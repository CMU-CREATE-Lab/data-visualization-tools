<!doctype html>
<html>
    <head>
        <title>Status</title>
        <style type="text/css">
            div.video {
                border: 1px solid red;
                width: fit-content;
                background:#2228;
            }
            div.video {
                border: 1px solid green;
                width: fit-content;
                background:#4448;
            }
        </style>
        <script type="text/javascript" src="../../config-local.js"></script>
        <script type="text/javascript" src="../../../../js/papaparse.min.js"></script>  
        <script type="text/javascript" src="../../../../js/d3.min.js"></script>
        <script type="text/javascript" src="../../../../js/handlebars-v4.0.11.js"></script>
        <script type="text/javascript" src="../../../../js/blazy.min.js"></script>
        <script type="text/javascript" src="../../../../js/noframework.waypoints.min.js"></script>
    </head>
    <body>
        <div id="out">
        </div>        

        <script type="text/javascript" src="../mobile-story.js"></script>
        <script id="story-template" type="text/x-handlebars-template">
          <div class="story" id="{{id}}">
            <h1><a href="./{{url}}">{{title}}</a></h1>
          </div>
        </script>        
        <script id="portrait-video-template" type="text/x-handlebars-template">
          <div class="video">
            <video preload="none" autoplay="" loop="" muted="" playsinline="" class="" width="270" height="360" onclick="this.paused?this.play():this.pause();">
                <source type="video/mp4" src="{{src}}">
            </video>
          </div>
        </script>        

        <script id="landscape-video-template" type="text/x-handlebars-template">
          <div class="video">
            <video preload="none" autoplay="" loop="" muted="" playsinline="" class="" width="640" height="360" onclick="this.paused?this.play():this.pause();">
                <source type="video/mp4" src="{{src}}">
            </video>
          </div>
        </script>        

        <script id="portrait-picture-template" type="text/x-handlebars-template">
          <div class="image">
            <picture width="270" height="360">
                <img src="{{src}}">
            </picture>
          </div>
        </script>        

        <script id="landscape-picture-template" type="text/x-handlebars-template">
         <div class="image">
            <picture width="640" height="360">
                <img src="{{src}}">
            </picture>
          </div>
         </script>        

        <script type="text/javascript">

            var source   = document.getElementById("story-template").innerHTML;
            var storyTemplate = Handlebars.compile(source);

            var source   = document.getElementById("portrait-video-template").innerHTML;
            var portraitVideoTemplate = Handlebars.compile(source);

            var source   = document.getElementById("landscape-video-template").innerHTML;
            var landscapeVideoTemplate = Handlebars.compile(source);

            var source   = document.getElementById("portrait-picture-template").innerHTML;
            var portraitPictureTemplate = Handlebars.compile(source);

            var source   = document.getElementById("landscape-picture-template").innerHTML;
            var landscapePictureTemplate = Handlebars.compile(source);

            var lochash = location.hash.substr(1);
            var mylocation = lochash.substr(lochash.indexOf('waypoints=')).split('&')[0].split('=')[1];

            var EARTH_TIMELAPSE_CONFIG = EARTH_TIMELAPSE_CONFIG || {};
            var rawUrl = EARTH_TIMELAPSE_CONFIG["waypointSliderContentPath"] || "https://docs.google.com/spreadsheets/d/1rCiksJv4aXi1usI0_9zdl4v5vuOfiHgMRidiDPt1WfE/edit#gid=1596808134";
            var regexp = /d\/(.*)\/edit\#gid=(.*)/;
            var matchesArray = rawUrl.match(regexp);
            var urlSrc = "https://docs-proxy.cmucreatelab.org/spreadsheets/d/{{id}}/export?format=csv&id={{id}}&gid={{gid}}";

            var urlTemplate = Handlebars.compile(urlSrc);
            var url = urlTemplate({'id': matchesArray[1], 'gid': matchesArray[2]});

            if (mylocation) {
                url =urlTemplate({'id': mylocation.split('.')[0], 'gid': mylocation.split('.')[1]});      
            }

            var storyTitles = [];
            var story = [];
            var data;
            var storyName = '';
            var slug = window.location.href.substr(window.location.href.lastIndexOf('/') + 1);
            slug = slug.split('#')[0];
            slug = slug.replace(/_/g,' ');
            if (slug != '') {
                storyName = '#' + slug.trim();
            }
            console.log(slug);
            var storyMode = false;
            Papa.parse(url, {
                download: true,
                header: true,
                complete: function(results, file) {
                    data = results["data"];
                    var append = false;
                    for (var i = 0; i < data.length; i++) {                        
                        if (storyMode && data[i]['Waypoint Title'][1] == "#" && append) {
                            append = false;            
                        } else if (!storyMode && data[i]['Waypoint Title'][0] == "#" && append) {
                            append = false;
                        }
                       
                        if ((storyMode && data[i]['Waypoint Title'][1] == "#") || (!storyMode && data[i]['Waypoint Title'][0] == "#")) {
                            storyTitles.push(data[i][0]);
                            var context = {
                                title: data[i]['Waypoint Title'].replace(/#/g,"").replace(/ /g, "_"), 
                                id: data[i]['Waypoint Title'].replace(/#/g,"").replace(/ /g, "_").toLowerCase(),
                                url: data[i]['Waypoint Title'].replace(/#/g,"").replace(/ /g, "_").toLowerCase()                       
                            };
                            var html = storyTemplate(context);                            
                            var el = document.getElementById("out");
                            el.insertAdjacentHTML('beforeend', html);
                        } 
                        if (data[i]['Waypoint Title'].toLowerCase() == storyName.toLowerCase() || data[i]['Waypoint Title'].toLowerCase() == '#' + storyName.toLowerCase()) {
                            if (data[i]['Waypoint Title'][1] == "#") {
                                storyMode = true;
                            }
                            append = true;
                            console.log('matched');
                        }
                        if (append) {
                            if (data[i]['Waypoint Title'] != '') {
                                story.push(data[i]);
                            }
                        }

                    }
                    if (storyName != '') {
                        var el = document.getElementById(storyName.replace(/#/g,"").replace(/ /g, "_"));
                        console.log(el);
                        for (var i = 0; i < story.length; i++) {
                            if (story[i]['Share View'] != '') {
                                var t = new Thumbnailer(story[i]['Share View']);
                                if (t.isPicture()) {
                                    var context = {src: t.getPng("portrait")};
                                    var html = portraitPictureTemplate(context);                            
                                    el.insertAdjacentHTML('beforeend', html);

                                    var context = {src: t.getPng("landscape")};
                                    var html = landscapePictureTemplate(context);                            
                                    el.insertAdjacentHTML('beforeend', html);    
                                } else {
                                    var context = {poster: t.getPng("portrait"), src: t.getMp4("portrait")};
                                    var html = portraitVideoTemplate(context);                            
                                    el.insertAdjacentHTML('beforeend', html);

                                    var context = {poster: t.getPng("landscape"), src: t.getMp4("landscape")};
                                    var html = landscapeVideoTemplate(context);                            
                                    el.insertAdjacentHTML('beforeend', html);
                                }
                            }
                        }
                    }
                }
            });

    </script>        
    </body>
</html>
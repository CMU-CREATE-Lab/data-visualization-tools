<html>
<head>
<script src="../../timemachine/js/jquery/jquery.min.js" type="text/javascript"></script>
<script src="TileIdx.js"></script>
<script src="Glb.js"></script>
<script src="WebglVideoTile.js"></script>
<script src="matrix.js"></script>
<script src="WebglTimemachinePerf.js"></script>
<script>

var tiles = [];

var perf;

function init() {
  console.log('init');
  var canvas = document.getElementById('webgl');
  var gl = canvas.getContext('experimental-webgl');
  var glb = new Glb(gl);

  var ntiles = 14;
  for (var i = 0; i < ntiles; i++) {
    tiles.push(new WebglVideoTile(
                      glb, 
                      new TileIdx(0,i,0), 
                      {min:{x:0,y:0}, max:{x:1,y:1}}, 
                      '1068x600/11/2620/' + (832 + i * 4) + '.mp4'));
  }
  $('#status').text(ntiles + ' tiles');
  perf = new WebglTimemachinePerf(document.getElementById('stats'), timelapse);
  WebglVideoTile.verbose = false;
  update();
}

/////////////////////
// Mocked timelapse
//

var startTime = performance.now();

var videoset = {
  getCurrentTime: function() {
    var t = ((performance.now() - startTime) / 1000) % 3.9 - 0.5;
    if (t < 0) t = 0;
    if (t > 2.9) t= 2.9;
    return t;
  }
};

var timelapse = {
  getVideoset: function() { return videoset; },
  getPlaybackRate: function() { return 1; },
  getVideoTime: function() { return getVideoset().getCurrentTime(); },
  getTimeIncludingDwells: function() { 
    return ((performance.now() - startTime) / 1000) % 3.9;
  }
};

var si=false;

function update() {
  if (performance.now() - startTime > 10000) return;
  if (si) return;
  perf.startFrame();
  window.requestAnimationFrame(update);
  transform = new Float32Array([1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1]);
  translateMatrix(transform, -1, -1);
  scaleMatrix(transform, 0.15, 2);
  // TODO(rsargent): don't hardcode this here
  var fps = 10;
  var displayFrame = timelapse.getVideoset().getCurrentTime() * fps;

  for (var i = 0; i < tiles.length; i++) {
    tiles[i].updatePhase1(displayFrame);  // Frame being displayed on screen
  }

  for (var i = 0; i < tiles.length; i++) {
    tiles[i].updatePhase2(displayFrame);  // Frame being displayed on screen
    tiles[i].draw(transform);
    translateMatrix(transform, 1.01, 0);
  }
  perf.endFrame();
}

//
///////////////////



$(init);
</script>
</head>
<body>
<canvas id='webgl' width=1000 height=40></canvas>
<div id='status'></div>
<canvas id='stats' width=1000 height=150></canvas>
<script>
</script>
</body>
</html>


<!DOCTYPE html>
<html>

<head>
  <title>Earth Timelapse</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

  <link href="../../timemachine/css/snaplapse.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/defaultUI.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/contextMap.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/scaleBar.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/customUI.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/leaflet/leaflet.css" rel="stylesheet" type="text/css" />
  <link href="../../js/customVideoTagControls/customVideoTagControls.css" rel="stylesheet" type="text/css" />
  <link href="../../css/jquery.multiselect.css" rel="stylesheet" type="text/css" />
  <link href="index.css" rel="stylesheet" type="text/css" />

  <script src="../../timemachine/js/jquery/jquery.min.js" type="text/javascript"></script>
  <script src="../../timemachine/js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
  <script src="../../timemachine/js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/util.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
  <script src="../../timemachine/js/Math.uuid.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/scaleBar.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/contextMap.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/customUI.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>
  <script src="../../timemachine/template_includes.js" type="text/javascript"></script>
  <script src="../../timemachine/js/leaflet/leaflet.min.js" type="text/javascript"></script>
  <script src="../../js/customVideoTagControls/customVideoTagControls.js" type="text/javascript"></script>
  <script src="../../js/jquery.multiselect.js" type="text/javascript"></script>
  <script src="../../js/earcut.min.js" type="text/javascript"></script>
  <script src="../../js/dat.gui.min.js"></script>
  <script src="../../js/papaparse.min.js"></script>
  <script src="../../js/d3.min.js"></script>

  <script src="config-local.js" type="text/javascript"></script>
  <script src="../../../../config.js" type="text/javascript"></script>

  <script src="timestamps_ajax_includes.js" type="text/javascript"></script>

  <script src="TileIdx.js"></script>
  <script src="WebglVideoTile.js"></script>
  <script src="TileView.js"></script>
  <script src="Glb.js"></script>
  <script src="WebglTimeMachineLayer.js"></script>
  <script src="WebglMapLayer.js"></script>
  <script src="WebglVectorLayer.js"></script>
  <script src="WebglVectorLayer2.js"></script>
  <script src="WebGLVectorTile.js"></script>
  <script src="WebGLVectorTile2.js"></script>
  <script src="WebglMapTile.js"></script>
  <script src="WebglMapTile2.js"></script>
  <script src="WebglMapLayer2.js"></script>
  <script src="perf.js"></script>
  <script src="../../js/utils.js"></script>

  <script type="text/javascript">
    "use strict";

    jQuery.support.cors = true;
    var UTIL = org.gigapan.Util;

    //
    //// Config ////
    //

    var EARTH_TIMELAPSE_CONFIG = EARTH_TIMELAPSE_CONFIG || {};
    // Deprecated externally but still used internally. Instead use waypointSliderContentPath, which points to an online or exported spreadsheet.
    var waypointSliderContent = EARTH_TIMELAPSE_CONFIG.waypointCollection;
    var waypointSliderContentPath = EARTH_TIMELAPSE_CONFIG.waypointSliderContentPath || "default-waypoints.tsv";
    var dotmapsContentPath;
    if (typeof(EARTH_TIMELAPSE_CONFIG.dotmapsContentPath) === "undefined") {
      dotmapsContentPath = "1rCiksJv4aXi1usI0_9zdl4v5vuOfiHgMRidiDPt1WfE.358696896";
    } else if (EARTH_TIMELAPSE_CONFIG.dotmapsContentPath === "") {
      dotmapsContentPath = "default-dotmaps.tsv";
    } else {
      dotmapsContentPath =  EARTH_TIMELAPSE_CONFIG.dotmapsContentPath;
    }

    if (typeof(Storage) !== "undefined") {
      if (localStorage.waypointSliderContentPath) {
        waypointSliderContentPath = localStorage.waypointSliderContentPath;
      }
      if (localStorage.dotmapsContentPath) {
        dotmapsContentPath = localStorage.dotmapsContentPath;
      }
    }

    var useUrbanFragilityWaypoints = window.location.hash.split("useUrbanFragilityWaypoints=")[1];
    if (useUrbanFragilityWaypoints === "true")
      waypointSliderContentPath = "https://docs.google.com/spreadsheets/d/1hFpDXOyjvjTpad7HpB0K-3thuYqSOlDJ4oExCTcscUk/edit#gid=1757433978";
    var googleMapsAPIKey = EARTH_TIMELAPSE_CONFIG.googleMapsAPIKey;

    var showEVA = !!EARTH_TIMELAPSE_CONFIG.showEVA;
    var showLodes = !!EARTH_TIMELAPSE_CONFIG.showLodes;
    var showCustomDotmaps = typeof(EARTH_TIMELAPSE_CONFIG.showCustomDotmaps) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showCustomDotmaps;
    var showCsvLayers = !!EARTH_TIMELAPSE_CONFIG.showCsvLayers;
    var showForestAlerts = !!EARTH_TIMELAPSE_CONFIG.showForestAlerts;
    var showMonthlyRefugees = !!EARTH_TIMELAPSE_CONFIG.showMonthlyRefugees;
    var showAnnualRefugees = !!EARTH_TIMELAPSE_CONFIG.showAnnualRefugees;
    var subsampleAnnualRefugees = !!EARTH_TIMELAPSE_CONFIG.subsampleAnnualRefugees;
    var subsampleAnnualReturns = !!EARTH_TIMELAPSE_CONFIG.subsampleAnnualReturns;
    var showAnnualReturns = !!EARTH_TIMELAPSE_CONFIG.showAnnualReturns;
    var showGlobalWindPower = !!EARTH_TIMELAPSE_CONFIG.showGlobalWindPower;
    var showVsi = !!EARTH_TIMELAPSE_CONFIG.showVsi;
    var showHealthImpact = !!EARTH_TIMELAPSE_CONFIG.showHealthImpact;
    var showZika = !!EARTH_TIMELAPSE_CONFIG.showZika;
    var showDengue = !!EARTH_TIMELAPSE_CONFIG.showDengue;
    var showChiku = !!EARTH_TIMELAPSE_CONFIG.showChiku;
    var showSeaLevelRise = !!EARTH_TIMELAPSE_CONFIG.showSeaLevelRise;
    var showUrbanFragility = !!EARTH_TIMELAPSE_CONFIG.showUrbanFragility;
    var showGtd = !!EARTH_TIMELAPSE_CONFIG.showGtd;
    var showHiv = !!EARTH_TIMELAPSE_CONFIG.showHiv;
    var showObesity = !!EARTH_TIMELAPSE_CONFIG.showObesity;
    var showVaccineConfidence = !!EARTH_TIMELAPSE_CONFIG.showVaccineConfidence;
    var showNdviAnomaly = !!EARTH_TIMELAPSE_CONFIG.showNdviAnomaly;
    var showEbola = !!EARTH_TIMELAPSE_CONFIG.showEbola;
    var showWaterOccurrence = !!EARTH_TIMELAPSE_CONFIG.showWaterOccurrence;
    var showWaterChange = !!EARTH_TIMELAPSE_CONFIG.showWaterChange;
    var showSeaLevelRise = !!EARTH_TIMELAPSE_CONFIG.showSeaLevelRise;
    var showCumulativeActiveMining = !!EARTH_TIMELAPSE_CONFIG.showCumulativeActiveMining;
    var showIomIdp = !!EARTH_TIMELAPSE_CONFIG.showIomIdp;
    var showBerkeleyEarthTemperatureAnomaly = !!EARTH_TIMELAPSE_CONFIG.showBerkeleyEarthTemperatureAnomaly;
    var showUppsalaConflict = !!EARTH_TIMELAPSE_CONFIG.showUppsalaConflict;
    var showLightsAtNight2012 = !!EARTH_TIMELAPSE_CONFIG.showLightsAtNight2012;
    var showLightsAtNight2016 = !!EARTH_TIMELAPSE_CONFIG.showLightsAtNight2016;
    var showOmiNo2 = !!EARTH_TIMELAPSE_CONFIG.showOmiNo2;
    var showChinaInfrastructure = !!EARTH_TIMELAPSE_CONFIG.showChinaInfrastructure;
    var showBePm25 = !!EARTH_TIMELAPSE_CONFIG.showBePm25;


    // Check URL layer verification tokens only if on http or https
    if (window.location.href.indexOf("http") == 0) {
      $.ajax({
        url: "http://verify.createlab.org:1337/et-china-infrastructure",
        data: {
          token: getUrlParameter("cit")
        }
      }).done(function(res) {
        if (res.response) {
          $("#ci").css("visibility", "visible");
        } else {
          showChinaInfrastructure = false;
          $("#ci").prev().remove();
          $("#ci").remove();
        }
      });
    }

    var showShareButton = !!EARTH_TIMELAPSE_CONFIG.showShareButton;
    var showShareButtonHash = window.location.hash.split("showShareButton=")[1];
    if (showShareButtonHash)
      showShareButton = showShareButtonHash === "true";
    var showSettingsButton = typeof(EARTH_TIMELAPSE_CONFIG.showSettingsButton) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showSettingsButton;
    var isHyperwall = !!EARTH_TIMELAPSE_CONFIG.isHyperwall;
    var useGoogleMaps = !!EARTH_TIMELAPSE_CONFIG.useGoogleMaps;
    var useGoogleSearch = (typeof(EARTH_TIMELAPSE_CONFIG.useGoogleSearch) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useGoogleSearch;
    var enableAutoMode = !!EARTH_TIMELAPSE_CONFIG.enableAutoMode;
    var screenTimeoutInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.screenTimeoutInMilliseconds) || 8 * 60 * 1000;
    var waypointDelayInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.waypointDelayInMilliseconds) || 1 * 15 * 1000;
    var defaultPlaybackSpeed = parseFloat(EARTH_TIMELAPSE_CONFIG.defaultPlaybackSpeed) || 0.5;
    var enableLetterboxMode = !!EARTH_TIMELAPSE_CONFIG.enableLetterboxMode;
    var letterboxModeHash = window.location.hash.split("enableLetterboxMode=")[1];
    if (letterboxModeHash)
      enableLetterboxMode = letterboxModeHash === "true";
    var landsatVersion = EARTH_TIMELAPSE_CONFIG.landsatVersion || "2015";
    var useFaderShader = (typeof(EARTH_TIMELAPSE_CONFIG.useFaderShader) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useFaderShader;
    var enableWaypointText = (typeof(EARTH_TIMELAPSE_CONFIG.enableWaypointText) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.enableWaypointText;
    var enableRecordingMode = !!EARTH_TIMELAPSE_CONFIG.enableRecordingMode;
    var trackingId = EARTH_TIMELAPSE_CONFIG.trackingId || "UA-4157572-7";
    var rootTilePath = (typeof(EARTH_TIMELAPSE_CONFIG.rootTilePath) == "undefined") ? "../../../data/" : EARTH_TIMELAPSE_CONFIG.rootTilePath;

    // TODO: Until we decide to force everyone to latest landsat, pull the version corresponding to the config above.
    if (landsatVersion == "2015"){
      var cachedLandsatTimeJsonPath = "landsat-times.json";
      var landsatAjaxIncludesPath = "landsat_ajax_includes.js";
    } else {
      var cachedLandsatTimeJsonPath = "landsat-times-2016.json";
      var landsatAjaxIncludesPath = "landsat_ajax_includes_2016.js";
    }

    var NORTH = 85.05113006405742; // Latitude for Northern most extent
    var landsatMaxScale = (landsatVersion == "2015") ? 1.25 : 0.45;
    var himawariMaxScale = 0.02;
    var isAutoModeRunning = false;
    var visibleBaseMapLayer = "landsat";
    var previousVisibleBaseMapLayer = visibleBaseMapLayer;
    WebglVideoTile.useFaderShader = useFaderShader;
    var timelapse, snaplapseViewerForPresentationSlider, previousWaypoint = {}, waypointViewChangeListener, hideWaypointListener, waypointTimeChangeListener, snaplapseForPresentationSlider;
    var himawariWaypoints = {};
    var annotationPicturePaths = {};
    var timelineType = "customUI";
    var activeLayersWithTimeline = 0;
    var previousActiveLayersWithTimeline = 0;
    var keysDown = [];
    var $lastSelectedExtra;

    // This is necessary because waypoint thumbnails are generated from the Landsat set and thus the best we can show is just a solid black thumbnail
    // instead of some random location that a himawari bounds corresponds to in Landsat.
    var himawariWaypointThumbnailBounds = {
      xmax: 1818264.731953845,
      xmin: 1746298.8849333557,
      ymax: 1253113.3077389232,
      ymin: 1218442.2616483232
    };

    // Mapping of spreadsheet entry title to jump point in waypoint slider
    var jumpToButtons = {};


    // ## 1 ##
    //
    //// Layer variables ////
    //

    var forestAlertsTimeMachineLayer, forestAlertsNoOverlayTimeMachineLayer, landsatBaseMapLayer, darkBaseMapLayer, lightBaseMapLayer, mcrmVectorLayer;
    var hansenMapLayer, hansenMapLayer2, lightsAtNightMapLayer, lightsAtNight2012MapLayer, lightsAtNight2016MapLayer, crwTimemachineLayer, animatedHansenLayer, himawariTimemachineLayer, ndviAnomalyTimemachineLayer;
    var waterOccurrenceLayer, waterChangeLayer, usgsWindTurbineLayer, solarInstallsLayer, drillingLayer;
    var globalWindPowerLayer;
    var annualRefugeesLayer;
    var annualReturnsLayer;
    var vsiLayer;
    var healthImpactLayer;
    var zikaLayer, dengueLayer, chikuLayer;
    var viirsLayer;
    var wdpaLayer;
    var seaLevelRiseLayer;
    var urbanFragilityLayer;
    var coralBleachingLayer;
    var monthlyRefugeesLayer;
    var gtdLayer;
    var hivLayer;
    var obesityLayer;
    var vaccineConfidenceLayer;
    var ebolaDeathsLayer;
    var ebolaCasesLayer;
    var ebolaNewCasesLayer;
    var lodesLayer;
    var cumulativeActiveMiningLayer;
    var iomIdpLayer;
    var berkeleyEarthTemperatureAnomalyTimeMachineLayer;
    var landBorderLayer;
    var uppsalaConflictLayer;
    var omiNo2Layer;
    var chinaAviationLayer;
    var chinaPowerPlantsLayer;
    var chinaReservoirsLayer;
    setTimeLine('china-reservoirs-times', 1950, 2012, 1);
    var chinaWasteTreatmentPlantsLayer;
    var bePm25Layer;

    // LODES interface
    var lodesGui;
    var lodesOptions;

    var LodesOptions = function() {
      this.doPulse = true;
      this.totalTime = 1000;
      this.dwellTime = 1000;
      this.filter = true;
      this.distance = 50.;
      this.animate = 'animate';
      this.speed = 1;
      this.se01 = true;
      this.se02 = true;
      this.se03 = true;
    };

    var lodesAnimationState = {
      then: new Date(),
      inMainLoop: false,
      inStartDwell: true,
      inEndDwell: false,
      pulse: false
    }

    function getLayerInfo(layer) {
      var readyTileCount = 0;
      var waitingTileCount = 0;

      var pointCount = 0;
      var keys = Object.keys(layer._tileView._tiles);
      var zoomLevel = 0;
      var layerView = timelapse.getView();
      var timelapse2map = layer.getWidth() / landsatBaseMapLayer.getWidth();
      layerView.scale /= timelapse2map;

      var zoomLevel = layer._tileView._scale2level(layerView.scale);

      var lightBaseMapView = timelapse.getView();
      var timelapse2map = lightBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
      lightBaseMapView.x *= timelapse2map;
      lightBaseMapView.y *= timelapse2map;
      lightBaseMapView.scale /= timelapse2map;
      var mapLevel = lightBaseMapLayer._tileView._scale2level(lightBaseMapView.scale);

      for (var i = 0; i < keys.length; i++) {
        var tile = layer._tileView._tiles[keys[i]];
        if (tile._ready) {
          readyTileCount++;
          pointCount += tile._pointCount;
        } else {
          waitingTileCount++;
        }
      }

      return {
        'readyTileCount': readyTileCount,
        'waitingTileCount': waitingTileCount,
        'pointCount': pointCount,
        'zoomLevel': zoomLevel,
        'mapLevel': mapLevel
      }
    }

    function initLodesGui() {
      lodesOptions = new LodesOptions();
      var gui = new dat.GUI();
      var f1 = gui.addFolder('Animation');
      f1.add(lodesOptions, 'animate', { animate: 'animate', home: 'home', work: 'work' } );
      f1.add(lodesOptions, 'speed', { fast: 1, medium: 3, slow: 5});
      f1.open();
      var f2 = gui.addFolder('Distance in KM');
      f2.add(lodesOptions, 'filter');
      f2.add(lodesOptions, 'distance',10,100);
      f2.open();
      var f3 = gui.addFolder('Earnings per Month');
      f3.add(lodesOptions, 'se01').name('< $1251');
      f3.add(lodesOptions, 'se02').name('$1251 - $3333');
      f3.add(lodesOptions, 'se03').name('> $3333');
      f3.open();
      f3.onResize = function() {
          var el1 = document.getElementById("se01-color");
          var el2 = document.getElementById("se02-color");
          var el3 = document.getElementById("se03-color");

          if (f3.closed) {
              el1.style['display'] = 'none';
              el2.style['display'] = 'none';
              el3.style['display'] = 'none';
          } else {
              el1.style['display'] = 'block';
              el2.style['display'] = 'block';
              el3.style['display'] = 'block';
          }
      }
      gui.onResize = function() {
          if (gui.closed) {
              var el1 = document.getElementById("se01-color");
              var el2 = document.getElementById("se02-color");
              var el3 = document.getElementById("se03-color");

              el1.style['display'] = 'none';
              el2.style['display'] = 'none';
              el3.style['display'] = 'none';

          }
      }
      var dg = document.getElementsByClassName("dg ac")[0];
      var el = document.createElement("div");
      el["id"] = "se01-color";
      el["style"]["position"] = "absolute";
      el["style"]["width"] = "24px";
      el["style"]["height"] = "12px";
      el["style"]["top"] = "205px";
      el["style"]["right"] = "112px";
      el["style"]["backgroundColor"] = "#194BFF";
      el["style"]["zIndex"] = 100;
      dg.appendChild(el);

      var el = document.createElement("div");
      el["id"] = "se02-color";
      el["style"]["position"] = "absolute";
      el["style"]["width"] = "24px";
      el["style"]["height"] = "12px";
      el["style"]["top"] = "233px";
      el["style"]["right"] = "112px";
      el["style"]["backgroundColor"] = "#148A09";
      el["style"]["zIndex"] = 100;
      dg.appendChild(el);

      var el = document.createElement("div");
      el["id"] = "se03-color";
      el["style"]["position"] = "absolute";
      el["style"]["width"] = "24px";
      el["style"]["height"] = "12px";
      el["style"]["top"] = "261px";
      el["style"]["right"] = "112px";
      el["style"]["backgroundColor"] = "#E31E1E";
      el["style"]["zIndex"] = 100;
      dg.appendChild(el);
      dg["style"]["display"] = "none";

    }
    // ## 2 ##
    //// Layer tile paths
    //

    var landsatUrl = (landsatVersion == "2015") ? rootTilePath + "/earthtime-annual-2015-v2/1068x600" : rootTilePath + "/earthtime-annual-2016-v14/1068x600";
    if (landsatVersion == "2016" && EARTH_TIMELAPSE_CONFIG.landsatUrl) {
      landsatUrl = EARTH_TIMELAPSE_CONFIG.landsatUrl;
    }
    var crwTimemachineUrl = rootTilePath + "/coral/coralreefwatch-3.timemachine/crf20-22fps-1424x800";
    var ndviAnomalyTimemachineUrl = rootTilePath + "/ndvi_anomaly_1000v01/1068x600";
    var himawariTimemachineUrl = rootTilePath + "/himawari8/himawari8-nov-2015.timemachine/crf26-12fps-1424x800";
    var forestAlertsTimeMachineUrl = rootTilePath + "/global-forest-alerts/ForestAlarms2016v2/1068x600";
    var forestAlertsNoOverlayTimeMachineUrl = rootTilePath + "/global-forest-alerts/ForestAlarmsNoOverlay2016v1/1068x600";
    var berkeleyEarthTemperatureAnomalyTimeMachineUrl = rootTilePath + "/berkeley-earth/berkeley-earth.timemachine/crf24-12fps-1424x800";
    var osmDefaultUrl = rootTilePath + "/openstreetmap/default/";
    var osmLightRetinaUrl = rootTilePath + "/openstreetmap/light_all_retina/{default}/{z}/{x}/{y}.png";
    var osmDarkRetinaUrl = rootTilePath + "/openstreetmap/dark_all_retina/{default}/{z}/{x}/{y}.png";
    var gfcTransUrl = rootTilePath + "/global-forest-change/loss_year_transparent/{default}/{z}/{x}/{y}.png";
    var gfcLossGainUrl = rootTilePath + "/global-forest-change/loss_tree_gain/{default}/{z}/{x}/{y}.png";
    var googleMapsDefaultUrl = "https://mts0.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0";
    var googleMapsDarkStyleUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0";
    var googleMapsDefaultRetinaUrl = "https://mts1.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0!5m1!5f2";
    var googleMapsDarkStyleRetinaUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0!5m1!5f2";
    var lightMapUrl = useGoogleMaps ? googleMapsDefaultRetinaUrl : osmLightRetinaUrl;
    var darkMapUrl = useGoogleMaps ? googleMapsDarkStyleRetinaUrl : osmDarkRetinaUrl;
    var lightsAtNightUrl = rootTilePath + "/lights-at-night/{default}/{z}/{x}/{y}.png";
    // Note that x/y are swapped for these two lights at night data sets
    var lightsAtNight2012Url = rootTilePath + "/lights-at-night-2012/{default}/{z}/{y}/{x}.jpg";
    var lightsAtNight2016Url = rootTilePath + "/lights-at-night-2016/{default}/{z}/{y}/{x}.jpg";
    var waterOccurrenceUrl = rootTilePath + "/water/occurrence_2016/{default}/{z}/{x}/{y}.png";
    var waterChangeUrl = rootTilePath + "/water/change_2016/{default}/{z}/{x}/{y}.png";

    var wdpaUrl = rootTilePath + "/wdpaline-year/{z}/{x}/{y}.bin";
    var mcrmUrl = rootTilePath + "/coral/mcrm-lines-wrapdateline/{z}/{x}/{y}.bin";

    // VIIRS fix
    var viirsUrl = rootTilePath + "/viirs/createlab-viirs-uncorrected-20140314-20150403.bin";
    var viirsUrl = rootTilePath + "/viirs/{z}/{x}/{y}.bin";

    var coralBleachingUrl = rootTilePath + "/coral/{z}/{x}/{y}.bin";
    var usgsWindTurbineUrl = rootTilePath + "/energy/wind-installs-usgs/{z}/{x}/{y}.bin";
    var solarInstallsUrl = rootTilePath + "/energy/solar-installs/{z}/{x}/{y}.bin";
    var globalWindPowerUrl = rootTilePath + "/energy/global-wind-power/{z}/{x}/{y}.bin";
    var drillingUrl = rootTilePath + "/energy/drilling/{z}/{x}/{y}.bin";
    var animatedHansenUrls = [gfcTransUrl, gfcLossGainUrl];
    var monthlyRefugeesUrl = rootTilePath + '/monthly-mediterranean-refugees/{z}/{x}/{y}.bin';

    var annualRefugeesUrl = rootTilePath + "/annual-refugees/{z}/{x}/{y}.bin";
    if (subsampleAnnualRefugees) {
      annualRefugeesUrl = rootTilePath + "/annual-refugees/subsampled/{z}/{x}/{y}.bin";
    }
    var annualReturnsUrl =  rootTilePath + "/annual-returns/refugee-returns.bin";
    if (subsampleAnnualReturns) {
      annualReturnsUrl = rootTilePath + "/annual-returns/refugee-returns-subsampled.bin";
    }

    var vsiUrl = rootTilePath + "/vsi/tiles/{default}/{z}/{x}/{y}.png";
    var healthImpactUrl = rootTilePath + "/health-impact/{z}/{x}/{y}.bin";
    var zikaUrl = rootTilePath + "/pandemics/zika/{z}/{x}/{y}.bin";
    var dengueUrl = rootTilePath + "/pandemics/dengue/{z}/{x}/{y}.bin";
    var chikuUrl = rootTilePath + "/pandemics/chiku/{z}/{x}/{y}.bin";

    var seaLevelRiseUrl = rootTilePath + "/sea-level-rise/201704_lockin_animated_land/{z}/{x}/{y}.png"; //"http://a.ss2tiles.climatecentral.org/lockin_animated_land/{z}/{x}/{y}.png";
    var urbanFragilityUrl = rootTilePath + "/urban-fragility/{z}/{x}/{y}.bin";
    var gtdUrl = rootTilePath + "/gtd/{z}/{x}/{y}.bin";
    var hivUrl = rootTilePath + "/hiv/{z}/{x}/{y}.bin";
    var obesityUrl = rootTilePath + "/obesity/{z}/{x}/{y}.geojson";
    var vaccineConfidenceUrl = rootTilePath + "/vaccine-confidence/{z}/{x}/{y}.geojson";
    var ebolaDeathsUrl = rootTilePath + "/ebola/deaths/{z}/{x}/{y}.bin";
    var ebolaCasesUrl = rootTilePath + "/ebola/cases/{z}/{x}/{y}.bin";
    var ebolaNewCasesUrl = rootTilePath + "/ebola/new-cases/{z}/{x}/{y}.bin";

    var lodesUrl = rootTilePath + "/lodes/lodes-10/{z}/{x}/{y}.bin";

    var cumulativeActiveMiningUrl = "http://storage.googleapis.com/skytruth-data/color_test_cumulativeActiveMining-FOOTPRINT/{z}/{x}/{y}.png";

    var iomIdpUrl = rootTilePath + "/iom-idp/idp-returns.geojson";
    var landBorderUrl = rootTilePath + "/land-borders/{default}/{z}/{x}/{y}.png";

    var uppsalaConflictUrl = rootTilePath + "/ucdp/uppsala-conflict.bin";

    var omiNo2Url = rootTilePath + "/omi-no2/omi-no2.timemachine/crf24-12fps-1424x800";

    var chinaAviationUrl = rootTilePath + "/china-infrastructure/china-aviation.bin";
    var chinaPowerPlantsUrl = rootTilePath + "/china-infrastructure/china-power-plants.bin";
    var chinaReservoirsUrl = rootTilePath + "/china-infrastructure/china-reservoirs.bin";
    var chinaWasteTreatmentPlantsUrl = rootTilePath + "/china-infrastructure/china-waste-treatment-plants.bin";

    var bePm25Url = rootTilePath + "/be-pm25/be-pm25.timemachine/crf24-22fps-1424x800";

    function init() {
      var enablePresentationSlider = true;
      if (enableRecordingMode || window.location.hash.split("disablePresentationSlider=")[1]) {
        enablePresentationSlider = false;
      }
      var settings = {
        loopDwell: {
          startDwell: 1.5,
          endDwell: 1.5
        },
        playbackSpeed: defaultPlaybackSpeed,
        viewerType: "webgl",
        url: landsatUrl,
        apiKeys: googleMapsAPIKey ? {'googleMaps': googleMapsAPIKey} : undefined,
        enablePresentationSlider: enablePresentationSlider,
        enableEditor: enableRecordingMode ? true : false,
        showEditorOnLoad: enableRecordingMode ? true : false,
        // Using "https" will casue the thumbnail loading from the server to fail
        thumbnailServerRootTileUrl: (landsatVersion == "2015") ? "http://earthengine.google.org/timelapse/data/20130507" : "http://storage.googleapis.com/earthengine-timelapse/herwig/earthtime_annual_1984_2016/v05",
        showFullScreenBtn: false,
        showShareBtn: showShareButton,
        presentationSliderSettings: enableRecordingMode ? {} : {
          onLoadAnimation: "none",
          playAfterAnimation: false,
          initialWaypointIndex: 0,
          doAutoMode: enableAutoMode,
          showAnnotations: false,
          screenIdleTime: screenTimeoutInMilliseconds,
          waypointDelayTime: waypointDelayInMilliseconds,
          height: 94
        },
        useTouchFriendlyUI: isHyperwall,
        datasetType: "landsat",
        playOnLoad: enableRecordingMode ? false : true,
        mediaType: (landsatVersion == "2015") ? ".webm" : ".mp4",
        onTimeMachinePlayerReady: function(viewerDivId) {},
        scaleBarOptions: {
          scaleBarDiv: "scaleBar1"
        },
        contextMapOptions: {
          contextMapDiv: "contextMap1",
          tileType: useGoogleMaps ? "Google" : "OpenStreetMap",
          tileUrl: osmDefaultUrl,
          geometry: {
            width: 270,
            height: 200
          }
        },
        isGoogleAnalyticEventTrackingEnabled: true,
        startEditorFromPresentationMode: true
      };

      if (enableLetterboxMode) {
        $("#timeMachine").addClass("letterbox");
        $("#letterbox-middle").replaceWith($("#timeMachine"));
      } else {
        $("#content").remove();
      }

      if (enableRecordingMode) {
        $("#timeMachine, #content").addClass("recording");
        $("#letterbox-bottom").remove();
      }

      timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", settings);
      onTimeMachinePlayerReady();
      if (showSettingsButton) {
        initSettingsUI();
      }
    }

    $.getScript(landsatAjaxIncludesPath)
      .done(function(script, status) {
        eval(script)
        $(init);
      }
    );

    function verticalTouchScroll(selector){
      var el = $(selector)[0];
      var scrollStartPos = 0;

      el.addEventListener("touchstart", function(event) {
        scrollStartPos = this.scrollTop+event.touches[0].pageY;
        event.preventDefault();
      },false);

      el.addEventListener("touchmove", function(event) {
        this.scrollTop = scrollStartPos-event.touches[0].pageY;
        event.preventDefault();
      },false);
    }

    function googleMapsLoadedCallback() {
      if (useGoogleSearch) {
        var autocomplete = new google.maps.places.Autocomplete($("#location_search").get(0));
        var geocoder = new google.maps.Geocoder();

        // Hack to enable places selection from dropdown on touch screens
        $(document).on('touchstart', '.pac-item', function(e) {
          e.preventDefault();
          var searchText = $(this).text();
          $("#location_search").val(searchText);
          google.maps.event.trigger(autocomplete, 'place_changed', {
            locationName: searchText
          });
          $('.pac-container').hide();
        });

        google.maps.event.addListener(autocomplete, 'place_changed', function(options) {
          var place = (options && options.locationName) || autocomplete.getPlace();
          if (!place) return;
          if (!place.geometry) {
            var address = $("#location_search").val();
            $("#location_search").val("");
            geocoder.geocode({
              'address': address
            }, function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                var lat = results[0].geometry.location.lat();
                var lng = results[0].geometry.location.lng();
                newView = {
                  center: {
                    "lat": lat,
                    "lng": lng
                  },
                  "zoom": 10
                };
                timelapse.setNewView(newView, false, false);
              } else {
                console.log("Geocode failed: " + status);
              }
            });
          } else {
            var newView = {
              center: {
                "lat": place.geometry.location.lat(),
                "lng": place.geometry.location.lng()
              },
              "zoom": 10
            };
            timelapse.setNewView(newView, false, false);
          }

          var searchLocation = (options && options.locationName) || place.formatted_address;
          if (searchLocation) {
            searchLocation = searchLocation.replace(/ /g, '');
            UTIL.addGoogleAnalyticEvent('textbox', 'search', 'go-to-searched-place=' + searchLocation);
          }
        });
      }
    }

    // Wait until currrent execution finishes so that we can skip loading the timeline in case it is not the last call.
    // We do this because the timeline loads asynchronously; otherwise, the next waypoint might use the wrong timeline.
    var finalizeNewTimelineTimeout = null;

    function requestNewTimeline(url, newTimelineStyle) {
      // The last timeline request takes precedence
      if (finalizeNewTimelineTimeout !== null) {
        clearTimeout(finalizeNewTimelineTimeout);
        finalizeNewTimelineTimeout = null;
      }
      finalizeNewTimelineTimeout = setTimeout(function() {
        timelapse.loadNewTimeline(url, newTimelineStyle);
        finalizeNewTimelineTimeout = null;
      }, 0);
    }


    function setTimeLine(identifier, startDate, endDate, step) {
      var captureTimes = [];
      if (isNaN(startDate) || isNaN(endDate) || isNaN(step) ) {
        captureTimes = cached_ajax['landsat-times.json']['capture-times'];
      } else {
        for (var i = startDate; i < endDate + 1; i+=step) {
          captureTimes.push(i.toString());
        }

      }
      cached_ajax[identifier + '.json'] = {"capture-times":  captureTimes};
    }

    function initLayerToggleUI() {
      // ## 3 ##
      //// Layer toggle event handlers ////
      //

      $("#show-water-occurrence").on("click", function() {
        var $this = $(this);
        if ($this.is(':checked')) {
          if ($("#show-water-change").prop('checked')) {
            $("#show-water-change").click();
          }
          showWaterOccurrenceLayer = true;
          timelineType = "none";
          $("#water-occurrence-legend").show();
        } else {
          showWaterOccurrenceLayer = false;
          timelineType = "customUI";
          $("#water-occurrence-legend").hide();
        }
      }).prop('checked', showWaterOccurrenceLayer);

      $("#show-water-change").on("click", function() {
        var $this = $(this);
        if ($this.is(':checked')) {
          if ($("#show-water-occurrence").prop('checked')) {
            $("#show-water-occurrence").click();
          }
          showWaterChangeLayer = true;
          timelineType = "none";
          $("#water-change-legend").show();
        } else {
          showWaterChangeLayer = false;
          timelineType = "customUI";
          $("#water-change-legend").hide();
        }
      }).prop('checked', showWaterChangeLayer);

      $("#show-wdpa").on("click", function() {
        var $this = $(this);
        if ($this.is(':checked')) {
          showWdpaLayer = true;
          timelineType = "none";
          $("#wdpa-legend").show();
        } else {
          showWdpaLayer = false;
          timelineType = "customUI";
          $("#wdpa-legend").hide();
        }
      }).prop('checked', showWdpaLayer);

      $("#show-forest-change").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-forest-loss-gain").prop('checked')) {
            $("#show-forest-loss-gain").click();
          }
          if ($("#show-animated-forest-loss-gain").prop('checked')) {
            $("#show-animated-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts").prop('checked')) {
            $("#show-forest-alerts").click();
          }
          if ($("#show-forest-alerts-no-overlay").prop('checked')) {
            $("#show-forest-alerts-no-overlay").click();
          }
          showHansenLayer = true;
          timelineType = "none";
          $("#forest-loss-year-legend").show();
        } else {
          showHansenLayer = false;
          timelineType = "customUI";
          $("#forest-loss-year-legend").hide();
        }
      }).prop('checked', showHansenLayer);

      $("#show-forest-loss-gain").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-forest-change").prop('checked')) {
            $("#show-forest-change").click();
          }
          if ($("#show-animated-forest-loss-gain").prop('checked')) {
            $("#show-animated-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts").prop('checked')) {
            $("#show-forest-alerts").click();
          }
          if ($("#show-forest-alerts-no-overlay").prop('checked')) {
            $("#show-forest-alerts-no-overlay").click();
          }
          showHansenLayer2 = true;
          timelineType = "none";
          $("#forest-loss-gain-legend").show();
        } else {
          showHansenLayer2 = false;
          timelineType = "customUI";
          $("#forest-loss-gain-legend").hide();
        }
      }).prop('checked', showHansenLayer2);

      $("#show-animated-forest-loss-gain").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-forest-change").prop('checked')) {
            $("#show-forest-change").click();
          }
          if ($("#show-forest-loss-gain").prop('checked')) {
            $("#show-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts").prop('checked')) {
            $("#show-forest-alerts").click();
          }
          if ($("#show-forest-alerts-no-overlay").prop('checked')) {
            $("#show-forest-alerts-no-overlay").click();
          }
          showAnimatedHansenLayer = true;
          setActiveLayersWithTimeline(1);
          if (!showViirsLayer) {
            timelineType = "customUI";
            requestNewTimeline("animated-forest-loss-gain-times.json", timelineType);
          }
          $("#forest-loss-gain-legend").show();
        } else {
          showAnimatedHansenLayer = false;
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#forest-loss-gain-legend").hide();
        }
      }).prop('checked', showAnimatedHansenLayer);

      $("#show-forest-alerts").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-forest-change").prop('checked')) {
            $("#show-forest-change").click();
          }
          if ($("#show-forest-loss-gain").prop('checked')) {
            $("#show-forest-loss-gain").click();
          }
          if ($("#show-animated-forest-loss-gain").prop('checked')) {
            $("#show-animated-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts-no-overlay").prop('checked')) {
            $("#show-forest-alerts-no-overlay").click();
          }
          showForestAlertsTimeMachineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("forest-alerts-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setMaxScale(landsatMaxScale);
          timelapse.setDoDwell(false);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(1);
          previousVisibleBaseMapLayer = visibleBaseMapLayer;
          visibleBaseMapLayer = "forest-alarms";
        } else {
          showForestAlertsTimeMachineLayer = false;
          setActiveLayersWithTimeline(-1);
          if (!showForestAlertsNoOverlayTimeMachineLayer && !showForestAlertsTimeMachineLayer) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            visibleBaseMapLayer = $("input:radio[name=base-layers]:checked").val();
            timelapse.setMaxScale(landsatMaxScale);
            var v = timelapse.getVideoset();
            v.setFps(10);
            timelapse.setDoDwell(true);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
        }
      }).prop('checked', showForestAlertsTimeMachineLayer);

      $("#show-forest-alerts-no-overlay").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-forest-change").prop('checked')) {
            $("#show-forest-change").click();
          }
          if ($("#show-forest-loss-gain").prop('checked')) {
            $("#show-forest-loss-gain").click();
          }
          if ($("#show-animated-forest-loss-gain").prop('checked')) {
            $("#show-animated-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts").prop('checked')) {
            $("#show-forest-alerts").click();
          }
          showForestAlertsNoOverlayTimeMachineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("forest-alerts-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setMaxScale(landsatMaxScale);
          timelapse.setDoDwell(false);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(1);
          previousVisibleBaseMapLayer = visibleBaseMapLayer;
          visibleBaseMapLayer = "forest-alarms-no-overlay";
        } else {
          showForestAlertsNoOverlayTimeMachineLayer = false;
          setActiveLayersWithTimeline(-1);
          if (!showForestAlertsNoOverlayTimeMachineLayer && !showForestAlertsTimeMachineLayer) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            visibleBaseMapLayer = $("input:radio[name=base-layers]:checked").val();
            timelapse.setMaxScale(landsatMaxScale);
            var v = timelapse.getVideoset();
            v.setFps(10);
            timelapse.setDoDwell(true);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
        }
      }).prop('checked', showForestAlertsNoOverlayTimeMachineLayer);

      $("#show-viirs").on("click", function() {
        if ($(this).prop('checked')) {
          showViirsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("viirs-times.json", timelineType);
          timelapse.setMasterPlaybackRate(8);
          timelapse.setPlaybackRate(8);
          timelapse.setDoDwell(false);
          $("#fires-at-night-legend").show();
        } else {
          showViirsLayer = false;
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#fires-at-night-legend").hide();
        }
      }).prop('checked', showViirsLayer);

      $("#show-coral").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-coral-bleaching-alerts").prop('checked')) {
            $("#show-coral-bleaching-alerts").click();
          }
          showCoralBleachingLayer = true;
          setActiveLayersWithTimeline(1);
          showMcrmLayer = true;
          timelineType = "customUI";
          $("#coral-bleaching-legend").show();
        } else {
          showCoralBleachingLayer = false;
          showMcrmLayer = false;
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-coral-bleaching-alerts").prop('checked')) {
            $("#coral-bleaching-legend").hide();
          }
        }
      }).prop('checked', showCoralBleachingLayer);

      $("#show-coral-bleaching-alerts").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-coral").prop('checked')) {
            $("#show-coral").click();
          }
          showCrwTimemachineLayer = true;
          showMcrmLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("crw-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(22);
          timelapse.setDoDwell(false);
          WebglVideoTile.useGreenScreen = true;
          $("#coral-bleaching-alerts-legend").show();
          $("#coral-bleaching-legend").show();
        } else {
          showCrwTimemachineLayer = false;
          showMcrmLayer = false;
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#coral-bleaching-alerts-legend").hide();
          if (!$("#show-coral").prop('checked')) {
            $("#coral-bleaching-legend").hide();
          }
        }
      }).prop('checked', showCrwTimemachineLayer);

      $("#show-ndvi-anomaly").on("click", function() {
        if ($(this).prop('checked')) {
          showNdviAnomalyTimemachineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("ndvi-anomaly-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(1);
          timelapse.setDoDwell(false);
          WebglVideoTile.useGreenScreen = true;
          $("#ndvi-anomaly-legend").show();
        } else {
          showNdviAnomalyTimemachineLayer = false;
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#ndvi-anomaly-legend").hide();
        }
      }).prop('checked', showNdviAnomalyTimemachineLayer);

      $("#show-himawari").on("click", function() {
        if ($(this).prop('checked')) {
          // Clear out non-himawari8 layers if they were already active.
          var $activeLayersNotIncludingHimawari = $(".map-layer-div, .ui-multiselect-checkboxes").find("input:checked").not("#show-himawari");
          if ($activeLayersNotIncludingHimawari.length > 1) {
            $activeLayersNotIncludingHimawari.trigger("click");
          }
          showHimawariTimeMachineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          previousVisibleBaseMapLayer = visibleBaseMapLayer;
          visibleBaseMapLayer = "himawari";
          requestNewTimeline("himawari-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(12);
          timelapse.setMaxScale(himawariMaxScale);
          timelapse.setDoDwell(false);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(1);
          $("#layers-legend").hide();
          // Handle Landsat 2016 bounds.
          if (landsatVersion == "2016") {
            $.getScript("himawari_landsat_ajax_includes.js")
              .done(function(script, status) {
                eval(script);
                landsatBaseMapLayer.resetDimensions(cached_ajax["./1068x600/r.json"]);
              }
            );
          }
        } else {
          showHimawariTimeMachineLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          visibleBaseMapLayer = previousVisibleBaseMapLayer;
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setMaxScale(landsatMaxScale);
          timelapse.setDoDwell(true);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#layers-legend").hide();
          // Handle Landsat 2016 bounds.
          if (landsatVersion == "2016") {
            $.getScript(landsatAjaxIncludesPath)
              .done(function(script, status) {
                eval(script);
                landsatBaseMapLayer.resetDimensions(cached_ajax["./1068x600/r.json"]);
              }
            );
          }
        }
        timelapse.warpTo(timelapse.getHomeView());
      }).prop('checked', showHimawariTimeMachineLayer);

      $("#show-berkeley-earth-temperature-anomaly").on("click", function() {
        if ($(this).prop('checked')) {
          showBerkeleyEarthTemperatureAnomalyTimeMachineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("berkeley-earth-temperature-anomaly-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(12);
          timelapse.setDoDwell(false);
          WebglVideoTile.useGreenScreen = false;
          timelapse.setMasterPlaybackRate(1.0);

          $("#berkeley-earth-temperature-anomaly-legend").show();
        } else {
          showBerkeleyEarthTemperatureAnomalyTimeMachineLayer = false;
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          var v = timelapse.getVideoset();
          v.setFps(10);
          $("#berkeley-earth-temperature-anomaly-legend").hide();
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
        }
      }).prop('checked', showBerkeleyEarthTemperatureAnomalyTimeMachineLayer);

      $("#show-usgs-windturbine").on("click", function() {
        if ($(this).prop('checked')) {
          showUsgsWindTurbineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#wind-installs-legend").show();
        } else {
          showUsgsWindTurbineLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          $("#wind-installs-legend").hide();
        }
      }).prop('checked', showUsgsWindTurbineLayer);

      $("#show-global-wind-power").on("click", function() {
        if ($(this).prop('checked')) {
          showGlobalWindPowerLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#global-wind-power-legend").show();
        } else {
          showGlobalWindPowerLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          $("#global-wind-power-legend").hide();
        }
      }).prop('checked', showGlobalWindPowerLayer);

      $("#show-solar-installs").on("click", function() {
        if ($(this).prop('checked')) {
          showSolarInstallsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#solar-installs-legend").show();
        } else {
          showSolarInstallsLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          $("#solar-installs-legend").hide();
        }
      }).prop('checked', showSolarInstallsLayer);

      $("#show-drilling").on("click", function() {
        if ($(this).prop('checked')) {
          showDrillingLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("drilling-times.json", timelineType);
          $("#drilling-legend").show();
        } else {
          showDrillingLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#drilling-legend").hide();
        }
      }).prop('checked', showDrillingLayer);

      $("#show-lights-at-night").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-lights-at-night-2016").prop('checked')) {
            $("#show-lights-at-night-2016").click();
          }
          if ($("#show-lights-at-night-2012").prop('checked')) {
            $("#show-lights-at-night-2012").click();
          }
          showLightsAtNightLayer = true;
          timelineType = "none";
          $("#lights-at-night-legend").show();
        } else {
          showLightsAtNightLayer = false;
          timelineType = "customUI";
          $("#lights-at-night-legend").hide();
        }
      }).prop('checked', showLightsAtNightLayer);

      $("#show-lights-at-night-2012").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-lights-at-night").prop('checked')) {
            $("#show-lights-at-night").click();
          }
          if ($("#show-lights-at-night-2016").prop('checked')) {
            $("#show-lights-at-night-2016").click();
          }
          showLightsAtNight2012Layer = true;
          timelineType = "none";
          $("#lights-at-night-2012-legend").show();
        } else {
          showLightsAtNight2012Layer = false;
          timelineType = "customUI";
          $("#lights-at-night-2012-legend").hide();
        }
      }).prop('checked', showLightsAtNight2012Layer);

      $("#show-lights-at-night-2016").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-lights-at-night").prop('checked')) {
            $("#show-lights-at-night").click();
          }
          if ($("#show-lights-at-night-2012").prop('checked')) {
            $("#show-lights-at-night-2012").click();
          }
          showLightsAtNight2016Layer = true;
          timelineType = "none";
          $("#lights-at-night-2016-legend").show();
        } else {
          showLightsAtNight2016Layer = false;
          timelineType = "customUI";
          $("#lights-at-night-2016-legend").hide();
        }
      }).prop('checked', showLightsAtNight2016Layer);

      $("#show-monthly-refugees").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-annual-refugees").prop('checked')) {
            $("#show-annual-refugees").click();
          }
          showMonthlyRefugeesLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("monthly-refugees-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.85);
          timelapse.setPlaybackRate(.425);
          timelapse.setDoDwell(false);
          $("#monthly-refugees-legend").show();
        } else {
          showMonthlyRefugeesLayer = false;
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#monthly-refugees-legend").hide();
        }
      }).prop('checked', showMonthlyRefugeesLayer);


      $("#show-annual-refugees").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-monthly-refugees").prop('checked')) {
            $("#show-monthly-refugees").click();
          }
          showAnnualRefugeesLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("annual-refugees-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.045);
          timelapse.setPlaybackRate(.0225);
          $("#annual-refugees-legend").show();
        } else {
          showAnnualRefugeesLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          timelapse.setMaxScale(landsatMaxScale);
          $("#annual-refugees-legend").hide();
        }
      }).prop('checked', showAnnualRefugeesLayer);

      $("#show-annual-returns").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-monthly-refugees").prop('checked')) {
            $("#show-monthly-refugees").click();
          }
          showAnnualReturnsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("annual-refugees-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.045);
          timelapse.setPlaybackRate(.0225);
          $("#annual-returns-legend").show();
        } else {
          showAnnualReturnsLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          timelapse.setMaxScale(landsatMaxScale);
          $("#annual-returns-legend").hide();
        }
      }).prop('checked', showAnnualReturnsLayer);

      $("#show-vsi").on("click", function() {
        if ($(this).prop('checked')) {
          showVsiLayer = true;
          timelineType = "none";
          $("#vsi-legend").show();
        } else {
          showVsiLayer = false;
          timelineType = "customUI";
          $("#vsi-legend").hide();
        }
      }).prop('checked', showVsiLayer);

      $("#show-health-impact-rcp2p6").on("click", function() {
        if ($(this).prop('checked')) {
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHealthImpactLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("health-impact-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.05);
          timelapse.setPlaybackRate(.05);
          timelapse.setDoDwell(false);
          $("#health-impact-legend").show();
          showHealthImpactRcp[0] = true;
        } else {
          showHealthImpactRcp[0] = false;
          setActiveLayersWithTimeline(-1);
          if (!showHealthImpactRcp[1] && !showHealthImpactRcp[2] && !showHealthImpactRcp[3]) {
            showHealthImpactLayer = false;
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            timelapse.setDoDwell(true);
            timelapse.setMaxScale(landsatMaxScale);
            $("#health-impact-legend").hide();
          }
        }
      }).prop('checked', showHealthImpactLayer);

      $("#show-health-impact-rcp4p5").on("click", function() {
        if ($(this).prop('checked')) {
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHealthImpactLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("health-impact-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.05);
          timelapse.setPlaybackRate(.05);
          timelapse.setDoDwell(false);
          $("#health-impact-legend").show();
          showHealthImpactRcp[1] = true;
        } else {
          showHealthImpactRcp[1] = false;
          setActiveLayersWithTimeline(-1);
          if (!showHealthImpactRcp[0] && !showHealthImpactRcp[2] && !showHealthImpactRcp[3]) {
            showHealthImpactLayer = false;
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            timelapse.setDoDwell(true);
            timelapse.setMaxScale(landsatMaxScale);
            $("#health-impact-legend").hide();
          }
        }
      }).prop('checked', showHealthImpactLayer);

      $("#show-health-impact-rcp6p0").on("click", function() {
        if ($(this).prop('checked')) {
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHealthImpactLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("health-impact-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.05);
          timelapse.setPlaybackRate(.05);
          timelapse.setDoDwell(false);
          $("#health-impact-legend").show();
          showHealthImpactRcp[2] = true;
        } else {
          showHealthImpactRcp[2] = false;
          setActiveLayersWithTimeline(-1);
          if (!showHealthImpactRcp[0] && !showHealthImpactRcp[1] && !showHealthImpactRcp[3]) {
            showHealthImpactLayer = false;
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            timelapse.setDoDwell(true);
            timelapse.setMaxScale(landsatMaxScale);
            $("#health-impact-legend").hide();
          }
        }
      }).prop('checked', showHealthImpactLayer);

      $("#show-health-impact-rcp8p5").on("click", function() {
        if ($(this).prop('checked')) {
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHealthImpactLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("health-impact-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.05);
          timelapse.setPlaybackRate(.05);
          $("#health-impact-legend").show();
          showHealthImpactRcp[3] = true;
        } else {
          showHealthImpactRcp[3] = false;
          setActiveLayersWithTimeline(-1);
          if (!showHealthImpactRcp[0] && !showHealthImpactRcp[1] && !showHealthImpactRcp[2]) {
            showHealthImpactLayer = false;
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            timelapse.setDoDwell(true);
            timelapse.setMaxScale(landsatMaxScale);
            $("#health-impact-legend").hide();
          }
        }
      }).prop('checked', showHealthImpactLayer);

      $("#show-zika").on("click", function() {
        if ($(this).prop('checked')) {
          showZikaLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          // TODO: Hack timeline to show all of 2016 for Zika
          requestNewTimeline("zika-times.json", timelineType);
          $("#zika-legend").show();
        } else {
          showZikaLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#zika-legend").hide();
        }
      }).prop('checked', showZikaLayer);

      $("#show-dengue").on("click", function() {
        if ($(this).prop('checked')) {
          showDengueLayer = true;
          timelineType = "customUI";
          setActiveLayersWithTimeline(1);
          $("#dengue-legend").show();
        } else {
          showDengueLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#dengue-legend").hide();
        }
      }).prop('checked', showDengueLayer);

      $("#show-chiku").on("click", function() {
        if ($(this).prop('checked')) {
          showChikuLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          $("#chiku-legend").show();
        } else {
          showChikuLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#chiku-legend").hide();
        }
      }).prop('checked', showChikuLayer);

      $("#show-sea-level-rise-1p0").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-sea-level-rise-1p5").prop('checked')) {
            $("#show-sea-level-rise-1p5").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-2p0").prop('checked')) {
            $("#show-sea-level-rise-2p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-4p0").prop('checked')) {
            $("#show-sea-level-rise-4p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          showSeaLevelRiseLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sea-level-rise-1p0-times.json", timelineType);
          $("#sea-level-rise-legend").show();
        } else {
          showSeaLevelRiseLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#sea-level-rise-legend").hide();
        }
      }).prop('checked', showSeaLevelRiseLayer);

      $("#show-sea-level-rise-1p5").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-sea-level-rise-1p0").prop('checked')) {
            $("#show-sea-level-rise-1p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-2p0").prop('checked')) {
            $("#show-sea-level-rise-2p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-4p0").prop('checked')) {
            $("#show-sea-level-rise-4p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          showSeaLevelRiseLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sea-level-rise-1p5-times.json", timelineType);
          $("#sea-level-rise-legend").show();
        } else {
          showSeaLevelRiseLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#sea-level-rise-legend").hide();
        }
      }).prop('checked', showSeaLevelRiseLayer);

      $("#show-sea-level-rise-2p0").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-sea-level-rise-1p0").prop('checked')) {
            $("#show-sea-level-rise-1p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-1p5").prop('checked')) {
            $("#show-sea-level-rise-1p5").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-4p0").prop('checked')) {
            $("#show-sea-level-rise-4p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          showSeaLevelRiseLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sea-level-rise-2p0-times.json", timelineType);
          $("#sea-level-rise-legend").show();
        } else {
          showSeaLevelRiseLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#sea-level-rise-legend").hide();
        }
      }).prop('checked', showSeaLevelRiseLayer);

      $("#show-sea-level-rise-4p0").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-sea-level-rise-1p0").prop('checked')) {
            $("#show-sea-level-rise-1p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-2p0").prop('checked')) {
            $("#show-sea-level-rise-2p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-1p5").prop('checked')) {
            $("#show-sea-level-rise-1p5").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          showSeaLevelRiseLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sea-level-rise-times.json", timelineType);
          $("#sea-level-rise-legend").show();
        } else {
          showSeaLevelRiseLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#sea-level-rise-legend").hide();
        }
      }).prop('checked', showSeaLevelRiseLayer);

      $("#show-urban-fragility").on("click", function() {
        if ($(this).prop('checked')) {
          showUrbanFragilityLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("urban-fragility-times.json", timelineType);
          $("#urban-fragility-legend").show();
        } else {
          showUrbanFragilityLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#urban-fragility-legend").hide();
        }
      }).prop('checked', showUrbanFragilityLayer);

      $("#show-gtd").on("click", function() {
        if ($(this).prop('checked')) {
          showGtdLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          $("#gtd-legend").show();
        } else {
          showGtdLayer = false;
          setActiveLayersWithTimeline(-1);
          $("#gtd-legend").hide();
        }
      }).prop('checked', showGtdLayer);

      $("#show-uppsala-conflict").on("click", function() {
        if ($(this).prop('checked')) {
          showUppsalaConflictLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("uppsala-conflict-times.json", timelineType);
          $("#uppsala-conflict-legend").show();
        } else {
          showUppsalaConflictLayer = false;
          setActiveLayersWithTimeline(-1);
          $("#uppsala-conflict-legend").hide();
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
        }
      }).prop('checked', showUppsalaConflictLayer);

      $("#show-hiv").on("click", function() {
        if ($(this).prop('checked')) {
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHivLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("hiv-times.json", timelineType);
          timelapse.setPlaybackRate(0.5);
          $("#hiv-legend").show();
        } else {
          showHivLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#hiv-legend").hide();
        }
      }).prop('checked', showHivLayer);

      $("#show-obesity").on("click", function() {
        if ($(this).prop('checked')) {
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showObesityLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("obesity-times.json", timelineType);
          timelapse.setMasterPlaybackRate(2);
          timelapse.setPlaybackRate(2);
          $("#obesity-legend").show();
        } else {
          showObesityLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#obesity-legend").hide();
        }
      }).prop('checked', showObesityLayer);

      $("#show-vaccine-confidence-q1").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-vaccine-confidence-q2").prop('checked')) {
            $("#show-vaccine-confidence-q2").prop('checked', false);
            $("#vaccine-confidence-q2-legend").hide();
          }
          if ($("#show-vaccine-confidence-q3").prop('checked')) {
            $("#show-vaccine-confidence-q3").prop('checked', false);
            $("#vaccine-confidence-q3-legend").hide();
          }
          if ($("#show-vaccine-confidence-q4").prop('checked')) {
            $("#show-vaccine-confidence-q4").prop('checked', false);
            $("#vaccine-confidence-q4-legend").hide();
          }
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showVaccineConfidenceLayer = true;
          timelineType = "none";
          $("#vaccine-confidence-q1-legend").show();
        } else {
          showVaccineConfidenceLayer = false;
          timelineType = "customUI";
          $("#vaccine-confidence-q1-legend").hide();
        }
      }).prop('checked', showVaccineConfidenceLayer);

      $("#show-vaccine-confidence-q2").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-vaccine-confidence-q1").prop('checked')) {
            $("#show-vaccine-confidence-q1").prop('checked', false);
            $("#vaccine-confidence-q1-legend").hide();
          }
          if ($("#show-vaccine-confidence-q3").prop('checked')) {
            $("#show-vaccine-confidence-q3").prop('checked', false);
            $("#vaccine-confidence-q3-legend").hide();
          }
          if ($("#show-vaccine-confidence-q4").prop('checked')) {
            $("#show-vaccine-confidence-q4").prop('checked', false);
            $("#vaccine-confidence-q4-legend").hide();
          }
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showVaccineConfidenceLayer = true;
          timelineType = "none";
          $("#vaccine-confidence-q2-legend").show();
        } else {
          showVaccineConfidenceLayer = false;
          timelineType = "customUI";
          $("#vaccine-confidence-q2-legend").hide();
        }
      }).prop('checked', showVaccineConfidenceLayer);

      $("#show-vaccine-confidence-q3").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-vaccine-confidence-q1").prop('checked')) {
            $("#show-vaccine-confidence-q1").prop('checked', false);
            $("#vaccine-confidence-q1-legend").hide();
          }
          if ($("#show-vaccine-confidence-q2").prop('checked')) {
            $("#show-vaccine-confidence-q2").prop('checked', false);
            $("#vaccine-confidence-q2-legend").hide();
          }
          if ($("#show-vaccine-confidence-q4").prop('checked')) {
            $("#show-vaccine-confidence-q4").prop('checked', false);
            $("#vaccine-confidence-q4-legend").hide();
          }
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showVaccineConfidenceLayer = true;
          timelineType = "none";
          $("#vaccine-confidence-q3-legend").show();
        } else {
          showVaccineConfidenceLayer = false;
          timelineType = "customUI";
          $("#vaccine-confidence-q3-legend").hide();
        }
      }).prop('checked', showVaccineConfidenceLayer);

      $("#show-vaccine-confidence-q4").on("click", function() {
        if ($(this).prop('checked')) {
          if ($("#show-vaccine-confidence-q1").prop('checked')) {
            $("#show-vaccine-confidence-q1").prop('checked', false);
            $("#vaccine-confidence-q1-legend").hide();
          }
          if ($("#show-vaccine-confidence-q3").prop('checked')) {
            $("#show-vaccine-confidence-q3").prop('checked', false);
            $("#vaccine-confidence-q3-legend").hide();
          }
          if ($("#show-vaccine-confidence-q2").prop('checked')) {
            $("#show-vaccine-confidence-q2").prop('checked', false);
            $("#vaccine-confidence-q2-legend").hide();
          }
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showVaccineConfidenceLayer = true;
          timelineType = "none";
          $("#vaccine-confidence-q4-legend").show();
        } else {
          showVaccineConfidenceLayer = false;
          timelineType = "customUI";
          $("#vaccine-confidence-q4-legend").hide();
        }
      }).prop('checked', showVaccineConfidenceLayer);

      $("#show-ebola-deaths").on("click", function() {
        if ($(this).prop('checked')) {
          showEbolaDeathsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("ebola-times.json", timelineType);
          timelapse.setPlaybackRate(1);
          $("#ebola-deaths-legend").show();
        } else {
          showEbolaDeathsLayer = false;
          setActiveLayersWithTimeline(-1);
          if (!$("#show-ebola-cases").prop('checked') && !$("#show-ebola-new-cases").prop('checked')) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
          $("#ebola-deaths-legend").hide();
        }
      }).prop('checked', showEbolaDeathsLayer);

      $("#show-ebola-cases").on("click", function() {
        if ($(this).prop('checked')) {
          showEbolaCasesLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("ebola-times.json", timelineType);
          timelapse.setPlaybackRate(1);
          $("#ebola-cases-legend").show();
        } else {
          showEbolaCasesLayer = false;
          setActiveLayersWithTimeline(-1);
          if (!$("#show-ebola-deaths").prop('checked') && !$("#show-ebola-new-cases").prop('checked')) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
          $("#ebola-cases-legend").hide();
        }
      }).prop('checked', showEbolaCasesLayer);

      $("#show-ebola-new-cases").on("click", function() {
        if ($(this).prop('checked')) {
          showEbolaNewCasesLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("ebola-times.json", timelineType);
          timelapse.setPlaybackRate(1);
          $("#ebola-new-cases-legend").show();
        } else {
          showEbolaNewCasesLayer = false;
          setActiveLayersWithTimeline(-1);
          if (!$("#show-ebola-deaths").prop('checked') && !$("#show-ebola-cases").prop('checked')) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
          $("#ebola-new-cases-legend").hide();
        }
      }).prop('checked', showEbolaNewCasesLayer);

      $("#show-lodes").on("click", function() {
        var dg = document.getElementsByClassName("dg ac")[0];
        if ($(this).prop('checked')) {
          if (visibleBaseMapLayer != "light") {
            $("#light-base").click();
          }
          dg["style"]["display"] = "block";
          showLodesLayer = true;
          timelineType = "none";
          $("#lodes-legend").show();
        } else {
          showLodesLayer = false;
          timelineType = "customUI";
          dg["style"]["display"] = "none";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#lodes-legend").hide();
        }
      }).prop('checked', showLodesLayer);

      $("#show-cumulative-active-mining").on("click", function() {
        if ($(this).prop('checked')) {
          showCumulativeActiveMiningLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          $("#cumulative-active-mining-legend").show();
        } else {
          showCumulativeActiveMiningLayer = false;
          setActiveLayersWithTimeline(-1);
          $("#cumulative-active-mining-legend").hide();
        }
      }).prop('checked', showCumulativeActiveMiningLayer);

      $("#show-iraq-iom-idp").on("click", function() {
        if ($(this).prop('checked')) {
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("iraq-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showIrqIdps'] = true;
          timelapse.setMasterPlaybackRate(.5);
          timelapse.setPlaybackRate(.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showIrqIdps'] = false;
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-syria-iom-idp").on("click", function() {
        if ($(this).prop('checked')) {
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("syria-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showSyrIdps'] = true;
          timelapse.setMasterPlaybackRate(.5);
          timelapse.setPlaybackRate(.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showSyrIdps'] = false;
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-yemen-iom-idp").on("click", function() {
        if ($(this).prop('checked')) {
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("yemen-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showYemIdps'] = true;
          timelapse.setMasterPlaybackRate(.5);
          timelapse.setPlaybackRate(.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showYemIdps'] = false;
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-libya-iom-idp").on("click", function() {
        if ($(this).prop('checked')) {
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("libya-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showLbyIdps'] = true;
          timelapse.setMasterPlaybackRate(.5);
          timelapse.setPlaybackRate(.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showLbyIdps'] = false;
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-iraq-iom-return").on("click", function() {
        if ($(this).prop('checked')) {
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("iraq-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showIrqReturns'] = true;
          timelapse.setMasterPlaybackRate(.5);
          timelapse.setPlaybackRate(.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showIrqReturns'] = false;
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-syria-iom-return").on("click", function() {
        if ($(this).prop('checked')) {
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("syria-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showSyrReturns'] = true;
          timelapse.setMasterPlaybackRate(.5);
          timelapse.setPlaybackRate(.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showSyrReturns'] = false;
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-yemen-iom-return").on("click", function() {
        if ($(this).prop('checked')) {
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("yemen-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showYemReturns'] = true;
          timelapse.setMasterPlaybackRate(.5);
          timelapse.setPlaybackRate(.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showYemReturns'] = false;
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-libya-iom-return").on("click", function() {
        if ($(this).prop('checked')) {
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("libya-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showLbyReturns'] = true;
          timelapse.setMasterPlaybackRate(.5);
          timelapse.setPlaybackRate(.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showLbyReturns'] = false;
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-omi-no2").on("click", function() {
        if ($(this).prop('checked')) {
          showOmiNo2Layer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("omi-no2-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(12);
          timelapse.setMasterPlaybackRate(.5);
          timelapse.setPlaybackRate(.1);
          $("#omi-no2-legend").show();
        } else {
          showOmiNo2Layer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#omi-no2-legend").hide();
        }
      }).prop('checked', showOmiNo2Layer);


      $("#show-be-pm25").on("click", function() {
        if ($(this).prop('checked')) {
          showBePm25Layer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("be-pm25-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(22);
          $("#be-pm25-legend").show();
        } else {
          showBePm25Layer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          var v = timelapse.getVideoset();
          v.setFps(10);
          $("#be-pm25-legend").hide();
        }
      }).prop('checked', showBePm25Layer);

      $("#show-china-aviation").on("click", function() {
        if ($(this).prop('checked')) {
          showChinaAviationLayer = true;
          $("#china-aviation-legend").show();
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
        } else {
          showChinaAviationLayer = false;
          $("#china-aviation-legend").hide();
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
        }
      }).prop('checked', showChinaAviationLayer);

      $("#show-china-power-plants").on("click", function() {
        if ($(this).prop('checked')) {
          showChinaPowerPlantsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          //requestNewTimeline("china-power-plants-times.json", timelineType);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#china-power-plants-legend").show();
        } else {
          showChinaPowerPlantsLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#china-power-plants-legend").hide();
        }
      }).prop('checked', showChinaPowerPlantsLayer);

      $("#show-china-reservoirs").on("click", function() {
        if ($(this).prop('checked')) {
          showChinaReservoirsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("china-reservoirs-times.json", timelineType);
          $("#china-reservoirs-legend").show();
        } else {
          showChinaReservoirsLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#china-reservoirs-legend").hide();
        }
      }).prop('checked', showChinaReservoirsLayer);

      $("#show-china-waste-treatment-plants").on("click", function() {
        if ($(this).prop('checked')) {
          showChinaWasteTreatmentPlantsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          //requestNewTimeline("china-waste-treatment-plants-times.json", timelineType);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);

          $("#china-waste-treatment-plants-legend").show();
        } else {
          showChinaWasteTreatmentPlantsLayer = false;
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#china-waste-treatment-plants-legend").hide();
        }
      }).prop('checked', showChinaWasteTreatmentPlantsLayer);

      // Base layers
      $("input:radio[name=base-layers]").on("click", function() {
        visibleBaseMapLayer = $(this).val();
        if (visibleBaseMapLayer == "landsat" && previousVisibleBaseMapLayer != "landsat") {
          setActiveLayersWithTimeline(1);
          if (!showViirsLayer) {
            timelineType = "customUI";
          }
          $(".googleLogo").show();
        } else if (visibleBaseMapLayer != "landsat") {
          if (previousVisibleBaseMapLayer == "landsat")
            setActiveLayersWithTimeline(-1);
          timelineType = "none";
          $(".googleLogo").hide();
        }
        previousVisibleBaseMapLayer = visibleBaseMapLayer;
      });



      // Set the starting base layer
      $('input:radio[name=base-layers][id=' + visibleBaseMapLayer + '-base]').prop('checked', true);

      // Initially set activeLayersWithTimeline to 1 if we first load with landsat enabled.
      // Also set the custom scale.
      if (visibleBaseMapLayer == "landsat") {
        activeLayersWithTimeline = 1;
        timelapse.setMaxScale(landsatMaxScale);
      }

      // Copy over data attributes to selectmenu
      $.widget("ui.selectmenu", $.ui.selectmenu, {
        _renderItem: function(ul, item) {
          var elementdata = item.element.context.dataset;
          var attributesObj = {};
          Object.keys(elementdata).forEach(function(x) {
            attributesObj["data-" + x] = elementdata[x];
          });
          return $('<li>')
            .attr(attributesObj)
            .append(item.label)
            .appendTo(ul);
        }
      });

      var appendTarget = "#timeMachine";
      if (enableLetterboxMode) {
        appendTarget = "#content";
      }
      $("#extras-selector").selectmenu({
        close: function() {
          // Chrome css workaround...
          $("#layers-list.right-panel").hide().show(0);
          $lastSelectedExtra = null;
        },
        position: {
          at: "left top",
          collision: 'flip',
          using: function(coords, feedback) {
            // Using 'flip' above, we ensure that the menu either draws up or down, depending upon how much space we have.
            // Then we place the default select option at either the begining or end based on this direction.
            $("#extras-selector option[id='default-extras-select']").remove();
            $(this).css({
              top: coords.top,
              left: coords.left
            });
            if (feedback.vertical == "top")
              $("#extras-selector").prepend('<option id="default-extras-select" selected="selected" value="select">Select extra content...</option>');
            else
              $("#extras-selector").append('<option id="default-extras-select" selected="selected" value="select">Select extra content...</option>');
            $("#extras-selector").selectmenu("refresh");
          }
        },
        appendTo: appendTarget
      });

      $("#current-location-text-picture").on('load', function() {
        var $current_location_text = $(".current-location-text");
        $(".current-location-text").css("max-width", $(this).width());
      })

      // Use click event rather than selectmenu 'change' since that event is not registered on the touch screen.
      $(".ui-selectmenu-menu").on("click", "li", function(e) {
        $lastSelectedExtra = $(e.currentTarget);
        // Reset automode timer, since clicking a waypoint now closes the extras pop-up.
        snaplapseViewerForPresentationSlider.startAutoModeIdleTimeout();
        var fileName = $(e.currentTarget).data("filename");
        var fileType = $(e.currentTarget).data("type");
        $("#extras-content").dialog('option', 'title', $(e.currentTarget).text());
        var $extrasHtml = "";
        if (fileType == "image") {
          $extrasHtml = '<img src="../../../extras/' + fileName + '">';
          $("#extras-content").html($extrasHtml).dialog("open");
        } else if (fileType == "video") {
          $extrasHtml = '<video id="extras-video" src="../../../extras/' + fileName + '" controls autoplay></video>';
          $("#extras-content").html($extrasHtml).dialog("open");
          $("#extras-video")[0].playbackRate = $(e.currentTarget).data("fileplaybackrate");
          $("#extras-video").gVideo({
            childtheme: 'smalldark'
          });
        } else if (fileType == "iframe") {
          $extrasHtml = '<iframe style="border: 0px; scrolling: no; width: 100%; height: 100%" src="' + $(e.currentTarget).data("linkpath") + '"></iframe>';
          $("#extras-content").html($extrasHtml).dialog("open");
        } else if (fileType == "img") {
          $extrasHtml = '<img id="extras-img" height="100%" style="display: block; margin: 0 auto;" src="../../../extras/' + $(e.currentTarget).data("linkpath") + '">';
          $("#extras-content").html($extrasHtml).dialog("open");
        } else if (fileType == "link") {
          window.location.href = $(e.currentTarget).data("linkpath");
        }
      });

      $("#extras-content").dialog({
        appendTo: "#timeMachine",
        modal: false,
        autoOpen: false,
        draggable: false,
        resizable: false,
        dialogClass: "extras-content-video",
        beforeClose: function(event, ui) {
          var $extrasVideo = $("#extras-video");
          if ($extrasVideo && $extrasVideo[0]) {
            $extrasVideo[0].pause();
            $extrasVideo[0].src = "";
          }
          $("#extras-selector").val("select").selectmenu('refresh');
        }
      }).css({
        'z-index': '2000',
        'left': '0px',
        'top': '0px'
      });

      $(document).keydown(function(e) {
        if (e.target.id == 'location_search') return;
        // 'a' key
        // Quick way to stop animating and go to the beginning
        if (e.keyCode === 65) {
          if (!timelapse.isPaused()) {
            timelapse.handlePlayPause();
          }
          timelapse.seek(0);
        }
        // 's' key
        // Quick way to stop animating and go to the end
        if (e.keyCode === 83) {
          if (!timelapse.isPaused()) {
            timelapse.handlePlayPause();
          }
          timelapse.seek(timelapse.getDuration());
        }
        // 'c' key
        // Quick way to clear all layers
        if (e.keyCode === 67) {
          $(".map-layer-div, .ui-multiselect-checkboxes").find("input:checked").trigger("click");
          var openCategories = $("h3.ui-accordion-header.ui-state-active");
          var availableCategories = $(".map-layer-div").children("h3");
          $.each(openCategories, function(index, value) {
            if (index == 0) return;
            var openIndex = availableCategories.index(openCategories[index]);
            $(".map-layer-div").accordion("option", "active", openIndex);
          });
        }
        // 'l' key (lowercase L)
        // Quick way to turn on automode
        if (e.keyCode === 76) {
          var snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
          snaplapseForPresentationSlider.getSnaplapseViewer().initializeAndRunAutoMode();
        }
        // up/down arrows (but only if a select menu option has already been clicked)
        // Quick way to toggle between the various items under the extras menu
        if ((e.keyCode === 38 || e.keyCode === 40) && $lastSelectedExtra) {
          // up arrow
          if (e.keyCode === 38) {
            $lastSelectedExtra.prev().click();
          } else {
            $lastSelectedExtra.next().click();
          }
        } else if (e.keyCode === 38) {
          var dotmaps = $("[id^='show-dotmap']");
          for (var i = 0; i < dotmaps.length; i++) {
            if ($(dotmaps[i]).prop('checked')) {
              $(dotmaps[i-1]).click();
              e.preventDefault();
              break;
            }
          }
        } else if (e.keyCode === 40) {
          var dotmaps = $("[id^='show-dotmap']");
          for (var i = 0; i < dotmaps.length; i++) {
            if ($(dotmaps[i]).prop('checked')) {
              $(dotmaps[i+1]).click();
              e.preventDefault();
              break;
            }
          }
        }
        // Bring up share view dialog
        if (keysDown.indexOf(e.keyCode) < 0) {
          keysDown.push(e.keyCode);
          // SHIFT + S + V
          if (keysDown[0] === 16 && keysDown[1] === 83 && keysDown[2] === 86) {
            $(".share").trigger("click");
          }
        }
      }).keyup(function(e) {
        keysDown.length = 0;
      });

      // Legend container toggling
      $('.map-layer-checkbox, .ui-multiselect-checkboxes').on("click", function() {
        var selectedLayers = $('.map-layer-checkbox, .ui-multiselect-checkboxes').find("input:checked");
        // Subtract one, since base layers are included in this count but they don't use the legend.
        var numLayersOn = selectedLayers.size() - 1;
        var continueState = true;
        selectedLayers.each(function() {
          if (this.id.indexOf("himawari") > 0) {
            continueState = false;
          } else if (this.id.indexOf("forest-alerts") > 0) {
            continueState = false;
          }
        });
        if (!continueState) return;
        if (numLayersOn == 0) {
          $("#layers-legend").hide();
        } else {
          $("#layers-legend").show();
        }
      });

      $('#layers-list, .ui-multiselect-checkboxes').on("click", "input", function(e) {
        if (e.originalEvent && event.pageX != 0 && event.pageY != 0)
          UTIL.addGoogleAnalyticEvent('button', 'click', 'layer=' + $(this).prop("id"));
      });

      var doSwitchToLandsat = function() {
        // Special case for layers with defaultUI timeline.
        if (timelineType == "defaultUI" && (showViirsLayer || showMonthlyRefugeesLayer || showCrwTimemachineLayer)) {
          return false;
        } else {
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          timelapse.setDoDwell(true);
          WebglVideoTile.useGreenScreen = false;
          var v = timelapse.getVideoset();
          v.setFps(10);
          return true;
        }
      }

      var timelineUIHandler = function(e) {
        var $layerContainer = $(e.target).parents("table");
        var $layerContainerHeader = $layerContainer.prev();
        var $firstlayerContainerHeader = $('.map-layer-div').find("h3").first();
        var numLayersActiveInCurrentContainer = $layerContainer.find("input:checked").length;

        // Add indicator that a layer is on in a category but ignore the first category (base layers)
        if (numLayersActiveInCurrentContainer > 0 && $layerContainerHeader[0].id != $firstlayerContainerHeader[0].id) {
          $layerContainerHeader.append("<span class='.ui-accordion-header-icon ui-icon ui-icon-bullet active-layers-in-category'>");
        } else {
          $layerContainerHeader.find(".active-layers-in-category").remove();
        }

        var isFromUser = true;

        if (showViirsLayer || showDrillingLayer) {
          timelineType = "defaultUI";
        }

        // Toggle off Himawari if any other layer is selected when it is up. Himawari is a special mode.
        // Base layer is part of the checkbox total, hence the > 1 check.
        if (showHimawariTimeMachineLayer && $('.map-layer-checkbox, .ui-multiselect-checkboxes').find("input:checked").not("#show-himawari").length > 1) {
          $("#show-himawari").click();
        }

        // Hide any timelines that are visible if we have no layers up that require a timeline or we are a static layer that fully covers the entire globe
        if (activeLayersWithTimeline <= 0 || (visibleBaseMapLayer == "landsat" && activeLayersWithTimeline == 1 && (showLightsAtNightLayer || showLightsAtNight2012Layer || showLightsAtNight2016Layer || showHansenLayer2 || showVsiLayer))) {
          $(".controls, .customControl").hide();
          $(".customControl").hide();
        } else if (activeLayersWithTimeline > 0) {
          if (timelineType == "customUI") {
            $(".controls, .captureTime").hide();
            $(".customControl").show();
          } else if (timelineType == "defaultUI") {
            $(".customControl").hide();
            $(".controls, .captureTime").show();
          }
        }

        if (e)
          var originalEvent = e.originalEvent;

        if (originalEvent) {
          // If true, event came from user interaction, otherwise it came from javascript
          if (!originalEvent.isTrusted)
            isFromUser = false
          // Browsers without isTrusted property
          if (originalEvent.x == 0 && originalEvent.y == 0)
            isFromUser = false;
          // IE 11
          if (originalEvent.isTrusted && (originalEvent.x == 0 && originalEvent.y == -55))
            isFromUser = false;
        }

        if ((activeLayersWithTimeline >= 1 && visibleBaseMapLayer != "landsat") ||
            (activeLayersWithTimeline == 1 && visibleBaseMapLayer == "landsat" && !(showLightsAtNightLayer || showLightsAtNight2012Layer || showLightsAtNight2016Layer || showHansenLayer2 || showVsiLayer))) {
          if (timelineType == "customUI") {
            $(".customControl").show().children().show();
            if (visibleBaseMapLayer != "landsat") {
              $(".googleLogo").hide();
            }
          } else if (timelineType == "defaultUI") {
            $(".controls, .captureTime").show();
          }
        }

        if (isFromUser && visibleBaseMapLayer != "landsat" && activeLayersWithTimeline == 0)
          $(".customControl").hide().children().hide();

        if (timelineType == "defaultUI") {
          $(".customHelpLabel-touchFriendly").css("top", "-8px");
        } else {
          $(".customHelpLabel-touchFriendly").css("top", "-26px");
        }

      };

      $('#layers-list, .ui-multiselect-checkboxes').on('click', 'input', timelineUIHandler);

      $("body").on("click", ".ui-accordion-header", function() {
        $('.layers-scroll-vertical').animate({
          scrollTop: $(this)[0].offsetTop
        });
      });

      // Make right layers panel vertically touch scrollable.
      try {
        if (document.createEvent("TouchEvent")) {
          verticalTouchScroll(".layers-scroll-vertical");
        }
      } catch (e) {
        // Error creating touch event
      }

      // TODO: Do we need this?
      //timelapse.addTimelineUIChangeListener(timelineUIHandler);
    }
    function setActiveLayersWithTimeline (modifier) {
      previousActiveLayersWithTimeline = activeLayersWithTimeline;
      activeLayersWithTimeline += modifier;
      if (activeLayersWithTimeline < 0) activeLayersWithTimeline = 0;
    };
  </script>

  <script src="../../js/TimeMachineCanvasLayer.js" type="text/javascript"></script>

  <script type="text/javascript" src="../../js/base.js"></script>
  <script type="text/javascript" src="../../js/io.js"></script>
  <script type="text/javascript" src="../../js/polyfills.js"></script>
  <script src="csvFileLayer.js"></script>

  <script type="text/javascript">
    "use strict";

    // BEGIN WebGL vars
    var canvasLayer;
    var gl, glb;


    // ## 4 ##
    //// Layer visibility ////
    //

    var showWdpaLayer = false;
    var showMcrmLayer = false;
    var showHansenLayer = false;
    var showHansenLayer2 = false;
    var showViirsLayer = false;
    var showCoralBleachingLayer = false;
    var showLightsAtNightLayer = false;
    var showLightsAtNight2012Layer = false;
    var showLightsAtNight2016Layer = false;
    var showCrwTimemachineLayer = false;
    var showNdviAnomalyTimemachineLayer = false;
    var showAnimatedHansenLayer = false;
    var showHimawariTimeMachineLayer = false;
    var showForestAlertsTimeMachineLayer = false;
    var showForestAlertsNoOverlayTimeMachineLayer = false;
    var showWaterOccurrenceLayer = false;
    var showWaterChangeLayer = false;
    var showUsgsWindTurbineLayer = false;
    var showGlobalWindPowerLayer = false;
    var showSolarInstallsLayer = false;
    var showDrillingLayer = false;
    var showMonthlyRefugeesLayer = false;
    var showAnnualRefugeesLayer = false;
    var showAnnualReturnsLayer = false;
    var showVsiLayer = false;
    var showHealthImpactLayer = false;
    var showHealthImpactRcp = [false, false, false, false]; // 2.6, 4.5, 6.0, 8.5
    var showZikaLayer = false;
    var showDengueLayer = false;
    var showChikuLayer = false;
    var showSeaLevelRiseLayer = false;
    var showUrbanFragilityLayer = false;
    var showGtdLayer = false;
    var showUppsalaConflictLayer = false;
    var showHivLayer = false;
    var showObesityLayer = false;
    var showVaccineConfidenceLayer = false;
    var showEbolaDeathsLayer = false;
    var showEbolaCasesLayer = false;
    var showEbolaNewCasesLayer = false;
    var showLodesLayer = false;
    var showCumulativeActiveMiningLayer = false;
    var showIomIdpLayer = false;
    var showBerkeleyEarthTemperatureAnomalyTimeMachineLayer = false;
    var showOmiNo2Layer = false;
    var showChinaAviationLayer = false;
    var showChinaPowerPlantsLayer = false;
    var showChinaReservoirsLayer = false;
    var showChinaWasteTreatmentPlantsLayer = false;
    var showBePm25Layer = false;

    // Default Time Machine visibility
    var tileViewVisibility = {
      videoTile: true,
      vectorTile: false
    };

    var waypointsLoadedPath;
    var csvFileLayers = new CsvFileLayer();
    var dotmapLayers = [];
    var dotlayersLoadedPath;
    var layersToShowOnCreation = {};

    function addDotmapLayer(nickname, name, credit, columnDefs) {
      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 10,
        setDataFunction: WebGLVectorTile2.prototype._setColorDotmapData,
        drawFunction: WebGLVectorTile2.prototype._drawColorDotmap,
        fragmentShader: WebGLVectorTile2.colorDotmapFragmentShader,
        vertexShader: WebGLVectorTile2.colorDotmapVertexShader
      };

      var tileUrl = 'http://dotmaptiles.createlab.org:8888/tilesv1/';
      //var tileUrl = 'http://rp.createlab.org:5000/tilesv1/';
      var layerTokens = [];
      for (var i = 0; i < columnDefs.length; i++) {
        layerTokens.push(encodeURIComponent(columnDefs[i].color) + ';' +
                         encodeURIComponent(columnDefs[i].expression.replace(/\s/g, '')));
      }
      tileUrl += layerTokens.join(';;');
      tileUrl += "/{z}/{x}/{y}.bin";
      var layer = new WebglVectorLayer2(glb, canvasLayer, tileUrl, layerOptions);
      dotmapLayers.push(layer);

      var id = 'show-dotmap-' + nickname;

      var row = '<tr><td><label name="' + nickname + '">';
      row += '<input type="checkbox" id="' + id + '">';
      row += name;
      row += '</label></tr>';

      $('#dotmaps_table').last().append(row);

      // Create and insert legend
      var legend='<tr id="' + nickname + '-legend" style="display: none"><td>';
      legend += '<div style="font-size: 17px">' + name
      if (credit) legend += '<span class="credit">(' + credit + ')</span>';
      legend += '</div>'

      legend += '<div style="float: left; padding-right:8px">';
      for (var i = 0; i < columnDefs.length; i++) {
        legend += '<div style="float: left; padding-right:8px">'
        legend += '<div style="background-color:' + columnDefs[i].color + '; width: 12px; height: 12px; float: left; margin-top: 2px; margin-left: 8px;"></div>';
        legend += '&nbsp;' + columnDefs[i].name + '</div>'
      }
      legend += '</div>';
      legend += '</tr>';

      $('#legend-content table tr:last').after(legend);

      // Handle click event to turn on and off layer
      $('#' + id).on("click", function() {
        if ($(this).prop('checked')) {
          // Turn off other dotmap layers
          $('#' + id).prop('checked', false);
          $("[id^='show-dotmap']:checked").click();
          $('#' + id).prop('checked', true);
          // Use dark basemap
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          // Turn on layer
          layer.visible = true;
          timelineType = "none";
          $("#" + nickname + "-legend").show();
        } else {
          // Turn off layer
          layer.visible = false;
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#" + nickname + "-legend").hide();
        }
      }).prop('checked', layer.visible);

      if (layersToShowOnCreation[nickname]) {
        $('#' + id).click();
      }
    }

    function loadDotmapLayersFromTsv(tsvLayerDefinitions) {
      var layerdefs = tsvLayerDefinitions.split('\n').slice(2);
      for (var i = 0; i < layerdefs.length; i++) {
        var layerdef = layerdefs[i].split('\t');
        if (layerdef[0] == 'FALSE') continue;
        var layerIdentifier = layerdef[1].replace(/\W+/g, '_'); // sanitize non-word chars

        var columnDefs = [];
        for (var c = 0; 1; c++) {
          var name = layerdef[c * 3 + 4];
          if (!name) break;
          var color = layerdef[c * 3 + 5];
          var expression = layerdef[c * 3 + 6];
          columnDefs.push({name: name, color: color, expression: expression});
        }
        addDotmapLayer(layerIdentifier, // identifier
                       layerdef[2], // name
                       layerdef[3], // credit
                       columnDefs);
      }
    }

    function loadDotmapLayers(docTabId) {
      // docTabId DOCID.TABID, e.g. 1hFpDXOyjvjTpad7HpB0K-3thuYqSOlDJ4oExCTcscUk.358696896,
      // which would translate into https://docs.google.com/spreadsheets/d/1hFpDXOyjvjTpad7HpB0K-3thuYqSOlDJ4oExCTcscUk/edit#gid=358696896
      var docId = docTabId.split('.')[0];
      var tabId = docTabId.split('.')[1];
      var url = 'https://docs.google.com/spreadsheets/d/' + docId + '/edit';
      if (tabId) {
          url += '#gid=' + tabId;
      }
      org.gigapan.Util.gdocToJSON(url, function(tsvdata) {
        loadDotmapLayersFromTsv(tsvdata);
      });
    }

    function loadDotmapsFromPath(path) {
      if (path == dotlayersLoadedPath) return;
      dotlayersLoadedPath = path;

      // Make fieldset visible, since it may have been hidden on initial page load
      //$('#custom_dotmaps_table').parent().show();
      // Clear out any dot layers that have already been loaded
      //$("#custom_dotmaps_table").find("input:checked").trigger("click");
      //$('#custom_dotmaps_table').empty();

      if (path.indexOf(".tsv") != -1) {
        // Load local version of the dotmaps .tsv file
        $.ajax({
          url: path,
          dataType: "text",
          success: function(csvdata) {
            loadDotmapLayersFromTsv(csvdata);
          }
        });
      } else {
        // Load dotmaps from Google Docs
        loadDotmapLayers(path);
      }
    }

    function loadWaypointSliderContentFromCSV(csvdata) {
      var waypointJSON = JSON.parse(snaplapseForPresentationSlider.CSVToJSON(csvdata));

      // Clear out internal data stores
      jumpToButtons = {};
      annotationPicturePaths = {};
      himawariWaypoints = {};

      for (var i = 0; i < waypointJSON.snaplapse.keyframes.length; i++) {
        var keyframe = waypointJSON.snaplapse.keyframes[i];
        annotationPicturePaths[i] = { path : keyframe.unsafe_string_annotationPicPath };
        // Himawari is a special case.
        // We need to store the bounds and times and then replace them with a default view.
        // The default view allows for a black thumbnail to be used on the waypoint slider instead of some random position in Landsat
        // Then when we actually click the Himawari waypoint, we load up the original bounds and time and use them.
        for (var j = 0; j < keyframe.layers.length; j++) {
          if (keyframe.layers[j] == "h8" || keyframe.layers[j] == "h8_16") {
            // Himawari keyframes made with Landsat 2015 and viewed in Landsat 2016 with reset dimensions
            // do not position correctly and need to be corrected below.
            if (landsatVersion == "2016" && keyframe.layers[j] == "h8") {
              keyframe.bounds.xmin -= 34645;
              keyframe.bounds.xmax -= 30000;
              keyframe.bounds.ymin -= 80931;
              keyframe.bounds.ymax -= 15128;
              var tmp = timelapse.pixelBoundingBoxToPixelCenter(keyframe.bounds);
              tmp.scale *= 2;
              keyframe.bounds = timelapse.pixelCenterToPixelBoundingBoxView(tmp).bbox;
            }

            himawariWaypoints[i] = {
              bounds: keyframe.bounds,
              time: keyframe.time
            };
            keyframe.bounds = himawariWaypointThumbnailBounds;
            keyframe.time = 0;
            break;
          }
        }

        // Sections in the spreadsheet to jump to are flagged by having the title start with a #
        if (keyframe.unsafe_string_frameTitle.indexOf("#") == 0) {
          keyframe.unsafe_string_frameTitle = keyframe.unsafe_string_frameTitle.slice(1);
          jumpToButtons[keyframe.unsafe_string_frameTitle] = i;
        }
      }

      if (Object.keys(jumpToButtons).length > 0) {
        $("#presentation-slider-selection").show();
        // Clear out quick selection bar
        $('#presentation-slider-selection table td:not(:first-child)').remove();
        // Add to quick selection bar
        $.each(jumpToButtons, function(sectionTitle, sectionIdx) {
          $("#presentation-slider-selection > table td:last").after($('<td class="clickable" data-section-idx=' + sectionIdx + '><div>' + sectionTitle + '</div></td>'));
        });
        // Set width on quick selection bar to properly handle page resizes
        $('#presentation-slider-selection table').css("min-width", $('#presentation-slider-selection table').width() + "px");
        if (!enableLetterboxMode) {
          var presentationSliderSelectionHasScroll = $("#presentation-slider-selection")[0].scrollWidth > $("#presentation-slider-selection")[0].clientWidth;
          if (presentationSliderSelectionHasScroll) {
            $("#timeMachine").removeClass("presentationSliderSelection").addClass("presentationSliderSelectionOverflow");
          } else {
            $("#timeMachine").addClass("presentationSliderSelection").removeClass("presentationSliderSelectionOverflow");
          }
        }
      } else {
        $("#presentation-slider-selection").hide();
      }

      waypointSliderContent = "#presentation=" + snaplapseForPresentationSlider.getAsUrlString(waypointJSON.snaplapse.keyframes);
      timelapse.loadSharedDataFromUnsafeURL(waypointSliderContent);
    }

    function loadWaypointsFromGdoc(waypointSliderContentPath) {
      org.gigapan.Util.gdocToJSON(waypointSliderContentPath, function(csvdata) {
        loadWaypointSliderContentFromCSV(csvdata);
      });
    }

    function loadWaypointsFromPath(path) {
      if (path == waypointsLoadedPath) return;
      waypointsLoadedPath = path;

      if (path.indexOf("http") >= 0) {
        // Load waypoints from Google Docs
        loadWaypointsFromGdoc(path);
      } else {
        // Load local version of the waypoints .tsv file
        $.ajax({
          url: path,
          dataType: "text",
          success: function(csvdata) {
            loadWaypointSliderContentFromCSV(csvdata);
          }
        });
      }
    }

    function onTimeMachinePlayerReady() {
      // initialize the canvasLayer
      var timeMachineCanvasLayerOptions = {
        timelapse: timelapse,
        resizeHandler: resize,
        animate: true,
        updateHandler: update,
        resolutionScale: window.devicePixelRatio || 1
      };
      canvasLayer = new TimeMachineCanvasLayer(timeMachineCanvasLayerOptions);

      // initialize WebGL
      gl = canvasLayer.canvas.getContext('experimental-webgl');
      glb = new Glb(gl);

      var layer_html = '';

      layer_html += '<div id="layers-list">';

      var landsat_base_str = '<label class="landsat-select" for="landsat-base" name="blsat"><input type="radio" id="landsat-base" name="base-layers" value="landsat"/>Google Earth Engine Timelapse</label>';
      var landsat_base = '<td colspan="2">' + landsat_base_str + '</td>';
      var light_base = '<td><label for="light-base" name="blte"><input type="radio" id="light-base" name="base-layers" value="light"/><span>Light Map</span></label></td>';
      var dark_base = '<td><label for="dark-base" name="bdrk"><input type="radio" id="dark-base" name="base-layers" value="dark"/><span>Dark Map</span></label></td>';

      // NOTE NOTE NOTE
      // What is set for the name in the label must never be changed and is forever connected to share links
      // The schema for generating the label name is using the initials of the data product. If this ends up conflicting
      // with one that already exists, then it is up to you to come up with something. Perhaps the initials of the name you would
      // give it when describing the layer to someone. Keep it as short as possible though.
      // NOTE NOTE NOTE
      var show_wdpa = '<td class="wdpa-select"><label for="show-wdpa" name="wdpa"><input type="checkbox" id="show-wdpa" />Protected Areas</label></td>';
      var show_forest_change = '<td class="forest-change-select"><label for="show-forest-change" name="fly"><input type="checkbox" id="show-forest-change" />Forest Loss by Year</label></td>';
      var show_forest_loss_gain = '<td class="forest-loss-gain-select"><label for="show-forest-loss-gain" name="flg"><input type="checkbox" id="show-forest-loss-gain" />Forest Loss/Gain</label></td>';
      var show_animated_forest_loss_gain = '<td class="animated-forest-loss-select"><label for="show-animated-forest-loss-gain" name="aflg"><input type="checkbox" id="show-animated-forest-loss-gain" />Animated Loss/Gain</label></td>';
      var show_viirs = '<td class="viirs-select"><label for="show-viirs" name="viirs"><input type="checkbox" id="show-viirs" />Fires at Night</label></td>';
      var show_forest_alerts = '<td class="forest-alerts-select"><label for="show-forest-alerts" name="fla"><input type="checkbox" id="show-forest-alerts" />Forest Loss Alerts</label></td>';
      var show_forest_alert_no_overlay = '<td class="forest-alerts-no-overlay-select"><label for="show-forest-alerts-no-overlay" name="flano"><input type="checkbox" id="show-forest-alerts-no-overlay" />Forest Loss Alerts <span style="font-size: 14px">(No Overlay)</span></label></td>';
      var show_lights_at_night = '<td class="lights-at-night-select"><label for="show-lights-at-night" name="lan"><input type="checkbox" id="show-lights-at-night" />Lights at Night (25 years)</label></td>';
      var show_lights_at_night_2012 = '<td class="lights-at-night-2012-select"><label for="show-lights-at-night-2012" name="lan12"><input type="checkbox" id="show-lights-at-night-2012" />Lights at Night 2012</label></td>';
      var show_lights_at_night_2016 = '<td class="lights-at-night-2016-select"><label for="show-lights-at-night-2016" name="lan16"><input type="checkbox" id="show-lights-at-night-2016" />Lights at Night 2016</label></td>';
      var show_coral = '<td class="coral-select"><label for="show-coral" name="cb"><input type="checkbox" id="show-coral"/>Coral Bleaching</label></td>';
      var show_coral_bleaching_alerts = '<td class="coral-bleaching-select"><label for="show-coral-bleaching-alerts" name="crw"><input type="checkbox" id="show-coral-bleaching-alerts" />Coral Reef Watch</label></td>';
      var show_usgs_windturbine = '<td class="wind-select"><label for="show-usgs-windturbine" name="wp"><input type="checkbox" id="show-usgs-windturbine" />Wind Power (USA)</span></label></td>';
      var show_global_wind_power = '<td class="wind-select"><label for="show-global-wind-power" name="gwp"><input type="checkbox" id="show-global-wind-power" />Wind Power (Global)</label></td>';
      var show_solar_installs = '<td class="solar-select"> <label for="show-solar-installs" name="sp"><input type="checkbox" id="show-solar-installs" />Solar PV (USA)</label></td>';
      var show_drilling = '<td class="drilling-select"><label for="show-drilling" name="drl"><input type="checkbox" id="show-drilling" />Oil/Gas Drilling (USA)</label></td>';
      var show_himawari = '<td class="himawari-select"><label for="show-himawari" name="h8_16"><input type="checkbox" id="show-himawari" />Himawari-8</label></td>';
      var show_water_occurrence = '<td class="water-occurrence-select"><label for="show-water-occurrence" name="wo"><input type="checkbox" id="show-water-occurrence" />Water Occurrence</label></td>';
      var show_water_change = '<td class="water-change-select"><label for="show-water-change" name="wc"><input type="checkbox" id="show-water-change" />Water Change</label></td>';
      var show_monthly_refugees = '<td class="monthly-refugees-select"><label for="show-monthly-refugees" name="mmr"><input type="checkbox" id="show-monthly-refugees" />Mediterranean Refugees</label></td>';
      var show_annual_refugees = '<td class="annual-refugees-select"><label for="show-annual-refugees" name="ar"><input type="checkbox" id="show-annual-refugees" />Global Refugees</label></td>';
      var show_annual_returns = '<td class="annual-returns-select"><label for="show-annual-returns" name="arr"><input type="checkbox" id="show-annual-returns" />Global Returnees</label></td>';
      var show_vsi = '<td class="vsi-select"><label for="show-vsi" name="vsi"><input type="checkbox" id="show-vsi" />Vegetation Sensitivity Index</label></td>';
      var show_health_impact_rcp2p6 = '<td class="health-impact-rcp2p6-select"><label for="show-health-impact-rcp2p6" name="hi-rcp2p6"><input type="checkbox" id="show-health-impact-rcp2p6" />Nutritional Deficiency RCP2.6</label></td>';
      var show_health_impact_rcp4p5 = '<td class="health-impact-rcp4p5-select"><label for="show-health-impact-rcp4p5" name="hi-rcp4p5"><input type="checkbox" id="show-health-impact-rcp4p5" />Nutritional Deficiency RCP4.5</label></td>';
      var show_health_impact_rcp6p0 = '<td class="health-impact-rcp6p0-select"><label for="show-health-impact-rcp6p0" name="hi-rcp6p0"><input type="checkbox" id="show-health-impact-rcp6p0" />Nutritional Deficiency RCP6.0</label></td>';
      var show_health_impact_rcp8p5 = '<td class="health-impact-rcp8p5-select"><label for="show-health-impact-rcp8p5" name="hi-rcp8p5"><input type="checkbox" id="show-health-impact-rcp8p5" />Nutritional Deficiency RCP8.5</label></td>';
      var show_zika = '<td class="zika-select"> <label for="show-zika" name="zv"><input type="checkbox" id="show-zika" />Zika</label></td>';
      var show_dengue = '<td class="dengue-select"> <label for="show-dengue" name="dv"><input type="checkbox" id="show-dengue" />Dengue</label></td>';
      var show_chiku = '<td class="chiku-select"> <label for="show-chiku" name="cv"><input type="checkbox" id="show-chiku" />Chikungunya</label></td>';
      var show_sea_level_rise_1p0 = '<td class="sea-level-rise-1p0-select"><label for="show-sea-level-rise-1p0" name="slr10"><input type="checkbox" id="show-sea-level-rise-1p0" />Sea Level Rise 1.0 &deg; C</label></td>';
      var show_sea_level_rise_1p5 = '<td class="sea-level-rise-1p5-select"><label for="show-sea-level-rise-1p5" name="slr15"><input type="checkbox" id="show-sea-level-rise-1p5" />Sea Level Rise 1.5 &deg; C</label></td>';
      var show_sea_level_rise_2p0 = '<td class="sea-level-rise-2p0-select"><label for="show-sea-level-rise-2p0" name="slr2"><input type="checkbox" id="show-sea-level-rise-2p0" />Sea Level Rise 2.0 &deg; C</label></td>';
      var show_sea_level_rise_4p0 = '<td class="sea-level-rise-4p0-select"><label for="show-sea-level-rise-4p0" name="slr4"><input type="checkbox" id="show-sea-level-rise-4p0" />Sea Level Rise 4.0 &deg; C</label></td>';
      var show_urban_fragility = '<td class="urban-fragility-select"><label for="show-urban-fragility" name="uf"><input type="checkbox" id="show-urban-fragility" />Urban Fragility</label></td>';
      var show_gtd = '<td class="gtd-select"><label for="show-gtd" name="gtd"><input type="checkbox" id="show-gtd" />Global Terrorism Database</label></td>';
      var show_uppsala_conflict = '<td class="uppsala-conflict-select"><label for="show-uppsala-conflict" name="uppsala-conflict"><input type="checkbox" id="show-uppsala-conflict" />UCDP Event Dataset</label></td>';
      var show_hiv = '<td class="hiv-select"><label for="show-hiv" name="hiv"><input type="checkbox" id="show-hiv" />HIV Infections</label></td>';
      var show_obesity = '<td class="obesity-select"><label for="show-obesity" name="obesity"><input type="checkbox" id="show-obesity" />Obesity</label></td>';
      var show_vaccine_confidence_q1 = '<td class="vaccine-confidence-q1-select"><label for="show-vaccine-confidence-q1" name="vc1"><input type="checkbox" id="show-vaccine-confidence-q1" />Vaccines & Children</label></td>';
      var show_vaccine_confidence_q2 = '<td class="vaccine-confidence-q2-select"><label for="show-vaccine-confidence-q2" name="vc2"><input type="checkbox" id="show-vaccine-confidence-q2" />Vaccine Safety</label></td>';
      var show_vaccine_confidence_q3 = '<td class="vaccine-confidence-q3-select"><label for="show-vaccine-confidence-q3" name="vc3"><input type="checkbox" id="show-vaccine-confidence-q3" />Vaccine Effectiveness</label></td>';
      var show_vaccine_confidence_q4 = '<td class="vaccine-confidence-q4-select"><label for="show-vaccine-confidence-q4" name="vc4"><input type="checkbox" id="show-vaccine-confidence-q4" />Vaccines & Religion</label></td>';
      var show_ndvi_anomaly = '<td class="ndvi-anomaly-select"><label for="show-ndvi-anomaly" name="ndvia"><input type="checkbox" id="show-ndvi-anomaly" />Vegetation Index Reduction</label></td>';
      var show_ebola_deaths = '<td class="ebola-deaths-select"><label for="show-ebola-deaths" name="ed"><input type="checkbox" id="show-ebola-deaths" />Ebola Deaths</label></td>';
      var show_ebola_cases = '<td class="ebola-cases-select"><label for="show-ebola-cases" name="ec"><input type="checkbox" id="show-ebola-cases" />Ebola Cases</label></td>';
      var show_ebola_new_cases = '<td class="ebola-new-cases-select"><label for="show-ebola-new-cases" name="enc"><input type="checkbox" id="show-ebola-new-cases" />Ebola New Cases</label></td>';
      var show_lodes = '<td class="lodes-select"><label for="show-lodes" name="lodes"><input type="checkbox" id="show-lodes" />LODES</label></td>';
      var show_cumulative_active_mining_layer = '<td class="cumulative-active-mining-select"><label for="show-cumulative-active-mining" name="cumulative-active-mining"><input type="checkbox" id="show-cumulative-active-mining" />Active Mining</label></td>';
      var show_iraq_iom_idp = '<td class="iraq-iom-idp-select"><label for="show-iraq-iom-idp" name="iraq-iom-idp"><input type="checkbox" id="show-iraq-iom-idp" />Iraq IDPs</label></td>';
      var show_syria_iom_idp = '<td class="syria-iom-idp-select"><label for="show-syria-iom-idp" name="syria-iom-idp"><input type="checkbox" id="show-syria-iom-idp" />Syria IDPs</label></td>';
      var show_libya_iom_idp = '<td class="libya-iom-idp-select"><label for="show-libya-iom-idp" name="libya-iom-idp"><input type="checkbox" id="show-libya-iom-idp" />Libya IDPs</label></td>';
      var show_yemen_iom_idp = '<td class="yemen-iom-idp-select"><label for="show-yemen-iom-idp" name="yemen-iom-idp"><input type="checkbox" id="show-yemen-iom-idp" />Yemen IDPs</label></td>';
      var show_iraq_iom_return = '<td class="iraq-iom-return-select"><label for="show-iraq-iom-return" name="iraq-iom-return"><input type="checkbox" id="show-iraq-iom-return" />Iraq Returnees</label></td>';
      var show_syria_iom_return = '<td class="syria-iom-return-select"><label for="show-syria-iom-return" name="syria-iom-return"><input type="checkbox" id="show-syria-iom-return" />Syria Returnees</label></td>';
      var show_libya_iom_return = '<td class="libya-iom-return-select"><label for="show-libya-iom-return" name="libya-iom-return"><input type="checkbox" id="show-libya-iom-return" />Libya Returnees</label></td>';
      var show_yemen_iom_return = '<td class="yemen-iom-return-select"><label for="show-yemen-iom-return" name="yemen-iom-return"><input type="checkbox" id="show-yemen-iom-return" />Yemen Returnees</label></td>';
      var show_berkeley_earth_temperature_anomaly = '<td class="berkeley-earth-temperature-anomaly-select"><label for="show-berkeley-earth-temperature-anomaly" name="berkeley-earth-temperature-anomaly"><input type="checkbox" id="show-berkeley-earth-temperature-anomaly" />Temperature Anomaly</label></td>';
      var show_omi_no2 = '<td class="omi-no2-select"><label for="show-omi-no2" name="omi-no2"><input type="checkbox" id="show-omi-no2" />OMI NO2</label></td>';
      var show_be_pm25 = '<td class="be-pm25-select"><label for="show-be-pm25" name="be-pm25"><input type="checkbox" id="show-be-pm25" />Berkeley Earth -- PM2.5</label></td>';
      var show_china_aviation = '<td class="china-aviation-select"><label for="show-china-aviation" name="china-aviation"><input type="checkbox" id="show-china-aviation" />China Aviation</label></td>';
      var show_china_power_plants = '<td class="china-power-plants-select"><label for="show-china-power-plants" name="china-power-plants"><input type="checkbox" id="show-china-power-plants" />China Power Plants</label></td>';
      var show_china_reservoirs = '<td class="china-reservoirs-select"><label for="show-china-reservoirs" name="china-reservoirs"><input type="checkbox" id="show-china-reservoirs" />China Reservoirs</label></td>';
      var show_china_waste_treatment_plants = '<td class="china-waste-treatment-plants-select"><label for="show-china-waste-treatment-plants" name="china-waste-treatment-plants"><input type="checkbox" id="show-china-waste-treatment-plants" />China Waste Treatment Plants</label></td>';


      if (enableLetterboxMode) {
        layer_html += '<div class="base-map-div">';
        layer_html += ' <table class="base-map-radio" cellspacing="3">';
        layer_html += '   <tr>';
        layer_html += landsat_base;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += light_base;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += dark_base;
        layer_html += '   </tr>';
        layer_html += ' </table>';
        layer_html += '</div>';
        layer_html += '<div class="map-layer-div" style="color: white">';
        layer_html += '  <table class="map-layer-checkbox" cellspacing="3">';

        layer_html += '    <tr>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 10px; text-align: right">';
        layer_html += '        Forests:';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 70px;">';
        layer_html += '        <select id="forest-theme" multiple="multiple" size="6">';
        layer_html += '          <option value="option1" data-id="show-forest-change" data-name="fly" data-credit="Hansen et al">Forest Loss By Year</option>';
        layer_html += '          <option value="option2" data-id="show-forest-alerts" data-name="fla" data-credit="Hansen et al">Forest Alerts (Overlay)</option>';
        layer_html += '          <option value="option3" data-id="show-forest-loss-gain" data-name="flg" data-credit="Hansen et al">Forest Loss/Gain</option>';
        layer_html += '          <option value="option4" data-id="show-forest-alerts-no-overlay" data-name="flano" data-credit="Hansen et al">Forest Alerts (No Overlay)</option>';
        layer_html += '          <option value="option5" data-id="show-animated-forest-loss-gain" data-name="aflg" data-credit="Hansen et al">Animated Loss/Gain</option>';
        layer_html += '          <option value="option6" data-id="show-wdpa" data-name="wdpa" data-credit="UNEP-WCMC">Protected Areas</option>';
        layer_html += '        </select>';
        layer_html += '        <button class="clear-theme" type="button">Clear <br>Theme</button>';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 10px; text-align: right">';
        layer_html += '        Energy:';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 70px;">';
        layer_html += '        <select id="energy-theme" multiple="multiple" size="5">';
        layer_html += '          <option value="option1" data-id="show-solar-installs" data-name="sp" data-credit="NREL">US Solar PV</option>';
        layer_html += '          <option value="option2" data-id="show-usgs-windturbine" data-name="wp" data-credit="USGS">US Wind Power</option>';
        layer_html += '          <option value="option3" data-id="show-drilling" data-name="drl" data-credit="FracTracker, CREATE Lab">US Oil/Gas Drilling</option>';
        layer_html += '          <option value="option4" data-id="show-global-wind-power" data-name="gwp" data-credit="TheWindPower.net">Global Wind Power</option>';
        layer_html += '          <option value="option5" data-id="show-viirs" data-name="viirs" data-credit="NOAA">Fires at Night</option>';
        layer_html += '        </select>';
        layer_html += '        <button class="clear-theme" type="button">Clear <br>Theme</button>';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 10px; text-align: right">';
        layer_html += '        Pandemics:';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 70px;">';
        layer_html += '        <select id="pandemic-theme" multiple="multiple" size="10">';
        layer_html += '          <option value="option1" data-id="show-zika" data-name="zv" data-credit="LSHTM">Zika</option>';
        layer_html += '          <option value="option2" data-id="show-dengue" data-name="dv" data-credit="LSHTM">Dengue</option>';
        layer_html += '          <option value="option3" data-id="show-chiku" data-name="cv" data-credit="LSHTM">Chikungunya</option>';
        layer_html += '          <option value="option4" data-id="show-ebola-deaths" data-name="ed" data-credit="LSHTM">Ebola Deaths</option>';
        layer_html += '          <option value="option5" data-id="show-hiv" data-name="hiv" data-credit="LSHTM">HIV Infections</option>';
        layer_html += '          <option value="option6" data-id="show-obesity" data-name="obesity" data-credit="LSHTM">Obesity</option>';
        layer_html += '          <option value="option7" data-id="show-vaccine-confidence-q1" data-name="vc1" data-credit="LSHTM">Vaccines & Children</option>';
        layer_html += '          <option value="option8" data-id="show-vaccine-confidence-q2" data-name="vc2" data-credit="LSHTM">Vaccine Safety</option>';
        layer_html += '          <option value="option9" data-id="show-vaccine-confidence-q3" data-name="vc3" data-credit="LSHTM">Vaccine Effectiveness</option>';
        layer_html += '          <option value="option10" data-id="show-vaccine-confidence-q4" data-name="vc4" data-credit="LSHTM">Vaccines & Religion</option>';
        layer_html += '        </select>';
        layer_html += '        <button class="clear-theme" type="button">Clear <br>Theme</button>';
        layer_html += '      </td>';
        layer_html += '      <td style="position: absolute; margin-top: -7px">';
        layer_html += '        <label for="show-himawari" name="h8_16">';
        layer_html += '          <input type="checkbox" id="show-himawari" style=" top: 2px" />Himawari-8';
        layer_html += '          <span class="credit"> (JMA)</span>';
        layer_html += '        </label>';
        layer_html += '      </td>';
        layer_html += '    </tr>';

        layer_html += '    <tr>';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 10px; text-align: right">';
        layer_html += '        Climate:';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 70px;">';
        layer_html += '        <select id="resilience-theme" multiple="multiple" size="6">';
        layer_html += '          <option value="option1" data-id="show-sea-level-rise-1p0" data-name="slr1" data-credit="Climate Central">Sea Level Rise 2m (1.0 &deg;C)</option>';
        layer_html += '          <option value="option2" data-id="show-sea-level-rise-1p5" data-name="slr15" data-credit="Climate Central">Sea Level Rise 1.5 &deg;C</option>';
        layer_html += '          <option value="option3" data-id="show-sea-level-rise-2p0" data-name="slr2" data-credit="Climate Central">Sea Level Rise 2.0 &deg;C</option>';
        layer_html += '          <option value="option4" data-id="show-sea-level-rise-4p0" data-name="slr4" data-credit="Climate Central">Sea Level Rise 4.0 &deg;C</option>';
        layer_html += '          <option value="option5" data-id="show-ndvi-anomaly" data-name="ndvia" data-credit="USGS">Vegetation Index Reduction</option>';
        layer_html += '          <option value="option6" data-id="show-vsi" data-name="vsi" data-credit="Oxford Martin">Vegetation Sensitivity Index</option>';
        layer_html += '        </select>';
        layer_html += '        <button class="clear-theme" type="button">Clear <br>Theme</button>';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 10px; text-align: right">';
        layer_html += '        Nutrition:';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 70px;">';
        layer_html += '        <select id="nutrition-theme" multiple="multiple" size="4">';
        layer_html += '          <option value="option1" data-id="show-health-impact-rcp2p6" data-name="hi-rcp2p6" data-credit="Oxford Martin">Nutritional Deficiency RCP2.6</option>';
        layer_html += '          <option value="option2" data-id="show-health-impact-rcp4p5" data-name="hi-rcp4p5" data-credit="Oxford Martin">Nutritional Deficiency RCP4.5</option>';
        layer_html += '          <option value="option3" data-id="show-health-impact-rcp6p0" data-name="hi-rcp6p0" data-credit="Oxford Martin">Nutritional Deficiency RCP6.0</option>';
        layer_html += '          <option value="option4" data-id="show-health-impact-rcp8p5" data-name="hi-rcp8p5" data-credit="Oxford Martin">Nutritional Deficiency RCP8.5</option>';
        layer_html += '        </select>';
        layer_html += '        <button class="clear-theme" type="button">Clear <br>Theme</button>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 10px; text-align: right">';
        layer_html += '        Water:';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 70px;">';
        layer_html += '        <select id="water-theme" multiple="multiple" size="2">';
        layer_html += '          <option value="option1" data-id="show-water-occurrence" data-name="wo" data-credit="JRC">Water Occurrence</option>';
        layer_html += '          <option value="option2" data-id="show-water-change" data-name="wc" data-credit="JRC">Water Change</option>';
        layer_html += '        </select>';
        layer_html += '        <button class="clear-theme" type="button">Clear <br>Theme</button>';
        layer_html += '      </td>';
        layer_html += '      <td style="position: absolute; margin-top: -7px">';
        layer_html += '        <label for="show-gtd" name="gtd">';
        layer_html += '          <input type="checkbox" id="show-gtd" style=" top: 2px" />Global Terrorism <br> Database';
        layer_html += '          <span class="credit"> (UMD)</span>';
        layer_html += '        </label>';
        layer_html += '      </td>';
        layer_html += '    </tr>';

        layer_html += '    <tr>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 10px; text-align: right">';
        layer_html += '        Coral:';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 70px;">';
        layer_html += '        <select id="coral-theme" multiple="multiple" size="2">';
        layer_html += '          <option value="option1" data-id="show-coral" data-name="cb" data-credit="NOAA, UNEP-WCMC">Coral Bleaching</option>';
        layer_html += '          <option value="option2" data-id="show-coral-bleaching-alerts" data-name="crw" data-credit="NOAA, UNEP-WCMC">Coral Reef Watch</option>';
        layer_html += '        </select>';
        layer_html += '        <button class="clear-theme" type="button">Clear <br>Theme</button>';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 10px; text-align: right">';
        layer_html += '        Refugees:';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 70px;">';
        layer_html += '        <select id="refugee-theme" multiple="multiple" size="2">';
        layer_html += '          <option value="option1" data-id="show-monthly-refugees" data-name="mmr" data-credit="UNHCR">Monthly Mediterranean Refugees</option>';
        layer_html += '          <option value="option2" data-id="show-annual-refugees" data-name="ar" data-credit="UNHCR">Annual Refugees</option>';
        layer_html += '          <option value="option3" data-id="show-annual-returns" data-name="arr" data-credit="UNHCR">Annual Returns</option>';
        layer_html += '        </select>';
        layer_html += '        <button class="clear-theme" type="button">Clear <br>Theme</button>';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 10px; text-align: right">';
        layer_html += '        Urbanization:';
        layer_html += '      </td>';
        layer_html += '      <td style="padding-bottom:16px; padding-right: 70px;">';
        layer_html += '        <select id="urbanization-theme" multiple="multiple" size="2">';
        layer_html += '          <option value="option1" data-id="show-lights-at-night" data-name="lan" data-credit="NOAA, Google">Lights at Night</option>';
        layer_html += '          <option value="option2" data-id="show-urban-fragility" data-name="uf" data-credit="Igarape Institute">Urban Fragility</option>';
        layer_html += '        </select>';
        layer_html += '        <button class="clear-theme" type="button">Clear <br>Theme</button>';
        layer_html += '      </td>';
        layer_html += '      <td style="position: absolute; margin-top: -7px">';
        layer_html += '        <label for="show-lodes" name="lodes">';
        layer_html += '          <input type="checkbox" id="show-lodes" style=" top: 2px" />LODES';
        layer_html += '          <span class="credit"> (US Census)</span>';
        layer_html += '        </label>';
        layer_html += '      </td>';
        layer_html += '    </tr>';

        // ## 5 ##
        //// Add layers to letterbox UI panel ////
        //
        layer_html += '  </table>';
        layer_html += '</div>';
      } else {
        layer_html += '<button class="toggleLayerPanelBtn" title="Toggle layer panel">Toggle</button>';
        layer_html += '<div class="layers-scroll-vertical">';
        layer_html += '<div class="map-layer-div map-layer-checkbox">';

        /* BASE LAYERS */
        layer_html += '  <h3>Base Layers</h3>';
        layer_html += '  <table>';
        layer_html += '    <tr>';
        layer_html += landsat_base;
        layer_html += '    </tr>';
        layer_html += '    <tr>'
        layer_html += light_base;
        layer_html += dark_base;
        layer_html += '    </tr>';
        layer_html += '  </table>';
        /* END BASE LAYERS */

        /* FOREST THEME */
        layer_html += '  <h3>Forests</h3>';
        layer_html += '  <table>';
        layer_html += '    <tr>';
        layer_html += show_wdpa;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_forest_change;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_forest_loss_gain;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_animated_forest_loss_gain;
        layer_html += '    </tr>';
        if (showForestAlerts) {
          layer_html += '    <tr>';
          layer_html += show_forest_alerts;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_forest_alert_no_overlay;
          layer_html += '    </tr>';
        }
        layer_html += '  </table>';
        /* END FOREST THEME */

        /* WATER THEME */
        layer_html += '  <h3>Water</h3>';
        layer_html += '  <table>';
        if (showWaterOccurrence) {
          layer_html += '   <tr>';
          layer_html += show_water_occurrence;
          layer_html += '   </tr>';
        }
        if (showWaterChange) {
          layer_html += '   <tr>';
          layer_html += show_water_change;
          layer_html += '   </tr>';
        }
        layer_html += '  </table>';
        /* END WATER THEME */

        /* CLIMATE THEME */
        layer_html += '  <h3>Climate</h3>';
        layer_html += '  <table>';
        if (showSeaLevelRise) {
          layer_html += '    <tr>';
          layer_html += show_sea_level_rise_1p0;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_sea_level_rise_1p5;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_sea_level_rise_2p0;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_sea_level_rise_4p0;
          layer_html += '    </tr>';
        }
        if (showNdviAnomaly) {
          layer_html += '    <tr>';
          layer_html += show_ndvi_anomaly;
          layer_html += '    </tr>';
        }
        if (showVsi) {
          layer_html += '   <tr>';
          layer_html += show_vsi;
          layer_html += '   </tr>';
        }
        if (showBerkeleyEarthTemperatureAnomaly) {
          layer_html += '    <tr>';
          layer_html += show_berkeley_earth_temperature_anomaly;
          layer_html += '    </tr>';
        }
        layer_html += '  </table>';
        /* END CLIMATE THEME */

        /* AIR QUALITY THEME */
        layer_html += '  <h3>Air Quality</h3>';
        layer_html += '  <table>';
        if (showOmiNo2) {
          layer_html += '   <tr>';
          layer_html += show_omi_no2;
          layer_html += '   </tr>';
        }
        if (showBePm25) {
          layer_html += '   <tr>';
          layer_html += show_be_pm25;
          layer_html += '   </tr>';
        }
        layer_html += '  </table>';
        /* END AIR QUALITY THEME */


        /* CORAL THEME */
        layer_html += '  <h3>Coral</h3>';
        layer_html += '  <table>';
        layer_html += '    <tr>';
        layer_html += show_coral;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_coral_bleaching_alerts;
        layer_html += '    </tr>';
        layer_html += '  </table>';
        /* END CORAL THEME */

        /* ENERGY THEME */
        layer_html += '  <h3>Energy</h3>';
        layer_html += '  <table>';
        layer_html += '    <tr>';
        layer_html += show_solar_installs;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_usgs_windturbine;
        layer_html += '    </tr>';
        if (showGlobalWindPower) {
          layer_html += '    <tr>';
          layer_html += show_global_wind_power;
          layer_html += '    </tr>';
        }
        layer_html += '    <tr>';
        layer_html += show_drilling;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_viirs;
        layer_html += '    </tr>';
        layer_html += '  </table>';
        /* END ENERGY THEME */

        /* NUTRITION THEME */
        layer_html += '  <h3>Nutrition</h3>';
        layer_html += '  <table>';
        if (showHealthImpact) {
          layer_html += '    <tr>';
          layer_html += show_health_impact_rcp2p6;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_health_impact_rcp4p5;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_health_impact_rcp6p0;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_health_impact_rcp8p5;
          layer_html += '    </tr>';
        }
        layer_html += '  </table>';
        /* END NUTRITION THEME */

        /* REFUGEE THEME */
        layer_html += '  <h3>Forced Displacement</h3>';
        layer_html += '  <table>';
        if (showMonthlyRefugees) {
          layer_html += '    <tr>';
          layer_html += show_monthly_refugees;
          layer_html += '    </tr>';
        }
        if (showAnnualRefugees) {
          layer_html += '    <tr>';
          layer_html += show_annual_refugees;
          layer_html += '    </tr>';
        }
        if (showAnnualReturns) {
          layer_html += '    <tr>';
          layer_html += show_annual_returns;
          layer_html += '    </tr>';
        }
        if (showIomIdp) {
          layer_html += '   <tr>';
          layer_html += show_iraq_iom_idp;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_syria_iom_idp;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_libya_iom_idp;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_yemen_iom_idp;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_iraq_iom_return;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_syria_iom_return;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_libya_iom_return;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_yemen_iom_return;
          layer_html += '   </tr>';
        }
        layer_html += '  </table>';
        /* END REFUGEE THEME */

        /* PANDEMICS THEME */
        layer_html += '  <h3>Pandemics</h3>';
        layer_html += '  <table>';
        if (showZika) {
          layer_html += '    <tr>';
          layer_html += show_zika;
          layer_html += '    </tr>';
        }
        if (showDengue) {
          layer_html += '    <tr>';
          layer_html += show_dengue;
          layer_html += '    </tr>';
        }
        if (showChiku) {
          layer_html += '    <tr>';
          layer_html += show_chiku;
          layer_html += '    </tr>';
        }
        if (showEbola) {
          layer_html += '    <tr>';
          layer_html += show_ebola_deaths;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_ebola_cases;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_ebola_new_cases;
          layer_html += '    </tr>';
        }
        if (showHiv) {
          layer_html += '    <tr>';
          layer_html += show_hiv;
          layer_html += '    </tr>';
        }
        if (showObesity) {
          layer_html += '    <tr>';
          layer_html += show_obesity;
          layer_html += '    </tr>';
        }
        if (showVaccineConfidence) {
          layer_html += '    <tr>';
          layer_html += show_vaccine_confidence_q1;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_vaccine_confidence_q2;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_vaccine_confidence_q3;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_vaccine_confidence_q4;
          layer_html += '    </tr>';
        }
        layer_html += '  </table>';
        /* END PANDEMICS THEME */

        /* URBANIZATION THEME */
        layer_html += '  <h3>Urbanization</h3>';
        layer_html += '  <table>';
        layer_html += '    <tr>';
        layer_html += show_lights_at_night;
        layer_html += '    </tr>';
        if (showLightsAtNight2012) {
          layer_html += '    <tr>';
          layer_html += show_lights_at_night_2012;
          layer_html += '    </tr>';
        }
        if (showLightsAtNight2016) {
          layer_html += '    <tr>';
          layer_html += show_lights_at_night_2016;
          layer_html += '    </tr>';
        }
        if (showUrbanFragility) {
          layer_html += '    <tr>';
          layer_html += show_urban_fragility;
          layer_html += '    </tr>';
        }
        layer_html += '  </table>';
        /* END URBANIZATION THEME */

        /* CHINA INFRASTRUCTURE THEME */
        if (showChinaInfrastructure) {
          layer_html += '  <h3>China Infrastructure</h3>';
          layer_html += '  <table id ="ci" style="visibility: hidden">';
          layer_html += '    <tr>';
          layer_html += show_china_aviation;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_china_power_plants;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_china_reservoirs;
          layer_html += '    </tr>';
          layer_html += '    <tr>';
          layer_html += show_china_waste_treatment_plants;
          layer_html += '    </tr>';
          layer_html += '  </table>';

        }
        /* END CHINA INFRASTRUCTURE THEME */


        /* DOTMAPS */
        layer_html += '  <h3>Dotmaps</h3>';
        layer_html += '  <table id="dotmaps_table">';
        if (showLodes) {
          layer_html += '    <tr>';
          layer_html += show_lodes;
          layer_html += '    </tr>';
        }

        layer_html += '  </table>';

        /* END DOTMAPS */

        /* MISC THEME */
        layer_html += '  <h3>Other</h3>';
        layer_html += '  <table id="other_table">';
        if (showGtd) {
          layer_html += '    <tr>';
          layer_html += show_gtd;
          layer_html += '    </tr>';
        }
        if (showUppsalaConflict) {
          layer_html += '    <tr>';
          layer_html += show_uppsala_conflict;
          layer_html += '    </tr>';
        }
        if (showCumulativeActiveMining) {
          layer_html += '    <tr>';
          layer_html += show_cumulative_active_mining_layer;
          layer_html += '    </tr>';
        }
        layer_html += '    <tr>';
        layer_html += show_himawari;
        layer_html += '    </tr>';
        layer_html += '  </table>';
        /* END MISC THEME */

        layer_html += '</div>';


        // ## 5 ##
        //// Add layers to side UI panel ////
        //
      }

      layer_html += '<div class="extras-selector-div">';
      layer_html += ' <select name="extras-selector" id="extras-selector">';
      layer_html += '   <option id="default-extras-select" selected="selected" value="select">Select extra content...</option>';
      layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="pumphandle_2014.mp4">Measured CO2 Over Time</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="Carbon Dioxide 2006 GEOS-5 model.mp4">CO2 2006 GEOS-5 Model</option>';
      layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Land + Ocean Average Temperature Annual Anomaly.mp4">Temperature Anomaly 1850-2013</option>';
      layer_html += '   <option data-file-playback-rate="0.5" data-type="video" data-file-name="berkeley-earth.mp4">Temperature Anomaly 1850-2015</option>';
      layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic ice age, 1987-2014.mp4">Ice Thinning 1987-2014</option>';
      layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Larsen-B-Collapse.mp4">Larsen-B Collapse</option>';
      layer_html += '   <option data-file-playback-rate="4" data-type="video" data-file-name="Orbiting Carbon Observatory.mp4">Orbiting Carbon Observatory</option>';
      layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic Sea Ice, September 1979 to September 2014.mp4">Sea Ice Concentration 1979-2014</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="coral-reef-watch-daily-7day-max.mp4">Coral Reef Watch 2013-2015</option>';
      layer_html += '   <option data-file-playback-rate="0.5" data-type="video" data-file-name="merra-spi.mp4">Standardized Precipitation Index 1980-2015</option>';
      layer_html += '   <option data-type="iframe" data-link-path="http://choices.climatecentral.org/widget.html?utm_source=Davos&utm_medium=embed&utm_campaign=SSMC-Map#11/31.2301/121.4736?compare=temperatures&carbon-end-yr=2100&scenario-a=warming-4&scenario-b=warming-2&presentation=1">Shanghai Sea Level</option>';
      layer_html += '   <option data-type="img" data-link-path="land-and-ocean-temps.png">2015: Hottest Year on Record</option>';
      /*layer_html += '   <option data-type="img" data-link-path="co2_emissions_over_time.png">CO2 Emissions Over Time</option>';
      layer_html += '   <option data-type="img" data-link-path="global_decarbonisation_staircase.png">Global Decarbonisation Staircase</option>';*/
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="refugee_camps.mp4">Refugee Camps Outside Mosul</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="iraq_smoke.mp4">Qayyarah Oil Field South of Mosul</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="sugarcane_plantations.mp4">Sugarcane Plantation in Bolivia</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="cepi.mp4">Coalition for Epidemic Prepardness Innovations</option>';
      layer_html += '   <option data-file-playback-rate="1.5" data-type="video" data-file-name="temp-anomaly.mp4">Temperature Anomaly 1970-2016</option>';
      layer_html += '   <option data-type="img" data-link-path="water-synergies-p1.png">Water Synergies Pt1</option>';
      layer_html += '   <option data-type="img" data-link-path="water-synergies-p2.png">Water Synergies Pt2</option>';
      layer_html += '   <option data-type="img" data-link-path="altered-river-flow.png">Altered River Flow</option>';
      layer_html += '   <option data-type="img" data-link-path="solar-with-legend.png">Global Atlas for Renewable Energy</option>';
      if (showEVA)
        layer_html += '   <option data-type="link" data-link-path="http://localhost:8080/?uid=history-1436384863961-Vyxt6PIO">EVA - Explorable Visual Analytics</option>';
      layer_html += '   <optgroup label="World Economic Forum - Davos 2016">';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Climate Crisis with Naomi Oreskes and Achim Steiner.mp4">Climate Crisis with Naomi Oreskes and Achim Steiner</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Climate Crisis with Naomi Oreskes and Nicholas Stern.mp4">Climate Crisis with Naomi Oreskes and Nicholas Stern</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Future of Forests with Matthew Hansen and Andrew Steer.mp4">Future of Forests with Matthew Hansen and Andrew Steer</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Industrialization Impasse with Ricardo Hausmann and Illah Nourbakhsh.mp4">Industrialization Impasse with Ricardo Hausmann and Illah Nourbakhsh</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Race for Resources with Ellen MacArthur and Randy Sargent.mp4">Race for Resources with Ellen MacArthur and Randy Sargent</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Race for Resources with William McDonough and Randy Sargent.mp4">Race for Resources with William McDonough and Randy Sargent</option>';
      layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The War on Water with Johan Rockstrom and Randy Sargent.mp4">War on Water with Johan Rockstrom and Randy Sargent</option>';
      layer_html += '   </optgroup>';
      layer_html += ' </select>';
      layer_html += '</div>';
      layer_html += '</div>';
      layer_html += '</div>';

      var legend_html = '<div id="layers-legend">';
      legend_html += '<div id="legend-content">';
      legend_html += '<table cellpadding=5>';
      legend_html += '<tr id="wdpa-legend" style="display: none"><td><div style="background-color:#33da4f; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -11px; font-size: 17px">Protected Areas<span class="credit"> (UNEP-WCMC)</span></div></td></tr>';
      legend_html += '<tr id="forest-loss-year-legend" style="display: none"><td><div style="font-size: 17px">Forest Loss By Year <span class="credit"> (Hansen et al)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">2000</div><div style="margin-top: 3px; float: left; background-image: -webkit-linear-gradient(left, yellow, orange 65%, red 100%);background-image: linear-gradient(left, yellow, orange 65%, red 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">2014</div></div></td></tr>';
      legend_html += '<tr id="forest-loss-gain-legend" style="display: none; font-size: 14px;"><td><div style="font-size: 17px">Forest Loss/Gain 2000-2014 <span class="credit"> (Hansen et al)</span></div><div style="float: left; padding-right:8px"><div style="background-color:#00e000; width: 12px; height: 12px; float: left; margin-top: 2px; margin-left: 8px;"></div>&nbsp;Extent</div><div style="float: left; padding-right:8px"><div style="background-color:#ff0000; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Loss</div><div style="float: left; padding-right:8px"><div style="background-color:#0000ff; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Gain</div><div><div style="background-color:#ff00ff; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Both</div></td></tr>';
      legend_html += '<tr id="fires-at-night-legend" style="display: none"><td><div style="background-color:#eda46a; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Fires At Night <span class="credit"> (NOAA)</span></div></td></tr>';
      legend_html += '<tr id="lights-at-night-legend" style="display: none"><td><div style="font-size: 17px">Lights at Night over 25 Years <span class="credit"> (NOAA, Google)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">Decrease</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, #4848FD, green 50%, red 100%);background-image: linear-gradient(left, #4848FD, green 50%, red 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">Increase</div></td></tr>';
      legend_html += '<tr id="lights-at-night-2012-legend" style="display: none"><td><div style="font-size: 17px">Lights at Night 2012 <span class="credit"> (NASA)</span></div></td></tr>';
      legend_html += '<tr id="lights-at-night-2016-legend" style="display: none"><td><div style="font-size: 17px">Lights at Night 2016 <span class="credit"> (NASA)</span></div></td></tr>';
      legend_html += '<tr id="coral-bleaching-legend" style="display: none"><td><div style="float:left; background-color:#fa13ab; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -5px; font-size: 17px">Coral Reefs <span class="credit"> (NOAA, UNEP-WCMC)</span></div></td></tr>';
      legend_html += '<tr id="coral-bleaching-alerts-legend" style="display: none"><td><div style="font-size: 17px">Coral Reef Watch <span class="credit"> (NOAA, UNEP-WCMC)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">Watch</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, #ffff00, #fbb404 65%, #a00200 100%);background-image: linear-gradient(left, #ffff00, #fbb404 65%, #a00200 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">Alert</div></td></tr>';
      legend_html += '<tr id="wind-installs-legend" style="display: none"><td><div style="background-color:#a0fe8f; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">US Wind Power <span class="credit"> (USGS)</span></div></div></td></tr>';
      legend_html += '<tr id="global-wind-power-legend" style="display: none"><td><div style="background-color:#a0fe8f; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">Global Wind Power <span class="credit"> (TheWindPower.net)</span></div></div></td></tr>';
      legend_html += '<tr id="solar-installs-legend" style="display: none"><td><div style="background-color:#7376b2; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">US Solar Photovoltaic <span class="credit"> (NREL)</span></div></td></tr>';
      legend_html += '<tr id="drilling-legend" style="display: none"><td><div style="background-color:#eda46a; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">US Oil/Gass Drilling <span class="credit"> (FracTracker, CREATE Lab)</span></div></td></tr>';
      legend_html += '<tr id="water-occurrence-legend" style="display: none"><td><div style="font-size: 17px">Water Occurrence 1984-2015 <span class="credit"> (JRC)</span></div><div style="margin-left: 8px"><div style="font-size: 13px; float: left">100%</div><div style="font-size: 13px; float: right;">0%</div><div class="waterLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">Always water</div><div style="font-size: 13px; float: right">Never water</div></div></td></tr>';
      legend_html += '<tr id="water-change-legend" style="display: none"><td><div style="font-size: 17px">Water Change 1984-1999 to 2000-2015 <span class="credit"> (JRC)</span></div><div style="margin-left: 8px"><div class="waterChangeLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">Water Loss</div><div style="font-size: 13px; float: right">Water Gain</div></div></td></tr>';
      legend_html += '<tr id="monthly-refugees-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, #ff0000 0%, #ffffff 100%);background: -webkit-linear-gradient(left, #ff0000 0%,#ffffff 100%); background: linear-gradient(to right, #ff0000 0%,#ffffff 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Refugees Crossing the Mediterranean: Jan 2014 - Jun 2016 <span class="credit"> (UNHCR)</span></div></td></tr>';
      if (subsampleAnnualRefugees)
        legend_html += '<tr id="annual-refugees-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, #da7300 25%, red 100%);background: -webkit-linear-gradient(left, #da7300 25%,red 100%); background: linear-gradient(to right, #da7300 25%,red 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Global Refugee Flow: 2000 - 2015 <span class="credit"> (UNHCR) <br> 1 dot = ~17 refugees</span></div></td></tr>';
      else
        legend_html += '<tr id="annual-refugees-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, #da7300 25%, red 100%);background: -webkit-linear-gradient(left, #da7300 25%,red 100%); background: linear-gradient(to right, #da7300 25%,red 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Global Refugee Flow: 2000 - 2015 <span class="credit"> (UNHCR) <br> 1 dot = 1 refugee </span></div></td></tr>';
      if (subsampleAnnualReturns)
        legend_html += '<tr id="annual-returns-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, lightyellow 25%, navy 100%);background: -webkit-linear-gradient(left, lightyellow 25%,navy 100%); background: linear-gradient(to right, lightyellow 25%,navy 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Global Refugee Return Flow: 2000 - 2015 <span class="credit"> (UNHCR) <br> 1 dot = ~17 refugees </span></div></td></tr>';
      else
        legend_html += '<tr id="annual-returns-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, lightyellow 25%, navy 100%);background: -webkit-linear-gradient(left, lightyellow 25%,navy 100%); background: linear-gradient(to right, lightyellow 25%,navy 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Global Refugee Return Flow: 2000 - 2015 <span class="credit"> (UNHCR) <br> 1 dot = 1 refugee </span></div></td></tr>';
      legend_html += '<tr id="vsi-legend" style="display: none"><td><div style="font-size: 17px">Vegetation Sensitivity Index 2000-2013 <span class="credit"> (USGS)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">0</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, rgb(0, 139, 0), rgb(92, 182, 69) 17%, rgb(163, 221, 99) 33%, rgb(255, 255, 0) 50%, rgb(255, 205, 0) 67%, rgb(255, 144, 0) 83%, rgb(255, 4, 0) 100%);background-image: linear-gradient(left, rgb(0, 139, 0), rgb(92, 182, 69) 17%, rgb(163, 221, 99) 33%, rgb(255, 255, 0) 50%, rgb(255, 205, 0) 67%, rgb(255, 144, 0) 83%, rgb(255, 4, 0) 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">100</div></td></tr>';
      legend_html += '<tr id="health-impact-legend" style="display: none"><td><div style="font-size: 17px">Nutritional Deficiencies<span class="credit"> (Oxford Martin)</span></div><svg class="svg-legend" width="242" height="180"><rect width="240" height="160" fill="white" opacity="0"></rect> <g transform="translate(2,10)"> <circle class="gain" r="5" cx="5" cy="10" style="fill: #8b0000; stroke: #fff;"></circle> <circle class="loss" r="5" cx="5" cy="30" style="fill: #00008b; stroke: #fff;"></circle> <text x="15" y="13">Mean deaths per capita</text> <text x="15" y="33">Mean lives per capita</text> <circle r="10.0" cx="160.0" cy="160.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="152.0" dy="13" style="font-size: 10px; fill: #666">5K</text><circle r="30.0" cx="160.0" cy="140.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="130.0" dy="13" style="font-size: 10px; fill: #666">15K</text><circle r="60.0" cx="160.0" cy="110.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="80.0" dy="13" style="font-size: 10px; fill: #666">30K</text></g> </svg></td></tr>';
      legend_html += '<tr id="sea-level-rise-legend" style="display: none"><td><div style="font-size: 17px">Global Temperature Rise <span id="slr-degree"></span> &#x2103;<span class="credit"> (Climate Central)</span></div><div style="font-size: 15px">Future Sea Level<span id="slr-feet" style="width:25px;"></span>&nbsp;<span id="slr-meters" style="width:25px; color: red;"></span></div></td></tr>';
      legend_html += '<tr id="urban-fragility-legend" style="display: none"><td><div style="font-size: 17px">Fragile Score <span class="credit"> (Igarape Institute)</span></div></div><svg class="svg-legend" width="200" height="30"> <rect fill="rgb(255,255,204)" x="0"   height="9" width="20"></rect><rect fill="rgb(255,237,160)" x="20"  height="9" width="20"></rect><rect fill="rgb(254,217,118)" x="40"  height="9" width="20"></rect><rect fill="rgb(254,178,76)"  x="60"  height="9" width="20"></rect><rect fill="rgb(253,141,60)"  x="80"  height="9" width="20"></rect><rect fill="rgb(252,78,42)"   x="100" height="9" width="20"></rect><rect fill="rgb(227,26,28)"   x="120" height="9" width="20"></rect><rect fill="rgb(189,0,38)"    x="140" height="9" width="20"></rect><rect fill="rgb(128,0,38)"    x="160" height="9" width="20"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">1.0</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="85">2.1</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="165">3.1</text></svg></td></tr>';
      legend_html += '<tr id="zika-legend" style="display: none"><td><div style="background-color:#ff8d74; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Zika Virus <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="chiku-legend" style="display: none"><td><div style="background-color:#6070ff; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Chikungunya Virus <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="dengue-legend" style="display: none"><td><div style="background-color:#a1ef5f; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Dengue Virus <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="gtd-legend" style="display: none"><td><div style="float:left; background-color:red; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -5px; font-size: 17px">Global Terrorism Database Events <span class="credit"> (UMD)</span></div></td></tr>';
      legend_html += '<tr id="uppsala-conflict-legend" style="display: none"><td><div style="float:left; background-color:red; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -5px; font-size: 17px">UCDP Event Database<span class="credit"> (UCDP)</span></div></td></tr>';
      legend_html += '<tr id="hiv-legend" style="display: none"><td><div style="font-size: 17px">Annual new HIV infections <span class="credit"> (LSHTM)</span></div></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffff" x="0" height="9" width="20.0"></rect><rect fill="#ffd8e7" x="20." height="9" width="20.0"></rect><rect fill="#feb1d1" x="40." height="9" width="20.0"></rect><rect fill="#f18bbd" x="60." height="9" width="20.0"></rect><rect fill="#dd68ac" x="80." height="9" width="20.0"></rect><rect fill="#c4479e" x="100." height="9" width="20.0"></rect><rect fill="#a52792" x="120." height="9" width="20.0"></rect><rect fill="#7d0989" x="140." height="9" width="20.0"></rect><rect fill="#4b0082" x="160." height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">1K</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="35">10K</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="80">100K</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="155">850K</text></svg></td></tr>';
      legend_html += '<tr id="obesity-legend" style="display: none"><td><div style="font-size: 17px">Obesity prevalence among adults <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"> <rect fill="#ffffff" x="0" height="9" width="20"></rect><rect fill="#fff18e" x="20" height="9" width="20"></rect><rect fill="#ffdc5b" x="40" height="9" width="20"></rect><rect fill="#ffc539" x="60" height="9" width="20"></rect><rect fill="#ffad21" x="80" height="9" width="20"></rect><rect fill="#ff920c" x="100" height="9" width="20"></rect><rect fill="#ff7500" x="120" height="9" width="20"></rect><rect fill="#ff5000" x="140" height="9" width="20"></rect><rect fill="#ff0000" x="160" height="9" width="20"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="80">15%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="160">>30%</text></svg></td></tr>';
      legend_html += '<tr id="vaccine-confidence-q1-legend" style="display: none"><td><div style="font-size: 13px">Disagree that vaccines are important for children to have <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffe0" x="0" height="9" width="20.0"></rect><rect fill="#ffe3af" x="20" height="9" width="20.0"></rect><rect fill="#ffc58a" x="40" height="9" width="20.0"></rect><rect fill="#ffa474" x="60" height="9" width="20.0"></rect><rect fill="#fa8266" x="80" height="9" width="20.0"></rect><rect fill="#ed645c" x="100" height="9" width="20.0"></rect><rect fill="#db4551" x="120" height="9" width="20.0"></rect><rect fill="#c52940" x="140" height="9" width="20.0"></rect><rect fill="#aa0e27" x="160" height="9" width="20.0"></rect><rect fill="#8b0000" x="180" height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="90">8%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="180">16%</text></svg></td></tr>';
      legend_html += '<tr id="vaccine-confidence-q2-legend" style="display: none"><td><div style="font-size: 13px">Disagree that vaccines are safe <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffe0" x="0" height="9" width="20.0"></rect><rect fill="#ffe3af" x="20" height="9" width="20.0"></rect><rect fill="#ffc58a" x="40" height="9" width="20.0"></rect><rect fill="#ffa474" x="60" height="9" width="20.0"></rect><rect fill="#fa8266" x="80" height="9" width="20.0"></rect><rect fill="#ed645c" x="100" height="9" width="20.0"></rect><rect fill="#db4551" x="120" height="9" width="20.0"></rect><rect fill="#c52940" x="140" height="9" width="20.0"></rect><rect fill="#aa0e27" x="160" height="9" width="20.0"></rect><rect fill="#8b0000" x="180" height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="90">20%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="180">41%</text></svg></td></tr>';
      legend_html += '<tr id="vaccine-confidence-q3-legend" style="display: none"><td><div style="font-size: 13px">Disagree that vaccines are effective <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffe0" x="0" height="9" width="20.0"></rect><rect fill="#ffe3af" x="20" height="9" width="20.0"></rect><rect fill="#ffc58a" x="40" height="9" width="20.0"></rect><rect fill="#ffa474" x="60" height="9" width="20.0"></rect><rect fill="#fa8266" x="80" height="9" width="20.0"></rect><rect fill="#ed645c" x="100" height="9" width="20.0"></rect><rect fill="#db4551" x="120" height="9" width="20.0"></rect><rect fill="#c52940" x="140" height="9" width="20.0"></rect><rect fill="#aa0e27" x="160" height="9" width="20.0"></rect><rect fill="#8b0000" x="180" height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="90">13%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="180">26%</text></svg></td></tr>';
      legend_html += '<tr id="vaccine-confidence-q4-legend" style="display: none"><td><div style="font-size: 13px">Disagree that vaccines are compatible with my religious beliefs <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffe0" x="0" height="9" width="20.0"></rect><rect fill="#ffe3af" x="20" height="9" width="20.0"></rect><rect fill="#ffc58a" x="40" height="9" width="20.0"></rect><rect fill="#ffa474" x="60" height="9" width="20.0"></rect><rect fill="#fa8266" x="80" height="9" width="20.0"></rect><rect fill="#ed645c" x="100" height="9" width="20.0"></rect><rect fill="#db4551" x="120" height="9" width="20.0"></rect><rect fill="#c52940" x="140" height="9" width="20.0"></rect><rect fill="#aa0e27" x="160" height="9" width="20.0"></rect><rect fill="#8b0000" x="180" height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="90">23%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="180">47%</text></svg></td></tr>';
      legend_html += '<tr id="ndvi-anomaly-legend" style="display: none"><td><div style="font-size: 17px">Vegetation Reduction <span class="credit"> (USGS)</span></div><div style="margin-left: 8px"><div class="ndviAnomalyLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">None</div><div style="font-size: 13px; float: right">Most Reduced</div></div></td></tr>';
      legend_html += '<tr id="ebola-deaths-legend" style="display: none"><td><div style="background-color:#ff8d74; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Ebola Deaths <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="ebola-cases-legend" style="display: none"><td><div style="background-color:#ff8d74; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Ebola Cases <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="ebola-new-cases-legend" style="display: none"><td><div style="background-color:#ff8d74; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Ebola New Cases <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="lodes-legend" style="display: none"><td><div>LODES<span class="credit"> (US Census)</span></div></td></tr>';
      legend_html += '<tr id="cumulative-active-mining-legend" style="display: none"><td><div>Active Mining<span class="credit"> (SkyTruth)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">1984</div><div style="margin-top: 3px; float: left; background-image: -webkit-linear-gradient( to right, rgb(255,255,255),rgb(128,0,0));background-image: linear-gradient(to right, rgb(255,255,255),rgb(128,0,0)); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">2016</div></td></tr>';
      legend_html += '<tr id="iraq-iom-idp-legend" style="display: none"><td><div>IRAQ IDPS<span class="credit"> (IOM)</span></div></td></tr>';
      legend_html += '<tr id="syria-iom-idp-legend" style="display: none"><td><div>Syria IDPS<span class="credit"> (IOM)</span></div></td></tr>';
      legend_html += '<tr id="yemen-iom-idp-legend" style="display: none"><td><div>Yemen IDPS<span class="credit"> (IOM)</span></div></td></tr>';
      legend_html += '<tr id="libya-iom-idp-legend" style="display: none"><td><div>Libya IDPS<span class="credit"> (IOM)</span></div></td></tr>';
      legend_html += '<tr id="iom-idp-legend" style="display: none"><td><div style="font-size: 17px">Internally Displaced Persons (IDPs) <br/>and Returnees<span class="credit"> (IOM)</span></div><svg class="svg-legend" width="242" height="130"><rect width="240" height="110" fill="white" opacity="0"></rect> <g transform="translate(2,10)"> <circle class="gain" r="5" cx="5" cy="10" style="fill: #8b0000; stroke: #fff;"></circle> <circle class="loss" r="5" cx="5" cy="30" style="fill: #00008b; stroke: #fff;"></circle> <text x="15" y="13">Individuals displaced</text> <text x="15" y="33">Indivdual returnees</text> <circle r="10.0" cx="160.0" cy="110.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="102.0" dy="13" style="font-size: 10px; fill: #666">18K</text><circle r="30.0" cx="160.0" cy="90.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="80.0" dy="13" style="font-size: 10px; fill: #666">900K</text><!--<circle r="60.0" cx="160.0" cy="110.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="80.0" dy="13" style="font-size: 10px; fill: #666">900K</text>--></g> </svg></td></tr>';
      legend_html += '<tr id="berkeley-earth-temperature-anomaly-legend" style="display: none"><td><div style="font-size: 13px">Average Temperature Annual Anomaly 1850-2017<span class="credit"> (Berkeley Earth)</span></div><svg class="svg-legend" width="220" height="40"><text font-size="12px" fill="rgba(0, 0, 0, 1.0)" y="10" x="40">Temperature Anomaly (&#8451)</text><rect fill="#00008b" y="20" x="0" height="10" width="20.0"></rect><rect fill="#3031c9" y="20" x="20" height="10" width="20.0"></rect><rect fill="#5768e6" y="20" x="40" height="10" width="20.0"></rect><rect fill="#799ef6" y="20" x="60" height="10" width="20.0"></rect><rect fill="#a1d4fe" y="20" x="80" height="10" width="20.0"></rect><rect fill="#ffffff" y="20" x="100" height="10" width="20.0"></rect><rect fill="#ffd130" y="20" x="120" height="10" width="20.0"></rect><rect fill="#ff9500" y="20" x="140" height="10" width="20.0"></rect><rect fill="#ed5700" y="20" x="160" height="10" width="20.0"></rect><rect fill="#c42102" y="20" x="180" height="10" width="20.0"></rect><rect fill="#8b0000" y="20" x="200" height="10" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="0">-10</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="25">-8</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="45">-6</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="65">-4</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="85">-2</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="107">0</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="127">2</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="147">4</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="167">6</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="187">8</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="205">10</text></svg></td></tr>'
      legend_html += '<tr id="china-aviation-legend" style="display: none"><td><div style="background-color:red; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">China Aviation <span class="credit"> (????)</span></div></td></tr>';
      legend_html += '<tr id="china-power-plants-legend" style="display: none"><td><div style="background-color:green; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">China Power Plants <span class="credit"> (????)</span></div></td></tr>';
      legend_html += '<tr id="china-reservoirs-legend" style="display: none"><td><div style="background-color:blue; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">China Reservoirs <span class="credit"> (????)</span></div></td></tr>';
      legend_html += '<tr id="china-waste-treatment-plants-legend" style="display: none"><td><div style="background-color:orange; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">China Waste Treatment Plants <span class="credit"> (????)</span></div></td></tr>';
      legend_html += '<tr id="omi-no2-legend" style="display:none"><td><div style="font-size: 13px">OMI NO2 2005-2016<span class="credit"> (NOAA)</span></div><svg class="svg-legend" width="220" height="40"><rect fill="rgb(68, 160, 216)" y="20" x="0" height="10" width="40.0"></rect><rect fill="rgb(171, 215, 176)" y="20" x="40" height="10" width="40.0"></rect><rect fill="rgb(253, 230, 132)" y="20" x="80" height="10" width="40.0"></rect><rect fill="rgb(252, 136, 80)" y="20" x="120" height="10" width="40.0"></rect><rect fill="rgb(232, 0, 28)" y="20" x="160" height="10" width="40.0"></rect><text font-size="12px" fill="rgba(0, 0, 0, 0.8)" y="40" x="5">LOW</text><text font-size="12px" fill="rgba(0, 0, 0, 0.8)" y="40" x="165">HIGH</text></svg></td></tr>';
      legend_html += '<tr id="be-pm25-legend" style="display:none"><td><div style="font-size: 14px">PM2.5<span class="credit"> (Berkeley Earth)</span></div><svg class="svg-legend" width="320" height="50"><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="0">0.0</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="40">12.0</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="92">35.5</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="142">55.5</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="192">150.5</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="242">250.5</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="287">500.0</text><rect fill="rgb(12, 231, 0)"  y="20" x="0" height="10" width="50.0"></rect><rect fill="rgb(255, 255, 0)" y="20" x="50" height="10" width="50.0"></rect><rect fill="rgb(255, 105, 0)" y="20" x="100" height="10" width="50.0"></rect><rect fill="rgb(255, 0, 0)"   y="20" x="150" height="10" width="50.0"></rect><rect fill="rgb(135, 0, 59)"  y="20" x="200" height="10" width="50.0"></rect><rect fill="rgb(107, 0, 25)"  y="20" x="250" height="10" width="50.0"></rect><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="10">Good</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="55">Moderate</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="105">Unhealthy</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="150">+Unhealthy</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="200">++Unhealthy</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="255">Hazardous</text></svg></td></tr>';


      // ## 5b ##
      //// Add to layer legend ////
      //
      legend_html += '</table>';
      legend_html += '</div>';
      legend_html += '</div>';

      if (enableLetterboxMode) {
        $(layer_html).appendTo($("#content"));
        $(legend_html).appendTo($("#content"));
        $("#presentation-slider-selection, .base-map-radio, .map-layer-checkbox, .extras-selector, .presentationSlider, #layers-legend, .customInstructions, .player, .share").addClass("letterbox");
        $(".base-map-div, .map-layer-div, .extras-selector-div").addClass("top-panel letterbox");
        $(".current-location-text").addClass("letterbox");
        $(".clear-theme").on("click", function() {
          var selectedTheme = $(this).prev().prop('id').replace("_ms", "-selection");
          var selectedLayers = $("#" + selectedTheme).find("input:checked");
          selectedLayers.each(function() {
            if ($(this).prop('checked')) $(this).trigger("click");
          });
        });
        // Theme dropdowns
        $("#forest-theme").multiselect({
            header: false,
            noneSelectedText: "Select layers...",
            selectedText: "# layer(s) selected",
            menuWidth: 630,
            height: 116,
            colType: "double"
        });
        $("#water-theme").multiselect({
            header: false,
            noneSelectedText: "Select layers...",
            selectedText: "# layer(s) selected",
            menuWidth: 425,
            height: 32,
            colType: "double"
        });
        $("#energy-theme").multiselect({
            header: false,
            noneSelectedText: "Select layers...",
            selectedText: "# layer(s) selected",
            menuWidth: 620,
            height: 116,
            colType: "double"
        });
        $("#coral-theme").multiselect({
            header: false,
            noneSelectedText: "Select layers...",
            selectedText: "# layer(s) selected",
            menuWidth: 600,
            height: 32,
            colType: "double"
        });
        $("#pandemic-theme").multiselect({
            header: false,
            noneSelectedText: "Select layers...",
            selectedText: "# layer(s) selected",
            menuWidth: 520,
            height: 194,
            colType: "double"
        });
        $("#refugee-theme").multiselect({
            header: false,
            noneSelectedText: "Select layers...",
            selectedText: "# layer(s) selected",
            menuWidth: 730,
            height: 32,
            colType: "double"
        });
        $("#nutrition-theme").multiselect({
            header: false,
            noneSelectedText: "Select layers...",
            selectedText: "# layer(s) selected",
            menuWidth: 733,
            height: 72,
            colType: "double"
        });
        $("#resilience-theme").multiselect({
            header: false,
            noneSelectedText: "Select layers...",
            selectedText: "# layer(s) selected",
            menuWidth: 1032,
            height: 72,
            colType: "triple"
        });
        $("#urbanization-theme").multiselect({
            header: false,
            noneSelectedText: "Select layers...",
            selectedText: "# layer(s) selected",
            menuWidth: 480,
            height: 32,
            colType: "double"
        });
      } else {
        $(layer_html).appendTo($("#timeMachine .player"));
        $(legend_html).appendTo($("#timeMachine .player"));
        $("#layers-list").addClass("right-panel");

        // Hide any fieldsets that have all their children
        // hidden (i.e. all layers of that topic are hidden)
        $("#layers-list").find('table').each(function() {
          if ($($(this)[0]).children().length == 0) {
            if (this.id == "dotmaps_table" && (showLodesLayer || showCustomDotmaps)) return;
            $(this).prev().hide();
          }
        });

        var toggleIconClose = "ui-icon-arrowthick-1-ne";
        var toggleIconOpen = "ui-icon-arrowthick-1-sw";
        var $toggleLayerPanelBtn = $(".toggleLayerPanelBtn");
        $toggleLayerPanelBtn.button({
          icons: {
            primary: toggleIconClose
          },
          text: false
        }).click(function() {
          if ($("#layers-list").hasClass("hide-layers-list")) {
            $("#layers-list").removeClass("hide-layers-list");
            $(this).css({"top" : "3px", "right" : "5px"});
          } else {
            $("#layers-list").addClass("hide-layers-list");
            $(this).css({"top" : "0px", "right" : "0px"});
          }
          var $icon = $(this).children(".ui-icon");
          if ($icon.hasClass(toggleIconOpen)) {
            $toggleLayerPanelBtn.button({
              icons: {
                primary: toggleIconClose
              },
              text: false
            });
          } else if ($icon.hasClass(toggleIconClose)) {
            $toggleLayerPanelBtn.button({
              icons: {
                primary: toggleIconOpen
              },
              text: false
            });
          }
          $("#layers-list.right-panel").hide().show(0);
        });
      }

      if (isHyperwall) {
        $("#layers-list, .sideToolBar, #layers-legend, #presentation-slider-selection, .base-map-div, .current-location-text, .customZoomhelp").addClass("hyperwall");
      }


      // ## 6 ##
      //// Layer options and initialization ////
      //

      // Landsat
      var defaultTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax[cachedLandsatTimeJsonPath]['capture-times'].length,
        fps: 10
      };
      landsatBaseMapLayer = new WebglTimeMachineLayer(glb, canvasLayer, landsatUrl, defaultTimeMachineLayerOptions);

      // NDVI Anomaly
      var ndviAnomalyTimemachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['ndvi-anomaly-times.json']['capture-times'].length,
        fps: 1,
        video_width: 1424,
        video_height: 800,
        width: 40076,
        height: 40076,
        greenScreen: true
      };
      ndviAnomalyTimemachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, ndviAnomalyTimemachineUrl, ndviAnomalyTimemachineLayerOptions);

      // Coral Bleaching Alerts
      var crwTimemacineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['crw-times.json']['capture-times'].length,
        fps: 22,
        video_width: 1424,
        video_height: 800,
        width: 7200,
        height: 7200,
        greenScreen: true
      };
      crwTimemachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, crwTimemachineUrl, crwTimemacineLayerOptions);

      // Himawari-8
      var himawariTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['himawari-times.json']['capture-times'].length,
        fps: 12,
        nLevels: 4,
        video_width: 1424,
        video_height: 800,
        width: 11000,
        height: 11000
      };
      himawariTimemachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, himawariTimemachineUrl, himawariTimeMachineLayerOptions);

      // Forest Alerts
      var forestAlertsTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['forest-alerts-times.json']['capture-times'].length,
        fps: 10,
        nLevels: 11,
        video_width: 1424,
        video_height: 800,
        width: 750836,
        height: 156136
      };
      forestAlertsTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsTimeMachineUrl, forestAlertsTimeMachineLayerOptions);
      forestAlertsNoOverlayTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsNoOverlayTimeMachineUrl, forestAlertsTimeMachineLayerOptions);

      // Himawari-8
      var berkeleyEarthTemperatureAnomalyTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['berkeley-earth-temperature-anomaly-times.json']['capture-times'].length,
        fps: 12,
        nLevels: 2,
        video_width: 1424,
        video_height: 800,
        width: 1024,
        height: 1024
      };
      berkeleyEarthTemperatureAnomalyTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, berkeleyEarthTemperatureAnomalyTimeMachineUrl, berkeleyEarthTemperatureAnomalyTimeMachineLayerOptions);


      var omiNo2LayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['omi-no2-times.json']['capture-times'].length,
        fps: 12,
        nlevels: 4,
        video_width: 1424,
        video_height: 800,
        width: 5760,
        height: 5760,
        greenScreen: true
      };
      omiNo2Layer = new WebglTimeMachineLayer(glb, canvasLayer, omiNo2Url, omiNo2LayerOptions);

      var bePm25LayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['be-pm25-times.json']['capture-times'].length,
        fps: 22,
        nlevels: 5,
        video_width: 1424,
        video_height: 800,
        width: 8192,
        height: 8192,
        greenScreen: true
      };
      bePm25Layer = new WebglTimeMachineLayer(glb, canvasLayer, bePm25Url, bePm25LayerOptions);

      // For any raster map
      var defaultMapLayerOptions = {
        nLevels: 12,
        tileWidth: 256,
        tileHeight: 256
      };

      // For any retina raster map
      var retinaMapLayerOptions = {
        nLevels: useGoogleMaps ? 20 : 11,
        tileWidth: 512,
        tileHeight: 512
      };

      // For the light/dark base layers
      var defaultBaseMapLayerOptions = {
        nLevels: useGoogleMaps ? 20 : 11,
        tileWidth: 256,
        tileHeight: 256
      };

      var baseMapLayerOptions = isHyperwall ? retinaMapLayerOptions : defaultBaseMapLayerOptions;

      lightBaseMapLayer = new WebglMapLayer(glb, canvasLayer, lightMapUrl, defaultBaseMapLayerOptions);
      darkBaseMapLayer = new WebglMapLayer(glb, canvasLayer, darkMapUrl, defaultBaseMapLayerOptions);
      hansenMapLayer = new WebglMapLayer(glb, canvasLayer, gfcTransUrl, defaultMapLayerOptions);
      hansenMapLayer2 = new WebglMapLayer(glb, canvasLayer, gfcLossGainUrl, defaultMapLayerOptions);
      mcrmVectorLayer = new WebglVectorLayer2(glb, canvasLayer, mcrmUrl, defaultBaseMapLayerOptions);
      waterOccurrenceLayer = new WebglMapLayer(glb, canvasLayer, waterOccurrenceUrl, defaultBaseMapLayerOptions);
      waterChangeLayer = new WebglMapLayer(glb, canvasLayer, waterChangeUrl, defaultBaseMapLayerOptions);

      landBorderLayer = new WebglMapLayer(glb, canvasLayer, landBorderUrl, defaultBaseMapLayerOptions);

      vsiLayer = new WebglMapLayer(glb, canvasLayer, vsiUrl, defaultMapLayerOptions);


      var coralBleachingLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
      };
      coralBleachingLayer = new WebglVectorLayer2(glb, canvasLayer, coralBleachingUrl, coralBleachingLayerOptions);

      var lightsAtNightMapLayerOptions = {
        nLevels: 8,
        tileWidth: 256,
        tileHeight: 256
      };
      lightsAtNightMapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNightUrl, lightsAtNightMapLayerOptions);

      var lightsAtNight2012MapLayerOptions = {
        nLevels: 9,
        tileWidth: 256,
        tileHeight: 256
      };
      lightsAtNight2012MapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNight2012Url, lightsAtNight2012MapLayerOptions);

      var lightsAtNight2016MapLayerOptions = {
        nLevels: 9,
        tileWidth: 256,
        tileHeight: 256
      };
      lightsAtNight2016MapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNight2016Url, lightsAtNight2016MapLayerOptions);

      var animatedHansenLayerOptions = {
        nLevels: 12,
        tileWidth: 256,
        tileHeight: 256
      };
      animatedHansenLayer = new WebglMapLayer2(glb, canvasLayer, animatedHansenUrls, animatedHansenLayerOptions);

      var viirsLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setViirsData,
        drawFunction: WebGLVectorTile2.prototype._drawViirs,
        fragmentShader: WebGLVectorTile2.viirsFragmentShader,
        vertexShader: WebGLVectorTile2.viirsVertexShader
      };
      viirsLayer = new WebglVectorLayer2(glb, canvasLayer, viirsUrl, viirsLayerOptions);

      var wdpaLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 11,
        setDataFunction: WebGLVectorTile2.prototype._setWdpaData,
        drawFunction: WebGLVectorTile2.prototype._drawWdpa,
        fragmentShader: WebGLVectorTile2.wdpaFragmentShader,
        vertexShader: WebGLVectorTile2.wdpaVertexShader
      };
      wdpaLayer = new WebglVectorLayer2(glb, canvasLayer, wdpaUrl, wdpaLayerOptions);

      var usgsWindturbineLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
      };
      usgsWindTurbineLayer = new WebglVectorLayer2(glb, canvasLayer, usgsWindTurbineUrl, usgsWindturbineLayerOptions);

      var globalWindPowerLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
      };
      globalWindPowerLayer = new WebglVectorLayer2(glb, canvasLayer, globalWindPowerUrl, globalWindPowerLayerOptions);

      var solarInstallsLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
      };
      solarInstallsLayer = new WebglVectorLayer2(glb, canvasLayer, solarInstallsUrl, solarInstallsLayerOptions);

      var drillingLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
      };
      drillingLayer = new WebglVectorLayer2(glb, canvasLayer, drillingUrl, drillingLayerOptions);

      var monthlyRefugeesLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setMonthlyRefugeesData,
        drawFunction: WebGLVectorTile2.prototype._drawMonthlyRefugees,
        fragmentShader: WebGLVectorTile2.monthlyRefugeesFragmentShader,
        vertexShader: WebGLVectorTile2.monthlyRefugeesVertexShader
      };
      monthlyRefugeesLayer = new WebglVectorLayer2(glb, canvasLayer, monthlyRefugeesUrl, monthlyRefugeesLayerOptions);

      var annualRefugeesLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setAnnualRefugeesData,
        drawFunction: WebGLVectorTile2.prototype._drawAnnualRefugees,
        fragmentShader: WebGLVectorTile2.annualRefugeesFragmentShader,
        vertexShader: WebGLVectorTile2.annualRefugeesVertexShader,
        imageSrc: "annual-refugees-color-map.png"

      };
      annualRefugeesLayer = new WebglVectorLayer2(glb, canvasLayer, annualRefugeesUrl, annualRefugeesLayerOptions);

      var annualReturnsLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setAnnualRefugeesData,
        drawFunction: WebGLVectorTile2.prototype._drawAnnualRefugees,
        fragmentShader: WebGLVectorTile2.annualRefugeesFragmentShader,
        vertexShader: WebGLVectorTile2.annualRefugeesVertexShader,
        imageSrc: "annual-returns-color-map.png"

      };
      annualReturnsLayer = new WebglVectorLayer2(glb, canvasLayer, annualReturnsUrl, annualReturnsLayerOptions);

      var healthImpactLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setHealthImpactData,
        drawFunction: WebGLVectorTile2.prototype._drawHealthImpact,
        fragmentShader: WebGLVectorTile2.healthImpactFragmentShader,
        vertexShader: WebGLVectorTile2.healthImpactVertexShader
      };
      healthImpactLayer = new WebglVectorLayer2(glb, canvasLayer, healthImpactUrl, healthImpactLayerOptions);


      var zikaLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
      };
      zikaLayer = new WebglVectorLayer2(glb, canvasLayer, zikaUrl, zikaLayerOptions);

      var dengueLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
      };
      dengueLayer = new WebglVectorLayer2(glb, canvasLayer, dengueUrl, dengueLayerOptions);

      var chikuLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
      };
      chikuLayer = new WebglVectorLayer2(glb, canvasLayer, chikuUrl, chikuLayerOptions);

      var seaLevelRiseLayerOptions = {
        nLevels: 12,
        tileWidth: 256,
        tileHeight: 256,
        fragmentShader: WebglMapTile.seaLevelRiseTextureFragmentShader,
        drawFunction: WebglMapTile.prototype._drawSeaLevelRise,

      };

      seaLevelRiseLayer = new WebglMapLayer(glb, canvasLayer, seaLevelRiseUrl, seaLevelRiseLayerOptions);


      var urbanFragilityLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUrbanFragilityData,
        drawFunction: WebGLVectorTile2.prototype._drawUrbanFragility,
        fragmentShader: WebGLVectorTile2.urbanFragilityFragmentShader,
        vertexShader: WebGLVectorTile2.urbanFragilityVertexShader,
        imageSrc: "urban-fragility-color-map.png"

      };
      urbanFragilityLayer = new WebglVectorLayer2(glb, canvasLayer, urbanFragilityUrl, urbanFragilityLayerOptions);

      var gtdLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setGtdData,
        drawFunction: WebGLVectorTile2.prototype._drawGtd,
        fragmentShader: WebGLVectorTile2.gtdFragmentShader,
        vertexShader: WebGLVectorTile2.gtdVertexShader
      };
      gtdLayer = new WebglVectorLayer2(glb, canvasLayer, gtdUrl, gtdLayerOptions);

      var uppsalaConflictLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUppsalaConflictData,
        drawFunction: WebGLVectorTile2.prototype._drawUppsalaConflict,
        fragmentShader: WebGLVectorTile2.uppsalaConflictFragmentShader,
        vertexShader: WebGLVectorTile2.uppsalaConflictVertexShader
      };
      uppsalaConflictLayer = new WebglVectorLayer2(glb, canvasLayer, uppsalaConflictUrl, uppsalaConflictLayerOptions);

      var hivLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUrbanFragilityData,
        drawFunction: WebGLVectorTile2.prototype._drawUrbanFragility,
        fragmentShader: WebGLVectorTile2.hivFragmentShader,
        vertexShader: WebGLVectorTile2.hivVertexShader,
        imageSrc: "hiv-color-map.png"
      };
      hivLayer = new WebglVectorLayer2(glb, canvasLayer, hivUrl, hivLayerOptions);


      var obesityLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setObesityData,
        loadDataFunction: WebGLVectorTile2.prototype._loadGeojsonData,
        drawFunction: WebGLVectorTile2.prototype._drawObesity,
        fragmentShader: WebGLVectorTile2.obesityFragmentShader,
        vertexShader: WebGLVectorTile2.obesityVertexShader,
        imageSrc: "obesity-color-map.png"
      };
      obesityLayer = new WebglVectorLayer2(glb, canvasLayer, obesityUrl, obesityLayerOptions);

      var vaccineConfidenceLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setVaccineConfidenceData,
        loadDataFunction: WebGLVectorTile2.prototype._loadGeojsonData,
        drawFunction: WebGLVectorTile2.prototype._drawVaccineConfidence,
        fragmentShader: WebGLVectorTile2.vaccineConfidenceFragmentShader,
        vertexShader: WebGLVectorTile2.vaccineConfidenceVertexShader,
        imageSrc: "vaccine-confidence-color-map.png"
      };
      vaccineConfidenceLayer = new WebglVectorLayer2(glb, canvasLayer, vaccineConfidenceUrl, vaccineConfidenceLayerOptions);

      var ebolaLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setEbolaData,
        drawFunction: WebGLVectorTile2.prototype._drawEbola,
        fragmentShader: WebGLVectorTile2.ebolaFragmentShader,
        vertexShader: WebGLVectorTile2.ebolaVertexShader
      };
      ebolaDeathsLayer = new WebglVectorLayer2(glb, canvasLayer, ebolaDeathsUrl, ebolaLayerOptions);
      ebolaCasesLayer = new WebglVectorLayer2(glb, canvasLayer, ebolaCasesUrl, ebolaLayerOptions);
      ebolaNewCasesLayer = new WebglVectorLayer2(glb, canvasLayer, ebolaNewCasesUrl, ebolaLayerOptions);

      var lodesLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 10,
        setDataFunction: WebGLVectorTile2.prototype._setLodesData,
        drawFunction: WebGLVectorTile2.prototype._drawLodes,
        fragmentShader: WebGLVectorTile2.lodesFragmentShader,
        vertexShader: WebGLVectorTile2.lodesVertexShader
      };
      lodesLayer = new WebglVectorLayer2(glb, canvasLayer, lodesUrl, lodesLayerOptions);
      initLodesGui();

      var cumulativeActiveMiningLayerOptions = {
        nLevels: 12,
        tileWidth: 256,
        tileHeight: 256,
        fragmentShader: WebglMapTile.animatedTextureFragmentShader,
        drawFunction: WebglMapTile.prototype._drawAnimatedTexture,

      };
      cumulativeActiveMiningLayer = new WebglMapLayer(glb, canvasLayer, cumulativeActiveMiningUrl, cumulativeActiveMiningLayerOptions);

      var iomIdpLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        loadDataFunction: WebGLVectorTile2.prototype._loadGeojsonData,
        setDataFunction: WebGLVectorTile2.prototype._setIomIdpData,
        drawFunction: WebGLVectorTile2.prototype._drawIomIdp,
        fragmentShader: WebGLVectorTile2.iomIdpFragmentShader,
        vertexShader: WebGLVectorTile2.iomIdpVertexShader
      };
      iomIdpLayer = new WebglVectorLayer2(glb, canvasLayer, iomIdpUrl, iomIdpLayerOptions);
      iomIdpLayer.options = {
        'showIrqIdps': false,
        'showSyrIdps': false,
        'showYemIdps': false,
        'showLbyIdps': false,
        'showIrqReturns': false,
        'showSyrReturns': false,
        'showYemReturns': false,
        'showLbyReturns': false      }


      var chinaLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
      };
      chinaAviationLayer = new WebglVectorLayer2(glb, canvasLayer, chinaAviationUrl, chinaLayerOptions);
      chinaPowerPlantsLayer = new WebglVectorLayer2(glb, canvasLayer, chinaPowerPlantsUrl, chinaLayerOptions);
      chinaReservoirsLayer = new WebglVectorLayer2(glb, canvasLayer, chinaReservoirsUrl, chinaLayerOptions);
      chinaWasteTreatmentPlantsLayer = new WebglVectorLayer2(glb, canvasLayer, chinaWasteTreatmentPlantsUrl, chinaLayerOptions);

      // Layer Toggle UI
      initLayerToggleUI();
      $(".googleLogo").html("Google Earth Engine");

      if (enableRecordingMode) {
        var snaplapse = timelapse.getSnaplapse();
        if (snaplapse) {
          snaplapse.getSnaplapseViewer().setToRecordingMode();
        }
      }

      // Toggle layers off when auto mode begins
      snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
      if (snaplapseForPresentationSlider) {
        snaplapseViewerForPresentationSlider = snaplapseForPresentationSlider.getSnaplapseViewer();
      }

      if (snaplapseViewerForPresentationSlider) {
        $('.presentationSlider').show();
        var $elements = $('.presentationSlider, .customControl, .controls, .captureTime, .scaleBarContainer, .snaplapse_keyframe_container, .keyframeSubtitleBoxForHovering, .snaplapse_keyframe_list_item_presentation, .snaplapse_keyframe_list_item_thumbnail_overlay_presentation');
        if (isHyperwall)
          $elements.addClass('hyperwall');
        if (enableLetterboxMode)
          $elements.addClass('letterbox');
        if (enableRecordingMode)
          $elements.addClass('recording');

        snaplapseViewerForPresentationSlider.addEventListener('snaplapse-loaded', function() {
          $(".snaplapse_keyframe_container").scrollLeft(0);
        });

        $('.current-location-text').click(function() {
          $(this).hide();
        });

        snaplapseViewerForPresentationSlider.addEventListener('automode-start', function() {
          if (timelapse.isPaused() && !timelapse.isDoingLoopingDwell()) {
            timelapse.handlePlayPause();
          }
        });

        snaplapseViewerForPresentationSlider.addEventListener('slide-before-changed', function(waypoint) {
          var waypointTitle = waypoint.title;
          var waypointIndex = waypoint.index;
          var waypointBounds = waypoint.bounds;
          isAutoModeRunning = snaplapseViewerForPresentationSlider.isAutoModeRunning();
          if (himawariWaypoints[waypointIndex]) timelapse.setMaxScale(himawariMaxScale);
          else timelapse.setMaxScale(landsatMaxScale);
        });

        snaplapseViewerForPresentationSlider.addEventListener('slide-changed', function(waypoint) {
          var waypointTitle = waypoint.title;
          var waypointIndex = waypoint.index;
          var waypointBounds = waypoint.bounds;
          var waypointLayers = waypoint.layers || [];
          var waypointStartTime = waypoint.time;
          var waypointEndTime = waypoint.endTime;
          var himawariWaypoint = himawariWaypoints[waypointIndex];

          // We are still technically using Landsat projections for any dataset being drawn,
          // so the bounds that slide-change returns is not valid for our use. But we already
          // know the bounds each himawari waypoints should be, so use that instead.
          if (himawariWaypoint) {
            waypointBounds = himawariWaypoint.bounds;
            waypointStartTime = himawariWaypoint.time;
          }

          timelapse.removeTimeChangeListener(waypointTimeChangeListener);

          if (waypointEndTime >= 0 && waypointStartTime != waypointEndTime) {
            waypointTimeChangeListener = function(t) {
              if (t >= waypointEndTime) {
                timelapse.seek(waypointStartTime);
              }
            }
            timelapse.addTimeChangeListener(waypointTimeChangeListener);
          }

          // Display info box for the waypoints
          if (enableWaypointText) {
            var waypointScale = timelapse.pixelBoundingBoxToPixelCenter(waypointBounds).scale;
            var $current_location_text = $(".current-location-text");

            timelapse.removeViewChangeListener(waypointViewChangeListener);
            timelapse.removeViewChangeListener(hideWaypointListener);
            waypointViewChangeListener = function() {
              var currentView = timelapse.getView();
              if (currentView.scale * 2.5 > waypointScale && (currentView.x >= waypointBounds.xmin && currentView.x <= waypointBounds.xmax && currentView.y >= waypointBounds.ymin && currentView.y <= waypointBounds.ymax)) {
                if (waypoint.annotationBoxTitle || waypoint.description) {
                  $current_location_text.show();
                  timelapse.seek(waypointStartTime);
                  $current_location_text.find("h3").text(waypoint.annotationBoxTitle);
                  var $current_location_text_picture = $current_location_text.find("img");
                  if (annotationPicturePaths[waypointIndex] && annotationPicturePaths[waypointIndex].path) {
                    $current_location_text_picture.attr("src", annotationPicturePaths[waypointIndex].path);
                  } else {
                    $current_location_text_picture.attr("src", "");
                    $current_location_text.css("max-width", 283);
                  }
                  $current_location_text.find("p").text(waypoint.description);
                  previousWaypoint.scale = waypointScale;
                  previousWaypoint.bounds = waypointBounds;
                  hideWaypointListener = function() {
                    var currentView = timelapse.getView();
                    var previousWaypointBounds = previousWaypoint.bounds;
                    if ((previousWaypoint.scale / 2.5 > currentView.scale || !(currentView.x >= previousWaypointBounds.xmin && currentView.x <= previousWaypointBounds.xmax && currentView.y >= previousWaypointBounds.ymin && currentView.y <= previousWaypointBounds.ymax))) {
                      $(".current-location-text").hide();
                      timelapse.removeViewChangeListener(hideWaypointListener);
                      timelapse.removeTimeChangeListener(waypointTimeChangeListener);
                    }
                  };
                  timelapse.addViewChangeListener(hideWaypointListener);
                } else {
                  $(".current-location-text").hide();
                }
                timelapse.removeViewChangeListener(waypointViewChangeListener);
              } else {
                $(".current-location-text").hide();
              }
            };

            // Close the extra content pop-up if a waypoint is clicked.
            $('#extras-content').dialog('close');

            timelapse.addViewChangeListener(waypointViewChangeListener);
          }

          // Remove himawari since we do special cases further below
          var himawariIdx = waypointLayers.indexOf("h8");
          himawariIdx = himawariIdx > -1 ? himawariIdx : waypointLayers.indexOf("h8_16");
          if (himawariIdx > -1) waypointLayers.splice(himawariIdx, 1);

          // Clear out layers if they were already checked
          // If himawari waypoint, clear out everything
          if (himawariWaypoint)
            $(".map-layer-div, .ui-multiselect-checkboxes").find("input:checked").not("#show-himawari").trigger("click");
          else
            $(".map-layer-div, .ui-multiselect-checkboxes").find("input:checked").trigger("click");

          // Handle layers
          waypointLayers.forEach(function(layer) {
            var $layerToggle = $("#layers-list label[name='" + layer + "'] input, .ui-multiselect-checkboxes label[name='" + layer + "'] input");
            if (!$layerToggle.prop('checked')) $layerToggle.trigger("click");
          });

          // Handle Himawari
          // Note: Must be run after other layers
          if (himawariWaypoint) {
            var initialHimawariViewChangeHack = function() {
              if (isAutoModeRunning) {
                snaplapseViewerForPresentationSlider.startAutoModeWaypointTimeout();
              } else {
                snaplapseViewerForPresentationSlider.startAutoModeIdleTimeout();
              }
            };

            var setHimawariView = function(himawariBoundingBox, himawariTime, himawariPlaybackSpeed) {
              var himawariView = {
                bbox: himawariBoundingBox
              };
              if (showHimawariTimeMachineLayer) {
                timelapse.stopParabolicMotion();
                timelapse.setNewView(himawariView);
              } else {
                $("#show-himawari").click();
                timelapse.stopParabolicMotion();
                timelapse.setNewView(himawariView, true, null, initialHimawariViewChangeHack);
              }
              timelapse.setMasterPlaybackRate(himawariPlaybackSpeed);
              timelapse.setPlaybackRate(himawariPlaybackSpeed);
              setTimeout(function() {
                timelapse.seek(himawariTime);
              }, 150);
            };

            setHimawariView(himawariWaypoint.bounds, himawariWaypoint.time, 0.5);
          }
          // End Himawari
        });
      }


      // Location search box, with autocomplete.
      var $locationSearchDiv = $('<div class="location_search_div"><input id="location_search" type="text" placeholder="Search for a location...">');
      if (enableLetterboxMode) {
        $locationSearchDiv.addClass("top-panel letterbox").appendTo($("#content"));
        $("#location_search").addClass("letterbox");
      } else {
        $locationSearchDiv.appendTo($("#timeMachine .player"));
      }

      if (isHyperwall) {
        $("#location_search").addClass("hyperwall");
      }

      // Note: Google's service gives much better results, but for locations where Google APIs cannot be used, we fallback to this.
      if (!useGoogleSearch) {
        var locationList = [];
        $("#location_search").autocomplete({
          minLength: 5,
          source: function(request, response) {
            locationList = [];
            //http://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=1
            $.getJSON("http://photon.komoot.de/api/?limit=5", {
              q: request.term
            }, function(data, status, xhr) {
              response(data.features);
            });
          },
          select: function(event, ui) {
            var view;
            //if (ui.item.properties.extent) {
            //  view = {bbox: {"ne": {"lat": ui.item.properties.extent[1], "lng": ui.item.properties.extent[2]}, "sw": {"lat" : ui.item.properties.extent[3], "lng": ui.item.properties.extent[0]}}};
            //} else {
            view = {
              center: {
                "lat": ui.item.geometry.coordinates[1],
                "lng": ui.item.geometry.coordinates[0]
              },
              "zoom": 12
            };
            //}
            timelapse.setNewView(view);
            if (ui.item.properties)
              UTIL.addGoogleAnalyticEvent('textbox', 'search', 'go-to-searched-place=' + ui.item.properties.name + "," + ui.item.properties.country);
          }
        }).autocomplete("instance")._renderItem = function(ul, item) {
          var tmpLocationString = (item.properties.name || "") + ", " + (item.properties.state || "") + item.properties.country;
          if (item.properties.osm_value == "hamlet" || !item.properties.country || locationList.indexOf(tmpLocationString) >= 0) return $("<li>");
          locationList.push(tmpLocationString);
          return $("<li style='z-index:9999'>").append("<a>" + (item.properties.name || "") + ", " + (item.properties.state || "") + "<br>" + item.properties.country + "</a>").appendTo(ul);
        };
      } else if (typeof(google) === "undefined" && !useGoogleMaps) {
        var googleMapsScript = document.createElement('script');
        var googleMapsSrc = "https://maps.google.com/maps/api/js?libraries=places&callback=googleMapsLoadedCallback";
        if (googleMapsAPIKey)
          googleMapsSrc += "&key=" + googleMapsAPIKey;
        googleMapsScript.setAttribute('src', googleMapsSrc);
        googleMapsScript.setAttribute('type', 'text/javascript');
        document.getElementsByTagName('head')[0].appendChild(googleMapsScript);
      }

      // Set the letterbox mode
      if (enableLetterboxMode && !enableRecordingMode) {
        // Resize the viewer
        timelapse.addViewerBottomMargin(-2);
        // Move the presentation slider out
        var $presentationSlider = $("#" + timelapse.getTimeMachineDivId() + " .presentationSlider");
        $presentationSlider.appendTo("#content");
      }

      // Toggle the context map and hide it
      $(".toggleContextMapBtn").click();
      $(".contextMapContainer").hide();

      // Display info box for the waypoints
      if (enableWaypointText) {
        var $current_location_text = $(".current-location-text");
        $current_location_text.appendTo($("#timeMachine"));
        if (enableRecordingMode) {
          $current_location_text.find(".close").remove();
          $current_location_text.addClass("recording");
        }
      }

      $("#presentation-slider-selection").on("click", "td", function() {
        var sectionId = $(this).get(0).id;
        var waypointContainer = $(".snaplapse_keyframe_container");
        if (sectionId == "automode-section") {
          var snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
          snaplapseForPresentationSlider.getSnaplapseViewer().initializeAndRunAutoMode();
        } else {
          var scrollTo = $($(".snaplapse_keyframe_list").children().children().get($(this).data("section-idx")));
          var scrollAmount = scrollTo.offset().left - waypointContainer.offset().left + waypointContainer.scrollLeft();
          $(".snaplapse_keyframe_container").scrollLeft(scrollAmount);
        }
      });

      var hashChange = function() {
        var vals = org.gigapan.Util.getUnsafeHashVars();
        if (vals.l) {
          var layers = vals.l.split(",");
          layers.forEach(function(layer) {
            layersToShowOnCreation[layer] = true;
            var $layerToggle = $("#layers-list label[name='" + layer + "'] input, .ui-multiselect-checkboxes label[name='" + layer + "'] input");
            if (!$layerToggle.prop('checked')) {
              $layerToggle.trigger("click");
            }
          });
        }

        if (timelapse.isPresentationSliderEnabled()) {
          var waypointsPath;
          if (vals.waypoints) {
            waypointsPath = docTabToGoogleSheetUrl(vals.waypoints);
          }
          waypointsPath = waypointsPath || waypointSliderContentPath;
          loadWaypointsFromPath(waypointsPath);
        }

        if (showCustomDotmaps) {
          var dotmapsPath;
          if (vals.dotlayers) {
            dotmapsPath = vals.dotlayers;
          }
          dotmapsPath = dotmapsPath || dotmapsContentPath;
          loadDotmapsFromPath(dotmapsPath);
        }

        if (showCsvLayers) {
          csvFileLayers.loadLayers('1rCiksJv4aXi1usI0_9zdl4v5vuOfiHgMRidiDPt1WfE.870361385');
        }
      };

      if (!enableLetterboxMode) {
        $(".map-layer-div").accordion({
          collapsible: true,
          active: false,
          animate: false,
          heightStyle: 'content',
          beforeActivate: function(event, ui) {
            // The accordion believes a panel is being opened
            if (ui.newHeader[0]) {
                var currHeader  = ui.newHeader;
                var currContent = currHeader.next('.ui-accordion-content');
            // The accordion believes a panel is being closed
            } else {
                var currHeader  = ui.oldHeader;
                var currContent = currHeader.next('.ui-accordion-content');
            }
            // Since we've changed the default behavior, this detects the actual status
            var isPanelSelected = currHeader.attr('aria-selected') == 'true';

            // Toggle the panel's header
            currHeader.toggleClass('ui-corner-all',isPanelSelected).toggleClass('accordion-header-active ui-state-active ui-corner-top', !isPanelSelected).attr('aria-selected', ((!isPanelSelected).toString()));

            // Toggle the panel's icon
            currHeader.children('.ui-icon').toggleClass('ui-icon-triangle-1-e', isPanelSelected).toggleClass('ui-icon-triangle-1-s', !isPanelSelected);

            // Toggle the panel's content
            currContent.toggleClass('accordion-content-active', !isPanelSelected)
            if (isPanelSelected) {
              currContent.slideUp(0);
            } else {
              currContent.slideDown(0);
            }

            // Cancel the default action
            return false;
          }
        });
      }

      $(window).trigger("resize");
      $(window).on('hashchange', hashChange).trigger('hashchange');
      $(".share").appendTo($(".location_search_div"));
    }

    function docTabToGoogleSheetUrl(doctab) {
      var docId = doctab.split('.')[0];
      var ret = 'https://docs.google.com/spreadsheets/d/' + docId + '/edit';
      var tabId = doctab.split('.')[1];
      if (tabId) ret += '#gid=' + tabId;
      return ret;
    }

    function googleSheetUrlToDocTab(url) {
      var match = /spreadsheets\/d\/(.*?)\/(.*?[#&]gid=(\d+))?/.exec(url);
      if (!match || match[1].len < 20) return null;
      var ret = match[1];
      if (match[3]) ret += '.' + match[3];
      return ret;
    }

    var spreadsheetUrlDialog;
    function askForSpreadsheetUrl(type, callback) {
      if (!spreadsheetUrlDialog) {
        spreadsheetUrlDialog = $('<div style="line-height: 200%"></div>').appendTo($('body'));
      }
      var d = spreadsheetUrlDialog;
      d.html('Paste new Google Spreadsheet tab URL for ' + type + '.<br>' +
             '<input type="text" size=90 id="spreadsheet-path"></input><br>' +
             '<i>If your spreadsheet has more than one tab, be sure to select the correct tab ' +
             'before copying its URL, as each tab has a different URL.</i><br>' +
             '<input type="checkbox" id="make-spreadsheet-default" value="' + type + '" style="cursor: pointer;"> Make this the default spreadsheet loaded from now on?<br>');

      d.dialog({
        minWidth: 800,
        title: "Change " + type,
        buttons: {
          Ok: function() {
            var url = d.find('#spreadsheet-path').val();
            if (typeof(Storage) !== "undefined") {
              var $makeDefaultElem = d.find('#make-spreadsheet-default');
              var makeDefault = $makeDefaultElem.is(':checked');
              if (makeDefault) {
                if (type == "waypoints") {
                  localStorage.waypointSliderContentPath = url;
                } else if (type == "dotmap layers") {
                  localStorage.dotmapsContentPath = url;
                }
              }
            }
            if (googleSheetUrlToDocTab(url)) {
              $(this).dialog("close");
              callback(url);
            } else {
              alert('URL entered is not a valid Google Spreadsheet link.');
            }
          },
          Cancel: function() { $(this).dialog("close") }
        }
      });
    }

    // Modify window.location.hash to include all fields from object newFields.
    // If a field in newFields isn't already in window.location.hash, add it.
    // If a field in newFields isn already in window.location.hash, overwrite it.
    function changeHash(newFields) {
      var fields = org.gigapan.Util.getUnsafeHashVars();
      $.extend(fields, newFields);
      var newHash;
      for (var prop in fields) {
        if (fields.hasOwnProperty(prop)) {
          if (newHash) {
            newHash += '&';
          } else {
            newHash = '#';
          }
          newHash += prop + '=' + fields[prop];
        }
      }
      window.location.hash = newHash;
    }

    function getSpreadsheetDownloadPath(path) {
      if (path.indexOf(".tsv") == -1 && path.indexOf("http") == -1) {
        path = docTabToGoogleSheetUrl(path);
      }
      return path;
    }

    var settingsDialog;

    function showSettingsDialog() {
      if (!settingsDialog) {
        settingsDialog =
          $('<div title="Settings" style="line-height: 200%"></div>')
          .appendTo($('body'));
      }

      var d = settingsDialog;
      d.html('<a target="_blank" href="' + getSpreadsheetDownloadPath(waypointsLoadedPath) + '" title="Click to view current waypoint spreadsheet">Current waypoints spreadsheet</a>' +
             '<button style="float: right; cursor: pointer;" title="Click to change waypoint list">Switch</button><br>' +
             '<a target="_blank" href="' + getSpreadsheetDownloadPath(dotlayersLoadedPath) + '" title="Click to view current dotmap spreadsheet">Current dotmap layer spreadsheet</a>' +
             '<button style="float: right; cursor: pointer;" title="Click to change dotmap layers">Switch</button><br><br>' +
             '<button style="float: right; cursor: pointer; font-size: 12px" title="Reset spreadsheets back to their defaults">Reset spreadsheets to default values</button><br>');


      d.find('button:eq(0)').click(function () {
        askForSpreadsheetUrl('waypoints', function (newUrl) {
          changeHash({waypoints: googleSheetUrlToDocTab(newUrl)});
          d.dialog("close");
        });
      });

      d.find('button:eq(1)').click(function () {
        askForSpreadsheetUrl('dotmap layers', function (newUrl) {
          changeHash({dotlayers: googleSheetUrlToDocTab(newUrl)});
          d.dialog("close");
        });
      });

      d.find('button:eq(2)').click(function () {
        localStorage.removeItem("waypointSliderContentPath");
        localStorage.removeItem("dotmapsContentPath");
        parent.location.hash = '';
        alert("Spreadsheets successfully reset back to their default values");
      });

      d.dialog({
        minWidth: 350,
        buttons: {
          Ok: function() { d.dialog("close") },
          Cancel: function() { d.dialog("close") }
        }
      });
    }

    function initSettingsUI() {
      $('.sideToolBar').append('<button class="settings" title="Settings"></button>');
      $(".settings").button({
        icons: {
          primary: "ui-icon-custom-gear"
        },
        text: false
      }).click(function() {
        showSettingsDialog();
      });
    }

    var maximumUpdateTime = 20; // milliseconds
    var startOfRedraw;

    function redrawTakingTooLong() {
      return performance.now() - startOfRedraw > maximumUpdateTime;
    }

    function resize() {
      var width = canvasLayer.canvas.width;
      var height = canvasLayer.canvas.height;
      gl.viewport(0, 0, width, height);

      if (Object.keys(jumpToButtons).length > 0 && !enableLetterboxMode) {
        var presentationSliderSelection = $("#presentation-slider-selection");
        var presentationSliderSelectionHasScroll = presentationSliderSelection[0].scrollWidth > presentationSliderSelection[0].clientWidth;
        if (presentationSliderSelectionHasScroll) {
          $("#timeMachine").removeClass("presentationSliderSelection").addClass("presentationSliderSelectionOverflow");
        } else {
          $("#timeMachine").addClass("presentationSliderSelection").removeClass("presentationSliderSelectionOverflow");
        }
      }
    }

    // Draws to canvas.
    // Called by TimeMachineCanavasLayer during animation and/or view changes
    function update() {
      perf_drawframe();
      gl.clear(gl.COLOR_BUFFER_BIT);

      //
      //// Draw layers ////
      //

      var getLayerView = function(dataLayer, baseLayer) {
        // New Landsat basemap no longer starts at standard Web Mercator north of 85.xxx
        // Compute offset in units of timelapse.getView() pixels
        var yOffset = timelapse.getProjection().latlngToPoint({
          lat: NORTH,
          lng: 0
        }).y;
        var view = timelapse.getView();
        var timelapse2map = dataLayer.getWidth() / baseLayer.getWidth();
        view.y -= yOffset;
        view.x *= timelapse2map;
        view.y *= timelapse2map;
        view.scale /= timelapse2map;
        return view;
      };

      // Extracting dates from timelapse -- TODO: Refactor and put in timemachine?
      function getDates(timelapse) {
        var dates = [];
        for (var i = 0; i < timelapse.getNumFrames(); i++) {
          dates.push(new Date(timelapse.getCaptureTimes()[i]));
        }
        return dates;
      }

      function getCurrentTimes(timelapse) {
        var currentTimes = [];
        for (var i = 0; i < timelapse.getNumFrames(); i++) {
          currentTimes.push(i/timelapse.getFps());
        }
        return currentTimes;
      }

      function getCurrentTimeIndex(currentTime, currentTimes) {
        for (var i = 0; i < currentTimes.length; i++) {
          if (currentTime <= currentTimes[i])  {
            return i;
          }
        }
        return currentTimes.length - 1;
      }

      function getCurrentTimesDelta(currentTime, currentTimes) {
        var currentIndex = getCurrentTimeIndex(currentTime, currentTimes);
        var previousIndex = 0;
        var range = 1;
        if (currentIndex != 0) {
          previousIndex = currentIndex - 1;
          range = (currentTimes[currentIndex] - currentTimes[previousIndex]);
        }
        var delta = (currentTime - currentTimes[previousIndex]) / range;
        return delta;
      }

      function getCurrentDate(currentTime, currentTimes, dates) {
        var delta = getCurrentTimesDelta(currentTime, currentTimes);
        var currentIndex = getCurrentTimeIndex(currentTime, currentTimes);
        var previousIndex = 0;
        if (currentIndex != 0) {
          previousIndex = currentIndex - 1;
        }
        var currentDate = dates[currentIndex];
        var previousDate = dates[previousIndex];
        var range = currentDate - previousDate;
        var date = new Date(previousDate.getTime() + range*delta);
        // Ensure we don't go beyond the last date of the timeline.
        // An example of where this is needed is when we are playing at fast speed and the current time
        // might go slightly beyond (small epsilon) the desired end time. You can see this when playing
        // the Obesity layer at fast speed.
        var lastTimelineDate = new Date(timelapse.getCaptureTimes()[timelapse.getNumFrames() - 1]);
        if (date > lastTimelineDate) {
          date = lastTimelineDate;
        }
        return date;
      }

      // Draw Himawari8. This is a special case that does not play with any of the other layers.
      if (showHimawariTimeMachineLayer) {
        var himawariView = getLayerView(himawariTimemachineLayer, landsatBaseMapLayer);
        himawariTimemachineLayer.draw(himawariView, tileViewVisibility);
      } else {
        // Static layers that cover the entire planet should be placed before the base layers in this manner.
        if (showLightsAtNightLayer) { // Draw lightsAtNightMapLayer
          var lightsAtNightLayerView = getLayerView(lightsAtNightMapLayer, landsatBaseMapLayer);
          lightsAtNightMapLayer.draw(lightsAtNightLayerView);
        } else if (showLightsAtNight2012Layer) { // Draw lightsAtNight2012MapLayer
          var lightsAtNight2012LayerView = getLayerView(lightsAtNight2012MapLayer, landsatBaseMapLayer);
          lightsAtNight2012MapLayer.draw(lightsAtNight2012LayerView);
        } else if (showLightsAtNight2016Layer) { // Draw lightsAtNight2016MapLayer
          var lightsAtNight2016LayerView = getLayerView(lightsAtNight2016MapLayer, landsatBaseMapLayer);
          lightsAtNight2016MapLayer.draw(lightsAtNight2016LayerView);
        } else if (showHansenLayer2) { // Draw Forest Loss/Gain
          var hansenMapLayerView2 = getLayerView(hansenMapLayer2, landsatBaseMapLayer);
          hansenMapLayer2.draw(hansenMapLayerView2);
        } else if (visibleBaseMapLayer == "landsat") { // Draw Landsat
          landsatBaseMapLayer.draw(timelapse.getView(), tileViewVisibility);
        } else if (visibleBaseMapLayer == "light") { // Draw Light Map
          var lightBaseMapView = getLayerView(lightBaseMapLayer, landsatBaseMapLayer);
          lightBaseMapLayer.draw(lightBaseMapView);
        } else if (visibleBaseMapLayer == "dark") { // Draw Dark Map
          var darkBaseMapView = getLayerView(darkBaseMapLayer, landsatBaseMapLayer);
          darkBaseMapLayer.draw(darkBaseMapView);
        }

        // Layers to draw above the base layer (or planet-wide static layers)

        // Draw Coral Reef Watch
        if (showCrwTimemachineLayer) {
          var crwView = getLayerView(crwTimemachineLayer, landsatBaseMapLayer);
          crwTimemachineLayer.draw(crwView, tileViewVisibility);
        }

        // Draw NDVI Anomaly
        if (showNdviAnomalyTimemachineLayer) {
          var ndviView = getLayerView(ndviAnomalyTimemachineLayer, landsatBaseMapLayer);
          ndviAnomalyTimemachineLayer.draw(ndviView, tileViewVisibility);
        }

        // Draw Forest Loss by Year (Transparent)
        if (showHansenLayer) {
          var hansenMapLayerView = getLayerView(hansenMapLayer, landsatBaseMapLayer);
          hansenMapLayer.draw(hansenMapLayerView);
        }

        // Draw Vegetation Sensitivity Index
        if (showVsiLayer) {
          var vsiLayerView = getLayerView(vsiLayer, landsatBaseMapLayer);
          vsiLayer.draw(vsiLayerView);
        }

        // Draw Water Occurrence
        if (showWaterOccurrenceLayer) {
          var waterOccurrenceView = getLayerView(waterOccurrenceLayer, landsatBaseMapLayer);
          waterOccurrenceLayer.draw(waterOccurrenceView);
        }

        // Draw Water Change
        if (showWaterChangeLayer) {
          var waterChangeView = getLayerView(waterChangeLayer, landsatBaseMapLayer);
          waterChangeLayer.draw(waterChangeView);
        }

        // Draw Animated Hansen Layer
        if (showAnimatedHansenLayer) {
          var animatedHansenLayerView = getLayerView(animatedHansenLayer, landsatBaseMapLayer);
          var ratio = 0;
          var captureTimes = timelapse.getCaptureTimes();
          var offset = captureTimes.indexOf("2000");
          var fps = timelapse.getFps();
          if (offset > -1) {
            var currentTime = Math.max(0, timelapse.getCurrentTime() - offset / fps);
            ratio = currentTime / ((captureTimes.length - offset - 1) / fps);
            ratio = Math.min(1, currentTime);
          }
          animatedHansenLayerView.alpha = ratio;
          animatedHansenLayer.draw(animatedHansenLayerView);
        }

        // Draw Coral
        if (showMcrmLayer) {
          var mcrmLayerView = getLayerView(mcrmVectorLayer, landsatBaseMapLayer);
          mcrmVectorLayer.draw(mcrmLayerView);
        }

        // Draw Fires at Night (VIIRS)
        if (showViirsLayer) {
          var viirsLayerView = getLayerView(viirsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          viirsLayer.draw(viirsLayerView, options);
        }

        // Draw Coral Bleaching
        if (showCoralBleachingLayer) {
          var coralBleachingLayerView = getLayerView(coralBleachingLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [.82, .22, .07, 1.0];
          options.pointSize = 8.0;
          coralBleachingLayer.draw(coralBleachingLayerView, options);
        }

        // Draw Wind Layer
        if (showUsgsWindTurbineLayer) {
          var usgsWindTurbineLayerView = getLayerView(usgsWindTurbineLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [0.1, 0.5, 0.1, 1.0];
          options.pointSize = 3.0;
          usgsWindTurbineLayer.draw(usgsWindTurbineLayerView, options);
        }

        // Draw Global Wind Layer
        if (showGlobalWindPowerLayer) {
          var globalWindPowerLayerView = getLayerView(globalWindPowerLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 3;
          options.color = [0.1, 0.5, 0.1, 1.0];
          globalWindPowerLayer.draw(globalWindPowerLayerView, options);
        }

        // Draw Solar Layer
        if (showSolarInstallsLayer) {
          var solarInstallsLayerView = getLayerView(solarInstallsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 3;
          solarInstallsLayer.draw(solarInstallsLayerView, options);
        }

        // Draw Oil/Gas Drilling Layer
        if (showDrillingLayer) {
          var drillingLayerView = getLayerView(drillingLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [0.82, 0.22, 0.07, 1.0];
          drillingLayer.draw(drillingLayerView, options);
        }

        // Draw Forest Alerts (No Overlay)
        if (showForestAlertsNoOverlayTimeMachineLayer) {
          var forestAlertsNoOverlayView = timelapse.getView();
          var timelapse2map = forestAlertsNoOverlayTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

          var p = timelapse.getProjection();
          var offest = p.latlngToPoint({
            "lat": 5.506709319555738,
            "lng": -82.5513118548623
          });

          forestAlertsNoOverlayView.x -= offest.x;
          forestAlertsNoOverlayView.y -= offest.y;
          forestAlertsNoOverlayTimeMachineLayer.draw(forestAlertsNoOverlayView, tileViewVisibility);
        }

        // Draw Forest Alerts (With Overlay)
        if (showForestAlertsTimeMachineLayer) {
          var forestAlertsView = timelapse.getView();
          var timelapse2map = forestAlertsTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

          var p = timelapse.getProjection();
          var offest = p.latlngToPoint({
            "lat": 5.506709319555738,
            "lng": -82.5513118548623
          });

          forestAlertsView.x -= offest.x;
          forestAlertsView.y -= offest.y;
          forestAlertsTimeMachineLayer.draw(forestAlertsView, tileViewVisibility);
        }

        // Draw Protected Areas (WDPA)
        if (showWdpaLayer) {
          var options = {};
          var wdpaLayerView = getLayerView(wdpaLayer, landsatBaseMapLayer);
          wdpaLayer.draw(wdpaLayerView, options);
        }

        // Draw Mediterranean Monthly Refugees
        if (showMonthlyRefugeesLayer) {
          var monthlyRefugeesLayerView = getLayerView(monthlyRefugeesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          monthlyRefugeesLayer.draw(monthlyRefugeesLayerView, options);
        }

        // Draw Annual Refugees
        if (showAnnualRefugeesLayer) {
          var annualRefugeesLayerView = getLayerView(annualRefugeesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.span = 240 * 24 * 60 * 60 * 1000;
          options.subsampleAnnualRefugees = subsampleAnnualRefugees;
          options.pointIdx = {
            2001: {'count': 798896, 'start': 0},
            2002: {'count': 1377803, 'start': 798896},
            2003: {'count': 402155, 'start': 2176699},
            2004: {'count': 640155, 'start': 2578854},
            2005: {'count': 375991, 'start': 3219009},
            2006: {'count': 1666399, 'start': 3595000},
            2007: {'count': 2881204, 'start': 5261399},
            2008: {'count': 431865, 'start': 8142603},
            2009: {'count': 900246, 'start': 8574468},
            2010: {'count': 492341, 'start': 9474714},
            2011: {'count': 742046, 'start': 9967055},
            2012: {'count': 1356451, 'start': 10709101},
            2013: {'count': 2260887, 'start': 12065552},
            2014: {'count': 3107100, 'start': 14326439},
            2015: {'count': 2331430, 'start': 17433539}
          };
          annualRefugeesLayer.draw(annualRefugeesLayerView, options);
        }

        // Draw Annual Returns
        if (showAnnualReturnsLayer) {
          var annualReturnsLayerView = getLayerView(annualReturnsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.span = 240 * 24 * 60 * 60 * 1000;
          options.subsampleAnnualRefugees = subsampleAnnualReturns;
          options.pointIdx = {
            2000: {'count': 763562, 'start': 0},
            2001: {'count': 453831, 'start': 763562},
            2002: {'count': 2411730, 'start': 1217393},
            2003: {'count': 1093240, 'start': 3629123},
            2004: {'count': 1431823, 'start': 4722363},
            2005: {'count': 1105375, 'start': 6154186},
            2006: {'count': 710542, 'start': 7259561},
            2007: {'count': 728128, 'start': 7970103},
            2008: {'count': 589392, 'start': 8698231},
            2009: {'count': 247555, 'start': 9287623},
            2010: {'count': 171179, 'start': 9535178},
            2011: {'count': 530960, 'start': 9706357},
            2012: {'count': 525154, 'start': 10237317},
            2013: {'count': 413619, 'start': 10762471},
            2014: {'count': 126877, 'start': 11176090},
            2015: {'count': 201440, 'start': 11302967}
          };
          annualReturnsLayer.draw(annualReturnsLayerView, options);
        }

        // Draw Nutritional Deficiency Layers
        if (showHealthImpactLayer) {
          var healthImpactLayerView = getLayerView(healthImpactLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();

          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var endDate = new Date("2055");
          var startDate = new Date("2015");
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          var year = currentDate.getUTCFullYear();

          for (var i = 0; i < times.length - 1; i++) {
            if (year == times[i] || year < times[i + 1] && year > times[i]) {
              year = parseInt(times[i]);
            }
          }
          var currentYear = new Date(year, 0, 1);
          var nextYear = new Date(year + 5, 0, 1);
          if (year >= 2050) {
            nextYear = currentYear;
          }
          var delta = (currentDate.getTime() - currentYear) / (nextYear - currentYear);

          options.year = year;
          options.delta = delta;
          options.showRcp = showHealthImpactRcp;

          healthImpactLayer.draw(healthImpactLayerView, options);
        }

        // Draw Zika Layer
        if (showZikaLayer) {
          var zikaLayerView = getLayerView(zikaLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.color = [1.0, 0.1, 0.1, 1.0];
          options.pointSize = 10.0;
          zikaLayer.draw(zikaLayerView, options);
        }

        // Draw Dengue Layer
        if (showDengueLayer) {
          var dengueLayerView = getLayerView(dengueLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.color = [0.2, 1.0, 0.1, 1.0];
          options.pointSize = 10.0;
          dengueLayer.draw(dengueLayerView, options);
        }

        // Draw Chiku Layer
        if (showChikuLayer) {
          var chikuLayerView = getLayerView(chikuLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.color = [0.1, 0.1, 1.0, 1.0];
          options.pointSize = 10.0;
          chikuLayer.draw(chikuLayerView, options);
        }

        // Draw Sea Level Rise Layer
        if (showSeaLevelRiseLayer) {
          var sea_level_heights = [
            [0.0, 0.0],
            [2.4, 0.7],
            [7.0, 2.1],
            [9.4, 2.9],
            [15, 4.7],
            [18, 5.6],
            [21, 6.4],
            [26, 7.9],
            [29, 8.9]
          ]; // [feet,meters]
          var feet = document.getElementById("slr-feet");
          var meters = document.getElementById("slr-meters");
          var degree = document.getElementById("slr-degree");
          var seaLevelRiseLayerView = getLayerView(seaLevelRiseLayer, landsatBaseMapLayer);
          var options = {};
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var start = parseFloat(times[0]);
          var end = parseFloat(times[times.length - 1]) + 0.5;
          var range = end - start;
          var current = ratio * range + start;
          options.currentC = Math.min(current, times[times.length - 1]);
          if (visibleBaseMapLayer == "landsat") {
            options.color = [0.1, 0.1, 0.1, 1.0];
          } else if (visibleBaseMapLayer == "light") {
            options.color = [0.4921875, 0.7421875, 0.91015625, 1.0];
          } else if (visibleBaseMapLayer == "dark") {
            options.color = [0.203125, 0.203125, 0.203125, 1.0];
          } else if (showLightsAtNightLayer || showLightsAtNight2012Layer || showLightsAtNight2016Layer) {
            options.color = [0.0, 0.0, 0.0, 1.0];
          }
          var currentIndex = 0;
          for (var i = 0; i < times.length; i++) {
            if (timelapse.getCurrentCaptureTime() == times[i]) {
              currentIndex = i;
            }
          }
          //feet.innerHTML = sea_level_heights[currentIndex][0] + "ft";
          if (sea_level_heights[currentIndex]) {
            meters.innerHTML = "+" + sea_level_heights[currentIndex][1].toFixed(1) + "m";
          }
          degree.innerHTML = (currentIndex / 2).toFixed(1);
          seaLevelRiseLayer.draw(seaLevelRiseLayerView, options);
        }

        if (showUrbanFragilityLayer) {
          var urbanFragilityLayerView = getLayerView(urbanFragilityLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();

          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          var year = currentDate.getUTCFullYear();
          options.year = year;
          options.delta = Math.min(delta, 1);
          urbanFragilityLayer.draw(urbanFragilityLayerView, options);

        }

        if (showGtdLayer) {
          var gtdLayerView = getLayerView(gtdLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [1.0, 0.0, 0.0, 1.0];
          gtdLayer.draw(gtdLayerView, options);
        }

        if (showUppsalaConflictLayer) {
          var uppsalaConflictLayerView = getLayerView(uppsalaConflictLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [1.0, 0.0, 0.0, 1.0];
          uppsalaConflictLayer.draw(uppsalaConflictLayerView, options);
        }

        if (showHivLayer) {
          var hivLayerView = getLayerView(hivLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();

          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          var year = currentDate.getUTCFullYear();
          options.year = year;
          options.delta = Math.min(delta, 1);
          hivLayer.draw(hivLayerView, options);
        }

        if (showObesityLayer) {
          var obesityLayerView = getLayerView(obesityLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();

          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          var year = currentDate.getUTCFullYear();
          options.year = year;
          options.delta = Math.min(delta, 1);
          obesityLayer.draw(obesityLayerView, options);
        }

        if (showVaccineConfidenceLayer) {
          var vaccineConfidenceLayerView = getLayerView(vaccineConfidenceLayer, landsatBaseMapLayer);
          var options = {};

          var vaccineConfidenceQuestion = 1.0;
          if ($("#show-vaccine-confidence-q2").prop('checked')) {
            vaccineConfidenceQuestion = 2.0;
          }
          if ($("#show-vaccine-confidence-q3").prop('checked')) {
            vaccineConfidenceQuestion = 3.0;
          }
          if ($("#show-vaccine-confidence-q4").prop('checked')) {
            vaccineConfidenceQuestion = 4.0;
          }
          options.question = vaccineConfidenceQuestion;
          vaccineConfidenceLayer.draw(vaccineConfidenceLayerView, options);

        }

        if (showEbolaDeathsLayer) {
          var ebolaLayerView = getLayerView(ebolaDeathsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [1.0, 0.0, 0.0, 1.0];
          options.pointSize = 2.5;
          ebolaDeathsLayer.draw(ebolaLayerView, options);
        }

        if (showEbolaCasesLayer) {
          var ebolaLayerView = getLayerView(ebolaCasesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [0.0, 1.0, 0.0, 1.0];
          options.pointSize = 2.5;
          ebolaCasesLayer.draw(ebolaLayerView, options);
        }

        if (showEbolaNewCasesLayer) {
          var ebolaLayerView = getLayerView(ebolaNewCasesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [0.0, 0.0, 1.0, 1.0];
          options.pointSize = 5.0;
          ebolaNewCasesLayer.draw(ebolaLayerView, options);
        }

        if (showLodesLayer) {

          var lodesLayerView = getLayerView(lodesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          options.se01 = lodesOptions.se01;
          options.se02 = lodesOptions.se02;
          options.se03 = lodesOptions.se03;

          options.filter = lodesOptions.filter;
          options.distance = lodesOptions.distance;

          if (lodesOptions.animate == 'animate') {
            var now = new Date();
            var deltaTime = now.getTime() - lodesAnimationState.then.getTime();
            var step = deltaTime/(lodesOptions.totalTime*lodesOptions.speed);
            if (lodesAnimationState.inMainLoop) {
              if (lodesOptions.doPulse) {
                if (lodesAnimationState.pulse) {
                  step = 1. - step;
                }
              } else if (lodesAnimationState.pulse) {
                lodesAnimationState.pulse = false;
              }

              if (deltaTime >= lodesOptions.totalTime*lodesOptions.speed) {
                lodesAnimationState.then = new Date();
                lodesAnimationState.inMainLoop = false;
                if (lodesOptions.doPulse && lodesAnimationState.pulse) {
                  lodesAnimationState.inStartDwell = true;
                } else {
                  lodesAnimationState.inEndDwell = true;
                }
              }
            }
            else if (lodesAnimationState.inStartDwell) {
              step = 0.;
              if (deltaTime >= lodesOptions.dwellTime) {
                lodesAnimationState.inStartDwell = false;
                lodesAnimationState.inMainLoop = true;
                lodesAnimationState.then = new Date();
                if (lodesOptions.doPulse) {
                  lodesAnimationState.pulse = false;
                }
              }
            }
            else {
              step = 1.;
              if (deltaTime >= lodesOptions.dwellTime) {
                lodesAnimationState.inEndDwell = false;
                lodesAnimationState.then = new Date();
                if (lodesOptions.doPulse) {
                  lodesAnimationState.inMainLoop = true;
                  lodesAnimationState.pulse = true;
                } else {
                  lodesAnimationState.inStartDwell = true;
                }
              }
            }
            step = Math.min(Math.max(step, 0.),1.);

          } else if (lodesOptions.animate == 'home'){
              step = 0.;
          } else {
            step = 1.;
          }

          options.step = step;

          var info = getLayerInfo(lodesLayer);
          var throttle = 1.0;
          if (info.zoomLevel >= 5 && info.mapLevel >= 5 && info.mapLevel < 11) {
            throttle = Math.min(1000000/info.pointCount, 1.0);
          }

          options.throttle = throttle;
          lodesLayer.draw(lodesLayerView, options);
        }

        // Show dotmaps loaded from spreadsheet
        for (var i = 0; i < dotmapLayers.length; i++) {
          var layer = dotmapLayers[i];
          if (layer.visible) {
            var view = getLayerView(layer, landsatBaseMapLayer);
            var options = {};
            options.zoom = timelapse.getCurrentZoom();

            // Throttle number of pixels if we're drawing "too many"
            var maxPoints = canvasLayer.canvas.width * canvasLayer.canvas.height;
            var info = getLayerInfo(layer);
            var drawFraction = 0.125;
            drawFraction = Math.min(maxPoints/info.pointCount, 1.0);

            options.throttle = drawFraction;
            layer.draw(view, options);
          }
        }

        if (showCumulativeActiveMiningLayer) {
          var cumulativeActiveMiningLayerView = getLayerView(cumulativeActiveMiningLayer, landsatBaseMapLayer);
          var options = {};
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var start = parseFloat(times[0]);
          var end = parseFloat(times[times.length - 1]) + 0.5;
          var range = end - start;
          var current = ratio * range + start;
          var currentIndex = 0;
          for (var i = 0; i < times.length; i++) {
            if (timelapse.getCurrentCaptureTime() == times[i]) {
              currentIndex = i;
            }
          }
          var colorRamp = {
            "1984": [255,255,255],
            "1985": [255,255,204],
            "1986": [250,246,198],
            "1987": [246,238,192],
            "1988": [242,229,187],
            "1989": [238,221,181],
            "1990": [233,212,176],
            "1991": [229,204,170],
            "1992": [225,195,165],
            "1993": [221,187,159],
            "1994": [216,178,154],
            "1995": [212,170,148],
            "1996": [208,161,143],
            "1997": [204,153,137],
            "1998": [199,144,132],
            "1999": [195,136,126],
            "2000": [191,127,121],
            "2001": [187,119,115],
            "2002": [183,110,109],
            "2003": [178,102,104],
            "2004": [174,93,98],
            "2005": [170,85,93],
            "2006": [166,76,87],
            "2007": [161,68,82],
            "2008": [157,59,76],
            "2009": [153,51,71],
            "2010": [149,42,65],
            "2011": [144,34,60],
            "2012": [140,25,54],
            "2013": [136,17,49],
            "2014": [132,8,43],
            "2015": [128,0,38],
            "2016": [128,0,0]
          }

          var currentBValue = colorRamp[times[currentIndex]][2]/255;
          options.currentBValue = currentBValue;
          cumulativeActiveMiningLayer.draw(cumulativeActiveMiningLayerView, options);
        }

        // ## 7 ##
        //// Layers to draw on top go here
        //
        for (var i = 0; i < csvFileLayers.layers.length; i++) {
          var layer = csvFileLayers.layers[i];
          if (layer.visible) {
            var view = getLayerView(layer, landsatBaseMapLayer);
            var options = {};
            options.zoom = timelapse.getCurrentZoom();
            var currentTime = timelapse.getCurrentTime();
            var currentTimes = getCurrentTimes(timelapse);
            var dates = getDates(timelapse);
            var delta = getCurrentTimesDelta(currentTime, currentTimes);
            var currentDate = getCurrentDate(currentTime, currentTimes, dates);
            options.currentTime = currentDate;
            options.pointSize = 500.;
            layer.draw(view, options);
          }
        }

        if (showIomIdpLayer) {
          var iomIdpLayerView = getLayerView(iomIdpLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.epoch = currentDate.getTime()/1000.;
          options.pointSize = 4.0;
          options.showIrqIdps = iomIdpLayer.options['showIrqIdps'];
          options.showSyrIdps = iomIdpLayer.options['showSyrIdps'];
          options.showYemIdps = iomIdpLayer.options['showYemIdps'];
          options.showLbyIdps = iomIdpLayer.options['showLbyIdps'];
          options.showIrqReturns = iomIdpLayer.options['showIrqReturns'];
          options.showSyrReturns = iomIdpLayer.options['showSyrReturns'];
          options.showYemReturns = iomIdpLayer.options['showYemReturns'];
          options.showLbyReturns = iomIdpLayer.options['showLbyReturns'];
          iomIdpLayer.draw(iomIdpLayerView, options);
        }

        if (showBerkeleyEarthTemperatureAnomalyTimeMachineLayer) {
          var view = getLayerView(berkeleyEarthTemperatureAnomalyTimeMachineLayer, landsatBaseMapLayer);
          berkeleyEarthTemperatureAnomalyTimeMachineLayer.draw(view, tileViewVisibility);


          var landBorderView = getLayerView(landBorderLayer, landsatBaseMapLayer);
          landBorderLayer.draw(landBorderView);
        }

        if (showOmiNo2Layer) {
          var view = getLayerView(omiNo2Layer, landsatBaseMapLayer);
          omiNo2Layer.draw(view, tileViewVisibility);
        }

        if (showBePm25Layer) {
          var view = getLayerView(bePm25Layer, landsatBaseMapLayer);
          bePm25Layer.draw(view, tileViewVisibility);
        }

        if (showChinaAviationLayer) {
          var chinaAviationLayerView = getLayerView(chinaAviationLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 5 * window.devicePixelRatio;
          options.color = [1.0, 0.0, 0.0, 1.0];
          chinaAviationLayer.draw(chinaAviationLayerView, options);
        }

        if (showChinaPowerPlantsLayer) {
          var chinaPowerPlantsLayerView = getLayerView(chinaPowerPlantsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 5 * window.devicePixelRatio;
          options.color = [0.0, 1.0, 0.0, 1.0];
          chinaPowerPlantsLayer.draw(chinaPowerPlantsLayerView, options);
        }

        if (showChinaReservoirsLayer) {
          var chinaReservoirsLayerView = getLayerView(chinaReservoirsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 5 * window.devicePixelRatio;
          options.color = [0.0, 0.0, 1.0, 1.0];
          chinaReservoirsLayer.draw(chinaReservoirsLayerView, options);
        }

        if (showChinaWasteTreatmentPlantsLayer) {
          var chinaWasteTreatmentPlantsLayerView = getLayerView(chinaWasteTreatmentPlantsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 5 * window.devicePixelRatio;
          options.color = [1.0, 0.5, 0.15, 1.0];
          chinaWasteTreatmentPlantsLayer.draw(chinaWasteTreatmentPlantsLayerView, options);
        }

      }
    }
  </script>

  <script>
    "use strict";
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    // Write to local storage since cookies cannot be used on file://
    // allowLinker is for crossdomain (the tracking domain is different from where we are sending from)
    ga('create', trackingId, 'auto', {
      'allowLinker': true,
      'storage': 'none',
      'clientId': localStorage.getItem('gaClientId')
    });
    ga(function(t) {
      localStorage.setItem('gaClientId', t.get('clientId'));
    });
    ga('set', 'checkProtocolTask', null); // Disable file protocol checking.
    ga('send', 'pageview');
  </script>
</head>

<body>
  <div id="content">
    <div id="letterbox-top"></div>
    <div id="letterbox-middle"></div>
    <div id="letterbox-bottom"></div>
  </div>
  <div id="timeMachine"></div>
  <div class="current-location-text">
    <h3></h3>
    <p></p>
    <img id="current-location-text-picture" src="">
  </div>
  <div id="extras-content" title=""></div>
  <div id="presentation-slider-selection">
    <table>
      <tr>
        <td style="color: white; padding-left: 5px !important"><div>Jump To:</div></td>
      </tr>
    </table>
  </div>
</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
  <title>EarthTime</title>
  <meta name="keywords" content="Earth Time,EarthTime,Earth Timelapse,EarthTimelapse,Global Situation Space,Climate">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no" />

  <link href="../../timemachine/css/snaplapse.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/defaultUI.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/contextMap.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/scaleBar.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/customUI.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/css/leaflet/leaflet.css" rel="stylesheet" type="text/css" />
  <link href="../../timemachine/libs/change-detect/css/change.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="../../js/customVideoTagControls/customVideoTagControls.css" rel="stylesheet" type="text/css" />
  <link href="../../css/jquery.multiselect.css" rel="stylesheet" type="text/css" />
  <link href="index.css" rel="stylesheet" type="text/css" />

  <script src="../../timemachine/js/jquery/jquery.min.js" type="text/javascript"></script>
  <script src="../../timemachine/js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
  <script src="../../timemachine/js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
  <script src="../../timemachine/js/jquery/plugins/dialogExtend/jquery.dialogextend.min.js" type="text/javascript"></script>

  <script src="../../timemachine/js/org/gigapan/util.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
  <script src="../../timemachine/js/Math.uuid.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/scaleBar.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/contextMap.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/customUI.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>
  <script src="../../timemachine/template_includes.js" type="text/javascript"></script>
  <script src="../../timemachine/js/leaflet/leaflet.min.js" type="text/javascript"></script>

  <script src="../../timemachine/libs/change-detect/js/ThumbnailServiceAPI.js" type="text/javascript"></script>
  <script src="../../timemachine/libs/change-detect/js/TimeMachineCanvasLayer.js" type="text/javascript"></script>
  <script src="../../timemachine/libs/change-detect/js/ThumbnailTool.js" type="text/javascript"></script>
  <script src="../../timemachine/libs/change-detect/js/BoxEventHandler.js" type="text/javascript"></script>
  <script src="../../timemachine/libs/change-detect/js/ChangeDetectionTool.js" type="text/javascript"></script>

  <script src="../../timemachine/js/org/gigapan/postmessage.js" type="text/javascript"></script>
  <script src="../../timemachine/js/org/gigapan/timelapse/crossdomain_api.js" type="text/javascript"></script>

  <script src="../../js/customVideoTagControls/customVideoTagControls.js" type="text/javascript"></script>
  <script src="../../js/jquery.multiselect.js" type="text/javascript"></script>
  <script src="../../js/earcut.min.js" type="text/javascript"></script>
  <script src="../../js/dat.gui.min.js"></script>
  <script src="../../js/papaparse.min.js"></script>
  <script src="../../js/d3.min.js"></script>
  <script src="earthtime.js"></script>
  <script src="../../js/promise.min.js"></script>
  <script src="../../js/gl-matrix-min.js"></script>
  <script src="config-local.js" type="text/javascript"></script>
  <script src="../../../../config.js" type="text/javascript"></script>

  <script src="timestamps_ajax_includes.js" type="text/javascript"></script>

  <script src="TileIdx.js"></script>
  <script src="WebglVideoTile.js"></script>
  <script src="TileView.js"></script>
  <script src="Glb.js"></script>
  <script src="WebglTimeMachineLayer.js"></script>
  <script src="WebglMapLayer.js"></script>
  <script src="WebglVectorLayer2.js"></script>
  <script src="WebGLVectorTile2.js"></script>
  <script src="WebglMapTile.js"></script>
  <script src="WebglMapTile2.js"></script>
  <script src="WebglMapLayer2.js"></script>
  <script src="CarbonPriceRisk.js"></script>
  <script src="gapminder.json"></script>
  <script src="perf.js"></script>
  <script src="../../js/utils.js"></script>
  <script src="../../js/download.min.js"></script>

  <script type="text/javascript">
    "use strict";

    jQuery.support.cors = true;
    var UTIL = org.gigapan.Util;

    var isMobileDevice = UTIL.isMobileDevice();
    var isBrowserSupported = UTIL.browserSupported();
    var isIE = UTIL.isIE();
    var isIEButNotEdge = isIE && !UTIL.isIEEdge();

    //
    //// Config ////
    //

    var EARTH_TIMELAPSE_CONFIG = EARTH_TIMELAPSE_CONFIG || {};
    var enableStoryMode = !!EARTH_TIMELAPSE_CONFIG.enableStoryMode;
    // Deprecated. Instead use waypointSliderContentPath, which points to an online or exported spreadsheet.
    var waypointCollection = EARTH_TIMELAPSE_CONFIG.waypointCollection;
    var waypointSliderContentPath = EARTH_TIMELAPSE_CONFIG.waypointSliderContentPath || "default-waypoints.tsv";
    var dotmapsContentPath;
    if (typeof(EARTH_TIMELAPSE_CONFIG.dotmapsContentPath) === "undefined") {
      dotmapsContentPath = "1rCiksJv4aXi1usI0_9zdl4v5vuOfiHgMRidiDPt1WfE.358696896";
    } else if (EARTH_TIMELAPSE_CONFIG.dotmapsContentPath === "") {
      dotmapsContentPath = "default-dotmaps.tsv";
    } else {
      dotmapsContentPath =  EARTH_TIMELAPSE_CONFIG.dotmapsContentPath;
    }
    var csvLayersContentPath;
    if (typeof(EARTH_TIMELAPSE_CONFIG.csvLayersContentPath) === "undefined") {
      csvLayersContentPath = "1rCiksJv4aXi1usI0_9zdl4v5vuOfiHgMRidiDPt1WfE.870361385";
    } else if (EARTH_TIMELAPSE_CONFIG.csvLayersContentPath === "") {
      csvLayersContentPath = "default-csvlayers.tsv";
    } else {
      csvLayersContentPath =  EARTH_TIMELAPSE_CONFIG.csvLayersContentPath;
    }
    // Local Storage
    if (typeof(Storage) !== "undefined") {
      if (localStorage.waypointSliderContentPath) {
        waypointSliderContentPath = localStorage.waypointSliderContentPath;
      }
      if (localStorage.dotmapsContentPath) {
        dotmapsContentPath = localStorage.dotmapsContentPath;
      }
      if (localStorage.csvLayersContentPath) {
        csvLayersContentPath = localStorage.csvLayersContentPath;
      }
    }
    var useUrbanFragilityWaypoints = window.location.hash.split("useUrbanFragilityWaypoints=")[1];
    if (useUrbanFragilityWaypoints === "true")
      waypointSliderContentPath = "https://docs.google.com/spreadsheets/d/1hFpDXOyjvjTpad7HpB0K-3thuYqSOlDJ4oExCTcscUk/edit#gid=1757433978";
    var googleMapsAPIKey = EARTH_TIMELAPSE_CONFIG.googleMapsAPIKey;

    var showExtrasMenu = typeof(EARTH_TIMELAPSE_CONFIG.showExtrasMenu) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showExtrasMenu;
    var showFullScreenButton = typeof(EARTH_TIMELAPSE_CONFIG.showFullScreenButton) === "undefined" ? false : !!EARTH_TIMELAPSE_CONFIG.showFullScreenButton;
    var showThumbnailTool = typeof(EARTH_TIMELAPSE_CONFIG.showThumbnailTool) === "undefined" ? false : !!EARTH_TIMELAPSE_CONFIG.showThumbnailTool;
    var showEVA = !!EARTH_TIMELAPSE_CONFIG.showEVA;
    var showGFW = !!EARTH_TIMELAPSE_CONFIG.showGFW;
    var showLodes = !!EARTH_TIMELAPSE_CONFIG.showLodes;
    var showCustomDotmaps = typeof(EARTH_TIMELAPSE_CONFIG.showCustomDotmaps) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showCustomDotmaps;
    var showCsvLayers = !!EARTH_TIMELAPSE_CONFIG.showCsvLayers;
    var showForestAlerts = !!EARTH_TIMELAPSE_CONFIG.showForestAlerts;
    var showCoral = typeof(EARTH_TIMELAPSE_CONFIG.showCoral) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showCoral;
    var showCoralBleaching = typeof(EARTH_TIMELAPSE_CONFIG.showCoralBleaching) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showCoralBleaching;
    var showHimawari8 = typeof(EARTH_TIMELAPSE_CONFIG.showHimawari8) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showHimawari8;
    var showUSDrilling = typeof(EARTH_TIMELAPSE_CONFIG.showUSDrilling) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showUSDrilling;
    var showViirs = typeof(EARTH_TIMELAPSE_CONFIG.showViirs) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showViirs;
    var showMonthlyRefugees = !!EARTH_TIMELAPSE_CONFIG.showMonthlyRefugees;
    var showAnnualRefugees = !!EARTH_TIMELAPSE_CONFIG.showAnnualRefugees;
    var subsampleAnnualRefugees = !!EARTH_TIMELAPSE_CONFIG.subsampleAnnualRefugees;
    var subsampleAnnualReturns = !!EARTH_TIMELAPSE_CONFIG.subsampleAnnualReturns;
    var showAnnualReturns = !!EARTH_TIMELAPSE_CONFIG.showAnnualReturns;
    var showGlobalWindPower = !!EARTH_TIMELAPSE_CONFIG.showGlobalWindPower;
    var showVsi = !!EARTH_TIMELAPSE_CONFIG.showVsi;
    var showHealthImpact = !!EARTH_TIMELAPSE_CONFIG.showHealthImpact;
    var showZika = !!EARTH_TIMELAPSE_CONFIG.showZika;
    var showDengue = !!EARTH_TIMELAPSE_CONFIG.showDengue;
    var showChiku = !!EARTH_TIMELAPSE_CONFIG.showChiku;
    var showSeaLevelRise = !!EARTH_TIMELAPSE_CONFIG.showSeaLevelRise;
    var showUrbanFragility = !!EARTH_TIMELAPSE_CONFIG.showUrbanFragility;
    var showGtd = !!EARTH_TIMELAPSE_CONFIG.showGtd;
    var showHiv = !!EARTH_TIMELAPSE_CONFIG.showHiv;
    var showObesity = !!EARTH_TIMELAPSE_CONFIG.showObesity;
    var showVaccineConfidence = !!EARTH_TIMELAPSE_CONFIG.showVaccineConfidence;
    var showNdviAnomaly = !!EARTH_TIMELAPSE_CONFIG.showNdviAnomaly;
    var showEbola = !!EARTH_TIMELAPSE_CONFIG.showEbola;
    var showWaterOccurrence = !!EARTH_TIMELAPSE_CONFIG.showWaterOccurrence;
    var showWaterChange = !!EARTH_TIMELAPSE_CONFIG.showWaterChange;
    var showSeaLevelRise = !!EARTH_TIMELAPSE_CONFIG.showSeaLevelRise;
    var showCumulativeActiveMining = !!EARTH_TIMELAPSE_CONFIG.showCumulativeActiveMining;
    var showIomIdp = !!EARTH_TIMELAPSE_CONFIG.showIomIdp;
    var showBerkeleyEarthTemperatureAnomaly = !!EARTH_TIMELAPSE_CONFIG.showBerkeleyEarthTemperatureAnomaly;
    var showUppsalaConflict = !!EARTH_TIMELAPSE_CONFIG.showUppsalaConflict;
    var showLightsAtNight = typeof(EARTH_TIMELAPSE_CONFIG.showLightsAtNight) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showLightsAtNight;
    var showLightsAtNight2012 = !!EARTH_TIMELAPSE_CONFIG.showLightsAtNight2012;
    var showLightsAtNight2016 = !!EARTH_TIMELAPSE_CONFIG.showLightsAtNight2016;
    var showOmiNo2 = !!EARTH_TIMELAPSE_CONFIG.showOmiNo2;
    var showChinaInfrastructure = !!EARTH_TIMELAPSE_CONFIG.showChinaInfrastructure;
    var showBePm25 = !!EARTH_TIMELAPSE_CONFIG.showBePm25;
    var showExpandingCities = !!EARTH_TIMELAPSE_CONFIG.showExpandingCities;
    var showIrena = !!EARTH_TIMELAPSE_CONFIG.showIrena;
    var showCarbonPriceRisk = !!EARTH_TIMELAPSE_CONFIG.showCarbonPriceRisk;
    var showCityLabelMap = !!EARTH_TIMELAPSE_CONFIG.showCityLabelMap;
    var showTsip = !!EARTH_TIMELAPSE_CONFIG.showTsip;
    var showSpCrude = !!EARTH_TIMELAPSE_CONFIG.showSpCrude;
    var showGoes16 = !!EARTH_TIMELAPSE_CONFIG.showGoes16;
    var showDscovr = !!EARTH_TIMELAPSE_CONFIG.showDscovr;
    var showAnnualGlobalPm25 = !!EARTH_TIMELAPSE_CONFIG.showAnnualGlobalPm25;

    var showTile = true;

    var usePresentationClicker = !!EARTH_TIMELAPSE_CONFIG.usePresentationClicker;
    var enableThemeHamburgerButton = !!EARTH_TIMELAPSE_CONFIG.enableThemeHamburgerButton;
    var minimalUI = window.location.hash.split("minimalUI=")[1] || !!EARTH_TIMELAPSE_CONFIG.minimalUI;
    var disableUI = window.location.hash.split("disableUI=")[1] || !!EARTH_TIMELAPSE_CONFIG.disableUI;
    var disablePresentationSlider = window.location.hash.split("disablePresentationSlider=")[1] || !!EARTH_TIMELAPSE_CONFIG.disablePresentationSlider || false;
    if (disableUI)
      disablePresentationSlider = true;
    var extraContributors = EARTH_TIMELAPSE_CONFIG.extraContributors ? EARTH_TIMELAPSE_CONFIG.extraContributors.replace(",", " |") : "";
    var showShareButton = typeof(EARTH_TIMELAPSE_CONFIG.showShareButton) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showShareButton;
    var showShareButtonHash = window.location.hash.split("showShareButton=")[1];
    if (showShareButtonHash)
      showShareButton = showShareButtonHash === "true";
    var showSettingsButton = isMobileDevice ? false : (typeof(EARTH_TIMELAPSE_CONFIG.showSettingsButton) === "undefined" ? true : !!EARTH_TIMELAPSE_CONFIG.showSettingsButton);
    var isHyperwall = !!EARTH_TIMELAPSE_CONFIG.isHyperwall;
    var useGoogleMaps = !!EARTH_TIMELAPSE_CONFIG.useGoogleMaps;
    var useGoogleSearch = (typeof(EARTH_TIMELAPSE_CONFIG.useGoogleSearch) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useGoogleSearch;
    var enableAutoMode = !!EARTH_TIMELAPSE_CONFIG.enableAutoMode;
    var screenTimeoutInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.screenTimeoutInMilliseconds) || 8 * 60 * 1000;
    var waypointDelayInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.waypointDelayInMilliseconds) || 1 * 15 * 1000;
    var defaultPlaybackSpeed = parseFloat(EARTH_TIMELAPSE_CONFIG.defaultPlaybackSpeed) || 0.5;
    var enableLetterboxMode = !!EARTH_TIMELAPSE_CONFIG.enableLetterboxMode;
    var letterboxBottomOffset = parseInt(EARTH_TIMELAPSE_CONFIG.letterboxBottomOffset) || 312;
    var letterboxModeHash = window.location.hash.split("enableLetterboxMode=")[1];
    if (letterboxModeHash)
      enableLetterboxMode = letterboxModeHash === "true";
    var landsatVersion = EARTH_TIMELAPSE_CONFIG.landsatVersion || "2015";
    var useFaderShader = (typeof(EARTH_TIMELAPSE_CONFIG.useFaderShader) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useFaderShader;
    var enableWaypointText = (typeof(EARTH_TIMELAPSE_CONFIG.enableWaypointText) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.enableWaypointText;
    var trackingId = EARTH_TIMELAPSE_CONFIG.trackingId || "UA-10682694-21";
    var rootTilePath = (typeof(EARTH_TIMELAPSE_CONFIG.rootTilePath) == "undefined") ? "../../../data/" : EARTH_TIMELAPSE_CONFIG.rootTilePath;
    var autoModeFullThemeCycle = (typeof(EARTH_TIMELAPSE_CONFIG.autoModeFullThemeCycle) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.autoModeFullThemeCycle;

    // TODO: Until we decide to force everyone to latest landsat, pull the version corresponding to the config above.
    if (landsatVersion == "2015"){
      var cachedLandsatTimeJsonPath = "landsat-times.json";
      var landsatAjaxIncludesPath = "landsat_ajax_includes.js";
    } else {
      var cachedLandsatTimeJsonPath = "landsat-times-2016.json";
      var landsatAjaxIncludesPath = "landsat_ajax_includes_2016.js";
      if (isMobileDevice || isIEButNotEdge) {
        landsatAjaxIncludesPath = "https://earthengine.google.com/timelapse/data/20161025/ajax_includes.js";
      }
    }

    // TODO:
    // We start crashing phones with a ratio > 1 and in general retina is
    // quite taxing for our videos and layers, so force it pixelRatio to 1.
    if (!isIE) {
      window.devicePixelRatio = 1;
    }

    var NORTH = 85.05113006405742; // Latitude for Northern most extent
    var landsatMaxScale = (landsatVersion == "2015") ? 1.25 : 0.45;
    landsatMaxScale -= (window.devicePixelRatio > 1) * 0.21;
    var rasterMapTileMaxScale = 80 * landsatMaxScale;
    var himawariMaxScale = 0.02;
    var goes16MaxScale = 0.017;
    var dscovrMaxScale = 0.004;
    var isAutoModeRunning = false;
    var visibleBaseMapLayer = "landsat";
    var previousVisibleBaseMapLayer = "landsat";
    WebglVideoTile.useFaderShader = useFaderShader;
    var timelapse, snaplapseViewerForPresentationSlider, previousWaypoint = {}, waypointViewChangeListener, hideWaypointListener, waypointTimeChangeListenerInterval, snaplapseForPresentationSlider;
    var currentWaypointTheme;
    var himawariWaypoints = {};
    var annotationPicturePaths = {};
    var timelineType = "customUI";
    var activeLayersWithTimeline = 0;
    var timelineHidden = false;
    var previousActiveLayersWithTimeline = 0;
    var lastAutomodeWaypointIndex = 0;
    var keysDown = [];
    var $lastSelectedExtra;
    var loadedInitialWaypointList = false;
    var loadedInitialCsvLayers = false;
    var timeInMsSinceLastWaypointLoop = 0;
    var $nextAnnotationLocationButton;
    var $previousAnnotationLocationButton;
    var timelapseWasPlaying = false;
    var lastLayerMenuScrollPos = 0;
    var $lastActiveLayerTopic = $();
    var lastActiveLayers = [];
    var maxCachedLayers = 8;
    var lastSelectedAnnotationBeforeHidden;

    // This is necessary because waypoint thumbnails are generated from the Landsat set and thus the best we can show is just a solid black thumbnail
    // instead of some random location that a himawari bounds corresponds to in Landsat.
    var himawariWaypointThumbnailBounds = {
      xmax: 1818264.731953845,
      xmin: 1746298.8849333557,
      ymax: 1253113.3077389232,
      ymin: 1218442.2616483232
    };


    // ## 1 ##
    //
    //// Layer variables ////
    //

    var forestAlertsTimeMachineLayer, forestAlertsNoOverlayTimeMachineLayer, landsatBaseMapLayer, darkBaseMapLayer, lightBaseMapLayer, mcrmVectorLayer, countryLabelMapLayer, cityLabelMapLayer;
    var hansenMapLayer, hansenMapLayer2, lightsAtNightMapLayer, lightsAtNight2012MapLayer, lightsAtNight2016MapLayer, crwTimeMachineLayer, animatedHansenLayer, himawariTimeMachineLayer, ndviAnomalyTimeMachineLayer;
    var waterOccurrenceLayer, waterChangeLayer, usgsWindTurbineLayer, solarInstallsLayer, drillingLayer;
    var goes16TimeMachineLayer, dscovrTimeMachineLayer, annualGlobalPm25TimeMachineLayer;
    var globalWindPowerLayer;
    var annualRefugeesLayer;
    var annualReturnsLayer;
    var vsiLayer;
    var healthImpactLayer;
    var zikaLayer, dengueLayer, chikuLayer;
    var viirsLayer;
    var wdpaLayer;
    var seaLevelRiseLayer;
    var urbanFragilityLayer;
    var coralBleachingLayer;
    var monthlyRefugeesLayer;
    var gtdLayer;
    var hivLayer;
    var obesityLayer;
    var vaccineConfidenceLayer;
    var ebolaDeathsLayer;
    var ebolaCasesLayer;
    var ebolaNewCasesLayer;
    var lodesLayer;
    var cumulativeActiveMiningLayer;
    var iomIdpLayer;
    var berkeleyEarthTemperatureAnomalyTimeMachineLayer;
    var landBorderLayer;
    var uppsalaConflictLayer;
    var omiNo2Layer;
    var chinaAviationLayer;
    var chinaPowerPlantsLayer;
    var chinaReservoirsLayer;
    setTimeLine('china-reservoirs-times', 1950, 2012, 1);
    var chinaWasteTreatmentPlantsLayer;
    var bePm25Layer;
    var expandingCitiesLayer;
    setTimeLine('expanding-cities-times', 1955, 2030, 5);
    var irenaSolarLayer;
    setTimeLine('irena-solar-times', 2000, 2016, 1);
    var irenaWindLayer;
    setTimeLine('irena-wind-times', 2000, 2016, 1);
    var carbonPriceRiskLayer;
    setTimeLine('carbon-price-risk-times', 2017, 2050, 1);
    var tsipLayer;
    setTimeLine('tsip-times', 2000, 2017, 1);

    // S&P Shipping
    var spCrudeLayer;
    setTimeLine('sp-crude-times', 2013, 2018, 1);

    var spCrudeLayerOceania;
    var spCrudeLayerAG;
    var spCrudeLayerWAF;
    var spCrudeLayerMedNAF;
    var spCrudeLayerUrals;
    var spCrudeLayerUSGC;
    var spCrudeLayerLatAM;
    var spCrudeLayerNS;

/*    var spCrudeLayerWAF;
    setTimeLine('sp-crude-times', 2013, 2018, 1);

    var spCrudeLayerNAF;
    setTimeLine('sp-crude-times', 2013, 2018, 1);
    var spCrudeLayerME;
    setTimeLine('sp-crude-times', 2013, 2018, 1);
    var spCrudeLayerUS;
    setTimeLine('sp-crude-us-times', 2016, 2018, 1);
*/
    var  shipsWorker = new Worker('ships-worker.js');
    shipsWorker.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        //spCrudeLayer.setBuffer(idx, new Float32Array(array));
        var data = new Float32Array(array);
        spCrudeLayer.buffers[idx].count = data.length / spCrudeLayer.buffers[idx].numAttributes;
        spCrudeLayer.buffers[idx].buffer = spCrudeLayer.gl.createBuffer();
        spCrudeLayer.gl.bindBuffer(spCrudeLayer.gl.ARRAY_BUFFER, spCrudeLayer.buffers[idx].buffer);
        gl.bufferData(spCrudeLayer.gl.ARRAY_BUFFER, data, spCrudeLayer.gl.STATIC_DRAW);
        spCrudeLayer.buffers[idx].ready = true;
      }
    };

    var shipsWorkerOceania = new Worker('ships-worker.js');
    shipsWorkerOceania.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        var data = new Float32Array(array);
        spCrudeLayerOceania.buffers[idx].count = data.length / spCrudeLayerOceania.buffers[idx].numAttributes;
        spCrudeLayerOceania.buffers[idx].buffer = spCrudeLayerOceania.gl.createBuffer();
        spCrudeLayerOceania.gl.bindBuffer(spCrudeLayerOceania.gl.ARRAY_BUFFER, spCrudeLayerOceania.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerOceania.gl.ARRAY_BUFFER, data, spCrudeLayerOceania.gl.STATIC_DRAW);
        spCrudeLayerOceania.buffers[idx].ready = true;
      }
    };
    var shipsWorkerAG = new Worker('ships-worker.js');
    shipsWorkerAG.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        var data = new Float32Array(array);
        spCrudeLayerAG.buffers[idx].count = data.length / spCrudeLayerAG.buffers[idx].numAttributes;
        spCrudeLayerAG.buffers[idx].buffer = spCrudeLayerAG.gl.createBuffer();
        spCrudeLayerAG.gl.bindBuffer(spCrudeLayerAG.gl.ARRAY_BUFFER, spCrudeLayerAG.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerAG.gl.ARRAY_BUFFER, data, spCrudeLayerAG.gl.STATIC_DRAW);
        spCrudeLayerAG.buffers[idx].ready = true;
      }
    };
    var shipsWorkerWAF = new Worker('ships-worker.js');
    shipsWorkerWAF.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        var data = new Float32Array(array);
        spCrudeLayerWAF.buffers[idx].count = data.length / spCrudeLayerWAF.buffers[idx].numAttributes;
        spCrudeLayerWAF.buffers[idx].buffer = spCrudeLayerWAF.gl.createBuffer();
        spCrudeLayerWAF.gl.bindBuffer(spCrudeLayerWAF.gl.ARRAY_BUFFER, spCrudeLayerWAF.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerWAF.gl.ARRAY_BUFFER, data, spCrudeLayerWAF.gl.STATIC_DRAW);
        spCrudeLayerWAF.buffers[idx].ready = true;
      }
    };
    var shipsWorkerMedNAF = new Worker('ships-worker.js');
    shipsWorkerMedNAF.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        var data = new Float32Array(array);
        spCrudeLayerMedNAF.buffers[idx].count = data.length / spCrudeLayerMedNAF.buffers[idx].numAttributes;
        spCrudeLayerMedNAF.buffers[idx].buffer = spCrudeLayerMedNAF.gl.createBuffer();
        spCrudeLayerMedNAF.gl.bindBuffer(spCrudeLayerMedNAF.gl.ARRAY_BUFFER, spCrudeLayerMedNAF.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerMedNAF.gl.ARRAY_BUFFER, data, spCrudeLayerMedNAF.gl.STATIC_DRAW);
        spCrudeLayerMedNAF.buffers[idx].ready = true;
      }
    };
    var shipsWorkerUrals = new Worker('ships-worker.js');
    shipsWorkerUrals.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        var data = new Float32Array(array);
        spCrudeLayerUrals.buffers[idx].count = data.length / spCrudeLayerUrals.buffers[idx].numAttributes;
        spCrudeLayerUrals.buffers[idx].buffer = spCrudeLayerUrals.gl.createBuffer();
        spCrudeLayerUrals.gl.bindBuffer(spCrudeLayerUrals.gl.ARRAY_BUFFER, spCrudeLayerUrals.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerUrals.gl.ARRAY_BUFFER, data, spCrudeLayerUrals.gl.STATIC_DRAW);
        spCrudeLayerUrals.buffers[idx].ready = true;
      }
    };
    var shipsWorkerUSGC = new Worker('ships-worker.js');
    shipsWorkerUSGC.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        var data = new Float32Array(array);
        spCrudeLayerUSGC.buffers[idx].count = data.length / spCrudeLayerUSGC.buffers[idx].numAttributes;
        spCrudeLayerUSGC.buffers[idx].buffer = spCrudeLayerUSGC.gl.createBuffer();
        spCrudeLayerUSGC.gl.bindBuffer(spCrudeLayerUSGC.gl.ARRAY_BUFFER, spCrudeLayerUSGC.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerUSGC.gl.ARRAY_BUFFER, data, spCrudeLayerUSGC.gl.STATIC_DRAW);
        spCrudeLayerUSGC.buffers[idx].ready = true;
      }
    };
    var shipsWorkerLatAM = new Worker('ships-worker.js');
    shipsWorkerLatAM.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        var data = new Float32Array(array);
        spCrudeLayerLatAM.buffers[idx].count = data.length / spCrudeLayerLatAM.buffers[idx].numAttributes;
        spCrudeLayerLatAM.buffers[idx].buffer = spCrudeLayerLatAM.gl.createBuffer();
        spCrudeLayerLatAM.gl.bindBuffer(spCrudeLayerLatAM.gl.ARRAY_BUFFER, spCrudeLayerLatAM.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerLatAM.gl.ARRAY_BUFFER, data, spCrudeLayerLatAM.gl.STATIC_DRAW);
        spCrudeLayerLatAM.buffers[idx].ready = true;
      }
    };
    var shipsWorkerNS = new Worker('ships-worker.js');
    shipsWorkerNS.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        var data = new Float32Array(array);
        spCrudeLayerNS.buffers[idx].count = data.length / spCrudeLayerNS.buffers[idx].numAttributes;
        spCrudeLayerNS.buffers[idx].buffer = spCrudeLayerNS.gl.createBuffer();
        spCrudeLayerNS.gl.bindBuffer(spCrudeLayerNS.gl.ARRAY_BUFFER, spCrudeLayerNS.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerNS.gl.ARRAY_BUFFER, data, spCrudeLayerNS.gl.STATIC_DRAW);
        spCrudeLayerNS.buffers[idx].ready = true;
      }
    };

/*
    var shipsWorkerWAF = new Worker('ships-worker.js');
    shipsWorkerWAF.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        //spCrudeLayer.setBuffer(idx, new Float32Array(array));
        var data = new Float32Array(array);
        spCrudeLayerWAF.buffers[idx].count = data.length / spCrudeLayerWAF.buffers[idx].numAttributes;
        spCrudeLayerWAF.buffers[idx].buffer = spCrudeLayerWAF.gl.createBuffer();
        spCrudeLayerWAF.gl.bindBuffer(spCrudeLayerWAF.gl.ARRAY_BUFFER, spCrudeLayerWAF.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerWAF.gl.ARRAY_BUFFER, data, spCrudeLayerWAF.gl.STATIC_DRAW);
        spCrudeLayerWAF.buffers[idx].ready = true;
      }
    };

    var shipsWorkerNAF = new Worker('ships-worker.js');
    shipsWorkerNAF.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        //spCrudeLayer.setBuffer(idx, new Float32Array(array));
        var data = new Float32Array(array);
        spCrudeLayerNAF.buffers[idx].count = data.length / spCrudeLayerNAF.buffers[idx].numAttributes;
        spCrudeLayerNAF.buffers[idx].buffer = spCrudeLayerNAF.gl.createBuffer();
        spCrudeLayerNAF.gl.bindBuffer(spCrudeLayerNAF.gl.ARRAY_BUFFER, spCrudeLayerNAF.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerNAF.gl.ARRAY_BUFFER, data, spCrudeLayerNAF.gl.STATIC_DRAW);
        spCrudeLayerNAF.buffers[idx].ready = true;
      }
    };

    var shipsWorkerME = new Worker('ships-worker.js');
    shipsWorkerME.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        //spCrudeLayer.setBuffer(idx, new Float32Array(array));
        var data = new Float32Array(array);
        spCrudeLayerME.buffers[idx].count = data.length / spCrudeLayerME.buffers[idx].numAttributes;
        spCrudeLayerME.buffers[idx].buffer = spCrudeLayerME.gl.createBuffer();
        spCrudeLayerME.gl.bindBuffer(spCrudeLayerME.gl.ARRAY_BUFFER, spCrudeLayerME.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerME.gl.ARRAY_BUFFER, data, spCrudeLayerME.gl.STATIC_DRAW);
        spCrudeLayerME.buffers[idx].ready = true;
      }
    };

    var shipsWorkerUS = new Worker('ships-worker.js');
    shipsWorkerUS.onmessage = function(e) {
      if (typeof e.data["idx"] != "undefined") {
        var idx = e.data.idx;
        var array = e.data["array"];
        //spCrudeLayer.setBuffer(idx, new Float32Array(array));
        var data = new Float32Array(array);
        spCrudeLayerUS.buffers[idx].count = data.length / spCrudeLayerUS.buffers[idx].numAttributes;
        spCrudeLayerUS.buffers[idx].buffer = spCrudeLayerUS.gl.createBuffer();
        spCrudeLayerUS.gl.bindBuffer(spCrudeLayerUS.gl.ARRAY_BUFFER, spCrudeLayerUS.buffers[idx].buffer);
        gl.bufferData(spCrudeLayerUS.gl.ARRAY_BUFFER, data, spCrudeLayerUS.gl.STATIC_DRAW);
        spCrudeLayerUS.buffers[idx].ready = true;
      }
    };
*/

    // LODES interface
    var lodesGui;
    var lodesOptions;

    var LodesOptions = function() {
      this.doPulse = true;
      this.totalTime = 1000;
      this.dwellTime = 1000;
      this.filter = true;
      this.distance = 50.0;
      this.animate = 'animate';
      this.speed = 1;
      this.se01 = true;
      this.se02 = true;
      this.se03 = true;
    };

    var lodesAnimationState = {
      then: new Date(),
      inMainLoop: false,
      inStartDwell: true,
      inEndDwell: false,
      pulse: false
    };

    function getLayerInfo(layer) {
      var readyTileCount = 0;
      var waitingTileCount = 0;

      var pointCount = 0;
      var keys = Object.keys(layer._tileView._tiles);
      var zoomLevel = 0;
      var layerView = timelapse.getView();
      var timelapse2map = layer.getWidth() / landsatBaseMapLayer.getWidth();
      layerView.scale /= timelapse2map;

      var zoomLevel = layer._tileView._scale2level(layerView.scale);

      var lightBaseMapView = timelapse.getView();
      var timelapse2map = lightBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
      lightBaseMapView.x *= timelapse2map;
      lightBaseMapView.y *= timelapse2map;
      lightBaseMapView.scale /= timelapse2map;
      var mapLevel = lightBaseMapLayer._tileView._scale2level(lightBaseMapView.scale);

      for (var i = 0; i < keys.length; i++) {
        var tile = layer._tileView._tiles[keys[i]];
        if (tile._ready) {
          readyTileCount++;
          pointCount += tile._pointCount;
        } else {
          waitingTileCount++;
        }
      }

      return {
        'readyTileCount': readyTileCount,
        'waitingTileCount': waitingTileCount,
        'pointCount': pointCount,
        'zoomLevel': zoomLevel,
        'mapLevel': mapLevel
      };
    }

    function initLodesGui() {
      if (lodesOptions) return;
      lodesOptions = new LodesOptions();
      var gui = new dat.GUI();
      var f1 = gui.addFolder('Animation');
      f1.add(lodesOptions, 'animate', { animate: 'animate', home: 'home', work: 'work' } );
      f1.add(lodesOptions, 'speed', { fast: 1, medium: 3, slow: 5});
      f1.open();
      var f2 = gui.addFolder('Distance in KM');
      f2.add(lodesOptions, 'filter');
      f2.add(lodesOptions, 'distance',10,100);
      f2.open();
      var f3 = gui.addFolder('Earnings per Month');
      f3.add(lodesOptions, 'se01').name('< $1251');
      f3.add(lodesOptions, 'se02').name('$1251 - $3333');
      f3.add(lodesOptions, 'se03').name('> $3333');
      f3.open();
      f3.onResize = function() {
          var el1 = document.getElementById("se01-color");
          var el2 = document.getElementById("se02-color");
          var el3 = document.getElementById("se03-color");

          if (f3.closed) {
              el1.style['display'] = 'none';
              el2.style['display'] = 'none';
              el3.style['display'] = 'none';
          } else {
              el1.style['display'] = 'block';
              el2.style['display'] = 'block';
              el3.style['display'] = 'block';
          }
      };
      gui.onResize = function() {
          if (gui.closed) {
              var el1 = document.getElementById("se01-color");
              var el2 = document.getElementById("se02-color");
              var el3 = document.getElementById("se03-color");

              el1.style['display'] = 'none';
              el2.style['display'] = 'none';
              el3.style['display'] = 'none';

          }
      };
      var dg = document.getElementsByClassName("dg ac")[0];
      var el = document.createElement("div");
      el["id"] = "se01-color";
      el["style"]["position"] = "absolute";
      el["style"]["width"] = "24px";
      el["style"]["height"] = "12px";
      el["style"]["top"] = "205px";
      el["style"]["right"] = "112px";
      el["style"]["backgroundColor"] = "#194BFF";
      el["style"]["zIndex"] = 100;
      dg.appendChild(el);

      var el = document.createElement("div");
      el["id"] = "se02-color";
      el["style"]["position"] = "absolute";
      el["style"]["width"] = "24px";
      el["style"]["height"] = "12px";
      el["style"]["top"] = "233px";
      el["style"]["right"] = "112px";
      el["style"]["backgroundColor"] = "#148A09";
      el["style"]["zIndex"] = 100;
      dg.appendChild(el);

      var el = document.createElement("div");
      el["id"] = "se03-color";
      el["style"]["position"] = "absolute";
      el["style"]["width"] = "24px";
      el["style"]["height"] = "12px";
      el["style"]["top"] = "261px";
      el["style"]["right"] = "112px";
      el["style"]["backgroundColor"] = "#E31E1E";
      el["style"]["zIndex"] = 100;
      dg.appendChild(el);
      dg["style"]["display"] = "none";

    }
    // ## 2 ##
    //// Layer tile paths
    //

    var landsatUrl = (landsatVersion == "2015") ? rootTilePath + "/earthtime-annual-2015-v2/1068x600" : rootTilePath + "/earthtime-annual-2016-v14/1068x600";
    if (isMobileDevice || isIEButNotEdge) {
      landsatUrl = "https://earthengine.google.com/timelapse/data/20161025/";
    } else if (EARTH_TIMELAPSE_CONFIG.landsatUrl) {
      landsatUrl = EARTH_TIMELAPSE_CONFIG.landsatUrl;
    }
    var crwTimeMachineUrl = rootTilePath + "/coral/coralreefwatch-3.timemachine/crf20-22fps-1424x800";
    var ndviAnomalyTimeMachineUrl = rootTilePath + "/ndvi_anomaly_1000v01/1068x600";
    var himawariTimeMachineUrl = rootTilePath + "/himawari8/himawari8-nov-2015.timemachine/crf26-12fps-1424x800";
    var goes16TimeMachineUrl = rootTilePath + "/goes16/2017-09-01.timemachine/crf26-12fps-1424x800";
    var dscovrTimeMachineUrl = rootTilePath + "/dscovr/dscovr.timemachine/crf26-6fps-1424x800";
    var annualGlobalPm25TimeMachineUrl = rootTilePath + "/annual-global-pm25/pm2_5v2.timemachine/crf26-6fps-1424x800";
    var forestAlertsTimeMachineUrl = rootTilePath + "/global-forest-alerts/ForestAlarms2016v2/1068x600";
    var forestAlertsNoOverlayTimeMachineUrl = rootTilePath + "/global-forest-alerts/ForestAlarmsNoOverlay2016v1/1068x600";
    var berkeleyEarthTemperatureAnomalyTimeMachineUrl = rootTilePath + "/berkeley-earth/berkeley-earth.timemachine/crf24-12fps-1424x800";
    var osmDefaultUrl = rootTilePath + "/openstreetmap/default/";
    var osmLightRetinaUrl = rootTilePath + "/openstreetmap/light_all_retina/{default}/{z}/{x}/{y}.png";
    var osmDarkRetinaUrl = rootTilePath + "/openstreetmap/dark_all_retina/{default}/{z}/{x}/{y}.png";
    var omtDarkUrl = rootTilePath + "/openmaptiles/dark-map/{default}/{z}/{x}/{y}.png";
    var omtLightUrl = rootTilePath + "/openmaptiles/light-map/{default}/{z}/{x}/{y}.png";
    var gfcTransUrl = rootTilePath + "/global-forest-change/loss_year_transparent/{default}/{z}/{x}/{y}.png";
    var gfcLossGainUrl = rootTilePath + "/global-forest-change/loss_tree_gain/{default}/{z}/{x}/{y}.png";
    //var googleMapsDefaultUrl = "https://mts0.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0";
    var googleMapsDefaultUrl = "https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i386081408!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy5lOmd8cC5jOiNmZjAwMDAwMCxzLmU6bHxwLnY6b2ZmLHMuZTpsLml8cC52Om9mZixzLmU6bC50LmZ8cC5jOiNmZjc1NzU3NSxzLmU6bC50LnN8cC5jOiNmZjIxMjEyMSxzLnQ6MXxzLmU6Z3xwLmM6I2ZmNzU3NTc1fHAudjpvZmYscy50OjE3fHAudjpvbixzLnQ6MTd8cy5lOmwudC5mfHAuYzojZmZjY2NjY2Mscy50OjE3fHMuZTpsLnQuc3xwLmM6I2ZmMDAwMDAwLHMudDoyMXxwLnY6b2ZmLHMudDoxOXxzLmU6bC50LmZ8cC5jOiNmZmJkYmRiZCxzLnQ6MjB8cC52Om9mZixzLnQ6MTh8cC52Om9uLHMudDoxOHxzLmU6bC50LmZ8cC5jOiNmZjdmN2Y3ZixzLnQ6MTh8cy5lOmwudC5zfHAuYzojZmYwMDAwMDAscy50OjJ8cC52Om9mZixzLnQ6MnxzLmU6bC50LmZ8cC5jOiNmZjc1NzU3NSxzLnQ6NDB8cy5lOmd8cC5jOiNmZjE4MTgxOCxzLnQ6NDB8cy5lOmwudC5mfHAuYzojZmY2MTYxNjEscy50OjQwfHMuZTpsLnQuc3xwLmM6I2ZmMWIxYjFiLHMudDozfHAudjpvZmYscy50OjN8cy5lOmcuZnxwLmM6I2ZmMmMyYzJjLHMudDozfHMuZTpsLml8cC52Om9mZixzLnQ6M3xzLmU6bC50LmZ8cC5jOiNmZjhhOGE4YSxzLnQ6NTB8cy5lOmd8cC5jOiNmZjM3MzczNyxzLnQ6NDl8cy5lOmd8cC5jOiNmZjNjM2MzYyxzLnQ6Nzg1fHMuZTpnfHAuYzojZmY0ZTRlNGUscy50OjUxfHMuZTpsLnQuZnxwLmM6I2ZmNjE2MTYxLHMudDo0fHAudjpvZmYscy50OjR8cy5lOmwudC5mfHAuYzojZmY3NTc1NzUscy50OjZ8cC5jOiNmZjRjNGM0YyxzLnQ6NnxzLmU6Z3xwLmM6I2ZmMzMzMzMzLHMudDo2fHMuZTpsLnQuZnxwLmM6I2ZmM2QzZDNk!4e0";
    var googleMapsDarkStyleUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0";
    var googleMapsDefaultRetinaUrl = "https://mts1.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0!5m1!5f2";


    //var googleMapsDarkStyleRetinaUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0!5m1!5f2";
    var googleMapsDarkStyleRetinaUrl = "https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i386081408!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy5lOmd8cC5jOiNmZjAwMDAwMCxzLmU6bHxwLnY6b2ZmLHMuZTpsLml8cC52Om9mZixzLmU6bC50LmZ8cC5jOiNmZjc1NzU3NSxzLmU6bC50LnN8cC5jOiNmZjIxMjEyMSxzLnQ6MXxzLmU6Z3xwLmM6I2ZmNzU3NTc1fHAudjpvZmYscy50OjE3fHAudjpvbixzLnQ6MTd8cy5lOmwudC5mfHAuYzojZmZjY2NjY2Mscy50OjE3fHMuZTpsLnQuc3xwLmM6I2ZmMDAwMDAwLHMudDoyMXxwLnY6b2ZmLHMudDoxOXxzLmU6bC50LmZ8cC5jOiNmZmJkYmRiZCxzLnQ6MjB8cC52Om9mZixzLnQ6MTh8cC52Om9uLHMudDoxOHxzLmU6bC50LmZ8cC5jOiNmZjdmN2Y3ZixzLnQ6MTh8cy5lOmwudC5zfHAuYzojZmYwMDAwMDAscy50OjJ8cC52Om9mZixzLnQ6MnxzLmU6bC50LmZ8cC5jOiNmZjc1NzU3NSxzLnQ6NDB8cy5lOmd8cC5jOiNmZjE4MTgxOCxzLnQ6NDB8cy5lOmwudC5mfHAuYzojZmY2MTYxNjEscy50OjQwfHMuZTpsLnQuc3xwLmM6I2ZmMWIxYjFiLHMudDozfHAudjpvZmYscy50OjN8cy5lOmcuZnxwLmM6I2ZmMmMyYzJjLHMudDozfHMuZTpsLml8cC52Om9mZixzLnQ6M3xzLmU6bC50LmZ8cC5jOiNmZjhhOGE4YSxzLnQ6NTB8cy5lOmd8cC5jOiNmZjM3MzczNyxzLnQ6NDl8cy5lOmd8cC5jOiNmZjNjM2MzYyxzLnQ6Nzg1fHMuZTpnfHAuYzojZmY0ZTRlNGUscy50OjUxfHMuZTpsLnQuZnxwLmM6I2ZmNjE2MTYxLHMudDo0fHAudjpvZmYscy50OjR8cy5lOmwudC5mfHAuYzojZmY3NTc1NzUscy50OjZ8cC5jOiNmZjRjNGM0YyxzLnQ6NnxzLmU6Z3xwLmM6I2ZmMzMzMzMzLHMudDo2fHMuZTpsLnQuZnxwLmM6I2ZmM2QzZDNk!4e0!5m1!5f2";
        googleMapsDarkStyleRetinaUrl = 'https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i408105841!3m14!2sen-US!3sUS!5e18!12m1!1e68!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy5lOmd8cC5jOiNmZjIxMjEyMSxzLmU6bC5pfHAudjpvZmYscy5lOmwudC5mfHAuYzojZmY3NTc1NzUscy5lOmwudC5zfHAuYzojZmYyMTIxMjEscy50OjF8cy5lOmd8cC5jOiNmZjc1NzU3NSxzLnQ6MTd8cy5lOmcuc3xwLnY6b2ZmLHMudDoxN3xzLmU6bC50LmZ8cC5jOiNmZjllOWU5ZSxzLnQ6MjF8cC52Om9mZixzLnQ6MTl8cy5lOmcuc3xwLnY6b2ZmLHMudDoxOXxzLmU6bC50LmZ8cC5jOiNmZmJkYmRiZCxzLnQ6MTh8cy5lOmcuc3xwLnY6b2ZmLHMudDoxMzEzfHAuYzojZmYwMDAwMDAscy50OjJ8cy5lOmwudC5mfHAuYzojZmY3NTc1NzUscy50OjQwfHMuZTpnfHAuYzojZmYxODE4MTgscy50OjQwfHMuZTpsLnQuZnxwLmM6I2ZmNjE2MTYxLHMudDo0MHxzLmU6bC50LnN8cC5jOiNmZjFiMWIxYixzLnQ6M3xzLmU6Zy5mfHAuYzojZmYyYzJjMmMscy50OjN8cy5lOmwudC5mfHAuYzojZmY4YThhOGEscy50OjUwfHMuZTpnfHAuYzojZmYzNzM3Mzcscy50OjQ5fHMuZTpnfHAuYzojZmYzYzNjM2Mscy50Ojc4NXxzLmU6Z3xwLmM6I2ZmNGU0ZTRlLHMudDo1MXxzLmU6bC50LmZ8cC5jOiNmZjYxNjE2MSxzLnQ6NHxzLmU6bC50LmZ8cC5jOiNmZjc1NzU3NSxzLnQ6NnxzLmU6Z3xwLmM6I2ZmMDAwMDAwLHMudDo2fHMuZTpnLmZ8cC5jOiNmZjMyMzIzMixzLnQ6NnxzLmU6bC50LmZ8cC5jOiNmZjNkM2QzZA!4e0!5m1!5f2';


    var googleMapsCountryLabelUrl = 'https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i388084864!3m14!2sen-US!3sUS!5e18!12m1!1e68!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy5lOmd8cC5jOiNmZjIxMjEyMSxzLmU6bC5pfHAudjpvZmYscy5lOmwudC5mfHAuYzojZmY3NTc1NzUscy5lOmwudC5zfHAuYzojZmYyMTIxMjEscy50OjF8cy5lOmd8cC5jOiNmZjc1NzU3NXxwLnY6b2ZmLHMudDoxN3xzLmU6bC50LmZ8cC5jOiNmZjllOWU5ZSxzLnQ6MjF8cC52Om9mZixzLnQ6MTl8cC52Om9mZixzLnQ6MTl8cy5lOmwudC5mfHAuYzojZmZiZGJkYmQscy50OjIwfHAudjpvZmYscy50OjE4fHAudjpvZmYscy50OjV8cC52Om9mZixzLnQ6MnxwLnY6b2ZmLHMudDoyfHMuZTpsLnR8cC52Om9mZixzLnQ6MnxzLmU6bC50LmZ8cC5jOiNmZjc1NzU3NSxzLnQ6NDB8cy5lOmd8cC5jOiNmZjE4MTgxOCxzLnQ6NDB8cy5lOmwudC5mfHAuYzojZmY2MTYxNjEscy50OjQwfHMuZTpsLnQuc3xwLmM6I2ZmMWIxYjFiLHMudDozfHAudjpvZmYscy50OjN8cy5lOmcuZnxwLmM6I2ZmMmMyYzJjLHMudDozfHMuZTpsfHAudjpvZmYscy50OjN8cy5lOmwuaXxwLnY6b2ZmLHMudDozfHMuZTpsLnQuZnxwLmM6I2ZmOGE4YThhLHMudDo1MHxzLmU6Z3xwLmM6I2ZmMzczNzM3LHMudDo0OXxzLmU6Z3xwLmM6I2ZmM2MzYzNjLHMudDo3ODV8cy5lOmd8cC5jOiNmZjRlNGU0ZSxzLnQ6NTF8cy5lOmwudC5mfHAuYzojZmY2MTYxNjEscy50OjR8cC52Om9mZixzLnQ6NHxzLmU6bC50LmZ8cC5jOiNmZjc1NzU3NSxzLnQ6NnxwLnY6b2ZmLHMudDo2fHMuZTpnfHAuYzojZmYwMDAwMDAscy50OjZ8cy5lOmwudHxwLnY6b2ZmLHMudDo2fHMuZTpsLnQuZnxwLmM6I2ZmM2QzZDNk!4e0';
    var googleMapsCountryLabelUrl = 'https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i388083592!3m14!2sen-US!3sUS!5e18!12m1!1e68!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy5lOmd8cC5jOiNmZjIxMjEyMSxzLmU6bC5pfHAudjpvZmYscy5lOmwudC5mfHAuYzojZmY3NTc1NzUscy5lOmwudC5zfHAuYzojZmYyMTIxMjEscy50OjF8cy5lOmd8cC5jOiNmZjc1NzU3NXxwLnY6b2ZmLHMudDoxN3xzLmU6bC50LmZ8cC5jOiNmZmZmZmZmZixzLnQ6MTd8cy5lOmwudC5zfHAuYzojZmYwMDAwMDAscy50OjIxfHAudjpvZmYscy50OjE5fHAudjpvZmYscy50OjE5fHMuZTpsLnQuZnxwLmM6I2ZmYmRiZGJkLHMudDoyMHxwLnY6b2ZmLHMudDoxOHxwLnY6b2ZmLHMudDo1fHAudjpvZmYscy50OjJ8cC52Om9mZixzLnQ6MnxzLmU6bC50fHAudjpvZmYscy50OjJ8cy5lOmwudC5mfHAuYzojZmY3NTc1NzUscy50OjQwfHMuZTpnfHAuYzojZmYxODE4MTgscy50OjQwfHMuZTpsLnQuZnxwLmM6I2ZmNjE2MTYxLHMudDo0MHxzLmU6bC50LnN8cC5jOiNmZjFiMWIxYixzLnQ6M3xwLnY6b2ZmLHMudDozfHMuZTpnLmZ8cC5jOiNmZjJjMmMyYyxzLnQ6M3xzLmU6bHxwLnY6b2ZmLHMudDozfHMuZTpsLml8cC52Om9mZixzLnQ6M3xzLmU6bC50LmZ8cC5jOiNmZjhhOGE4YSxzLnQ6NTB8cy5lOmd8cC5jOiNmZjM3MzczNyxzLnQ6NDl8cy5lOmd8cC5jOiNmZjNjM2MzYyxzLnQ6Nzg1fHMuZTpnfHAuYzojZmY0ZTRlNGUscy50OjUxfHMuZTpsLnQuZnxwLmM6I2ZmNjE2MTYxLHMudDo0fHAudjpvZmYscy50OjR8cy5lOmwudC5mfHAuYzojZmY3NTc1NzUscy50OjZ8cC52Om9mZixzLnQ6NnxzLmU6Z3xwLmM6I2ZmMDAwMDAwLHMudDo2fHMuZTpsLnR8cC52Om9mZixzLnQ6NnxzLmU6bC50LmZ8cC5jOiNmZjNkM2QzZA!4e0&token=52457';
    var omtCountryLabelUrl = rootTilePath + "/labels/dark-map-country-labels/{default}/{z}/{x}/{y}.png";
    var googleMapsCityLabelUrl = 'https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i397094607!3m14!2sen-US!3sUS!5e18!12m1!1e68!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy50OjV8cC52Om9mZixzLnQ6MnxwLnY6b2ZmLHMudDozfHAudjpvZmYscy50OjN8cy5lOmx8cC52Om9mZixzLnQ6NHxwLnY6b2ZmLHMudDo2fHAudjpvZmY!4e0!5m1!5f2&token=118514';
    var lightMapUrl = useGoogleMaps ? googleMapsDefaultRetinaUrl : omtLightUrl;
    var darkMapUrl = useGoogleMaps ? googleMapsDarkStyleRetinaUrl : omtDarkUrl;
    var countryLabelMapUrl = useGoogleMaps ? googleMapsCountryLabelUrl : omtCountryLabelUrl;
    var cityLabelMapUrl = useGoogleMaps ? googleMapsCityLabelUrl : googleMapsCityLabelUrl;
    var lightsAtNightUrl = rootTilePath + "/lights-at-night/{default}/{z}/{x}/{y}.png";
    // Note that x/y are swapped for these two lights at night data sets
    var lightsAtNight2012Url = rootTilePath + "/lights-at-night-2012/{default}/{z}/{y}/{x}.jpg";
    var lightsAtNight2016Url = rootTilePath + "/lights-at-night-2016/{default}/{z}/{y}/{x}.jpg";
    var waterOccurrenceUrl = rootTilePath + "/water/occurrence_2016/{default}/{z}/{x}/{y}.png";
    var waterChangeUrl = rootTilePath + "/water/change_2016/{default}/{z}/{x}/{y}.png";

    var wdpaUrl = rootTilePath + "/wdpaline-year/{z}/{x}/{y}.bin";
    var mcrmUrl = rootTilePath + "/coral/mcrm-lines-wrapdateline/{z}/{x}/{y}.bin";

    var viirsUrl = rootTilePath + "/viirs/viirs_20140817-20170917.bin";

    var coralBleachingUrl = rootTilePath + "/coral/{z}/{x}/{y}.bin";
    var usgsWindTurbineUrl = rootTilePath + "/energy/wind-installs-usgs/{z}/{x}/{y}.bin";
    var solarInstallsUrl = rootTilePath + "/energy/solar-installs/{z}/{x}/{y}.bin";
    var globalWindPowerUrl = rootTilePath + "/energy/global-wind-power/{z}/{x}/{y}.bin";
    var drillingUrl = rootTilePath + "/energy/drilling/{z}/{x}/{y}.bin";
    var animatedHansenUrls = [gfcTransUrl, gfcLossGainUrl];
    var monthlyRefugeesUrl = rootTilePath + '/monthly-mediterranean-refugees/{z}/{x}/{y}.bin';

    var annualRefugeesUrl = rootTilePath + "/annual-refugees/{z}/{x}/{y}.bin";
    if (subsampleAnnualRefugees) {
      annualRefugeesUrl = rootTilePath + "/annual-refugees/subsampled/{z}/{x}/{y}.bin";
    }
    var annualReturnsUrl =  rootTilePath + "/annual-returns/refugee-returns.bin";
    if (subsampleAnnualReturns) {
      annualReturnsUrl = rootTilePath + "/annual-returns/refugee-returns-subsampled.bin";
    }

    var vsiUrl = rootTilePath + "/vsi/tiles/{default}/{z}/{x}/{y}.png";
    var healthImpactUrl = rootTilePath + "/health-impact/{z}/{x}/{y}.bin";
    var zikaUrl = rootTilePath + "/pandemics/zika/{z}/{x}/{y}.bin";
    var dengueUrl = rootTilePath + "/pandemics/dengue/{z}/{x}/{y}.bin";
    var chikuUrl = rootTilePath + "/pandemics/chiku/{z}/{x}/{y}.bin";

    var seaLevelRiseUrl = rootTilePath + "/sea-level-rise/201704_lockin_animated_land/{z}/{x}/{y}.png"; //"http://a.ss2tiles.climatecentral.org/lockin_animated_land/{z}/{x}/{y}.png";
    var urbanFragilityUrl = rootTilePath + "/urban-fragility/{z}/{x}/{y}.bin";
    var gtdUrl = rootTilePath + "/gtd/{z}/{x}/{y}.bin";
    var hivUrl = rootTilePath + "/hiv/{z}/{x}/{y}.bin";
    var obesityUrl = rootTilePath + "/obesity/{z}/{x}/{y}.geojson";
    var vaccineConfidenceUrl = rootTilePath + "/vaccine-confidence/{z}/{x}/{y}.geojson";
    var ebolaDeathsUrl = rootTilePath + "/ebola/deaths/{z}/{x}/{y}.bin";
    var ebolaCasesUrl = rootTilePath + "/ebola/cases/{z}/{x}/{y}.bin";
    var ebolaNewCasesUrl = rootTilePath + "/ebola/new-cases/{z}/{x}/{y}.bin";

    var lodesUrl = rootTilePath + "/lodes/lodes-10/{z}/{x}/{y}.bin";

    var cumulativeActiveMiningUrl = "https://storage.googleapis.com/skytruth-data/color_test_cumulativeActiveMining-FOOTPRINT/{z}/{x}/{y}.png";

    var iomIdpUrl = rootTilePath + "/iom-idp/idp-returns.geojson";
    var landBorderUrl = rootTilePath + "/land-borders2/{default}/{z}/{x}/{y}.png";

    var uppsalaConflictUrl = rootTilePath + "/ucdp/uppsala-conflict.bin";

    var omiNo2Url = rootTilePath + "/omi-no2/omi-no2.timemachine/crf24-12fps-1424x800";

    var chinaAviationUrl = rootTilePath + "/china-infrastructure/china-aviation.bin";
    var chinaPowerPlantsUrl = rootTilePath + "/china-infrastructure/china-power-plants.bin";
    var chinaReservoirsUrl = rootTilePath + "/china-infrastructure/china-reservoirs.bin";
    var chinaWasteTreatmentPlantsUrl = rootTilePath + "/china-infrastructure/china-waste-treatment-plants.bin";

    var bePm25Url = rootTilePath + "/be-pm25/be-pm25.timemachine/crf24-22fps-1424x800";

    var expandingCitiesUrl = rootTilePath + "/expandingCities/expandingCities.bin";

    var irenaSolarUrl = 'https://data.cmucreatelab.org/earthtime/IRENA/Solar.Electricity_capacity_MW.csv';
    var irenaWindUrl = 'https://data.cmucreatelab.org/earthtime/IRENA/Wind.Electricity_capacity_MW.csv';

    var carbonPriceRiskUrl = 'https://data.cmucreatelab.org/msc/carbon-price-risk.csv';

    var tsipUrl = rootTilePath + "/tsip/tsip.bin";

    var spCrudeUrl = rootTilePath + "/sp-crude/0-crude-flows.bin";
    var spCrudeUrlOceania = rootTilePath + "/sp-crude/Oceania/0-crude-flows_Oceania.bin";
    var spCrudeUrlAG = rootTilePath + "/sp-crude/AG/0-crude-flows_AG.bin";
    var spCrudeUrlWAF = rootTilePath + "/sp-crude/WAF/0-crude-flows_WAF.bin";
    var spCrudeUrlMedNAF = rootTilePath + "/sp-crude/MedNAF/0-crude-flows_MedNAF.bin";
    var spCrudeUrlUrals = rootTilePath + "/sp-crude/Urals/0-crude-flows_Urals.bin";
    var spCrudeUrlUSGC = rootTilePath + "/sp-crude/USGC/0-crude-flows_USGC.bin";
    var spCrudeUrlLatAM = rootTilePath + "/sp-crude/LatAM/0-crude-flows_LatAM.bin";
    var spCrudeUrlNS = rootTilePath + "/sp-crude/NS/0-crude-flows_NS.bin";

    /*
    var spCrudeUrlWAF = rootTilePath + "/sp-crude/0-crude-flows_WAF.bin"
    var spCrudeUrlNAF = rootTilePath + "/sp-crude/0-crude-flows_NAF.bin"
    var spCrudeUrlME = rootTilePath + "/sp-crude/0-crude-flows_ME.bin"
    var spCrudeUrlUS = rootTilePath + "/sp-crude/0-crude-flows_US.bin"
    */

    function init() {
      if (!UTIL.isWebGLSupported()) {
        $("#baseLayerCreditContainer, #logosContainer").hide();
        $("#browser_not_supported").show();
        return;
      }

      var settings = {
        loopDwell: {
          startDwell: 1.5,
          endDwell: 1.5
        },
        playbackSpeed: defaultPlaybackSpeed,
        viewerType: isMobileDevice || isIEButNotEdge ? undefined : "webgl",
        url: landsatUrl,
        apiKeys: googleMapsAPIKey ? {'googleMaps': googleMapsAPIKey} : undefined,
        enablePresentationSlider: !disablePresentationSlider,
        enableEditor: false,
        showEditorOnLoad: false,
        // Using "https" will cause the thumbnail loading from the server to fail
        thumbnailServerRootTileUrl: (landsatVersion == "2015") ? "http://earthengine.google.org/timelapse/data/20130507" : "http://storage.googleapis.com/earthengine-timelapse/herwig/earthtime_annual_1984_2016/v05",
        showFullScreenBtn: showFullScreenButton,
        showThumbnailTool: showThumbnailTool,
        showShareBtn: showShareButton,
        presentationSliderSettings: {
          onLoadAnimation: "none",
          playAfterAnimation: false,
          initialWaypointIndex: 0,
          doAutoMode: enableAutoMode,
          showAnnotations: false,
          screenIdleTime: screenTimeoutInMilliseconds,
          waypointDelayTime: waypointDelayInMilliseconds,
          height: 94
        },
        contextMapOptions: {
          contextMapDiv: "contextMap1",
          tileType: useGoogleMaps ? "Google" : "OpenStreetMap",
          tileUrl: osmDefaultUrl,
          geometry: {
            width: 270,
            height: 200
          }
        },
        useTouchFriendlyUI: isHyperwall || isMobileDevice,
        datasetType: "landsat",
        playOnLoad: true,
        mediaType: (landsatVersion == "2015") ? ".webm" : ".mp4",
        onTimeMachinePlayerReady: function(viewerDivId) {
          setupPostMessageHandlers();
        },
        scaleBarOptions: {
          scaleBarDiv: "scaleBar1"
        },
        isGoogleAnalyticEventTrackingEnabled: true,
        startEditorFromPresentationMode: true
      };

      if (enableLetterboxMode) {
        $("#letterbox-content").show();
        $("#timeMachine").addClass("letterbox");
        $("#letterbox-main").replaceWith($("#timeMachine"));
        $("#letterbox-bottom").css("height", letterboxBottomOffset);
        $("#timeMachine").css("height", "calc(100% - " + letterboxBottomOffset + "px)");
      } else {
        $("#letterbox-content").remove();
      }

      timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", settings);
      onTimeMachinePlayerReady();
    }

    $.getScript(landsatAjaxIncludesPath)
      .done(function(script, status) {
        eval(script);
        $(init);
      }
    );

    function googleMapsLoadedCallback() {
      if (useGoogleSearch) {
        var autocomplete = new google.maps.places.Autocomplete($("#location_search").get(0));
        var geocoder = new google.maps.Geocoder();

        // Hack to enable places selection from dropdown on touch screens
        $(document).on('touchstart', '.pac-item', function(e) {
          e.preventDefault();
          var searchText = $(this).text();
          $("#location_search").val(searchText);
          google.maps.event.trigger(autocomplete, 'place_changed', {
            locationName: searchText
          });
          $('.pac-container').hide();
        });

        $("#location_search").on("keydown", function(e) {
          if (e.keyCode == 13) {
            google.maps.event.trigger(e.target, 'focus');
            google.maps.event.trigger(e.target, 'keydown', {
              keyCode: 13
            });
          }
        });

        google.maps.event.addListener(autocomplete, 'place_changed', function(options) {
          var place = (options && options.locationName) || autocomplete.getPlace();
          if (!place) return;
          if (!place.geometry) {
            var address = $("#location_search").val();
            $("#location_search").val("");
            geocoder.geocode({
              'address': address
            }, function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                var lat = results[0].geometry.location.lat();
                var lng = results[0].geometry.location.lng();
                newView = {
                  center: {
                    "lat": lat,
                    "lng": lng
                  },
                  "zoom": 10
                };
                timelapse.setNewView(newView, false, false);
              } else {
                console.log("Geocode failed: " + status);
              }
            });
          } else {
            var newView = {
              center: {
                "lat": place.geometry.location.lat(),
                "lng": place.geometry.location.lng()
              },
              "zoom": 10
            };
            timelapse.setNewView(newView, false, false);
          }

          var searchLocation = (options && options.locationName) || place.formatted_address;
          if (searchLocation) {
            searchLocation = searchLocation.replace(/ /g, '');
            UTIL.addGoogleAnalyticEvent('textbox', 'search', 'go-to-searched-place=' + searchLocation);
          }
        });
      }
    }

    // Wait until currrent execution finishes so that we can skip loading the timeline in case it is not the last call.
    // We do this because the timeline loads asynchronously; otherwise, the next waypoint might use the wrong timeline.
    var finalizeNewTimelineTimeout = null;

    function requestNewTimeline(url, newTimelineStyle) {
      // The last timeline request takes precedence
      if (finalizeNewTimelineTimeout !== null) {
        clearTimeout(finalizeNewTimelineTimeout);
        finalizeNewTimelineTimeout = null;
      }
      finalizeNewTimelineTimeout = setTimeout(function() {
        timelapse.loadNewTimeline(url, newTimelineStyle);
        finalizeNewTimelineTimeout = null;
      }, 0);
    }

    function cacheLastUsedLayer(layer) {
      var cacheIdx = lastActiveLayers.indexOf(layer);

      if (cacheIdx >= 0) {
        lastActiveLayers.push(lastActiveLayers.splice(cacheIdx, 1)[0]);
      } else {
        if (lastActiveLayers.length == maxCachedLayers) {
          lastActiveLayers.shift().destroy();
        }

        // May not do anything if tiles have all loaded for this layer or have been deleted
        layer.abortLoading();

        var tiles = Object.keys(layer.getTiles());

        if (tiles && tiles.length > 0) {
          lastActiveLayers.push(layer);
        }
      }
    }

    function setTimeLine(identifier, startDate, endDate, step) {
      var captureTimes = [];

      var yyyymm_re = /(\d{4})(\d{2})$/;
      var sm = String(startDate).match(yyyymm_re);
      var em = String(endDate).match(yyyymm_re);
      if (sm && em) {
        var startYear = sm[1];
        var startMonth = sm[2];
        var endYear = em[1];
        var endMonth = em[2];
        startYear = parseInt(startYear, 10);
        startMonth = parseInt(startMonth, 10);
        endYear = parseInt(endYear, 10);
        endMonth = parseInt(endMonth, 10);

        if (isNaN(startYear) || isNaN(endYear) || isNaN(startMonth) || isNaN(endMonth) ) {
          captureTimes = cached_ajax['landsat-times.json']['capture-times'];
        } else {
          function pad(n) {
            return (n < 10) ? ("0" + n) : n;
          }
          for (var i = startYear; i <= endYear; i++) {
            var beginMonth = 1;
            var stopMonth = 12;
            if (i == startYear) {
              beginMonth = startMonth;
            }
            if (i == endYear) {
              stopMonth = endMonth;
            }
            for (var j = beginMonth; j <= stopMonth; j++) {
              captureTimes.push(pad(i.toString()) + "-" + pad(j.toString()));
            }
          }
        }
      } else  {
        startDate = parseInt(startDate,10);
        endDate = parseInt(endDate,10);
        step = parseInt(step,10);
        if (isNaN(startDate) || isNaN(endDate) || isNaN(step) ) {
          captureTimes = cached_ajax['landsat-times.json']['capture-times'];
        } else {
          for (var i = startDate; i < endDate + 1; i+=step) {
            captureTimes.push(i.toString());
          }
        }
      }
      cached_ajax[identifier + '.json'] = {"capture-times":  captureTimes};
    }

    function initLayerToggleUI() {
      // ## 3 ##
      //// Layer toggle event handlers ////
      //

      $("#show-water-occurrence").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          waterOccurrenceLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-water-change").prop('checked')) {
            $("#show-water-change").click();
          }
          showWaterOccurrenceLayer = true;
          $("#water-occurrence-legend").show();
        } else {
          showWaterOccurrenceLayer = false;
          cacheLastUsedLayer(waterOccurrenceLayer);
          $("#water-occurrence-legend").hide();
        }
      }).prop('checked', showWaterOccurrenceLayer);

      $("#show-water-change").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          waterChangeLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-water-occurrence").prop('checked')) {
            $("#show-water-occurrence").click();
          }
          showWaterChangeLayer = true;
          $("#water-change-legend").show();
        } else {
          showWaterChangeLayer = false;
          cacheLastUsedLayer(waterChangeLayer);
          $("#water-change-legend").hide();
        }
      }).prop('checked', showWaterChangeLayer);

      $("#show-wdpa").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          wdpaLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showWdpaLayer = true;
          $("#wdpa-legend").show();
        } else {
          showWdpaLayer = false;
          cacheLastUsedLayer(wdpaLayer);
          $("#wdpa-legend").hide();
        }
      }).prop('checked', showWdpaLayer);

      $("#show-forest-change").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          hansenMapLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-forest-loss-gain").prop('checked')) {
            $("#show-forest-loss-gain").click();
          }
          if ($("#show-animated-forest-loss-gain").prop('checked')) {
            $("#show-animated-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts").prop('checked')) {
            $("#show-forest-alerts").click();
          }
          if ($("#show-forest-alerts-no-overlay").prop('checked')) {
            $("#show-forest-alerts-no-overlay").click();
          }
          showHansenLayer = true;
          $("#forest-loss-year-legend").show();
        } else {
          showHansenLayer = false;
          cacheLastUsedLayer(hansenMapLayer);
          $("#forest-loss-year-legend").hide();
        }
      }).prop('checked', showHansenLayer);

      $("#show-forest-loss-gain").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          hansenMapLayer2.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-forest-change").prop('checked')) {
            $("#show-forest-change").click();
          }
          if ($("#show-animated-forest-loss-gain").prop('checked')) {
            $("#show-animated-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts").prop('checked')) {
            $("#show-forest-alerts").click();
          }
          if ($("#show-forest-alerts-no-overlay").prop('checked')) {
            $("#show-forest-alerts-no-overlay").click();
          }
          showHansenLayer2 = true;
          timelineType = "none";
          $("#forest-loss-gain-legend").show();
          $("#baseLayerCreditContainer").hide();
        } else {
          showHansenLayer2 = false;
          cacheLastUsedLayer(hansenMapLayer2);
          timelineType = "customUI";
          $("#forest-loss-gain-legend").hide();
          $("#baseLayerCreditContainer").show();
        }
      }).prop('checked', showHansenLayer2);

      $("#show-animated-forest-loss-gain").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          //animatedHansenLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-forest-change").prop('checked')) {
            $("#show-forest-change").click();
          }
          if ($("#show-forest-loss-gain").prop('checked')) {
            $("#show-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts").prop('checked')) {
            $("#show-forest-alerts").click();
          }
          if ($("#show-forest-alerts-no-overlay").prop('checked')) {
            $("#show-forest-alerts-no-overlay").click();
          }
          showAnimatedHansenLayer = true;
          setActiveLayersWithTimeline(1);
          if (!showViirsLayer) {
            timelineType = "customUI";
            requestNewTimeline("animated-forest-loss-gain-times.json", timelineType);
          }
          $("#forest-loss-gain-legend").show();
        } else {
          showAnimatedHansenLayer = false;
          cacheLastUsedLayer(animatedHansenLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#forest-loss-gain-legend").hide();
        }
      }).prop('checked', showAnimatedHansenLayer);

      $("#show-forest-alerts").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          forestAlertsTimeMachineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-forest-change").prop('checked')) {
            $("#show-forest-change").click();
          }
          if ($("#show-forest-loss-gain").prop('checked')) {
            $("#show-forest-loss-gain").click();
          }
          if ($("#show-animated-forest-loss-gain").prop('checked')) {
            $("#show-animated-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts-no-overlay").prop('checked')) {
            $("#show-forest-alerts-no-overlay").click();
          }
          showForestAlertsTimeMachineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("forest-alerts-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setMaxScale(landsatMaxScale);
          timelapse.setDoDwell(false);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(1);
          previousVisibleBaseMapLayer = visibleBaseMapLayer;
          visibleBaseMapLayer = "forest-alarms";
        } else {
          showForestAlertsTimeMachineLayer = false;
          cacheLastUsedLayer(forestAlertsTimeMachineLayer);
          setActiveLayersWithTimeline(-1);
          if (!showForestAlertsNoOverlayTimeMachineLayer && !showForestAlertsTimeMachineLayer) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            visibleBaseMapLayer = $("input:radio[name=base-layers]:checked").val();
            timelapse.setMaxScale(landsatMaxScale);
            var v = timelapse.getVideoset();
            v.setFps(10);
            timelapse.setDoDwell(true);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
        }
      }).prop('checked', showForestAlertsTimeMachineLayer);

      $("#show-forest-alerts-no-overlay").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          forestAlertsNoOverlayTimeMachineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-forest-change").prop('checked')) {
            $("#show-forest-change").click();
          }
          if ($("#show-forest-loss-gain").prop('checked')) {
            $("#show-forest-loss-gain").click();
          }
          if ($("#show-animated-forest-loss-gain").prop('checked')) {
            $("#show-animated-forest-loss-gain").click();
          }
          if ($("#show-forest-alerts").prop('checked')) {
            $("#show-forest-alerts").click();
          }
          showForestAlertsNoOverlayTimeMachineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("forest-alerts-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setMaxScale(landsatMaxScale);
          timelapse.setDoDwell(false);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(1);
          previousVisibleBaseMapLayer = visibleBaseMapLayer;
          visibleBaseMapLayer = "forest-alarms-no-overlay";
        } else {
          showForestAlertsNoOverlayTimeMachineLayer = false;
          cacheLastUsedLayer(forestAlertsNoOverlayTimeMachineLayer);
          setActiveLayersWithTimeline(-1);
          if (!showForestAlertsNoOverlayTimeMachineLayer && !showForestAlertsTimeMachineLayer) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            visibleBaseMapLayer = $("input:radio[name=base-layers]:checked").val();
            timelapse.setMaxScale(landsatMaxScale);
            var v = timelapse.getVideoset();
            v.setFps(10);
            timelapse.setDoDwell(true);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
        }
      }).prop('checked', showForestAlertsNoOverlayTimeMachineLayer);

      $("#show-viirs").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          viirsLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showViirsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("viirs-times.json", timelineType);
          timelapse.setMasterPlaybackRate(8);
          timelapse.setPlaybackRate(8);
          timelapse.setDoDwell(false);
          $("#fires-at-night-legend").show();
        } else {
          showViirsLayer = false;
          cacheLastUsedLayer(viirsLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#fires-at-night-legend").hide();
        }
      }).prop('checked', showViirsLayer);

      $("#show-coral").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          coralBleachingLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          mcrmVectorLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-coral-bleaching-alerts").prop('checked')) {
            $("#show-coral-bleaching-alerts").click();
          }
          showCoralBleachingLayer = true;
          setActiveLayersWithTimeline(1);
          showMcrmLayer = true;
          timelineType = "customUI";
          $("#coral-bleaching-legend").show();
        } else {
          showCoralBleachingLayer = false;
          cacheLastUsedLayer(coralBleachingLayer);
          showMcrmLayer = false;
          cacheLastUsedLayer(mcrmVectorLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-coral-bleaching-alerts").prop('checked')) {
            $("#coral-bleaching-legend").hide();
          }
        }
      }).prop('checked', showCoralBleachingLayer);

      $("#show-coral-bleaching-alerts").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          crwTimeMachineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          mcrmVectorLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-coral").prop('checked')) {
            $("#show-coral").click();
          }
          showCrwTimeMachineLayer = true;
          showMcrmLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("crw-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(22);
          timelapse.setDoDwell(false);
          WebglVideoTile.useGreenScreen = true;
          $("#coral-bleaching-alerts-legend").show();
          $("#coral-bleaching-legend").show();
        } else {
          showCrwTimeMachineLayer = false;
          cacheLastUsedLayer(crwTimeMachineLayer);
          showMcrmLayer = false;
          cacheLastUsedLayer(mcrmVectorLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#coral-bleaching-alerts-legend").hide();
          if (!$("#show-coral").prop('checked')) {
            $("#coral-bleaching-legend").hide();
          }
        }
      }).prop('checked', showCrwTimeMachineLayer);

      $("#show-ndvi-anomaly").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          ndviAnomalyTimeMachineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showNdviAnomalyTimeMachineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("ndvi-anomaly-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(1);
          timelapse.setDoDwell(false);
          WebglVideoTile.useGreenScreen = true;
          $("#ndvi-anomaly-legend").show();
        } else {
          showNdviAnomalyTimeMachineLayer = false;
          cacheLastUsedLayer(ndviAnomalyTimeMachineLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#ndvi-anomaly-legend").hide();
        }
      }).prop('checked', showNdviAnomalyTimeMachineLayer);

      $("#show-himawari").on("click", function() {
        $(".current-location-text-container").hide();
        $(".snaplapse_keyframe_list_item_thumbnail_overlay_presentation.thumbnail_highlight").removeClass("thumbnail_highlight");

        var $this = $(this);
        if ($this.prop('checked')) {
          himawariTimeMachineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          // Clear out non-himawari8 layers if they were already active.
          var $activeLayersNotIncludingClickedLayer = $(".map-layer-div").find("input:checked").not($(this));
          if ($activeLayersNotIncludingClickedLayer.length > 1) {
            $activeLayersNotIncludingClickedLayer.trigger("click");
          }
          showHimawariTimeMachineLayer = true;
          activeLayersWithTimeline = 1;
          previousActiveLayersWithTimeline = activeLayersWithTimeline;
          timelineType = "defaultUI";
          previousVisibleBaseMapLayer = visibleBaseMapLayer;
          visibleBaseMapLayer = "himawari";
          requestNewTimeline("himawari-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(12);
          timelapse.setMaxScale(himawariMaxScale);
          timelapse.setDoDwell(false);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(1);
          $("#layers-legend").hide();
          // Handle Landsat 2016 bounds.
          if (landsatVersion == "2016") {
            $.getScript("himawari_landsat_ajax_includes.js")
              .done(function(script, status) {
                eval(script);
                landsatBaseMapLayer.resetDimensions(cached_ajax["./1068x600/r.json"]);
              }
            );
          }
          $("#baselayerCreditText").html("&copy; JMA");
        } else {
          showHimawariTimeMachineLayer = false;
          cacheLastUsedLayer(himawariTimeMachineLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.seek(0);
          timelapse.setMaxScale(landsatMaxScale);
          timelapse.setDoDwell(true);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#layers-legend").hide();
          // Handle Landsat 2016 bounds.
          if (!$("#show-goes16").prop('checked') && !$("#show-dscovr").prop('checked')) {
            if (landsatVersion == "2016") {
              $.getScript(landsatAjaxIncludesPath)
                .done(function(script, status) {
                  eval(script);
                  landsatBaseMapLayer.resetDimensions(cached_ajax["./1068x600/r.json"]);
                }
              );
            }
          }
        }
        timelapse.warpTo(timelapse.getHomeView());
      }).prop('checked', showHimawariTimeMachineLayer);

      $("#show-goes16").on("click", function() {
        $(".current-location-text-container").hide();
        $(".snaplapse_keyframe_list_item_thumbnail_overlay_presentation.thumbnail_highlight").removeClass("thumbnail_highlight");

        var $this = $(this);
        if ($this.prop('checked')) {
          goes16TimeMachineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          // Clear out non-goes16 layers if they were already active.
          var $activeLayersNotIncludingClickedLayer = $(".map-layer-div").find("input:checked").not($(this));
          if ($activeLayersNotIncludingClickedLayer.length > 1) {
            $activeLayersNotIncludingClickedLayer.trigger("click");
          }
          showGoes16TimeMachineLayer = true;
          activeLayersWithTimeline = 1;
          previousActiveLayersWithTimeline = activeLayersWithTimeline;
          timelineType = "defaultUI";
          previousVisibleBaseMapLayer = visibleBaseMapLayer;
          visibleBaseMapLayer = "goes16";
          requestNewTimeline("goes16-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(12);
          timelapse.setMaxScale(goes16MaxScale);
          timelapse.setDoDwell(false);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(1);
          $("#layers-legend").hide();
          // Handle Landsat 2016 bounds.
          if (landsatVersion == "2016") {
            $.getScript("himawari_landsat_ajax_includes.js")
              .done(function(script, status) {
                eval(script);
                landsatBaseMapLayer.resetDimensions(cached_ajax["./1068x600/r.json"]);
              }
            );
          }
          $("#baselayerCreditText").html("&copy; NOOA");
        } else {
          showGoes16TimeMachineLayer = false;
          cacheLastUsedLayer(goes16TimeMachineLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.seek(0);
          timelapse.setMaxScale(landsatMaxScale);
          timelapse.setDoDwell(true);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#layers-legend").hide();
          // Handle Landsat 2016 bounds.
          if (!$("#show-himawari").prop('checked') && !$("#show-dscovr").prop('checked')) {
            if (landsatVersion == "2016") {
              $.getScript(landsatAjaxIncludesPath)
                .done(function(script, status) {
                  eval(script);
                  landsatBaseMapLayer.resetDimensions(cached_ajax["./1068x600/r.json"]);
                }
              );
            }
          }
        }
        timelapse.warpTo(timelapse.getHomeView());
      }).prop('checked', showGoes16TimeMachineLayer);

      $("#show-dscovr").on("click", function() {
        $(".current-location-text-container").hide();
        $(".snaplapse_keyframe_list_item_thumbnail_overlay_presentation.thumbnail_highlight").removeClass("thumbnail_highlight");

        var $this = $(this);
        if ($this.prop('checked')) {
          dscovrTimeMachineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          // Clear out non-dscovr layers if they were already active.
          var $activeLayersNotIncludingClickedLayer = $(".map-layer-div").find("input:checked").not($(this));
          if ($activeLayersNotIncludingClickedLayer.length > 1) {
            $activeLayersNotIncludingClickedLayer.trigger("click");
          }
          showDscovrTimeMachineLayer = true;
          activeLayersWithTimeline = 1;
          previousActiveLayersWithTimeline = activeLayersWithTimeline;
          timelineType = "defaultUI";
          previousVisibleBaseMapLayer = visibleBaseMapLayer;
          visibleBaseMapLayer = "dscovr";
          requestNewTimeline("dscovr-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(6);
          timelapse.seek(0);
          timelapse.setMaxScale(dscovrMaxScale);
          timelapse.setDoDwell(false);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(1);
          $("#layers-legend").hide();
          // Handle Landsat 2016 bounds.
          if (landsatVersion == "2016") {
            $.getScript("himawari_landsat_ajax_includes.js")
              .done(function(script, status) {
                eval(script);
                landsatBaseMapLayer.resetDimensions(cached_ajax["./1068x600/r.json"]);
              }
            );
          }
          $("#baselayerCreditText").html("&copy; NOOA");
        } else {
          showDscovrTimeMachineLayer = false;
          cacheLastUsedLayer(dscovrTimeMachineLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setMaxScale(landsatMaxScale);
          timelapse.setDoDwell(true);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#layers-legend").hide();
          // Handle Landsat 2016 bounds.
          if (!$("#show-goes16").prop('checked') && !$("#show-himawari").prop('checked')) {
            if (landsatVersion == "2016") {
              $.getScript(landsatAjaxIncludesPath)
                .done(function(script, status) {
                  eval(script);
                  landsatBaseMapLayer.resetDimensions(cached_ajax["./1068x600/r.json"]);
                }
              );
            }
          }
        }
        timelapse.warpTo(timelapse.getHomeView());
      }).prop('checked', showDscovrTimeMachineLayer);

      $("#show-annual-pm25").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          annualGlobalPm25TimeMachineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showAnnualGlobalPm25TimeMachineLayer = true;
          setActiveLayersWithTimeline(1);
          visibleBaseMapLayer = "annual-pm25";
          timelineType = "defaultUI";
          requestNewTimeline("annual-global-pm25-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(6);
          timelapse.setDoDwell(true);
          WebglVideoTile.useGreenScreen = false;
          timelapse.setMasterPlaybackRate(1.0);
          $("#baseLayerCreditContainer").hide();
        } else {
          showAnnualGlobalPm25TimeMachineLayer = false;
          cacheLastUsedLayer(annualGlobalPm25TimeMachineLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          visibleBaseMapLayer = previousVisibleBaseMapLayer;
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#baseLayerCreditContainer").show();
        }
      }).prop('checked', showAnnualGlobalPm25TimeMachineLayer);

      $("#show-berkeley-earth-temperature-anomaly").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          berkeleyEarthTemperatureAnomalyTimeMachineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showBerkeleyEarthTemperatureAnomalyTimeMachineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("berkeley-earth-temperature-anomaly-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(12);
          timelapse.setDoDwell(false);
          WebglVideoTile.useGreenScreen = false;
          timelapse.setMasterPlaybackRate(1.0);
          $("#berkeley-earth-temperature-anomaly-legend").show();
          $("#baseLayerCreditContainer").hide();
        } else {
          showBerkeleyEarthTemperatureAnomalyTimeMachineLayer = false;
          cacheLastUsedLayer(berkeleyEarthTemperatureAnomalyTimeMachineLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          var v = timelapse.getVideoset();
          v.setFps(10);
          $("#berkeley-earth-temperature-anomaly-legend").hide();
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#baseLayerCreditContainer").show();
        }
      }).prop('checked', showBerkeleyEarthTemperatureAnomalyTimeMachineLayer);

      $("#show-usgs-windturbine").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          usgsWindTurbineLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showUsgsWindTurbineLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#wind-installs-legend").show();
        } else {
          showUsgsWindTurbineLayer = false;
          cacheLastUsedLayer(usgsWindTurbineLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          $("#wind-installs-legend").hide();
        }
      }).prop('checked', showUsgsWindTurbineLayer);

      $("#show-global-wind-power").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          globalWindPowerLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showGlobalWindPowerLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#global-wind-power-legend").show();
        } else {
          showGlobalWindPowerLayer = false;
          cacheLastUsedLayer(globalWindPowerLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          $("#global-wind-power-legend").hide();
        }
      }).prop('checked', showGlobalWindPowerLayer);

      $("#show-solar-installs").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          solarInstallsLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSolarInstallsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#solar-installs-legend").show();
        } else {
          showSolarInstallsLayer = false;
          cacheLastUsedLayer(solarInstallsLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          $("#solar-installs-legend").hide();
        }
      }).prop('checked', showSolarInstallsLayer);

      $("#show-drilling").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          drillingLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showDrillingLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("drilling-times.json", timelineType);
          $("#drilling-legend").show();
        } else {
          showDrillingLayer = false;
          cacheLastUsedLayer(drillingLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#drilling-legend").hide();
        }
      }).prop('checked', showDrillingLayer);

      $("#show-lights-at-night").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          lightsAtNightMapLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-lights-at-night-2016").prop('checked')) {
            $("#show-lights-at-night-2016").click();
          }
          if ($("#show-lights-at-night-2012").prop('checked')) {
            $("#show-lights-at-night-2012").click();
          }
          showLightsAtNightLayer = true;
          timelineType = "none";
          $("#lights-at-night-legend").show();
        } else {
          showLightsAtNightLayer = false;
          cacheLastUsedLayer(lightsAtNightMapLayer);
          timelineType = "customUI";
          $("#lights-at-night-legend").hide();
        }
      }).prop('checked', showLightsAtNightLayer);

      $("#show-lights-at-night-2012").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          lightsAtNight2012MapLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-lights-at-night").prop('checked')) {
            $("#show-lights-at-night").click();
          }
          if ($("#show-lights-at-night-2016").prop('checked')) {
            $("#show-lights-at-night-2016").click();
          }
          showLightsAtNight2012Layer = true;
          timelineType = "none";
          $("#lights-at-night-2012-legend").show();
          $("#baseLayerCreditContainer").hide();
        } else {
          showLightsAtNight2012Layer = false;
          cacheLastUsedLayer(lightsAtNight2012MapLayer);
          timelineType = "customUI";
          $("#lights-at-night-2012-legend").hide();
          $("#baseLayerCreditContainer").show();
        }
      }).prop('checked', showLightsAtNight2012Layer);

      $("#show-lights-at-night-2016").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          lightsAtNight2016MapLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-lights-at-night").prop('checked')) {
            $("#show-lights-at-night").click();
          }
          if ($("#show-lights-at-night-2012").prop('checked')) {
            $("#show-lights-at-night-2012").click();
          }
          showLightsAtNight2016Layer = true;
          timelineType = "none";
          $("#lights-at-night-2016-legend").show();
          $("#baseLayerCreditContainer").hide();
        } else {
          showLightsAtNight2016Layer = false;
          cacheLastUsedLayer(lightsAtNight2016MapLayer);
          timelineType = "customUI";
          $("#lights-at-night-2016-legend").hide();
          $("#baseLayerCreditContainer").show();
        }
      }).prop('checked', showLightsAtNight2016Layer);

      $("#show-monthly-refugees").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          monthlyRefugeesLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-annual-refugees").prop('checked')) {
            $("#show-annual-refugees").click();
          }
          showMonthlyRefugeesLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("monthly-refugees-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.85);
          timelapse.setPlaybackRate(0.425);
          timelapse.setDoDwell(false);
          $("#monthly-refugees-legend").show();
        } else {
          showMonthlyRefugeesLayer = false;
          cacheLastUsedLayer(monthlyRefugeesLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#monthly-refugees-legend").hide();
        }
      }).prop('checked', showMonthlyRefugeesLayer);


      $("#show-annual-refugees").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          annualRefugeesLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-monthly-refugees").prop('checked')) {
            $("#show-monthly-refugees").click();
          }
          showAnnualRefugeesLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("annual-refugees-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.045);
          timelapse.setPlaybackRate(0.0225);
          $("#annual-refugees-legend").show();
        } else {
          showAnnualRefugeesLayer = false;
          cacheLastUsedLayer(annualRefugeesLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          timelapse.setMaxScale(landsatMaxScale);
          $("#annual-refugees-legend").hide();
        }
      }).prop('checked', showAnnualRefugeesLayer);

      $("#show-annual-returns").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          annualReturnsLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-monthly-refugees").prop('checked')) {
            $("#show-monthly-refugees").click();
          }
          showAnnualReturnsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("annual-refugees-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.045);
          timelapse.setPlaybackRate(0.0225);
          $("#annual-returns-legend").show();
        } else {
          showAnnualReturnsLayer = false;
          cacheLastUsedLayer(annualReturnsLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          timelapse.setMaxScale(landsatMaxScale);
          $("#annual-returns-legend").hide();
        }
      }).prop('checked', showAnnualReturnsLayer);

      $("#show-vsi").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          vsiLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showVsiLayer = true;
          timelineType = "none";
          $("#vsi-legend").show();
        } else {
          showVsiLayer = false;
          cacheLastUsedLayer(vsiLayer);
          timelineType = "customUI";
          $("#vsi-legend").hide();
        }
      }).prop('checked', showVsiLayer);

      $("#show-health-impact-rcp2p6").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          healthImpactLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHealthImpactLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("health-impact-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.05);
          timelapse.setPlaybackRate(0.05);
          timelapse.setDoDwell(false);
          $("#health-impact-legend").show();
          showHealthImpactRcp[0] = true;
        } else {
          showHealthImpactRcp[0] = false;
          setActiveLayersWithTimeline(-1);
          if (!showHealthImpactRcp[1] && !showHealthImpactRcp[2] && !showHealthImpactRcp[3]) {
            showHealthImpactLayer = false;
            cacheLastUsedLayer(healthImpactLayer);
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            timelapse.setDoDwell(true);
            timelapse.setMaxScale(landsatMaxScale);
            $("#health-impact-legend").hide();
          }
        }
      }).prop('checked', showHealthImpactLayer);

      $("#show-health-impact-rcp4p5").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          healthImpactLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHealthImpactLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("health-impact-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.05);
          timelapse.setPlaybackRate(0.05);
          timelapse.setDoDwell(false);
          $("#health-impact-legend").show();
          showHealthImpactRcp[1] = true;
        } else {
          showHealthImpactRcp[1] = false;
          setActiveLayersWithTimeline(-1);
          if (!showHealthImpactRcp[0] && !showHealthImpactRcp[2] && !showHealthImpactRcp[3]) {
            showHealthImpactLayer = false;
            cacheLastUsedLayer(showHealthImpactLayer);
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            timelapse.setDoDwell(true);
            timelapse.setMaxScale(landsatMaxScale);
            $("#health-impact-legend").hide();
          }
        }
      }).prop('checked', showHealthImpactLayer);

      $("#show-health-impact-rcp6p0").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          healthImpactLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHealthImpactLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("health-impact-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.05);
          timelapse.setPlaybackRate(0.05);
          timelapse.setDoDwell(false);
          $("#health-impact-legend").show();
          showHealthImpactRcp[2] = true;
        } else {
          showHealthImpactRcp[2] = false;
          setActiveLayersWithTimeline(-1);
          if (!showHealthImpactRcp[0] && !showHealthImpactRcp[1] && !showHealthImpactRcp[3]) {
            showHealthImpactLayer = false;
            cacheLastUsedLayer(showHealthImpactLayer);
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            timelapse.setDoDwell(true);
            timelapse.setMaxScale(landsatMaxScale);
            $("#health-impact-legend").hide();
          }
        }
      }).prop('checked', showHealthImpactLayer);

      $("#show-health-impact-rcp8p5").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          healthImpactLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHealthImpactLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("health-impact-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.05);
          timelapse.setPlaybackRate(0.05);
          $("#health-impact-legend").show();
          showHealthImpactRcp[3] = true;
        } else {
          showHealthImpactRcp[3] = false;
          setActiveLayersWithTimeline(-1);
          if (!showHealthImpactRcp[0] && !showHealthImpactRcp[1] && !showHealthImpactRcp[2]) {
            showHealthImpactLayer = false;
            cacheLastUsedLayer(showHealthImpactLayer);
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setMasterPlaybackRate(1);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            timelapse.setDoDwell(true);
            timelapse.setMaxScale(landsatMaxScale);
            $("#health-impact-legend").hide();
          }
        }
      }).prop('checked', showHealthImpactLayer);

      $("#show-zika").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          zikaLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showZikaLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          // TODO: Hack timeline to show all of 2016 for Zika
          requestNewTimeline("zika-times.json", timelineType);
          $("#zika-legend").show();
        } else {
          showZikaLayer = false;
          cacheLastUsedLayer(showZikaLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#zika-legend").hide();
        }
      }).prop('checked', showZikaLayer);

      $("#show-dengue").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          dengueLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showDengueLayer = true;
          timelineType = "customUI";
          setActiveLayersWithTimeline(1);
          $("#dengue-legend").show();
        } else {
          showDengueLayer = false;
          cacheLastUsedLayer(dengueLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#dengue-legend").hide();
        }
      }).prop('checked', showDengueLayer);

      $("#show-chiku").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          chikuLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showChikuLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          $("#chiku-legend").show();
        } else {
          showChikuLayer = false;
          cacheLastUsedLayer(chikuLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#chiku-legend").hide();
        }
      }).prop('checked', showChikuLayer);

      $("#show-sea-level-rise-1p0").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          seaLevelRiseLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-sea-level-rise-1p5").prop('checked')) {
            $("#show-sea-level-rise-1p5").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-2p0").prop('checked')) {
            $("#show-sea-level-rise-2p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-4p0").prop('checked')) {
            $("#show-sea-level-rise-4p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          showSeaLevelRiseLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sea-level-rise-1p0-times.json", timelineType);
          $("#sea-level-rise-legend").show();
        } else {
          showSeaLevelRiseLayer = false;
          cacheLastUsedLayer(seaLevelRiseLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#sea-level-rise-legend").hide();
        }
      }).prop('checked', showSeaLevelRiseLayer);

      $("#show-sea-level-rise-1p5").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          seaLevelRiseLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-sea-level-rise-1p0").prop('checked')) {
            $("#show-sea-level-rise-1p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-2p0").prop('checked')) {
            $("#show-sea-level-rise-2p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-4p0").prop('checked')) {
            $("#show-sea-level-rise-4p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          showSeaLevelRiseLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sea-level-rise-1p5-times.json", timelineType);
          $("#sea-level-rise-legend").show();
        } else {
          showSeaLevelRiseLayer = false;
          cacheLastUsedLayer(seaLevelRiseLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#sea-level-rise-legend").hide();
        }
      }).prop('checked', showSeaLevelRiseLayer);

      $("#show-sea-level-rise-2p0").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          seaLevelRiseLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-sea-level-rise-1p0").prop('checked')) {
            $("#show-sea-level-rise-1p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-1p5").prop('checked')) {
            $("#show-sea-level-rise-1p5").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-4p0").prop('checked')) {
            $("#show-sea-level-rise-4p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          showSeaLevelRiseLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sea-level-rise-2p0-times.json", timelineType);
          $("#sea-level-rise-legend").show();
        } else {
          showSeaLevelRiseLayer = false;
          cacheLastUsedLayer(seaLevelRiseLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#sea-level-rise-legend").hide();
        }
      }).prop('checked', showSeaLevelRiseLayer);

      $("#show-sea-level-rise-4p0").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          seaLevelRiseLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-sea-level-rise-1p0").prop('checked')) {
            $("#show-sea-level-rise-1p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-2p0").prop('checked')) {
            $("#show-sea-level-rise-2p0").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          if ($("#show-sea-level-rise-1p5").prop('checked')) {
            $("#show-sea-level-rise-1p5").prop('checked', false);
            setActiveLayersWithTimeline(-1);
          }
          showSeaLevelRiseLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sea-level-rise-times.json", timelineType);
          $("#sea-level-rise-legend").show();
        } else {
          showSeaLevelRiseLayer = false;
          cacheLastUsedLayer(seaLevelRiseLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#sea-level-rise-legend").hide();
        }
      }).prop('checked', showSeaLevelRiseLayer);

      $("#show-urban-fragility").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          urbanFragilityLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showUrbanFragilityLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("urban-fragility-times.json", timelineType);
          $("#urban-fragility-legend").show();
        } else {
          showUrbanFragilityLayer = false;
          cacheLastUsedLayer(urbanFragilityLayer);
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#urban-fragility-legend").hide();
        }
      }).prop('checked', showUrbanFragilityLayer);

      $("#show-gtd").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          gtdLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showGtdLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          $("#gtd-legend").show();
        } else {
          showGtdLayer = false;
          cacheLastUsedLayer(gtdLayer);
          setActiveLayersWithTimeline(-1);
          $("#gtd-legend").hide();
        }
      }).prop('checked', showGtdLayer);

      $("#show-uppsala-conflict").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          uppsalaConflictLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showUppsalaConflictLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("uppsala-conflict-times.json", timelineType);
          $("#uppsala-conflict-legend").show();
        } else {
          showUppsalaConflictLayer = false;
          cacheLastUsedLayer(uppsalaConflictLayer);
          setActiveLayersWithTimeline(-1);
          $("#uppsala-conflict-legend").hide();
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
        }
      }).prop('checked', showUppsalaConflictLayer);

      $("#show-hiv").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          hivLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showHivLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("hiv-times.json", timelineType);
          timelapse.setPlaybackRate(0.5);
          $("#hiv-legend").show();
        } else {
          showHivLayer = false;
          cacheLastUsedLayer(hivLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#hiv-legend").hide();
        }
      }).prop('checked', showHivLayer);

      $("#show-obesity").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          obesityLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showObesityLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("obesity-times.json", timelineType);
          timelapse.setMasterPlaybackRate(2);
          timelapse.setPlaybackRate(2);
          $("#obesity-legend").show();
        } else {
          showObesityLayer = false;
          cacheLastUsedLayer(obesityLayer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#obesity-legend").hide();
        }
      }).prop('checked', showObesityLayer);

      $("#show-vaccine-confidence-q1").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          vaccineConfidenceLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-vaccine-confidence-q2").prop('checked')) {
            $("#show-vaccine-confidence-q2").prop('checked', false);
            $("#vaccine-confidence-q2-legend").hide();
          }
          if ($("#show-vaccine-confidence-q3").prop('checked')) {
            $("#show-vaccine-confidence-q3").prop('checked', false);
            $("#vaccine-confidence-q3-legend").hide();
          }
          if ($("#show-vaccine-confidence-q4").prop('checked')) {
            $("#show-vaccine-confidence-q4").prop('checked', false);
            $("#vaccine-confidence-q4-legend").hide();
          }
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showVaccineConfidenceLayer = true;
          timelineType = "none";
          $("#vaccine-confidence-q1-legend").show();
        } else {
          showVaccineConfidenceLayer = false;
          cacheLastUsedLayer(vaccineConfidenceLayer);
          timelineType = "customUI";
          $("#vaccine-confidence-q1-legend").hide();
        }
      }).prop('checked', showVaccineConfidenceLayer);

      $("#show-vaccine-confidence-q2").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          vaccineConfidenceLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-vaccine-confidence-q1").prop('checked')) {
            $("#show-vaccine-confidence-q1").prop('checked', false);
            $("#vaccine-confidence-q1-legend").hide();
          }
          if ($("#show-vaccine-confidence-q3").prop('checked')) {
            $("#show-vaccine-confidence-q3").prop('checked', false);
            $("#vaccine-confidence-q3-legend").hide();
          }
          if ($("#show-vaccine-confidence-q4").prop('checked')) {
            $("#show-vaccine-confidence-q4").prop('checked', false);
            $("#vaccine-confidence-q4-legend").hide();
          }
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showVaccineConfidenceLayer = true;
          timelineType = "none";
          $("#vaccine-confidence-q2-legend").show();
        } else {
          showVaccineConfidenceLayer = false;
          cacheLastUsedLayer(vaccineConfidenceLayer);
          timelineType = "customUI";
          $("#vaccine-confidence-q2-legend").hide();
        }
      }).prop('checked', showVaccineConfidenceLayer);

      $("#show-vaccine-confidence-q3").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          vaccineConfidenceLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-vaccine-confidence-q1").prop('checked')) {
            $("#show-vaccine-confidence-q1").prop('checked', false);
            $("#vaccine-confidence-q1-legend").hide();
          }
          if ($("#show-vaccine-confidence-q2").prop('checked')) {
            $("#show-vaccine-confidence-q2").prop('checked', false);
            $("#vaccine-confidence-q2-legend").hide();
          }
          if ($("#show-vaccine-confidence-q4").prop('checked')) {
            $("#show-vaccine-confidence-q4").prop('checked', false);
            $("#vaccine-confidence-q4-legend").hide();
          }
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showVaccineConfidenceLayer = true;
          timelineType = "none";
          $("#vaccine-confidence-q3-legend").show();
        } else {
          showVaccineConfidenceLayer = false;
          cacheLastUsedLayer(vaccineConfidenceLayer);
          timelineType = "customUI";
          $("#vaccine-confidence-q3-legend").hide();
        }
      }).prop('checked', showVaccineConfidenceLayer);

      $("#show-vaccine-confidence-q4").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          vaccineConfidenceLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if ($("#show-vaccine-confidence-q1").prop('checked')) {
            $("#show-vaccine-confidence-q1").prop('checked', false);
            $("#vaccine-confidence-q1-legend").hide();
          }
          if ($("#show-vaccine-confidence-q3").prop('checked')) {
            $("#show-vaccine-confidence-q3").prop('checked', false);
            $("#vaccine-confidence-q3-legend").hide();
          }
          if ($("#show-vaccine-confidence-q2").prop('checked')) {
            $("#show-vaccine-confidence-q2").prop('checked', false);
            $("#vaccine-confidence-q2-legend").hide();
          }
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showVaccineConfidenceLayer = true;
          timelineType = "none";
          $("#vaccine-confidence-q4-legend").show();
        } else {
          showVaccineConfidenceLayer = false;
          cacheLastUsedLayer(vaccineConfidenceLayer);
          timelineType = "customUI";
          $("#vaccine-confidence-q4-legend").hide();
        }
      }).prop('checked', showVaccineConfidenceLayer);

      $("#show-ebola-deaths").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          ebolaDeathsLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showEbolaDeathsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("ebola-times.json", timelineType);
          timelapse.setPlaybackRate(1);
          $("#ebola-deaths-legend").show();
        } else {
          showEbolaDeathsLayer = false;
          cacheLastUsedLayer(ebolaDeathsLayer);
          setActiveLayersWithTimeline(-1);
          if (!$("#show-ebola-cases").prop('checked') && !$("#show-ebola-new-cases").prop('checked')) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
          $("#ebola-deaths-legend").hide();
        }
      }).prop('checked', showEbolaDeathsLayer);

      $("#show-ebola-cases").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          ebolaCasesLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showEbolaCasesLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("ebola-times.json", timelineType);
          timelapse.setPlaybackRate(1);
          $("#ebola-cases-legend").show();
        } else {
          showEbolaCasesLayer = false;
          cacheLastUsedLayer(ebolaCasesLayer);
          setActiveLayersWithTimeline(-1);
          if (!$("#show-ebola-deaths").prop('checked') && !$("#show-ebola-new-cases").prop('checked')) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
          $("#ebola-cases-legend").hide();
        }
      }).prop('checked', showEbolaCasesLayer);

      $("#show-ebola-new-cases").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          ebolaNewCasesLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showEbolaNewCasesLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("ebola-times.json", timelineType);
          timelapse.setPlaybackRate(1);
          $("#ebola-new-cases-legend").show();
        } else {
          showEbolaNewCasesLayer = false;
          cacheLastUsedLayer(ebolaNewCasesLayer);
          setActiveLayersWithTimeline(-1);
          if (!$("#show-ebola-deaths").prop('checked') && !$("#show-ebola-cases").prop('checked')) {
            timelineType = "customUI";
            requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
          }
          $("#ebola-new-cases-legend").hide();
        }
      }).prop('checked', showEbolaNewCasesLayer);

      $("#show-lodes").on("click", function() {
        initLodesGui();
        var dg = document.getElementsByClassName("dg ac")[0];
        var $this = $(this);
        if ($this.prop('checked')) {
          lodesLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          if (visibleBaseMapLayer != "light") {
            $("#light-base").click();
          }
          dg["style"]["display"] = "block";
          showLodesLayer = true;
          timelineType = "none";
          $("#lodes-legend").show();
        } else {
          showLodesLayer = false;
          cacheLastUsedLayer(lodesLayer);
          dg["style"]["display"] = "none";
          doSwitchToLandsat();
          $("#lodes-legend").hide();
        }
      }).prop('checked', showLodesLayer);

      $("#show-cumulative-active-mining").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          cumulativeActiveMiningLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showCumulativeActiveMiningLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          $("#cumulative-active-mining-legend").show();
        } else {
          showCumulativeActiveMiningLayer = false;
          cacheLastUsedLayer(cumulativeActiveMiningLayer);
          setActiveLayersWithTimeline(-1);
          $("#cumulative-active-mining-legend").hide();
        }
      }).prop('checked', showCumulativeActiveMiningLayer);

      $("#show-iraq-iom-idp").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          iomIdpLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("iraq-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showIrqIdps'] = true;
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showIrqIdps'] = false;
          if (Object.values(iomIdpLayer.options).indexOf(true) == -1) {
            iomIdpLayer.destroy();
          }
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-syria-iom-idp").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          iomIdpLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("syria-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showSyrIdps'] = true;
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showSyrIdps'] = false;
          if (Object.values(iomIdpLayer.options).indexOf(true) == -1) {
            iomIdpLayer.destroy();
          }
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-yemen-iom-idp").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          iomIdpLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("yemen-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showYemIdps'] = true;
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showYemIdps'] = false;
          if (Object.values(iomIdpLayer.options).indexOf(true) == -1) {
            iomIdpLayer.destroy();
          }
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-libya-iom-idp").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          iomIdpLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("libya-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showLbyIdps'] = true;
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showLbyIdps'] = false;
          if (Object.values(iomIdpLayer.options).indexOf(true) == -1) {
            iomIdpLayer.destroy();
          }
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-iraq-iom-return").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          iomIdpLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("iraq-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showIrqReturns'] = true;
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
        } else {
          showIomIdpLayer = false;
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showIrqReturns'] = false;
          if (Object.values(iomIdpLayer.options).indexOf(true) == -1) {
            iomIdpLayer.destroy();
          }
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-syria-iom-return").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          iomIdpLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("syria-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showSyrReturns'] = true;
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
        } else {
          showIomIdpLayer = false;
          timelineType = "customUI";
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showSyrReturns'] = false;
          if (Object.values(iomIdpLayer.options).indexOf(true) == -1) {
            iomIdpLayer.destroy();
          }
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-yemen-iom-return").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          iomIdpLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("yemen-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showYemReturns'] = true;
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
        } else {
          showIomIdpLayer = false;
          timelineType = "customUI";
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showYemReturns'] = false;
          if (Object.values(iomIdpLayer.options).indexOf(true) == -1) {
            iomIdpLayer.destroy();
          }
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-libya-iom-return").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          iomIdpLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIomIdpLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("libya-iom-idp-times.json", timelineType);
          $("#iom-idp-legend").show();
          iomIdpLayer.options['showLbyReturns'] = true;
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
        } else {
          showIomIdpLayer = false;
          timelineType = "customUI";
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          if (!$("#show-iraq-iom-idp").prop('checked') && !$("#show-syria-iom-idp").prop('checked') && !$("#show-libya-iom-idp").prop('checked') && !$("#show-yemen-iom-idp").prop('checked') && !$("#show-iraq-iom-return").prop('checked') && !$("#show-syria-iom-return").prop('checked') && !$("#show-libya-iom-return").prop('checked') && !$("#show-yemen-iom-return").prop('checked'))
            $("#iom-idp-legend").hide();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          iomIdpLayer.options['showLbyReturns'] = false;
          if (Object.values(iomIdpLayer.options).indexOf(true) == -1) {
            iomIdpLayer.destroy();
          }
        }
      }).prop('checked', showIomIdpLayer);

      $("#show-omi-no2").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          omiNo2Layer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showOmiNo2Layer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("omi-no2-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(12);
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
          $("#omi-no2-legend").show();
        } else {
          showOmiNo2Layer = false;
          cacheLastUsedLayer(omiNo2Layer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#omi-no2-legend").hide();
        }
      }).prop('checked', showOmiNo2Layer);

      $("#show-be-pm25").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          bePm25Layer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showBePm25Layer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "defaultUI";
          requestNewTimeline("be-pm25-times.json", timelineType);
          var v = timelapse.getVideoset();
          v.setFps(22);
          timelapse.setMasterPlaybackRate(0.5);
          timelapse.setPlaybackRate(0.1);
          $("#be-pm25-legend").show();
        } else {
          showBePm25Layer = false;
          cacheLastUsedLayer(bePm25Layer);
          setActiveLayersWithTimeline(-1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          var v = timelapse.getVideoset();
          v.setFps(10);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          $("#be-pm25-legend").hide();
        }
      }).prop('checked', showBePm25Layer);

      $("#show-china-aviation").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          chinaAviationLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showChinaAviationLayer = true;
          $("#china-aviation-legend").show();
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
        } else {
          showChinaAviationLayer = false;
          cacheLastUsedLayer(chinaAviationLayer);
          $("#china-aviation-legend").hide();
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
        }
      }).prop('checked', showChinaAviationLayer);

      $("#show-china-power-plants").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          chinaPowerPlantsLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showChinaPowerPlantsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          //requestNewTimeline("china-power-plants-times.json", timelineType);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#china-power-plants-legend").show();
        } else {
          showChinaPowerPlantsLayer = false;
          cacheLastUsedLayer(chinaPowerPlantsLayer);
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#china-power-plants-legend").hide();
        }
      }).prop('checked', showChinaPowerPlantsLayer);

      $("#show-china-reservoirs").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          chinaReservoirsLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showChinaReservoirsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("china-reservoirs-times.json", timelineType);
          $("#china-reservoirs-legend").show();
        } else {
          showChinaReservoirsLayer = false;
          cacheLastUsedLayer(chinaReservoirsLayer);
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#china-reservoirs-legend").hide();
        }
      }).prop('checked', showChinaReservoirsLayer);

      $("#show-china-waste-treatment-plants").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          chinaWasteTreatmentPlantsLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showChinaWasteTreatmentPlantsLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          //requestNewTimeline("china-waste-treatment-plants-times.json", timelineType);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);

          $("#china-waste-treatment-plants-legend").show();
        } else {
          showChinaWasteTreatmentPlantsLayer = false;
          cacheLastUsedLayer(chinaWasteTreatmentPlantsLayer);
          setActiveLayersWithTimeline(-1);
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#china-waste-treatment-plants-legend").hide();
        }
      }).prop('checked', showChinaWasteTreatmentPlantsLayer);

      $("#show-expanding-cities").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          expandingCitiesLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showExpandingCitiesLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("expanding-cities-times.json", timelineType);
          $("#expanding-cities-legend").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          showTile = false;
          $("#baseLayerCreditContainer").hide();
        } else {
          showExpandingCitiesLayer = false;
          cacheLastUsedLayer(expandingCitiesLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#expanding-cities-legend").hide();
          showTile = true;
          $("#baseLayerCreditContainer").show();
        }
      }).prop('checked', showExpandingCitiesLayer);

      $("#show-irena-solar").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          irenaSolarLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIrenaSolarLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("irena-solar-times.json", timelineType);
          $("#irena-legend").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showIrenaSolarLayer = false;
          cacheLastUsedLayer(irenaSolarLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-irena-wind").prop('checked')) {
            $("#irena-legend").hide();
          }
        }
      }).prop('checked', showIrenaSolarLayer);

      $("#show-irena-wind").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          irenaWindLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showIrenaWindLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("irena-wind-times.json", timelineType);
          $("#irena-legend").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showIrenaWindLayer = false;
          cacheLastUsedLayer(irenaWindLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-irena-solar").prop('checked')) {
            $("#irena-legend").hide();
          }
        }
      }).prop('checked', showIrenaWindLayer);

      $("#show-carbon-price-risk").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          carbonPriceRiskLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showCarbonPriceRiskLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("carbon-price-risk-times.json", timelineType);
          $("#carbon-price-risk-legend").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showCarbonPriceRiskLayer = false;
          cacheLastUsedLayer(carbonPriceRiskLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          $("#carbon-price-risk-legend").hide();
        }
      }).prop('checked', showCarbonPriceRiskLayer);

      for (var i = 0; i < carbonPriceRisk.sectors.length; i++) {
        carbonPriceRisk.enableSelect(i);
      }

      $("#show-tsip").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          tsipLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showTsipLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("tsip-times.json", timelineType);
          $("#tsip-legend").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showTsipLayer = false;
          cacheLastUsedLayer(tsipLayer);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-tsip").prop('checked')) {
            $("#tsip-legend").hide();
          }
        }
      }).prop('checked', showTsipLayer);

      $("#show-sp-crude").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          spCrudeLayer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSpCrudeLayer = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.005);
          timelapse.setPlaybackRate(0.00225);
          $("#sp-crude-legend").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayer = false;
          cacheLastUsedLayer(spCrudeLayer);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude").prop('checked')) {
            $("#sp-crude-legend").hide();
          }
        }
      }).prop('checked', showSpCrudeLayer);

      $("#show-sp-crude_Oceania").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          spCrudeLayerOceania.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSpCrudeLayerOceania = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.005);
          timelapse.setPlaybackRate(0.00225);
          $("#sp-crude-legend_Oceania").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerOceania = false;
          cacheLastUsedLayer(spCrudeLayerOceania);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_Oceania").prop('checked')) {
            $("#sp-crude-legend_Oceania").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerOceania);

      $("#show-sp-crude_AG").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          spCrudeLayerAG.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSpCrudeLayerAG = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.005);
          timelapse.setPlaybackRate(0.00225);
          $("#sp-crude-legend_AG").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerAG = false;
          cacheLastUsedLayer(spCrudeLayerAG);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_AG").prop('checked')) {
            $("#sp-crude-legend_AG").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerAG);

      $("#show-sp-crude_WAF").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          spCrudeLayerWAF.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSpCrudeLayerWAF = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.005);
          timelapse.setPlaybackRate(0.00225);
          $("#sp-crude-legend_WAF").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerWAF = false;
          cacheLastUsedLayer(spCrudeLayerWAF);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_WAF").prop('checked')) {
            $("#sp-crude-legend_WAF").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerWAF);

      $("#show-sp-crude_MedNAF").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          spCrudeLayerMedNAF.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSpCrudeLayerMedNAF = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.005);
          timelapse.setPlaybackRate(0.00225);
          $("#sp-crude-legend_MedNAF").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerMedNAF = false;
          cacheLastUsedLayer(spCrudeLayerMedNAF);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_MedNAF").prop('checked')) {
            $("#sp-crude-legend_MedNAF").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerMedNAF);

      $("#show-sp-crude_Urals").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          spCrudeLayerUrals.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSpCrudeLayerUrals = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.005);
          timelapse.setPlaybackRate(0.00225);
          $("#sp-crude-legend_Urals").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerUrals = false;
          cacheLastUsedLayer(spCrudeLayerUrals);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_Urals").prop('checked')) {
            $("#sp-crude-legend_Urals").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerUrals);

      $("#show-sp-crude_USGC").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          spCrudeLayerUSGC.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSpCrudeLayerUSGC = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.005);
          timelapse.setPlaybackRate(0.00225);
          $("#sp-crude-legend_USGC").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerUSGC = false;
          cacheLastUsedLayer(spCrudeLayerUSGC);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_USGC").prop('checked')) {
            $("#sp-crude-legend_USGC").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerUSGC);

      $("#show-sp-crude_LatAM").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          spCrudeLayerLatAM.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSpCrudeLayerLatAM = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.005);
          timelapse.setPlaybackRate(0.00225);
          $("#sp-crude-legend_LatAM").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerLatAM = false;
          cacheLastUsedLayer(spCrudeLayerLatAM);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_LatAM").prop('checked')) {
            $("#sp-crude-legend_LatAM").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerLatAM);

      $("#show-sp-crude_NS").on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          spCrudeLayerNS.getTileView().handleTileLoading({layerDomId: $this[0].id});
          showSpCrudeLayerNS = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(0.005);
          timelapse.setPlaybackRate(0.00225);
          $("#sp-crude-legend_NS").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerNS = false;
          cacheLastUsedLayer(spCrudeLayerNS);
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_NS").prop('checked')) {
            $("#sp-crude-legend_NS").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerNS);

/*
      $("#show-sp-crude_WAF").on("click", function() {
        if ($(this).prop('checked')) {
          showSpCrudeLayerWAF = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.005);
          timelapse.setPlaybackRate(.00225);
          $("#sp-crude-legend_WAF").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerWAF = false;
          spCrudeLayerWAF.destroy();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_WAF").prop('checked')) {
            $("#sp-crude-legend_WAF").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerWAF);

      $("#show-sp-crude_NAF").on("click", function() {
        if ($(this).prop('checked')) {
          showSpCrudeLayerNAF = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.005);
          timelapse.setPlaybackRate(.00225);
          $("#sp-crude-legend_NAF").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerNAF = false;
          spCrudeLayerNAF.destroy();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_NAF").prop('checked')) {
            $("#sp-crude-legend_NAF").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerNAF);

      $("#show-sp-crude_ME").on("click", function() {
        if ($(this).prop('checked')) {
          showSpCrudeLayerME = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.005);
          timelapse.setPlaybackRate(.00225);
          $("#sp-crude-legend_ME").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerME = false;
          spCrudeLayerME.destroy();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_ME").prop('checked')) {
            $("#sp-crude-legend_ME").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerME);

      $("#show-sp-crude_US").on("click", function() {
        if ($(this).prop('checked')) {
          showSpCrudeLayerUS = true;
          setActiveLayersWithTimeline(1);
          timelineType = "customUI";
          requestNewTimeline("sp-crude-us-times.json", timelineType);
          timelapse.setMasterPlaybackRate(.005);
          timelapse.setPlaybackRate(.00225);
          $("#sp-crude-legend_US").show();
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
        } else {
          showSpCrudeLayerUS = false;
          spCrudeLayerUS.destroy();
          timelapse.setMasterPlaybackRate(1);
          timelapse.setPlaybackRate(defaultPlaybackSpeed);
          setActiveLayersWithTimeline(-1);
          doSwitchToLandsat();
          if (!$("#show-sp-crude_US").prop('checked')) {
            $("#sp-crude-legend_US").hide();
          }
        }
      }).prop('checked', showSpCrudeLayerUS);
*/
      // Base layers
      $("input:radio[name=base-layers]").on("click", function() {
        previousVisibleBaseMapLayer = visibleBaseMapLayer;
        visibleBaseMapLayer = $(this).val();
        if (visibleBaseMapLayer == "landsat") {
          $("#baselayerCreditText").html("&copy; Google");
        } else if (visibleBaseMapLayer == "light") {
          if (useGoogleMaps) {
            $("#baselayerCreditText").html("&copy; Google");
            //$("#baselayerCreditText").html("&copy; Google (Dashed gray line indicates disputed borders)");
          } else {
            $("#baselayerCreditText").html("&copy; OpenMapTiles, &copy; OpenStreetMap");
          }
        } else if (visibleBaseMapLayer == "dark") {
          if (useGoogleMaps) {
            $("#baselayerCreditText").html("&copy; Google");
            //$("#baselayerCreditText").html("&copy; Google (Dashed gray line indicates disputed borders)");
          } else {
            $("#baselayerCreditText").html("&copy; OpenMapTiles, &copy; OpenStreetMap");
          }
        }
        if (visibleBaseMapLayer == "landsat" && previousVisibleBaseMapLayer != "landsat") {
          timelapse.setMaxScale(landsatMaxScale);
          setActiveLayersWithTimeline(1);
          if (!showViirsLayer) {
            timelineType = "customUI";
          }
        } else if (visibleBaseMapLayer != "landsat") {
          timelapse.setMaxScale(rasterMapTileMaxScale);
          if (previousVisibleBaseMapLayer == "landsat")
            setActiveLayersWithTimeline(-1);
          timelineType = "none";
        }
      });

      // Initially set activeLayersWithTimeline to 1 if we first load with landsat enabled.
      // Also set the custom scale.
      if (visibleBaseMapLayer == "landsat") {
        activeLayersWithTimeline = 1;
        timelapse.setMaxScale(landsatMaxScale);
      }

      // Copy over data attributes to selectmenu
      $.widget("ui.selectmenu", $.ui.selectmenu, {
        _renderItem: function(ul, item) {
          var elementdata = item.element.context.dataset;
          var attributesObj = {};
          Object.keys(elementdata).forEach(function(x) {
            attributesObj["data-" + x] = elementdata[x];
          });
          return $('<li>')
            .attr(attributesObj)
            .append(item.label)
            .appendTo(ul);
        }
      });

      var appendTarget = "#timeMachine";
      if (enableLetterboxMode) {
        appendTarget = "#letterbox-content";
      }
      $("#extras-selector").selectmenu({
        close: function() {
          $lastSelectedExtra = null;
        },
        position: {
          at: "left top",
          collision: 'flip',
          using: function(coords, feedback) {
            // Using 'flip' above, we ensure that the menu either draws up or down, depending upon how much space we have.
            // Then we place the default select option at either the begining or end based on this direction.
            $("#extras-selector option[id='default-extras-select']").remove();
            $(this).css({
              top: coords.top,
              left: coords.left
            });
            if (feedback.vertical == "top")
              $("#extras-selector").prepend('<option id="default-extras-select" selected="selected" value="select">Select extra content...</option>');
            else
              $("#extras-selector").append('<option id="default-extras-select" selected="selected" value="select">Select extra content...</option>');
            $("#extras-selector").selectmenu("refresh");
          }
        },
        appendTo: appendTarget
      });

      // Use click event rather than selectmenu 'change' since that event is not registered on the touch screen.
      $(".ui-selectmenu-menu").on("click", "li", function(e) {
        $lastSelectedExtra = $(e.currentTarget);
        // Reset automode timer, since clicking a waypoint now closes the extras pop-up.
        if (snaplapseViewerForPresentationSlider) {
          snaplapseViewerForPresentationSlider.startAutoModeIdleTimeout();
        }
        var fileName = $(e.currentTarget).data("filename");
        var fileType = $(e.currentTarget).data("type");
        $("#extras-content").dialog('option', 'title', $(e.currentTarget).text());
        var $extrasHtml = "";
        if (fileType == "image") {
          $extrasHtml = '<img src="../../../extras/' + fileName + '">';
          $("#extras-content").html($extrasHtml).dialog("open");
        } else if (fileType == "video") {
          $extrasHtml = '<video id="extras-video" src="../../../extras/' + fileName + '" controls autoplay></video>';
          $("#extras-content").html($extrasHtml).dialog("open");
          $("#extras-video")[0].playbackRate = $(e.currentTarget).data("fileplaybackrate");
          $("#extras-video").gVideo({
            childtheme: 'smalldark'
          });
        } else if (fileType == "iframe") {
          $extrasHtml = '<iframe style="border: 0px; scrolling: no; width: 100%; height: 100%" src="' + $(e.currentTarget).data("linkpath") + '"></iframe>';
          $("#extras-content").html($extrasHtml).dialog("open");
        } else if (fileType == "img") {
          $extrasHtml = '<img id="extras-img" height="100%" style="display: block; margin: 0 auto;" src="../../../extras/' + $(e.currentTarget).data("linkpath") + '">';
          $("#extras-content").html($extrasHtml).dialog("open");
        } else if (fileType == "link") {
          window.location.href = $(e.currentTarget).data("linkpath");
        }
      });

      $("#extras-content").dialog({
        appendTo: "#timeMachine",
        modal: false,
        autoOpen: false,
        draggable: false,
        resizable: false,
        dialogClass: "extras-content-video",
        open: function(event, ui) {
          $("#timeMachine").removeClass("presentationSliderSelection presentationSliderSelectionOverflow");
        },
        close: function(event, ui) {
          $lastSelectedExtra = null;
        },
        beforeClose: function(event, ui) {
          var $extrasVideo = $("#extras-video");
          if ($extrasVideo && $extrasVideo[0]) {
            $extrasVideo[0].pause();
            $extrasVideo[0].src = "";
          }
          $("#extras-selector").val("select").selectmenu('refresh');
        }
      }).css({
        'z-index': '2000',
        'left': '0px',
        'top': '0px'
      });

      $(document).keydown(function(e) {
        var fromRealKeydown = e.originalEvent && e.pageX != 0 && e.pageY != 0;
        if ((e.target.id == 'location_search' || ($(".ui-dialog").is(":visible") && $("#dialog-extend-fixed-container").children().length == 0)) && !!fromRealKeydown) return;

        // 'page up' key
        // Quick way to step forward through waypoints
        if (!disablePresentationSlider && e.keyCode === 33) {
          var selectedIdx = 0;
          var $selectedWaypoint = $(".snaplapse_keyframe_list .thumbnail_highlight");
          if ($selectedWaypoint.length > 0) {
            selectedIdx = $selectedWaypoint.parents(".snaplapse_keyframe_list_item").index();
            selectedIdx++;
            if (selectedIdx > $(".snaplapse_keyframe_list").children().last().index()) {
              selectedIdx = 0;
            }
          }
          $(".snaplapse_keyframe_list").children().eq(selectedIdx).children().first().trigger("click");
        }

        // 'page down' key
        // Quick way to step backwards through waypoints
        if (!disablePresentationSlider && e.keyCode === 34) {
          var lastWaypointIdx, selectedIdx;
          lastWaypointIdx = selectedIdx = $(".snaplapse_keyframe_list").children().last().index();
          var $selectedWaypoint = $(".snaplapse_keyframe_list .thumbnail_highlight");
          if ($selectedWaypoint.length) {
            selectedIdx = $selectedWaypoint.parents(".snaplapse_keyframe_list_item").index();
            selectedIdx--;
            if (selectedIdx < 0) {
              selectedIdx = lastWaypointIdx;
            }
          }
          $(".snaplapse_keyframe_list").children().eq(selectedIdx).children().first().trigger("click");
        }

        // 'tab' or 'enter' key
        // Quick way to toggle play/pause
        if (usePresentationClicker) {
          if (e.keyCode === 9 || e.keyCode === 13) {
            timelapse.handlePlayPause();
          }
        }

        // 'a' key
        // Quick way to stop animating and go to the beginning
        if (e.keyCode === 65) {
          if (!timelapse.isPaused()) {
            timelapse.handlePlayPause();
          }
          timelapse.seek(0);
        }
        // 's' key
        // Quick way to stop animating and go to the end
        if (e.keyCode === 83 && keysDown.length == 0) {
          if (!timelapse.isPaused()) {
            timelapse.handlePlayPause();
          }
          timelapse.seek(timelapse.getDuration());
        }
        // 'c' key and share view dialog is not visible
        // Quick way to clear all layers
        if (e.keyCode === 67) {
          $(".map-layer-div").find("input:checked").trigger("click");
          var openCategories = $("h3.ui-accordion-header.ui-state-active");
          var availableCategories = $(".map-layer-div").children("h3");
          $.each(openCategories, function(index, value) {
            if (index == 0) return;
            var openIndex = availableCategories.index(openCategories[index]);
            $(".map-layer-div").accordion("option", "active", openIndex);
          });
          $(".current-location-text-container").hide();
          $(".snaplapse_keyframe_list_item_thumbnail_overlay_presentation.thumbnail_highlight").removeClass("thumbnail_highlight");
          $("#category-base-layers").find("input:checked").click();
        }
        // 'h' key
        // Quick way to toggle the layer panel
        if (e.keyCode === 72) {
          $("#presentation-slider-hamburger-wrapper").trigger("click");
        }
        // 'l' key (lowercase L)
        // Quick way to turn on automode
        if (e.keyCode === 76) {
          if (typeof(EarthlapseUI) !== "undefined" && enableStoryMode) {
            EarthlapseUI.Modes.revertToDefault();
          } else {
            var snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
            snaplapseForPresentationSlider.getSnaplapseViewer().initializeAndRunAutoMode();
          }
        }
        // up arrow
        // Quick way to toggle between the various items whether under the extras menu (if just selected) or a layer
        if (e.keyCode === 38) {
          if ($lastSelectedExtra) {
            $lastSelectedExtra.prev().click();
          } else {
            var $newActiveTopic = $(document.activeElement).closest($(".ui-accordion-content"));
            $lastActiveLayerTopic = $newActiveTopic.length ? $newActiveTopic : $lastActiveLayerTopic;
            var $layers = $lastActiveLayerTopic.find("input");
            if ($layers.filter(":checked").length > 1) return;
            for (var i = 0; i < $layers.length; i++) {
              if ($($layers[i]).prop('checked')) {
                $($layers[i-1]).trigger('click');
                e.preventDefault();
                break;
              }
            }
          }
        }
        // down arrow
        // Quick way to toggle between the various items whether under the extras menu (if just selected) or a layer
        if (e.keyCode === 40) {
          if ($lastSelectedExtra) {
            $lastSelectedExtra.next().click();
          } else {
            var $newActiveTopic = $(document.activeElement).closest($(".ui-accordion-content"));
            $lastActiveLayerTopic = $newActiveTopic.length ? $newActiveTopic : $lastActiveLayerTopic;
            var $layers = $lastActiveLayerTopic.find("input");
            if ($layers.filter(":checked").length > 1) return;
            for (var i = 0; i < $layers.length; i++) {
              if ($($layers[i]).prop('checked')) {
                $($layers[i+1]).trigger('click');
                e.preventDefault();
                break;
              }
            }
          }
        }
        if (keysDown.indexOf(e.keyCode) < 0) {
          keysDown.push(e.keyCode);
          // SHIFT + S + V
          // Shortcut to bring up share view dialog
          if (keysDown[0] === 16 && keysDown[1] === 83 && keysDown[2] === 86) {
            $(".share").trigger("click");
          }
        }
      }).keyup(function(e) {
        keysDown.length = 0;
      });

      $('#layers-list').on("click", "input", function(e) {
        var fromRealKeydown = e.originalEvent && e.pageX != 0 && e.pageY != 0;
        if (fromRealKeydown && $(".current-location-text-container").is(':visible')) {
          showAnnotationResumeExit();
        }
        if (isMobileDevice || isIEButNotEdge) {
          if (visibleBaseMapLayer != "landsat" || showLightsAtNightLayer || showLightsAtNight2012Layer || showLightsAtNight2016Layer || showHansenLayer2 || showVsiLayer) {
            UTIL.setDrawState(false);
          } else {
            UTIL.setDrawState(true);
          }
        }
      });

      $('#layers-list').on("change", "input", function(e) {
        if (enableLetterboxMode) {
          updateLetterboxSelections($(this));
        }
        var selectedLayers = $('.map-layer-checkbox').find("input:checked").not("#show-forest-alerts, show-forest-alerts-no-overlay, #show-himawari, #show-goes16, #show-dscovr");
        // Subtract one, since base layers are included in this count but they don't use the legend.
        var numLayersOn = selectedLayers.size() - 1;

        // Legend container toggling
        if (numLayersOn <= 0) {
          $("#layers-legend").hide();
        } else {
          $("#layers-legend").show();
        }

        if (e.originalEvent && e.pageX != 0 && e.pageY != 0 && $(this).prop('checked')) {
          UTIL.addGoogleAnalyticEvent('button', 'click', 'layer=' + $(this).prop("id"));
        }
      });

      var timelineUIHandler = function(e) {
        var $layerContainer = $(e.target).parents("table");
        var $layerContainerHeader = $layerContainer.prev();
        var $firstlayerContainerHeader = $('.map-layer-div').find("h3").first();
        var numLayersActiveInCurrentContainer = $layerContainer.find("input:checked").length;

        if ($('.map-layer-div').find("input:checked").length > 1) {
          $(".clearLayers").show();
          $("#layers-list").css("height", "calc(100% - " + ($(".clearLayers").outerHeight() -1) + "px)");
        } else {
          $(".clearLayers").hide();
          $("#layers-list").css("height", "100%");
        }

        // Add indicator that a layer is on in a category but ignore the first category (base layers)
        if ($firstlayerContainerHeader.length && $layerContainerHeader.length) {
          if (numLayersActiveInCurrentContainer > 0 && $layerContainerHeader[0].id != $firstlayerContainerHeader[0].id) {
            $layerContainerHeader.append("<span class='.ui-accordion-header-icon ui-icon ui-icon-bullet active-layers-in-category'>");
          } else {
            $layerContainerHeader.find(".active-layers-in-category").remove();
          }
        }

        var isFromUser = true;

        if (showViirsLayer || showDrillingLayer || $(".csvlayer").find("input:checked").length > 0) {
          timelineType = "defaultUI";
        }

        // Toggle off Himawari/GOES16/DSCOVR if any other layer is selected when it is up. These layers are a special mode.
        // Base layer is part of the checkbox total, hence the > 1 check.
        if ((showHimawariTimeMachineLayer || showGoes16TimeMachineLayer || showDscovrTimeMachineLayer) && $('.map-layer-checkbox').find("input:checked").not("#show-himawari, #show-goes16, #show-dscovr").length > 1) {
          if ($("#show-himawari").prop('checked')) {
            $("#show-himawari").click();
          } else if ($("#show-goes16").prop('checked')) {
            $("#show-goes16").click();
          } else if ($("#show-dscovr").prop('checked')) {
            $("#show-dscovr").click();
          }
        }

        // Hide any timelines that are visible if we have no layers up that require a timeline or we are a static layer that fully covers the entire globe
        if (activeLayersWithTimeline <= 0 || (visibleBaseMapLayer == "landsat" && activeLayersWithTimeline == 1 && (showLightsAtNightLayer || showLightsAtNight2012Layer || showLightsAtNight2016Layer || showHansenLayer2 || showVsiLayer))) {
          $(".controls, .customControl").hide();
          $(".customControl").hide();
        } else if (activeLayersWithTimeline > 0) {
          if (timelineType == "customUI") {
            $(".controls, .captureTime").hide();
            $(".customControl").show();
          } else if (timelineType == "defaultUI") {
            $(".customControl").hide();
            $(".controls, .captureTime").show();
          }
        }

        if (e && e.originalEvent) {
          var originalEvent = e.originalEvent;
          // If true, event came from user interaction, otherwise it came from javascript
          if (!originalEvent.isTrusted)
            isFromUser = false;
          // Browsers without isTrusted property
          if (originalEvent.x == 0 && originalEvent.y == 0)
            isFromUser = false;
          // IE 11
          if (originalEvent.isTrusted && (originalEvent.x == 0 && originalEvent.y == -55))
            isFromUser = false;
        }

        if ((activeLayersWithTimeline >= 1 && visibleBaseMapLayer != "landsat") ||
            (activeLayersWithTimeline == 1 && visibleBaseMapLayer == "landsat" && !(showLightsAtNightLayer || showLightsAtNight2012Layer || showLightsAtNight2016Layer || showHansenLayer2 || showVsiLayer))) {
          if (timelineType == "customUI") {
            $(".customControl").show().children().show();
          } else if (timelineType == "defaultUI") {
            $(".controls, .captureTime").show();
          }
        }

        if (isFromUser && visibleBaseMapLayer != "landsat" && activeLayersWithTimeline == 0)
          $(".customControl").hide().children().hide();

        if (timelineType == "defaultUI") {
          $(".customHelpLabel-touchFriendly").css("top", "-8px");
        } else {
          $(".customHelpLabel-touchFriendly").css("top", "-26px");
        }

        if (timelineType != "none" && activeLayersWithTimeline == 0) {
          timelineType = "none";
        }

        if (activeLayersWithTimeline <= 1 && timelineType == "none") {
          $(".current-location-text-container, .annotations-resume-exit-container, .scaleBarContainer, #logosContainer, .current-location-text, #layers-legend").addClass("noTimeline");
          if (!timelapse.isPaused()) {
            timelapse.handlePlayPause();
            timelapseWasPlaying = true;
          }
        } else {
          $(".current-location-text-container, .annotations-resume-exit-container, .scaleBarContainer, #logosContainer, .current-location-text, #layers-legend").removeClass("noTimeline");
          if (timelapseWasPlaying) {
            timelapse.play();
          }
        }

        timelineHidden = $(".noTimeline").length != 0;
      };

      $('#layers-list').on('click', 'input', timelineUIHandler);

      $("body").on("click", "#layers-list .ui-accordion-header", function() {
        lastLayerMenuScrollPos = $(this)[0].offsetTop - 120;
        $('.layers-scroll-vertical').animate({
          scrollTop: lastLayerMenuScrollPos
        });
        $lastActiveLayerTopic = $(this).next();
      });

      // Make right layers panel vertically touch scrollable.
      try {
        if (document.createEvent("TouchEvent")) {
          UTIL.verticalTouchScroll($(".layers-scroll-vertical"));
          UTIL.verticalTouchScroll($("#csvChartLegend"));
          UTIL.verticalTouchScroll($("#theme-list"));
          UTIL.touchHorizontalScroll($("#letterbox-bottom-picker-content"));
          UTIL.touchHorizontalScroll($("#letterbox-bottom-picker-results-content"));
        }
      } catch (e) {
        // Error creating touch event
      }

      // Set the starting base layer
      $('input:radio[name=base-layers][id=' + visibleBaseMapLayer + '-base]').trigger("click");

      timelapse.addTimelineUIChangeListener(function() {
        if (visibleBaseMapLayer != "landsat" && activeLayersWithTimeline == 0) {
          $(".customControl").hide().children().hide();
        }
      });
    }
    // END of initLayerToggleUI()

    function hideAnnotations() {
      $(".current-location-text-container").hide();
      lastSelectedAnnotationBeforeHidden = $(".snaplapse_keyframe_list_item_thumbnail_overlay_presentation.thumbnail_highlight");
      lastSelectedAnnotationBeforeHidden.removeClass("thumbnail_highlight");
    }

    function showAnnotations(fromResume) {
      $(".annotations-resume-exit-container").hide();
      $(".current-location-text-container").show();
      if (lastSelectedAnnotationBeforeHidden && fromResume) {
        lastSelectedAnnotationBeforeHidden.trigger("click");
      }
    }

    function showAnnotationResumeExit() {
      $(".current-location-text-container").hide();
      $(".annotations-resume-exit-container").show();
      lastSelectedAnnotationBeforeHidden = $(".snaplapse_keyframe_list_item_thumbnail_overlay_presentation.thumbnail_highlight");
      lastSelectedAnnotationBeforeHidden.removeClass("thumbnail_highlight");
    }

    function setActiveLayersWithTimeline (modifier) {
      previousActiveLayersWithTimeline = activeLayersWithTimeline;
      activeLayersWithTimeline += modifier;
      if (activeLayersWithTimeline < 0) activeLayersWithTimeline = 0;
    }

    function doSwitchToLandsat() {
      // Special case for layers with defaultUI timeline.
      if ((timelineType == "defaultUI" && (showViirsLayer || showMonthlyRefugeesLayer || showCrwTimeMachineLayer)) ||  $(".csvlayer").find("input:checked").length > 0) {
        return false;
      } else {
        timelineType = "customUI";
        requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
        timelapse.setMasterPlaybackRate(1);
        timelapse.setPlaybackRate(defaultPlaybackSpeed);
        timelapse.setDoDwell(true);
        WebglVideoTile.useGreenScreen = false;
        var v = timelapse.getVideoset();
        v.setFps(10);
        return true;
      }
    }

  </script>

  <script src="../../js/TimeMachineCanvasLayer.js" type="text/javascript"></script>
  <script src="../../js/canvasjs.min.js" type="text/javascript"></script>

  <script type="text/javascript" src="../../js/base.js"></script>
  <script type="text/javascript" src="../../js/io.js"></script>
  <script type="text/javascript" src="../../js/polyfills.js"></script>
  <script src="Legend.js"></script>
  <script src="csvFileLayer.js"></script>
  <script src="csvDataGrapher.js"></script>

  <script type="text/javascript">
    "use strict";

    // BEGIN WebGL vars
    var canvasLayer;
    var gl, glb;


    // ## 4 ##
    //// Layer visibility ////
    //

    var showWdpaLayer = false;
    var showMcrmLayer = false;
    var showHansenLayer = false;
    var showHansenLayer2 = false;
    var showViirsLayer = false;
    var showCoralBleachingLayer = false;
    var showLightsAtNightLayer = false;
    var showLightsAtNight2012Layer = false;
    var showLightsAtNight2016Layer = false;
    var showCrwTimeMachineLayer = false;
    var showNdviAnomalyTimeMachineLayer = false;
    var showAnimatedHansenLayer = false;
    var showHimawariTimeMachineLayer = false;
    var showGoes16TimeMachineLayer = false;
    var showDscovrTimeMachineLayer = false;
    var showAnnualGlobalPm25TimeMachineLayer = false;
    var showForestAlertsTimeMachineLayer = false;
    var showForestAlertsNoOverlayTimeMachineLayer = false;
    var showWaterOccurrenceLayer = false;
    var showWaterChangeLayer = false;
    var showUsgsWindTurbineLayer = false;
    var showGlobalWindPowerLayer = false;
    var showSolarInstallsLayer = false;
    var showDrillingLayer = false;
    var showMonthlyRefugeesLayer = false;
    var showAnnualRefugeesLayer = false;
    var showAnnualReturnsLayer = false;
    var showVsiLayer = false;
    var showHealthImpactLayer = false;
    var showHealthImpactRcp = [false, false, false, false]; // 2.6, 4.5, 6.0, 8.5
    var showZikaLayer = false;
    var showDengueLayer = false;
    var showChikuLayer = false;
    var showSeaLevelRiseLayer = false;
    var showUrbanFragilityLayer = false;
    var showGtdLayer = false;
    var showUppsalaConflictLayer = false;
    var showHivLayer = false;
    var showObesityLayer = false;
    var showVaccineConfidenceLayer = false;
    var showEbolaDeathsLayer = false;
    var showEbolaCasesLayer = false;
    var showEbolaNewCasesLayer = false;
    var showLodesLayer = false;
    var showCumulativeActiveMiningLayer = false;
    var showIomIdpLayer = false;
    var showBerkeleyEarthTemperatureAnomalyTimeMachineLayer = false;
    var showOmiNo2Layer = false;
    var showChinaAviationLayer = false;
    var showChinaPowerPlantsLayer = false;
    var showChinaReservoirsLayer = false;
    var showChinaWasteTreatmentPlantsLayer = false;
    var showBePm25Layer = false;
    var showCountryLabelMapLayer = false;
    var showExpandingCitiesLayer = false;
    var showIrenaSolarLayer = false;
    var showIrenaWindLayer = false;
    var showCarbonPriceRiskLayer = false;
    var showTsipLayer = false;
    var showSpCrudeLayer = false;
    var showSpCrudeLayerOceania = false;
    var showSpCrudeLayerAG = false;
    var showSpCrudeLayerWAF = false;
    var showSpCrudeLayerMedNAF = false;
    var showSpCrudeLayerUrals = false;
    var showSpCrudeLayerUSGC = false;
    var showSpCrudeLayerLatAM = false;
    var showSpCrudeLayerNS = false;
    /*
    var showSpCrudeLayerWAF = false;
    var showSpCrudeLayerNAF = false;
    var showSpCrudeLayerME = false;
    var showSpCrudeLayerUS = false;
  */

    // Default Time Machine visibility
    var tileViewVisibility = {
      videoTile: true,
      vectorTile: false
    };

    var waypointsLoadedPath;
    var csvFileLayers = new CsvFileLayer();
    var csvDataGrapher = new CsvDataGrapher();
    var dotmapLayers = [];
    var dotlayersLoadedPath;
    var csvlayersLoadedPath;
    var layersToShowOnCreation = {};

    function addDotmapLayer(nickname, name, credit, category, columnDefs) {
      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 10,
        setDataFunction: WebGLVectorTile2.prototype._setColorDotmapData,
        drawFunction: WebGLVectorTile2.prototype._drawColorDotmap,
        fragmentShader: WebGLVectorTile2.colorDotmapFragmentShader,
        vertexShader: WebGLVectorTile2.colorDotmapVertexShader,
      };

      var useLocalTiles = false;

      if (EARTH_TIMELAPSE_CONFIG.localDotmaps) {
        for (var i = 0; i < EARTH_TIMELAPSE_CONFIG.localDotmaps.length; i++) {
          if (nickname == EARTH_TIMELAPSE_CONFIG.localDotmaps[i]) {
            useLocalTiles = true;
            break;
          }
        }
      }

      var tileUrl;

      if (useLocalTiles) {
        tileUrl = rootTilePath + '/dotmaptiles/' + nickname;
      } else {
        tileUrl = 'https://dotmaptiles.createlab.org/tilesv1/';
        var layerTokens = [];
        for (var i = 0; i < columnDefs.length; i++) {
          layerTokens.push(encodeURIComponent(columnDefs[i].color) + ';' +
                           encodeURIComponent(columnDefs[i].expression.replace(/\s/g, '')));
        }
        tileUrl += layerTokens.join(';;');
      }
      tileUrl += "/{z}/{x}/{y}.bin";

      var layer = new WebglVectorLayer2(glb, canvasLayer, tileUrl, layerOptions);
      dotmapLayers.push(layer);

      var id = 'show-dotmap-' + nickname;
      var category_id = category ? "category-" + category.trim().replace(/ /g,"-").toLowerCase() : "category-us-demographics";

      var row = '<tr><td><label name="' + nickname + '">';
      row += '<input type="checkbox" id="' + id + '">';
      row += name;
      row += '</label></tr>';

      if ($('#' + category_id).length == 0) {
        $(".map-layer-div #other_table").prev("h3").before("<h3 class='dotmap'>" + category + "</h3><table class=dotmap' id='" + category_id + "'></table>");
      }

      $('#' + category_id).append(row);

      // Create and insert legend
      var legend='<tr id="' + nickname + '-legend" style="display: none"><td>';
      legend += '<div style="font-size: 17px">' + name;
      if (credit) legend += '<span class="credit">(' + credit + ')</span>';
      legend += '</div>';

      legend += '<div style="float: left; padding-right:8px">';
      for (var i = 0; i < columnDefs.length; i++) {
        legend += '<div style="float: left; padding-right:8px">';
        legend += '<div style="background-color:' + columnDefs[i].color + '; width: 12px; height: 12px; float: left; margin-top: 2px; margin-left: 8px;"></div>';
        legend += '&nbsp;' + columnDefs[i].name + '</div>';
      }
      legend += '</div>';
      legend += '</tr>';

      $('#legend-content table tr:last').after(legend);

      // Handle click event to turn on and off layer
      $('#' + id).on("click", function() {
        var $this = $(this);
        if ($this.prop('checked')) {
          layer.getTileView().handleTileLoading({layerDomId: $this[0].id});
          // Turn off other dotmap layers
          $('#' + id).prop('checked', false);
          $("[id^='show-dotmap']:checked").click();
          $('#' + id).prop('checked', true);
          // Use dark basemap
          if (visibleBaseMapLayer != "dark") {
            $("#dark-base").click();
          }
          // Turn on layer
          layer.visible = true;
          timelineType = "none";
          $("#" + nickname + "-legend").show();
        } else {
          // Turn off layer
          layer.visible = false;
          cacheLastUsedLayer(layer);
          timelineType = "customUI";
          requestNewTimeline(cachedLandsatTimeJsonPath, timelineType);
          $("#" + nickname + "-legend").hide();
        }
      }).prop('checked', layer.visible);

      if (layersToShowOnCreation[nickname]) {
        $('#' + id).click();
      }
    }

    function loadDotmapLayersFromTsv(tsvLayerDefinitions) {
      if (tsvLayerDefinitions.startsWith('Dotmap layer info')) {
        // Backwards-compatibility;  paste new header
        var header = 'Enabled\tShare link identifier\tName\tCredits\tPopName1\tColor1\tDefinition1\tPopName2\tColor2\tDefinition2\tPopName3\tColor3\tDefinition3\tPopName4\tColor4\tDefinition4\tPopName5\tColor5\tDefinition5\tPopName6\tColor6\tDefinition6\tPopName7\tColor7\tDefinition7\tPopName8\tColor8\tDefinition8\tPopName9\tColor9\tDefinition9';
        tsvLayerDefinitions = [header].concat(tsvLayerDefinitions.split('\n').slice(2)).join('\n');
      }
      var parsed = Papa.parse(tsvLayerDefinitions, {delimiter: '\t', header: true});
      var layerdefs = parsed['data'];
      for (var i = 0; i < layerdefs.length; i++) {
        var layerdef = layerdefs[i];
        if (layerdef['Enabled'].toLowerCase() == 'false') continue;
        var layerIdentifier = layerdef['Share link identifier'].replace(/\W+/g, '_'); // sanitize non-word chars

        var columnDefs = [];
        for (var c = 1; 1; c++) {
          var name = layerdef['PopName' + c];
          if (!name) break;
          var color = layerdef['Color' + c];
          var expression = layerdef['Definition' + c];
          columnDefs.push({name: name, color: color, expression: expression});
        }
        addDotmapLayer(layerIdentifier, // identifier
                       layerdef['Name'], // name
                       layerdef['Credits'], // credit
                       layerdef['Category'], // layer category
                       columnDefs);
      }
      // New layers have been added, so refresh the layer panel
      $(".map-layer-div").accordion("refresh");
      sortLayerCategories();
      if (enableLetterboxMode) {
        updateLetterboxContent();
      }
    }

    function loadDotmapLayers(path) {
      if (path == dotlayersLoadedPath) return;
      dotlayersLoadedPath = path;
      var url = path;

      // Clear out any dot map layers that have already been loaded
      $("#dotmaps_table, .dotmap").find("input:checked").trigger("click");
      $(".dotmap").remove();
      $('#custom_dotmaps_table').empty();

      if (path.indexOf(".tsv") != -1) {
        // Load local version of the dotmaps .tsv file
        $.ajax({
          url: path,
          dataType: "text",
          success: function(csvdata) {
            loadDotmapLayersFromTsv(csvdata);
          }
        });
        return;
      } else if (path.indexOf("http") != 0) {
        // docTabId DOCID.TABID, e.g. 1hFpDXOyjvjTpad7HpB0K-3thuYqSOlDJ4oExCTcscUk.358696896,
        // which would translate into https://docs.google.com/spreadsheets/d/1hFpDXOyjvjTpad7HpB0K-3thuYqSOlDJ4oExCTcscUk/edit#gid=358696896
        var docId = path.split('.')[0];
        var tabId = path.split('.')[1];
        url = 'https://docs.google.com/spreadsheets/d/' + docId + '/edit';
        if (tabId) {
          url += '#gid=' + tabId;
        }
      }
      // Load dotmaps from Google Docs
      UTIL.gdocToJSON(url, function(tsvdata) {
        loadDotmapLayersFromTsv(tsvdata);
      });
    }

    function modifyWaypointSliderContent(keyframes, theme) {
      himawariWaypoints[theme] = {};
      annotationPicturePaths[theme] = {};
      for (var i = 0; i < keyframes.length; i++) {
        var keyframe = keyframes[i];
        annotationPicturePaths[theme][i] = { path : keyframe.unsafe_string_annotationPicPath };
        // Himawari is a special case.
        // We need to store the bounds and times and then replace them with a default view.
        // The default view allows for a black thumbnail to be used on the waypoint slider instead of some random position in Landsat
        // Then when we actually click the Himawari waypoint, we load up the original bounds and time and use them.
        for (var j = 0; j < keyframe.layers.length; j++) {
          if (keyframe.layers[j] == "h8" || keyframe.layers[j] == "h8_16") {
            // Himawari keyframes made with Landsat 2015 and viewed in Landsat 2016 with reset dimensions
            // do not position correctly and need to be corrected below.
            if (landsatVersion == "2016" && keyframe.layers[j] == "h8") {
              keyframe.bounds.xmin -= 34645;
              keyframe.bounds.xmax -= 30000;
              keyframe.bounds.ymin -= 80931;
              keyframe.bounds.ymax -= 15128;
              var tmp = timelapse.pixelBoundingBoxToPixelCenter(keyframe.bounds);
              tmp.scale *= 2;
              keyframe.bounds = timelapse.pixelCenterToPixelBoundingBoxView(tmp).bbox;
            }
            himawariWaypoints[theme][i] = {
              bounds: keyframe.bounds,
              time: keyframe.time
            };
            // Fake bounds for thumbnail generating
            keyframe.bounds = himawariWaypointThumbnailBounds;
            break;
          }
        }

        // Sections in the spreadsheet to jump to are flagged by having the title start with a #
        if (keyframe.unsafe_string_frameTitle.indexOf("#") == 0) {
          keyframe.unsafe_string_frameTitle = keyframe.unsafe_string_frameTitle.slice(1);
        }
      }
    }

    function loadWaypointSliderContentFromCSV(csvdata) {
      // Clear out internal data stores and relevant dom elements
      annotationPicturePaths = {};
      himawariWaypoints = {};
      $("#theme-list").empty();
      $("#timeMachine").removeClass("presentationSliderSelection");
      var currentWaypointSliderContentUrl;

      if (enableThemeHamburgerButton) {
        // May just be a single item if there is only only one or zero themes designated
        var waypointJSONList = snaplapseForPresentationSlider.CSVToJSONList(csvdata);
        for (var themeId in waypointJSONList) {
          var waypointJSON = JSON.parse(waypointJSONList[themeId].waypoints);
          var $themeEntry = $("<li>");
          $themeEntry.attr("id", themeId);
          $themeEntry.text(waypointJSONList[themeId].themeTitle);
          modifyWaypointSliderContent(waypointJSON.snaplapse.keyframes, themeId);
          currentWaypointSliderContentUrl = snaplapseForPresentationSlider.getAsUrlString(waypointJSON.snaplapse.keyframes);
          $themeEntry.data("waypoint-url", currentWaypointSliderContentUrl);
          $("#theme-list").append($themeEntry);
        }
        if (loadedInitialWaypointList) {
          changeHash({theme : ""});
        }
        var hashVals = UTIL.getUnsafeHashVars();
        if (hashVals.theme && !hashVals.v) {
          loadedInitialWaypointList = true;
        }
        var $selectedThemeElement = waypointJSONList[hashVals.theme] ? $("#" + hashVals.theme) : $("#theme-list").children().first();
        $selectedThemeElement.click();
      } else {
        currentWaypointTheme = "default";
        var waypointJSON = JSON.parse(snaplapseForPresentationSlider.CSVToJSON(csvdata));
        modifyWaypointSliderContent(waypointJSON.snaplapse.keyframes, currentWaypointTheme);
        currentWaypointSliderContentUrl = snaplapseForPresentationSlider.getAsUrlString(waypointJSON.snaplapse.keyframes);
        var waypointSliderContent = "#presentation=" + currentWaypointSliderContentUrl;
        timelapse.loadSharedDataFromUnsafeURL(waypointSliderContent);
      }

      if (enableThemeHamburgerButton) {
        $(".snaplapse_keyframe_container").prepend($("#presentation-slider-hamburger-wrapper"));
        $(".snaplapse_keyframe_list").addClass("has-hamburger");
        if (!isHyperwall && !isMobileDevice) {
          $("#presentation-slider-hamburger-wrapper .hamburger").height($(".snaplapse_keyframe_list").height() - 2);
          $("#presentation-slider-hamburger-wrapper #theme-title-container").height($(".snaplapse_keyframe_list").height());
        }
        $("#presentation-slider-hamburger-wrapper").show();
      }

      sortThemes();
      if (enableLetterboxMode) {
        updateLetterboxContent();
      }
    }

    function loadWaypoints(path) {
      if (path == waypointsLoadedPath) return;
      waypointsLoadedPath = path;

      // Legacy waypoint format (output of snaplapse editor)
      if (waypointCollection) {
        timelapse.loadSharedDataFromUnsafeURL(waypointCollection);
      } else if (path.indexOf("http") >= 0) {
        // Load waypoints from Google Docs
        UTIL.gdocToJSON(path, function(csvdata) {
          loadWaypointSliderContentFromCSV(csvdata);
        });
      } else {
        // Load local version of the waypoints .tsv file
        $.ajax({
          url: path,
          dataType: "text",
          success: function(csvdata) {
            loadWaypointSliderContentFromCSV(csvdata);
          }
        });
      }
    }

    function onTimeMachinePlayerReady() {

      if (!isBrowserSupported) {
        $("#baseLayerCreditContainer").hide();
      }

      // initialize the canvasLayer
      var timeMachineCanvasLayerOptions = {
        timelapse: timelapse,
        resizeHandler: resize,
        animate: true,
        updateHandler: update,
        resolutionScale: window.devicePixelRatio || 1
      };
      canvasLayer = new TimeMachineCanvasLayer(timeMachineCanvasLayerOptions);

      // initialize WebGL
      gl = canvasLayer.canvas.getContext('experimental-webgl');
      glb = new Glb(gl);

      var layer_html = '';

      layer_html += '<ul id="layers-list">';

      var landsat_base_str = '<label class="landsat-select" for="landsat-base" name="blsat"><input type="radio" id="landsat-base" name="base-layers" value="landsat"/>Google Earth Engine Timelapse</label>';
      var landsat_base = '<td colspan="2">' + landsat_base_str + '</td>';
      var light_base = '<td><label for="light-base" name="blte"><input type="radio" id="light-base" name="base-layers" value="light"/><span>Light Map</span></label></td>';
      var dark_base = '<td><label for="dark-base" name="bdrk"><input type="radio" id="dark-base" name="base-layers" value="dark"/><span>Dark Map</span></label></td>';

      // NOTE NOTE NOTE
      // What is set for the name in the label must never be changed and is forever connected to share links
      // The schema for generating the label name is using the initials of the data product. If this ends up conflicting
      // with one that already exists, then it is up to you to come up with something. Perhaps the initials of the name you would
      // give it when describing the layer to someone. Keep it as short as possible though.
      // NOTE NOTE NOTE
      var show_wdpa = '<td class="wdpa-select"><label for="show-wdpa" name="wdpa"><input type="checkbox" id="show-wdpa" />Protected Areas</label></td>';
      var show_forest_change = '<td class="forest-change-select"><label for="show-forest-change" name="fly"><input type="checkbox" id="show-forest-change" />Forest Loss by Year</label></td>';
      var show_forest_loss_gain = '<td class="forest-loss-gain-select"><label for="show-forest-loss-gain" name="flg"><input type="checkbox" id="show-forest-loss-gain" />Forest Loss/Gain</label></td>';
      var show_animated_forest_loss_gain = '<td class="animated-forest-loss-select"><label for="show-animated-forest-loss-gain" name="aflg"><input type="checkbox" id="show-animated-forest-loss-gain" />Animated Loss/Gain</label></td>';
      var show_viirs = '<td class="viirs-select"><label for="show-viirs" name="viirs"><input type="checkbox" id="show-viirs" />Fires at Night</label></td>';
      var show_forest_alerts = '<td class="forest-alerts-select"><label for="show-forest-alerts" name="fla"><input type="checkbox" id="show-forest-alerts" />Forest Loss Alerts</label></td>';
      var show_forest_alert_no_overlay = '<td class="forest-alerts-no-overlay-select"><label for="show-forest-alerts-no-overlay" name="flano"><input type="checkbox" id="show-forest-alerts-no-overlay" />Forest Loss Alerts <span style="font-size: 14px">(No Overlay)</span></label></td>';
      var show_lights_at_night = '<td class="lights-at-night-select"><label for="show-lights-at-night" name="lan"><input type="checkbox" id="show-lights-at-night" />Lights at Night (25 years)</label></td>';
      var show_lights_at_night_2012 = '<td class="lights-at-night-2012-select"><label for="show-lights-at-night-2012" name="lan12"><input type="checkbox" id="show-lights-at-night-2012" />Lights at Night 2012</label></td>';
      var show_lights_at_night_2016 = '<td class="lights-at-night-2016-select"><label for="show-lights-at-night-2016" name="lan16"><input type="checkbox" id="show-lights-at-night-2016" />Lights at Night 2016</label></td>';
      var show_coral = '<td class="coral-select"><label for="show-coral" name="cb"><input type="checkbox" id="show-coral"/>Coral Bleaching</label></td>';
      var show_coral_bleaching_alerts = '<td class="coral-bleaching-select"><label for="show-coral-bleaching-alerts" name="crw"><input type="checkbox" id="show-coral-bleaching-alerts" />Coral Reef Watch</label></td>';
      var show_usgs_windturbine = '<td class="wind-select"><label for="show-usgs-windturbine" name="wp"><input type="checkbox" id="show-usgs-windturbine" />Wind Power (USA)</span></label></td>';
      var show_global_wind_power = '<td class="wind-select"><label for="show-global-wind-power" name="gwp"><input type="checkbox" id="show-global-wind-power" />Wind Power (Global)</label></td>';
      var show_solar_installs = '<td class="solar-select"> <label for="show-solar-installs" name="sp"><input type="checkbox" id="show-solar-installs" />Solar PV (USA)</label></td>';
      var show_drilling = '<td class="drilling-select"><label for="show-drilling" name="drl"><input type="checkbox" id="show-drilling" />Oil/Gas Drilling (USA)</label></td>';
      var show_himawari = '<td class="himawari-select"><label for="show-himawari" name="h8_16"><input type="checkbox" id="show-himawari" />Himawari-8</label></td>';
      var show_water_occurrence = '<td class="water-occurrence-select"><label for="show-water-occurrence" name="wo"><input type="checkbox" id="show-water-occurrence" />Water Occurrence</label></td>';
      var show_water_change = '<td class="water-change-select"><label for="show-water-change" name="wc"><input type="checkbox" id="show-water-change" />Water Change</label></td>';
      var show_monthly_refugees = '<td class="monthly-refugees-select"><label for="show-monthly-refugees" name="mmr"><input type="checkbox" id="show-monthly-refugees" />Mediterranean Refugees</label></td>';
      var show_annual_refugees = '<td class="annual-refugees-select"><label for="show-annual-refugees" name="ar"><input type="checkbox" id="show-annual-refugees" />Global Refugees</label></td>';
      var show_annual_returns = '<td class="annual-returns-select"><label for="show-annual-returns" name="arr"><input type="checkbox" id="show-annual-returns" />Global Returnees</label></td>';
      var show_vsi = '<td class="vsi-select"><label for="show-vsi" name="vsi"><input type="checkbox" id="show-vsi" />Vegetation Sensitivity Index</label></td>';
      var show_health_impact_rcp2p6 = '<td class="health-impact-rcp2p6-select"><label for="show-health-impact-rcp2p6" name="hi-rcp2p6"><input type="checkbox" id="show-health-impact-rcp2p6" />Nutritional Deficiency RCP2.6</label></td>';
      var show_health_impact_rcp4p5 = '<td class="health-impact-rcp4p5-select"><label for="show-health-impact-rcp4p5" name="hi-rcp4p5"><input type="checkbox" id="show-health-impact-rcp4p5" />Nutritional Deficiency RCP4.5</label></td>';
      var show_health_impact_rcp6p0 = '<td class="health-impact-rcp6p0-select"><label for="show-health-impact-rcp6p0" name="hi-rcp6p0"><input type="checkbox" id="show-health-impact-rcp6p0" />Nutritional Deficiency RCP6.0</label></td>';
      var show_health_impact_rcp8p5 = '<td class="health-impact-rcp8p5-select"><label for="show-health-impact-rcp8p5" name="hi-rcp8p5"><input type="checkbox" id="show-health-impact-rcp8p5" />Nutritional Deficiency RCP8.5</label></td>';
      var show_zika = '<td class="zika-select"> <label for="show-zika" name="zv"><input type="checkbox" id="show-zika" />Zika</label></td>';
      var show_dengue = '<td class="dengue-select"> <label for="show-dengue" name="dv"><input type="checkbox" id="show-dengue" />Dengue</label></td>';
      var show_chiku = '<td class="chiku-select"> <label for="show-chiku" name="cv"><input type="checkbox" id="show-chiku" />Chikungunya</label></td>';
      var show_sea_level_rise_1p0 = '<td class="sea-level-rise-1p0-select"><label for="show-sea-level-rise-1p0" name="slr10"><input type="checkbox" id="show-sea-level-rise-1p0" />Sea Level Rise Due to 1.0 &deg;C Increase</label></td>';
      var show_sea_level_rise_1p5 = '<td class="sea-level-rise-1p5-select"><label for="show-sea-level-rise-1p5" name="slr15"><input type="checkbox" id="show-sea-level-rise-1p5" />Sea Level Rise Due to 1.5 &deg;C Increase</label></td>';
      var show_sea_level_rise_2p0 = '<td class="sea-level-rise-2p0-select"><label for="show-sea-level-rise-2p0" name="slr2"><input type="checkbox" id="show-sea-level-rise-2p0" />Sea Level Rise Due to 2.0 &deg;C Increase</label></td>';
      var show_sea_level_rise_4p0 = '<td class="sea-level-rise-4p0-select"><label for="show-sea-level-rise-4p0" name="slr4"><input type="checkbox" id="show-sea-level-rise-4p0" />Sea Level Rise Due to 4.0 &deg;C Increase</label></td>';
      var show_urban_fragility = '<td class="urban-fragility-select"><label for="show-urban-fragility" name="uf"><input type="checkbox" id="show-urban-fragility" />Urban Fragility</label></td>';
      var show_gtd = '<td class="gtd-select"><label for="show-gtd" name="gtd"><input type="checkbox" id="show-gtd" />Global Terrorism Database</label></td>';
      var show_uppsala_conflict = '<td class="uppsala-conflict-select"><label for="show-uppsala-conflict" name="uppsala-conflict"><input type="checkbox" id="show-uppsala-conflict" />Organized Violence Fatalities</label></td>';
      var show_hiv = '<td class="hiv-select"><label for="show-hiv" name="hiv"><input type="checkbox" id="show-hiv" />HIV Infections</label></td>';
      var show_obesity = '<td class="obesity-select"><label for="show-obesity" name="obesity"><input type="checkbox" id="show-obesity" />Obesity</label></td>';
      var show_vaccine_confidence_q1 = '<td class="vaccine-confidence-q1-select"><label for="show-vaccine-confidence-q1" name="vc1"><input type="checkbox" id="show-vaccine-confidence-q1" />Vaccines & Children</label></td>';
      var show_vaccine_confidence_q2 = '<td class="vaccine-confidence-q2-select"><label for="show-vaccine-confidence-q2" name="vc2"><input type="checkbox" id="show-vaccine-confidence-q2" />Vaccine Safety</label></td>';
      var show_vaccine_confidence_q3 = '<td class="vaccine-confidence-q3-select"><label for="show-vaccine-confidence-q3" name="vc3"><input type="checkbox" id="show-vaccine-confidence-q3" />Vaccine Effectiveness</label></td>';
      var show_vaccine_confidence_q4 = '<td class="vaccine-confidence-q4-select"><label for="show-vaccine-confidence-q4" name="vc4"><input type="checkbox" id="show-vaccine-confidence-q4" />Vaccines & Religion</label></td>';
      var show_ndvi_anomaly = '<td class="ndvi-anomaly-select"><label for="show-ndvi-anomaly" name="ndvia"><input type="checkbox" id="show-ndvi-anomaly" />Vegetation Index Reduction</label></td>';
      var show_ebola_deaths = '<td class="ebola-deaths-select"><label for="show-ebola-deaths" name="ed"><input type="checkbox" id="show-ebola-deaths" />Ebola Deaths</label></td>';
      var show_ebola_cases = '<td class="ebola-cases-select"><label for="show-ebola-cases" name="ec"><input type="checkbox" id="show-ebola-cases" />Ebola Cases</label></td>';
      var show_ebola_new_cases = '<td class="ebola-new-cases-select"><label for="show-ebola-new-cases" name="enc"><input type="checkbox" id="show-ebola-new-cases" />Ebola New Cases</label></td>';
      var show_lodes = '<td class="lodes-select"><label for="show-lodes" name="lodes"><input type="checkbox" id="show-lodes" />LODES</label></td>';
      var show_cumulative_active_mining_layer = '<td class="cumulative-active-mining-select"><label for="show-cumulative-active-mining" name="cumulative-active-mining"><input type="checkbox" id="show-cumulative-active-mining" />Active Mining</label></td>';
      var show_iraq_iom_idp = '<td class="iraq-iom-idp-select"><label for="show-iraq-iom-idp" name="iraq-iom-idp"><input type="checkbox" id="show-iraq-iom-idp" />Iraq IDPs</label></td>';
      var show_syria_iom_idp = '<td class="syria-iom-idp-select"><label for="show-syria-iom-idp" name="syria-iom-idp"><input type="checkbox" id="show-syria-iom-idp" />Syria IDPs</label></td>';
      var show_libya_iom_idp = '<td class="libya-iom-idp-select"><label for="show-libya-iom-idp" name="libya-iom-idp"><input type="checkbox" id="show-libya-iom-idp" />Libya IDPs</label></td>';
      var show_yemen_iom_idp = '<td class="yemen-iom-idp-select"><label for="show-yemen-iom-idp" name="yemen-iom-idp"><input type="checkbox" id="show-yemen-iom-idp" />Yemen IDPs</label></td>';
      var show_iraq_iom_return = '<td class="iraq-iom-return-select"><label for="show-iraq-iom-return" name="iraq-iom-return"><input type="checkbox" id="show-iraq-iom-return" />Iraq Returnees</label></td>';
      var show_syria_iom_return = '<td class="syria-iom-return-select"><label for="show-syria-iom-return" name="syria-iom-return"><input type="checkbox" id="show-syria-iom-return" />Syria Returnees</label></td>';
      var show_libya_iom_return = '<td class="libya-iom-return-select"><label for="show-libya-iom-return" name="libya-iom-return"><input type="checkbox" id="show-libya-iom-return" />Libya Returnees</label></td>';
      var show_yemen_iom_return = '<td class="yemen-iom-return-select"><label for="show-yemen-iom-return" name="yemen-iom-return"><input type="checkbox" id="show-yemen-iom-return" />Yemen Returnees</label></td>';
      var show_berkeley_earth_temperature_anomaly = '<td class="berkeley-earth-temperature-anomaly-select"><label for="show-berkeley-earth-temperature-anomaly" name="berkeley-earth-temperature-anomaly"><input type="checkbox" id="show-berkeley-earth-temperature-anomaly" />Temperature Anomaly</label></td>';
      var show_omi_no2 = '<td class="omi-no2-select"><label for="show-omi-no2" name="omi-no2"><input type="checkbox" id="show-omi-no2" />OMI NO2</label></td>';
      var show_be_pm25 = '<td class="be-pm25-select"><label for="show-be-pm25" name="be-pm25"><input type="checkbox" id="show-be-pm25" />Berkeley Earth -- PM2.5</label></td>';
      var show_china_aviation = '<td class="china-aviation-select"><label for="show-china-aviation" name="china-aviation"><input type="checkbox" id="show-china-aviation" />China Aviation</label></td>';
      var show_china_power_plants = '<td class="china-power-plants-select"><label for="show-china-power-plants" name="china-power-plants"><input type="checkbox" id="show-china-power-plants" />China Power Plants</label></td>';
      var show_china_reservoirs = '<td class="china-reservoirs-select"><label for="show-china-reservoirs" name="china-reservoirs"><input type="checkbox" id="show-china-reservoirs" />China Reservoirs</label></td>';
      var show_china_waste_treatment_plants = '<td class="china-waste-treatment-plants-select"><label for="show-china-waste-treatment-plants" name="china-waste-treatment-plants"><input type="checkbox" id="show-china-waste-treatment-plants" />China Waste Treatment Plants</label></td>';
      var show_expanding_cities = '<td class="expanding-cities-select"><label for="show-expanding-cities" name="expanding-cities"><input type="checkbox" id="show-expanding-cities" />Expanding Cities</label></td>';
      var show_irena_solar = '<td class="irena-solar-select"><label for="show-irena-solar" name="IRENA_Solar"><input type="checkbox" id="show-irena-solar" />Solar electric capacity per country</label></td>';
      var show_irena_wind = '<td class="irena-wind-select"><label for="show-irena-wind" name="IRENA_Wind"><input type="checkbox" id="show-irena-wind" />Wind electric capacity per country</label></td>';
      var show_carbon_price_risk = '<td class="carbon-price-risk-select"><label for="show-carbon-price-risk" name="carbon_price_risk"><input type="checkbox" id="show-carbon-price-risk" />Carbon price risk</label></td>';
      var show_tsip = '<td class="tsip-select"><label for="show-tsip" name="tsip"><input type="checkbox" id="show-tsip" />Toxic Sites</label></td>';
      var show_sp_crude = '<td class="sp-crude-select"><label for="show-sp-crude" name="sp-crude"><input type="checkbox" id="show-sp-crude" />Crude Oil flows</label></td>';
      var show_sp_crude_Oceania = '<td class="sp-crude-select_Oceania"><label for="show-sp-crude_Oceania" name="sp-crude_Oceania"><input type="checkbox" id="show-sp-crude_Oceania" />Oceania Crude Oil flows</label></td>';
      var show_sp_crude_AG = '<td class="sp-crude-select_AG"><label for="show-sp-crude_AG" name="sp-crude_AG"><input type="checkbox" id="show-sp-crude_AG" />AG Crude Oil flows</label></td>';
      var show_sp_crude_WAF = '<td class="sp-crude-select_WAF"><label for="show-sp-crude_WAF" name="sp-crude_WAF"><input type="checkbox" id="show-sp-crude_WAF" />WAF Crude Oil flows</label></td>';
      var show_sp_crude_MedNAF = '<td class="sp-crude-select_MedNAF"><label for="show-sp-crude_MedNAF" name="sp-crude_MedNAF"><input type="checkbox" id="show-sp-crude_MedNAF" />MedNAF Crude Oil flows</label></td>';
      var show_sp_crude_Urals = '<td class="sp-crude-select_Urals"><label for="show-sp-crude_Urals" name="sp-crude_Urals"><input type="checkbox" id="show-sp-crude_Urals" />Urals Crude Oil flows</label></td>';
      var show_sp_crude_USGC = '<td class="sp-crude-select_USGC"><label for="show-sp-crude_USGC" name="sp-crude_USGC"><input type="checkbox" id="show-sp-crude_USGC" />USGC Crude Oil flows</label></td>';
      var show_sp_crude_LatAM = '<td class="sp-crude-select_LatAM"><label for="show-sp-crude_LatAM" name="sp-crude_LatAM"><input type="checkbox" id="show-sp-crude_LatAM" />LatAM Crude Oil flows</label></td>';
      var show_sp_crude_NS = '<td class="sp-crude-select_NS"><label for="show-sp-crude_NS" name="sp-crude_NS"><input type="checkbox" id="show-sp-crude_NS" />NS Crude Oil flows</label></td>';
      var show_goes16 = '<td class="goes16-select"><label for="show-goes16" name="goes16"><input type="checkbox" id="show-goes16" />GOES16</label></td>';
      var show_dscovr = '<td class="dscovr-select"><label for="show-dscovr" name="dscovr"><input type="checkbox" id="show-dscovr" />DSCOVR</label></td>';
      var show_annual_global_pm25 = '<td class="annual-pm25-select"><label for="show-annual-pm25" name="annual-pm25"><input type="checkbox" id="show-annual-pm25" />Annual Global PM 2.5</label></td>';

/*
      var show_sp_crude_WAF = '<td class="sp-crude-select_WAF"><label for="show-sp-crude_WAF" name="sp-crude_WAF"><input type="checkbox" id="show-sp-crude_WAF" />WAF Crude Oil flows</label></td>';
      var show_sp_crude_NAF = '<td class="sp-crude-select_NAF"><label for="show-sp-crude_WAF" name="sp-crude_NAF"><input type="checkbox" id="show-sp-crude_NAF" />NAF Crude Oil flows</label></td>';
      var show_sp_crude_ME = '<td class="sp-crude-select_ME"><label for="show-sp-crude_ME" name="sp-crude_ME"><input type="checkbox" id="show-sp-crude_ME" />ME Crude Oil flows</label></td>';
      var show_sp_crude_US = '<td class="sp-crude-select_US"><label for="show-sp-crude_US" name="sp-crude_US"><input type="checkbox" id="show-sp-crude_US" />US Crude Oil flows</label></td>';
*/

      layer_html += '<div class="layers-scroll-vertical">';
      layer_html += '<div class="map-layer-div map-layer-checkbox">';

      /* BASE LAYERS */
      layer_html += '  <h3>Base Layers</h3>';
      layer_html += '  <table id="category-base-layers">';
      layer_html += '    <tr>';
      layer_html += landsat_base;
      layer_html += '    </tr>';
      layer_html += '    <tr>';
      layer_html += light_base;
      layer_html += dark_base;
      layer_html += '    </tr>';
      layer_html += '  </table>';
      /* END BASE LAYERS */

      /* FOREST CATEGORY */
      layer_html += '  <h3>Forests</h3>';
      layer_html += '  <table id="category-forests">';
      layer_html += '    <tr>';
      layer_html += show_wdpa;
      layer_html += '    </tr>';
      layer_html += '    <tr>';
      layer_html += show_forest_change;
      layer_html += '    </tr>';
      layer_html += '    <tr>';
      layer_html += show_forest_loss_gain;
      layer_html += '    </tr>';
      layer_html += '    <tr>';
      layer_html += show_animated_forest_loss_gain;
      layer_html += '    </tr>';
      if (showForestAlerts) {
        layer_html += '    <tr>';
        layer_html += show_forest_alerts;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_forest_alert_no_overlay;
        layer_html += '    </tr>';
      }
      layer_html += '  </table>';
      /* END FOREST CATEGORY */

      /* WATER CATEGORY */
      layer_html += '  <h3>Water</h3>';
      layer_html += '  <table id="category-water">';
      if (showWaterOccurrence) {
        layer_html += '   <tr>';
        layer_html += show_water_occurrence;
        layer_html += '   </tr>';
      }
      if (showWaterChange) {
        layer_html += '   <tr>';
        layer_html += show_water_change;
        layer_html += '   </tr>';
      }
      layer_html += '  </table>';
      /* END WATER CATEGORY */

      /* CLIMATE CATEGORY */
      layer_html += '  <h3>Climate</h3>';
      layer_html += '  <table id="category-climate">';
      if (showSeaLevelRise) {
        layer_html += '    <tr>';
        layer_html += show_sea_level_rise_1p0;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sea_level_rise_1p5;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sea_level_rise_2p0;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sea_level_rise_4p0;
        layer_html += '    </tr>';
      }
      if (showNdviAnomaly) {
        layer_html += '    <tr>';
        layer_html += show_ndvi_anomaly;
        layer_html += '    </tr>';
      }
      if (showVsi) {
        layer_html += '   <tr>';
        layer_html += show_vsi;
        layer_html += '   </tr>';
      }
      if (showBerkeleyEarthTemperatureAnomaly) {
        layer_html += '    <tr>';
        layer_html += show_berkeley_earth_temperature_anomaly;
        layer_html += '    </tr>';
      }
      layer_html += '  </table>';
      /* END CLIMATE CATEGORY */

      /* POLLUTION CATEGORY */
      layer_html += '  <h3>Pollution</h3>';
      layer_html += '  <table id="category-pollution">';
      if (showOmiNo2) {
        layer_html += '   <tr>';
        layer_html += show_omi_no2;
        layer_html += '   </tr>';
      }
      if (showBePm25) {
        layer_html += '   <tr>';
        layer_html += show_be_pm25;
        layer_html += '   </tr>';
      }
      if (showTsip) {
        layer_html += '    <tr>';
        layer_html += show_tsip;
        layer_html += '    </tr>';
      }
      if (showAnnualGlobalPm25) {
        layer_html += '    <tr>';
        layer_html += show_annual_global_pm25;
        layer_html += '    </tr>';
      }
      layer_html += '  </table>';
      /* END POLLUTION CATEGORY */

      /* CORAL CATEGORY */
      layer_html += '  <h3>Coral</h3>';
      layer_html += '  <table id="category-coral">';
      if (showCoral) {
        layer_html += '    <tr>';
        layer_html += show_coral;
        layer_html += '    </tr>';
      }
      if (showCoralBleaching) {
        layer_html += '    <tr>';
        layer_html += show_coral_bleaching_alerts;
        layer_html += '    </tr>';
      }
      layer_html += '  </table>';
      /* END CORAL CATEGORY */

      /* ENERGY CATEGORY */
      layer_html += '  <h3>Energy</h3>';
      layer_html += '  <table id="category-energy">';
      layer_html += '    <tr>';
      layer_html += show_solar_installs;
      layer_html += '    </tr>';
      layer_html += '    <tr>';
      layer_html += show_usgs_windturbine;
      layer_html += '    </tr>';
      if (showGlobalWindPower) {
        layer_html += '    <tr>';
        layer_html += show_global_wind_power;
        layer_html += '    </tr>';
      }
      if (showUSDrilling) {
        layer_html += '    <tr>';
        layer_html += show_drilling;
        layer_html += '    </tr>';
      }
      if (showViirs) {
        layer_html += '    <tr>';
        layer_html += show_viirs;
        layer_html += '    </tr>';
      }
      if (showIrena) {
        layer_html += '    <tr>';
        layer_html += show_irena_solar;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_irena_wind;
        layer_html += '    </tr>';
      }
      if (showSpCrude) {
        layer_html += '    <tr>';
        layer_html += show_sp_crude;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_Oceania;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_AG;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_WAF;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_MedNAF;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_Urals;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_USGC;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_LatAM;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_NS;
        layer_html += '    </tr>';          /*
        layer_html += '    <tr>';
        layer_html += show_sp_crude_WAF;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_NAF;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_ME;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_sp_crude_US;
        layer_html += '    </tr>';
        */
      }

      layer_html += '  </table>';
      /* END ENERGY CATEGORY */

      /* NUTRITION CATEGORY */
      layer_html += '  <h3>Nutrition</h3>';
      layer_html += '  <table id="category-nutrition">';
      if (showHealthImpact) {
        layer_html += '    <tr>';
        layer_html += show_health_impact_rcp2p6;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_health_impact_rcp4p5;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_health_impact_rcp6p0;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_health_impact_rcp8p5;
        layer_html += '    </tr>';
      }
      layer_html += '  </table>';
      /* END NUTRITION CATEGORY */

      /* REFUGEE CATEGORY */
      layer_html += '  <h3>Forced Displacement</h3>';
      layer_html += '  <table id="category-forced-displacement">';
      if (showMonthlyRefugees) {
        layer_html += '    <tr>';
        layer_html += show_monthly_refugees;
        layer_html += '    </tr>';
      }
      if (showAnnualRefugees) {
        layer_html += '    <tr>';
        layer_html += show_annual_refugees;
        layer_html += '    </tr>';
      }
      if (showAnnualReturns) {
        layer_html += '    <tr>';
        layer_html += show_annual_returns;
        layer_html += '    </tr>';
      }
      if (showIomIdp) {
        layer_html += '   <tr>';
        layer_html += show_iraq_iom_idp;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += show_syria_iom_idp;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += show_libya_iom_idp;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += show_yemen_iom_idp;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += show_iraq_iom_return;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += show_syria_iom_return;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += show_libya_iom_return;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += show_yemen_iom_return;
        layer_html += '   </tr>';
      }
      layer_html += '  </table>';
      /* END REFUGEE CATEGORY */

      /* PANDEMICS CATEGORY */
      layer_html += '  <h3>Pandemics</h3>';
      layer_html += '  <table id="category-pandemics">';
      if (showZika) {
        layer_html += '    <tr>';
        layer_html += show_zika;
        layer_html += '    </tr>';
      }
      if (showDengue) {
        layer_html += '    <tr>';
        layer_html += show_dengue;
        layer_html += '    </tr>';
      }
      if (showChiku) {
        layer_html += '    <tr>';
        layer_html += show_chiku;
        layer_html += '    </tr>';
      }
      if (showEbola) {
        layer_html += '    <tr>';
        layer_html += show_ebola_deaths;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_ebola_cases;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_ebola_new_cases;
        layer_html += '    </tr>';
      }
      if (showHiv) {
        layer_html += '    <tr>';
        layer_html += show_hiv;
        layer_html += '    </tr>';
      }
      if (showObesity) {
        layer_html += '    <tr>';
        layer_html += show_obesity;
        layer_html += '    </tr>';
      }
      if (showVaccineConfidence) {
        layer_html += '    <tr>';
        layer_html += show_vaccine_confidence_q1;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_vaccine_confidence_q2;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_vaccine_confidence_q3;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_vaccine_confidence_q4;
        layer_html += '    </tr>';
      }
      layer_html += '  </table>';
      /* END PANDEMICS CATEGORY */

      /* URBANIZATION CATEGORY */
      layer_html += '  <h3>Urbanization</h3>';
      layer_html += '  <table id="category-urbanization">';
      if (showLightsAtNight) {
        layer_html += '    <tr>';
        layer_html += show_lights_at_night;
        layer_html += '    </tr>';
      }
      if (showLightsAtNight2012) {
        layer_html += '    <tr>';
        layer_html += show_lights_at_night_2012;
        layer_html += '    </tr>';
      }
      if (showLightsAtNight2016) {
        layer_html += '    <tr>';
        layer_html += show_lights_at_night_2016;
        layer_html += '    </tr>';
      }
      if (showUrbanFragility) {
        layer_html += '    <tr>';
        layer_html += show_urban_fragility;
        layer_html += '    </tr>';
      }
      if (showExpandingCities) {
        layer_html += '    <tr>';
        layer_html += show_expanding_cities;
        layer_html += '    </tr>';
      }
      layer_html += '  </table>';
      /* END URBANIZATION CATEGORY */

      /* CHINA INFRASTRUCTURE CATEGORY */
      if (showChinaInfrastructure) {
        layer_html += '  <h3 style="display: none">China Infrastructure</h3>';
        layer_html += '  <table id="category-ci" style="display: none">';
        layer_html += '    <tr>';
        layer_html += show_china_aviation;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_china_power_plants;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_china_reservoirs;
        layer_html += '    </tr>';
        layer_html += '    <tr>';
        layer_html += show_china_waste_treatment_plants;
        layer_html += '    </tr>';
        layer_html += '  </table>';
      }
      /* END CHINA INFRASTRUCTURE CATEGORY */

      /* US DEMOGRAPHICS CATEGORY */
      if (showLodes) {
        layer_html += '  <h3>US Demographics</h3>';
        layer_html += '  <table id="category-us-demographics">';
        layer_html += '    <tr>';
        layer_html += show_lodes;
        layer_html += '    </tr>';
        layer_html += '  </table>';
      }
      /* END US DEMOGRAPHICS CATEGORY */

      /* CARBON PRICE RISK CATEGORY */
      if (showCarbonPriceRisk) {
        layer_html += '  <h3>Carbon Price Risk</h3>';
        layer_html += '  <table id="category-carbon-price-risk">';
        layer_html += '    <tr>';
        layer_html += show_carbon_price_risk;
        layer_html += '    </tr>';
        for (var i = 0; i < carbonPriceRisk.sectors.length; i++) {
          layer_html += '    <tr>';
          layer_html += carbonPriceRisk.getSelect(i);
          layer_html += '    </tr>';
        }
        layer_html += '  </table>';
      }
      /* END CARBON PRICE CATEGORY */

      /* MISC CATEGORY */
      layer_html += '  <h3>Other</h3>';
      layer_html += '  <table id="other_table">';
      if (showGtd) {
        layer_html += '    <tr>';
        layer_html += show_gtd;
        layer_html += '    </tr>';
      }
      if (showUppsalaConflict) {
        layer_html += '    <tr>';
        layer_html += show_uppsala_conflict;
        layer_html += '    </tr>';
      }
      if (showCumulativeActiveMining) {
        layer_html += '    <tr>';
        layer_html += show_cumulative_active_mining_layer;
        layer_html += '    </tr>';
      }
      if (showHimawari8) {
        layer_html += '    <tr>';
        layer_html += show_himawari;
        layer_html += '    </tr>';
      }
      if (showGoes16) {
        layer_html += '    <tr>';
        layer_html += show_goes16;
        layer_html += '    </tr>';
      }
      if (showDscovr) {
        layer_html += '    <tr>';
        layer_html += show_dscovr;
        layer_html += '    </tr>';
      }
      if (showCsvLayers) {
        // Custom CSV Layers
        layer_html += '  <tbody id="csvlayers_table">';
        layer_html += '  </tbody>';
      }
      layer_html += '  </table>';
      /* END MISC CATEGORY */

      // ## 5 ##
      //// Add additional layers to side UI panel ////
      //

      layer_html += '</div>';

      // Extras menu
      if (showExtrasMenu) {
        layer_html += '<div class="extras-selector-div">';
        layer_html += ' <select name="extras-selector" id="extras-selector">';
        layer_html += '   <option id="default-extras-select" selected="selected" value="select">Select extra content...</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="pumphandle_2014.mp4" data-name="e-pumphandle">Measured CO2 Over Time</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="Carbon Dioxide 2006 GEOS-5 model.mp4" data-name="e-geos5model">CO2 2006 GEOS-5 Model</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Land + Ocean Average Temperature Annual Anomaly.mp4" data-name="e-tempanomaly">Temperature Anomaly 1850-2013</option>';
        layer_html += '   <option data-file-playback-rate="0.5" data-type="video" data-file-name="berkeley-earth.mp4" data-name="e-tempanomaly2">Temperature Anomaly 1850-2015</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic ice age, 1987-2014.mp4" data-name="e-icethinning">Ice Thinning 1987-2014</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Larsen-B-Collapse.mp4" data-name="e-larsenb">Larsen-B Collapse</option>';
        layer_html += '   <option data-file-playback-rate="4" data-type="video" data-file-name="Orbiting Carbon Observatory.mp4" data-name="e-oco">Orbiting Carbon Observatory</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic Sea Ice, September 1979 to September 2014.mp4" data-name="e-seaice">Sea Ice Concentration 1979-2014</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="coral-reef-watch-daily-7day-max.mp4" data-name="e-crw">Coral Reef Watch 2013-2015</option>';
        layer_html += '   <option data-file-playback-rate="0.5" data-type="video" data-file-name="merra-spi.mp4" data-name="e-spi">Standardized Precipitation Index 1980-2015</option>';
        layer_html += '   <option data-type="iframe" data-link-path="http://choices.climatecentral.org/widget.html?utm_source=Davos&utm_medium=embed&utm_campaign=SSMC-Map#11/31.2301/121.4736?compare=temperatures&carbon-end-yr=2100&scenario-a=warming-4&scenario-b=warming-2&presentation=1" data-name="e-shanghaisealevel">Shanghai Sea Level</option>';
        layer_html += '   <option data-type="img" data-link-path="land-and-ocean-temps.png" data-name="e-hottestyear2015">2015: Hottest Year on Record</option>';
        /*layer_html += '   <option data-type="img" data-link-path="co2_emissions_over_time.png">CO2 Emissions Over Time</option>';
        layer_html += '   <option data-type="img" data-link-path="global_decarbonisation_staircase.png">Global Decarbonisation Staircase</option>';*/
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="refugee_camps.mp4" data-name="e-refugeesmosul">Refugee Camps Outside Mosul</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="iraq_smoke.mp4" data-name="e-oilmosul">Qayyarah Oil Field South of Mosul</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="sugarcane_plantations.mp4" data-name="e-sugarcane">Sugarcane Plantation in Bolivia</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="cepi.mp4" data-name="e-cepi">Coalition for Epidemic Prepardness Innovations</option>';
        layer_html += '   <option data-file-playback-rate="1.5" data-type="video" data-file-name="temp-anomaly.mp4" data-name="e-tempanomaly3">Temperature Anomaly 1970-2016</option>';
        layer_html += '   <option data-type="img" data-link-path="water-synergies-p1.png" data-name="e-watersynergies">Water Synergies Pt1</option>';
        layer_html += '   <option data-type="img" data-link-path="water-synergies-p2.png" data-name="e-watersynergies2">Water Synergies Pt2</option>';
        layer_html += '   <option data-type="img" data-link-path="altered-river-flow.png" data-name="e-riverflow">Altered River Flow</option>';
        layer_html += '   <option data-type="img" data-link-path="solar-with-legend.png" data-name="e-globalatlas">Global Atlas for Renewable Energy</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="smog_tower_pm_animation.mp4" data-name="e-smogtoweranim">Smog Tower PM10 Animation</option>';
        layer_html += '   <option data-type="img" data-link-path="smog_tower_pm_reduction.png" data-name="e-smogtowerpm10">Smog Tower PM10 Reduction</option>';
        layer_html += '   <option data-type="img" data-link-path="smog_free_tower_tianjin.jpg" data-name="e-smogtowertianjin">Smog Free Tower Tianjin</option>';
        layer_html += '   <option data-type="img" data-link-path="smog_free_tower_dalian.jpeg" data-name="e-smogtowerdalian">Smog Free Tower Dalian</option>';
        layer_html += '   <option data-type="img" data-link-path="Outbound FDI by Sector Geo.jpg" data-name="e-fdi">Outbound FDI by Sector Geo</option>';
        layer_html += '   <option data-type="img" data-link-path="BRI-mapping.jpg" data-name="e-bri">BRI Mapping</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="global_and_european_fisheries_map.mp4" data-name="e-globalfishmap">Global and European Fisheries Map</option>';
        layer_html += '   <option data-type="img" data-link-path="nation-states.jpg" data-name="e-nationstates">Nation States</option>';
        layer_html += '   <option data-type="img" data-link-path="Doughnut-classic.png" data-name="e-doughnut_classic">Doughnut Classic</option>';
        layer_html += '   <option data-type="img" data-link-path="Doughnut-transgressing.png" data-name="e-doughnut_transgressing">Doughnut Transgressing</option>';
        layer_html += '   <option data-type="img" data-link-path="Trade Openness.png" data-name="e-tradeopenness">Trade Openness</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="Global Cyber Centre.mp4" data-name="e-globalcyber">Global Cyber Centre</option>';
        if (showEVA)
          layer_html += '   <option data-type="link" data-link-path="http://localhost:8080/?uid=history-1436384863961-Vyxt6PIO" data-name="e-eva">EVA - Explorable Visual Analytics</option>';
        if (showGFW)
          layer_html += '   <option data-type="iframe" data-link-path="http://localhost:8081/index.html?workspace=https://api-dot-skytruth-pleuston.appspot.com/v1/workspaces/udw-v1-4a79e843-9e84-4c02-a903-f49c4d0ebc0c" data-name="e-gfw">Global Fishing Watch</option>';
        layer_html += '   <optgroup label="World Economic Forum - Davos 2016">';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Climate Crisis with Naomi Oreskes and Achim Steiner.mp4" data-name="e-davos16climate1">Climate Crisis with Naomi Oreskes and Achim Steiner</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Climate Crisis with Naomi Oreskes and Nicholas Stern.mp4" data-name="e-davos16climate2">Climate Crisis with Naomi Oreskes and Nicholas Stern</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Future of Forests with Matthew Hansen and Andrew Steer.mp4" data-name="e-davos16forests1">Future of Forests with Matthew Hansen and Andrew Steer</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Industrialization Impasse with Ricardo Hausmann and Illah Nourbakhsh.mp4 data-name="e-davos16industrial1"">Industrialization Impasse with Ricardo Hausmann and Illah Nourbakhsh</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Race for Resources with Ellen MacArthur and Randy Sargent.mp4" data-name="e-davos16resources1">Race for Resources with Ellen MacArthur and Randy Sargent</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Race for Resources with William McDonough and Randy Sargent.mp4" data-name="e-davos16resources2">Race for Resources with William McDonough and Randy Sargent</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The War on Water with Johan Rockstrom and Randy Sargent.mp4" data-name="e-davos16water1">War on Water with Johan Rockstrom and Randy Sargent</option>';
        layer_html += '   </optgroup>';
        layer_html += ' </select>';
        layer_html += '</div>';
      }
      layer_html += '</div>';
      layer_html += '<div class="clearLayers"></div>';
      layer_html += '</ul>';

      var legend_html = '<div id="layers-legend">';
      legend_html += '<div id="legend-content">';
      legend_html += '<table cellpadding=5>';
      legend_html += '<tr id="wdpa-legend" style="display: none"><td><div style="background-color:#33da4f; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -11px; font-size: 17px">Protected Areas<span class="credit"> (UNEP-WCMC)</span></div></td></tr>';
      legend_html += '<tr id="forest-loss-year-legend" style="display: none"><td><div style="font-size: 17px">Forest Loss By Year <span class="credit"> (Hansen et al)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">2000</div><div style="margin-top: 3px; float: left; background-image: -webkit-linear-gradient(left, yellow, orange 65%, red 100%);background-image: linear-gradient(left, yellow, orange 65%, red 100%); width: 68%; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">2016</div></div></td></tr>';
      legend_html += '<tr id="forest-loss-gain-legend" style="display: none; font-size: 14px;"><td><div style="font-size: 17px">Forest Loss/Gain 2000-2016 <span class="credit"> (Hansen et al)</span></div><div style="float: left; padding-right:8px"><div style="background-color:#00e000; width: 12px; height: 12px; float: left; margin-top: 2px; margin-left: 8px;"></div>&nbsp;Extent</div><div style="float: left; padding-right:8px"><div style="background-color:#ff0000; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Loss</div><div style="float: left; padding-right:8px"><div style="background-color:#0000ff; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Gain</div><div><div style="background-color:#ff00ff; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Both</div></td></tr>';
      legend_html += '<tr id="fires-at-night-legend" style="display: none"><td><div style="background-color:#eda46a; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Fires At Night <span class="credit"> (NOAA)</span></div></td></tr>';
      legend_html += '<tr id="lights-at-night-legend" style="display: none"><td><div style="font-size: 17px">Lights at Night over 25 Years <span class="credit"> (NOAA, Google)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">Decrease</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, #4848FD, green 50%, red 100%);background-image: linear-gradient(left, #4848FD, green 50%, red 100%); width: 59%; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">Increase</div></td></tr>';
      legend_html += '<tr id="lights-at-night-2012-legend" style="display: none"><td><div style="font-size: 17px">Lights at Night 2012 <span class="credit"> (NASA)</span></div></td></tr>';
      legend_html += '<tr id="lights-at-night-2016-legend" style="display: none"><td><div style="font-size: 17px">Lights at Night 2016 <span class="credit"> (NASA)</span></div></td></tr>';
      legend_html += '<tr id="coral-bleaching-legend" style="display: none"><td><div style="float:left; background-color:#fa13ab; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -5px; font-size: 17px">Coral Reefs <span class="credit"> (NOAA, UNEP-WCMC)</span></div></td></tr>';
      legend_html += '<tr id="coral-bleaching-alerts-legend" style="display: none"><td><div style="font-size: 17px">Coral Reef Watch <span class="credit"> (NOAA, UNEP-WCMC)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">Watch</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, #ffff00, #fbb404 65%, #a00200 100%);background-image: linear-gradient(left, #ffff00, #fbb404 65%, #a00200 100%); width: 70%; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">Alert</div></td></tr>';
      legend_html += '<tr id="wind-installs-legend" style="display: none"><td><div style="background-color:#a0fe8f; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">US Wind Power <span class="credit"> (USGS)</span></div></div></td></tr>';
      legend_html += '<tr id="global-wind-power-legend" style="display: none"><td><div style="background-color:#a0fe8f; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">Global Wind Power <span class="credit"> (TheWindPower.net)</span></div></div></td></tr>';
      legend_html += '<tr id="solar-installs-legend" style="display: none"><td><div style="background-color:#7376b2; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">US Solar Photovoltaic <span class="credit"> (NREL)</span></div></td></tr>';
      legend_html += '<tr id="drilling-legend" style="display: none"><td><div style="background-color:#eda46a; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">US Oil/Gass Drilling <span class="credit"> (FracTracker, CREATE Lab)</span></div></td></tr>';
      legend_html += '<tr id="water-occurrence-legend" style="display: none"><td><div style="font-size: 17px">Water Occurrence 1984-2015 <span class="credit"> (JRC)</span></div><div style="margin-left: 8px"><div style="font-size: 13px; float: left">100%</div><div style="font-size: 13px; float: right;">0%</div><div class="waterLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">Always water</div><div style="font-size: 13px; float: right">Never water</div></div></td></tr>';
      legend_html += '<tr id="water-change-legend" style="display: none"><td><div style="font-size: 17px">Water Change 1984-1999 to 2000-2015 <span class="credit"> (JRC)</span></div><div style="margin-left: 8px"><div class="waterChangeLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">Water Loss</div><div style="font-size: 13px; float: right">Water Gain</div></div></td></tr>';
      legend_html += '<tr id="monthly-refugees-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, #ff0000 0%, #ffffff 100%);background: -webkit-linear-gradient(left, #ff0000 0%,#ffffff 100%); background: linear-gradient(to right, #ff0000 0%,#ffffff 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Refugees Crossing the Mediterranean: Jan 2014 - Jun 2016 <span class="credit"> (UNHCR)</span></div></td></tr>';
      if (subsampleAnnualRefugees)
        legend_html += '<tr id="annual-refugees-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, #da7300 25%, red 100%);background: -webkit-linear-gradient(left, #da7300 25%,red 100%); background: linear-gradient(to right, #da7300 25%,red 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Global Refugee Flow: 2000 - 2015 <span class="credit"> (UNHCR) <br> 1 dot = ~17 refugees</span></div></td></tr>';
      else
        legend_html += '<tr id="annual-refugees-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, #da7300 25%, red 100%);background: -webkit-linear-gradient(left, #da7300 25%,red 100%); background: linear-gradient(to right, #da7300 25%,red 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Global Refugee Flow: 2000 - 2015 <span class="credit"> (UNHCR) <br> 1 dot = 1 refugee </span></div></td></tr>';
      if (subsampleAnnualReturns)
        legend_html += '<tr id="annual-returns-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, lightyellow 25%, navy 100%);background: -webkit-linear-gradient(left, lightyellow 25%,navy 100%); background: linear-gradient(to right, lightyellow 25%,navy 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Global Refugee Return Flow: 2000 - 2015 <span class="credit"> (UNHCR) <br> 1 dot = ~17 refugees </span></div></td></tr>';
      else
        legend_html += '<tr id="annual-returns-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(right, lightyellow 25%, navy 100%);background: -webkit-linear-gradient(left, lightyellow 25%,navy 100%); background: linear-gradient(to right, lightyellow 25%,navy 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Global Refugee Return Flow: 2000 - 2015 <span class="credit"> (UNHCR) <br> 1 dot = 1 refugee </span></div></td></tr>';
      legend_html += '<tr id="vsi-legend" style="display: none"><td><div style="font-size: 17px">Vegetation Sensitivity Index 2000-2013 <span class="credit"> (USGS)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">0</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, rgb(0, 139, 0), rgb(92, 182, 69) 17%, rgb(163, 221, 99) 33%, rgb(255, 255, 0) 50%, rgb(255, 205, 0) 67%, rgb(255, 144, 0) 83%, rgb(255, 4, 0) 100%);background-image: linear-gradient(left, rgb(0, 139, 0), rgb(92, 182, 69) 17%, rgb(163, 221, 99) 33%, rgb(255, 255, 0) 50%, rgb(255, 205, 0) 67%, rgb(255, 144, 0) 83%, rgb(255, 4, 0) 100%); width: 86%; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">100</div></td></tr>';
      legend_html += '<tr id="health-impact-legend" style="display: none"><td><div style="font-size: 17px">Nutritional Deficiencies<span class="credit"> (Oxford Martin)</span></div><svg class="svg-legend" width="242" height="180"><rect width="240" height="160" fill="white" opacity="0"></rect> <g transform="translate(2,10)"> <circle class="gain" r="5" cx="5" cy="10" style="fill: #8b0000; stroke: #fff;"></circle> <circle class="loss" r="5" cx="5" cy="30" style="fill: #00008b; stroke: #fff;"></circle> <text x="15" y="13">Mean deaths per capita</text> <text x="15" y="33">Mean lives per capita</text> <circle r="10.0" cx="160.0" cy="160.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="152.0" dy="13" style="font-size: 10px; fill: #fff">5K</text><circle r="30.0" cx="160.0" cy="140.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="130.0" dy="13" style="font-size: 10px; fill: #fff">15K</text><circle r="60.0" cx="160.0" cy="110.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="80.0" dy="13" style="font-size: 10px; fill: #fff">30K</text></g> </svg></td></tr>';
      legend_html += '<tr id="sea-level-rise-legend" style="display: none"><td><div style="font-size: 17px">Global Temperature Rise <span id="slr-degree"></span> &#x2103;<span class="credit"> (Climate Central)</span></div><div style="font-size: 15px">Future Sea Level<span id="slr-feet" style="width:25px;"></span>&nbsp;<span id="slr-meters" style="width:25px; color: red;"></span></div></td></tr>';
      legend_html += '<tr id="urban-fragility-legend" style="display: none"><td><div style="font-size: 17px">Fragile Score <span class="credit"> (Igarape Institute)</span></div></div><svg class="svg-legend" width="200" height="30"> <rect fill="#313695" x="0" height="9" width="20"></rect><rect fill="#4575b4" x="20" height="9" width="20"></rect><rect fill="#74add1" x="40" height="9" width="20"></rect><rect fill="#abd9e9" x="60" height="9" width="20"></rect><rect fill="#e0f3f8" x="80" height="9" width="20"></rect><rect fill="#ffffbf" x="100" height="9" width="20"></rect><rect fill="#fee090" x="120" height="9" width="20"></rect><rect fill="#fdae61" x="140" height="9" width="20"></rect><rect fill="#f46d43" x="160" height="9" width="20"></rect><rect fill="#d73027" x="180" height="9" width="20"></rect><rect fill="#a50026" x="200" height="9" width="20"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">1.0</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="100">2.25</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="185">3.5</text></svg></td></tr>';
      legend_html += '<tr id="zika-legend" style="display: none"><td><div style="background-color:#ff8d74; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Zika Virus <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="chiku-legend" style="display: none"><td><div style="background-color:#6070ff; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Chikungunya Virus <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="dengue-legend" style="display: none"><td><div style="background-color:#a1ef5f; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Dengue Virus <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="gtd-legend" style="display: none"><td><div style="float:left; background-color:red; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -5px; font-size: 17px">Global Terrorism Database Events <span class="credit"> (UMD)</span></div></td></tr>';
      legend_html += '<tr id="uppsala-conflict-legend" style="display: none"><td><div style="float:left; background-color:red; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -5px; font-size: 17px">Organized Violence Fatalities<span class="credit"> (UCDP)</span></div></td></tr>';
      legend_html += '<tr id="hiv-legend" style="display: none"><td><div style="font-size: 17px">Annual new HIV infections <span class="credit"> (LSHTM)</span></div></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffff" x="0" height="9" width="20.0"></rect><rect fill="#ffd8e7" x="20." height="9" width="20.0"></rect><rect fill="#feb1d1" x="40." height="9" width="20.0"></rect><rect fill="#f18bbd" x="60." height="9" width="20.0"></rect><rect fill="#dd68ac" x="80." height="9" width="20.0"></rect><rect fill="#c4479e" x="100." height="9" width="20.0"></rect><rect fill="#a52792" x="120." height="9" width="20.0"></rect><rect fill="#7d0989" x="140." height="9" width="20.0"></rect><rect fill="#4b0082" x="160." height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">1K</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="35">10K</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="80">100K</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="155">850K</text></svg></td></tr>';
      legend_html += '<tr id="obesity-legend" style="display: none"><td><div style="font-size: 17px">Obesity prevalence among adults <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"> <rect fill="#ffffff" x="0" height="9" width="20"></rect><rect fill="#fff18e" x="20" height="9" width="20"></rect><rect fill="#ffdc5b" x="40" height="9" width="20"></rect><rect fill="#ffc539" x="60" height="9" width="20"></rect><rect fill="#ffad21" x="80" height="9" width="20"></rect><rect fill="#ff920c" x="100" height="9" width="20"></rect><rect fill="#ff7500" x="120" height="9" width="20"></rect><rect fill="#ff5000" x="140" height="9" width="20"></rect><rect fill="#ff0000" x="160" height="9" width="20"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="80">15%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="160">>30%</text></svg></td></tr>';
      legend_html += '<tr id="vaccine-confidence-q1-legend" style="display: none"><td><div style="font-size: 13px">Disagree that vaccines are important for children to have <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffe0" x="0" height="9" width="20.0"></rect><rect fill="#ffe3af" x="20" height="9" width="20.0"></rect><rect fill="#ffc58a" x="40" height="9" width="20.0"></rect><rect fill="#ffa474" x="60" height="9" width="20.0"></rect><rect fill="#fa8266" x="80" height="9" width="20.0"></rect><rect fill="#ed645c" x="100" height="9" width="20.0"></rect><rect fill="#db4551" x="120" height="9" width="20.0"></rect><rect fill="#c52940" x="140" height="9" width="20.0"></rect><rect fill="#aa0e27" x="160" height="9" width="20.0"></rect><rect fill="#8b0000" x="180" height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="90">8%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="180">16%</text></svg></td></tr>';
      legend_html += '<tr id="vaccine-confidence-q2-legend" style="display: none"><td><div style="font-size: 13px">Disagree that vaccines are safe <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffe0" x="0" height="9" width="20.0"></rect><rect fill="#ffe3af" x="20" height="9" width="20.0"></rect><rect fill="#ffc58a" x="40" height="9" width="20.0"></rect><rect fill="#ffa474" x="60" height="9" width="20.0"></rect><rect fill="#fa8266" x="80" height="9" width="20.0"></rect><rect fill="#ed645c" x="100" height="9" width="20.0"></rect><rect fill="#db4551" x="120" height="9" width="20.0"></rect><rect fill="#c52940" x="140" height="9" width="20.0"></rect><rect fill="#aa0e27" x="160" height="9" width="20.0"></rect><rect fill="#8b0000" x="180" height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="90">20%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="180">41%</text></svg></td></tr>';
      legend_html += '<tr id="vaccine-confidence-q3-legend" style="display: none"><td><div style="font-size: 13px">Disagree that vaccines are effective <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffe0" x="0" height="9" width="20.0"></rect><rect fill="#ffe3af" x="20" height="9" width="20.0"></rect><rect fill="#ffc58a" x="40" height="9" width="20.0"></rect><rect fill="#ffa474" x="60" height="9" width="20.0"></rect><rect fill="#fa8266" x="80" height="9" width="20.0"></rect><rect fill="#ed645c" x="100" height="9" width="20.0"></rect><rect fill="#db4551" x="120" height="9" width="20.0"></rect><rect fill="#c52940" x="140" height="9" width="20.0"></rect><rect fill="#aa0e27" x="160" height="9" width="20.0"></rect><rect fill="#8b0000" x="180" height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="90">13%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="180">26%</text></svg></td></tr>';
      legend_html += '<tr id="vaccine-confidence-q4-legend" style="display: none"><td><div style="font-size: 13px">Disagree that vaccines are compatible with my religious beliefs <span class="credit"> (LSHTM)</span></div><svg class="svg-legend" width="200" height="29"><rect fill="#ffffe0" x="0" height="9" width="20.0"></rect><rect fill="#ffe3af" x="20" height="9" width="20.0"></rect><rect fill="#ffc58a" x="40" height="9" width="20.0"></rect><rect fill="#ffa474" x="60" height="9" width="20.0"></rect><rect fill="#fa8266" x="80" height="9" width="20.0"></rect><rect fill="#ed645c" x="100" height="9" width="20.0"></rect><rect fill="#db4551" x="120" height="9" width="20.0"></rect><rect fill="#c52940" x="140" height="9" width="20.0"></rect><rect fill="#aa0e27" x="160" height="9" width="20.0"></rect><rect fill="#8b0000" x="180" height="9" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="0">0%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="90">23%</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="29" x="180">47%</text></svg></td></tr>';
      legend_html += '<tr id="ndvi-anomaly-legend" style="display: none"><td><div style="font-size: 17px">Vegetation Reduction <span class="credit"> (USGS)</span></div><div style="margin-left: 8px"><div class="ndviAnomalyLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">None</div><div style="font-size: 13px; float: right">Most Reduced</div></div></td></tr>';
      legend_html += '<tr id="ebola-deaths-legend" style="display: none"><td><div style="background-color:#ff8d74; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Ebola Deaths <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="ebola-cases-legend" style="display: none"><td><div style="background-color:#ff8d74; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Ebola Cases <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="ebola-new-cases-legend" style="display: none"><td><div style="background-color:#ff8d74; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Ebola New Cases <span class="credit"> (LSHTM)</span></div></td></tr>';
      legend_html += '<tr id="lodes-legend" style="display: none"><td><div>LODES<span class="credit"> (US Census)</span></div></td></tr>';
      legend_html += '<tr id="cumulative-active-mining-legend" style="display: none"><td><div>Active Mining<span class="credit"> (SkyTruth)</span></div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">1984</div><div style="margin-top: 3px; float: left; background-image: -webkit-linear-gradient( to right, rgb(255,255,255),rgb(128,0,0));background-image: linear-gradient(to right, rgb(255,255,255),rgb(128,0,0)); width: 50%; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">2016</div></td></tr>';
      legend_html += '<tr id="iraq-iom-idp-legend" style="display: none"><td><div>IRAQ IDPS<span class="credit"> (IOM)</span></div></td></tr>';
      legend_html += '<tr id="syria-iom-idp-legend" style="display: none"><td><div>Syria IDPS<span class="credit"> (IOM)</span></div></td></tr>';
      legend_html += '<tr id="yemen-iom-idp-legend" style="display: none"><td><div>Yemen IDPS<span class="credit"> (IOM)</span></div></td></tr>';
      legend_html += '<tr id="libya-iom-idp-legend" style="display: none"><td><div>Libya IDPS<span class="credit"> (IOM)</span></div></td></tr>';
      legend_html += '<tr id="iom-idp-legend" style="display: none"><td><div style="font-size: 17px">Internally Displaced Persons (IDPs) <br/>and Returnees<span class="credit"> (IOM)</span></div><svg class="svg-legend" width="242" height="130"><rect width="240" height="110" fill="white" opacity="0"></rect> <g transform="translate(2,10)"> <circle class="gain" r="5" cx="5" cy="10" style="fill: #8b0000; stroke: #fff;"></circle> <circle class="loss" r="5" cx="5" cy="30" style="fill: #00008b; stroke: #fff;"></circle> <text x="15" y="13">Individuals displaced</text> <text x="15" y="33">Indivdual returnees</text> <circle r="10.0" cx="160.0" cy="110.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="102.0" dy="13" style="font-size: 10px; fill: #fff">18K</text><circle r="30.0" cx="160.0" cy="90.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="80.0" dy="13" style="font-size: 10px; fill: #fff">900K</text><!--<circle r="60.0" cx="160.0" cy="110.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle> <text text-anchor="middle" x="160.0" y="80.0" dy="13" style="font-size: 10px; fill: #fff">900K</text>--></g> </svg></td></tr>';
      legend_html += '<tr id="berkeley-earth-temperature-anomaly-legend" style="display: none"><td><div style="font-size: 13px">Average Temperature Annual Anomaly 1850-2017<span class="credit"> (Berkeley Earth)</span></div><svg class="svg-legend" width="220" height="40"><text font-size="12px" fill="rgba(0, 0, 0, 1.0)" y="10" x="40">Temperature Anomaly (&#8451)</text><rect fill="#00008b" y="20" x="0" height="10" width="20.0"></rect><rect fill="#3031c9" y="20" x="20" height="10" width="20.0"></rect><rect fill="#5768e6" y="20" x="40" height="10" width="20.0"></rect><rect fill="#799ef6" y="20" x="60" height="10" width="20.0"></rect><rect fill="#a1d4fe" y="20" x="80" height="10" width="20.0"></rect><rect fill="#ffffff" y="20" x="100" height="10" width="20.0"></rect><rect fill="#ffd130" y="20" x="120" height="10" width="20.0"></rect><rect fill="#ff9500" y="20" x="140" height="10" width="20.0"></rect><rect fill="#ed5700" y="20" x="160" height="10" width="20.0"></rect><rect fill="#c42102" y="20" x="180" height="10" width="20.0"></rect><rect fill="#8b0000" y="20" x="200" height="10" width="20.0"></rect><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="0">-10</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="25">-8</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="45">-6</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="65">-4</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="85">-2</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="107">0</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="127">2</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="147">4</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="167">6</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="187">8</text><text font-size="10.5px" fill="rgba(0, 0, 0, 0.8)" y="40" x="205">10</text></svg></td></tr>';
      legend_html += '<tr id="china-aviation-legend" style="display: none"><td><div style="background-color:red; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">China Aviation <span class="credit"> (Oxford & Harvard)</span></div></td></tr>';
      legend_html += '<tr id="china-power-plants-legend" style="display: none"><td><div style="background-color:green; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">China Power Plants <span class="credit"> (Oxford & Harvard)</span></div></td></tr>';
      legend_html += '<tr id="china-reservoirs-legend" style="display: none"><td><div style="background-color:blue; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">China Reservoirs <span class="credit"> (Oxford & Harvard)</span></div></td></tr>';
      legend_html += '<tr id="china-waste-treatment-plants-legend" style="display: none"><td><div style="background-color:orange; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">China Waste Treatment Plants <span class="credit"> (Oxford & Harvard)</span></div></td></tr>';
      legend_html += '<tr id="omi-no2-legend" style="display:none"><td><div style="font-size: 13px">OMI NO2 2005-2016<span class="credit"> (NOAA)</span></div><svg class="svg-legend" width="220" height="40"><rect fill="rgb(68, 160, 216)" y="20" x="0" height="10" width="40.0"></rect><rect fill="rgb(171, 215, 176)" y="20" x="40" height="10" width="40.0"></rect><rect fill="rgb(253, 230, 132)" y="20" x="80" height="10" width="40.0"></rect><rect fill="rgb(252, 136, 80)" y="20" x="120" height="10" width="40.0"></rect><rect fill="rgb(232, 0, 28)" y="20" x="160" height="10" width="40.0"></rect><text font-size="12px" fill="rgba(0, 0, 0, 0.8)" y="40" x="5">LOW</text><text font-size="12px" fill="rgba(0, 0, 0, 0.8)" y="40" x="165">HIGH</text></svg></td></tr>';
      legend_html += '<tr id="be-pm25-legend" style="display:none"><td><div style="font-size: 14px">PM2.5<span class="credit"> (Berkeley Earth)</span></div><svg class="svg-legend" width="320" height="50"><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="0">0.0</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="40">12.0</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="92">35.5</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="142">55.5</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="192">150.5</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="242">250.5</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="15" x="287">500.0</text><rect fill="rgb(12, 231, 0)"  y="20" x="0" height="10" width="50.0"></rect><rect fill="rgb(255, 255, 0)" y="20" x="50" height="10" width="50.0"></rect><rect fill="rgb(255, 105, 0)" y="20" x="100" height="10" width="50.0"></rect><rect fill="rgb(255, 0, 0)"   y="20" x="150" height="10" width="50.0"></rect><rect fill="rgb(135, 0, 59)"  y="20" x="200" height="10" width="50.0"></rect><rect fill="rgb(107, 0, 25)"  y="20" x="250" height="10" width="50.0"></rect><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="10">Good</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="55">Moderate</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="105">Unhealthy</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="150">+Unhealthy</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="200">++Unhealthy</text><text font-size="10px" fill="rgba(0, 0, 0, 0.8)" y="40" x="255">Hazardous</text></svg></td></tr>';

      legend_html += '<tr id="expanding-cities-legend" style="display: none"><td><div style="background-color:silver; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">Expanding Cities <span class="credit"> (Igarapé)</span></div></div></td></tr>';
      legend_html += '<tr id="irena-legend" style="display: none"><td><div style="font-size: 15px">Electric Capacity per Country<span class="credit"> (IRENA)</span></div><svg class="svg-legend" width="240" height="170"><circle class="gain" r="10" cx="15" cy="10" style="fill: blue; stroke: #fff;"></circle> <text x="30" y="15" style="font-size: 12px; fill: #fff">Wind power (GWh)</text> <circle class="gain" r="10" cx="15" cy="35" style="fill: purple; stroke: #fff;"></circle><text x="30" y="40" style="font-size: 12px; fill: #fff">Solar power (GWh)</text> <circle r="25.0" cx="120.0" cy="122.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle><circle r="40.0" cx="120.0" cy="107.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle><circle r="50.0" cx="120.0" cy="97.0" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle><text text-anchor="middle" x="120.0" y="112.0" dy="13" style="font-size: 10px; fill: #fff">25K</text><text text-anchor="middle" x="120.0" y="77.0" dy="13" style="font-size: 10px; fill: #fff">64K</text><text text-anchor="middle" x="120.0" y="52.0" dy="13" style="font-size: 10px; fill: #fff">100K</text></svg></td></tr>';

      legend_html += '<tr id="carbon-price-risk-legend" style="display: none"><td>' + carbonPriceRisk.getLegend().str + '</td></tr>';

      var tsipStr = '<div style="font-size: 15px">Toxic Sites Identification Program<span class="credit"> (PureEarth)</span></div><svg class="svg-legend" width="240" height="35"><circle class="gain" r="10" cx="15" cy="10" style="fill: brown; stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">Sites (size relative to Blacksmith Index)</text><!--<circle r="10.0" cx="120.0" cy="50" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle><text text-anchor="middle" x="120.0" y="45" dy="10" style="font-size: 10px; fill: #fff">5</text><circle r="20.0" cx="120.0" cy="40" vector-effect="non-scaling-stroke" style="fill: none; stroke: #999"></circle><text text-anchor="middle" x="120.0" y="25" dy="10" style="font-size: 10px; fill: #fff">10</text>--></svg>';
      var tsipLegend = new BubbleMapLegend({"id" : "tsip", "str": tsipStr});
      legend_html += tsipLegend.toString();

      legend_html += '<tr id="sp-crude-legend" style="display: none"><td><div style="font-size: 15px">Crude Oil Flows<span> (S&P Global)</div><svg class="svg-legend" width="240" height="220"><circle class="gain" r="10" cx="15" cy="10" style="fill: red; stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">Middle East</text><circle class="gain" r="10" cx="15" cy="35" style="fill: blue; stroke: #fff;"></circle><text x="30" y="40" style="font-size: 12px; fill: #fff">North Africa</text><circle class="gain" r="10" cx="15" cy="60" style="fill: green; stroke: #fff;"></circle><text x="30" y="65" style="font-size: 12px; fill: #fff">North Sea</text><circle class="gain" r="10" cx="15" cy="85" style="fill: yellow; stroke: #fff;"></circle><text x="30" y="90" style="font-size: 12px; fill: #fff">Urals</text><circle class="gain" r="10" cx="15" cy="110" style="fill: purple; stroke: #fff;"></circle><text x="30" y="115" style="font-size: 12px; fill: #fff">US Golf Coast</text><circle class="gain" r="10" cx="15" cy="135" style="fill: orange; stroke: #fff;"></circle><text x="30" y="140" style="font-size: 12px; fill: #fff">West Africa</text></svg></td></tr>';
      legend_html += '<tr id="sp-crude-legend_AG" style="display: none"><td><div style="font-size: 15px">Arab Gulf Crude Oil Flows<span> (S&P Global)</div><svg class="svg-legend" width="240" height="35"><circle class="gain" r="10" cx="15" cy="10" style="fill: rgb(228, 26, 28); stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">Arab Gulf</text></svg></td></tr>';
      legend_html += '<tr id="sp-crude-legend_WAF" style="display: none"><td><div style="font-size: 15px">West Africa Crude Oil Flows<span> (S&P Global)</div><svg class="svg-legend" width="240" height="35"><circle class="gain" r="10" cx="15" cy="10" style="fill: rgb(255, 127, 0); stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">West Africa</text></svg></td></tr>';
      legend_html += '<tr id="sp-crude-legend_MedNAF" style="display: none"><td><div style="font-size: 15px">Mediterranean Crude Oil Flows<span> (S&P Global)</div><svg class="svg-legend" width="240" height="35"><circle class="gain" r="10" cx="15" cy="10" style="fill: rgb(55, 126, 184); stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">Mediterranean</text></svg></td></tr>';
      legend_html += '<tr id="sp-crude-legend_NS" style="display: none"><td><div style="font-size: 15px">North Sea Crude Oil Flows<span> (S&P Global)</div><svg class="svg-legend" width="240" height="35"><circle class="gain" r="10" cx="15" cy="10" style="fill: rgb(77, 175, 74); stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">North Sea</text></svg></td></tr>';
      legend_html += '<tr id="sp-crude-legend_USGC" style="display: none"><td><div style="font-size: 15px">U.S. Gulf Coast Crude Oil Flows<span> (S&P Global)</div><svg class="svg-legend" width="240" height="35"><circle class="gain" r="10" cx="15" cy="10" style="fill: rgb(152, 78, 163); stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">U.S. Gulf Coast</text></svg></td></tr>';
      legend_html += '<tr id="sp-crude-legend_LatAM" style="display: none"><td><div style="font-size: 15px">Latin America Crude Oil Flows<span> (S&P Global)</div><svg class="svg-legend" width="240" height="35"><circle class="gain" r="10" cx="15" cy="10" style="fill: rgb(247, 129, 191); stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">Latin America</text></svg></td></tr>';
      legend_html += '<tr id="sp-crude-legend_Oceania" style="display: none"><td><div style="font-size: 15px">Oceania Crude Oil Flows<span> (S&P Global)</div><svg class="svg-legend" width="240" height="35"><circle class="gain" r="10" cx="15" cy="10" style="fill: rgb(166, 86, 40); stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">Oceania</text></svg></td></tr>';
      legend_html += '<tr id="sp-crude-legend_Urals" style="display: none"><td><div style="font-size: 15px">Urals Crude Oil Flows<span> (S&P Global)</div><svg class="svg-legend" width="240" height="35"><circle class="gain" r="10" cx="15" cy="10" style="fill: rgb(255, 255, 51); stroke: #fff;"></circle><text x="30" y="15" style="font-size: 12px; fill: #fff">Urals</text></svg></td></tr>';

      // ## 5b ##
      //// Add to layer legend ////
      //
      legend_html += '</table>';
      legend_html += '</div>';
      legend_html += '</div>';

      $(layer_html).appendTo($("#layers-menu"));
      $(legend_html).appendTo($("#timeMachine .player"));

      if (enableLetterboxMode) {
        $(".presentationSlider, .current-location-text-container, .annotations-resume-exit-container, .annotation-nav, .player, #csvChartContainer").addClass("letterbox");
      } else {
        $nextAnnotationLocationButton = $('.next-annotation-location');
        $nextAnnotationLocationButton.button({
          icons: {
            primary: "ui-icon-right-arrow"
          },
          text: false
        }).click(function() {
          var e = jQuery.Event("keydown");
          e.which = 33;
          e.keyCode = 33;
          $(document).trigger(e);
        });

        $previousAnnotationLocationButton = $('.previous-annotation-location');
        $previousAnnotationLocationButton.button({
          icons: {
            primary: "ui-icon-left-arrow"
          },
          text: false
        }).click(function() {
          var e = jQuery.Event("keydown");
          e.which = 34;
          e.keyCode = 34;
          $(document).trigger(e);
        });

        var $controlsContainer = $("<div id='controlsContainer' />");

        var $appControls = $("<div id='appControls' />");
        $appControls.appendTo($controlsContainer);

        if (showShareButton) {
          var $shareBtn = $('<button class="sharing controlButton" title="Share"></button>');
          $shareBtn.button({
            icons: {
              primary: "ui-icon-custom-share"
            },
            text: false
          }).click(function() {
            $(".share").trigger("click");
          });
          $shareBtn.appendTo($appControls);
        }

        if (showSettingsButton) {
          var $settingsBtn = $('<button class="settings controlButton" title="Settings"></button>');
          $settingsBtn.button({
            icons: {
              primary: "ui-icon-custom-gear"
            },
            text: false
          }).click(function() {
            if (settingsDialog && settingsDialog.is(":visible")) {
              settingsDialog.dialog("close");
            } else {
              showSettingsDialog();
            }
          });
          $settingsBtn.appendTo($appControls);
        }

        var $navigationControls = $("<div id='navControls' />");

        $navigationControls.appendTo($controlsContainer);

        var $zoomControls = $($(".zoom > *").not(".zoomSlider, .zoomall")).addClass("controlButton");
        $zoomControls.appendTo($navigationControls);

        $controlsContainer.appendTo($("#timeMachine .player"));

        $appControls.css("top", ($navigationControls.height() + 20) + "px");

        // Hide any tables that have all their children
        // hidden (i.e. all layers of that topic are hidden)
        $("#layers-list").find('table').each(function() {
          if ($($(this)[0]).children().length == 0) {
            $(this).prev().hide();
          }
        });

        // Add clear active layer button
        var $clearLayersBtn = $(".clearLayers");
        $clearLayersBtn.button({
          icons: {
            primary: "clearLayersIcon"
          },
          showLabel: true,
          label: "Clear Active Layers",
          text: "Clear Active Layers"
        }).click(function() {
          var e = jQuery.Event("keydown");
          e.which = 67;
          e.keyCode = 67;
          $("body").trigger(e);
          UTIL.addGoogleAnalyticEvent('button', 'click', 'viewer-clear-active-layers');
        });
      }

      if (isHyperwall) {
        $("#layers-list, #layers-legend, .base-map-div, .customZoomhelp, #logosContainer").addClass("hyperwall");
      }


      // ## 6 ##
      //// Layer options and initialization ////
      //

      // Landsat
      var landsatTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax[cachedLandsatTimeJsonPath]['capture-times'].length,
        fps: 10,
        startYear: 1984
      };
      landsatBaseMapLayer = new WebglTimeMachineLayer(glb, canvasLayer, landsatUrl, landsatTimeMachineLayerOptions);

      // NDVI Anomaly
      var ndviAnomalyTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['ndvi-anomaly-times.json']['capture-times'].length,
        fps: 1,
        video_width: 1424,
        video_height: 800,
        width: 40076,
        height: 40076,
        greenScreen: true
      };
      ndviAnomalyTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, ndviAnomalyTimeMachineUrl, ndviAnomalyTimeMachineLayerOptions);

      // Coral Bleaching Alerts
      var crwTimemacineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['crw-times.json']['capture-times'].length,
        fps: 22,
        video_width: 1424,
        video_height: 800,
        width: 7200,
        height: 7200,
        greenScreen: true
      };
      crwTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, crwTimeMachineUrl, crwTimemacineLayerOptions);

      // Himawari-8
      var himawariTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['himawari-times.json']['capture-times'].length,
        fps: 12,
        nLevels: 4,
        video_width: 1424,
        video_height: 800,
        width: 11000,
        height: 11000
      };
      himawariTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, himawariTimeMachineUrl, himawariTimeMachineLayerOptions);

      // GOES16
      var goes16TimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['goes16-times.json']['capture-times'].length,
        fps: 12,
        nLevels: 4,
        video_width: 1424,
        video_height: 800,
        width: 10848,
        height: 10848
      };
      goes16TimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, goes16TimeMachineUrl, goes16TimeMachineLayerOptions);

      // DSCOVR
      var dscovrTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['dscovr-times.json']['capture-times'].length,
        fps: 6,
        nLevels: 3,
        video_width: 1424,
        video_height: 800,
        width: 2048,
        height: 2048
      };
      dscovrTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, dscovrTimeMachineUrl, dscovrTimeMachineLayerOptions);

      // Annual Global PM 2.5
      var annualGlobalPm25TimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['annual-global-pm25-times.json']['capture-times'].length,
        fps: 6,
        nLevels: 5,
        video_width: 1424,
        video_height: 800,
        width: 7200,
        height: 7200,
        colormap: rootTilePath + '/colormaps/pm25-who-annual.png'
      };
      annualGlobalPm25TimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, annualGlobalPm25TimeMachineUrl, annualGlobalPm25TimeMachineLayerOptions);

      // Forest Alerts
      var forestAlertsTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['forest-alerts-times.json']['capture-times'].length,
        fps: 10,
        nLevels: 11,
        video_width: 1424,
        video_height: 800,
        width: 750836,
        height: 156136
      };
      forestAlertsTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsTimeMachineUrl, forestAlertsTimeMachineLayerOptions);

      // Forest Alerts No Overlay
      var forestAlertsNoOverlayTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['forest-alerts-times.json']['capture-times'].length,
        fps: 10,
        nLevels: 11,
        video_width: 1424,
        video_height: 800,
        width: 750836,
        height: 156136
      };
      forestAlertsNoOverlayTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsNoOverlayTimeMachineUrl, forestAlertsTimeMachineLayerOptions);

      // Berkeley Earth Temperature Anomaly
      var berkeleyEarthTemperatureAnomalyTimeMachineLayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['berkeley-earth-temperature-anomaly-times.json']['capture-times'].length,
        fps: 12,
        nLevels: 2,
        video_width: 1424,
        video_height: 800,
        width: 1024,
        height: 1024
      };
      berkeleyEarthTemperatureAnomalyTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, berkeleyEarthTemperatureAnomalyTimeMachineUrl, berkeleyEarthTemperatureAnomalyTimeMachineLayerOptions);

      // OMI NO2
      var omiNo2LayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['omi-no2-times.json']['capture-times'].length,
        fps: 12,
        nlevels: 4,
        video_width: 1424,
        video_height: 800,
        width: 5760,
        height: 5760,
        greenScreen: true
      };
      omiNo2Layer = new WebglTimeMachineLayer(glb, canvasLayer, omiNo2Url, omiNo2LayerOptions);

      // Berkeley Earth PM 2.5
      var bePm25LayerOptions = {
        mediaType: ".mp4",
        numFrames: cached_ajax['be-pm25-times.json']['capture-times'].length,
        fps: 22,
        nlevels: 5,
        video_width: 1424,
        video_height: 800,
        width: 8192,
        height: 8192,
        greenScreen: true
      };
      bePm25Layer = new WebglTimeMachineLayer(glb, canvasLayer, bePm25Url, bePm25LayerOptions);

      // For any raster map
      var defaultMapLayerOptions = {
        nLevels: 12,
        tileWidth: 256,
        tileHeight: 256
      };

      // For any retina raster map
      var retinaMapLayerOptions = {
        nLevels: useGoogleMaps ? 20 : 11,
        tileWidth: 512,
        tileHeight: 512
      };

      // For the light/dark base layers
      var defaultBaseMapLayerOptions = {
        nLevels: useGoogleMaps ? 20 : 11,
        tileWidth: 256,
        tileHeight: 256
      };

      var baseMapLayerOptions = isHyperwall ? retinaMapLayerOptions : defaultBaseMapLayerOptions;

      lightBaseMapLayer = new WebglMapLayer(glb, canvasLayer, lightMapUrl, defaultBaseMapLayerOptions);
      darkBaseMapLayer = new WebglMapLayer(glb, canvasLayer, darkMapUrl, defaultBaseMapLayerOptions);
      hansenMapLayer = new WebglMapLayer(glb, canvasLayer, gfcTransUrl, defaultMapLayerOptions);
      hansenMapLayer2 = new WebglMapLayer(glb, canvasLayer, gfcLossGainUrl, defaultMapLayerOptions);
      waterOccurrenceLayer = new WebglMapLayer(glb, canvasLayer, waterOccurrenceUrl, defaultBaseMapLayerOptions);
      waterChangeLayer = new WebglMapLayer(glb, canvasLayer, waterChangeUrl, defaultBaseMapLayerOptions);

      landBorderLayer = new WebglMapLayer(glb, canvasLayer, landBorderUrl, defaultBaseMapLayerOptions);
      countryLabelMapLayer = new WebglMapLayer(glb, canvasLayer, countryLabelMapUrl, defaultBaseMapLayerOptions);
      cityLabelMapLayer = new WebglMapLayer(glb, canvasLayer, cityLabelMapUrl, defaultBaseMapLayerOptions);

      // Vegetation Sensitivity Index
      vsiLayer = new WebglMapLayer(glb, canvasLayer, vsiUrl, defaultMapLayerOptions);

      // Coral Reefs (in pink)
      var mcrmVectorLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        numAttributes: 2
      };
      mcrmVectorLayer = new WebglVectorLayer2(glb, canvasLayer, mcrmUrl, mcrmVectorLayerOptions);

      // Coral Bleaching Events
      var coralBleachingLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader,
        numAttributes: 3
      };
      coralBleachingLayer = new WebglVectorLayer2(glb, canvasLayer, coralBleachingUrl, coralBleachingLayerOptions);

      var lightsAtNightMapLayerOptions = {
        nLevels: 8,
        tileWidth: 256,
        tileHeight: 256
      };
      lightsAtNightMapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNightUrl, lightsAtNightMapLayerOptions);

      var lightsAtNight2012MapLayerOptions = {
        nLevels: 9,
        tileWidth: 256,
        tileHeight: 256
      };
      lightsAtNight2012MapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNight2012Url, lightsAtNight2012MapLayerOptions);

      var lightsAtNight2016MapLayerOptions = {
        nLevels: 9,
        tileWidth: 256,
        tileHeight: 256
      };
      lightsAtNight2016MapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNight2016Url, lightsAtNight2016MapLayerOptions);

      var animatedHansenLayerOptions = {
        nLevels: 12,
        tileWidth: 256,
        tileHeight: 256
      };
      animatedHansenLayer = new WebglMapLayer2(glb, canvasLayer, animatedHansenUrls, animatedHansenLayerOptions);

      var viirsLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawViirs,
        fragmentShader: WebGLVectorTile2.viirsFragmentShader,
        vertexShader: WebGLVectorTile2.viirsVertexShader,
        numAttributes: 3
      };
      viirsLayer = new WebglVectorLayer2(glb, canvasLayer, viirsUrl, viirsLayerOptions);

      var wdpaLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 11,
        drawFunction: WebGLVectorTile2.prototype._drawWdpa,
        fragmentShader: WebGLVectorTile2.wdpaFragmentShader,
        vertexShader: WebGLVectorTile2.wdpaVertexShader,
        numAttributes: 3
      };
      wdpaLayer = new WebglVectorLayer2(glb, canvasLayer, wdpaUrl, wdpaLayerOptions);

      var usgsWindturbineLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader,
        numAttributes: 3
      };
      usgsWindTurbineLayer = new WebglVectorLayer2(glb, canvasLayer, usgsWindTurbineUrl, usgsWindturbineLayerOptions);

      var globalWindPowerLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader,
        numAttributes: 3
      };
      globalWindPowerLayer = new WebglVectorLayer2(glb, canvasLayer, globalWindPowerUrl, globalWindPowerLayerOptions);

      var solarInstallsLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader,
        numAttributes: 3
      };
      solarInstallsLayer = new WebglVectorLayer2(glb, canvasLayer, solarInstallsUrl, solarInstallsLayerOptions);

      var drillingLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader,
        numAttributes: 3
      };
      drillingLayer = new WebglVectorLayer2(glb, canvasLayer, drillingUrl, drillingLayerOptions);

      var monthlyRefugeesLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawMonthlyRefugees,
        fragmentShader: WebGLVectorTile2.monthlyRefugeesFragmentShader,
        vertexShader: WebGLVectorTile2.monthlyRefugeesVertexShader,
        numAttributes: 10
      };
      monthlyRefugeesLayer = new WebglVectorLayer2(glb, canvasLayer, monthlyRefugeesUrl, monthlyRefugeesLayerOptions);

      var annualRefugeesLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawAnnualRefugees,
        fragmentShader: WebGLVectorTile2.annualRefugeesFragmentShader,
        vertexShader: WebGLVectorTile2.annualRefugeesVertexShader,
        imageSrc: "annual-refugees-color-map.png",
        numAttributes: 7
      };
      annualRefugeesLayer = new WebglVectorLayer2(glb, canvasLayer, annualRefugeesUrl, annualRefugeesLayerOptions);

      var annualReturnsLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawAnnualRefugees,
        fragmentShader: WebGLVectorTile2.annualRefugeesFragmentShader,
        vertexShader: WebGLVectorTile2.annualRefugeesVertexShader,
        imageSrc: "annual-returns-color-map.png",
        numAttributes: 7
      };
      annualReturnsLayer = new WebglVectorLayer2(glb, canvasLayer, annualReturnsUrl, annualReturnsLayerOptions);

      var healthImpactLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawHealthImpact,
        fragmentShader: WebGLVectorTile2.healthImpactFragmentShader,
        vertexShader: WebGLVectorTile2.healthImpactVertexShader,
        numAttributes: 6
      };
      healthImpactLayer = new WebglVectorLayer2(glb, canvasLayer, healthImpactUrl, healthImpactLayerOptions);

      var zikaLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader,
        numAttributes: 3
      };
      zikaLayer = new WebglVectorLayer2(glb, canvasLayer, zikaUrl, zikaLayerOptions);

      var dengueLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader,
        numAttributes: 3
      };
      dengueLayer = new WebglVectorLayer2(glb, canvasLayer, dengueUrl, dengueLayerOptions);

      var chikuLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader,
        numAttributes: 3
      };
      chikuLayer = new WebglVectorLayer2(glb, canvasLayer, chikuUrl, chikuLayerOptions);

      var seaLevelRiseLayerOptions = {
        nLevels: 9,
        tileWidth: 256,
        tileHeight: 256,
        fragmentShader: WebglMapTile.seaLevelRiseTextureFragmentShader,
        drawFunction: WebglMapTile.prototype._drawSeaLevelRise
      };
      seaLevelRiseLayer = new WebglMapLayer(glb, canvasLayer, seaLevelRiseUrl, seaLevelRiseLayerOptions);

      var urbanFragilityLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawUrbanFragility,
        fragmentShader: WebGLVectorTile2.urbanFragilityFragmentShader,
        vertexShader: WebGLVectorTile2.urbanFragilityVertexShader,
        imageSrc: "urban-fragility-color-map.png",
        numAttributes: 5
      };
      urbanFragilityLayer = new WebglVectorLayer2(glb, canvasLayer, urbanFragilityUrl, urbanFragilityLayerOptions);

      var gtdLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawGtd,
        fragmentShader: WebGLVectorTile2.gtdFragmentShader,
        vertexShader: WebGLVectorTile2.gtdVertexShader,
        numAttributes: 4
      };
      gtdLayer = new WebglVectorLayer2(glb, canvasLayer, gtdUrl, gtdLayerOptions);

      var uppsalaConflictLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawUppsalaConflict,
        fragmentShader: WebGLVectorTile2.uppsalaConflictFragmentShader,
        vertexShader: WebGLVectorTile2.uppsalaConflictVertexShader,
        numAttributes: 5
      };
      uppsalaConflictLayer = new WebglVectorLayer2(glb, canvasLayer, uppsalaConflictUrl, uppsalaConflictLayerOptions);

      var hivLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawUrbanFragility,
        fragmentShader: WebGLVectorTile2.hivFragmentShader,
        vertexShader: WebGLVectorTile2.hivVertexShader,
        imageSrc: "hiv-color-map.png",
        numAttributes: 5
      };
      hivLayer = new WebglVectorLayer2(glb, canvasLayer, hivUrl, hivLayerOptions);

      var obesityLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setObesityData,
        loadDataFunction: WebGLVectorTile2.prototype._loadGeojsonData,
        drawFunction: WebGLVectorTile2.prototype._drawObesity,
        fragmentShader: WebGLVectorTile2.obesityFragmentShader,
        vertexShader: WebGLVectorTile2.obesityVertexShader,
        imageSrc: "obesity-color-map.png"
      };
      obesityLayer = new WebglVectorLayer2(glb, canvasLayer, obesityUrl, obesityLayerOptions);

      var vaccineConfidenceLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        setDataFunction: WebGLVectorTile2.prototype._setVaccineConfidenceData,
        loadDataFunction: WebGLVectorTile2.prototype._loadGeojsonData,
        drawFunction: WebGLVectorTile2.prototype._drawVaccineConfidence,
        fragmentShader: WebGLVectorTile2.vaccineConfidenceFragmentShader,
        vertexShader: WebGLVectorTile2.vaccineConfidenceVertexShader,
        imageSrc: "vaccine-confidence-color-map.png"
      };
      vaccineConfidenceLayer = new WebglVectorLayer2(glb, canvasLayer, vaccineConfidenceUrl, vaccineConfidenceLayerOptions);

      var ebolaLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawBubbleMap,
        fragmentShader: WebGLVectorTile2.bubbleMapFragmentShader,
        vertexShader: WebGLVectorTile2.bubbleMapVertexShader,
        numAttributes: 6
      };
      ebolaDeathsLayer = new WebglVectorLayer2(glb, canvasLayer, ebolaDeathsUrl, ebolaLayerOptions);
      ebolaCasesLayer = new WebglVectorLayer2(glb, canvasLayer, ebolaCasesUrl, ebolaLayerOptions);
      ebolaNewCasesLayer = new WebglVectorLayer2(glb, canvasLayer, ebolaNewCasesUrl, ebolaLayerOptions);

      var lodesLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 10,
        drawFunction: WebGLVectorTile2.prototype._drawLodes,
        fragmentShader: WebGLVectorTile2.lodesFragmentShader,
        vertexShader: WebGLVectorTile2.lodesVertexShader,
        numAttributes: 6
      };
      lodesLayer = new WebglVectorLayer2(glb, canvasLayer, lodesUrl, lodesLayerOptions);

      var cumulativeActiveMiningLayerOptions = {
        nLevels: 12,
        tileWidth: 256,
        tileHeight: 256,
        fragmentShader: WebglMapTile.animatedTextureFragmentShader,
        drawFunction: WebglMapTile.prototype._drawAnimatedTexture
      };
      cumulativeActiveMiningLayer = new WebglMapLayer(glb, canvasLayer, cumulativeActiveMiningUrl, cumulativeActiveMiningLayerOptions);

      var iomIdpLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        loadDataFunction: WebGLVectorTile2.prototype._loadGeojsonData,
        setDataFunction: WebGLVectorTile2.prototype._setIomIdpData,
        drawFunction: WebGLVectorTile2.prototype._drawIomIdp,
        fragmentShader: WebGLVectorTile2.iomIdpFragmentShader,
        vertexShader: WebGLVectorTile2.iomIdpVertexShader
      };
      iomIdpLayer = new WebglVectorLayer2(glb, canvasLayer, iomIdpUrl, iomIdpLayerOptions);
      iomIdpLayer.options = {
        'showIrqIdps': false,
        'showSyrIdps': false,
        'showYemIdps': false,
        'showLbyIdps': false,
        'showIrqReturns': false,
        'showSyrReturns': false,
        'showYemReturns': false,
        'showLbyReturns': false
      };

      var chinaLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawPoints,
        fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
        vertexShader: WebGLVectorTile2.vectorPointTileVertexShader,
        numAttributes: 3
      };
      chinaAviationLayer = new WebglVectorLayer2(glb, canvasLayer, chinaAviationUrl, chinaLayerOptions);
      chinaPowerPlantsLayer = new WebglVectorLayer2(glb, canvasLayer, chinaPowerPlantsUrl, chinaLayerOptions);
      chinaReservoirsLayer = new WebglVectorLayer2(glb, canvasLayer, chinaReservoirsUrl, chinaLayerOptions);
      chinaWasteTreatmentPlantsLayer = new WebglVectorLayer2(glb, canvasLayer, chinaWasteTreatmentPlantsUrl, chinaLayerOptions);

      var expandingCitiesLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawTimeSeriesPointData,
        fragmentShader: WebGLVectorTile2.timeSeriesPointDataFragmentShader,
        vertexShader: WebGLVectorTile2.timeSeriesPointDataVertexShader,
        numAttributes: 6
      };
      expandingCitiesLayer = new WebglVectorLayer2(glb, canvasLayer, expandingCitiesUrl, expandingCitiesLayerOptions);

      var irenaSolarLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        scalingFunction: 'd3.scaleSqrt().domain([0,100000]).range([0, 100])',
        loadDataFunction: WebGLVectorTile2.prototype._loadBubbleMapDataFromCsv,
        drawFunction: WebGLVectorTile2.prototype._drawBubbleMap,
        fragmentShader: WebGLVectorTile2.bubbleMapFragmentShader,
        vertexShader: WebGLVectorTile2.bubbleMapVertexShader,
        numAttributes: 6
      };
      irenaSolarLayer = new WebglVectorLayer2(glb, canvasLayer, irenaSolarUrl, irenaSolarLayerOptions);

      var irenaWindLayerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        scalingFunction: 'd3.scaleSqrt().domain([0,100000]).range([0, 100])',
        loadDataFunction: WebGLVectorTile2.prototype._loadBubbleMapDataFromCsv,
        drawFunction: WebGLVectorTile2.prototype._drawBubbleMap,
        fragmentShader: WebGLVectorTile2.bubbleMapFragmentShader,
        vertexShader: WebGLVectorTile2.bubbleMapVertexShader,
        numAttributes: 6
      };
      irenaWindLayer = new WebglVectorLayer2(glb, canvasLayer, irenaWindUrl, irenaWindLayerOptions);

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        loadDataFunction: WebGLVectorTile2.prototype._loadCarbonPriceRiskDataFromCsv,
        drawFunction: WebGLVectorTile2.prototype._drawCarbonPriceRisk,
        fragmentShader: WebGLVectorTile2.carbonPriceRiskFragmentShader,
        vertexShader: WebGLVectorTile2.carbonPriceRiskVertexShader,
        externalGeojson: "https://data.cmucreatelab.org/msc/carbon-price-risk.geojson",
        numAttributes: 9
      };
      carbonPriceRiskLayer = new WebglVectorLayer2(glb, canvasLayer, carbonPriceRiskUrl, layerOptions);

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawTsip,
        fragmentShader: WebGLVectorTile2.tsipFragmentShader,
        vertexShader: WebGLVectorTile2.tsipVertexShader,
        numAttributes: 5
      };
      tsipLayer = new WebglVectorLayer2(glb, canvasLayer, tsipUrl, layerOptions);

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawSpCrude,
        fragmentShader: WebGLVectorTile2.spCrudeFragmentShader,
        vertexShader: WebGLVectorTile2.spCrudeVertexShader,
        numAttributes: 7
      };
      spCrudeLayer = new WebglVectorLayer2(glb, canvasLayer, spCrudeUrl, layerOptions);
      spCrudeLayer.buffers = [];

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawSpCrude,
        fragmentShader: WebGLVectorTile2.spCrudeFragmentShader,
        vertexShader: WebGLVectorTile2.spCrudeVertexShader,
        numAttributes: 7
      };
      spCrudeLayerOceania = new WebglVectorLayer2(glb, canvasLayer, spCrudeUrlOceania, layerOptions);
      spCrudeLayerOceania.buffers = [];

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawSpCrude,
        fragmentShader: WebGLVectorTile2.spCrudeFragmentShader,
        vertexShader: WebGLVectorTile2.spCrudeVertexShader,
        numAttributes: 7
      };
      spCrudeLayerAG = new WebglVectorLayer2(glb, canvasLayer, spCrudeUrlAG, layerOptions);
      spCrudeLayerAG.buffers = [];

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawSpCrude,
        fragmentShader: WebGLVectorTile2.spCrudeFragmentShader,
        vertexShader: WebGLVectorTile2.spCrudeVertexShader,
        numAttributes: 7
      };
      spCrudeLayerWAF = new WebglVectorLayer2(glb, canvasLayer, spCrudeUrlWAF, layerOptions);
      spCrudeLayerWAF.buffers = [];

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawSpCrude,
        fragmentShader: WebGLVectorTile2.spCrudeFragmentShader,
        vertexShader: WebGLVectorTile2.spCrudeVertexShader,
        numAttributes: 7
      };
      spCrudeLayerMedNAF = new WebglVectorLayer2(glb, canvasLayer, spCrudeUrlMedNAF, layerOptions);
      spCrudeLayerMedNAF.buffers = [];

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawSpCrude,
        fragmentShader: WebGLVectorTile2.spCrudeFragmentShader,
        vertexShader: WebGLVectorTile2.spCrudeVertexShader,
        numAttributes: 7
      };
      spCrudeLayerUrals = new WebglVectorLayer2(glb, canvasLayer, spCrudeUrlUrals, layerOptions);
      spCrudeLayerUrals.buffers = [];

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawSpCrude,
        fragmentShader: WebGLVectorTile2.spCrudeFragmentShader,
        vertexShader: WebGLVectorTile2.spCrudeVertexShader,
        numAttributes: 7
      };
      spCrudeLayerUSGC = new WebglVectorLayer2(glb, canvasLayer, spCrudeUrlUSGC, layerOptions);
      spCrudeLayerUSGC.buffers = [];

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawSpCrude,
        fragmentShader: WebGLVectorTile2.spCrudeFragmentShader,
        vertexShader: WebGLVectorTile2.spCrudeVertexShader,
        numAttributes: 7
      };
      spCrudeLayerLatAM = new WebglVectorLayer2(glb, canvasLayer, spCrudeUrlLatAM, layerOptions);
      spCrudeLayerLatAM.buffers = [];

      var layerOptions = {
        tileWidth: 256,
        tileHeight: 256,
        nLevels: 0,
        drawFunction: WebGLVectorTile2.prototype._drawSpCrude,
        fragmentShader: WebGLVectorTile2.spCrudeFragmentShader,
        vertexShader: WebGLVectorTile2.spCrudeVertexShader,
        numAttributes: 7
      };
      spCrudeLayerNS = new WebglVectorLayer2(glb, canvasLayer, spCrudeUrlNS, layerOptions);
      spCrudeLayerNS.buffers = [];


      // Layer Toggle UI
      initLayerToggleUI();

      // TODO: Why is this element of TimeMachine outside the controls container?
      $(".captureTime").prependTo(".controls");

      snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
      if (snaplapseForPresentationSlider) {
        snaplapseViewerForPresentationSlider = snaplapseForPresentationSlider.getSnaplapseViewer();
      }

      if (isMobileDevice) {
        $(".current-location-text-container").addClass("current-location-text-container-touchFriendly");
        $(".annotations-resume-exit-container").addClass("annotations-resume-exit-container-touchFriendly");
        $("#logosContainer").addClass("logosContainer-touchFriendly");
      }

      if (snaplapseViewerForPresentationSlider) {
        $('.presentationSlider').show();
        var $elements = $('#layers-legend, #theme-title-container, .current-location-text-container, .annotations-resume-exit-container, .presentationSlider, .customControl, .controls, .captureTime, .scaleBarContainer, .snaplapse_keyframe_container, .keyframeSubtitleBoxForHovering, .snaplapse_keyframe_list_item_presentation, .snaplapse_keyframe_list_item_thumbnail_overlay_presentation');
        if (isHyperwall)
          $elements.addClass('hyperwall');
        if (enableLetterboxMode)
          $elements.addClass('letterbox');

        snaplapseViewerForPresentationSlider.addEventListener('snaplapse-loaded', function() {
          $(".snaplapse_keyframe_container").scrollLeft(0);
          isAutoModeRunning = snaplapseViewerForPresentationSlider.isAutoModeRunning();
          if (isAutoModeRunning) {
            var snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
            snaplapseForPresentationSlider.getSnaplapseViewer().initializeAndRunAutoMode();
          }
          if (loadedInitialWaypointList) {
            $(".snaplapse_keyframe_list").children().first().children().click();
          }
          loadedInitialWaypointList = true;
        });

        snaplapseViewerForPresentationSlider.addEventListener('automode-start', function() {
          if (timelapse.isPaused() && !timelapse.isDoingLoopingDwell()) {
            timelapse.handlePlayPause();
          }
        });

        snaplapseViewerForPresentationSlider.addEventListener('slide-before-changed', function(waypoint) {
          var waypointTitle = waypoint.title;
          var waypointIndex = waypoint.index;
          var waypointStartTime = waypoint.time;
          var waypointBounds = waypoint.bounds;
          var himawariWaypoint = himawariWaypoints[currentWaypointTheme][waypointIndex];
          isAutoModeRunning = snaplapseViewerForPresentationSlider.isAutoModeRunning();

          // We are still technically using Landsat (web mercator) projections for any dataset being drawn,
          // so the bounds that slide-change returns is not valid for our use. But we already
          // know the bounds each himawari waypoints should be, so use that instead.
          if (himawariWaypoint) {
            waypointBounds = himawariWaypoint.bounds;
            waypointStartTime = himawariWaypoint.time;
            timelapse.setMaxScale(himawariMaxScale);
          } else {
            timelapse.setMaxScale(landsatMaxScale);
          }

          if (enableThemeHamburgerButton && isAutoModeRunning && autoModeFullThemeCycle && lastAutomodeWaypointIndex > waypointIndex) {
            var nextWaypointThemeCollection = $("#theme-list li.checkmark").next();
            if (nextWaypointThemeCollection.length == 0) {
              nextWaypointThemeCollection = $("#theme-list li").first();
            }
            nextWaypointThemeCollection.trigger("click");
          }
          if (isAutoModeRunning) {
            lastAutomodeWaypointIndex = waypointIndex;
          }
          //$(".map-layer-div").find("input:checked").trigger("click");
        });

        snaplapseViewerForPresentationSlider.addEventListener('slide-changed', function(waypoint) {
          var waypointTitle = waypoint.title;
          var waypointIndex = waypoint.index;
          var waypointBounds = waypoint.bounds;
          var waypointLayers = waypoint.layers || [];
          var waypointStartTime = waypoint.time;
          var waypointEndTime = waypoint.endTime;
          var waypointPlaybackSpeed = waypoint.speed;
          var himawariWaypoint = himawariWaypoints[currentWaypointTheme][waypointIndex];
          var lastAvailableWaypointIdx = $(".snaplapse_keyframe_list").children().last().index();
          var selectedWaypointIdx = $(".snaplapse_keyframe_list .thumbnail_highlight").closest(".snaplapse_keyframe_list_item").index();

          if ($previousAnnotationLocationButton) {
            $previousAnnotationLocationButton.button("enable");
          }
          if ($nextAnnotationLocationButton) {
            $nextAnnotationLocationButton.button("enable");
          }

          if (selectedWaypointIdx == 0 && $previousAnnotationLocationButton) {
            $previousAnnotationLocationButton.button("disable");
          } else if (selectedWaypointIdx == lastAvailableWaypointIdx && $nextAnnotationLocationButton) {
            $nextAnnotationLocationButton.button("disable");

          }
          // We are still technically using Landsat (web mercator) projections for any dataset being drawn,
          // so the bounds that slide-change returns is not valid for our use. But we already
          // know the bounds each himawari waypoints should be, so use that instead.
          if (himawariWaypoint) {
            waypointBounds = himawariWaypoint.bounds;
            waypointStartTime = himawariWaypoint.time;
          }

          clearInterval(waypointTimeChangeListenerInterval);
          waypointTimeChangeListenerInterval = null;

          if (waypointEndTime >= 0 && waypointStartTime != waypointEndTime) {
            waypointTimeChangeListenerInterval = setInterval(function() {
              var t = timelapse.getCurrentTime();
              if (t > waypointEndTime) {
                // If the user ends up scrubbing past the desired 'end time' of this waypoint,
                // remove this loopback check and let the animation loop through the entire time range.
                var currentTimeInMs = (new Date()).getTime();
                if ((currentTimeInMs - timeInMsSinceLastWaypointLoop) < 500) {
                  clearInterval(waypointTimeChangeListenerInterval);
                  waypointTimeChangeListenerInterval = null;
                }
                timeInMsSinceLastWaypointLoop = currentTimeInMs;
                // Seek back to the desired 'begin time' of this waypoint.
                timelapse.seek(waypointStartTime);
              }
            }, 1);
          }

          var waypointListNameString = waypointLayers.map(function(waypointName) {
            // Legacy Himawari ID
            if (waypointName == "h8") waypointName = "h8_16";
            return "[name=" + waypointName + "]";
          }).join(',');


          // TODO: This breaks our timelines sometimes
          // Clear out layers if they were checked and not needed again
          //$(".map-layer-div").find("input:checked").parent().not($(waypointListNameString)).children().trigger("click");

          // Clear out all layers that were checked
          $(".map-layer-div").find("input:checked").trigger("click");

          // Remove himawari since we do special cases further below
          var himawariIdx = waypointLayers.indexOf("h8");
          himawariIdx = himawariIdx > -1 ? himawariIdx : waypointLayers.indexOf("h8_16");
          if (himawariIdx > -1) waypointLayers.splice(himawariIdx, 1);

          // Handle layers
          waypointLayers.forEach(function(layer) {
            if (layer.indexOf("e-") == 0) {
              $("#extras-selector").selectmenu("refresh");
              // Need to delay some amount of time for the selectmenu to refresh.
              setTimeout(function() {
                $('#extras-selector-menu li[data-name="' + layer + '"]').click();
              }, 5);
            } else {
              var $layerToggle = $("#layers-list label[name='" + layer + "'] input");
              if (!$layerToggle.prop('checked')) $layerToggle.trigger("click");
            }
          });

          // Handle Himawari
          // Note: Must be run after other layers
          // Note: Needed because does not use mercator projection
          if (himawariWaypoint) {
            var initialHimawariViewChangeHack = function() {
              if (isAutoModeRunning) {
                snaplapseViewerForPresentationSlider.startAutoModeWaypointTimeout();
              } else {
                snaplapseViewerForPresentationSlider.startAutoModeIdleTimeout();
              }
              timelapse.seek(himawariWaypoint.time);
            };

            var setHimawariView = function(himawariBoundingBox, himawariTime, himawariPlaybackSpeed) {
              var himawariView = {
                bbox: himawariBoundingBox
              };
              if (showHimawariTimeMachineLayer) {
                timelapse.setNewView(himawariView);
              } else {
                $("#show-himawari").click();
                timelapse.stopParabolicMotion({doCallback : false});
                timelapse.setNewView(himawariView, true, null, initialHimawariViewChangeHack);
              }
              timelapse.setMasterPlaybackRate(1);
              timelapse.setPlaybackRate(himawariPlaybackSpeed);
            };

            setHimawariView(himawariWaypoint.bounds, himawariWaypoint.time, 0.5);
          }
          // End Himawari

          // Set playback rate based on the waypoint.
          if (waypointPlaybackSpeed != null) {
            if (waypointPlaybackSpeed == 0) {
              if (timelapse.isDoingLoopingDwell()) {
                timelapse.handlePlayPause();
              } else {
                timelapse.pause();
              }
            } else {
              var waypointPlaybackRate = timelapse.getMaxPlaybackRate() * (waypointPlaybackSpeed / 100);
              timelapse.setPlaybackRate(waypointPlaybackRate);
              // TODO: We shouldn't force playing here
              if (timelapse.isPaused() && !timelapse.isDoingLoopingDwell()) {
                timelapse.handlePlayPause();
              }
            }
            var onWaypointChangeListener = function() {
              timelapse.removeTimelineUIChangeListener(onWaypointChangeListener);
              timelapse.setPlaybackRate(waypointPlaybackRate);
            };
            timelapse.addTimelineUIChangeListener(onWaypointChangeListener);
            // In the event a waypoint does not have a timeline change, be sure the above listener is removed.
            setTimeout(function() {
              timelapse.removeTimelineUIChangeListener(onWaypointChangeListener);
            }, 500);
          }

          // Display info box for the waypoints
          if (enableWaypointText) {
            var waypointScale = timelapse.pixelBoundingBoxToPixelCenter(waypointBounds).scale;
            var $current_location_text = $(".current-location-text");
            var $current_location_text_container = $(".current-location-text-container");

            timelapse.removeViewChangeListener(waypointViewChangeListener);
            timelapse.removeViewChangeListener(hideWaypointListener);

            var currentView = timelapse.getView();
            if (waypoint.annotationBoxTitle || waypoint.description) {
              showAnnotations();
              $(".snaplapse_keyframe_list .snaplapse_keyframe_list_item_thumbnail_overlay_presentation").eq(selectedWaypointIdx).addClass("thumbnail_highlight");
              if (waypoint.annotationBoxTitle) {
                $current_location_text.find(".current-location-text-title").show().text(waypoint.annotationBoxTitle);
              } else {
                $current_location_text.find(".current-location-text-title").empty().hide();
              }
              var $current_location_text_picture = $("#current-location-text-picture");
              if (annotationPicturePaths[currentWaypointTheme] && annotationPicturePaths[currentWaypointTheme][waypointIndex].path) {
                $current_location_text_picture.show();
                $current_location_text_picture.css('background-image', 'url("' + annotationPicturePaths[currentWaypointTheme][waypointIndex].path + '")');
              } else {
                $current_location_text_picture.empty().hide();
              }
              if (waypoint.description) {
                $current_location_text.find("p").show().text(waypoint.description);
              } else {
                $current_location_text.find("p").empty().hide();
              }

              waypointViewChangeListener = function() {
                var currentView = timelapse.getView();
                previousWaypoint.scale = waypointScale;
                previousWaypoint.bounds = waypointBounds;
                if (currentView.scale * 2.5 > waypointScale && (currentView.x >= waypointBounds.xmin && currentView.x <= waypointBounds.xmax && currentView.y >= waypointBounds.ymin && currentView.y <= waypointBounds.ymax)) {
                  hideWaypointListener = function() {
                    var currentView = timelapse.getView();
                    var previousWaypointBounds = previousWaypoint.bounds;
                    if (((previousWaypoint.scale * 3.0 < currentView.scale && !timelapse.isMovingToWaypoint()) || (previousWaypoint.scale / 2.5 > currentView.scale && !timelapse.isMovingToWaypoint()) || !(currentView.x >= previousWaypointBounds.xmin && currentView.x <= previousWaypointBounds.xmax && currentView.y >= previousWaypointBounds.ymin && currentView.y <= previousWaypointBounds.ymax))) {
                      showAnnotationResumeExit();
                      timelapse.removeViewChangeListener(hideWaypointListener);
                      clearInterval(waypointTimeChangeListenerInterval);
                      waypointTimeChangeListenerInterval = null;
                    }
                  };
                  timelapse.addViewChangeListener(hideWaypointListener);
                  timelapse.removeViewChangeListener(waypointViewChangeListener);
                }
              };
              timelapse.addViewChangeListener(waypointViewChangeListener);
            } else {
              // No waypoint title or description given; really should never happen.
              $current_location_text_container.hide();
            }

            // Close the extra content pop-up if a waypoint is clicked.
            $('#extras-content').dialog('close');
          }

          var parabolicMotionStoppedListener = function() {
            timelapse.removeParabolicMotionStoppedListener(parabolicMotionStoppedListener);
            timelapse.removeViewChangeListener(waypointViewChangeListener);
            var waypointScale = timelapse.pixelBoundingBoxToPixelCenter(waypointBounds).scale;
            var currentView = timelapse.getView();
            if ((waypointScale / 2.5 > currentView.scale || !(currentView.x >= waypointBounds.xmin && currentView.x <= waypointBounds.xmax && currentView.y >= waypointBounds.ymin && currentView.y <= waypointBounds.ymax))) {
              showAnnotationResumeExit();
            }
          };
          timelapse.addParabolicMotionStoppedListener(parabolicMotionStoppedListener);

        });
        // End snaplapseViewerForPresentationSlider check
      }


      // Location search box, with autocomplete.
      var $locationSearchDiv = $('<div class="location_search_div"><input id="location_search" type="text" placeholder="Search for a location...">');
      if (enableLetterboxMode) {
        $locationSearchDiv.addClass("top-panel letterbox").appendTo($("#letterbox-bottom-controls"));
        $("#location_search").addClass("letterbox");
      } else {
        $locationSearchDiv.appendTo($("#timeMachine .player"));
      }

      $(".current-location-text-container, .annotations-resume-exit-container").appendTo($("#timeMachine .player"));

      if (isHyperwall) {
        $("#location_search").addClass("hyperwall");
      }

      // Note: Google's service gives much better results, but for locations where Google APIs cannot be used, we fallback to this.
      if (!useGoogleSearch) {
        var locationList = [];
        $("#location_search").autocomplete({
          minLength: 5,
          source: function(request, response) {
            locationList = [];
            //http://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=1
            $.getJSON("https://photon.komoot.de/api/?limit=5", {
              q: request.term
            }, function(data, status, xhr) {
              response(data.features);
            });
          },
          select: function(event, ui) {
            var view;
            //if (ui.item.properties.extent) {
            //  view = {bbox: {"ne": {"lat": ui.item.properties.extent[1], "lng": ui.item.properties.extent[2]}, "sw": {"lat" : ui.item.properties.extent[3], "lng": ui.item.properties.extent[0]}}};
            //} else {
            view = {
              center: {
                "lat": ui.item.geometry.coordinates[1],
                "lng": ui.item.geometry.coordinates[0]
              },
              "zoom": 12
            };
            //}
            timelapse.setNewView(view);
            if (ui.item.properties) {
              UTIL.addGoogleAnalyticEvent('textbox', 'search', 'go-to-searched-place=' + ui.item.properties.name + "," + ui.item.properties.country);
            }
          }
        }).autocomplete("instance")._renderItem = function(ul, item) {
          var tmpLocationString = (item.properties.name || "") + ", " + (item.properties.state || "") + item.properties.country;
          if (item.properties.osm_value == "hamlet" || !item.properties.country || locationList.indexOf(tmpLocationString) >= 0) return $("<li>");
          locationList.push(tmpLocationString);
          return $("<li style='z-index:9999'>").append("<a>" + (item.properties.name || "") + ", " + (item.properties.state || "") + "<br>" + item.properties.country + "</a>").appendTo(ul);
        };
      } else if (typeof(google) === "undefined" && !useGoogleMaps) {
        var googleMapsScript = document.createElement('script');
        var googleMapsSrc = "https://maps.google.com/maps/api/js?libraries=places&callback=googleMapsLoadedCallback";
        if (googleMapsAPIKey)
          googleMapsSrc += "&key=" + googleMapsAPIKey;
        googleMapsScript.setAttribute('src', googleMapsSrc);
        googleMapsScript.setAttribute('type', 'text/javascript');
        document.getElementsByTagName('head')[0].appendChild(googleMapsScript);
      }

      // Set the letterbox mode
      if (enableLetterboxMode) {
        // Move the presentation slider out
        var $presentationSlider = $("#" + timelapse.getTimeMachineDivId() + " .presentationSlider");
        $presentationSlider.prependTo("#letterbox-bottom");
        var $chartContainer = $("#csvChartContainer");
        $chartContainer.appendTo("#timeMachine");
        var $chartLegend = $("#csvChartLegend");
        $chartLegend.appendTo("#timeMachine");
        $(".hamburger").hide();
      }

      var hashChange = function() {
        var vals = UTIL.getUnsafeHashVars();
        // Another hashChange call may happen later from csvFileLayers.addLayersLoadedListener() which will end up clearing out
        // any layers a waypoint may have up. So if we are looking at a waypoint, we need to filter out its layers.
        var activeWaypoint = $(".snaplapse_keyframe_list_item_thumbnail_overlay_presentation.thumbnail_highlight");
        if (activeWaypoint.length) {
          var waypointLayersSelectors = "";
          var waypointIdx = activeWaypoint.closest(".snaplapse_keyframe_list_item").index();
          if (snaplapseForPresentationSlider) {
            var waypointLayerIds = snaplapseForPresentationSlider.getKeyframes()[waypointIdx].layers;
            for (i = 0; i < waypointLayerIds.length; i++) {
              waypointLayersSelectors += "label[name='" + waypointLayerIds[i] + "']";
              // Need to comma separate each selector
              if (i < waypointLayerIds.length - 1) {
                waypointLayersSelectors += ",";
              }
            }
          }
        }
        // Turn off any layers that are active except ones related to current waypoint
        $(".map-layer-div").find("input:checked").parent().not(waypointLayersSelectors).children().trigger("click");
        if (vals.l) {
          var layers = vals.l.split(",");
          layers.forEach(function(layer) {
            layersToShowOnCreation[layer] = true;
            var $layerToggle = $("#layers-list label[name='" + layer + "'] input");
            if (!$layerToggle.prop('checked')) {
              $layerToggle.trigger("click");
            }
          });
          // The time in a share link may correspond to a layer that has a different timeline than the default one.
          // Re-run corresponding sharelink code once the timeline has changed.
          // Note that this may be unncessary because of the callback for CSV layers, but it's possible not to have CSV layers
          // and CSV layers are async (and could be loaded very fast) so we keep this in.
          var onloadView = function() {
            timelapse.loadSharedViewFromUnsafeURL(UTIL.getUnsafeHashString());
            timelapse.removeTimelineUIChangeListener(onloadView);
          };
          timelapse.addTimelineUIChangeListener(onloadView);
          // In the event a sharelink layer does not have a timeline change, be sure the above listener is removed.
          setTimeout(function() {
            timelapse.removeTimelineUIChangeListener(onloadView);
          }, 500);
        }

        if (vals.theme) {
          $("#" + vals.theme).click();
        }

        if (timelapse.isPresentationSliderEnabled()) {
          var waypointsPath;
          if (vals.waypoints) {
            waypointsPath = docTabToGoogleSheetUrl(vals.waypoints);
          }
          waypointsPath = waypointsPath || waypointSliderContentPath;
          // If for some reason the waypoints cannot load, the controls need to be manually
          // pushed up by changing the player to where it would be had the waypoints loaded.
          $("#timeMachine .player").css("bottom", "93px");
          loadWaypoints(waypointsPath);
        }

        if (showCustomDotmaps) {
          var dotmapsPath;
          if (vals.dotlayers) {
            dotmapsPath = vals.dotlayers;
          }
          dotmapsPath = dotmapsPath || dotmapsContentPath;
          loadDotmapLayers(dotmapsPath);
        }

        if (showCsvLayers) {
          var csvlayersPath;
          if (vals.csvlayers) {
            csvlayersPath = vals.csvlayers;
          }
          csvlayersPath = csvlayersPath || csvLayersContentPath;
          csvFileLayers.loadLayers(csvlayersPath);
        }
      };

      $(".map-layer-div").accordion({
        collapsible: true,
        active: false,
        animate: false,
        heightStyle: 'content',
        create: function() {
          updateLetterboxContent();
        },
        beforeActivate: function(event, ui) {
          // The accordion believes a panel is being opened
          if (ui.newHeader[0]) {
              var currHeader  = ui.newHeader;
              var currContent = currHeader.next('.ui-accordion-content');
          // The accordion believes a panel is being closed
          } else {
              var currHeader  = ui.oldHeader;
              var currContent = currHeader.next('.ui-accordion-content');
          }
          // Since we've changed the default behavior, this detects the actual status
          var isPanelSelected = currHeader.attr('aria-selected') == 'true';

          // Toggle the panel's header
          currHeader.toggleClass('ui-corner-all',isPanelSelected).toggleClass('accordion-header-active ui-state-active ui-corner-top', !isPanelSelected).attr('aria-selected', ((!isPanelSelected).toString()));

          // Toggle the panel's icon
          currHeader.children('.ui-icon').toggleClass('ui-icon-triangle-1-e', isPanelSelected).toggleClass('ui-icon-triangle-1-s', !isPanelSelected);

          // Toggle the panel's content
          currContent.toggleClass('accordion-content-active', !isPanelSelected);
          if (isPanelSelected) {
            currContent.slideUp(0);
          } else {
            currContent.slideDown(0);
          }

          // Cancel the default action
          return false;
        }
      });

      sortLayerCategories();

      // Callback when data for a specific CSV layer has loaded.
      csvFileLayers.addDataLoadedListener(function(layerId) {
        csvDataGrapher.graphDataForLayer(layerId);
        showHideCsvGrapher(true, layerId, true);
        csvFileLayers.setLegend(layerId);
      });

      // Callback when a CSV file has been loaded and layers added to the DOM.
      csvFileLayers.addLayersLoadedListener(function() {
        // New layers have been added, so refresh the layer panel
        $(".map-layer-div").accordion("refresh");
        sortLayerCategories();
        if (enableLetterboxMode) {
          updateLetterboxContent();
        }
        if (!loadedInitialCsvLayers) {
          loadedInitialCsvLayers = true;
          // CSV layers are loaded asynchronously, so trigger another hash change if we just loaded the page
          $(window).on('hashchange', hashChange).trigger('hashchange');
        }
      });

      csvDataGrapher.initialize();

      $("#layers-list").on("click", ".csvlayer input, input[data-has-graph='true']", function(e) {
        var activeGraphableLayers = $(".csvlayer input, tr input[data-has-graph='true']").closest("input:checked");
        var $target = $(e.target);
        var layerId = $target.parent().attr("name");
        var layerIds = csvFileLayers.layers.map(function(props) {
          return props['_layerId'];
        });
        var layerIdx = layerIds.indexOf(layerId);
        var dataLoaded = $target.data("has-graph") ? true : false;
        if (layerIdx >= 0 && typeof csvFileLayers.layers[layerIdx] != "undefined") {
          var tiles = csvFileLayers.layers[layerIdx]._tileView._tiles;
          var key = Object.keys(tiles)[0];
          // Checking point count is a special case when we are only displaying a chart and nothing on the main map
          dataLoaded = key && (tiles[key]._ready || tiles[key]._pointCount == 0);
        }
        if (dataLoaded && $target.is(':checked') && !$target.data("has-graph")) {
          var layerId = tiles[key].layerId;
          csvDataGrapher.graphDataForLayer(layerId);
        }
        var isCsvLayer = $(this).closest("tr").hasClass("csvlayer");
        if ($target.is(':checked') && dataLoaded) {
          showHideCsvGrapher(true, layerId, isCsvLayer);
        } else {
          csvDataGrapher.removePlot($target.data("graph-name"));
        }
        if (activeGraphableLayers.length == 0) {
          showHideCsvGrapher(false, layerId, isCsvLayer);
          csvDataGrapher.removeAllPlots();
        }
      });

      $("#logosContainer, #baseLayerCreditContainer").appendTo("#timeMachine .player");

      $("#main-hamburger-menu .selection-heading").on("click", function(e) {
        var selectionButton = $(this).siblings("input:radio");
        if (selectionButton.prop("checked")) {
          e.preventDefault();
          selectionButton.prop("checked", false);
        }
        setTimeout(function() {
          fixThemeMenuHeight();
        }, 20);
      });

      $("#presentation-slider-hamburger-wrapper").on("click", function(e) {
        if (enableLetterboxMode) {
          return;
        }
        $('#main-hamburger-menu').toggle("slide", { direction: "left" }, 150);
        var $hamburgerButtonSelector = $(this).find(".hamburger");
        $hamburgerButtonSelector.toggleClass("is-active");
        if ($(e.target).closest("#theme-title-container").length && $hamburgerButtonSelector.hasClass("is-active")) {
          $("#theme-menu #theme-selection").prop("checked", true);
        } else {
          $("#theme-menu #theme-selection").prop("checked", false);
        }

        if ($hamburgerButtonSelector.hasClass("is-active")) {
          $("#controlsContainer").animate({"left": $("#main-hamburger-menu").css("width")}, 150);
          //UTIL.addGoogleAnalyticEvent('button', 'click', 'viewer-show-panel');
        } else {
          $("#controlsContainer").animate({"left" : "0px"}, 150);
        }

        $('.layers-scroll-vertical').animate({
          scrollTop: lastLayerMenuScrollPos
        }, 250);

        setTimeout(function() {
          fixThemeMenuHeight();
        }, 20);

      });

      $("#theme-menu").on("click", function(e) {
        var $selectedThemeElement = $(e.target);
        if (currentWaypointTheme == $selectedThemeElement.attr("id") || !$selectedThemeElement.data("waypoint-url")) return;
        $(this).find("li").removeClass("checkmark");
        $selectedThemeElement.addClass("checkmark");
        changeHash({theme: $selectedThemeElement.attr("id")});
        currentWaypointTheme = $selectedThemeElement.attr("id");
        $("#theme-title").attr("data-theme-id", $selectedThemeElement[0].id).text($selectedThemeElement.text());
        var waypointSliderContent = "#presentation=" + $selectedThemeElement.data("waypoint-url");
        timelapse.loadSharedDataFromUnsafeURL(waypointSliderContent);
        UTIL.addGoogleAnalyticEvent('button', 'click', 'viewer-select-theme=' + currentWaypointTheme);
        if ($("#presentation-slider-hamburger-wrapper .hamburger").hasClass("is-active")) {
          $("#presentation-slider-hamburger-wrapper").click();
        }
      });

      $("body").on("click", function(e) {
        if (!e.originalEvent && !e.detail) return;
        var ignoredElms = $(e.target).closest("#main-hamburger-menu, #presentation-slider-hamburger-wrapper");
        if (ignoredElms.attr("id") == "main-hamburger-menu" || ignoredElms.attr("id") == "presentation-slider-hamburger-wrapper" || !$(".hamburger").hasClass("is-active")) return;
        $("#presentation-slider-hamburger-wrapper").trigger("click");
      });

      if (extraContributors) {
        if (extraContributors == "Igarape Institute") {
          var idx = extraContributors.indexOf('e');
          extraContributors = extraContributors.substr(0, idx) + '&eacute;' + extraContributors.substr(idx + 1);
          $("#productLogo").css("font-size", "32px");
          $("#contributors").css("font-size", "22px");
          $(".current-location-text p").css({"font-size" : "24px", "line-height" : "30px"});
          $(".current-location-text h3").css("font-size", "34px");
        }
        $("#contributors").html($("#contributors").html() + " | " + extraContributors);
      }

      if (minimalUI) {
        // Move capture time outside of the timeline controls
        $(".captureTime").insertBefore(".controls");
        $(".captureTime, .scaleBarContainer, #logosContainer, #baseLayerCreditContainer").addClass("minimalUIMode");
        // Move annotation to top left
        $(".current-location-text-container, .annotation-nav").addClass("letterbox");
        // Remove side control panel, search box, and timelines
        $("#controlsContainer, .location_search_div, .customControl, .controls").remove();
        // Hide presentation slider so that it's still usable via keyboard/clicker but not shown on screen
        $("#timeMachine .presentationSlider").addClass("offscreen");
        $("#timeMachine .player").addClass("presentationSliderOffscreen");
      }

      if (disableUI) {
        // Remove side control panel, search box, timelines, scalebar, logos and legend
        $("#controlsContainer, .location_search_div, .customControl, .controls, .scaleBarContainer, .captureTime, #baseLayerCreditContainer, #logosContainer, #layers-legend").remove();
      }

      $(".annotations-resume-button").on("click", function() {
        showAnnotations(true);
      });

      $(".annotations-exit-button").on("click", function() {
        hideAnnotations();
      });

      $(window).on('hashchange', hashChange).trigger('hashchange');

      if (enableLetterboxMode) {
        $("#letterbox-list-themes-button").on("click", function() {
          updateLetterboxContent("themes");
        });
        $("#letterbox-list-layers-button").on("click", function() {
          updateLetterboxContent("layers");
        });
        $("#letterbox-clear-layers-button").on("click", function() {
          var e = jQuery.Event("keydown");
          e.which = 67;
          e.keyCode = 67;
          $("body").trigger(e);
        });
        updateLetterboxSelections();
      }

      // Workaround for issue that came with Chrome 65. Rot in hell browsers.
      // Force redraw of the sticky positioned menus in bottom left.
      $(".snaplapse_keyframe_container").scroll(function() {
        $("#presentation-slider-hamburger-wrapper").hide().show(0);
      });

      // End of onTimeMachinePlayerReady
    }

    var sortLayerCategories = function() {
      var layerAccordion = $(".map-layer-div");

      var entries = $.map(layerAccordion.children("h3").get(), function(entry) {
        var $entry = $(entry);
        return $entry.add($entry.next());
      });

      entries.sort(function(a, b) {
        return a.filter("h3").text().localeCompare(b.filter("h3").text());
      });

      $.each(entries, function() {
        // Ensure 'Base Layers' is always the first entry
        if (this.filter("h3").text() == "Base Layers") {
          this.detach().prependTo(layerAccordion);
        } else {
          this.detach().appendTo(layerAccordion);
        }
      });
    }

    var sortThemes = function() {
      var $themeList = $("#theme-list");
      var themes = $themeList.children("li");

      themes.sort(function(a, b) {
        return $(a).text().localeCompare($(b).text());
      });

      $.each(themes, function() {
        $(this).detach().appendTo($themeList);
      });
    }

    var updateLetterboxContent = function(newSectionChoice) {
      var sectionChoice = newSectionChoice || "themes";
      var numRows = 3;

      $("#letterbox-control-buttons .letterbox-list-button-highlight").removeClass("letterbox-list-button-highlight");
      if (sectionChoice == "themes") {
        $("#letterbox-list-themes-button").addClass("letterbox-list-button-highlight");
      } else if (sectionChoice == "layers") {
        $("#letterbox-list-layers-button").addClass("letterbox-list-button-highlight");
      }

      // Create letterbox base layers table
      if (!$(".letterbox-base-layers-table").length) {
        var baseLayers = $("#category-base-layers").find("td").map(function() {
          return $(this);
        }).get();

        var baselayerRowHeight = Math.floor(100 / baseLayers.length);

        var html = "<table class='letterbox-base-layers-table'><caption>Base Layers:</caption>";

        for (var i = 0; i < baseLayers.length; i++) {
          var labelName = $(baseLayers[i]).parent().attr('name');
          var inputId = $(baseLayers[i]).find("input")[0].id;
          var textName = baseLayers[i].text();

          if (textName.indexOf("Earth Engine") >= 0) {
            textName = "Timelapse";
          }

          html += "<tr height='" + baselayerRowHeight + "%'><td><div><label class='pointer' for='letterbox-" + inputId + "'><input type='radio' class='pointer' id='letterbox-" + inputId + "' data-base-layer-id='" + inputId + "' name='letterbox-base-layers'/>" + textName + "</label></div></td></tr>"
        }
        html += "</table>";

        $("#letterbox-base-layers").children().remove();
        $("#letterbox-base-layers").html(html);

        // Handle letterbox base layer selection
        $('.letterbox-base-layers-table').on("click", "td", function(e) {
          // Clicking a span will cause this to run twice, so we ignore element a user did not physically click
          if (!e.detail) return;
          var $input = $(this).find("input");
          // Special case since this is a radio button
          $input.prop("checked", true);
          $("#" + $input.data("base-layer-id")).trigger("click");
        });
      }

      if (sectionChoice == "themes") {
        // Create letterbox theme table
        var layerThemes = $("#theme-list").find("li").map(function() {
          return $(this);
        }).get();

        var numThemesPerRow = Math.ceil(layerThemes.length / numRows);

        var html = "<table class='letterbox-bottom-picker-table'><tr><th>Themes:</th></tr><tr height='33%'>";

        var k = 0;
        var j = 0;
        var doSwap = false;
        for (var i = 0; i < layerThemes.length; i++) {
          if ((i % numThemesPerRow == 0) && i > 0) {
            html += "</tr><tr height='33%'>";
            j = 0;
            k += 1;
          }
          var idx = (j*numRows + k);
          if (idx >= layerThemes.length) {
            idx -= (k + 1)
            doSwap = true;
          }
          var themeId = layerThemes[idx][0].id;
          var theme = layerThemes[idx].text();
          html += "<td><label class='pointer' for='letterbox-" + themeId + "'><input type='radio' class='pointer' id='letterbox-" + themeId + "' data-theme-id='" + themeId + "' name='letterbox-layer-theme'/>" + theme + "</label></td>"
          j++;
        }
        html += "</tr></table>";

        $("#letterbox-bottom-picker-results-content").children().remove();
        $("#letterbox-bottom-picker-content").children().remove();
        $("#letterbox-bottom-picker-content").html(html);

        if (doSwap) {
          var lastColumns = $('.letterbox-bottom-picker-table tr > td:last-child');
          var tmp = $(lastColumns[0]).html();
          $(lastColumns[0]).html($(lastColumns[1]).html());
          $(lastColumns[1]).html(tmp);
        }

        // Handle letterbox theme selection
        $('.letterbox-bottom-picker-table').on("click", "td", function(e) {
          // Clicking a span will cause this to run twice, so we ignore element a user did not physically click
          if (!e.detail) return;
          var $input = $(this).find("input");
          // Special case since this is a radio button
          $input.prop("checked", true);
          $("#" + $input.data("theme-id")).trigger("click");
        });

        $("#letterbox-bottom-picker-content").find("input#letterbox-" + $("#theme-title").attr("data-theme-id")).prop("checked", true);

      } else if (sectionChoice == "layers") {
        // Create letterbox layer categories table, sorted alphabetically top down, left to right
        var layerCategories = $("#layers-list").find("h3").map(function() {
          if ($(this).text() != "Base Layers") {
            return $(this);
          }
        }).get();

        var numCategoriesPerRow = Math.ceil(layerCategories.length / numRows);

        var html = "<table class='letterbox-bottom-picker-table'><tr><th colspan='2'>Layer Categories:</th></tr><tr height='33%'>";
        var k = 0;
        var j = 0;
        var doSwap = false;
        for (var i = 0; i < layerCategories.length; i++) {
          if ((i % numCategoriesPerRow == 0) && i > 0) {
            html += "</tr><tr height='33%'>";
            j = 0;
            k += 1;
          }
          var idx = (j*numRows + k);
          if (idx >= layerCategories.length) {
            idx -= (k + 1)
            doSwap = true;
          }
          var categoryId = layerCategories[idx][0].id;
          var category = layerCategories[idx].text();
          html += "<td><label class='pointer' for='letterbox-" + categoryId + "'><input type='radio' class='pointer' id='letterbox-" + categoryId + "' data-category-id='" + categoryId + "' name='letterbox-layer-categories'/>" + category + "</label></td>"
          j++;
        }
        html += "</tr></table>";

        $("#letterbox-bottom-picker-content").children().remove();
        $("#letterbox-bottom-picker-content").html(html);

        if (doSwap) {
          var lastColumns = $('.letterbox-bottom-picker-table tr > td:last-child');
          var tmp = $(lastColumns[0]).html();
          $(lastColumns[0]).html($(lastColumns[1]).html());
          $(lastColumns[1]).html(tmp);
        }

        // Handle letterbox layer category selection
        $('.letterbox-bottom-picker-table').on("click", "td", function(e) {
          // Clicking a span will cause this to run twice, so we ignore element a user did not physically click
          if (!e.detail) return;

          var $input = $(this).find("input");
          // Special case since this is a radio button
          $input.prop("checked", true);

          // Create letterbox layers table
          var categoryLayers = $("#" + $input.data("category-id")).next().find("td").not(".loading-layer-spinner-small");
          var numLayersPerRow = Math.ceil(categoryLayers.length / numRows);

          var html = "<table class='letterbox-bottom-picker-results-table'><tr style='height: 1%'><th>" + $(this).text() + " Layers:</th></tr><tr height='33%'>";

          for (var i = 0; i < categoryLayers.length; i++) {
            if ((i % numLayersPerRow == 0) && i > 0) {
              html += "</tr><tr height='33%'>";
            }

            var labelName = $(categoryLayers[i]).find("label").attr('name');
            var inputId = $(categoryLayers[i]).find("input")[0].id;

            html += "<td><label class='pointer' name='letterbox-" + labelName + "'><input type='checkbox' class='pointer' id='letterbox-" + inputId + "' data-layer-id='" + inputId + "'/>" + $(categoryLayers[i]).text() + "</label></td>";

          }
          html += "</tr></table>";

          $("#letterbox-bottom-picker-results-content").children().remove();
          $("#letterbox-bottom-picker-results-content").html(html);

          // Handle letterbox specific layer selection
          $(".letterbox-bottom-picker-results-table").on("click", "td", function(e) {
            if (e.toElement.tagName.toLowerCase() == "label") return;
            var $input = $(this).find("input");
            $("#" + $input.data("layer-id")).trigger("click");
          });

          updateLetterboxSelections();
        });
      }
    }

    var updateLetterboxSelections = function(elemClicked) {
      var $letterboxContainers = $("#letterbox-base-layers, #letterbox-bottom-picker-results-content");
      if (elemClicked) {
        $letterboxContainers.find("input#letterbox-" + elemClicked[0].id).prop("checked", elemClicked.prop("checked"));
      } else {
        $letterboxContainers.find("input:checked").prop("checked", false);
        var activeLayers = $(".map-layer-div").find("input:checked").map(function() {
          return $(this);
        }).get();
        for (var i = 0; i < activeLayers.length; i++) {
          var activeSelection = $letterboxContainers.find("input#letterbox-" + activeLayers[i][0].id);
          activeSelection.prop("checked", true);
        }
      }
    }

    // CSV Data Grapher
    var showHideCsvGrapher = function(doShow, layerId, isCSV) {
      if (doShow && layerId && isCSV) {
        var layerIds = csvFileLayers.layers.map(function(props) {
          return props['_layerId']
        });
        var layerIdx = layerIds.indexOf(layerId);
        if (layerIdx < 0) return;
        var layerOpts = csvFileLayers.layers[layerIdx].opts;
        var showGraph = layerOpts.showGraph == "TRUE";
        if (!showGraph) return;
      }
      if (doShow) {
        $("#csvChartLegend").show();
        $("#csvChartContainer").show();
        if (!disablePresentationSlider) {
          $("#layers-legend, #main-hamburger-menu, .controls, .customControl, #baseLayerCreditContainer, .current-location-text-container, .annotations-resume-exit-container, .player, .scaleBarContainer, #logosContainer").addClass("layerGraphs");
        }
        $("#timeMachine").addClass("layerGraphs");
      } else {
        $("#csvChartLegend").hide();
        $("#csvChartContainer").hide();
        if (!disablePresentationSlider) {
          $("#layers-legend, #main-hamburger-menu, .controls, .customControl, #baseLayerCreditContainer, .current-location-text-container, .annotations-resume-exit-container, .player, .scaleBarContainer, #logosContainer").removeClass("layerGraphs");
        }
        $("#timeMachine").removeClass("layerGraphs");
      }
      var snaplapse = timelapse.getSnaplapseForPresentationSlider();
      if (snaplapse) {
        snaplapse.getSnaplapseViewer().showHideSnaplapseContainer(!doShow);
      }
      resize();
      csvDataGrapher.chart.render();
    };

    function docTabToGoogleSheetUrl(doctab) {
      var docId = doctab.split('.')[0];
      var ret = 'https://docs.google.com/spreadsheets/d/' + docId + '/edit';
      var tabId = doctab.split('.')[1];
      if (tabId) ret += '#gid=' + tabId;
      return ret;
    }

    function googleSheetUrlToDocTab(url) {
      var match = /spreadsheets\/d\/(.*?)\/(.*?[#&]gid=(\d+))?/.exec(url);
      if (!match || match[1].len < 20) return null;
      var ret = match[1];
      if (match[3]) ret += '.' + match[3];
      return ret;
    }

    var spreadsheetUrlDialog;
    function askForSpreadsheetUrl(type, callback) {
      if (!spreadsheetUrlDialog) {
        spreadsheetUrlDialog = $('<div style="line-height: 200%"></div>').appendTo($('body'));
      }
      var d = spreadsheetUrlDialog;
      d.html('Paste new Google Spreadsheet tab URL for ' + type + '.<br>' +
             '<input type="text" size=90 id="spreadsheet-path"></input><br>' +
             '<i>If your spreadsheet has more than one tab, be sure to select the correct tab ' +
             'before copying its URL, as each tab has a different URL.</i><br>' +
             '<label style="cursor: pointer"><input type="checkbox" id="make-spreadsheet-default" value="' + type + '" style="cursor: pointer;">Make this the default spreadsheet loaded from now on?</label><br>');

      d.dialog({
        minWidth: 800,
        title: "Change " + type,
        buttons: {
          Ok: function() {
            var url = d.find('#spreadsheet-path').val();
            if (typeof(Storage) !== "undefined") {
              var $makeDefaultElem = d.find('#make-spreadsheet-default');
              var makeDefault = $makeDefaultElem.is(':checked');
              if (makeDefault) {
                if (type == "waypoints") {
                  localStorage.waypointSliderContentPath = url;
                } else if (type == "dotmap layers") {
                  localStorage.dotmapsContentPath = url;
                } else if (type == "csv layers") {
                  localStorage.csvLayersContentPath = url;
                }
              }
            }
            if (googleSheetUrlToDocTab(url)) {
              $(this).dialog("close");
              callback(url);
            } else {
              alert('URL entered is not a valid Google Spreadsheet link.');
            }
          },
          Cancel: function() { $(this).dialog("close"); }
        }
      });
    }

    // Modify window.location.hash to include all fields from object newFields.
    // If a field in newFields isn't already in window.location.hash, add it.
    // If a field in newFields isn already in window.location.hash, overwrite it.
    function changeHash(newFields) {
      var fields = UTIL.getUnsafeHashVars();
      $.extend(fields, newFields);
      var newHash;
      for (var prop in fields) {
        if (fields.hasOwnProperty(prop)) {
          if (newHash) {
            newHash += '&';
          } else {
            newHash = '#';
          }
          newHash += prop + '=' + fields[prop];
        }
      }
      window.location.hash = newHash;
    }

    function getSpreadsheetDownloadPath(path) {
      if (path && path.indexOf(".tsv") == -1 && path.indexOf("http") == -1) {
        path = docTabToGoogleSheetUrl(path);
      }
      return path;
    }

    var settingsDialog;

    function showSettingsDialog() {
      if (!settingsDialog) {
        settingsDialog =
          $('<div title="Settings" style="line-height: 200%"></div>')
          .appendTo($('body'));
      }

      var d = settingsDialog;
      d.html('<a target="_blank" href="' + getSpreadsheetDownloadPath(waypointsLoadedPath) + '" title="Click to view current waypoint spreadsheet">Current waypoints spreadsheet</a>' +
             '<button style="float: right; cursor: pointer;" title="Click to change waypoint list">Switch</button><br>' +
             '<a target="_blank" href="' + getSpreadsheetDownloadPath(dotlayersLoadedPath) + '" title="Click to view current dotmap spreadsheet">Current dotmap layer spreadsheet</a>' +
             '<button style="float: right; cursor: pointer;" title="Click to change dotmap layers">Switch</button><br>' +
             '<a target="_blank" href="' + getSpreadsheetDownloadPath(csvlayersLoadedPath) + '" title="Click to view current csv spreadsheet">Current csv layer spreadsheet</a>' +
             '<button style="float: right; cursor: pointer;" title="Click to change csv layers">Switch</button><br><br>' +
             '<button style="float: right; cursor: pointer; font-size: 12px" title="Reset spreadsheets back to their defaults">Reset spreadsheets to default values</button><br>');


      d.find('button:eq(0)').click(function () {
        askForSpreadsheetUrl('waypoints', function (newUrl) {
          changeHash({waypoints: googleSheetUrlToDocTab(newUrl)});
          d.dialog("close");
        });
      });

      d.find('button:eq(1)').click(function () {
        askForSpreadsheetUrl('dotmap layers', function (newUrl) {
          changeHash({dotlayers: googleSheetUrlToDocTab(newUrl)});
          d.dialog("close");
        });
      });

      d.find('button:eq(2)').click(function () {
        askForSpreadsheetUrl('csv layers', function (newUrl) {
          changeHash({csvlayers: googleSheetUrlToDocTab(newUrl)});
          d.dialog("close");
        });
      });

      d.find('button:eq(3)').click(function () {
        localStorage.removeItem("waypointSliderContentPath");
        localStorage.removeItem("dotmapsContentPath");
        localStorage.removeItem("csvLayersContentPath");
        parent.location.hash = '';
        alert("Spreadsheets successfully reset back to their default values. You may have to reload the page to see this change.");
      });

      d.dialog({
        minWidth: 350,
        buttons: {
          Ok: function() { d.dialog("close"); },
          Cancel: function() { d.dialog("close"); }
        }
      });
    }

    var maximumUpdateTime = 20; // milliseconds
    var startOfRedraw;

    function redrawTakingTooLong() {
      return performance.now() - startOfRedraw > maximumUpdateTime;
    }

    function fixThemeMenuHeight() {
      var $themeList = $("#theme-list");
      if ($themeList.is(':visible')) {
        var sectionHeadingHeight = parseInt($(".selection-heading").outerHeight());
        var $children = $themeList.children();
        var numThemes = $children.length;
        var themeEntryHeight = parseInt($children.first().outerHeight());
        var themeListHeight = numThemes * themeEntryHeight;
        var newThemeListHeight = parseInt($("#main-hamburger-menu").outerHeight()) - themeListHeight;
        if (newThemeListHeight < sectionHeadingHeight) {
          newThemeListHeight = sectionHeadingHeight;
        }
        $themeList.css("height", "calc(100% - " + newThemeListHeight + "px)");
      }
    }

    function resize() {
      var width = canvasLayer.canvas.width;
      var height = canvasLayer.canvas.height;
      gl.viewport(0, 0, width, height);

      fixThemeMenuHeight();

      canvasLayer.resize_();
    }

    // Draws to canvas.
    // Called by TimeMachineCanavasLayer during animation and/or view changes
    function update() {
      timelapse.frameno = (timelapse.frameno || 0) + 1;
      perf_drawframe();
      gl.clear(gl.COLOR_BUFFER_BIT);

      // Set this to true at the beginning of frame redraw;  any layer that decides it wasn't completely drawn will set
      // this to false upon draw below
      timelapse.lastFrameCompletelyDrawn = true;

      //
      //// Draw layers ////
      //

      var getLayerView = function(dataLayer, baseLayer) {
        // New Landsat basemap no longer starts at standard Web Mercator north of 85.xxx
        // Compute offset in units of timelapse.getView() pixels
        var yOffset = timelapse.getProjection().latlngToPoint({
          lat: NORTH,
          lng: 0
        }).y;
        var view = timelapse.getView();
        var timelapse2map = dataLayer.getWidth() / baseLayer.getWidth();
        view.y -= yOffset;
        view.x *= timelapse2map;
        view.y *= timelapse2map;
        view.scale /= timelapse2map;
        return view;
      };

      // Extracting dates from timelapse -- TODO: Refactor and put in timemachine?
      function getDates(timelapse) {
        var dates = [];
        for (var i = 0; i < timelapse.getNumFrames(); i++) {
          dates.push(new Date(timelapse.getCaptureTimes()[i]));
        }
        return dates;
      }

      function getCurrentTimes(timelapse) {
        var currentTimes = [];
        for (var i = 0; i < timelapse.getNumFrames(); i++) {
          currentTimes.push(i/timelapse.getFps());
        }
        return currentTimes;
      }

      function getCurrentTimeIndex(currentTime, currentTimes) {
        for (var i = 0; i < currentTimes.length; i++) {
          if (currentTime <= currentTimes[i])  {
            return i;
          }
        }
        return currentTimes.length - 1;
      }

      function getCurrentTimesDelta(currentTime, currentTimes) {
        var currentIndex = getCurrentTimeIndex(currentTime, currentTimes);
        var previousIndex = 0;
        var range = 1;
        if (currentIndex != 0) {
          previousIndex = currentIndex - 1;
          range = (currentTimes[currentIndex] - currentTimes[previousIndex]);
        }
        var delta = (currentTime - currentTimes[previousIndex]) / range;
        return delta;
      }

      function getCurrentDate(currentTime, currentTimes, dates) {
        var delta = getCurrentTimesDelta(currentTime, currentTimes);
        var currentIndex = getCurrentTimeIndex(currentTime, currentTimes);
        var previousIndex = 0;
        if (currentIndex != 0) {
          previousIndex = currentIndex - 1;
        }
        var currentDate = dates[currentIndex];
        var previousDate = dates[previousIndex];
        var range = currentDate - previousDate;
        var date = new Date(previousDate.getTime() + range*delta);
        // Ensure we don't go beyond the last date of the timeline.
        // An example of where this is needed is when we are playing at fast speed and the current time
        // might go slightly beyond (small epsilon) the desired end time. You can see this when playing
        // the Obesity layer at fast speed.
        var lastTimelineDate = new Date(timelapse.getCaptureTimes()[timelapse.getNumFrames() - 1]);
        if (date > lastTimelineDate) {
          date = lastTimelineDate;
        }
        return date;
      }

      // Draw Himawari8. This is a special case that does not play with any of the other layers.
      if (showHimawariTimeMachineLayer) {
        var himawariView = getLayerView(himawariTimeMachineLayer, landsatBaseMapLayer);
        himawariTimeMachineLayer.draw(himawariView, tileViewVisibility);
      } else if (showGoes16TimeMachineLayer) {
        var goes16View = getLayerView(goes16TimeMachineLayer, landsatBaseMapLayer);
        goes16TimeMachineLayer.draw(goes16View, tileViewVisibility);
      } else if (showDscovrTimeMachineLayer) {
        var dscovrView = getLayerView(dscovrTimeMachineLayer, landsatBaseMapLayer);
        dscovrTimeMachineLayer.draw(dscovrView, tileViewVisibility);
      } else {
        // Static layers that cover the entire planet should be placed before the base layers in this manner.
        if (showLightsAtNightLayer) { // Draw lightsAtNightMapLayer
          var lightsAtNightLayerView = getLayerView(lightsAtNightMapLayer, landsatBaseMapLayer);
          lightsAtNightMapLayer.draw(lightsAtNightLayerView);
        } else if (showLightsAtNight2012Layer) { // Draw lightsAtNight2012MapLayer
          var lightsAtNight2012LayerView = getLayerView(lightsAtNight2012MapLayer, landsatBaseMapLayer);
          lightsAtNight2012MapLayer.draw(lightsAtNight2012LayerView);
        } else if (showLightsAtNight2016Layer) { // Draw lightsAtNight2016MapLayer
          var lightsAtNight2016LayerView = getLayerView(lightsAtNight2016MapLayer, landsatBaseMapLayer);
          lightsAtNight2016MapLayer.draw(lightsAtNight2016LayerView);
        } else if (showHansenLayer2) { // Draw Forest Loss/Gain
          var hansenMapLayerView2 = getLayerView(hansenMapLayer2, landsatBaseMapLayer);
          hansenMapLayer2.draw(hansenMapLayerView2);
        } else if (visibleBaseMapLayer == "landsat") { // Draw Landsat
          landsatBaseMapLayer.draw(timelapse.getView(), tileViewVisibility);
        } else if (visibleBaseMapLayer == "light") { // Draw Light Map
          var lightBaseMapView = getLayerView(lightBaseMapLayer, landsatBaseMapLayer);
          lightBaseMapLayer.draw(lightBaseMapView);
        } else if (visibleBaseMapLayer == "dark") { // Draw Dark Map
          var darkBaseMapView = getLayerView(darkBaseMapLayer, landsatBaseMapLayer);
          var options = {showTile: showTile};
          darkBaseMapLayer.draw(darkBaseMapView, options);
        }

        // Layers to draw above the base layer (or planet-wide static layers)

        // Draw Coral Reef Watch
        if (showCrwTimeMachineLayer) {
          var crwView = getLayerView(crwTimeMachineLayer, landsatBaseMapLayer);
          crwTimeMachineLayer.draw(crwView, tileViewVisibility);
        }

        // Draw NDVI Anomaly
        if (showNdviAnomalyTimeMachineLayer) {
          var ndviView = getLayerView(ndviAnomalyTimeMachineLayer, landsatBaseMapLayer);
          ndviAnomalyTimeMachineLayer.draw(ndviView, tileViewVisibility);
        }

        // Draw Forest Loss by Year (Transparent)
        if (showHansenLayer) {
          var hansenMapLayerView = getLayerView(hansenMapLayer, landsatBaseMapLayer);
          hansenMapLayer.draw(hansenMapLayerView);
        }

        // Draw Vegetation Sensitivity Index
        if (showVsiLayer) {
          var vsiLayerView = getLayerView(vsiLayer, landsatBaseMapLayer);
          vsiLayer.draw(vsiLayerView);
        }

        // Draw Water Occurrence
        if (showWaterOccurrenceLayer) {
          var waterOccurrenceView = getLayerView(waterOccurrenceLayer, landsatBaseMapLayer);
          waterOccurrenceLayer.draw(waterOccurrenceView);
        }

        // Draw Water Change
        if (showWaterChangeLayer) {
          var waterChangeView = getLayerView(waterChangeLayer, landsatBaseMapLayer);
          waterChangeLayer.draw(waterChangeView);
        }

        // Draw Animated Hansen Layer
        if (showAnimatedHansenLayer) {
          var animatedHansenLayerView = getLayerView(animatedHansenLayer, landsatBaseMapLayer);
          var ratio = 0;
          var captureTimes = timelapse.getCaptureTimes();
          var offset = captureTimes.indexOf("2000");
          var fps = timelapse.getFps();
          if (offset > -1) {
            var currentTime = Math.max(0, timelapse.getCurrentTime() - offset / fps);
            ratio = currentTime / ((captureTimes.length - offset - 1) / fps);
            ratio = Math.min(1, currentTime);
          }
          animatedHansenLayerView.alpha = ratio;
          animatedHansenLayer.draw(animatedHansenLayerView);
        }

        // Draw Coral
        if (showMcrmLayer) {
          var mcrmLayerView = getLayerView(mcrmVectorLayer, landsatBaseMapLayer);
          mcrmVectorLayer.draw(mcrmLayerView);
        }

        // Draw Fires at Night (VIIRS)
        var viirsIndex = {
          '201408': {'count': 115909, 'first': 0},
          '201409': {'count': 213165, 'first': 115909},
          '201410': {'count': 232833, 'first': 329074},
          '201411': {'count': 146622, 'first': 561907},
          '201412': {'count': 151926, 'first': 708529},
          '201501': {'count': 192835, 'first': 860455},
          '201502': {'count': 150901, 'first': 1053290},
          '201503': {'count': 189347, 'first': 1204191},
          '201504': {'count': 175398, 'first': 1393538},
          '201505': {'count': 133021, 'first': 1568936},
          '201506': {'count': 116314, 'first': 1701957},
          '201507': {'count': 192662, 'first': 1818271},
          '201508': {'count': 289941, 'first': 2010933},
          '201509': {'count': 282792, 'first': 2300874},
          '201510': {'count': 286486, 'first': 2583666},
          '201511': {'count': 187366, 'first': 2870152},
          '201512': {'count': 183570, 'first': 3057518},
          '201601': {'count': 208576, 'first': 3241088},
          '201602': {'count': 179606, 'first': 3449664},
          '201603': {'count': 184595, 'first': 3629270},
          '201604': {'count': 185076, 'first': 3813865},
          '201605': {'count': 144875, 'first': 3998941},
          '201606': {'count': 126776, 'first': 4143816},
          '201607': {'count': 175568, 'first': 4270592},
          '201608': {'count': 236754, 'first': 4446160},
          '201609': {'count': 254754, 'first': 4682914},
          '201610': {'count': 174679, 'first': 4937668},
          '201611': {'count': 167121, 'first': 5112347},
          '201612': {'count': 183016, 'first': 5279468},
          '201701': {'count': 181133, 'first': 5462484},
          '201702': {'count': 158187, 'first': 5643617},
          '201703': {'count': 156410, 'first': 5801804},
          '201704': {'count': 170735, 'first': 5958214},
          '201705': {'count': 101733, 'first': 6128949},
          '201706': {'count': 132268, 'first': 6230682},
          '201707': {'count': 171562, 'first': 6362950},
          '201708': {'count': 299079, 'first': 6534512},
          '201709': {'count': 298956, 'first': 6833591},
          '201710': {'count': 53789, 'first': 7132547}
        };
        if (showViirsLayer) {
          var viirsLayerView = getLayerView(viirsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;

          var currentMonth = currentDate.getUTCMonth();
          var currentYear = currentDate.getUTCFullYear();
          var prevYear = currentYear;
          var prevMonth = currentMonth - 1;
          if (prevMonth < 0) {
            prevMonth = 11;
            prevYear--;
          }

          var currentIdx = currentYear + ('0' + (currentMonth+1)).slice(-2);
          var prevIdx = prevYear + ('0' + (prevMonth+1)).slice(-2);
          options.first = prevIdx in viirsIndex ? viirsIndex[prevIdx]['first'] : 0 ;
          options.count = prevIdx in viirsIndex && currentIdx in viirsIndex ? viirsIndex[currentIdx]['count'] + viirsIndex[prevIdx]['count'] : 100;

          viirsLayer.draw(viirsLayerView, options);
        }

        // Draw Coral Bleaching
        if (showCoralBleachingLayer) {
          var coralBleachingLayerView = getLayerView(coralBleachingLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [0.82, 0.22, 0.07, 1.0];
          options.pointSize = 8.0;
          coralBleachingLayer.draw(coralBleachingLayerView, options);
        }

        // Draw Wind Layer
        if (showUsgsWindTurbineLayer) {
          var usgsWindTurbineLayerView = getLayerView(usgsWindTurbineLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [0.1, 0.5, 0.1, 1.0];
          options.pointSize = 3.0;
          usgsWindTurbineLayer.draw(usgsWindTurbineLayerView, options);
        }

        // Draw Global Wind Layer
        if (showGlobalWindPowerLayer) {
          var globalWindPowerLayerView = getLayerView(globalWindPowerLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 3;
          options.color = [0.1, 0.5, 0.1, 1.0];
          globalWindPowerLayer.draw(globalWindPowerLayerView, options);
        }

        // Draw Solar Layer
        if (showSolarInstallsLayer) {
          var solarInstallsLayerView = getLayerView(solarInstallsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 3;
          solarInstallsLayer.draw(solarInstallsLayerView, options);
        }

        // Draw Oil/Gas Drilling Layer
        if (showDrillingLayer) {
          var drillingLayerView = getLayerView(drillingLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [0.82, 0.22, 0.07, 1.0];
          drillingLayer.draw(drillingLayerView, options);
        }

        // Draw Forest Alerts (No Overlay)
        if (showForestAlertsNoOverlayTimeMachineLayer) {
          var forestAlertsNoOverlayView = timelapse.getView();
          var timelapse2map = forestAlertsNoOverlayTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

          var p = timelapse.getProjection();
          var offest = p.latlngToPoint({
            "lat": 5.506709319555738,
            "lng": -82.5513118548623
          });

          forestAlertsNoOverlayView.x -= offest.x;
          forestAlertsNoOverlayView.y -= offest.y;
          forestAlertsNoOverlayTimeMachineLayer.draw(forestAlertsNoOverlayView, tileViewVisibility);
        }

        // Draw Forest Alerts (With Overlay)
        if (showForestAlertsTimeMachineLayer) {
          var forestAlertsView = timelapse.getView();
          var timelapse2map = forestAlertsTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

          var p = timelapse.getProjection();
          var offest = p.latlngToPoint({
            "lat": 5.506709319555738,
            "lng": -82.5513118548623
          });

          forestAlertsView.x -= offest.x;
          forestAlertsView.y -= offest.y;
          forestAlertsTimeMachineLayer.draw(forestAlertsView, tileViewVisibility);
        }

        // Draw Protected Areas (WDPA)
        if (showWdpaLayer) {
          var options = {};
          var wdpaLayerView = getLayerView(wdpaLayer, landsatBaseMapLayer);
          wdpaLayer.draw(wdpaLayerView, options);
        }

        // Draw Mediterranean Monthly Refugees
        if (showMonthlyRefugeesLayer) {
          var monthlyRefugeesLayerView = getLayerView(monthlyRefugeesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          monthlyRefugeesLayer.draw(monthlyRefugeesLayerView, options);
        }

        // Draw Annual Refugees
        if (showAnnualRefugeesLayer) {
          var annualRefugeesLayerView = getLayerView(annualRefugeesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.span = 240 * 24 * 60 * 60 * 1000;
          options.subsampleAnnualRefugees = subsampleAnnualRefugees;
          options.pointIdx = {
            2001: {'count': 798896, 'start': 0},
            2002: {'count': 1377803, 'start': 798896},
            2003: {'count': 402155, 'start': 2176699},
            2004: {'count': 640155, 'start': 2578854},
            2005: {'count': 375991, 'start': 3219009},
            2006: {'count': 1666399, 'start': 3595000},
            2007: {'count': 2881204, 'start': 5261399},
            2008: {'count': 431865, 'start': 8142603},
            2009: {'count': 900246, 'start': 8574468},
            2010: {'count': 492341, 'start': 9474714},
            2011: {'count': 742046, 'start': 9967055},
            2012: {'count': 1356451, 'start': 10709101},
            2013: {'count': 2260887, 'start': 12065552},
            2014: {'count': 3107100, 'start': 14326439},
            2015: {'count': 2331430, 'start': 17433539}
          };
          annualRefugeesLayer.draw(annualRefugeesLayerView, options);
        }

        // Draw Annual Returns
        if (showAnnualReturnsLayer) {
          var annualReturnsLayerView = getLayerView(annualReturnsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.span = 240 * 24 * 60 * 60 * 1000;
          options.subsampleAnnualRefugees = subsampleAnnualReturns;
          options.pointIdx = {
            2000: {'count': 763562, 'start': 0},
            2001: {'count': 453831, 'start': 763562},
            2002: {'count': 2411730, 'start': 1217393},
            2003: {'count': 1093240, 'start': 3629123},
            2004: {'count': 1431823, 'start': 4722363},
            2005: {'count': 1105375, 'start': 6154186},
            2006: {'count': 710542, 'start': 7259561},
            2007: {'count': 728128, 'start': 7970103},
            2008: {'count': 589392, 'start': 8698231},
            2009: {'count': 247555, 'start': 9287623},
            2010: {'count': 171179, 'start': 9535178},
            2011: {'count': 530960, 'start': 9706357},
            2012: {'count': 525154, 'start': 10237317},
            2013: {'count': 413619, 'start': 10762471},
            2014: {'count': 126877, 'start': 11176090},
            2015: {'count': 201440, 'start': 11302967}
          };
          annualReturnsLayer.draw(annualReturnsLayerView, options);
        }

        // Draw Nutritional Deficiency Layers
        if (showHealthImpactLayer) {
          var healthImpactLayerView = getLayerView(healthImpactLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();

          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var endDate = new Date("2055");
          var startDate = new Date("2015");
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          var year = currentDate.getUTCFullYear();

          for (var i = 0; i < times.length - 1; i++) {
            if (year == times[i] || year < times[i + 1] && year > times[i]) {
              year = parseInt(times[i]);
            }
          }
          var currentYear = new Date(year, 0, 1);
          var nextYear = new Date(year + 5, 0, 1);
          if (year >= 2050) {
            nextYear = currentYear;
          }
          var delta = (currentDate.getTime() - currentYear) / (nextYear - currentYear);

          options.year = year;
          options.delta = delta;
          options.showRcp = showHealthImpactRcp;

          healthImpactLayer.draw(healthImpactLayerView, options);
        }

        // Draw Zika Layer
        if (showZikaLayer) {
          var zikaLayerView = getLayerView(zikaLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.color = [1.0, 0.1, 0.1, 1.0];
          options.pointSize = 10.0;
          zikaLayer.draw(zikaLayerView, options);
        }

        // Draw Dengue Layer
        if (showDengueLayer) {
          var dengueLayerView = getLayerView(dengueLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.color = [0.2, 1.0, 0.1, 1.0];
          options.pointSize = 10.0;
          dengueLayer.draw(dengueLayerView, options);
        }

        // Draw Chiku Layer
        if (showChikuLayer) {
          var chikuLayerView = getLayerView(chikuLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var startDate = new Date(parseInt(times[0]), 0, 1);
          var endDate = new Date(parseInt(times[times.length - 1]) + 1, 0, 1);
          var range = endDate.getTime() - startDate.getTime();
          var currentDate = new Date(ratio * range + startDate.getTime());
          options.currentTime = currentDate;
          options.color = [0.1, 0.1, 1.0, 1.0];
          options.pointSize = 10.0;
          chikuLayer.draw(chikuLayerView, options);
        }

        // Draw Sea Level Rise Layer
        if (showSeaLevelRiseLayer) {
          var sea_level_heights = [
            [0.0, 0.0],
            [2.4, 0.7],
            [7.0, 2.1],
            [9.4, 2.9],
            [15, 4.7],
            [18, 5.6],
            [21, 6.4],
            [26, 7.9],
            [29, 8.9]
          ]; // [feet,meters]
          var feet = document.getElementById("slr-feet");
          var meters = document.getElementById("slr-meters");
          var degree = document.getElementById("slr-degree");
          var seaLevelRiseLayerView = getLayerView(seaLevelRiseLayer, landsatBaseMapLayer);
          var options = {};
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var start = parseFloat(times[0]);
          var end = parseFloat(times[times.length - 1]) + 0.5;
          var range = end - start;
          var current = ratio * range + start;
          options.currentC = Math.min(current, times[times.length - 1]);
          if (visibleBaseMapLayer == "landsat") {
            options.color = [0.1, 0.1, 0.1, 1.0];
          } else if (visibleBaseMapLayer == "light") {
            options.color = [0.4921875, 0.7421875, 0.91015625, 1.0];
          } else if (visibleBaseMapLayer == "dark") {
            options.color = [0.203125, 0.203125, 0.203125, 1.0];
          } else if (showLightsAtNightLayer || showLightsAtNight2012Layer || showLightsAtNight2016Layer) {
            options.color = [0.0, 0.0, 0.0, 1.0];
          }
          var currentIndex = 0;
          for (var i = 0; i < times.length; i++) {
            if (timelapse.getCurrentCaptureTime() == times[i]) {
              currentIndex = i;
            }
          }
          //feet.innerHTML = sea_level_heights[currentIndex][0] + "ft";
          if (sea_level_heights[currentIndex]) {
            $(meters).html("+" + sea_level_heights[currentIndex][1].toFixed(1) + "m");
          }
          $(degree).html((currentIndex / 2).toFixed(1));
          seaLevelRiseLayer.draw(seaLevelRiseLayerView, options);
          $(".timeText, .captureTimeMain").html(timelapse.getCurrentCaptureTime() + "&degC");
        }

        if (showUrbanFragilityLayer) {
          var urbanFragilityLayerView = getLayerView(urbanFragilityLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();

          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          var year = currentDate.getUTCFullYear();
          options.year = year;
          options.delta = Math.min(delta, 1);
          urbanFragilityLayer.draw(urbanFragilityLayerView, options);

        }

        if (showGtdLayer) {
          var gtdLayerView = getLayerView(gtdLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [1.0, 0.0, 0.0, 1.0];
          gtdLayer.draw(gtdLayerView, options);
        }

        if (showUppsalaConflictLayer) {
          var uppsalaConflictLayerView = getLayerView(uppsalaConflictLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [1.0, 0.0, 0.0, 1.0];
          uppsalaConflictLayer.draw(uppsalaConflictLayerView, options);
        }

        if (showHivLayer) {
          var hivLayerView = getLayerView(hivLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();

          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          var year = currentDate.getUTCFullYear();
          options.year = year;
          options.delta = Math.min(delta, 1);
          hivLayer.draw(hivLayerView, options);
        }

        if (showObesityLayer) {
          var obesityLayerView = getLayerView(obesityLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();

          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          var year = currentDate.getUTCFullYear();
          options.year = year;
          options.delta = Math.min(delta, 1);
          obesityLayer.draw(obesityLayerView, options);
        }

        if (showVaccineConfidenceLayer) {
          var vaccineConfidenceLayerView = getLayerView(vaccineConfidenceLayer, landsatBaseMapLayer);
          var options = {};

          var vaccineConfidenceQuestion = 1.0;
          if ($("#show-vaccine-confidence-q2").prop('checked')) {
            vaccineConfidenceQuestion = 2.0;
          }
          if ($("#show-vaccine-confidence-q3").prop('checked')) {
            vaccineConfidenceQuestion = 3.0;
          }
          if ($("#show-vaccine-confidence-q4").prop('checked')) {
            vaccineConfidenceQuestion = 4.0;
          }
          options.question = vaccineConfidenceQuestion;
          vaccineConfidenceLayer.draw(vaccineConfidenceLayerView, options);

        }

        if (showEbolaDeathsLayer) {
          var ebolaLayerView = getLayerView(ebolaDeathsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [1.0, 0.0, 0.0, 1.0];
          options.pointSize = 2.5;
          ebolaDeathsLayer.draw(ebolaLayerView, options);
        }

        if (showEbolaCasesLayer) {
          var ebolaLayerView = getLayerView(ebolaCasesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [0.0, 1.0, 0.0, 1.0];
          options.pointSize = 2.5;
          ebolaCasesLayer.draw(ebolaLayerView, options);
        }

        if (showEbolaNewCasesLayer) {
          var ebolaLayerView = getLayerView(ebolaNewCasesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.color = [0.0, 0.0, 1.0, 1.0];
          options.pointSize = 5.0;
          ebolaNewCasesLayer.draw(ebolaLayerView, options);
        }

        if (showLodesLayer) {
          var lodesLayerView = getLayerView(lodesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          options.se01 = lodesOptions.se01;
          options.se02 = lodesOptions.se02;
          options.se03 = lodesOptions.se03;

          options.filter = lodesOptions.filter;
          options.distance = lodesOptions.distance;

          if (lodesOptions.animate == 'animate') {
            var now = new Date();
            var deltaTime = now.getTime() - lodesAnimationState.then.getTime();
            var step = deltaTime/(lodesOptions.totalTime*lodesOptions.speed);
            if (lodesAnimationState.inMainLoop) {
              if (lodesOptions.doPulse) {
                if (lodesAnimationState.pulse) {
                  step = 1. - step;
                }
              } else if (lodesAnimationState.pulse) {
                lodesAnimationState.pulse = false;
              }

              if (deltaTime >= lodesOptions.totalTime*lodesOptions.speed) {
                lodesAnimationState.then = new Date();
                lodesAnimationState.inMainLoop = false;
                if (lodesOptions.doPulse && lodesAnimationState.pulse) {
                  lodesAnimationState.inStartDwell = true;
                } else {
                  lodesAnimationState.inEndDwell = true;
                }
              }
            }
            else if (lodesAnimationState.inStartDwell) {
              step = 0.;
              if (deltaTime >= lodesOptions.dwellTime) {
                lodesAnimationState.inStartDwell = false;
                lodesAnimationState.inMainLoop = true;
                lodesAnimationState.then = new Date();
                if (lodesOptions.doPulse) {
                  lodesAnimationState.pulse = false;
                }
              }
            }
            else {
              step = 1.;
              if (deltaTime >= lodesOptions.dwellTime) {
                lodesAnimationState.inEndDwell = false;
                lodesAnimationState.then = new Date();
                if (lodesOptions.doPulse) {
                  lodesAnimationState.inMainLoop = true;
                  lodesAnimationState.pulse = true;
                } else {
                  lodesAnimationState.inStartDwell = true;
                }
              }
            }
            step = Math.min(Math.max(step, 0.),1.);

          } else if (lodesOptions.animate == 'home'){
              step = 0.;
          } else {
            step = 1.;
          }

          options.step = step;

          var info = getLayerInfo(lodesLayer);
          var throttle = 1.0;
          if (info.zoomLevel >= 5 && info.mapLevel >= 5 && info.mapLevel < 11) {
            throttle = Math.min(1000000/info.pointCount, 1.0);
          }

          options.throttle = throttle;
          lodesLayer.draw(lodesLayerView, options);
        }

        // Show dotmaps loaded from spreadsheet
        for (var i = 0; i < dotmapLayers.length; i++) {
          var layer = dotmapLayers[i];
          if (layer.visible) {
            var view = getLayerView(layer, landsatBaseMapLayer);
            var options = {};
            options.zoom = timelapse.getCurrentZoom();

            // Throttle number of pixels if we're drawing "too many"
            var maxPoints = canvasLayer.canvas.width * canvasLayer.canvas.height;
            var info = getLayerInfo(layer);
            var drawFraction = 0.125;
            drawFraction = Math.min(maxPoints/info.pointCount, 1.0);

            options.throttle = drawFraction;
            layer.draw(view, options);
          }
        }

        if (showCumulativeActiveMiningLayer) {
          var cumulativeActiveMiningLayerView = getLayerView(cumulativeActiveMiningLayer, landsatBaseMapLayer);
          var options = {};
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var start = parseFloat(times[0]);
          var end = parseFloat(times[times.length - 1]) + 0.5;
          var range = end - start;
          var current = ratio * range + start;
          var currentIndex = 0;
          for (var i = 0; i < times.length; i++) {
            if (timelapse.getCurrentCaptureTime() == times[i]) {
              currentIndex = i;
            }
          }
          var colorRamp = {
            "1984": [255,255,255],
            "1985": [255,255,204],
            "1986": [250,246,198],
            "1987": [246,238,192],
            "1988": [242,229,187],
            "1989": [238,221,181],
            "1990": [233,212,176],
            "1991": [229,204,170],
            "1992": [225,195,165],
            "1993": [221,187,159],
            "1994": [216,178,154],
            "1995": [212,170,148],
            "1996": [208,161,143],
            "1997": [204,153,137],
            "1998": [199,144,132],
            "1999": [195,136,126],
            "2000": [191,127,121],
            "2001": [187,119,115],
            "2002": [183,110,109],
            "2003": [178,102,104],
            "2004": [174,93,98],
            "2005": [170,85,93],
            "2006": [166,76,87],
            "2007": [161,68,82],
            "2008": [157,59,76],
            "2009": [153,51,71],
            "2010": [149,42,65],
            "2011": [144,34,60],
            "2012": [140,25,54],
            "2013": [136,17,49],
            "2014": [132,8,43],
            "2015": [128,0,38],
            "2016": [128,0,0]
          }
          var currentBValue = colorRamp[times[currentIndex]][2]/255;
          options.currentBValue = currentBValue;
          cumulativeActiveMiningLayer.draw(cumulativeActiveMiningLayerView, options);
        }

        // Draw Annual Global PM 2.5
        if (showAnnualGlobalPm25TimeMachineLayer) {
          var view = getLayerView(annualGlobalPm25TimeMachineLayer, landsatBaseMapLayer);
          annualGlobalPm25TimeMachineLayer.draw(view, tileViewVisibility);
        }

        // ## 7 ##
        //// Layers to draw on top go here
        //
        var visibleCsvLayers = [];
        for (var i = 0; i < csvFileLayers.layers.length; i++) {
          var layer = csvFileLayers.layers[i];
          if (layer.visible && layer.paired) {
            visibleCsvLayers.push(i);
          }
        }
        for (var i = 0; i < csvFileLayers.layers.length; i++) {
          var layer = csvFileLayers.layers[i];
          if (layer.visible) {
            var view = getLayerView(layer, landsatBaseMapLayer);
            var options = {};
            options.zoom = timelapse.getCurrentZoom();
            var currentTime = timelapse.getCurrentTime();
            var currentTimes = getCurrentTimes(timelapse);
            var dates = getDates(timelapse);
            var delta = getCurrentTimesDelta(currentTime, currentTimes);
            var currentDate = getCurrentDate(currentTime, currentTimes, dates);
            options.currentTime = currentDate;
            options.pointSize = 2.0;
            if (visibleCsvLayers.length >= 2) {
              if (visibleCsvLayers[0] == i) {
                options.mode = 2.0;
              }
              if (visibleCsvLayers[1] == i) {
                options.mode = 3.0;
              }
            }
            if (layer.options) {
              $.extend(options, layer.options);
            }
            layer.draw(view, options);
          }
        }

        if (showIomIdpLayer) {
          var iomIdpLayerView = getLayerView(iomIdpLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.epoch = currentDate.getTime()/1000.;
          options.pointSize = 4.0;
          options.showIrqIdps = iomIdpLayer.options['showIrqIdps'];
          options.showSyrIdps = iomIdpLayer.options['showSyrIdps'];
          options.showYemIdps = iomIdpLayer.options['showYemIdps'];
          options.showLbyIdps = iomIdpLayer.options['showLbyIdps'];
          options.showIrqReturns = iomIdpLayer.options['showIrqReturns'];
          options.showSyrReturns = iomIdpLayer.options['showSyrReturns'];
          options.showYemReturns = iomIdpLayer.options['showYemReturns'];
          options.showLbyReturns = iomIdpLayer.options['showLbyReturns'];
          iomIdpLayer.draw(iomIdpLayerView, options);
        }

        if (showBerkeleyEarthTemperatureAnomalyTimeMachineLayer) {
          var view = getLayerView(berkeleyEarthTemperatureAnomalyTimeMachineLayer, landsatBaseMapLayer);
          berkeleyEarthTemperatureAnomalyTimeMachineLayer.draw(view, tileViewVisibility);

          var landBorderView = getLayerView(landBorderLayer, landsatBaseMapLayer);
          landBorderLayer.draw(landBorderView);

          if (showCityLabelMap) {
            var cityLabelView = getLayerView(cityLabelMapLayer, landsatBaseMapLayer);
            cityLabelMapLayer.draw(cityLabelView);
          }
        }

        if (showOmiNo2Layer) {
          var view = getLayerView(omiNo2Layer, landsatBaseMapLayer);
          omiNo2Layer.draw(view, tileViewVisibility);

          var landBorderView = getLayerView(landBorderLayer, landsatBaseMapLayer);
          landBorderLayer.draw(landBorderView);
        }

        if (showBePm25Layer) {
          var view = getLayerView(bePm25Layer, landsatBaseMapLayer);
          bePm25Layer.draw(view, tileViewVisibility);
        }

        if (showChinaAviationLayer) {
          var chinaAviationLayerView = getLayerView(chinaAviationLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 5 * window.devicePixelRatio;
          options.color = [1.0, 0.0, 0.0, 1.0];
          chinaAviationLayer.draw(chinaAviationLayerView, options);
        }

        if (showChinaPowerPlantsLayer) {
          var chinaPowerPlantsLayerView = getLayerView(chinaPowerPlantsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 5 * window.devicePixelRatio;
          options.color = [0.0, 1.0, 0.0, 1.0];
          chinaPowerPlantsLayer.draw(chinaPowerPlantsLayerView, options);
        }

        if (showChinaReservoirsLayer) {
          var chinaReservoirsLayerView = getLayerView(chinaReservoirsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 5 * window.devicePixelRatio;
          options.color = [0.0, 0.0, 1.0, 1.0];
          chinaReservoirsLayer.draw(chinaReservoirsLayerView, options);
        }

        if (showChinaWasteTreatmentPlantsLayer) {
          var chinaWasteTreatmentPlantsLayerView = getLayerView(chinaWasteTreatmentPlantsLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 5 * window.devicePixelRatio;
          options.color = [1.0, 0.5, 0.15, 1.0];
          chinaWasteTreatmentPlantsLayer.draw(chinaWasteTreatmentPlantsLayerView, options);
        }

        if (showCountryLabelMapLayer) {
          var countryLabelMapView = getLayerView(countryLabelMapLayer, landsatBaseMapLayer);
          countryLabelMapLayer.draw(countryLabelMapView);
        }

        if (showExpandingCitiesLayer) {
          var layerView = getLayerView(expandingCitiesLayer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 5 * window.devicePixelRatio;
          options.color = [1.0, 0.5, 0.15, 1.0];
          var year = currentDate.getUTCFullYear();
          options.year = year;
          options.delta = Math.min(delta, 1);
          options.maxValue = 195;
          expandingCitiesLayer.draw(layerView, options);
        }

        if (showIrenaWindLayer) {
          var layer  = irenaWindLayer;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 500.;
          layer.draw(view, options);
        }
        if (showIrenaSolarLayer) {
          var layer = irenaSolarLayer;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 500.;
          options.color = [0.5,0.05,0.5,1.0];
          layer.draw(view, options);
        }

        if (showCarbonPriceRiskLayer) {
          var layer = carbonPriceRiskLayer;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.sectors = carbonPriceRisk.sectors;
          layer.draw(view, options);
        }

        if (showTsipLayer) {
          var layer = tsipLayer;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          layer.draw(view, options);
        }

        var crude_flows_index = [
          {'filename': '0-crude-flows.bin', 'max_epoch': 1362803764.439162, 'min_epoch': 1344196740.0},
          {'filename': '1-crude-flows.bin', 'max_epoch': 1368630850.6254642, 'min_epoch': 1356352440.0},
          {'filename': '2-crude-flows.bin', 'max_epoch': 1375477977.755611, 'min_epoch': 1363526454.6067417},
          {'filename': '3-crude-flows.bin', 'max_epoch': 1382008440.0, 'min_epoch': 1365473760.0},
          {'filename': '4-crude-flows.bin', 'max_epoch': 1392493649.7164462, 'min_epoch': 1371392040.0},
          {'filename': '5-crude-flows.bin', 'max_epoch': 1393598774.858223, 'min_epoch': 1382677171.011236},
          {'filename': '6-crude-flows.bin', 'max_epoch': 1399832731.587473, 'min_epoch': 1385223928.5822306},
          {'filename': '7-crude-flows.bin', 'max_epoch': 1406034129.6090713, 'min_epoch': 1392063240.0},
          {'filename': '8-crude-flows.bin', 'max_epoch': 1413160440.0, 'min_epoch': 1400939343.3707864},
          {'filename': '9-crude-flows.bin', 'max_epoch': 1418089195.8662152, 'min_epoch': 1404994380.0},
          {'filename': '10-crude-flows.bin', 'max_epoch': 1424125799.774436, 'min_epoch': 1413165780.0},
          {'filename': '11-crude-flows.bin', 'max_epoch': 1442046780.0, 'min_epoch': 1417092012.1348314},
          {'filename': '12-crude-flows.bin', 'max_epoch': 1437058019.1022444, 'min_epoch': 1421189963.6363637},
          {'filename': '13-crude-flows.bin', 'max_epoch': 1443465644.3032672, 'min_epoch': 1425812640.0},
          {'filename': '14-crude-flows.bin', 'max_epoch': 1448988823.6228287, 'min_epoch': 1436904887.2727273},
          {'filename': '15-crude-flows.bin', 'max_epoch': 1455260843.3774915, 'min_epoch': 1445261237.9165041},
          {'filename': '16-crude-flows.bin', 'max_epoch': 1463993410.909091, 'min_epoch': 1450881160.140802},
          {'filename': '17-crude-flows.bin', 'max_epoch': 1467755612.9371564, 'min_epoch': 1457289194.0186915},
          {'filename': '18-crude-flows.bin', 'max_epoch': 1474374616.3636363, 'min_epoch': 1463748721.8181818},
          {'filename': '19-crude-flows.bin', 'max_epoch': 1481250173.6283185, 'min_epoch': 1469280227.0160873},
          {'filename': '20-crude-flows.bin', 'max_epoch': 1487025440.549273, 'min_epoch': 1474853520.0},
          {'filename': '21-crude-flows.bin', 'max_epoch': 1492642858.041543, 'min_epoch': 1483774740.0},
          {'filename': '22-crude-flows.bin', 'max_epoch': 1503923820.0, 'min_epoch': 1482323820.0},
          {'filename': '23-crude-flows.bin', 'max_epoch': 1508006340.0, 'min_epoch': 1492941696.4485981},
          {'filename': '24-crude-flows.bin', 'max_epoch': 1509999715.9048486, 'min_epoch': 1497947778.504673}
         ];
        function showIndex(idx, epoch) {
          return crude_flows_index[idx]['min_epoch'] < epoch && crude_flows_index[idx]['max_epoch'] > epoch;
        }

        if (showSpCrudeLayer) {
          var layer = spCrudeLayer;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          var currentEpoch = currentDate/1000.;
          for (var i = 0; i < crude_flows_index.length; i++) {
            if (showIndex(i, currentEpoch)) {
              if (typeof spCrudeLayer.buffers[i] == "undefined") {
                spCrudeLayer.buffers[i] = {
                  "numAttributes": 7,
                  "count": 0,
                  "buffer": null,
                  "ready": false
                };

                var dataUrl = rootTilePath + '/sp-crude/' + crude_flows_index[i]["filename"];
                shipsWorker.postMessage({'idx': i, 'url': dataUrl});
              }
              options.idx = i;
              options.buffers = spCrudeLayer.buffers;
              layer.draw(view, options);
            }
          }
        }

        var crude_flows_index_Oceania = [{'max_epoch': 1.5083176e+09, 'filename': 'Oceania/0-crude-flows_Oceania.bin', 'min_epoch': 1.3435715e+09}];
        var crude_flows_index_AG = [{'max_epoch': 1.3617048e+09, 'filename': 'AG/0-crude-flows_AG.bin', 'min_epoch': 1.3441967e+09}, {'max_epoch': 1.3771071e+09, 'filename': 'AG/1-crude-flows_AG.bin', 'min_epoch': 1.3594772e+09}, {'max_epoch': 1.3706697e+09, 'filename': 'AG/2-crude-flows_AG.bin', 'min_epoch': 1.3597724e+09}, {'max_epoch': 1.3761761e+09, 'filename': 'AG/3-crude-flows_AG.bin', 'min_epoch': 1.3693578e+09}, {'max_epoch': 1.3799291e+09, 'filename': 'AG/4-crude-flows_AG.bin', 'min_epoch': 1.3730234e+09}, {'max_epoch': 1.3835629e+09, 'filename': 'AG/5-crude-flows_AG.bin', 'min_epoch': 1.376452e+09}, {'max_epoch': 1.3884915e+09, 'filename': 'AG/6-crude-flows_AG.bin', 'min_epoch': 1.3797737e+09}, {'max_epoch': 1.3922216e+09, 'filename': 'AG/7-crude-flows_AG.bin', 'min_epoch': 1.3842066e+09}, {'max_epoch': 1.3967419e+09, 'filename': 'AG/8-crude-flows_AG.bin', 'min_epoch': 1.3880942e+09}, {'max_epoch': 1.4022243e+09, 'filename': 'AG/9-crude-flows_AG.bin', 'min_epoch': 1.3932987e+09}, {'max_epoch': 1.4059923e+09, 'filename': 'AG/10-crude-flows_AG.bin', 'min_epoch': 1.398294e+09}, {'max_epoch': 1.4106575e+09, 'filename': 'AG/11-crude-flows_AG.bin', 'min_epoch': 1.4030985e+09}, {'max_epoch': 1.4146995e+09, 'filename': 'AG/12-crude-flows_AG.bin', 'min_epoch': 1.408361e+09}, {'max_epoch': 1.4204237e+09, 'filename': 'AG/13-crude-flows_AG.bin', 'min_epoch': 1.4105153e+09}, {'max_epoch': 1.4244887e+09, 'filename': 'AG/14-crude-flows_AG.bin', 'min_epoch': 1.416967e+09}, {'max_epoch': 1.4297343e+09, 'filename': 'AG/15-crude-flows_AG.bin', 'min_epoch': 1.4202262e+09}, {'max_epoch': 1.4338424e+09, 'filename': 'AG/16-crude-flows_AG.bin', 'min_epoch': 1.4269531e+09}, {'max_epoch': 1.438222e+09, 'filename': 'AG/17-crude-flows_AG.bin', 'min_epoch': 1.4312159e+09}, {'max_epoch': 1.4429395e+09, 'filename': 'AG/18-crude-flows_AG.bin', 'min_epoch': 1.4354159e+09}, {'max_epoch': 1.4478618e+09, 'filename': 'AG/19-crude-flows_AG.bin', 'min_epoch': 1.4417828e+09}, {'max_epoch': 1.4529947e+09, 'filename': 'AG/20-crude-flows_AG.bin', 'min_epoch': 1.4457651e+09}, {'max_epoch': 1.458193e+09, 'filename': 'AG/21-crude-flows_AG.bin', 'min_epoch': 1.4514196e+09}, {'max_epoch': 1.4634623e+09, 'filename': 'AG/22-crude-flows_AG.bin', 'min_epoch': 1.4557041e+09}, {'max_epoch': 1.4669064e+09, 'filename': 'AG/23-crude-flows_AG.bin', 'min_epoch': 1.4613379e+09}, {'max_epoch': 1.4730853e+09, 'filename': 'AG/24-crude-flows_AG.bin', 'min_epoch': 1.4639675e+09}, {'max_epoch': 1.4782132e+09, 'filename': 'AG/25-crude-flows_AG.bin', 'min_epoch': 1.4703533e+09}, {'max_epoch': 1.480319e+09, 'filename': 'AG/26-crude-flows_AG.bin', 'min_epoch': 1.4711836e+09}, {'max_epoch': 1.4862049e+09, 'filename': 'AG/27-crude-flows_AG.bin', 'min_epoch': 1.47741e+09}, {'max_epoch': 1.4903073e+09, 'filename': 'AG/28-crude-flows_AG.bin', 'min_epoch': 1.4828404e+09}, {'max_epoch': 1.4943535e+09, 'filename': 'AG/29-crude-flows_AG.bin', 'min_epoch': 1.4861729e+09}, {'max_epoch': 1.4983288e+09, 'filename': 'AG/30-crude-flows_AG.bin', 'min_epoch': 1.4919392e+09}, {'max_epoch': 1.5031058e+09, 'filename': 'AG/31-crude-flows_AG.bin', 'min_epoch': 1.4967662e+09}, {'max_epoch': 1.5120396e+09, 'filename': 'AG/32-crude-flows_AG.bin', 'min_epoch': 1.5002131e+09}];
        var crude_flows_index_WAF = [{'max_epoch': 1.3656445e+09, 'filename': 'WAF/0-crude-flows_WAF.bin', 'min_epoch': 1.3473725e+09}, {'max_epoch': 1.3747565e+09, 'filename': 'WAF/1-crude-flows_WAF.bin', 'min_epoch': 1.3650022e+09}, {'max_epoch': 1.3842788e+09, 'filename': 'WAF/2-crude-flows_WAF.bin', 'min_epoch': 1.3740604e+09}, {'max_epoch': 1.3929523e+09, 'filename': 'WAF/3-crude-flows_WAF.bin', 'min_epoch': 1.3833535e+09}, {'max_epoch': 1.4025202e+09, 'filename': 'WAF/4-crude-flows_WAF.bin', 'min_epoch': 1.3921147e+09}, {'max_epoch': 1.411857e+09, 'filename': 'WAF/5-crude-flows_WAF.bin', 'min_epoch': 1.4018527e+09}, {'max_epoch': 1.4214098e+09, 'filename': 'WAF/6-crude-flows_WAF.bin', 'min_epoch': 1.4116553e+09}, {'max_epoch': 1.4311532e+09, 'filename': 'WAF/7-crude-flows_WAF.bin', 'min_epoch': 1.4210131e+09}, {'max_epoch': 1.4404055e+09, 'filename': 'WAF/8-crude-flows_WAF.bin', 'min_epoch': 1.4305885e+09}, {'max_epoch': 1.4499501e+09, 'filename': 'WAF/9-crude-flows_WAF.bin', 'min_epoch': 1.4388869e+09}, {'max_epoch': 1.458926e+09, 'filename': 'WAF/10-crude-flows_WAF.bin', 'min_epoch': 1.4490766e+09}, {'max_epoch': 1.468358e+09, 'filename': 'WAF/11-crude-flows_WAF.bin', 'min_epoch': 1.458066e+09}, {'max_epoch': 1.4786161e+09, 'filename': 'WAF/12-crude-flows_WAF.bin', 'min_epoch': 1.4664877e+09}, {'max_epoch': 1.4881251e+09, 'filename': 'WAF/13-crude-flows_WAF.bin', 'min_epoch': 1.4772301e+09}, {'max_epoch': 1.4974886e+09, 'filename': 'WAF/14-crude-flows_WAF.bin', 'min_epoch': 1.4877286e+09}, {'max_epoch': 1.507764e+09, 'filename': 'WAF/15-crude-flows_WAF.bin', 'min_epoch': 1.496261e+09}, {'max_epoch': 1.511334e+09, 'filename': 'WAF/16-crude-flows_WAF.bin', 'min_epoch': 1.5044224e+09}];
        var crude_flows_index_MedNAF = [{'max_epoch': 1.3762028e+09, 'filename': 'MedNAF/0-crude-flows_MedNAF.bin', 'min_epoch': 1.3501318e+09}, {'max_epoch': 1.4003267e+09, 'filename': 'MedNAF/1-crude-flows_MedNAF.bin', 'min_epoch': 1.3754286e+09}, {'max_epoch': 1.4250889e+09, 'filename': 'MedNAF/2-crude-flows_MedNAF.bin', 'min_epoch': 1.3960728e+09}, {'max_epoch': 1.4498509e+09, 'filename': 'MedNAF/3-crude-flows_MedNAF.bin', 'min_epoch': 1.4244504e+09}, {'max_epoch': 1.4743622e+09, 'filename': 'MedNAF/4-crude-flows_MedNAF.bin', 'min_epoch': 1.4464378e+09}, {'max_epoch': 1.4972628e+09, 'filename': 'MedNAF/5-crude-flows_MedNAF.bin', 'min_epoch': 1.4736177e+09}, {'max_epoch': 1.5095916e+09, 'filename': 'MedNAF/6-crude-flows_MedNAF.bin', 'min_epoch': 1.4953752e+09}];
        var crude_flows_index_Urals = [{'max_epoch': 1.3944883e+09, 'filename': 'Urals/0-crude-flows_Urals.bin', 'min_epoch': 1.3512047e+09}, {'max_epoch': 1.435146e+09, 'filename': 'Urals/1-crude-flows_Urals.bin', 'min_epoch': 1.3944666e+09}, {'max_epoch': 1.47633e+09, 'filename': 'Urals/2-crude-flows_Urals.bin', 'min_epoch': 1.4350828e+09}, {'max_epoch': 1.5092532e+09, 'filename': 'Urals/3-crude-flows_Urals.bin', 'min_epoch': 1.4763123e+09}];
        var crude_flows_index_USGC = [{'max_epoch': 1.5122628e+09, 'filename': 'USGC/0-crude-flows_USGC.bin', 'min_epoch': 1.3621992e+09}];
        var crude_flows_index_LatAM = [{'max_epoch': 1.3680512e+09, 'filename': 'LatAM/0-crude-flows_LatAM.bin', 'min_epoch': 1.3474893e+09}, {'max_epoch': 1.3785563e+09, 'filename': 'LatAM/1-crude-flows_LatAM.bin', 'min_epoch': 1.3666175e+09}, {'max_epoch': 1.3898134e+09, 'filename': 'LatAM/2-crude-flows_LatAM.bin', 'min_epoch': 1.3767935e+09}, {'max_epoch': 1.4000607e+09, 'filename': 'LatAM/3-crude-flows_LatAM.bin', 'min_epoch': 1.3878431e+09}, {'max_epoch': 1.4103395e+09, 'filename': 'LatAM/4-crude-flows_LatAM.bin', 'min_epoch': 1.3986446e+09}, {'max_epoch': 1.4202254e+09, 'filename': 'LatAM/5-crude-flows_LatAM.bin', 'min_epoch': 1.408922e+09}, {'max_epoch': 1.43073e+09, 'filename': 'LatAM/6-crude-flows_LatAM.bin', 'min_epoch': 1.4186223e+09}, {'max_epoch': 1.4399827e+09, 'filename': 'LatAM/7-crude-flows_LatAM.bin', 'min_epoch': 1.4289676e+09}, {'max_epoch': 1.4490721e+09, 'filename': 'LatAM/8-crude-flows_LatAM.bin', 'min_epoch': 1.4386007e+09}, {'max_epoch': 1.4587574e+09, 'filename': 'LatAM/9-crude-flows_LatAM.bin', 'min_epoch': 1.4481128e+09}, {'max_epoch': 1.4689476e+09, 'filename': 'LatAM/10-crude-flows_LatAM.bin', 'min_epoch': 1.4563868e+09}, {'max_epoch': 1.4796142e+09, 'filename': 'LatAM/11-crude-flows_LatAM.bin', 'min_epoch': 1.4676618e+09}, {'max_epoch': 1.4914527e+09, 'filename': 'LatAM/12-crude-flows_LatAM.bin', 'min_epoch': 1.4776771e+09}, {'max_epoch': 1.5010688e+09, 'filename': 'LatAM/13-crude-flows_LatAM.bin', 'min_epoch': 1.4883502e+09}, {'max_epoch': 1.511766e+09, 'filename': 'LatAM/14-crude-flows_LatAM.bin', 'min_epoch': 1.498359e+09}];
        var crude_flows_index_NS = [{'max_epoch': 1.4191127e+09, 'filename': 'NS/0-crude-flows_NS.bin', 'min_epoch': 1.3472122e+09}, {'max_epoch': 1.4766056e+09, 'filename': 'NS/1-crude-flows_NS.bin', 'min_epoch': 1.4182052e+09}, {'max_epoch': 1.5126084e+09, 'filename': 'NS/2-crude-flows_NS.bin', 'min_epoch': 1.4763096e+09}];

        /** START Oceania LAYER */
        function showIndexOceania(idx, epoch) {
          return crude_flows_index_Oceania[idx]['min_epoch'] < epoch && crude_flows_index_Oceania[idx]['max_epoch'] > epoch;
        }

        if (showSpCrudeLayerOceania) {
          var layer = spCrudeLayerOceania;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          var currentEpoch = currentDate/1000.;
          for (var i = 0; i < crude_flows_index_Oceania.length; i++) {
            if (showIndexOceania(i, currentEpoch)) {
              if (typeof spCrudeLayerOceania.buffers[i] == "undefined") {
                spCrudeLayerOceania.buffers[i] = {
                  "numAttributes": 7,
                  "count": 0,
                  "buffer": null,
                  "ready": false
                };

                var dataUrl = rootTilePath + '/sp-crude/' + crude_flows_index_Oceania[i]["filename"];
                shipsWorkerOceania.postMessage({'idx': i, 'url': dataUrl});
              }
              options.idx = i;
              options.buffers = spCrudeLayerOceania.buffers;
              layer.draw(view, options);
            }
          }
        }
        /** END Oceania LAYER */


        /** START AG LAYER */
        function showIndexAG(idx, epoch) {
          return crude_flows_index_AG[idx]['min_epoch'] < epoch && crude_flows_index_AG[idx]['max_epoch'] > epoch;
        }

        if (showSpCrudeLayerAG) {
          var layer = spCrudeLayerAG;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          var currentEpoch = currentDate/1000.;
          for (var i = 0; i < crude_flows_index_AG.length; i++) {
            if (showIndexAG(i, currentEpoch)) {
              if (typeof spCrudeLayerAG.buffers[i] == "undefined") {
                spCrudeLayerAG.buffers[i] = {
                  "numAttributes": 7,
                  "count": 0,
                  "buffer": null,
                  "ready": false
                };

                var dataUrl = rootTilePath + '/sp-crude/' + crude_flows_index_AG[i]["filename"];
                shipsWorkerAG.postMessage({'idx': i, 'url': dataUrl});
              }
              options.idx = i;
              options.buffers = spCrudeLayerAG.buffers;
              layer.draw(view, options);
            }
          }
        }
        /** END AG LAYER */


        /** START WAF LAYER */
        function showIndexWAF(idx, epoch) {
          return crude_flows_index_WAF[idx]['min_epoch'] < epoch && crude_flows_index_WAF[idx]['max_epoch'] > epoch;
        }

        if (showSpCrudeLayerWAF) {
          var layer = spCrudeLayerWAF;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          var currentEpoch = currentDate/1000.;
          for (var i = 0; i < crude_flows_index_WAF.length; i++) {
            if (showIndexWAF(i, currentEpoch)) {
              if (typeof spCrudeLayerWAF.buffers[i] == "undefined") {
                spCrudeLayerWAF.buffers[i] = {
                  "numAttributes": 7,
                  "count": 0,
                  "buffer": null,
                  "ready": false
                };

                var dataUrl = rootTilePath + '/sp-crude/' + crude_flows_index_WAF[i]["filename"];
                shipsWorkerWAF.postMessage({'idx': i, 'url': dataUrl});
              }
              options.idx = i;
              options.buffers = spCrudeLayerWAF.buffers;
              layer.draw(view, options);
            }
          }
        }
        /** END WAF LAYER */


        /** START MedNAF LAYER */
        function showIndexMedNAF(idx, epoch) {
          return crude_flows_index_MedNAF[idx]['min_epoch'] < epoch && crude_flows_index_MedNAF[idx]['max_epoch'] > epoch;
        }

        if (showSpCrudeLayerMedNAF) {
          var layer = spCrudeLayerMedNAF;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          var currentEpoch = currentDate/1000.;
          for (var i = 0; i < crude_flows_index_MedNAF.length; i++) {
            if (showIndexMedNAF(i, currentEpoch)) {
              if (typeof spCrudeLayerMedNAF.buffers[i] == "undefined") {
                spCrudeLayerMedNAF.buffers[i] = {
                  "numAttributes": 7,
                  "count": 0,
                  "buffer": null,
                  "ready": false
                };

                var dataUrl = rootTilePath + '/sp-crude/' + crude_flows_index_MedNAF[i]["filename"];
                shipsWorkerMedNAF.postMessage({'idx': i, 'url': dataUrl});
              }
              options.idx = i;
              options.buffers = spCrudeLayerMedNAF.buffers;
              layer.draw(view, options);
            }
          }
        }
        /** END MedNAF LAYER */


        /** START Urals LAYER */
        function showIndexUrals(idx, epoch) {
          return crude_flows_index_Urals[idx]['min_epoch'] < epoch && crude_flows_index_Urals[idx]['max_epoch'] > epoch;
        }

        if (showSpCrudeLayerUrals) {
          var layer = spCrudeLayerUrals;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          var currentEpoch = currentDate/1000.;
          for (var i = 0; i < crude_flows_index_Urals.length; i++) {
            if (showIndexUrals(i, currentEpoch)) {
              if (typeof spCrudeLayerUrals.buffers[i] == "undefined") {
                spCrudeLayerUrals.buffers[i] = {
                  "numAttributes": 7,
                  "count": 0,
                  "buffer": null,
                  "ready": false
                };

                var dataUrl = rootTilePath + '/sp-crude/' + crude_flows_index_Urals[i]["filename"];
                shipsWorkerUrals.postMessage({'idx': i, 'url': dataUrl});
              }
              options.idx = i;
              options.buffers = spCrudeLayerUrals.buffers;
              layer.draw(view, options);
            }
          }
        }
        /** END Urals LAYER */


        /** START USGC LAYER */
        function showIndexUSGC(idx, epoch) {
          return crude_flows_index_USGC[idx]['min_epoch'] < epoch && crude_flows_index_USGC[idx]['max_epoch'] > epoch;
        }

        if (showSpCrudeLayerUSGC) {
          var layer = spCrudeLayerUSGC;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          var currentEpoch = currentDate/1000.;
          for (var i = 0; i < crude_flows_index_USGC.length; i++) {
            if (showIndexUSGC(i, currentEpoch)) {
              if (typeof spCrudeLayerUSGC.buffers[i] == "undefined") {
                spCrudeLayerUSGC.buffers[i] = {
                  "numAttributes": 7,
                  "count": 0,
                  "buffer": null,
                  "ready": false
                };

                var dataUrl = rootTilePath + '/sp-crude/' + crude_flows_index_USGC[i]["filename"];
                shipsWorkerUSGC.postMessage({'idx': i, 'url': dataUrl});
              }
              options.idx = i;
              options.buffers = spCrudeLayerUSGC.buffers;
              layer.draw(view, options);
            }
          }
        }
        /** END USGC LAYER */


        /** START LatAM LAYER */
        function showIndexLatAM(idx, epoch) {
          return crude_flows_index_LatAM[idx]['min_epoch'] < epoch && crude_flows_index_LatAM[idx]['max_epoch'] > epoch;
        }

        if (showSpCrudeLayerLatAM) {
          var layer = spCrudeLayerLatAM;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          var currentEpoch = currentDate/1000.;
          for (var i = 0; i < crude_flows_index_LatAM.length; i++) {
            if (showIndexLatAM(i, currentEpoch)) {
              if (typeof spCrudeLayerLatAM.buffers[i] == "undefined") {
                spCrudeLayerLatAM.buffers[i] = {
                  "numAttributes": 7,
                  "count": 0,
                  "buffer": null,
                  "ready": false
                };

                var dataUrl = rootTilePath + '/sp-crude/' + crude_flows_index_LatAM[i]["filename"];
                shipsWorkerLatAM.postMessage({'idx': i, 'url': dataUrl});
              }
              options.idx = i;
              options.buffers = spCrudeLayerLatAM.buffers;
              layer.draw(view, options);
            }
          }
        }
        /** END LatAM LAYER */


        /** START NS LAYER */
        function showIndexNS(idx, epoch) {
          return crude_flows_index_NS[idx]['min_epoch'] < epoch && crude_flows_index_NS[idx]['max_epoch'] > epoch;
        }

        if (showSpCrudeLayerNS) {
          var layer = spCrudeLayerNS;
          var view = getLayerView(layer, landsatBaseMapLayer);
          var options = {};
          options.zoom = timelapse.getCurrentZoom();
          var currentTime = timelapse.getCurrentTime();
          var currentTimes = getCurrentTimes(timelapse);
          var dates = getDates(timelapse);
          var delta = getCurrentTimesDelta(currentTime, currentTimes);
          var currentDate = getCurrentDate(currentTime, currentTimes, dates);
          options.currentTime = currentDate;
          options.pointSize = 2.;
          options.color = [0.5,0.05,0.5,1.0];
          var currentEpoch = currentDate/1000.;
          for (var i = 0; i < crude_flows_index_NS.length; i++) {
            if (showIndexNS(i, currentEpoch)) {
              if (typeof spCrudeLayerNS.buffers[i] == "undefined") {
                spCrudeLayerNS.buffers[i] = {
                  "numAttributes": 7,
                  "count": 0,
                  "buffer": null,
                  "ready": false
                };

                var dataUrl = rootTilePath + '/sp-crude/' + crude_flows_index_NS[i]["filename"];
                shipsWorkerNS.postMessage({'idx': i, 'url': dataUrl});
              }
              options.idx = i;
              options.buffers = spCrudeLayerNS.buffers;
              layer.draw(view, options);
            }
          }
        }
        /** END NS LAYER */

        // END LAYER DRAWS
      }
    }
  </script>

  <script>
    "use strict";
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    // Write to local storage since cookies cannot be used on file://
    // allowLinker is for crossdomain (the tracking domain is different from where we are sending from)
    ga('create', trackingId, 'auto', {
      'allowLinker': true,
      'storage': 'none',
      'clientId': localStorage.getItem('gaClientId')
    });
    ga(function(t) {
      localStorage.setItem('gaClientId', t.get('clientId'));
    });
    ga('set', 'checkProtocolTask', null); // Disable file protocol checking.
    ga('send', 'pageview');
  </script>
</head>

<body>
  <div id="letterbox-content" class="unselectable">
    <div id="letterbox-main"></div>
    <div id="letterbox-bottom">
      <table id="letterbox-bottom-controls-container">
        <tr>
          <td id="letterbox-bottom-controls" width="20%">
          <div id="letterbox-base-layers"></div>
          <div id="letterbox-control-buttons">
            <button type="button" id="letterbox-list-themes-button">Themes</button><br/>
            <button type="button" id="letterbox-list-layers-button">Layers</button><br/>
            <button type="button" id="letterbox-clear-layers-button">Clear Layers</button>
          </div>
          </td>
          <td id="letterbox-bottom-picker" width="40%">
            <div id="letterbox-bottom-picker-content-wrapper">
              <div id="letterbox-bottom-picker-content">
              </div>
            </div>
          </td>
          <td id="letterbox-bottom-picker-results" width="40%">
            <div id="letterbox-bottom-picker-results-content-wrapper">
              <div id="letterbox-bottom-picker-results-content">
              </div>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <div id="timeMachine"></div>
  <div class="annotations-resume-exit-container unselectable">
    <table>
      <tr>
        <td class="annotations-resume-button">Resume Story</td>
        <td class="annotations-button-separator"></td>
        <td class="annotations-exit-button">Exit Story</td>
      </tr>
    </table>
  </div>
  <div class="current-location-text-container unselectable">
    <div class="previous-annotation-location annotation-nav" title="Previous story"></div>
    <div class="current-location-text">
      <div class="current-location-text-title"></div>
      <div id="current-location-text-picture"></div>
      <p></p>
    </div>
    <div class="next-annotation-location annotation-nav" title="Next story"></div>
  </div>
  <div id="extras-content" title=""></div>
  <div id="logosContainer" class="unselectable">
    <div id="productLogo">EarthTime</div>
    <div id="contributors">CMU CREATE Lab</div>
  </div>
  <div id="baseLayerCreditContainer" class="unselectable">
    <table>
    <tr>
      <td id="baselayerCreditHeader">Base Layer</td>
      <td id="baselayerCreditText">&copy; Google</td>
      <td id="baselayerCreditLogoContainer">
        <div id="baselayerCreditLogo"></div>
      </td>
    </tr>
    </table>
  </div>
  <div id="main-hamburger-menu" class="menu">
    <ul class="accordion-menu">
      <li id="theme-menu" class="has-children">
        <input type="radio" name="main-hamburger-selection" id="theme-selection" class="main-hamburger-selection">
        <label for="theme-selection" class="selection-heading">Themes</label>
        <ul id="theme-list"></ul>
      </li>
      <li id="layers-menu" class="has-children">
        <input type="radio" name="main-hamburger-selection" id="layer-selection" class="main-hamburger-selection">
        <label for="layer-selection" class="selection-heading">Layers</label>
      </li>
    </ul>
  </div>
  <div id="presentation-slider-hamburger-wrapper">
    <button class="hamburger" type="button" title="More">
      <span class="hamburger-box">
        <span class="hamburger-inner"></span>
      </span>
    </button>
    <div id="theme-title-container" title="Select a theme">
      <div id="theme-title"></div>
    </div>
  </div>
  <div id="csvChartContainer"></div>
  <div id="csvChartLegend">
    <ul id="csvChartLegendList"></ul>
  </div>
  <div id="browser_not_supported">
    <div class="warning">Sorry, but it looks like your system is not currently supported by EarthTime.
      <br><br>At this time, we support systems with WebGL enabled and running recent desktop and mobile browser versions of
      <a href="http://www.google.com/chrome">Chrome</a>,
      <a href="http://www.apple.com/safari/">Safari</a>,
      <a href="http://www.firefox.com">Firefox</a> and
      <a href="http://windows.microsoft.com/en-us/internet-explorer/download-ie">Internet Explorer / Microsoft Edge</a>.
      <br><br>If you have questions, please email us at: <a href="mailto:earthtime@cmucreatelab.org?Subject=EarthTime%20Questions" target="_top">earthtime@cmucreatelab.org</a>
    </div>
  </div>
</body>

</html>

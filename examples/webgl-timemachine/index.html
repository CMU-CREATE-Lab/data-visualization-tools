<!DOCTYPE html>
<html>
  <head>
    <title>Earth Timelapse</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <link href="../../timemachine/css/snaplapse.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/defaultUI.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/contextMap.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/scaleBar.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/customUI.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/leaflet/leaflet.css" rel="stylesheet" type="text/css"/>
    <link href="../../js/customVideoTagControls/customVideoTagControls.css" rel="stylesheet" type="text/css"/>

    <script src="../../timemachine/js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/util.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
    <script src="../../timemachine/js/Math.uuid.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/scaleBar.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/contextMap.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/customUI.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>
    <script src="../../timemachine/template_includes.js" type="text/javascript"></script>
    <script src="../../timemachine/js/leaflet/leaflet.min.js" type="text/javascript" ></script>
    <script src="../../js/customVideoTagControls/customVideoTagControls.js" type="text/javascript"></script>
    <script src="landsat_ajax_includes2.js" type="text/javascript"></script>
    <script src="../../../../config.js" type="text/javascript"></script>

    <script src="TileIdx.js"></script>
    <script src="WebglVideoTile.js"></script>
    <script src="TileView.js"></script>
    <script src="Glb.js"></script>
    <script src="WebglTimeMachineLayer.js"></script>
    <script src="WebglMapLayer.js"></script>
    <script src="WebglVectorLayer.js"></script>
    <script src="WebglVectorLayer2.js"></script>
    <script src="WebglTimeMachinePerf.js"></script>
    <script src="WebGLVectorTile.js"></script>
    <script src="WebGLVectorTile2.js"></script>
    <script src="WebglMapTile.js"></script>
    <script src="WebglViirsTile.js"></script>
    <script src="WebglCoralTile.js"></script>

    <style>
      #timeMachine {
        position: absolute;
        overflow: hidden;
        width: 100%;
        height: 100%;
      }
      #timeMachine.letterbox {
        overflow: hidden;
        position: relative;
        width: 1920px;
        height: 768px;
      }
      .player {
        left: -2px !important;
        right: -2px !important;
        top: -2px !important;
        z-index: 0;
      }
      .snaplapse_keyframe_list {
        height: 84px !important;
      }
      .snaplapse_keyframe_list_item_thumbnail_overlay_presentation {
        height: 77px !important;
      }
      .snaplapse_keyframe_container {
        top: -7px !important;
        left: 0px !important;
        width: 100% !important;
      }
      .snaplapse_keyframe_list_item_presentation {
        height: 82px !important;
      }
      .snaplapse_keyframe_container.hyperwall {
        top: 0px !important;
        left: -1px !important;
        right: -1px !important;
        overflow-x: hidden !important;
        background-color: black !important;
      }
      .keyframeSubtitleBoxForHovering.hyperwall {
        bottom: 131px !important;
        font-size: 20px;
        line-height: 29px;
        color: rgb(60, 60, 60);
      }
      .snaplapse_keyframe_list_item_presentation.hyperwall {
        width: 147px !important;
        height: 101px !important;
      }
      .snaplapse_keyframe_list_item_thumbnail_overlay_presentation.hyperwall {
        width: 140px !important;
        height: 95px !important;
      }
      .keyframeSubtitleBoxForHovering.hyperwall p {
        max-width: 550px;
        padding-top: 18px;
        padding-bottom: 26px;
        padding-left: 27px;
        padding-right: 27px;
      }
      #legend {
        font-size: 30px;
        margin-left: 6px;
        border-bottom: 1px solid #656565;
        padding-bottom: 6px;
      }
      .legendColor {
        width: 22px;
        height: 22px;
        margin-bottom: 4px;
      }
      .legendTitle {
        margin-left: 7px;
        margin-bottom: 4px;
        color: #656565;
      }
      #logoUrl {
        position: absolute;
        font-size: 40px;
        text-shadow: -1px 0 #000, 0 1px #000, 1px 0 #000, 0 -1px #000, 2px 2px 3px rgba(0, 0, 0, 0.3);
        font-family: Arial, Helvetica, sans-serif;
        color: white;
        font-weight: normal;
        z-index: 50;
        left: 92px;
        top: 18px;
      }
      ::-webkit-input-placeholder {
        color: rgba(50,50,50,1.0);
      }
      .ui-widget-header {
        height: 20px;
      }
      .ui-menu-item {
        font-size: 14px;
        padding-left: 10px !important;
        padding-right: 10px !important;
        padding-top: 5px !important;
        padding-bottom: 5px !important;
        background-image: none !important;
      }
      .ui-dialog-titlebar-close {
        width: 25px !important;
        height: 25px !important;
        top: 12px !important;
        background: #EFEFEF !important;
      }
      .ui-selectmenu-button {
        margin-left: 3px;
        font-size: 14px !important;
        background: #EFEFEF !important;
        height: 29px !important;
        border-radius: 2px;
      }
      .ui-selectmenu-button span.ui-selectmenu-text {
        padding-left: 10px !important;
        padding-right: 10px !important;
        padding-top: 5px !important;
        padding-bottom: 5px !important;
      }
      .customHelpLabel-touchFriendly.ui-button {
        top: -26px;
      }
      .presentationSlider.hyperwall {
        top: auto !important;
        bottom: -17px;
        height: 120px !important;
      }
      .presentationSlider.hyperwall.letterbox {
        top: auto !important;
        -ms-transform: scale(1.5,1.5);
        -webkit-transform: scale(1.5,1.5);
        transform: scale(1.5,1.5);
        bottom: 5px !important;
      }
      .snaplapse_keyframe_list_item_thumbnail {
        height: 82px !important;
      }
      .extras-content-video {
        position: absolute !important;
        top: 0px !important;
        left: 0px !important;
        bottom: 0px !important;
        right: 0px !important;
        height: auto !important;
        width: auto !important;
      }
      #extras-content {
        display: none;
        padding: 0;
        margin: 0;
        overflow: hidden;
        position: absolute !important;
        top: 35px !important;
        left: 0px !important;
        right: 0px !important;
        bottom: 0px !important;
        width: auto !important;
        height: auto !important;
      }
      .ghinda-video-player {
        width: 100% !important;
        height: 100% !important;
      }
      #extras-video {
        width: 100% !important;
        height: 100% !important;
      }
      .ui-selectmenu-menu {
        border-bottom-right-radius: 2px;
        border-bottom-left-radius: 2px;
      }
      .top-panel {
        background: black;
        border: 0px solid black;
        border-radius: 0px;
        outline: none;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 19px;
        padding: 0;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        white-space: nowrap;
      }
      label .credit {
        color: #555555;
        font-size: 14px;
        position: relative;
        top: -1px;
        right: -4px;
      }
      label input[type='radio'], label input[type='checkbox'] {
        position: relative;
        width: 17px;
        height: 17px;
        top: 1px;
        margin-right: 6px;
        margin-left: 0;
        margin-top: 0;
        margin-bottom: 0;
        padding: 0;
        cursor: pointer;
      }
      label {
        cursor: pointer;
        color: black;
        display: block;
        margin-right: 0;
        margin-top: -3px;
        margin-left: -3px;
        margin-bottom: 0;
        padding-top: 15px;
        padding-bottom: 10px;
        padding-left: 15px;
        padding-right: 15px;
      }
      .top-panel label {
        border: 1px solid black;
        color: white;
      }
      .top-panel label .credit {
        color: #A1A1A1;
      }
      .map-layer-div.letterbox {
        width: 746px;
        height: 152px;
        position: absolute;
        right: 0px;
        bottom: auto;
        top: 0px;
      }
      .map-layer-checkbox.letterbox {
        position: relative;
        top: 7px;
        left: 4px;
      }
      .base-map-div.letterbox {
        width: 342px;
        height: 152px;
        position: absolute;
        left: 345px;
        bottom: auto;
        top: 0px;
      }
      .base-map-radio.letterbox {
        position: relative;
        top: 7px;
        left: 4px;
      }
      .extras-selector-div {
        padding: 10px;
      }
      .extras-selector-div.letterbox {
        position: absolute;
        left: 0px;
        top: 78px;
        width: 342px;
        height: 74px;
        padding: 0;
      }
      .extras-selector-div.letterbox .ui-selectmenu-button {
        position: relative;
        top: 14px;
        left: 20px;
        width: 300px !important;
        outline: none;
      }
      #location_search {
        position: absolute;
        top: 23px;
        left: 230px;
        width: 280px;
        padding-bottom: 11px;
        padding-top: 12px;
        padding-left: 15px;
        padding-right: 15px;
        background: rgba(255,255,255,1);
        margin-left: -140px;
        border: 1px solid #656565;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 17px;
        height: 13px;
        outline: none;
        border-radius: 3px;
        box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
        z-index: 100;
      }
      .location_search_div.letterbox {
        width: 342px;
        position: absolute;
        left: 0px;
        bottom: auto;
        top: 0px;
        height: 74px;
      }
      #location_search.letterbox {
        position: relative;
        top: 32px;
        left: 23px;
        width: 280px;
        margin: 0;
        padding-bottom: 7px;
        padding-top: 7px;
        padding-left: 10px;
        padding-right: 10px;
        box-shadow: 0px 0px 0px rgba(0,0,0,0);
      }
      .vector-layers.right-panel.hyperwall {
        bottom: 250px !important;
      }
      .vector-layers.right-panel {
        position: absolute;
        bottom: 215px;
        right: 20px;
        width: 315px;
        padding: 10px;
        background: white;
        border-radius: 2px;
        border: 1px solid #656565;
        box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
        outline: none;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 19px;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        white-space: nowrap;
      }
      #letterbox-top {
        position: relative;
        width: 100%;
        top: 0px;
        left: 0px;
        height: 156px;
        background: black;
      }
      #letterbox-bottom {
        position: relative;
        width: 100%;
        bottom: 0px;
        left: 0px;
        height: 156px;
        background: black;
      }
      .customToggleSpeed-touchFriendly.ui-button {
        height: 30px;
      }
    </style>
    <script type="text/javascript">
      "use strict";

      jQuery.support.cors = true;

      var landsatBaseMapLayer, timelapse, darkBaseMapLayer, lightBaseMapLayer, wdpaVectorLayer, mcrmVectorLayer, hansonMapLayer, hansonMapLayer2, viirsTile, coralBleachingTile, lightsAtNightMapLayer;

      //// Config ////
      var EARTH_TIMELAPSE_CONFIG = EARTH_TIMELAPSE_CONFIG || {};

      var presentationSliderContent = EARTH_TIMELAPSE_CONFIG.waypointCollection || "http://timemachine.cmucreatelab.org/wiki/EarthEngineTourEditor#presentation=EsBDkDV0jvjsXrchC_Climate%20Change_DkDPWPyXs9wR6gBAmazon%20Deforestation%20in%20Rondonia_Rondonia_DkDNnM4bRHuqojB_N%20Sumatra_DkDQhV1kUKXaiD_Fires%20at%20night_DkDFWaNbFlEeqJ_Agricultural%20fires_DkDASzGiNIcpvK_Agricultural%20fires_DkDIAHUl1q2eqJ_Drilling%20fires_DkDSx-Tmy5yMmK_Shale%20oil%20extraction_DkDRFMpUtEFyje_Eagle%20Downs%20Coal_DkDOHcDnYDBPjgB_Mountaintop%20Removal_DkDWlMmn4Acs_iB_Hei%20Dai%20Gao%20coal_DkDcYs5sY3cKrZ_Alberta%20Tar%20Sands_DkDA8sGufoBFqe_Columbia%20Glacier_DkDNROTtit7GojB_Mendenhall%20Glacier_DkDFGq9mKcYi8VThe%20shrinking%20and%20drying%20up%20of%20the%20Lake%20Urmia_Lake%20Urmia_DkDOcGQprwpkmRThe%20shrinking%20of%20the%20Aral%20Sea%20destroys%20fishing%20industry%20and%20brings%20unemployment%20and%20public%20health%20problems_Aral%20Sea_DkDSq1joU5sk6gBThe%20expansion%20of%20irrigation%20systems%20near%20the%20Aral%20Sea_Aral%20Expansion_CkDWmblQtbBxuXBushfires%20in%20Australia%20are%20frequent%20during%20the%20hotter%20months%20of%20the%20year_Australia%20Bushfire_DkDblXvnAWJL2V_Bark%20Beetles_DkDV0jvjsXrchC_Asia%20Growth_DkDX2whibLvsof3rd%20largest%20city%20in%20China%2E%20Population%20doubled%20since%202001%2E_Guangzhou_DkDQ5wYitp3subShenzhen%20bay%2C%20growth%20of%20land%20use%20into%20bay%2E_Shenzhen_DkDcABUmLtywojBHaneda%20Airport%3A%20Now%20second%20busiest%20airport%20in%20Asia%2E_Tokyo-Yokohama_DkDP4t6mgw0u7c_Seoul_DkDFkV8lWccJ9X_Los%20Angeles_DkDFWDcc0I-q_a_Kuala%20Lumpur_DkDWhO8nm0KbkD_Resources%20and%20Forest_DkDE2DoXNG6QofPeru%20artisanal%20gold%20mining%2E_Peru_DkDXJ22s_hcKuYTar%20sands%20in%20Alberta%2E_Alberta%2C%20Canada_DkDVPdDamRWw7cGrasberg%20mine%20tailings%2E_Papua%2C%20Indonesia_DkDQmpkWZR9RsbChaco%20clearing%20for%20agriculture%2E_Bolivia_DkDXjdRU4GNy9fCoal%20mining%2E_Queensland%20_DkDWscKjT05j_f_Dubai_DkDbiakl-OnMkgBGas%20pads%2E_Dallas%E2%80%93Fort%20Worth_DkDUmY_oLtXLkgBPowder%20River%20Basin%20coal%20mining%2E_Wyoming_DkDWOO2mpaxOoeMountaintop%20removal%20mining%2E_Kentucky_DkDV0jvjsXrchC_Other%20changes_DkDVUU_kfEAu_cUrban%20expansion%20in%20Shanghai%2C%20China%2E_Shanghai_BkDTiTRWWTmR6gBRiver%20meandering%20in%20the%20Amazon_Meander_DkDK9ySWib2R2dThe%20abandonment%20of%20a%20river%20channel%20and%20the%20formation%20of%20a%20new%20river%20channel_Bolivia%20Avulsion_DkDcOeLoWayQ6gBThe%20Cape%20and%20islands%20are%20subject%20to%20massive%20coastal%20erosion_South%20Cape%20Cod_BkDPt3KmUZ3P6gBThe%20Outer%20Banks%20often%20suffers%20significant%20beach%20erosion%20during%20storms_Outer%20Banks%20NC_BkDcM7nkdxUhgZCenter-pivot%20irrigation%20irrigates%20crops%20with%20sprinklers%20centered%20on%20the%20pivot%2C%20creating%20a%20green%20circular%20pattern_Saudi%20Irrigation_DkDWZuFgTJ1tycThe%20eruption%20of%20Mount%20Pinatubo%20on%20June%2015%2C%201991_Pinatubo_Untitled_B";
      var showEVA = !!EARTH_TIMELAPSE_CONFIG.showEVA;
      var isHyperwall = !!EARTH_TIMELAPSE_CONFIG.isHyperwall;
      var useGoogleMaps = !!EARTH_TIMELAPSE_CONFIG.useGoogleMaps;
      var enableAutoMode = !!EARTH_TIMELAPSE_CONFIG.enableAutoMode;
      var screenTimeoutInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.screenTimeoutInMilliseconds) || 8 * 60 * 1000;
      var waypointDelayInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.waypointDelayInMilliseconds) || 1 * 15 * 1000;
      var defaultPlaybackSpeed = parseFloat(EARTH_TIMELAPSE_CONFIG.defaultPlaybackSpeed) || 0.5;
      var enableLetterboxMode = !!EARTH_TIMELAPSE_CONFIG.enableLetterboxMode || false;
      var useFaderShader = !!EARTH_TIMELAPSE_CONFIG.useFaderShader || false;

      // Set shader
      WebglVideoTile.useFaderShader = useFaderShader;

      //// Context Map Tiles ////
      var osmDefaultUrl = "../../../data/openstreetmap/default/";

      //// Video Tiles
      var landsatUrl = "../../../data/landsat-annual-2015-v1/1068x600";
      // Using "https" will casue the thumbnail loading from the server to fail
      //var landsatUrl = "http://earthengine.google.org/timelapse/data/20130507";

      //// Map Tiles ////
      // OpenStreetMap/CartoDB
      var osmLightRetinaUrl = "../../../data/openstreetmap/light_all_retina/{default}/{z}/{x}/{y}.png";
      var osmDarkRetinaUrl = "../../../data/openstreetmap/dark_all_retina/{default}/{z}/{x}/{y}.png";
      // Global Forest Change (Matt Hansen)
      var gfcTransUrl = "../../../data/global-forest-change/loss_year_transparent/{default}/{z}/{x}/{y}.png";
      var gfcLossGainUrl = "../../../data/global-forest-change/loss_tree_gain/{default}/{z}/{x}/{y}.png";
      // Google Maps non-retina
      var googleMapsDefaultUrl = "https://mts0.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0";
      var googleMapsDarkStyleUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0";
      // Google Maps retina
      var googleMapsDefaultRetinaUrl = "https://mts1.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0!5m1!5f2";
      var googleMapsDarkStyleRetinaUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0!5m1!5f2";
      // Lights At Night
      var lightsAtNightUrl = "../../../data/lights-at-night/{default}/{z}/{x}/{y}.png";

      //// Vector Tiles ////
      var wdpaUrl = "../../../data/wdpaline-year";
      var mcrmUrl = "../../../data/coral/mcrm-lines-wrapdateline";
      var viirsUrl = '../../../data/viirs/createlab-viirs-uncorrected-20140314-20150403.bin';
      var coralBleachingUrl = "../../../data/coral/bleaching_reports_4km_81-10.bin";

      var visibleBaseMapLayer = "landsat";

      function init() {
        var settings = {
          playbackSpeed: defaultPlaybackSpeed,
          viewerType: "webgl",
          url: landsatUrl,
          enablePresentationSlider: true,
          thumbnailServerRootTileUrl: "http://earthengine.google.org/timelapse/data/20130507",
          showFullScreenBtn: false,
          presentationSliderSettings: {
            onLoadAnimation: "none",
            playAfterAnimation: false,
            initialWaypointIndex: 0,
            doAutoMode: enableAutoMode,
            showAnnotations: false,
            screenIdleTime: screenTimeoutInMilliseconds,
            waypointDelayTime: waypointDelayInMilliseconds
          },
          useTouchFriendlyUI: isHyperwall,
          datasetType: "landsat",
          playOnLoad: true,
          mediaType: ".mp4",
          onTimeMachinePlayerReady: function(viewerDivId) {},
          scaleBarOptions: {
            scaleBarDiv: "scaleBar1"
          },
          thumbnailUrlList: ["thumbnails/climate-change.jpg", "thumbnails/rondonia.jpg",
                             "thumbnails/n-sumatra.jpg", "thumbnails/fires-at-night.jpg",
                             "thumbnails/agricultural-fires.jpg", "thumbnails/agricultural-fires2.jpg",
                             "thumbnails/drilling-fires.jpg", "thumbnails/shale-oil-extraction.jpg",
                             "thumbnails/eagle-downs-coal.jpg", "thumbnails/mountaintop-removal.jpg",
                             "thumbnails/hei-dai-gao-coal.jpg", "thumbnails/alberta-tar-sands.jpg",
                             "thumbnails/columbia-glacier.jpg", "thumbnails/mendenhall-glacier.jpg",
                             "thumbnails/lake-urmia.jpg", "thumbnails/aral-sea.jpg",
                             "thumbnails/aral-expansion.jpg", "thumbnails/australia-bushfire.jpg",
                             "thumbnails/bark-beetles.jpg", "thumbnails/asia-growth.jpg",
                             "thumbnails/guangzhou.jpg", "thumbnails/shenzhen.jpg",
                             "thumbnails/tokyo-yokohama.jpg", "thumbnails/seoul.jpg",
                             "thumbnails/los-angeles.jpg", "thumbnails/kuala-lumpur.jpg",
                             "thumbnails/resources-and-forest.jpg", "thumbnails/peru.jpg",
                             "thumbnails/alberta-canada.jpg", "thumbnails/papua-indonesia.jpg",
                             "thumbnails/bolivia.jpg", "thumbnails/queensland.jpg",
                             "thumbnails/dubai.jpg", "thumbnails/dallas-fort-worth.jpg",
                             "thumbnails/wyoming.jpg", "thumbnails/kentucky.jpg",
                             "thumbnails/other-changes.jpg", "thumbnails/shanghai.jpg",
                             "thumbnails/meander.jpg", "thumbnails/bolivia-avulsion.jpg",
                             "thumbnails/south-cape-cod.jpg", "thumbnails/outer-banks-nc.jpg",
                             "thumbnails/saudi-irrigation.jpg", "thumbnails/pinatubo.jpg"],
          contextMapOptions: {
            contextMapDiv: "contextMap1",
            tileType: useGoogleMaps ? "Google" : "OpenStreetMap",
            tileUrl: osmDefaultUrl,
            geometry: {
              width: 270,
              height: 200
            }
          }
        };

        if(enableLetterboxMode) {
          $("#timeMachine").appendTo($("#letterbox-middle"));
          $("#timeMachine").addClass("letterbox");
        } else {
          $("#content").remove();
        }

        timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", settings);
        onTimeMachinePlayerReady();

        //document.body.appendChild( stats.domElement );
        //$(stats.domElement).css('z-index', 1000);

        perf = new WebglTimeMachinePerf(document.getElementById('stats'), timelapse);
        $('#stats').hide();
        /*$(document).keypress(function(e) {
          // ctrl-a toggles perf
          if (e.keyCode == 1) {
            $('#stats').toggle();
          }
        });*/
      }

      $(init);

      function googleMapsLoadedCallback() {
        if (useGoogleMaps) {
          var autocomplete = new google.maps.places.Autocomplete($("#location_search").get(0));
          var geocoder = new google.maps.Geocoder();

          google.maps.event.addListener(autocomplete, 'place_changed', function() {
            var place = autocomplete.getPlace();
            if (!place.geometry) {
              var address = $("#location_search").val();
              geocoder.geocode({
                'address': address
              }, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                  var lat = results[0].geometry.location.lat();
                  var lng = results[0].geometry.location.lng();
                  newView = {
                    center: {
                      "lat": lat,
                      "lng": lng
                    },
                    "zoom": 10
                  };
                  timelapse.setNewView(newView, false, false);
                } else {
                  console.log("Geocode failed: " + status);
                }
              });
            } else {
              var newView = {
                center: {
                  "lat": place.geometry.location.lat(),
                  "lng": place.geometry.location.lng()
                },
                "zoom": 10
              };
              timelapse.setNewView(newView, false, false);
            }
          });
        }
      }

      function initLayerToggleUI() {
        $("#show-wdpa").on("click", function() {
          var $this = $(this);
          if ($this.is(':checked')) {
            showWdpaLayer = true;
          } else {
            showWdpaLayer = false;
          }
        }).prop('checked', showWdpaLayer);

        $("#show-forest-change").on("click", function() {
          if ($(this).prop('checked')) {
            showHansonLayer = true;
          } else {
            showHansonLayer = false;
          }
        }).prop('checked', showHansonLayer);

        $("#show-forest-loss-gain").on("click", function() {
          if ($(this).prop('checked')) {
            showHansonLayer2 = true;
          } else {
            showHansonLayer2 = false;
          }
        }).prop('checked', showHansonLayer2);

        $("#show-viirs").on("click", function() {
          if ($(this).prop('checked')) {
            showViirsLayer = true;
            timelapse.setPlaybackRate(8);
            timelapse.loadNewTimeline("../createlab-viirs/viirs-times.json","defaultUI");
            timelapse.setDoDwell(false);
            $("#show-additional-landsat").prop("disabled", true);
          } else {
            showViirsLayer = false;
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            if ($("#show-additional-landsat").prop('checked')) {
              timelapse.loadNewTimeline("landsat-times-long.json","customUI");
            } else {
              timelapse.loadNewTimeline("landsat-times.json","customUI");
            }
            timelapse.setDoDwell(true);
            $("#show-additional-landsat").prop("disabled", false);
          }
        }).prop('checked', showViirsLayer);

        $("#show-coral").on("click", function() {
          if ($(this).prop('checked')) {
            showCoralBleachingLayer = true;
            showMcrmLayer = true;
          } else {
            showCoralBleachingLayer = false;
            showMcrmLayer = false;
          }
        }).prop('checked', showCoralBleachingLayer);

        $("#show-lights-at-night").on("click", function() {
          if ($(this).prop('checked')) {
            showLightsAtNightLayer = true;
          } else {
            showLightsAtNightLayer = false;
          }
        }).prop('checked', showCoralBleachingLayer);

        $("#show-additional-landsat").on("click", function() {
          if ($(this).prop('checked')) {
            timelapse.loadNewTimeline("landsat-times-long.json","customUI");
          } else {
            timelapse.loadNewTimeline("landsat-times.json","customUI");
          }
        });

        // Set the starting base layer
        $("input:radio[name=base-layers]").on("click", function() {
          visibleBaseMapLayer = $(this).val();
        });
        $('input:radio[name=base-layers][id=' + visibleBaseMapLayer + '-base]').prop('checked', true);

        // Copy over data attributes to selectmenu
        $.widget("ui.selectmenu", $.ui.selectmenu, {
          _renderItem: function( ul, item ) {
            var elementdata = item.element.context.dataset;
            var attributesObj = {};
            Object.keys(elementdata).forEach(function(x){
            attributesObj["data-" + x] = elementdata[x];
          });
          return $( '<li>' )
            .attr(attributesObj)
            .append(item.label)
            .appendTo( ul );
          }
        });

        var appendTarget = "#timeMachine";
        if(enableLetterboxMode) {
          appendTarget = "#content";
        }
        $("#extras-selector").selectmenu({
          appendTo: appendTarget,
          change: function(event, ui) {
            // use click event below since this event is not registered on the touch screen.
          }
        });

        $(".ui-selectmenu-menu").on("click", "li", function(e) {
            var fileName = $(e.currentTarget).data("filename");
            var fileType = $(e.currentTarget).data("type");
            $("#extras-content").dialog('option', 'title', $(e.currentTarget).text());
            var $extrasHtml = "";
            if (fileType == "image") {
              $extrasHtml = '<img src="../../../extras/' + fileName + '">';
              $("#extras-content").html($extrasHtml).dialog("open");
            } else if (fileType == "video") {
              $extrasHtml = '<video id="extras-video" src="../../../extras/' + fileName + '" controls autoplay></video>';
              $("#extras-content").html($extrasHtml).dialog("open");
              $("#extras-video")[0].playbackRate = $(e.currentTarget).data("fileplaybackrate");
              $("#extras-video").gVideo({
                childtheme:'smalldark'
              });
            } else if (fileType == "link") {
              window.location.href = $(e.currentTarget).data("linkpath");
            }
        });

        $("#extras-content").dialog({
          appendTo: "#timeMachine",
          modal: true,
          autoOpen: false,
          draggable: false,
          resizable: false,
          dialogClass: "extras-content-video",
          beforeClose: function(event, ui) {
            var $extrasVideo  = $("#extras-video");
            if ($extrasVideo) {
              $extrasVideo[0].pause();
              $extrasVideo[0].src = "";
            }
            $("#extras-selector").val("select").selectmenu('refresh');
          }
        }).css({
          'z-index': '2000',
          'left': '0px',
          'top':'0px'
        });

        $(window).resize(function () {
          var width = $(window).width() * 1.8;
          var height = $(window).height() * 1.28;
          var scale = Math.min(1, Math.min(width / 1920, height / 1200));
          if(!enableLetterboxMode) {
            $('.vector-layers').css({'transform-origin': 'bottom right'});
            $('.vector-layers').css({'transform': 'scale(' + scale + ')'});
          }
        });
        $(window).trigger("resize");

      }
    </script>

    <script src="../../js/TimeMachineCanvasLayer.js" type="text/javascript"></script>

    <script type="text/javascript" src="../../js/base.js"></script>
    <script type="text/javascript" src="../../js/io.js"></script>
    <script type="text/javascript" src="../../js/utils.js"></script>

    <script type="text/javascript">
      "use strict";

      /* begin stats */
      /*var stats = new Stats();
      stats.setMode(0); // 0: fps, 1: ms
      // Align top-left
      stats.domElement.style.position = 'absolute';
      stats.domElement.style.left = '0px';
      stats.domElement.style.top = '0px';*/
      /* end stats */

      // BEGIN WebGL vars
      var canvasLayer;
      var gl, glb;

      var showWdpaLayer = false;
      var showMcrmLayer = false;
      var showHansonLayer = false;
      var showHansonLayer2 = false;
      var showViirsLayer = false;
      var showCoralBleachingLayer = false;
      var showLightsAtNightLayer = false;

      var tileViewVisibility = {
        videoTile: true,
        vectorTile: false
      };

      function onTimeMachinePlayerReady() {
        // initialize the canvasLayer
        var timeMachineCanvasLayerOptions = {
          timelapse: timelapse,
          resizeHandler: resize,
          animate: true,
          updateHandler: update,
          resolutionScale: window.devicePixelRatio || 1
        };
        canvasLayer = new TimeMachineCanvasLayer(timeMachineCanvasLayerOptions);

        // initialize WebGL
        gl = canvasLayer.canvas.getContext('experimental-webgl');
        glb = new Glb(gl);

        var layer_html = '';

        layer_html += '<div class="vector-layers">';

        var landsat_base_str = '<label for="landsat-base"><input type="radio" id="landsat-base" name="base-layers" value="landsat"/>Earth Engine Timelapse<span class="credit"> (Google)</span></label>';
        var landsat_base_letterbox = '<td>' + landsat_base_str + '</td>';
        var landsat_base = '<td colspan="2">' + landsat_base_str + '</td>';
        var light_base = '<td><label for="light-base"><input type="radio" id="light-base" name="base-layers" value="light"/><span>Light Map</span></label></td>';
        var dark_base = '<td><label for="dark-base"><input type="radio" id="dark-base" name="base-layers" value="dark"/><span>Dark Map</span></label></td>';

        layer_html += '<div class="base-map-div">';
        layer_html += ' <table class="base-map-radio" cellspacing="0">';
        layer_html += '   <tr>';
        if(enableLetterboxMode) {
          layer_html += landsat_base_letterbox;
        } else {
          layer_html += landsat_base;
        }
        layer_html += '   </tr>';
        if(enableLetterboxMode) {
          layer_html += '   <tr>';
          layer_html += light_base;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += dark_base;
          layer_html += '   </tr>';
        } else {
          layer_html += '   <tr>';
          layer_html += light_base;
          layer_html += dark_base;
          layer_html += '   </tr>';
        }
        layer_html += ' </table>';
        layer_html += '</div>';

        var show_wdpa = '<td><label for="show-wdpa"><input type="checkbox" id="show-wdpa" value="1"/>Protected Areas<span class="credit"> (UNEP-WCMC)</span></label></td>';
        var show_forest_change = '<td><label for="show-forest-change"><input type="checkbox" id="show-forest-change" value="2"/>Forest Loss by Year<span class="credit"> (Hansen et al)</span></label></td>';
        var show_viirs = '<td><label for="show-viirs"><input type="checkbox" id="show-viirs" value="4"/>Fires at Night<span class="credit"> (NOAA)</span></label></td>';
        var show_forest_loss_gain = '<td><label for="show-forest-loss-gain"><input type="checkbox" id="show-forest-loss-gain" value="3"/>Forest Loss/Gain<span class="credit"> (Hansen et al)</span></label></td>';
        var show_lights_at_night = '<td><label for="show-lights-at-night"><input type="checkbox" id="show-lights-at-night" value="5"/>Lights at Night<span class="credit"> (NOAA, Google)</span></label></td>';
        var show_coral = '<td><label for="show-coral"><input type="checkbox" id="show-coral" value="6"/>Coral Bleaching<span class="credit"> (NOAA, UNEP-WCMC)</span></label></td>';
        //var show_additional_landsat = '<td><label for="show-additional-landsat"><input type="checkbox" id="show-additional-landsat" value="7"/>+3Y</label></td>';

        layer_html += '<div class="map-layer-div">';
        layer_html += ' <table class="map-layer-checkbox" cellspacing="0">';
        layer_html += '   <tr>';
        layer_html += show_wdpa;
        if(enableLetterboxMode)
          layer_html += show_viirs;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += show_forest_change;
        if(enableLetterboxMode)
          layer_html += show_lights_at_night;
        layer_html += '   </tr>';
        layer_html += '   <tr>';
        layer_html += show_forest_loss_gain;
        if(enableLetterboxMode)
          layer_html += show_coral;
        layer_html += '   </tr>';
        if(!enableLetterboxMode) {
          layer_html += '   <tr>';
          layer_html += show_viirs;
          layer_html += '   <tr>';
          layer_html += '   <tr>';
          layer_html += show_lights_at_night;
          layer_html += '   <tr>';
          layer_html += '   <tr>';
          layer_html += show_forest_loss_gain;
          layer_html += '   <tr>';
        }
        layer_html += ' </table>';
        layer_html += '</div>';

        layer_html += '<div class="extras-selector-div">';
        layer_html += ' <select name="extras-selector" id="extras-selector">';
        layer_html += '   <option selected="selected" value="select">Select extra content...</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="pumphandle_2014.mp4">Measured CO2 Over Time</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Carbon Dioxide 2006 GEOS-5 model.mp4">CO2 2006 GEOS-5 Model</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Land + Ocean Average Temperature Annual Anomaly.mp4">Temperature Anomaly 1850-2013</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic ice age, 1987-2014.mp4">Ice Thinning 1987-2014</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Larsen-B-Collapse.mp4">Larsen-B Collapse</option>';
        layer_html += '   <option data-file-playback-rate="4" data-type="video" data-file-name="Orbiting Carbon Observatory.mp4">Orbiting Carbon Observatory</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic Sea Ice, September 1979 to September 2014.mp4">Annual Sea Ice Concentration 1979-2014</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="coral-reef-watch-daily-7day-max.mp4">Coral Reef Watch 2013-2015</option>';
        layer_html += '   <option data-file-playback-rate="0.5" data-type="video" data-file-name="merra-spi.mp4">Standardized Precipitation Index 1980-2015</option>';
        if (showEVA)
          layer_html += '   <option data-type="link" data-link-path="http://localhost:8080/?uid=history-1436384863961-Vyxt6PIO">EVA - Explorable Visual Analytics</option>';
        layer_html += ' </select>';
        layer_html += '</div>';

        layer_html += '</div>';

        if(enableLetterboxMode) {
          $(layer_html).appendTo($("#content"));
          $(".base-map-div, .map-layer-div, .extras-selector-div").addClass("top-panel").addClass("letterbox");
          $(".base-map-radio, .map-layer-checkbox, .extras-selector").addClass("letterbox");
        } else {
          $(layer_html).appendTo($("#timeMachine"));
          $(".vector-layers").addClass("right-panel");
        }

        if (isHyperwall) {
          $(".vector-layers").addClass("hyperwall");
        }

        // Time Machine layer
        var defaultTimeMachineLayerOptions = {
          mediaType: ".mp4",
          numFrames: 32,
          fps: 10
        };

        landsatBaseMapLayer = new WebglTimeMachineLayer(glb, canvasLayer, landsatUrl, defaultTimeMachineLayerOptions);

        // Raster map layers
        var defaultMapLayerOptions = {
          nLevels: 12,
          tileWidth: 256,
          tileHeight: 256
        };
        var defaultBaseMapLayerOptions = {
          nLevels: 11,
          tileWidth: 256,
          tileHeight: 256
        };
        var retinaMapLayerOptions = {
          nLevels: 11,
          tileWidth: 512,
          tileHeight: 512
        };
         var lightsAtNightMapLayerOptions = {
          nLevels: 8,
          tileWidth: 256,
          tileHeight: 256
        };

        var lightTileUrl = useGoogleMaps ? googleMapsDefaultRetinaUrl : osmLightRetinaUrl;
        var darkTileUrl = useGoogleMaps ? googleMapsDarkStyleRetinaUrl : osmDarkRetinaUrl;

        var mapBaseLayerOptions = isHyperwall ? retinaMapLayerOptions : defaultBaseMapLayerOptions;

        lightBaseMapLayer = new WebglMapLayer(glb, canvasLayer, lightTileUrl, mapBaseLayerOptions);
        darkBaseMapLayer = new WebglMapLayer(glb, canvasLayer, darkTileUrl, mapBaseLayerOptions);
        hansonMapLayer = new WebglMapLayer(glb, canvasLayer, gfcTransUrl, defaultMapLayerOptions);
        hansonMapLayer2 = new WebglMapLayer(glb, canvasLayer, gfcLossGainUrl, defaultMapLayerOptions);
        wdpaVectorLayer = new WebglVectorLayer(glb, canvasLayer, wdpaUrl, defaultMapLayerOptions);
        mcrmVectorLayer = new WebglVectorLayer2(glb, canvasLayer, mcrmUrl, defaultBaseMapLayerOptions);
        lightsAtNightMapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNightUrl, lightsAtNightMapLayerOptions);

        // VIIRS is just a single tile
        viirsTile = new WebglViirsTile(glb, viirsUrl);
        coralBleachingTile = new WebglCoralTile(glb, coralBleachingUrl);

        // Layer Toggle UI
        initLayerToggleUI();

        // Load waypoints
        timelapse.loadSharedDataFromUnsafeURL(presentationSliderContent);

        // Toggle layers off when auto mode begins
        var snaplapse = timelapse.getSnaplapseForPresentationSlider();
        var snaplapseViewer = snaplapse.getSnaplapseViewer();

        // Change UI based on whether setup is a hyperwall or not
        snaplapseViewer.addEventListener('snaplapse-loaded', function() {
          if (isHyperwall)
            $('.presentationSlider, .snaplapse_keyframe_container, .keyframeSubtitleBoxForHovering, .snaplapse_keyframe_list_item_presentation, .snaplapse_keyframe_list_item_thumbnail_overlay_presentation').addClass('hyperwall');
          if (enableLetterboxMode)
            $('.presentationSlider, .snaplapse_keyframe_container, .keyframeSubtitleBoxForHovering, .snaplapse_keyframe_list_item_presentation, .snaplapse_keyframe_list_item_thumbnail_overlay_presentation').addClass('letterbox');
        });

        // TODO: Refactor how this is handled and how layers turn on/off in general
        snaplapseViewer.addEventListener('slide-changed', function(waypointTitle) {
          // Earth Engine Timelapse
          var $landsatToggle = $("#landsat-base");
          // Light Map
          var $lightMapToggle = $("#light-base");
          // Dark Map
          var $darkMapToggle = $("#dark-base");
          // Protected Areas
          var $wdpaLayerToggle = $("#show-wdpa");
          // Forest Loss By Year
          var $globalForestLayerToggle = $("#show-forest-change");
          // Forest Loss/Gain
          var $globalForestLossLayerToggle = $("#show-forest-loss-gain");
          // Fires at Night
          var $viirsLayerToggle = $("#show-viirs");
          // Coral
          var $coralLayerToggle = $("#show-coral");
          // Coral
          var $lightsAtNightToggle = $("#show-lights-at-night");

          // Clear out layers if they were already checked
          // Default to Landsat
          $landsatToggle.click();
          if ($globalForestLayerToggle.prop('checked')) {
            $globalForestLayerToggle.click();
          }
          if ($wdpaLayerToggle.prop('checked')) {
            $wdpaLayerToggle.click();
          }
          if ($globalForestLossLayerToggle.prop('checked')) {
            $globalForestLossLayerToggle.click();
          }
          if ($coralLayerToggle.prop('checked')) {
            $coralLayerToggle.click();
          }
          if ($lightsAtNightToggle.prop('checked')) {
            $lightsAtNightToggle.click();
          }

          // Set layers based on waypoint

          // VIIRS specific waypoints
          if (waypointTitle == "Fires at night") {
            if (!$viirsLayerToggle.prop('checked')) {
              $viirsLayerToggle.click();
              //timelapse.play();
            }
            if (!$darkMapToggle.prop('checked')) {
              $darkMapToggle.click();
            }
          } else if (waypointTitle == "Agricultural fires") {
            if (!$viirsLayerToggle.prop('checked')) {
              $viirsLayerToggle.click();
              //timelapse.play();
            }
            if (!$darkMapToggle.prop('checked')) {
              $darkMapToggle.click();
            }
          } else if (waypointTitle == "Drilling fires") {
            if (!$viirsLayerToggle.prop('checked')) {
              $viirsLayerToggle.click();
              //timelapse.play();
            }
            if (!$darkMapToggle.prop('checked')) {
              $darkMapToggle.click();
            }
          } else if (waypointTitle == "Shale oil extraction") {
            if (!$viirsLayerToggle.prop('checked')) {
              $viirsLayerToggle.click();
              //timelapse.play();
            }
            if (!$darkMapToggle.prop('checked')) {
              $darkMapToggle.click();
            }
          } else {
            if ($viirsLayerToggle.prop('checked'))
              $viirsLayerToggle.click();
          }

          // Non-VIIRS waypoints
          if (waypointTitle == "Rondonia") {
            if (!$wdpaLayerToggle.prop('checked')) {
              $wdpaLayerToggle.click();
            }
          } else if (waypointTitle == "N Sumatra") {
            if (!$wdpaLayerToggle.prop('checked')) {
              $wdpaLayerToggle.click();
            }
          } else if (waypointTitle == "Asia Growth") {
            if (!$lightsAtNightToggle.prop('checked')) {
              $lightsAtNightToggle.click();
            }
          } else if (waypointTitle == "Resources and Forest") {
            if (!$globalForestLossLayerToggle.prop('checked')) {
              $globalForestLossLayerToggle.click();
            }
          } else if (waypointTitle == "Peru") {
            if (!$globalForestLayerToggle.prop('checked')) {
              $globalForestLayerToggle.click();
            }
            if (!$darkMapToggle.prop('checked')) {
              $darkMapToggle.click();
            }
          } else if (waypointTitle == "Alberta, Canada") {
            if (!$globalForestLayerToggle.prop('checked')) {
              $globalForestLayerToggle.click();
            }
            if (!$darkMapToggle.prop('checked')) {
              $darkMapToggle.click();
            }
          } else if (waypointTitle == "Papua, Indonesia") {
            if (!$globalForestLayerToggle.prop('checked')) {
              $globalForestLayerToggle.click();
            }
            if (!$darkMapToggle.prop('checked')) {
              $darkMapToggle.click();
            }
          } else if (waypointTitle == "Bolivia") {
            if (!$globalForestLayerToggle.prop('checked')) {
              $globalForestLayerToggle.click();
            }
            if (!$darkMapToggle.prop('checked')) {
              $darkMapToggle.click();
            }
          }
        });

        snaplapseViewer.addEventListener('automode-start', function() {
          var $globalForestLayerToggle = $("#show-forest-change");
          var $wdpaLayerToggle = $("#show-wdpa");
          var $globalForestLossLayerToggle = $("#show-forest-loss-gain");
          var $viirsLayerToggle = $("#show-viirs");
          var $coralLayerToggle = $("#show-coral");
          var $lightsAtNightToggle = $("#show-lights-at-night");

          var $showAdditionalLandsatYearsToggle = $("#show-additional-landsat");

          if ($globalForestLayerToggle.prop('checked')) {
            $globalForestLayerToggle.click();
          }
          if ($wdpaLayerToggle.prop('checked')) {
            $wdpaLayerToggle.click();
          }
          if ($globalForestLossLayerToggle.prop('checked')) {
            $globalForestLossLayerToggle.click();
          }
          if ($viirsLayerToggle.prop('checked')) {
            $viirsLayerToggle.click();
          }
          if ($coralLayerToggle.prop('checked')) {
            $coralLayerToggle.click();
          }
          if ($lightsAtNightToggle.prop('checked')) {
            $lightsAtNightToggle.click();
          }
          if ($showAdditionalLandsatYearsToggle.prop('checked')) {
            $showAdditionalLandsatYearsToggle.click();
          }
        });

        // Location search box, with autocomplete.
        var $locationSearchDiv = $('<div class="location_search_div"><input id="location_search" type="text" placeholder="Search for a location...">');
        if(enableLetterboxMode) {
          $locationSearchDiv.addClass("top-panel").addClass("letterbox").appendTo($("#content"));
          $("#location_search").addClass("letterbox");
        } else {
          $locationSearchDiv.appendTo($("#timeMachine"));
        }

        // Note: Google's service gives much better results, but for sites where Google APIs cannot be used, we fallback to this.
        if (!useGoogleMaps) {
          var locationList = [];
          $("#location_search").autocomplete({
            minLength: 5,
            source: function( request, response ) {
              locationList = [];
              //http://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=1
              $.getJSON( "http://photon.komoot.de/api/?limit=5", { q: request.term }, function( data, status, xhr ) {
                response( data.features );
              });
            },
            select: function(event, ui) {
              var view;
              //if (ui.item.properties.extent) {
                //  view = {bbox: {"ne": {"lat": ui.item.properties.extent[1], "lng": ui.item.properties.extent[2]}, "sw": {"lat" : ui.item.properties.extent[3], "lng": ui.item.properties.extent[0]}}};
              //} else {
                view = {center: {"lat": ui.item.geometry.coordinates[1], "lng": ui.item.geometry.coordinates[0]}, "zoom": 12};
              //}
              timelapse.setNewView(view);
            }
          }).autocomplete( "instance" )._renderItem = function( ul, item ) {
            var tmpLocationString = (item.properties.name || "")  + ", " + (item.properties.state || "") + item.properties.country;
            if (item.properties.osm_value == "hamlet" || !item.properties.country || locationList.indexOf(tmpLocationString) >= 0) return $("<li>");
              locationList.push(tmpLocationString);
             return $("<li style='z-index:9999'>").append("<a>" + (item.properties.name || "")  + ", " + (item.properties.state || "") + "<br>" + item.properties.country + "</a>").appendTo(ul);
          };
        }

        // Set the letterbox mode
        if(enableLetterboxMode) {
          // Resize the viewer
          timelapse.addViewerBottomMargin(-2);
          // Move the presentation slider out
          var $presentationSlider = $("#" + timelapse.getTimeMachineDivId() + " .presentationSlider");
          $presentationSlider.appendTo("#content");
        }
        // Toggle the context map and hide it
        $(".toggleContextMapBtn").click();
        $(".contextMapContainer").hide();
      }

      var perf;
      var maximumUpdateTime = 20; // milliseconds
      var startOfRedraw;

      function redrawTakingTooLong() {
        return performance.now() - startOfRedraw > maximumUpdateTime;
      }

      function resize() {
        var width = canvasLayer.canvas.width;
        var height = canvasLayer.canvas.height;

        gl.viewport(0, 0, width, height);
      }

      //var firstDrawTime = null;
      //var lastFrameTime = null

      // Draws to canvas.
      // Called by TimeMachineCanavasLayer during animation and/or view changes
      function update() {

        /*var frameTime = performance.now();
        startOfRedraw = frameTime;

        if (lastFrameTime != null) {
          var duration = frameTime - lastFrameTime;
        }
        lastFrameTime = frameTime;

        //stats.begin();
        if (WebglVideoTile.verbose) {
          function r2(x) {
            return Math.round(x * 100) / 100;
          }
          console.log(r2(performance.now()) + ' update start --------------------------------------------------');
        }*/

        //if (!firstDrawTime) {
        //  firstDrawTime = performance.now();
        //  var dfwView = { center: {x:308100, y:538800}, zoom: 8};
        //  timelapse.setNewView(dfwView, true);
        //  timelapse.play();
        //}

        //if (performance.now() - firstDrawTime < 1 * 5000) {
        //  WebglVideoTile.verbose = true;
        //} else {
        //  if (WebglVideoTile.verbose) {
        //    WebglVideoTile.verbose = false;
        //    console.log(WebglVideoTile.stats());
        //  }
        //}

        gl.clear(gl.COLOR_BUFFER_BIT);

        // Draw lightsAtNightMapLayer
        if (showLightsAtNightLayer) {
          // Construct view for lightsAtNightMapLayer
          var lightsAtNightLayerView = timelapse.getView();
          var timelapse2map = lightsAtNightMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
          lightsAtNightLayerView.x *= timelapse2map;
          lightsAtNightLayerView.y *= timelapse2map;
          lightsAtNightLayerView.scale /= timelapse2map;

          lightsAtNightMapLayer.draw(lightsAtNightLayerView);
        }

        // Draw base layer
        else if (visibleBaseMapLayer == "landsat") {
          landsatBaseMapLayer.draw(timelapse.getView(), tileViewVisibility);
        } else if (visibleBaseMapLayer == "light") {
          // Construct view for lightBaseMapLayer
          var lightBaseMapView = timelapse.getView();
          var timelapse2map = lightBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
          lightBaseMapView.x *= timelapse2map;
          lightBaseMapView.y *= timelapse2map;
          lightBaseMapView.scale /= timelapse2map;

          lightBaseMapLayer.draw(lightBaseMapView);
        } else if (visibleBaseMapLayer == "dark") {
          // Construct view for darkBaseMapLayer
          var darkBaseMapView = timelapse.getView();
          var timelapse2map = darkBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
          darkBaseMapView.x *= timelapse2map;
          darkBaseMapView.y *= timelapse2map;
          darkBaseMapView.scale /= timelapse2map;

          darkBaseMapLayer.draw(darkBaseMapView);
        }

        // Layers to draw above the base layer

        // Draw hansonMapLayer (Forest change transparent)
        if (showHansonLayer) {
          // Construct view for hansonMapLayer
          var hansonMapLayerView = timelapse.getView();
          var timelapse2map = hansonMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
          hansonMapLayerView.x *= timelapse2map;
          hansonMapLayerView.y *= timelapse2map;
          hansonMapLayerView.scale /= timelapse2map;

          hansonMapLayer.draw(hansonMapLayerView);
        }

        // Draw hansonMapLayer2 (Forest Loss/Gain)
        if (showHansonLayer2) {
          // Construct view for hansonMapLayer2
          var hansonMapLayerView2 = timelapse.getView();
          var timelapse2map = hansonMapLayer2.getWidth() / landsatBaseMapLayer.getWidth();
          hansonMapLayerView2.x *= timelapse2map;
          hansonMapLayerView2.y *= timelapse2map;
          hansonMapLayerView2.scale /= timelapse2map;

          hansonMapLayer2.draw(hansonMapLayerView2);
        }

        // Draw wdpaLayer
        if (showWdpaLayer)
          wdpaVectorLayer.draw(timelapse.getView());

        if (showMcrmLayer) {
          var mcrmLayerView = timelapse.getView();
          var timelapse2map = mcrmVectorLayer.getWidth() / landsatBaseMapLayer.getWidth();
          mcrmLayerView.x *= timelapse2map;
          mcrmLayerView.y *= timelapse2map;
          mcrmLayerView.scale /= timelapse2map;

          mcrmVectorLayer.draw(mcrmLayerView);
        }


        // VIIRS layer
        if (showViirsLayer) {
          //var v = timelapse.getVideoset();
          //v.seek(0);
          var viirsView = timelapse.getView();
          viirsView.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
          var currentDate = ratio*range + new Date(times[0]).getTime();
          viirsView.currentDate = currentDate;
          viirsTile.draw(viirsView);
        }

        if (showCoralBleachingLayer) {
          //var v = timelapse.getVideoset();
          //v.seek(0);
          var viirsView = timelapse.getView();
          viirsView.zoom = timelapse.getCurrentZoom();
          var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
          var times = timelapse.getCaptureTimes();
          var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
          var currentDate = ratio*range + new Date(times[0]).getTime();
          viirsView.currentDate = currentDate;
          coralBleachingTile.draw(viirsView);
        }

        //stats.end();
      }
    </script>
  </head>
  <body>
    <div id="content" style="position: relative; width: 1920px; height: 1080px; overflow: hidden;">
      <div id="letterbox-top"></div>
      <div id="letterbox-middle"></div>
      <div id="letterbox-bottom"></div>
    </div>
    <div id="timeMachine"></div>
    <canvas id="stats" style="position:absolute; top:0px; right:0px; z-index:100" width=1000 height=153></canvas>
    <div id="extras-content" title=""></div>
  </body>
</html>

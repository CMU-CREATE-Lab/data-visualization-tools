<!DOCTYPE html>
<html>
  <head>
    <title>Earth Timelapse</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <link href="../../timemachine/css/snaplapse.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/defaultUI.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/contextMap.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/scaleBar.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/customUI.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/leaflet/leaflet.css" rel="stylesheet" type="text/css"/>
    <link href="../../js/customVideoTagControls/customVideoTagControls.css" rel="stylesheet" type="text/css"/>
    <link href="index.css" rel="stylesheet" type="text/css" />

    <script src="../../timemachine/js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/util.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
    <script src="../../timemachine/js/Math.uuid.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/scaleBar.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/contextMap.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/customUI.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>
    <script src="../../timemachine/template_includes.js" type="text/javascript"></script>
    <script src="../../timemachine/js/leaflet/leaflet.min.js" type="text/javascript" ></script>
    <script src="../../js/customVideoTagControls/customVideoTagControls.js" type="text/javascript"></script>
    <script src="../../../data/earthtime-annual-2015-v2/ajax_includes.js" type="text/javascript"></script>
    <script src="../../../../config.js" type="text/javascript"></script>
    <script src="waypoint-text.js" type="text/javascript"></script>

    <script src="TileIdx.js"></script>
    <script src="WebglVideoTile.js"></script>
    <script src="TileView.js"></script>
    <script src="Glb.js"></script>
    <script src="WebglTimeMachineLayer.js"></script>
    <script src="WebglMapLayer.js"></script>
    <script src="WebglVectorLayer.js"></script>
    <script src="WebglVectorLayer2.js"></script>
    <script src="WebglTimeMachinePerf.js"></script>
    <script src="WebGLVectorTile.js"></script>
    <script src="WebGLVectorTile2.js"></script>
    <script src="WebglMapTile.js"></script>
    <script src="WebglViirsTile.js"></script>
    <script src="WebglCoralTile.js"></script>
    <script src="WebglMapTile2.js"></script>
    <script src="WebglMapLayer2.js"></script>

    <script type="text/javascript">
      "use strict";

      jQuery.support.cors = true;

      var previousWaypoint = {}, previousHimawariIdx, waypointViewChangeListener, hideWaypointListener;
      var forestAlertsTimeMachineLayer, forestAlertsNoOverlayTimeMachineLayer, landsatBaseMapLayer, timelapse, darkBaseMapLayer, lightBaseMapLayer, wdpaVectorLayer, mcrmVectorLayer, hansonMapLayer, hansonMapLayer2, viirsTile, coralBleachingTile, lightsAtNightMapLayer, crwTimemachineLayer, animatedHansenLayer, himawariTimemachineLayer, waterOccurrenceLayer, waterChangeLayer;

      var usgsWindTurbineLayer, solarInstallsLayer, drillingLayer;

      //// Config ////
      var EARTH_TIMELAPSE_CONFIG = EARTH_TIMELAPSE_CONFIG || {};

      var presentationSliderContent = EARTH_TIMELAPSE_CONFIG.waypointCollection || "http://timemachine.cmucreatelab.org/wiki/EarthEngineTourEditor#presentation=E5DDkDV0jvjsXrchC_Climate_DkDQhV1kUKXaiD_Fires%20at%20Night_DkDFWaNbFlEeqJ_Agricultural%20Fires_DkDASzGiNIcpvK_Agricultural%20Fires_DkDIAHUl1q2eqJ_Drilling%20Flares_DkDSx-Tmy5yMmK_Shale%20Oil%20Extraction_DkDRFMpUtEFyje_Eagle%20Downs%20Coal_DkDOHcDnYDBPjgB_Mountaintop%20Removal_DkDcYs5sY3cKrZ_Alberta%20Tar%20Sands_DkDIl59k8-Aurb_Shanghai_DkDIHBIjdC4j7f_Dubai_DkDIumflQzrMib_Dallas%20Fort-Worth_DkDWVyelV9qMjW_Dallas%20Fort-Worth%20_DkDIYWEnHy5MoJ_United%20States_DkDI8H8f-Cuc3C_Lights%20at%20Night_DkDI9F8k2euuzJ_East%20Asia_DkDPWPyXs9wR6gB_Rondonia_DkDPZ85XKYIShT_Rondonia_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDA8sGufoBFqe_Columbia%20Glacier_DkDNROTtit7GojB_Mendenhall%20Glacier_DkDFGq9mKcYi8VThe%20shrinking%20and%20drying%20up%20of%20the%20Lake%20Urmia_Lake%20Urmia_DkDOcGQprwpkmRThe%20shrinking%20of%20the%20Aral%20Sea%20destroys%20fishing%20industry%20and%20brings%20unemployment%20and%20public%20health%20problems_Aral%20Sea_DkDSq1joU5sk6gBThe%20expansion%20of%20irrigation%20systems%20near%20the%20Aral%20Sea_Aral%20Expansion_CkDWmblQtbBxuXBushfires%20in%20Australia%20are%20frequent%20during%20the%20hotter%20months%20of%20the%20year_Australia%20Bushfire_DkDblXvnAWJL2V_Bark%20Beetles_DkDPZ85XKYIShT_Rondonia_DkDPI2unYMQqrhB_Gansu%20Wind%20Farm_DkDPOxFm4qZJ2iB_Solar%20Star_DkDV0jvjsXrchC_Forest_DkDVWlolkXJOxe_Alabama_DkDVmSguE8quhS_Yakutsk_DkDVZNiW4_KhhS_Mozambique_DkDVdSqbMp9qlV_Indonesia_DkDVdhqUIJOShS_Paraguay_DkDV5NVdc5jalV_Cote%20D%E2%80%99Ivoire_DkDVzKwaoThslV_Kalimantan_DkDVjqJcYu9spY_Sarawak_DkDVxYQuwu2fhS_Russia%2FFinland_DkDV0jvjsXrchC_Water_DkDV9ofmUx7Jmd_Las%20Vegas_DkDFGq9mKcYi8VThe%20shrinking%20and%20drying%20up%20of%20the%20Lake%20Urmia_Lake%20Urmia_DkDOcGQprwpkmR_Aral%20Sea_DkDSq1joU5sk6gB_Aral%20Expansion_DkDSYrnkxOVh6c_Saudi%20Irrigation_DkDSVR-mLkAJ3c_Central%20Valley_DkDS4s-m9NHJ8gB_California%20Reservoir_BkDTiTRWWTmR6gBRiver%20meandering%20in%20the%20Amazon_Bolivia%20Meander_DkDK9ySWib2R2dThe%20abandonment%20of%20a%20river%20channel%20and%20the%20formation%20of%20a%20new%20river%20channel_Bolivia%20Avulsion_DkDTXCJXWOFUha_Brazil%20Reservoir_DkDT6ClYMn5SpN_Amazon%20Deforestation_DkDTypVi8CHpkd_Bangladesh_DkDT07enqs_t_gB_Fish%20Ponds%2C%20China_DkDV0jvjsXrchC_Coral%20Reef%20Watch_DkDV0jvjsXrchC_Resources_DkDVl59k8-Aurb_Shanghai_DkDVumflQzrMib_Dallas%20Fort-Worth_DkDVWWhlM5mMiiB_Barnett%20Shale_DkDWVyelV9qMjW_DFW%20Growth_DkDVYWEnHy5MoJ_United%20States_DkDV8H8f-Cuc3C_Lights%20at%20Night_DkDVsXXi870skf_Pearl%20River%20Delta_DkDQhV1kUKXaiD_Fires%20at%20Night_DkDIAHUl1q2eqJ_Drilling%20Flares_DkDSx-Tmy5yMmK_Shale%20Oil%20Extraction_DkDVbUxoD7ZLre_Wyoming%20Coal%20Mining_DkDOHcDnYDBPjgB_Mountaintop%20Removal_DkDV-99mHP-OgW_Mountaintop%20Removal_DkDVlMmn4Acs_iB_Hei%20Dai%20Gao%20Coal_DkDcYs5sY3cKrZ_Alberta%20Tar%20Sands_DkDVNViXQeyQjgB_Peru%20Mining_DkDVEuOaR5YwojB_Grasberg%20Mine_DkDVOnDa0YXw6d_Grasberg%20Tailings_DkDOcGQprwpkmR_Aral%20Sea_DkDOYrnkxOVh6c_Saudi%20Irrigation_DkDPWPyXs9wR6gB_Rondonia_DkDPZ85XKYIShT_Rondonia_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDPNEabGoEs-N_Indonesia%20Forests_DkDWOpqWSEFK2Q_Sumatra%20Fires_DkDPRG9ln6qOtN_Forestry%20SE%20US_DkDWWnfme-zqiiB_Longyangxia%20Solar_DkDPOxFm4qZJ2iB_Solar%20Star_DkDPjqQmuXJJojB_Topaz%20Solar%20Farm_DkDPKtwiQVVmojB_Charanka%20Solar%20Park_DkDPGUUmWP2JojB_Ivanpah%20Solar%20Power_DkDP22pmX2kaojB_Valle%20Solar%20Power_DkDPI2unYMQqrhB_Gansu%20Wind%20Farm_DkDPEuJmc6aJojB_Alta%20Wind%20Farm_DkDPD7CnLTtMiK_US%20Wind_DkDPD7CnLTtMiK_US%20Photovoltaic_DkDV0jvjsXrchC_Industrialization_DkDVlsznvjQPkgB_Pittsburgh_DkDWksznwjQP_Z_Pittsburgh_DkDVLjfdNa_b5c_Lagos_DkDVLjfdNa_b5c_Lagos_DkDP4t6mgw0u7c_Seoul_DkDP4t6mgw0u7c_Seoul_DkDQ5wYitp3subShenzhen%20bay%2C%20growth%20of%20land%20use%20into%20bay%2E_Shenzhen_DkDQrnpWLjJUya_Brasilia_DkDQoLbXOXaTsV_Brasilia_DkDQ5YWph63cxf_Milano_DkDQSHLrsBhcigB_Duisburg_DkDQENjTEnwf2d_Pretoria_DkDAFpEbiqFhmjB_Nairobi_DkDAZdNelWYhojB_Addis%20Ababa_DkDAGq9mKcYi8V_Lake%20Urmia_DkDAGyOdZ5mcnC_Coral%20Reefs_DkDAHBYiAv1s9a_Shenzhen_DkDWFqgBAAAA1M_Himawari-8_DkDWOpqWSEFK2Q_Sumatra%20Fires_DkDWA-fScC5OtR_Sinabung%20Volcano_DkDWFqgBAAAA1M_Clear%20Beijing_DkDWFqgBAAAA1M_Hazy%20Beijing_DkDWFqgBAAAA1M_Hazier%20Beijing_DkDWFqgBAAAA1M_Melting%20Snow_DkDWtEyBMH2b3N_Ice%20Floes_DkDWqpyBvNmagT_Iceberg%20calving_BAWFqgBAAAA1M_Typhoon%20In-Fa_Untitled_B";
      var showEVA = !!EARTH_TIMELAPSE_CONFIG.showEVA;
      var isHyperwall = !!EARTH_TIMELAPSE_CONFIG.isHyperwall;
      var useGoogleMaps = !!EARTH_TIMELAPSE_CONFIG.useGoogleMaps;
      var useGoogleSearch = (typeof(EARTH_TIMELAPSE_CONFIG.useGoogleSearch) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useGoogleSearch;
      var enableAutoMode = !!EARTH_TIMELAPSE_CONFIG.enableAutoMode;
      var screenTimeoutInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.screenTimeoutInMilliseconds) || 8 * 60 * 1000;
      var waypointDelayInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.waypointDelayInMilliseconds) || 1 * 15 * 1000;
      var defaultPlaybackSpeed = parseFloat(EARTH_TIMELAPSE_CONFIG.defaultPlaybackSpeed) || 0.5;
      var enableLetterboxMode = (typeof(EARTH_TIMELAPSE_CONFIG.enableLetterboxMode) == "undefined") ? false : !!EARTH_TIMELAPSE_CONFIG.enableLetterboxMode;
      var useFaderShader = (typeof(EARTH_TIMELAPSE_CONFIG.useFaderShader) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useFaderShader;
      var enableWaypointText = (typeof(EARTH_TIMELAPSE_CONFIG.enableWaypointText) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.enableWaypointText;
      var enableRecordingMode = (typeof(EARTH_TIMELAPSE_CONFIG.enableRecordingMode) == "undefined") ? false : !!EARTH_TIMELAPSE_CONFIG.enableRecordingMode;

      var landsatMaxScale = 1.25;
      var himawariMaxScale = 0.02;
      var isAutoModeRunning = false;

      // Set shader
      WebglVideoTile.useFaderShader = useFaderShader;

      //// Context Map Tiles ////
      var osmDefaultUrl = "../../../data/openstreetmap/default/";

      //// Video Tiles
      var landsatUrl = "../../../data/earthtime-annual-2015-v2/1068x600";
      // Using "https" will casue the thumbnail loading from the server to fail
      //var landsatUrl = "http://earthengine.google.org/timelapse/data/20130507";
      var crwTimemachineUrl = "../../../data/coral/coralreefwatch-2.timemachine/crf20-22fps-1424x800";
      var himawariTimemachineUrl = "../../../data/himawari8/himawari8-nov-2015.timemachine/crf26-12fps-1424x800";
      var forestAlertsTimeMachineUrl = "../../../data/global-forest-alerts/ForestAlarms2015v5/1068x600";
      var forestAlertsNoOverlayTimeMachineUrl = "../../../data/global-forest-alerts/ForestAlarmsNoOverlay2015v5/1068x600";

      //// Map Tiles ////
      // OpenStreetMap/CartoDB
      var osmLightRetinaUrl = "../../../data/openstreetmap/light_all_retina/{default}/{z}/{x}/{y}.png";
      var osmDarkRetinaUrl = "../../../data/openstreetmap/dark_all_retina/{default}/{z}/{x}/{y}.png";
      // Global Forest Change (Matt Hansen)
      var gfcTransUrl = "../../../data/global-forest-change/loss_year_transparent/{default}/{z}/{x}/{y}.png";
      var gfcLossGainUrl = "../../../data/global-forest-change/loss_tree_gain/{default}/{z}/{x}/{y}.png";
      // Google Maps non-retina
      var googleMapsDefaultUrl = "https://mts0.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0";
      var googleMapsDarkStyleUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0";
      // Google Maps retina
      var googleMapsDefaultRetinaUrl = "https://mts1.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0!5m1!5f2";
      var googleMapsDarkStyleRetinaUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0!5m1!5f2";
      // Lights At Night
      var lightsAtNightUrl = "../../../data/lights-at-night/{default}/{z}/{x}/{y}.png";
      // Water Occurrence
      var waterOccurrenceUrl = "../../../data/water/occurrence-2015/{default}/{z}/{x}/{y}.png";
      // Water Change
      var waterChangeUrl = "../../../data/water/change-2015/{default}/{z}/{x}/{y}.png";

      //// Vector Tiles ////
      var wdpaUrl = "../../../data/wdpaline-year";
      var mcrmUrl = "../../../data/coral/mcrm-lines-wrapdateline";
      var viirsUrl = '../../../data/viirs/createlab-viirs-uncorrected-20140314-20150403.bin';
      var coralBleachingUrl = "../../../data/coral/bleaching_reports_4km_81-10.bin";

      var usgsWindTurbineUrl = "../../../data/energy/wind-installs-usgs";
      var solarInstallsUrl = "../../../data/energy/solar-installs";
      var drillingUrl = "../../../data/energy/drilling";

      var animatedHansenUrls = [gfcTransUrl, gfcLossGainUrl];

      var visibleBaseMapLayer = "landsat";
      var previousVisibleBaseMapLayer = visibleBaseMapLayer;

      function init() {
        var settings = {
          loopDwell: { startDwell:1.5, endDwell:1.5 },
          playbackSpeed: defaultPlaybackSpeed,
          viewerType: "webgl",
          url: landsatUrl,
          enablePresentationSlider: enableRecordingMode ? false : true,
          enableEditor: enableRecordingMode ? true : false,
          showEditorOnLoad: enableRecordingMode ? true : false,
          thumbnailServerRootTileUrl: "http://earthengine.google.org/timelapse/data/20130507",
          showFullScreenBtn: false,
          presentationSliderSettings: enableRecordingMode ? {} : {
            onLoadAnimation: "none",
            playAfterAnimation: false,
            initialWaypointIndex: 0,
            doAutoMode: enableAutoMode,
            showAnnotations: false,
            screenIdleTime: screenTimeoutInMilliseconds,
            waypointDelayTime: waypointDelayInMilliseconds,
            height: 94
          },
          useTouchFriendlyUI: isHyperwall,
          datasetType: "landsat",
          playOnLoad: enableRecordingMode ? false : true,
          mediaType: ".mp4",
          onTimeMachinePlayerReady: function(viewerDivId) {},
          scaleBarOptions: {
            scaleBarDiv: "scaleBar1"
          },
          contextMapOptions: {
            contextMapDiv: "contextMap1",
            tileType: useGoogleMaps ? "Google" : "OpenStreetMap",
            tileUrl: osmDefaultUrl,
            geometry: {
              width: 270,
              height: 200
            }
          }
        };

        if (enableLetterboxMode) {
          $("#timeMachine").addClass("letterbox");
          $("#letterbox-middle").replaceWith($("#timeMachine"));
        } else {
          $("#content").remove();
        }

        if(enableRecordingMode) {
          $("#timeMachine, #content").addClass("recording");
          $("#letterbox-bottom").remove();
        }

        timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", settings);
        onTimeMachinePlayerReady();

        //document.body.appendChild( stats.domElement );
        //$(stats.domElement).css('z-index', 1000);

        perf = new WebglTimeMachinePerf(document.getElementById('stats'), timelapse);
        $('#stats').hide();
        /*$(document).keypress(function(e) {
          // ctrl-a toggles perf
          if (e.keyCode == 1) {
            $('#stats').toggle();
          }
        });*/
      }

      $(init);

      function loadHimawari() {
        if (!$("#show-himawari").prop('checked')) {
          $('#show-himawari').prop('checked', true);
          timelapse.loadNewTimeline("himawari-times.json","defaultUI");
          showHimawariTimeMachineLayer = true;
          var v = timelapse.getVideoset();
          v.setFps(12);
          timelapse.setMaxScale(himawariMaxScale);
          timelapse.setDoDwell(false);
          timelapse.setPlaybackRate(1);
          previousVisibleBaseMapLayer = visibleBaseMapLayer;
          visibleBaseMapLayer = "himawari";
          $(".vector-legend").hide();
        }
      }

      function googleMapsLoadedCallback() {
        if (useGoogleSearch) {

          var autocomplete = new google.maps.places.Autocomplete($("#location_search").get(0));
          var geocoder = new google.maps.Geocoder();

          // Hack to enable places selection from dropdown on touch screens
          $(document).on('touchstart', '.pac-item', function(e){
            e.preventDefault();
            var searchText = $(this).text();
            $("#location_search").val(searchText);
            google.maps.event.trigger(autocomplete, 'place_changed', {locationName: searchText});
            $('.pac-container').hide();
          });

          google.maps.event.addListener(autocomplete, 'place_changed', function(options) {
            var place = autocomplete.getPlace() || options.locationName;
            if (!place) return;
            if (!place.geometry) {
              var address = $("#location_search").val();
              geocoder.geocode({
                'address': address
              }, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                  var lat = results[0].geometry.location.lat();
                  var lng = results[0].geometry.location.lng();
                  newView = {
                    center: {
                      "lat": lat,
                      "lng": lng
                    },
                    "zoom": 10
                  };
                  timelapse.setNewView(newView, false, false);
                } else {
                  console.log("Geocode failed: " + status);
                }
              });
            } else {
              var newView = {
                center: {
                  "lat": place.geometry.location.lat(),
                  "lng": place.geometry.location.lng()
                },
                "zoom": 10
              };
              timelapse.setNewView(newView, false, false);
            }
          });
        }
      }

      function initLayerToggleUI() {
        $("#show-water-occurrence").on("click", function() {
          var $this = $(this);
          if ($this.is(':checked')) {
            showWaterOccurrenceLayer = true;
            if ($("#show-water-change").prop('checked')) {
              $("#show-water-change").click();
            }
            $("#water-occurrence-legend").show();
          } else {
            showWaterOccurrenceLayer = false;
            $("#water-occurrence-legend").hide();
          }
        }).prop('checked', showWaterOccurrenceLayer);

        $("#show-water-change").on("click", function() {
          var $this = $(this);
          if ($this.is(':checked')) {
            showWaterChangeLayer = true;
            if ($("#show-water-occurrence").prop('checked')) {
              $("#show-water-occurrence").click();
            }
            $("#water-change-legend").show();
          } else {
            showWaterChangeLayer = false;
            $("#water-change-legend").hide();
          }
        }).prop('checked', showWaterChangeLayer);

        $("#show-wdpa").on("click", function() {
          var $this = $(this);
          if ($this.is(':checked')) {
            showWdpaLayer = true;
            $("#wdpa-legend").show();
          } else {
            showWdpaLayer = false;
            $("#wdpa-legend").hide();
          }
        }).prop('checked', showWdpaLayer);

        $("#show-forest-change").on("click", function() {
          if ($(this).prop('checked')) {
            showHansonLayer = true;
            if ($("#show-forest-loss-gain").prop('checked')) {
              $("#show-forest-loss-gain").click();
            }
            if ($("#show-animated-forest-loss-gain").prop('checked')) {
              $("#show-animated-forest-loss-gain").click();
            }
            if ($("#show-forest-alerts").prop('checked')) {
              $("#show-forest-alerts").click();
            }
            if ($("#show-forest-alerts-no-overlay").prop('checked')) {
              $("#show-forest-alerts-no-overlay").click();
            }
            $("#forest-loss-year-legend").show();
          } else {
            showHansonLayer = false;
            $("#forest-loss-year-legend").hide();
          }
        }).prop('checked', showHansonLayer);

        $("#show-forest-loss-gain").on("click", function() {
          if ($(this).prop('checked')) {
            showHansonLayer2 = true;
            if ($("#show-forest-change").prop('checked')) {
              $("#show-forest-change").click();
            }
            if ($("#show-animated-forest-loss-gain").prop('checked')) {
              $("#show-animated-forest-loss-gain").click();
            }
            if ($("#show-forest-alerts").prop('checked')) {
              $("#show-forest-alerts").click();
            }
            if ($("#show-forest-alerts-no-overlay").prop('checked')) {
              $("#show-forest-alerts-no-overlay").click();
            }
            $("#forest-loss-gain-legend").show();
          } else {
            showHansonLayer2 = false;
            $("#forest-loss-gain-legend").hide();
          }
        }).prop('checked', showHansonLayer2);

        $("#show-animated-forest-loss-gain").on("click", function() {
          if ($(this).prop('checked')) {
            showAnimatedHansenLayer = true;
            if ($("#show-forest-change").prop('checked')) {
              $("#show-forest-change").click();
            }
            if ($("#show-forest-loss-gain").prop('checked')) {
              $("#show-forest-loss-gain").click();
            }
            if ($("#show-forest-alerts").prop('checked')) {
              $("#show-forest-alerts").click();
            }
            if ($("#show-forest-alerts-no-overlay").prop('checked')) {
              $("#show-forest-alerts-no-overlay").click();
            }
            $("#forest-loss-gain-legend").show();
          } else {
            showAnimatedHansenLayer = false;
            $("#forest-loss-gain-legend").hide();
          }
        }).prop('checked', showViirsLayer);

        $("#show-forest-alerts").on("click", function() {
          // Do not load if Himawari is up
          if ($("#show-himawari").prop('checked')) {
            $(this).prop('checked', false);
            return;
          }
          if ($(this).prop('checked')) {
            timelapse.loadNewTimeline("forest-alerts-times.json","defaultUI");
            showForestAlertsTimeMachineLayer = true;
            if ($("#show-forest-change").prop('checked')) {
              $("#show-forest-change").click();
            }
            if ($("#show-forest-loss-gain").prop('checked')) {
              $("#show-forest-loss-gain").click();
            }
            if ($("#show-animated-forest-loss-gain").prop('checked')) {
              $("#show-animated-forest-loss-gain").click();
            }
            if ($("#show-forest-alerts-no-overlay").prop('checked')) {
              $("#show-forest-alerts-no-overlay").click();
            }
            var v = timelapse.getVideoset();
            v.setFps(10);
            timelapse.setMaxScale(landsatMaxScale);
            timelapse.setDoDwell(false);
            timelapse.setPlaybackRate(1);
            previousVisibleBaseMapLayer = visibleBaseMapLayer;
            visibleBaseMapLayer = "forest-alarms";
          } else {
            showForestAlertsTimeMachineLayer = false;
            if (!showForestAlertsNoOverlayTimeMachineLayer && !showForestAlertsTimeMachineLayer) {
              timelapse.loadNewTimeline("landsat-times-long.json","customUI");
              visibleBaseMapLayer = $("input:radio[name=base-layers]:checked").val();
              timelapse.setMaxScale(landsatMaxScale);
              var v = timelapse.getVideoset();
              v.setFps(10);
              timelapse.setDoDwell(true);
              timelapse.setPlaybackRate(defaultPlaybackSpeed);
            }
          }
        }).prop('checked', showForestAlertsTimeMachineLayer);

        $("#show-forest-alerts-no-overlay").on("click", function() {
          // Do not load if Himawari is up
          if ($("#show-himawari").prop('checked')) {
            $(this).prop('checked', false);
            return;
          }
          if ($(this).prop('checked')) {
            timelapse.loadNewTimeline("forest-alerts-times.json","defaultUI");
            showForestAlertsNoOverlayTimeMachineLayer = true;
            if ($("#show-forest-change").prop('checked')) {
              $("#show-forest-change").click();
            }
            if ($("#show-forest-loss-gain").prop('checked')) {
              $("#show-forest-loss-gain").click();
            }
            if ($("#show-animated-forest-loss-gain").prop('checked')) {
              $("#show-animated-forest-loss-gain").click();
            }
            if ($("#show-forest-alerts").prop('checked')) {
              $("#show-forest-alerts").click();
            }
            var v = timelapse.getVideoset();
            v.setFps(10);
            timelapse.setMaxScale(landsatMaxScale);
            timelapse.setDoDwell(false);
            timelapse.setPlaybackRate(1);
            previousVisibleBaseMapLayer = visibleBaseMapLayer;
            visibleBaseMapLayer = "forest-alarms-no-overlay";
          } else {
            showForestAlertsNoOverlayTimeMachineLayer = false;
            if (!showForestAlertsNoOverlayTimeMachineLayer && !showForestAlertsTimeMachineLayer) {
              timelapse.loadNewTimeline("landsat-times-long.json","customUI");
              visibleBaseMapLayer = $("input:radio[name=base-layers]:checked").val();
              timelapse.setMaxScale(landsatMaxScale);
              var v = timelapse.getVideoset();
              v.setFps(10);
              timelapse.setDoDwell(true);
              timelapse.setPlaybackRate(defaultPlaybackSpeed);
            }
          }
        }).prop('checked', showForestAlertsNoOverlayTimeMachineLayer);

        $("#show-viirs").on("click", function() {
          if ($(this).prop('checked')) {
            showViirsLayer = true;
            timelapse.setPlaybackRate(8);
            timelapse.loadNewTimeline("../createlab-viirs/viirs-times.json","defaultUI");
            timelapse.setDoDwell(false);
            $("#show-additional-landsat").prop("disabled", true);
            $("#fires-at-night-legend").show();
          } else {
            showViirsLayer = false;
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            timelapse.loadNewTimeline("landsat-times-long.json","customUI");
            timelapse.setDoDwell(true);
            $("#show-additional-landsat").prop("disabled", false);
            $("#fires-at-night-legend").hide();
          }
        }).prop('checked', showViirsLayer);

        $("#show-coral").on("click", function() {
          if ($(this).prop('checked')) {
            showCoralBleachingLayer = true;
            showMcrmLayer = true;
            $("#coral-bleaching-legend").show();
          } else {
            showCoralBleachingLayer = false;
            showMcrmLayer = false;
            if (!$("#show-coral-bleaching-alerts").prop('checked'))
            $("#coral-bleaching-legend").hide();
          }
        }).prop('checked', showCoralBleachingLayer);

        $("#show-coral-bleaching-alerts").on("click", function() {
          if ($(this).prop('checked')) {
            timelapse.loadNewTimeline("crw-times.json","defaultUI");
            showCrwTimemachineLayer = true;
            showMcrmLayer = true;
            var v = timelapse.getVideoset();
            v.setFps(22);
            timelapse.setDoDwell(false);
            WebglVideoTile.useGreenScreen = true;
            $("#coral-bleaching-alerts-legend").show();
            $("#coral-bleaching-legend").show();
          } else {
            showCrwTimemachineLayer = false;
            showMcrmLayer = false;
            timelapse.loadNewTimeline("landsat-times-long.json","customUI");
            timelapse.setDoDwell(true);
            WebglVideoTile.useGreenScreen = false;
            var v = timelapse.getVideoset();
            v.setFps(10);
            $("#coral-bleaching-alerts-legend").hide();
            if (!$("#show-coral").prop('checked'))
              $("#coral-bleaching-legend").hide();
          }
        }).prop('checked', showCrwTimemachineLayer);

        $("#show-himawari").on("click", function() {
          if ($(this).prop('checked')) {
            timelapse.loadNewTimeline("himawari-times.json","defaultUI");
            showHimawariTimeMachineLayer = true;
            var v = timelapse.getVideoset();
            v.setFps(12);
            timelapse.setMaxScale(himawariMaxScale);
            timelapse.setDoDwell(false);
            timelapse.setPlaybackRate(1);
            previousVisibleBaseMapLayer = visibleBaseMapLayer;
            visibleBaseMapLayer = "himawari";
            $(".vector-legend").hide();
          } else {
            showHimawariTimeMachineLayer = false;
            timelapse.loadNewTimeline("landsat-times-long.json","customUI");
            var v = timelapse.getVideoset();
            v.setFps(10);
            visibleBaseMapLayer = previousVisibleBaseMapLayer;
            timelapse.setMaxScale(landsatMaxScale);
            timelapse.setDoDwell(true);
            timelapse.setPlaybackRate(defaultPlaybackSpeed);
            $(".vector-legend").hide();
          }
          timelapse.warpTo(timelapse.getHomeView());
        }).prop('checked', showHimawariTimeMachineLayer);

        $("#show-usgs-windturbine").on("click", function() {
          if ($(this).prop('checked')) {
            showUsgsWindTurbineLayer = true;
            $("#wind-installs-legend").show();
          } else {
            showUsgsWindTurbineLayer = false;
            $("#wind-installs-legend").hide();
          }
        }).prop('checked', showUsgsWindTurbineLayer);

        $("#show-solar-installs").on("click", function() {
          if ($(this).prop('checked')) {
            showSolarInstallsLayer = true;
            $("#solar-installs-legend").show();
          } else {
            showSolarInstallsLayer = false;
            $("#solar-installs-legend").hide();
          }
        }).prop('checked', showSolarInstallsLayer);

        $("#show-drilling").on("click", function() {
          if ($(this).prop('checked')) {
            showDrillingLayer = true;
            $("#drilling-legend").show();
          } else {
            showDrillingLayer = false;
            $("#drilling-legend").hide();
          }
        }).prop('checked', showDrillingLayer);

        $("#show-lights-at-night").on("click", function() {
          if ($(this).prop('checked')) {
            showLightsAtNightLayer = true;
            $("#lights-at-night-legend").show();
          } else {
            showLightsAtNightLayer = false;
            $("#lights-at-night-legend").hide();
          }
        }).prop('checked', showCoralBleachingLayer);

        // Set the starting base layer
        $("input:radio[name=base-layers]").on("click", function() {
          visibleBaseMapLayer = $(this).val();
        });
        $('input:radio[name=base-layers][id=' + visibleBaseMapLayer + '-base]').prop('checked', true);

        // Copy over data attributes to selectmenu
        $.widget("ui.selectmenu", $.ui.selectmenu, {
          _renderItem: function( ul, item ) {
            var elementdata = item.element.context.dataset;
            var attributesObj = {};
            Object.keys(elementdata).forEach(function(x){
            attributesObj["data-" + x] = elementdata[x];
          });
          return $( '<li>' )
            .attr(attributesObj)
            .append(item.label)
            .appendTo( ul );
          }
        });

        var appendTarget = "#timeMachine";
        if(enableLetterboxMode) {
          appendTarget = "#content";
        }
        $("#extras-selector").selectmenu({
          position: {
            at : "left top",
            collision: 'flip',
            using: function(coords, feedback) {
              // Using 'flip' above, we ensure that the menu either draws up or down, depending upon how much space we have.
              // Then we place the default select option at either the begining or end based on this direction.
              $("#extras-selector option[id='default-extras-select']").remove();
              $(this).css({top: coords.top, left: coords.left});
              if (feedback.vertical == "top")
                $("#extras-selector").prepend('<option id="default-extras-select" selected="selected" value="select">Select extra content...</option>');
              else
                $("#extras-selector").append('<option id="default-extras-select" selected="selected" value="select">Select extra content...</option>');
              $("#extras-selector").selectmenu("refresh");
            }
          },
          appendTo: appendTarget
        });

        // Use click event rather than selectmenu 'change' since that event is not registered on the touch screen.
        $(".ui-selectmenu-menu").on("click", "li", function(e) {
            var fileName = $(e.currentTarget).data("filename");
            var fileType = $(e.currentTarget).data("type");
            $("#extras-content").dialog('option', 'title', $(e.currentTarget).text());
            var $extrasHtml = "";
            if (fileType == "image") {
              $extrasHtml = '<img src="../../../extras/' + fileName + '">';
              $("#extras-content").html($extrasHtml).dialog("open");
            } else if (fileType == "video") {
              $extrasHtml = '<video id="extras-video" src="../../../extras/' + fileName + '" controls autoplay></video>';
              $("#extras-content").html($extrasHtml).dialog("open");
              $("#extras-video")[0].playbackRate = $(e.currentTarget).data("fileplaybackrate");
              $("#extras-video").gVideo({
                childtheme:'smalldark'
              });
            } else if (fileType == "iframe") {
              $extrasHtml = '<iframe style="border: 0px; scrolling: no; width: 100%; height: 100%" src="' + $(e.currentTarget).data("linkpath") + '"></iframe>';
              $("#extras-content").html($extrasHtml).dialog("open");
            } else if (fileType == "img") {
              $extrasHtml = '<img height="100%" style="display: block; margin: 0 auto;" src="../../../extras/' + $(e.currentTarget).data("linkpath") + '">';
              $("#extras-content").html($extrasHtml).dialog("open");
            } else if (fileType == "link") {
              window.location.href = $(e.currentTarget).data("linkpath");
            }
        });

        $("#extras-content").dialog({
          appendTo: "#timeMachine",
          modal: false,
          autoOpen: false,
          draggable: false,
          resizable: false,
          dialogClass: "extras-content-video",
          beforeClose: function(event, ui) {
            var $extrasVideo  = $("#extras-video");
            if ($extrasVideo && $extrasVideo[0]) {
              $extrasVideo[0].pause();
              $extrasVideo[0].src = "";
            }
            $("#extras-selector").val("select").selectmenu('refresh');
          }
        }).css({
          'z-index': '2000',
          'left': '0px',
          'top':'0px'
        });

        $(window).resize(function () {
          var width = $(window).width();
          var height = $(window).height();
          var scale = Math.min(1, Math.min((width * 1.8) / 1920, (height * 1.28) / 1200));
          if (!enableLetterboxMode) {
            $('.vector-layers').css({'transform-origin': 'bottom right'});
            $('.vector-layers').css({'transform': 'scale(' + scale + ')'});
          }
          if (!isHyperwall && enableLetterboxMode) {
            scale = Math.min(1, Math.min(width / 1920, height / 1080));
            $('.map-layer-div').css({'transform-origin': 'center right', 'transform': 'scale(' + scale + ')'});
            $('.base-map-div').css({'transform-origin': 'center left', 'transform': 'scale(' + scale + ')'});
            $('.extras-selector-div, .location_search_div').css({'transform-origin': 'center left', 'transform': 'scale(' + '0.9' + ')'});
          }
        });

        $('.map-layer-checkbox').on("click", function() {
          var selectedLayers = $('.map-layer-checkbox input:checked');
          var numLayersOn = selectedLayers.size();
          var continueState = true;
          selectedLayers.each(function(){
            if (this.id.indexOf("himawari") > 0) {
              continueState = false;
            } else if (this.id.indexOf("forest-alerts") > 0) {
              continueState = false;
            }
          });
          if (!continueState) return;
          if (numLayersOn == 0) {
            $(".vector-legend").hide();
          } else {
            $(".vector-legend").show();
          }
        });
      }
    </script>

    <script src="../../js/TimeMachineCanvasLayer.js" type="text/javascript"></script>

    <script type="text/javascript" src="../../js/base.js"></script>
    <script type="text/javascript" src="../../js/io.js"></script>
    <script type="text/javascript" src="../../js/utils.js"></script>

    <script type="text/javascript">
      "use strict";

      /* begin stats */
      /*var stats = new Stats();
      stats.setMode(0); // 0: fps, 1: ms
      // Align top-left
      stats.domElement.style.position = 'absolute';
      stats.domElement.style.left = '0px';
      stats.domElement.style.top = '0px';*/
      /* end stats */

      // BEGIN WebGL vars
      var canvasLayer;
      var gl, glb;

      var showWdpaLayer = false;
      var showMcrmLayer = false;
      var showHansonLayer = false;
      var showHansonLayer2 = false;
      var showViirsLayer = false;
      var showCoralBleachingLayer = false;
      var showLightsAtNightLayer = false;
      var showCrwTimemachineLayer = false;
      var showAnimatedHansenLayer = false;
      var showHimawariTimeMachineLayer = false;
      var showForestAlertsTimeMachineLayer = false;
      var showForestAlertsNoOverlayTimeMachineLayer = false;
      var showWaterOccurrenceLayer = false;
      var showWaterChangeLayer = false;

      var showUsgsWindTurbineLayer = false;
      var showSolarInstallsLayer = false;
      var showDrillingLayer = false;

      var tileViewVisibility = {
        videoTile: true,
        vectorTile: false
      };

      function onTimeMachinePlayerReady() {
        // initialize the canvasLayer
        var timeMachineCanvasLayerOptions = {
          timelapse: timelapse,
          resizeHandler: resize,
          animate: true,
          updateHandler: update,
          resolutionScale: window.devicePixelRatio || 1
        };
        canvasLayer = new TimeMachineCanvasLayer(timeMachineCanvasLayerOptions);

        // initialize WebGL
        gl = canvasLayer.canvas.getContext('experimental-webgl');
        glb = new Glb(gl);

        var layer_html = '';

        layer_html += '<div class="vector-layers">';

        var landsat_base_str = '<label class="landsat-select" for="landsat-base"><input type="radio" id="landsat-base" name="base-layers" value="landsat"/>Earth Engine Timelapse<span class="credit"> (Google)</span></label>';
        var landsat_base = '<td colspan="2">' + landsat_base_str + '</td>';
        var light_base = '<td><label for="light-base"><input type="radio" id="light-base" name="base-layers" value="light"/><span>Light Map</span></label></td>';
        var dark_base = '<td><label for="dark-base"><input type="radio" id="dark-base" name="base-layers" value="dark"/><span>Dark Map</span></label></td>';

        var show_wdpa = '<td class="wdpa-select"><label for="show-wdpa"><input type="checkbox" id="show-wdpa" value="1"/>Protected Areas<span class="credit"> (UNEP-WCMC)</span></label></td>';
        var show_forest_change = '<td class="forest-change-select"><label for="show-forest-change"><input type="checkbox" id="show-forest-change" value="2"/>Forest Loss by Year<span class="credit"> (Hansen et al)</span></label></td>';
        var show_viirs = '<td class="viirs-select"><label for="show-viirs"><input type="checkbox" id="show-viirs" value="3"/>Fires at Night<span class="credit"> (NOAA)</span></label></td>';
        var show_forest_loss_gain = '<td class="forest-loss-gain-select"><label for="show-forest-loss-gain"><input type="checkbox" id="show-forest-loss-gain" value="4"/>Forest Loss/Gain<span class="credit"> (Hansen et al)</span></label></td>';
        var show_animated_forest_loss_gain = '<td class="animated-forest-loss-select"><label for="show-animated-forest-loss-gain"><input type="checkbox" id="show-animated-forest-loss-gain" value="5" />Animated Loss/Gain<span class="credit"> (Hansen et al)</span></label></td>';
        var show_forest_alerts = '<td class="forest-alerts-select"><label for="show-forest-alerts"><input type="checkbox" id="show-forest-alerts" value="13"/>Forest Loss Alerts<span class="credit"> (Hansen et al)</span></label></td>';
        var show_forest_alert_no_overlay = '<td class="forest-alerts-no-overlay-select"><label for="show-forest-alerts-no-overlay"><input type="checkbox" id="show-forest-alerts-no-overlay" value="13"/>Forest Loss Alerts <span style="font-size: 14px">(No Overlay)</span><span class="credit"> (Hansen et al)</span></label></td>';
        var show_lights_at_night = '<td class="lights-at-night-select"><label for="show-lights-at-night"><input type="checkbox" id="show-lights-at-night" value="6"/>Lights at Night<span class="credit"> (NOAA, Google)</span></label></td>';
        var show_coral = '<td class="coral-select"><label for="show-coral"><input type="checkbox" id="show-coral" value="7"/>Coral Bleaching<span class="credit"> (NOAA, UNEP-WCMC)</span></label></td>';
        var show_coral_bleaching_alerts = '<td class="coral-bleaching-select"><label for="show-coral-bleaching-alerts"><input type="checkbox" id="show-coral-bleaching-alerts" value="8"/>Coral Reef Watch<span class="credit"> (NOAA, UNEP-WCMC)</span></label></td>';
        var show_usgs_windturbine = '<td class="wind-select"><label for="show-usgs-windturbine"><input type="checkbox" id="show-usgs-windturbine" value="9"/>Wind Power (USA)<span class="credit" style=""> (USGS)</span></label></td>';
        var show_solar_installs = '<td class="solar-select"> <label for="show-solar-installs"><input type="checkbox" id="show-solar-installs" value="10"/>Solar PV (USA)<span class="credit"> (NREL)</span></label></td>';
        var show_drilling = '<td class="drilling-select"><label for="show-drilling"><input type="checkbox" id="show-drilling" value="11"/>Oil/Gas Drilling<span class="credit"> (CREATE Lab)</span></label></td>';
        var show_himawari = '<td class="himawari-select"><label for="show-himawari"><input type="checkbox" id="show-himawari" value="12"/>Himawari-8<span class="credit"> (JMA)</span></label></td>';
        var show_water_occurrence = '<td class="water-occurrence-select"><label for="show-water-occurrence"><input type="checkbox" id="show-water-occurrence" value="14"/>Water Occurrence<span class="credit"> (JRC)</span></label></td>';
        var show_water_change = '<td class="water-change-select"><label for="show-water-change"><input type="checkbox" id="show-water-change" value="15"/>Water Change<span class="credit"> (JRC)</span></label></td>';

        if (enableLetterboxMode) {
          layer_html += '<div class="base-map-div">';
          layer_html += ' <table class="base-map-radio" cellspacing="3">';
          layer_html += '   <tr>';
          layer_html += landsat_base;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += light_base;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += dark_base;
          layer_html += '   </tr>';
          layer_html += ' </table>';
          layer_html += '</div>';
          layer_html += '<div class="map-layer-div">';
          layer_html += ' <table class="map-layer-checkbox" cellspacing="3">';
          layer_html += '   <tr>';
          layer_html += show_viirs;
          layer_html += show_solar_installs;
          layer_html += show_coral;
          layer_html += show_forest_change;
          layer_html += show_forest_alerts;
          layer_html += show_himawari;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_lights_at_night;
          layer_html += show_usgs_windturbine;
          layer_html += show_water_occurrence;
          layer_html += show_forest_loss_gain;
          layer_html += show_forest_alert_no_overlay;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_drilling;
          layer_html += show_coral_bleaching_alerts;
          layer_html += show_water_change;
          layer_html += show_animated_forest_loss_gain;
          layer_html += show_wdpa;
          layer_html += '   </tr>';
          layer_html += ' </table>';
          layer_html += '</div>';
        } else {
          layer_html += '<div class="base-map-div">';
          layer_html += ' <table class="base-map-radio" cellspacing="0">';
          layer_html += '   <tr>';
          layer_html += landsat_base;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += light_base;
          layer_html += dark_base;
          layer_html += '   </tr>';
          layer_html += ' </table>';
          layer_html += '</div>';
          layer_html += '<div class="map-layer-div">';
          layer_html += ' <table class="map-layer-checkbox" cellspacing="0">';
          layer_html += '   <tr>';
          layer_html += show_wdpa;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_forest_change;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_forest_loss_gain;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_animated_forest_loss_gain;
          layer_html += '   </tr>';
          /*layer_html += '   <tr>';
          layer_html += show_forest_alerts;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_forest_alert_no_overlay;
          layer_html += '   </tr>';*/
          layer_html += '   <tr>';
          layer_html += show_viirs;
          layer_html += '   </tr>';
          layer_html += show_lights_at_night;
          layer_html += '   <tr>';
          layer_html += show_coral;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_coral_bleaching_alerts;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_usgs_windturbine;
          layer_html += '   </tr>';
          layer_html += '   <tr>';
          layer_html += show_solar_installs;
          layer_html += '   </tr>';
          /*layer_html += '   <tr>';
          layer_html += show_drilling;
          layer_html += '   </tr>';*/
          layer_html += '   <tr>';
          layer_html += show_himawari;
          layer_html += '   </tr>';
          layer_html += ' </table>';
          layer_html += '</div>';
        }

        layer_html += '<div class="extras-selector-div">';
        layer_html += ' <select name="extras-selector" id="extras-selector">';
        layer_html += '   <option id="default-extras-select" selected="selected" value="select">Select extra content...</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="pumphandle_2014.mp4">Measured CO2 Over Time</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Carbon Dioxide 2006 GEOS-5 model.mp4">CO2 2006 GEOS-5 Model</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Land + Ocean Average Temperature Annual Anomaly.mp4">Temperature Anomaly 1850-2013</option>';
        layer_html += '   <option data-file-playback-rate="0.5" data-type="video" data-file-name="berkeley-earth.mp4">Temperature Anomaly 1850-2015</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic ice age, 1987-2014.mp4">Ice Thinning 1987-2014</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Larsen-B-Collapse.mp4">Larsen-B Collapse</option>';
        layer_html += '   <option data-file-playback-rate="4" data-type="video" data-file-name="Orbiting Carbon Observatory.mp4">Orbiting Carbon Observatory</option>';
        layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic Sea Ice, September 1979 to September 2014.mp4">Sea Ice Concentration 1979-2014</option>';
        layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="coral-reef-watch-daily-7day-max.mp4">Coral Reef Watch 2013-2015</option>';
        layer_html += '   <option data-file-playback-rate="0.5" data-type="video" data-file-name="merra-spi.mp4">Standardized Precipitation Index 1980-2015</option>';
        layer_html += '   <option data-type="iframe" data-link-path="http://choices.climatecentral.org/widget.html?utm_source=Davos&utm_medium=embed&utm_campaign=SSMC-Map#11/31.2301/121.4736?compare=temperatures&carbon-end-yr=2100&scenario-a=warming-4&scenario-b=warming-2&presentation=1">Shanghai Sea Level</option>';
        layer_html += '   <option data-type="img" data-link-path="land-and-ocean-temps.png">2015: Hottest Year on Record</option>';
        if (showEVA)
          layer_html += '   <option data-type="link" data-link-path="http://localhost:8080/?uid=history-1436384863961-Vyxt6PIO">EVA - Explorable Visual Analytics</option>';
        layer_html += ' </select>';
        layer_html += '</div>';

        layer_html += '</div>';

        var legend_html = '<div class="vector-legend">';
        legend_html += '<div id="legend-content">';
        legend_html += '<table cellpadding=5>';
        legend_html += '<tr id="wdpa-legend" style="display: none"><td><div style="background-color:#33da4f; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -11px; font-size: 17px">Protected Areas</div></td></tr>';
        legend_html += '<tr id="forest-loss-year-legend" style="display: none"><td><div style="font-size: 17px">Forest Loss By Year</div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">2000</div><div style="margin-top: 3px; float: left; background-image: -webkit-linear-gradient(left, yellow, orange 65%, red 100%);background-image: linear-gradient(left, yellow, orange 65%, red 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">2014</div></div></td></tr>';
        legend_html += '<tr id="forest-loss-gain-legend" style="display: none; font-size: 14px;"><td><div style="font-size: 17px">Forest Loss/Gain 2000-2014</div><div style="float: left; padding-right:8px"><div style="background-color:#00e000; width: 12px; height: 12px; float: left; margin-top: 2px; margin-left: 8px;"></div>&nbsp;Extent</div><div style="float: left; padding-right:8px"><div style="background-color:#ff0000; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Loss</div><div style="float: left; padding-right:8px"><div style="background-color:#0000ff; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Gain</div><div><div style="background-color:#ff00ff; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Both</div></td></tr>';
        legend_html += '<tr id="fires-at-night-legend" style="display: none"><td><div style="background-color:#eda46a; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Fires At Night</div></td></tr>';
        legend_html += '<tr id="lights-at-night-legend" style="display: none"><td><div style="font-size: 17px">Lights at Night over 25 Years</div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">Decrease</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, #4848FD, green 50%, red 100%);background-image: linear-gradient(left, #4848FD, green 50%, red 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">Increase</div></td></tr>';
        legend_html += '<tr id="coral-bleaching-legend" style="display: none"><td><div style="float:left; background-color:#fa13ab; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -5px; font-size: 17px">Coral Reefs</div></td></tr>';
        legend_html += '<tr id="coral-bleaching-alerts-legend" style="display: none"><td><div style="font-size: 17px">Coral Reef Watch</div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">Watch</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, #ffff00, #fbb404 65%, #a00200 100%);background-image: linear-gradient(left, #ffff00, #fbb404 65%, #a00200 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">Alert</div></td></tr>';
        legend_html += '<tr id="wind-installs-legend" style="display: none"><td><div style="background-color:#a0fe8f; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">Wind Power (USA)</div></div></td></tr>';
        legend_html += '<tr id="solar-installs-legend" style="display: none"><td><div style="background-color:#7376b2; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">Solar Photovoltaic (USA)</div></td></tr>';
        legend_html += '<tr id="drilling-legend" style="display: none"><td><div style="background-color:#eda46a; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Oil/Gass Drilling (USA)</div></td></tr>';
        legend_html += '<tr id="water-occurrence-legend" style="display: none"><td><div style="font-size: 17px">Water Occurrence 1984-2015</div><div style="margin-left: 8px"><div style="font-size: 13px; float: left">100%</div><div style="font-size: 13px; float: right;">0%</div><div class="waterLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">Always water</div><div style="font-size: 13px; float: right">Never water</div></div></td></tr>';
        legend_html += '<tr id="water-change-legend" style="display: none"><td><div style="font-size: 17px">Water Change 1984-1999 to 2000-2015</div><div style="margin-left: 8px"><div class="waterChangeLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">Water Loss</div><div style="font-size: 13px; float: right">Water Gain</div></div></td></tr>';
        legend_html += '</table>';
        legend_html += '</div>';
        legend_html += '</div>';

        if (enableLetterboxMode) {
          $(layer_html).appendTo($("#content"));
          $(legend_html).appendTo($("#content"));
          $("#presentation-slider-selection, .base-map-radio, .map-layer-checkbox, .extras-selector, .presentationSlider, .vector-legend").addClass("letterbox");
          $(".base-map-div, .map-layer-div, .extras-selector-div").addClass("top-panel letterbox");
          $(".current-location-text, .landsat-select, .wdpa-select, .forest-change-select, .viirs-select, .forest-loss-gain-select, .animated-forest-loss-select, .forest-alerts-select, .forest-alerts-no-overlay-select, .lights-at-night-select, .coral-select, .coral-bleaching-select, .wind-select, .solar-select, .drilling-select, .himawari-select, .water-occurrence-select, .water-change-select").addClass("letterbox");
        } else {
          $(layer_html).appendTo($("#timeMachine .player"));
          $(legend_html).appendTo($("#timeMachine .player"));
          $(".vector-layers").addClass("right-panel");
        }

        if (isHyperwall) {
          $(".vector-layers, .sideToolBar, .vector-legend, #presentation-slider-selection, .base-map-div").addClass("hyperwall");
        }

        //// Time Machine layers

        // Landsat
        var defaultTimeMachineLayerOptions = {
          mediaType: ".mp4",
          numFrames: 32,
          fps: 10
        };
        landsatBaseMapLayer = new WebglTimeMachineLayer(glb, canvasLayer, landsatUrl, defaultTimeMachineLayerOptions);

        // Coral Bleaching Alerts
        var crwTimemacineLayerOptions = {
          mediaType: ".mp4",
          numFrames: 904,
          fps: 22,
          video_width: 1424,
          video_height: 800,
          width: 7200,
          height: 7200,
          greenScreen: true
        };
        crwTimemachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, crwTimemachineUrl, crwTimemacineLayerOptions);

        // Himawari-8
        var himawariTimeMachineLayerOptions = {
          mediaType: ".mp4",
          numFrames: 4249,
          fps: 12,
          nLevels: 4,
          video_width: 1424,
          video_height: 800,
          width: 11000,
          height: 11000
        };
        himawariTimemachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, himawariTimemachineUrl, himawariTimeMachineLayerOptions);

        // Forest Alerts
        var forestAlertsTimeMachineLayerOptions = {
          mediaType: ".mp4",
          numFrames: 183,
          fps: 10,
          nLevels: 11,
          video_width: 1424,
          video_height: 800,
          width: 750836,
          height: 156136
        };
        forestAlertsTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsTimeMachineUrl, forestAlertsTimeMachineLayerOptions);
        // Forest Alerts No Overlay
        forestAlertsNoOverlayTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsNoOverlayTimeMachineUrl, forestAlertsTimeMachineLayerOptions);


        //// Raster map layers

        var defaultMapLayerOptions = {
          nLevels: 12,
          tileWidth: 256,
          tileHeight: 256
        };
        var defaultBaseMapLayerOptions = {
          nLevels: 11,
          tileWidth: 256,
          tileHeight: 256
        };
        var retinaMapLayerOptions = {
          nLevels: 11,
          tileWidth: 512,
          tileHeight: 512
        };
         var lightsAtNightMapLayerOptions = {
          nLevels: 8,
          tileWidth: 256,
          tileHeight: 256
        };

        var lightTileUrl = useGoogleMaps ? googleMapsDefaultRetinaUrl : osmLightRetinaUrl;
        var darkTileUrl = useGoogleMaps ? googleMapsDarkStyleRetinaUrl : osmDarkRetinaUrl;

        var mapBaseLayerOptions = isHyperwall ? retinaMapLayerOptions : defaultBaseMapLayerOptions;

        lightBaseMapLayer = new WebglMapLayer(glb, canvasLayer, lightTileUrl, mapBaseLayerOptions);
        darkBaseMapLayer = new WebglMapLayer(glb, canvasLayer, darkTileUrl, mapBaseLayerOptions);
        hansonMapLayer = new WebglMapLayer(glb, canvasLayer, gfcTransUrl, defaultMapLayerOptions);
        hansonMapLayer2 = new WebglMapLayer(glb, canvasLayer, gfcLossGainUrl, defaultMapLayerOptions);
        wdpaVectorLayer = new WebglVectorLayer(glb, canvasLayer, wdpaUrl, defaultMapLayerOptions);
        mcrmVectorLayer = new WebglVectorLayer2(glb, canvasLayer, mcrmUrl, defaultBaseMapLayerOptions);
        lightsAtNightMapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNightUrl, lightsAtNightMapLayerOptions);
        waterOccurrenceLayer = new WebglMapLayer(glb, canvasLayer, waterOccurrenceUrl, defaultBaseMapLayerOptions);
        waterChangeLayer = new WebglMapLayer(glb, canvasLayer, waterChangeUrl, defaultBaseMapLayerOptions);

        // VIIRS is just a single tile
        viirsTile = new WebglViirsTile(glb, viirsUrl);
        coralBleachingTile = new WebglCoralTile(glb, coralBleachingUrl);

        var animatedHansenLayerOptions = {
          nLevels: 12,
          tileWidth: 256,
          tileHeight: 256
        };
        animatedHansenLayer = new WebglMapLayer2(glb, canvasLayer, animatedHansenUrls, animatedHansenLayerOptions);

        var usgsWindturbineLayerOptions = {
          tileWidth: 256,
          tileHeight: 256,
          nLevels: 0,
          setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
          drawFunction: WebGLVectorTile2.prototype._drawPoints,
          fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
          vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
        };
        usgsWindTurbineLayer  = new WebglVectorLayer2(glb, canvasLayer, usgsWindTurbineUrl, usgsWindturbineLayerOptions);

        var solarInstallsLayerOptions = {
          tileWidth: 256,
          tileHeight: 256,
          nLevels: 0,
          setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
          drawFunction: WebGLVectorTile2.prototype._drawPoints,
          fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
          vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
        };
        solarInstallsLayer  = new WebglVectorLayer2(glb, canvasLayer, solarInstallsUrl, solarInstallsLayerOptions);

        var drillingLayerOptions = {
          tileWidth: 256,
          tileHeight: 256,
          nLevels: 0,
          setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
          drawFunction: WebGLVectorTile2.prototype._drawPoints,
          fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
          vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
        };
        drillingLayer  = new WebglVectorLayer2(glb, canvasLayer, drillingUrl, drillingLayerOptions);

        // Layer Toggle UI
        initLayerToggleUI();
        $(".googleLogo").html("Google Earth Engine");

        // Load waypoints
        timelapse.loadSharedDataFromUnsafeURL(presentationSliderContent);

        if (enableRecordingMode) {
          var snaplapse = timelapse.getSnaplapse();
          if (snaplapse) {
            snaplapse.getSnaplapseViewer().setToRecordingMode();
          }
        }

        // Toggle layers off when auto mode begins
        var snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
        var snaplapseViewerForPresentationSlider;
        if (snaplapseForPresentationSlider) {
          snaplapseViewerForPresentationSlider = snaplapseForPresentationSlider.getSnaplapseViewer();
        }

        if (snaplapseViewerForPresentationSlider) {
          // Change UI based on whether setup is a hyperwall or not
          snaplapseViewerForPresentationSlider.addEventListener('snaplapse-loaded', function() {
            var $elements = $('.presentationSlider, .snaplapse_keyframe_container, .keyframeSubtitleBoxForHovering, .snaplapse_keyframe_list_item_presentation, .snaplapse_keyframe_list_item_thumbnail_overlay_presentation');
            if (isHyperwall)
              $elements.addClass('hyperwall');
            if (enableLetterboxMode)
              $elements.addClass('letterbox');
            if (enableRecordingMode)
              $elements.addClass('recording');
            $(".snaplapse_keyframe_container").scrollLeft(0);
          });
        }

        $('.current-location-text').click(function() {
          $('.current-location-text').hide();
        });


        var himawariWaypointIndicies = [81, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120];

        // TODO: Refactor how this is handled and how layers turn on/off in general
        if (snaplapseViewerForPresentationSlider) {
          snaplapseViewerForPresentationSlider.addEventListener('slide-before-changed', function(waypointTitle, waypointIndex, waypointBounds) {
            isAutoModeRunning = snaplapseViewerForPresentationSlider.isAutoModeRunning();
            if (himawariWaypointIndicies.indexOf(waypointIndex) > -1) timelapse.setMaxScale(himawariMaxScale);
            else timelapse.setMaxScale(landsatMaxScale);
          });

          snaplapseViewerForPresentationSlider.addEventListener('slide-changed', function(waypointTitle, waypointIndex, waypointBounds) {
            // Display info box for the waypoints
            if (enableWaypointText && WAYPOINT_TEXT) {
              var waypointScale = timelapse.pixelBoundingBoxToPixelCenter(waypointBounds).scale;
              var $current_location_text = $(".current-location-text");

              timelapse.removeViewChangeListener(waypointViewChangeListener);
              timelapse.removeViewChangeListener(hideWaypointListener);
              waypointViewChangeListener = function() {
                var currentView = timelapse.getView();
                if (currentView.scale * 2.5 > waypointScale && (currentView.x >= waypointBounds.xmin && currentView.x <= waypointBounds.xmax && currentView.y >= waypointBounds.ymin && currentView.y <= waypointBounds.ymax)) {
                  if (WAYPOINT_TEXT && WAYPOINT_TEXT[waypointIndex].title) {
                    $current_location_text.show();
                    $current_location_text.find("h3").text(WAYPOINT_TEXT[waypointIndex].title);
                    $current_location_text.find("p").text(WAYPOINT_TEXT[waypointIndex].text);
                    previousWaypoint.scale = waypointScale;
                    previousWaypoint.bounds = waypointBounds;
                    hideWaypointListener = function() {
                      var currentView = timelapse.getView();
                      var previousWaypointBounds = previousWaypoint.bounds;
                      if ((previousWaypoint.scale / 2.5 > currentView.scale || !(currentView.x >= previousWaypointBounds.xmin && currentView.x <= previousWaypointBounds.xmax && currentView.y >= previousWaypointBounds.ymin && currentView.y <= previousWaypointBounds.ymax))) {
                        $(".current-location-text").hide();
                        timelapse.removeViewChangeListener(hideWaypointListener);
                      }
                    };
                    timelapse.addViewChangeListener(hideWaypointListener);
                  } else {
                    $(".current-location-text").hide();
                  }
                  timelapse.removeViewChangeListener(waypointViewChangeListener);
                } else {
                  $(".current-location-text").hide();
                }
              };
              timelapse.addViewChangeListener(waypointViewChangeListener);
            }

            // Earth Engine Timelapse
            var $landsatToggle = $("#landsat-base");
            // Light Map
            var $lightMapToggle = $("#light-base");
            // Dark Map
            var $darkMapToggle = $("#dark-base");
            // Protected Areas
            var $wdpaLayerToggle = $("#show-wdpa");
            // Forest Loss By Year
            var $globalForestLayerToggle = $("#show-forest-change");
            // Forest Loss/Gain
            var $globalForestLossLayerToggle = $("#show-forest-loss-gain");
            // Animated Fotest Loss/Gain
            var $animatedGlobalForestLossLayerToggle = $("#show-animated-forest-loss-gain");
            // Forest Loss Alerts
            var $forestLossAlarmsLayerToggle = $("show-forest-alerts");
            // Forest Loss Alerts No Overlay
            var $forestLossAlarmsNoOverlayLayerToggle = $("show-forest-alerts-no-overlay");
            // Fires at Night
            var $viirsLayerToggle = $("#show-viirs");
            // Lights at Night
            var $lightsAtNightToggle = $("#show-lights-at-night");
            // Coral Bleaching
            var $coralLayerToggle = $("#show-coral");
            // Coral Bleaching Alerts
            var $coralBleachingAlertsLayerToggle = $("#show-coral-bleaching-alerts");
            // Wind Power
            var $usgsWindTurbineLayerToggle = $("#show-usgs-windturbine");
            // Solar Power
            var $solarInstallsLayerToggle = $("#show-solar-installs");
            // Drilling
            var $drillingLayerToggle = $("#show-drilling");
            // Himawari-8
            var $himawariLayerToggle = $("#show-himawari");
            // Water Occurrence
            var $waterOccurrenceToggle = $("#show-water-occurrence");
            // Water Change
            var $waterChangeToggle = $("#show-water-change");

            // Default to Landsat turned on
            $landsatToggle.click();

            //// Clear out layers if they were already checked

            if ($wdpaLayerToggle.prop('checked')) {
              $wdpaLayerToggle.click();
            }
            if ($globalForestLayerToggle.prop('checked')) {
              $globalForestLayerToggle.click();
            }
            if ($globalForestLossLayerToggle.prop('checked')) {
              $globalForestLossLayerToggle.click();
            }
            if ($animatedGlobalForestLossLayerToggle.prop('checked')) {
              $animatedGlobalForestLossLayerToggle.click();
            }
            if ($forestLossAlarmsLayerToggle.prop('checked')) {
              $forestLossAlarmsLayerToggle.click();
            }
            if ($forestLossAlarmsNoOverlayLayerToggle.prop('checked')) {
              $forestLossAlarmsNoOverlayLayerToggle.click();
            }
            if ($lightsAtNightToggle.prop('checked')) {
              $lightsAtNightToggle.click();
            }
            if ($coralLayerToggle.prop('checked')) {
              $coralLayerToggle.click();
            }
            if ($coralBleachingAlertsLayerToggle.prop('checked')) {
              $coralBleachingAlertsLayerToggle.click();
            }
            if ($usgsWindTurbineLayerToggle.prop('checked')) {
              $usgsWindTurbineLayerToggle.click();
            }
            if ($solarInstallsLayerToggle.prop('checked')) {
              $solarInstallsLayerToggle.click();
            }
            if ($drillingLayerToggle.prop('checked')) {
              $drillingLayerToggle.click();
            }
            if ($waterOccurrenceToggle.prop('checked')) {
              $waterOccurrenceToggle.click();
            }
            if ($waterChangeToggle.prop('checked')) {
              $waterChangeToggle.click();
            }

            //// Set layers based on selected waypoint ////

            // VIIRS specific waypoints
            // Issues arise if VIIRS waypoints are not handled first
            if ((waypointIndex >= 1 && waypointIndex <= 5) || (waypointIndex >= 63 && waypointIndex <= 65)) {
              if (!$viirsLayerToggle.prop('checked')) {
                $viirsLayerToggle.click();
              }
              if (!$darkMapToggle.prop('checked')) {
                $darkMapToggle.click();
              }
            } else {
              if ($viirsLayerToggle.prop('checked')) {
                $viirsLayerToggle.click();
                timelapse.setPlaybackRate(defaultPlaybackSpeed);
              }
            }
            // End VIIRS

            // Himawari
            // Must be after VIIRS but before other waypoints
            var isHimawariLayerOn = $himawariLayerToggle.prop('checked');

            var initialHimawariViewChangeHack = function() {
              if (isAutoModeRunning) {
                snaplapseViewerForPresentationSlider.startAutoModeWaypointTimeout();
              } else {
                snaplapseViewerForPresentationSlider.startAutoModeIdleTimeout();
              }
            };

            var setHimawariView = function(himawariBoundingBox, himawariTime, himawariPlaybackSpeed) {
              var himawariView = {bbox : himawariBoundingBox};
              if (!isHimawariLayerOn) {
                loadHimawari();
                timelapse.stopParabolicMotion();
                timelapse.setNewView(himawariView, true, null, initialHimawariViewChangeHack);
              } else {
                timelapse.stopParabolicMotion();
                timelapse.setNewView(himawariView);
              }
              timelapse.setPlaybackRate(himawariPlaybackSpeed);
              setTimeout(function() {
                timelapse.seek(himawariTime);
              }, 150);
            };

            if (waypointIndex == himawariWaypointIndicies[0]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 245106.46412122744, y: 727021.4061973379, scale: 0.019163055706363917}).bbox;
              setHimawariView(waypointBounds, 47.67, 0.5);
            } else if (waypointIndex == himawariWaypointIndicies[1]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 670030.661392405, y: 760918.1012658221, scale: 0.0004731126771739602}).bbox;
              setHimawariView(waypointBounds, 0, 1);
            } else if (waypointIndex == himawariWaypointIndicies[2]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 245106.46412122744, y: 727021.4061973379, scale: 0.019163055706363917}).bbox;
              setHimawariView(waypointBounds, 47.67, 0.5);
            } else if (waypointIndex == himawariWaypointIndicies[3]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 362126.4405055399, y: 782057.1066230518, scale: 0.022475101466500988}).bbox;
              setHimawariView(waypointBounds, 34.75, 1);
            } else if (waypointIndex == himawariWaypointIndicies[4]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 451074.23876657395, y: 212062.48697210365, scale: 0.017032941813388835}).bbox;
              setHimawariView(waypointBounds, 12.50, 0.5);
            } else if (waypointIndex == himawariWaypointIndicies[5]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 451074.23876657395, y: 212062.48697210365, scale: 0.017032941813388835}).bbox;
              setHimawariView(waypointBounds, 24.33, 0.5);
            } else if (waypointIndex == himawariWaypointIndicies[6]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 451074.23876657395, y: 212062.48697210365, scale: 0.017032941813388835}).bbox;
              setHimawariView(waypointBounds, 342.83, 0.5);
            } else if (waypointIndex == himawariWaypointIndicies[7]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 363341.95657876006, y: 205546.6268786163, scale: 0.02011577928416843}).bbox;
              setHimawariView(waypointBounds, 296.66, 0.5);
            } else if (waypointIndex == himawariWaypointIndicies[8]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 677150.2096313634, y: 1300560.2801491471, scale: 0.009919419703208456}).bbox;
              setHimawariView(waypointBounds, 9.5, 0.5);
            } else if (waypointIndex == himawariWaypointIndicies[9]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 646791.4364009488, y: 1299485.0077851338, scale: 0.031962724591951354}).bbox;
              setHimawariView(waypointBounds, 9.75, 0.5);
            } else if (waypointIndex == himawariWaypointIndicies[10]) {
              waypointBounds = timelapse.pixelCenterToPixelBoundingBoxView({x: 745253.433241357, y: 550139.9045414061, scale: 0.006365420067946737}).bbox;
              setHimawariView(waypointBounds, 223.084, 0.5);
            } else {
              if ($himawariLayerToggle.prop('checked'))
                $himawariLayerToggle.click();
            }
            // End Himawari

            // All other waypoints
            if ((waypointIndex >= 12 && waypointIndex <= 15) || (waypointIndex >= 59 && waypointIndex <= 61) || waypointIndex == 95) {
              if (!$lightsAtNightToggle.prop('checked')) {
                $lightsAtNightToggle.click();
              }
            } else if (waypointIndex == 19 || waypointIndex == 26 || (waypointIndex >= 32 && waypointIndex <= 38) || (waypointIndex >= 79 && waypointIndex <= 80)) {
              if (!$globalForestLayerToggle.prop('checked')) {
                $globalForestLayerToggle.click();
              }
            } else if (waypointIndex >= 30 && waypointIndex <= 39) {
              if (!$darkMapToggle.prop('checked')) {
                $darkMapToggle.click();
              }
            } else if (waypointIndex == 27 || waypointIndex == 98 || waypointIndex == 100 || waypointIndex == 102) {
              if (!$wdpaLayerToggle.prop('checked')) {
                $wdpaLayerToggle.click();
              }
            } else if ((waypointIndex >= 30 && waypointIndex <= 31) || waypointIndex == 39 || waypointIndex == 82 || waypointIndex == 97 || waypointIndex == 99) {
              if (!$globalForestLossLayerToggle.prop('checked')) {
                $globalForestLossLayerToggle.click();
              }
            } else if (waypointIndex == 40 || waypointIndex == 52) {
              if (!$waterChangeToggle.prop('checked')) {
                $waterChangeToggle.click();
              }
            } else if (waypointIndex == 54) {
              if (!$coralBleachingAlertsLayerToggle.prop('checked')) {
                $coralBleachingAlertsLayerToggle.click();
              }
              if (!$darkMapToggle.prop('checked')) {
                $darkMapToggle.click();
              }
            } else if (waypointIndex == 109) {
              if (!$coralLayerToggle.prop('checked')) {
                $coralLayerToggle.click();
              }
            } else if (waypointIndex == 91) {
              if (!$usgsWindTurbineLayerToggle.prop('checked')) {
                $usgsWindTurbineLayerToggle.click();
              }
            } else if (waypointIndex == 92) {
              if (!$solarInstallsLayerToggle.prop('checked')) {
                $solarInstallsLayerToggle.click();
              }
            } else if (waypointIndex == 101) {
              if (!$lightMapToggle.prop('checked')) {
                $lightMapToggle.click();
              }
              if (!$wdpaLayerToggle.prop('checked')) {
                $wdpaLayerToggle.click();
              }
            }
            // End other waypoints
          });
        }

        // Location search box, with autocomplete.
        var $locationSearchDiv = $('<div class="location_search_div"><input id="location_search" type="text" placeholder="Search for a location...">');
        if (enableLetterboxMode) {
          $locationSearchDiv.addClass("top-panel letterbox").appendTo($("#content"));
          $("#location_search").addClass("letterbox");
        } else {
          $locationSearchDiv.appendTo($("#timeMachine"));
        }

        if (isHyperwall) {
          $("#location_search").addClass("hyperwall");
        }

        // Note: Google's service gives much better results, but for locations where Google APIs cannot be used, we fallback to this.
        if (!useGoogleSearch) {
          var locationList = [];
          $("#location_search").autocomplete({
            minLength: 5,
            source: function( request, response ) {
              locationList = [];
              //http://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=1
              $.getJSON( "http://photon.komoot.de/api/?limit=5", { q: request.term }, function( data, status, xhr ) {
                response( data.features );
              });
            },
            select: function(event, ui) {
              var view;
              //if (ui.item.properties.extent) {
                //  view = {bbox: {"ne": {"lat": ui.item.properties.extent[1], "lng": ui.item.properties.extent[2]}, "sw": {"lat" : ui.item.properties.extent[3], "lng": ui.item.properties.extent[0]}}};
              //} else {
                view = {center: {"lat": ui.item.geometry.coordinates[1], "lng": ui.item.geometry.coordinates[0]}, "zoom": 12};
              //}
              timelapse.setNewView(view);
            }
          }).autocomplete( "instance" )._renderItem = function( ul, item ) {
            var tmpLocationString = (item.properties.name || "")  + ", " + (item.properties.state || "") + item.properties.country;
            if (item.properties.osm_value == "hamlet" || !item.properties.country || locationList.indexOf(tmpLocationString) >= 0) return $("<li>");
              locationList.push(tmpLocationString);
             return $("<li style='z-index:9999'>").append("<a>" + (item.properties.name || "")  + ", " + (item.properties.state || "") + "<br>" + item.properties.country + "</a>").appendTo(ul);
          };
        } else if (typeof(google) === "undefined" && !useGoogleMaps) {
          var googleMapsScript = document.createElement('script');
          googleMapsScript.setAttribute('src', 'https://maps.google.com/maps/api/js?libraries=places&callback=googleMapsLoadedCallback');
          googleMapsScript.setAttribute('type', 'text/javascript');
          document.getElementsByTagName('head')[0].appendChild(googleMapsScript);
        }

        // Set the letterbox mode
        if(enableLetterboxMode && !enableRecordingMode) {
          // Resize the viewer
          timelapse.addViewerBottomMargin(-2);
          // Move the presentation slider out
          var $presentationSlider = $("#" + timelapse.getTimeMachineDivId() + " .presentationSlider");
          $presentationSlider.appendTo("#content");
        }

        // Toggle the context map and hide it
        $(".toggleContextMapBtn").click();
        $(".contextMapContainer").hide();

        // Display info box for the waypoints
        if (enableWaypointText) {
          var $current_location_text = $(".current-location-text");
          $current_location_text.appendTo($("#timeMachine"));
          if (enableRecordingMode) {
            $current_location_text.find(".close").remove();
            $current_location_text.addClass("recording");
          }
        }

        $("#presentation-slider-selection").on("click", "td", function() {
          var sectionId = $(this).get(0).id;
          var waypointContainer = $(".snaplapse_keyframe_container");
          if (sectionId == "automode-section") {
            var snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
            snaplapseForPresentationSlider.getSnaplapseViewer().initializeAndRunAutoMode();
          } else {
            if (sectionId == "climate-1-section") {
              var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(0));
            } else if (sectionId == "climate-2-section") {
              var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(14));
            } else if (sectionId == "forest-section") {
              var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(30));
            } else if (sectionId == "water-section") {
              var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(40));
            } else if (sectionId == "resources-1-section") {
              var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(55));
            } else if (sectionId == "resources-2-section") {
              var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(69));
            } else if (sectionId == "industrialization-section") {
              var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(93));
            } else if (sectionId == "himawari-section") {
              var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(110));
            }
            var scrollAmount = scrollTo.offset().left - waypointContainer.offset().left + waypointContainer.scrollLeft();
            $(".snaplapse_keyframe_container").scrollLeft(scrollAmount);
          }
        });

        $(window).trigger("resize");
      }

      var perf;
      var maximumUpdateTime = 20; // milliseconds
      var startOfRedraw;

      function redrawTakingTooLong() {
        return performance.now() - startOfRedraw > maximumUpdateTime;
      }

      function resize() {
        var width = canvasLayer.canvas.width;
        var height = canvasLayer.canvas.height;

        gl.viewport(0, 0, width, height);
      }

      //var firstDrawTime = null;
      //var lastFrameTime = null

      // Draws to canvas.
      // Called by TimeMachineCanavasLayer during animation and/or view changes
      function update() {

        /*var frameTime = performance.now();
        startOfRedraw = frameTime;

        if (lastFrameTime != null) {
          var duration = frameTime - lastFrameTime;
        }
        lastFrameTime = frameTime;

        //stats.begin();
        if (WebglVideoTile.verbose) {
          function r2(x) {
            return Math.round(x * 100) / 100;
          }
          console.log(r2(performance.now()) + ' update start --------------------------------------------------');
        }*/

        //if (performance.now() - firstDrawTime < 1 * 5000) {
        //  WebglVideoTile.verbose = true;
        //} else {
        //  if (WebglVideoTile.verbose) {
        //    WebglVideoTile.verbose = false;
        //    console.log(WebglVideoTile.stats());
        //  }
        //}

        gl.clear(gl.COLOR_BUFFER_BIT);

        // Draw himawari
        if (showHimawariTimeMachineLayer) {
          var himawariView = timelapse.getView();
          var timelapse2map = himawariTimemachineLayer.getWidth() / landsatBaseMapLayer.getWidth();
          himawariView.x *= timelapse2map;
          himawariView.y *= timelapse2map;
          himawariView.scale /= timelapse2map;
          himawariTimemachineLayer.draw(himawariView, tileViewVisibility);
        } else {

          // Draw lightsAtNightMapLayer
          if (showLightsAtNightLayer) {
            // Construct view for lightsAtNightMapLayer
            var lightsAtNightLayerView = timelapse.getView();
            var timelapse2map = lightsAtNightMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
            lightsAtNightLayerView.x *= timelapse2map;
            lightsAtNightLayerView.y *= timelapse2map;
            lightsAtNightLayerView.scale /= timelapse2map;

            lightsAtNightMapLayer.draw(lightsAtNightLayerView);
          }

          // Draw base layer
          else if (visibleBaseMapLayer == "landsat") {
            landsatBaseMapLayer.draw(timelapse.getView(), tileViewVisibility);
          } else if (visibleBaseMapLayer == "light") {
            // Construct view for lightBaseMapLayer
            var lightBaseMapView = timelapse.getView();
            var timelapse2map = lightBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
            lightBaseMapView.x *= timelapse2map;
            lightBaseMapView.y *= timelapse2map;
            lightBaseMapView.scale /= timelapse2map;

            lightBaseMapLayer.draw(lightBaseMapView);
          } else if (visibleBaseMapLayer == "dark") {
            // Construct view for darkBaseMapLayer
            var darkBaseMapView = timelapse.getView();
            var timelapse2map = darkBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
            darkBaseMapView.x *= timelapse2map;
            darkBaseMapView.y *= timelapse2map;
            darkBaseMapView.scale /= timelapse2map;

            darkBaseMapLayer.draw(darkBaseMapView);
          }

          // Layers to draw above the base layer

          if (showCrwTimemachineLayer) {
            var crwView = timelapse.getView();
            var timelapse2map = crwTimemachineLayer.getWidth() / landsatBaseMapLayer.getWidth();
            crwView.x *= timelapse2map;
            crwView.y *= timelapse2map;
            crwView.scale /= timelapse2map;
            crwTimemachineLayer.draw(crwView, tileViewVisibility);
           }

          // Draw hansonMapLayer (Forest change transparent)
          if (showHansonLayer) {
            // Construct view for hansonMapLayer
            var hansonMapLayerView = timelapse.getView();
            var timelapse2map = hansonMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
            hansonMapLayerView.x *= timelapse2map;
            hansonMapLayerView.y *= timelapse2map;
            hansonMapLayerView.scale /= timelapse2map;

            hansonMapLayer.draw(hansonMapLayerView);
          }

          // Draw hansonMapLayer2 (Forest Loss/Gain)
          if (showHansonLayer2) {
            // Construct view for hansonMapLayer2
            var hansonMapLayerView2 = timelapse.getView();
            var timelapse2map = hansonMapLayer2.getWidth() / landsatBaseMapLayer.getWidth();
            hansonMapLayerView2.x *= timelapse2map;
            hansonMapLayerView2.y *= timelapse2map;
            hansonMapLayerView2.scale /= timelapse2map;

            hansonMapLayer2.draw(hansonMapLayerView2);
          }

          // Draw water occurrence
          if (showWaterOccurrenceLayer) {
            // Construct view for waterOccurrenceLayer
            var waterOccurrenceView = timelapse.getView();
            var timelapse2map = waterOccurrenceLayer.getWidth() / landsatBaseMapLayer.getWidth();
            waterOccurrenceView.x *= timelapse2map;
            waterOccurrenceView.y *= timelapse2map;
            waterOccurrenceView.scale /= timelapse2map;

            waterOccurrenceLayer.draw(waterOccurrenceView);
          }

         // Draw water change
          if (showWaterChangeLayer) {
            // Construct view for waterChangeLayer
            var waterChangeView = timelapse.getView();
            var timelapse2map = waterChangeLayer.getWidth() / landsatBaseMapLayer.getWidth();
            waterChangeView.x *= timelapse2map;
            waterChangeView.y *= timelapse2map;
            waterChangeView.scale /= timelapse2map;

            waterChangeLayer.draw(waterChangeView);
          }

          // Draw Animated Hansen Layer
          if (showAnimatedHansenLayer) {
            // Construct view for hansonMapLayer
            var animatedHansenLayerView = timelapse.getView();
            var timelapse2map = animatedHansenLayer.getWidth() / landsatBaseMapLayer.getWidth();
            animatedHansenLayerView.x *= timelapse2map;
            animatedHansenLayerView.y *= timelapse2map;
            animatedHansenLayerView.scale /= timelapse2map;


            var ratio = 0;

            var captureTimes = timelapse.getCaptureTimes();
            var offset = captureTimes.indexOf("2000");
            var fps = timelapse.getFps();
            if (offset > -1) {
              var currentTime = Math.max(0,timelapse.getCurrentTime() - offset/fps);
              ratio = currentTime / ((captureTimes.length - offset - 1)/fps);
              ratio = Math.min(1, currentTime);
            }
            animatedHansenLayerView.alpha = ratio;

            animatedHansenLayer.draw(animatedHansenLayerView);
          }

          if (showMcrmLayer) {
            var mcrmLayerView = timelapse.getView();
            var timelapse2map = mcrmVectorLayer.getWidth() / landsatBaseMapLayer.getWidth();
            mcrmLayerView.x *= timelapse2map;
            mcrmLayerView.y *= timelapse2map;
            mcrmLayerView.scale /= timelapse2map;

            mcrmVectorLayer.draw(mcrmLayerView);
          }


          // VIIRS layer
          if (showViirsLayer) {
            var viirsView = timelapse.getView();
            viirsView.zoom = timelapse.getCurrentZoom();
            var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
            var times = timelapse.getCaptureTimes();
            var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
            var currentDate = ratio*range + new Date(times[0]).getTime();
            viirsView.currentDate = currentDate;
            viirsTile.draw(viirsView);
          }

          if (showCoralBleachingLayer) {
            var viirsView = timelapse.getView();
            viirsView.zoom = timelapse.getCurrentZoom();
            var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
            var times = timelapse.getCaptureTimes();
            var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
            var currentDate = ratio*range + new Date(times[0]).getTime();
            viirsView.currentDate = currentDate;
            coralBleachingTile.draw(viirsView);
          }

          if (showUsgsWindTurbineLayer) {
            var usgsWindTurbineLayerView = timelapse.getView();
            var timelapse2map = usgsWindTurbineLayer.getWidth() / landsatBaseMapLayer.getWidth();
            usgsWindTurbineLayerView.x *= timelapse2map;
            usgsWindTurbineLayerView.y *= timelapse2map;
            usgsWindTurbineLayerView.scale /= timelapse2map;
            usgsWindTurbineLayerView.zoom = timelapse.getCurrentZoom();
            var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
            var times = timelapse.getCaptureTimes();
            var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
            var currentDate = ratio*range + new Date(times[0]).getTime();
            usgsWindTurbineLayerView.currentTime = currentDate;
            usgsWindTurbineLayerView.color = [0.1, 0.5, 0.1, 1.0];
            usgsWindTurbineLayer.draw(usgsWindTurbineLayerView);
          }

          if (showSolarInstallsLayer) {
            var solarInstallsLayerView = timelapse.getView();
            var timelapse2map = usgsWindTurbineLayer.getWidth() / landsatBaseMapLayer.getWidth();
            solarInstallsLayerView.x *= timelapse2map;
            solarInstallsLayerView.y *= timelapse2map;
            solarInstallsLayerView.scale /= timelapse2map;
            solarInstallsLayerView.zoom = timelapse.getCurrentZoom();
            var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
            var times = timelapse.getCaptureTimes();
            var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
            var currentDate = ratio*range + new Date(times[0]).getTime();
            solarInstallsLayerView.currentTime = currentDate;
            solarInstallsLayer.draw(solarInstallsLayerView);
          }

          if (showDrillingLayer) {
            var drillingLayerView = timelapse.getView();
            var timelapse2map = drillingLayer.getWidth() / landsatBaseMapLayer.getWidth();
            drillingLayerView.x *= timelapse2map;
            drillingLayerView.y *= timelapse2map;
            drillingLayerView.scale /= timelapse2map;
            drillingLayerView.zoom = timelapse.getCurrentZoom();
            var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
            var times = timelapse.getCaptureTimes();
            var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
            var currentDate = ratio*range + new Date(times[0]).getTime();
            drillingLayerView.currentTime = currentDate;
            drillingLayerView.color = [0.82, 0.22, 0.07, 1.0];
            drillingLayer.draw(drillingLayerView);
          }

          // Draw forest alerts no overlay
          if (showForestAlertsNoOverlayTimeMachineLayer) {
            var forestAlertsNoOverlayView = timelapse.getView();
            var timelapse2map = forestAlertsNoOverlayTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

            var p = timelapse.getProjection();
            var offest = p.latlngToPoint({"lat":5.506709319555738, "lng":-82.5513118548623});

            forestAlertsNoOverlayView.x -= offest.x;
            forestAlertsNoOverlayView.y -= offest.y;
            forestAlertsNoOverlayTimeMachineLayer.draw(forestAlertsNoOverlayView, tileViewVisibility);
          }

          // Draw forest alerts
          if (showForestAlertsTimeMachineLayer) {
            var forestAlertsView = timelapse.getView();
            var timelapse2map = forestAlertsTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

            var p = timelapse.getProjection();
            var offest = p.latlngToPoint({"lat":5.506709319555738, "lng":-82.5513118548623});

            forestAlertsView.x -= offest.x;
            forestAlertsView.y -= offest.y;
            forestAlertsTimeMachineLayer.draw(forestAlertsView, tileViewVisibility);
          }

          // Draw wdpaLayer
          if (showWdpaLayer)
            wdpaVectorLayer.draw(timelapse.getView());

        }

        //stats.end();
      }
    </script>
  </head>
  <body>
    <div id="content">
      <div id="letterbox-top"></div>
      <div id="letterbox-middle"></div>
      <div id="letterbox-bottom"></div>
    </div>
    <div id="timeMachine"></div>
    <div class="current-location-text">
      <h3></h3>
      <p></p>
    </div>
    <canvas id="stats" style="position:absolute; top:0px; right:0px; z-index:100" width=1000 height=153></canvas>
    <div id="extras-content" title=""></div>
    <div id="presentation-slider-selection"><table><tr><td style="color: white">Jump To: <td id="climate-1-section"><button type="button">Climate 1</button></td><td id="climate-2-section"><button type="button">Climate 2</button></td><td id="forest-section"><button type="button">Forest</button></td><td id="water-section"><button type="button">Water</button></td><td id="resources-1-section"><button type="button">Resources 1</button></td><td id="resources-2-section"><button type="button">Resources 2</button></td><td id="industrialization-section"><button type="button">Industrialization</button></td><td id="himawari-section"><button type="button">Himawari-8</button></td><td id="automode-section"><button type="button">Launch Automode</button></td></tr></table></div>
  </body>
</html>

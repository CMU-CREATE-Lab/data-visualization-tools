<!DOCTYPE html>
<html>
  <head>
	<title>Earth Timelapse</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

	<link href="../../timemachine/css/snaplapse.css" rel="stylesheet" type="text/css" />
	<link href="../../timemachine/css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css" />
	<link href="../../timemachine/css/defaultUI.css" rel="stylesheet" type="text/css" />
	<link href="../../timemachine/css/contextMap.css" rel="stylesheet" type="text/css" />
	<link href="../../timemachine/css/scaleBar.css" rel="stylesheet" type="text/css" />
	<link href="../../timemachine/css/customUI.css" rel="stylesheet" type="text/css" />
	<link href="../../timemachine/css/leaflet/leaflet.css" rel="stylesheet" type="text/css"/>
	<link href="../../js/customVideoTagControls/customVideoTagControls.css" rel="stylesheet" type="text/css"/>
	<link href="index.css" rel="stylesheet" type="text/css" />

	<script src="../../timemachine/js/jquery/jquery.min.js" type="text/javascript"></script>
	<script src="../../timemachine/js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
	<script src="../../timemachine/js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/util.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
	<script src="../../timemachine/js/Math.uuid.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/scaleBar.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/contextMap.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/customUI.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
	<script src="../../timemachine/js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>
	<script src="../../timemachine/template_includes.js" type="text/javascript"></script>
	<script src="../../timemachine/js/leaflet/leaflet.min.js" type="text/javascript" ></script>
	<script src="../../js/customVideoTagControls/customVideoTagControls.js" type="text/javascript"></script>

	<script src="config-local.js" type="text/javascript"></script>
	<script src="../../../../config.js" type="text/javascript"></script>
	<script src="waypoint-text.js" type="text/javascript"></script>
	<script src="landsat_ajax_includes.js" type="text/javascript"></script>
	<script src="timestamps_ajax_includes.js" type="text/javascript"></script>

	<script src="TileIdx.js"></script>
	<script src="WebglVideoTile.js"></script>
	<script src="TileView.js"></script>
	<script src="Glb.js"></script>
	<script src="WebglTimeMachineLayer.js"></script>
	<script src="WebglMapLayer.js"></script>
	<script src="WebglVectorLayer.js"></script>
	<script src="WebglVectorLayer2.js"></script>
	<script src="WebglTimeMachinePerf.js"></script>
	<script src="WebGLVectorTile.js"></script>
	<script src="WebGLVectorTile2.js"></script>
	<script src="WebglMapTile.js"></script>
	<script src="WebglViirsTile.js"></script>
	<script src="WebglCoralTile.js"></script>
	<script src="WebglMapTile2.js"></script>
	<script src="WebglMapLayer2.js"></script>
	<script src="MonthlyRefugeesTile.js"></script>

	<script type="text/javascript">
	  "use strict";

	  jQuery.support.cors = true;
	  var UTIL = org.gigapan.Util;

	  //
	  //// Config ////
	  //

	  var EARTH_TIMELAPSE_CONFIG = EARTH_TIMELAPSE_CONFIG || {};

	  // "http://timemachine.cmucreatelab.org/wiki/EarthEngineTourEditor#presentation=E5DDkDV0jvjsXrchC_Climate_DkDQhV1kUKXaiD_Fires%20at%20Night_DkDFWaNbFlEeqJ_Agricultural%20Fires_DkDASzGiNIcpvK_Agricultural%20Fires_DkDIAHUl1q2eqJ_Drilling%20Flares_DkDSx-Tmy5yMmK_Shale%20Oil%20Extraction_DkDRFMpUtEFyje_Eagle%20Downs%20Coal_DkDOHcDnYDBPjgB_Mountaintop%20Removal_DkDcYs5sY3cKrZ_Alberta%20Tar%20Sands_DkDIl59k8-Aurb_Shanghai_DkDIHBIjdC4j7f_Dubai_DkDIumflQzrMib_Dallas%20Fort-Worth_DkDWVyelV9qMjW_Dallas%20Fort-Worth%20_DkDIYWEnHy5MoJ_United%20States_DkDI8H8f-Cuc3C_Lights%20at%20Night_DkDI9F8k2euuzJ_East%20Asia_DkDPWPyXs9wR6gB_Rondonia_DkDPZ85XKYIShT_Rondonia_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDA8sGufoBFqe_Columbia%20Glacier_DkDNROTtit7GojB_Mendenhall%20Glacier_DkDFGq9mKcYi8VThe%20shrinking%20and%20drying%20up%20of%20the%20Lake%20Urmia_Lake%20Urmia_DkDOcGQprwpkmRThe%20shrinking%20of%20the%20Aral%20Sea%20destroys%20fishing%20industry%20and%20brings%20unemployment%20and%20public%20health%20problems_Aral%20Sea_DkDSq1joU5sk6gBThe%20expansion%20of%20irrigation%20systems%20near%20the%20Aral%20Sea_Aral%20Expansion_CkDWmblQtbBxuXBushfires%20in%20Australia%20are%20frequent%20during%20the%20hotter%20months%20of%20the%20year_Australia%20Bushfire_DkDblXvnAWJL2V_Bark%20Beetles_DkDPZ85XKYIShT_Rondonia_DkDPI2unYMQqrhB_Gansu%20Wind%20Farm_DkDPOxFm4qZJ2iB_Solar%20Star_DkDV0jvjsXrchC_Forest_DkDVWlolkXJOxe_Alabama_DkDVmSguE8quhS_Yakutsk_DkDVZNiW4_KhhS_Mozambique_DkDVdSqbMp9qlV_Indonesia_DkDVdhqUIJOShS_Paraguay_DkDV5NVdc5jalV_Cote%20D%E2%80%99Ivoire_DkDVzKwaoThslV_Kalimantan_DkDVjqJcYu9spY_Sarawak_DkDVxYQuwu2fhS_Russia%2FFinland_DkDV0jvjsXrchC_Water_DkDV9ofmUx7Jmd_Las%20Vegas_DkDFGq9mKcYi8VThe%20shrinking%20and%20drying%20up%20of%20the%20Lake%20Urmia_Lake%20Urmia_DkDOcGQprwpkmR_Aral%20Sea_DkDSq1joU5sk6gB_Aral%20Expansion_DkDSYrnkxOVh6c_Saudi%20Irrigation_DkDSVR-mLkAJ3c_Central%20Valley_DkDS4s-m9NHJ8gB_California%20Reservoir_BkDTiTRWWTmR6gBRiver%20meandering%20in%20the%20Amazon_Bolivia%20Meander_DkDK9ySWib2R2dThe%20abandonment%20of%20a%20river%20channel%20and%20the%20formation%20of%20a%20new%20river%20channel_Bolivia%20Avulsion_DkDTXCJXWOFUha_Brazil%20Reservoir_DkDT6ClYMn5SpN_Amazon%20Deforestation_DkDTypVi8CHpkd_Bangladesh_DkDT07enqs_t_gB_Fish%20Ponds%2C%20China_DkDV0jvjsXrchC_Coral%20Reef%20Watch_DkDV0jvjsXrchC_Resources_DkDVl59k8-Aurb_Shanghai_DkDVumflQzrMib_Dallas%20Fort-Worth_DkDVWWhlM5mMiiB_Barnett%20Shale_DkDWVyelV9qMjW_DFW%20Growth_DkDVYWEnHy5MoJ_United%20States_DkDV8H8f-Cuc3C_Lights%20at%20Night_DkDVsXXi870skf_Pearl%20River%20Delta_DkDQhV1kUKXaiD_Fires%20at%20Night_DkDIAHUl1q2eqJ_Drilling%20Flares_DkDSx-Tmy5yMmK_Shale%20Oil%20Extraction_DkDVbUxoD7ZLre_Wyoming%20Coal%20Mining_DkDOHcDnYDBPjgB_Mountaintop%20Removal_DkDV-99mHP-OgW_Mountaintop%20Removal_DkDVlMmn4Acs_iB_Hei%20Dai%20Gao%20Coal_DkDcYs5sY3cKrZ_Alberta%20Tar%20Sands_DkDVNViXQeyQjgB_Peru%20Mining_DkDVEuOaR5YwojB_Grasberg%20Mine_DkDVOnDa0YXw6d_Grasberg%20Tailings_DkDOcGQprwpkmR_Aral%20Sea_DkDOYrnkxOVh6c_Saudi%20Irrigation_DkDPWPyXs9wR6gB_Rondonia_DkDPZ85XKYIShT_Rondonia_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDPNEabGoEs-N_Indonesia%20Forests_DkDWOpqWSEFK2Q_Sumatra%20Fires_DkDPRG9ln6qOtN_Forestry%20SE%20US_DkDWWnfme-zqiiB_Longyangxia%20Solar_DkDPOxFm4qZJ2iB_Solar%20Star_DkDPjqQmuXJJojB_Topaz%20Solar%20Farm_DkDPKtwiQVVmojB_Charanka%20Solar%20Park_DkDPGUUmWP2JojB_Ivanpah%20Solar%20Power_DkDP22pmX2kaojB_Valle%20Solar%20Power_DkDPI2unYMQqrhB_Gansu%20Wind%20Farm_DkDPEuJmc6aJojB_Alta%20Wind%20Farm_DkDPD7CnLTtMiK_US%20Wind_DkDPD7CnLTtMiK_US%20Photovoltaic_DkDV0jvjsXrchC_Industrialization_DkDVlsznvjQPkgB_Pittsburgh_DkDWksznwjQP_Z_Pittsburgh_DkDVLjfdNa_b5c_Lagos_DkDVLjfdNa_b5c_Lagos_DkDP4t6mgw0u7c_Seoul_DkDP4t6mgw0u7c_Seoul_DkDQ5wYitp3subShenzhen%20bay%2C%20growth%20of%20land%20use%20into%20bay%2E_Shenzhen_DkDQrnpWLjJUya_Brasilia_DkDQoLbXOXaTsV_Brasilia_DkDQ5YWph63cxf_Milano_DkDQSHLrsBhcigB_Duisburg_DkDQENjTEnwf2d_Pretoria_DkDAFpEbiqFhmjB_Nairobi_DkDAZdNelWYhojB_Addis%20Ababa_DkDAGq9mKcYi8V_Lake%20Urmia_DkDAGyOdZ5mcnC_Coral%20Reefs_DkDAHBYiAv1s9a_Shenzhen_DkDWFqgBAAAA1M_Himawari-8_DkDWOpqWSEFK2Q_Sumatra%20Fires_DkDWA-fScC5OtR_Sinabung%20Volcano_DkDWFqgBAAAA1M_Clear%20Beijing_DkDWFqgBAAAA1M_Hazy%20Beijing_DkDWFqgBAAAA1M_Hazier%20Beijing_DkDWFqgBAAAA1M_Melting%20Snow_DkDWtEyBMH2b3N_Ice%20Floes_DkDWqpyBvNmagT_Iceberg%20calving_BAWFqgBAAAA1M_Typhoon%20In-Fa_Untitled_B"
	  var waypointSliderContent = EARTH_TIMELAPSE_CONFIG.waypointCollection || "http://timemachine.cmucreatelab.org/wiki/EarthEngineTourEditor#presentation=F5DDkDV0jvjsXrchC_Climate__blsat_DkDQhV1kUKXaiD_Fires%20at%20Night__bdrk%2Cviirs_DkDFWaNbFlEeqJ_Agricultural%20Fires_Seasonal%20fires%20in%20Africa%20include%20range%20burning%20to%20encourage%20tender%20grass%20growth%20for%20grazing%2C%20or%20in%20preparation%20for%20planting%2E_bdrk%2Cviirs_DkDASzGiNIcpvK_Agricultural%20Fires_Fires%20in%20South%20East%20Asia%20move%20south%20to%20north%20annually%20in%20preparation%20for%20the%20growing%20season%2E_bdrk%2Cviirs_DkDIAHUl1q2eqJ_Drilling%20Flares_Methane%20and%20other%20light%20products%20flare%20at%20oil%20wells%20across%20Northern%20Africa%20and%20the%20Middle%20East%2E_bdrk%2Cviirs_DkDSx-Tmy5yMmK_Shale%20Oil%20Extraction_Fracked%20oil%20wells%20in%20the%20US%20produce%20a%20large%20fraction%20of%20methane%20and%20other%20light%20gases%2E%20In%20North%20Dakota%2C%20approximately%20one%20third%20of%20the%20carbon%20extracted%20from%20the%20ground%20is%20converted%20directly%20into%20CO2%20via%20flaring%2E_bdrk%2Cviirs_DkDRFMpUtEFyje_Eagle%20Downs%20Coal_30%20years%20of%20excavation%20at%20the%20Eagle%20Downs%20open%20pit%20coal%20mine%20in%20Queensland%2C%20Australia%2E%20Most%20Australian%20coal%20is%20exported%20to%20China%2E_blsat_DkDOHcDnYDBPjgB_Mountaintop%20Removal_Mountaintop%20Removal%20in%20West%20Virginia%20involves%20moving%20aside%20the%20tops%20of%20mountains%20to%20access%20coal%20seams%2E%20This%20practice%20often%20poisons%20water%2E_blsat_DkDcYs5sY3cKrZ_Alberta%20Tar%20Sands_Tar%20Sands%20extraction%20in%20Alberta%2C%20Canada%2E%20Half%20of%20the%20tar%20extracted%20is%20burned%20to%20process%20the%20other%20half%2E_blsat_DkDIl59k8-Aurb_Shanghai_Shanghai%20merges%20into%20nearby%20cities%2C%20growing%20to%20become%20the%206th%20largest%20megacity%2C%20with%2024%20million%20people%2E_blsat_DkDIHBIjdC4j7f_Dubai_Dubai%20Palm%20and%20World%20Islands%2E_blsat_DkDIumflQzrMib_Dallas%20Fort-Worth_Dallas%20Fort-Worth_blsat_DkDWVyelV9qMjW_Dallas%20Fort-Worth_Dallas%20Fort-Worth%20growth%20over%2025%20years%2E_blsat%2Clan_DkDIYWEnHy5MoJ_United%20States_Red%20rings%20reveal%20growth%20in%20Atlanta%2C%20Dallas-Forth%20Worth%2C%20Phoenix%2E_blsat%2Clan_DkDI8H8f-Cuc3C_Lights%20at%20Night_Red%20shows%20strong%20growth%20in%20Asia%2E_blsat%2Clan_DkDI9F8k2euuzJ_East%20Asia_In%20contrast%20to%20Japan%2C%20China%20shows%20strong%20growth%2E_blsat%2Clan_DkDPWPyXs9wR6gB_Rondonia_Conversion%20of%20forests%20to%20farmland%20in%20Rondonia%2C%20Brazil%2E_blsat_DkDPZ85XKYIShT_Rondonia_Conversion%20of%20forests%20to%20farmland%20in%20Rondonia%2C%20Brazil%2E_blsat_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_Arc%20of%20deforestation%2C%20Amazon%20Rain%20Forest%2E_blsat_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_Yellower%20tones%20indicate%20slowing%20rate%20of%20deforestation%2C%20while%20redder%20tones%20indicate%20speeding%20rate%2E_blsat%2Cfly_DkDA8sGufoBFqe_Columbia%20Glacier_Columbia%20Glacier%20has%20retreated%20more%20than%2020%20kilometers%2E_blsat_DkDNROTtit7GojB_Mendenhall%20Glacier_Mendenhall%20Glacier%20has%20retreated%20about%201%20kilometer%2E_blsat_DkDFGq9mKcYi8V_Lake%20Urmia_Water%20previously%20terminating%20in%20Lake%20Urmia%20is%20diverted%20for%20agriculture%2E_blsat_DkDOcGQprwpkmR_Aral%20Sea_Water%20previously%20terminating%20in%20Aral%20Sea%20is%20diverted%20for%20agriculture%2E%20Drought%20is%20further%20accelerating%20water%20loss%2E_blsat_DkDSq1joU5sk6gB_Aral%20Expansion_Cropland%20in%20Uzbekistan%20south%20of%20Aral%20Sea%20expands%20and%20retreats%2E_blsat_DkDWmblQtbBxuX_Australia%20Bushfire_Climate%20change%20is%20increasing%20the%20frequency%20and%20severity%20of%20bushfires%20in%20Australia%2E_blsat_DkDblXvnAWJL2V_Bark%20Beetles_Bark%20beetle%20range%20is%20increasing%20during%20warmer%20winters%2C%20leading%20to%20widespread%20tree%20death%20in%20Colorado%2E_blsat%2Cfly_DkDPZ85XKYIShT_Rondonia_Indigenous%20areas%20and%20preserves%20can%20halt%20or%20slow%20deforestation%20in%20Brazil%2E_blsat%2Cwdpa_DkDPI2unYMQqrhB_Gansu%20Wind%20Farm_Gansu%20Wind%20Farm%2C%20China%3A%208GW%20%2820GW%20planned%29_blsat_DkDPOxFm4qZJ2iB_Solar%20Star_Solar%20Star%2C%20US%3A%20579MW%20photovoltaic_blsat_DkDV0jvjsXrchC_Forest__bdrk%2Cflg_DkDVWlolkXJOxeA%202011%20tornado%20path%20from%20Tuscaloosa%20to%20Birmingham%2C%20Alabama%2C%20USA%20is%20shown%20in%20red%2E%20Tornado%20frequency%20in%20the%20southeast%20USA%20is%20expected%20to%20increase%20due%20to%20global%20warming%2E_Alabama_Alabama_bdrk%2Cflg_DkDVmSguE8quhSBoreal%20forest%20fire%20dynamics%20are%20illustrated%20for%20Yakutsk%2C%20eastern%20Siberia%2C%20Russia%2E%20Fire%20frequency%2C%20extent%20and%20severity%20are%20likely%20to%20increase%20with%20global%20warming%2E_Yakutsk_Yakutsk_bdrk%2Cfly_DkDVZNiW4_KhhSMost%20of%20African%20land%20change%20is%20due%20to%20smallholder%20agriculture%2C%20where%20families%20clear%20woodlands%20and%20forest%20to%20grow%20crops%2E%20The%20sustainability%20of%20such%20systems%20given%20burgeoning%20populations%20is%20threatened%20as%20they%20require%20fallow%20periods%20for%20land%20to%20recover%20before%20subsequent%20clearing%2E%20The%20threats%20to%20biodiversity%20are%20great%20as%20humans%20encroach%20on%20the%20remaining%20natural%20woodland%20and%20forest%20ecosystems%2E_Mozambique_Mozambique_bdrk%2Cfly_DkDVdSqbMp9qlVIndustrial%20scale%20clearing%20of%20tropical%20forests%20to%20produce%20palm%20oil%20and%20wood%20products%20is%20clear%20in%20Riau%2C%20Sumatra%2C%20Indonesia%2E%20Palm%20oil%20is%20found%20in%20many%20household%20products%20and%20foods%20and%20is%20produced%20only%20in%20the%20humid%20tropics%2E%20Humid%20tropical%20forests%20are%20the%20most%20biodiverse%20on%20the%20planet%20and%20their%20replacement%20by%20monoculture%20palm%20estates%20and%20tree%20plantations%20results%20in%20ecosystem%20collapse%2E_Indonesia_Indonesia_bdrk%2Cfly_DkDVdhqUIJOShSParaguay%20is%20the%20site%20of%20one%20of%20the%20highest%20deforestation%20rates%20globally%2C%20from%20its%20Interior%20Atlantic%20Forests%20in%20the%20east%20to%20Chaco%20woodlands%20in%20the%20west%2E%20Land%20is%20cleared%20for%20row%20crops%20or%20pastures%2C%20with%20little%20area%20set%20aside%20for%20nature%20or%20indigenous%20reserves%2E_Paraguay_Paraguay_bdrk%2Cfly_DkDV5NVdc5jalVForest%20loss%20within%20protected%20areas%20in%20Cote%20D%27Ivoire%20is%20evident%20and%20related%20to%20the%20two%20civil%20wars%20of%202002%20and%202007%20and%20a%20resulting%20breakdown%20in%20governance%2E%20The%20dynamic%20points%20out%20the%20fragility%20of%20protected%20area%20networks%20which%20on%20paper%20can%20cover%20a%20substantial%20area%20of%20a%20given%20country%2C%20but%20are%20subject%20to%20exploitation%20in%20times%20of%20conflict%2E_Cote%20D%E2%80%99Ivoire_Cote%20D%27Ivoire_bdrk%2Cfly_DkDVzKwaoThslVLike%20Sumatra%2C%20Kalimantan%2C%20Indonesia%20is%20the%20site%20of%20large-scale%20agroindustrial%20clearing%2E%20Kalimantan%27s%20peatlands%2C%20habitat%20for%20orangutans%20and%20extensive%20carbon%20stores%20in%20peatland%20soils%2C%20are%20increasingly%20appropriated%20for%20palm%20oil%20production%2E%20The%20interior%20highlands%20are%20logged%2C%20but%20not%20cleared%20as%20extensively%20as%20accessible%20lowland%20and%20wetland%20forests%2E_Kalimantan_Kalimantan_bdrk%2Cfly_DkDVjqJcYu9spYThe%20border%20of%20Malaysia%20and%20Indonesia%20on%20the%20island%20of%20Borneo%20reveals%20a%20variation%20in%20forest%20exploitation%20between%20the%20two%20countries%2E%20Interior%20Borneo%20is%20the%20site%20of%20intensive%20high-grading%20of%20high%20value%20tropical%20forests%20on%20the%20Malaysian%20side%20of%20the%20border%2E%20The%20Heart%20of%20Borneo%20conservation%20initiative%20will%20likely%20rely%20on%20the%20Indonesian%20side%20of%20the%20border%20for%20conserving%20the%20unique%20ecosystem%20services%20of%20montane%20Borneo%20forests%2E_Sarawak_Sarawak_bdrk%2Cfly_DkDVxYQuwu2fhSUnder%20Soviet%20rule%2C%20a%20buffer%20of%20forest%20was%20maintained%20along%20the%20Russian-Finland%20border%2E%20Recent%20access%20to%20this%20forest%20under%20Russian%20governance%20has%20led%20to%20increased%20forest%20clearing%2E%20The%20Finland%20side%20of%20the%20border%20reflects%20a%20long-held%20smallholder%20forestry%20land%20use%2C%20and%20a%20lack%20of%20intact%20natural%20forests%2E_Russia%2FFinland_Russia%2FFinland_bdrk%2Cflg_DkDV0jvjsXrchC_Water__blsat_DkDV9ofmUx7Jmd_Las%20Vegas_Las%20Vegas%20grows%20while%20Lake%20Mead%20shrinks%2E_blsat_DkDFGq9mKcYi8V_Lake%20Urmia_Water%20previously%20terminating%20in%20Lake%20Urmia%20is%20diverted%20for%20agriculture%2E_blsat_DkDOcGQprwpkmR_Aral%20Sea_Water%20previously%20terminating%20in%20Aral%20Sea%20is%20diverted%20for%20agriculture%2E%20Drought%20is%20further%20accelerating%20water%20loss%2E_blsat_DkDSq1joU5sk6gB_Aral%20Expansion_Cropland%20in%20Uzbekistan%20south%20of%20Aral%20Sea%20expands%20and%20retreats%2E_blsat_DkDSYrnkxOVh6c_Saudi%20Irrigation_Cropland%20in%20Saudi%20Arabia%20is%20irrigated%20from%20ancient%20aquifer%2E_blsat_DkDSVR-mLkAJ3c_Central%20Valley_The%20productive%20California%20Central%20Valley%20relies%20on%20irrigation%2E_blsat_DkDS4s-m9NHJ8gB_California%20Reservoir_Pedro%20Reservoir%20and%20Lake%20McClure%20lose%20water%20during%20recent%20drought%2E_blsat_DkDTiTRWWTmR6gB_Bolivia%20Meander_Tributary%20of%20the%20Amazon%20fresh%20from%20the%20Andes%20meaders%20in%20Bolivia%2E_blsat_DkDK9ySWib2R2d_Bolivia%20Avulsion_Tributary%20of%20the%20Amazon%20changes%20path%2C%20depositing%20soil%20across%20large%20area%2E_blsat_DkDTXCJXWOFUha_Brazil%20Reservoir_Lago%20de%20Serra%20da%20Mesa%2C%20Brazil%2E_blsat_DkDT6ClYMn5SpN_Amazon%20Deforestation_Amazon%20forest%20loss%20diminishes%20precipitation%2E_blsat_DkDTypVi8CHpkd_Bangladesh_Creation%20of%20fish%20ponds%20in%20Bangladesh%2E_blsat_DkDT07enqs_t_gB_Fish%20Ponds%2C%20China_Fish%20ponds%2C%20Bohai%20Sea%2C%20China_blsat_DkDV0jvjsXrchC_Coral%20Reef%20Watch_Ocean%20heating%2C%20El%20Nino%2C%20and%20acidification%20from%20CO2%20have%20triggered%20a%20massive%20coral%20bleaching%20event%2E_bdrk%2Ccrw_DkDV0jvjsXrchC_Resources__blsat_DkDVl59k8-Aurb_Shanghai_Shanghai%20merges%20into%20nearby%20cities%2C%20growing%20to%20become%20the%206th%20largest%20megacity%2C%20with%2024%20million%20people%2E_blsat_DkDVumflQzrMib_Dallas%20Fort-Worth_Dallas%20Fort-Worth_blsat_DkDVWWhlM5mMiiB_Barnett%20Shale_Fracking%20the%20Barnett%20Shale%20for%20Natural%20Gas%2E_blsat_DkDWVyelV9qMjW_DFW%20Growth_Dallas%20Fort-Worth%20growth%20over%2025%20years_blsat%2Clan_DkDVYWEnHy5MoJ_United%20States_Red%20rings%20reveal%20growth%20in%20Atlanta%2C%20Dallas-Forth%20Worth%2C%20Phoenix_blsat%2Clan_DkDV8H8f-Cuc3C_Lights%20at%20Night_Red%20shows%20strong%20growth%20in%20Asia%2E_blsat%2Clan_DkDVsXXi870skf_Pearl%20River%20Delta_Pearl%20River%20Delta%2C%20China_blsat_DkDQhV1kUKXaiD_Fires%20at%20Night_Fires%20At%20Night_bdrk%2Cviirs_DkDIAHUl1q2eqJ_Drilling%20Flares_Methane%20and%20other%20light%20products%20flare%20at%20oil%20wells%20across%20Northern%20Africa%20and%20the%20Middle%20East%2E_bdrk%2Cviirs_DkDSx-Tmy5yMmK_Shale%20Oil%20Extraction_Fracked%20oil%20wells%20in%20the%20US%20produce%20a%20large%20fraction%20of%20methane%20and%20other%20light%20gases%2E%20In%20North%20Dakota%2C%20approximately%20one%20third%20of%20the%20carbon%20extracted%20from%20the%20ground%20is%20converted%20directly%20into%20CO2%20via%20flaring%2E_bdrk%2Cviirs_DkDVbUxoD7ZLre_Wyoming%20Coal%20Mining_Open%20pit%20coal%20mining%20in%20Wyoming%2C%20US%2E_blsat_DkDOHcDnYDBPjgB_Mountaintop%20Removal_Mountaintop%20Removal%20in%20West%20Virginia%20involves%20dumping%20tops%20of%20mountains%20into%20valleys%20to%20access%20coal%20seams%2C%20often%20polluting%20watersheds%2E_blsat_DkDV-99mHP-OgW_Mountaintop%20Removal_Mountaintop%20Removal%20in%20West%20Virginia%20involves%20moving%20aside%20the%20tops%20of%20mountains%20to%20access%20coal%20seams%2E%20This%20practice%20often%20poisons%20water%2E_blsat_DkDVlMmn4Acs_iB_Hei%20Dai%20Gao%20Coal_Open%20pit%20coal%20mining%20in%20China%2E_blsat_DkDcYs5sY3cKrZ_Alberta%20Tar%20Sands_Tar%20Sands%20extraction%20in%20Alberta%2C%20Canada%2E%20Half%20of%20the%20tar%20extracted%20is%20burned%20to%20process%20the%20other%20half%2E_blsat_DkDVNViXQeyQjgB_Peru%20Mining_Tailings%20from%20artisinal%20gold%20mining%20in%20Peru%2E_blsat_DkDVEuOaR5YwojB_Grasberg%20Mine_Grasberg%20Mine%20in%20Indonesia%20is%20the%20largest%20gold%20mine%20and%20third%20largest%20copper%20mine%2E_blsat_DkDVOnDa0YXw6d_Grasberg%20Tailings_Tailings%20from%20Grasberg%20Mine%2E_blsat_DkDOcGQprwpkmR_Aral%20Sea_Water%20previously%20terminating%20in%20Aral%20Sea%20is%20diverted%20for%20agriculture%2E%20Drought%20is%20further%20accelerating%20water%20loss%2E_blsat_DkDOYrnkxOVh6c_Saudi%20Irrigation_Cropland%20in%20Saudi%20Arabia%20is%20irrigated%20from%20ancient%20aquifer%2E_blsat_DkDPWPyXs9wR6gB_Rondonia_Conversion%20of%20forests%20to%20farmland%20in%20Rondonia%2C%20Brazil%2E_blsat_DkDPZ85XKYIShT_Rondonia_Conversion%20of%20forests%20to%20farmland%20in%20Rondonia%2C%20Brazil%2E_blsat_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_Arc%20of%20deforestation%2C%20Amazon%20Rain%20Forest%2E_blsat_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_Yellower%20tones%20indicate%20slowing%20rate%20of%20deforestation%2C%20while%20redder%20tones%20indicate%20speeding%20rate%2E_blsat%2Cfly_DkDPNEabGoEs-N_Indonesia%20Forests_Forest%20loss%20in%20Indonesia%20is%20accelerating%2E_blsat%2Cfly_DkDAm4fVqIeqoO_Sumatra%20Fires_Fires%20in%20Sumatra%2C%20Indonesia%20remove%20forest%20for%20agriculture%2E_blsat%2Ch8_DkDPA0dbA0dbJ_Forestry%20SE%20US_Forestry%20in%20Southeast%20United%20States%20supplies%20paper%20pulp%20and%20biomass%20for%20power%20generation%2E_blsat%2Cflg_DkDWWnfme-zqiiB_Longyangxia%20Solar_Longyangxia%20Dam%20Solar%20Park%2C%20China%3A%20320MW%20photovoltaic_blsat_DkDPOxFm4qZJ2iB_Solar%20Star_Solar%20Star%2C%20US%3A%20579MW%20photovoltaic_blsat_DkDPjqQmuXJJojB_Topaz%20Solar%20Farm_Topaz%20Solar%20Farm%2C%20US%3A%20550MW%20photovoltaic_blsat_DkDPKtwiQVVmojB_Charanka%20Solar%20Park_Charanka%20Solar%20Park%2C%20India%3A%20600MW%20photovoltaic_blsat_DkDPGUUmWP2JojB_Ivanpah%20Solar%20Power_Ivanpah%20Solar%20Power%2C%20US%3A%20Largest%20concentrated%20solar%20power%2C%20392MW_blsat_DkDP22pmX2kaojB_Valle%20Solar%20Power_Valle%20Solar%2C%20Spain%3A%20100MW%20concentrated%20solar_blsat_DkDPI2unYMQqrhB_Gansu%20Wind%20Farm_Gansu%20Wind%20Farm%2C%20China%3A%208GW%20%2820GW%20planned%29_blsat_DkDPEuJmc6aJojB_Alta%20Wind%20Farm_Alta%20Wind%20Farm%2C%20US%3A%201%2E5GW_blsat_DkDPD7CnLTtMiK_US%20Wind_Wind%20turbine%20installation%20across%20the%20United%20States%2E_blsat%2Cwp_DkDPD7CnLTtMiK_US%20Photovoltaic_Solar%20photovoltaic%20installations%20across%20the%20United%20States%2E_blsat%2Csp_DkDV0jvjsXrchC_Industrialization__blsat_DkDVlsznvjQPkgBPittsburgh%2C%20USA%2C%20demonstrates%20long-term%20exurban%20growth%2C%20with%20significant%20greenspace%20loss%20rather%20than%20through%20densification%2E_Pittsburgh_Pittsburgh_blsat_DkDWksznwjQP_ZPittsburgh%27s%20evolution%20demonstrates%20residential%20and%20industrial%20sites%20intermingled%2C%20bringing%20questions%20of%20airshed%20and%20watershed%20toxicity%20to%20the%20forefront%20as%20major%20emissions%2C%20residences%20and%20schools%20all%20collocate%2E_Pittsburgh_Pittsburgh_blsat%2Clan_DkDVLjfdNa_b5cLagos%2C%20Nigeria%20has%20witnessed%20massive%20growth%2C%20from%2017%20million%20in%202006%20to%20over%2020%20million%20today%2E_Lagos_Lagos_blsat_DkDVLjfdNa_b5cLiving%20resources%20of%20water%20and%20forest%20in%20Lagos%2C%20Nigeria%20are%20threatened%20by%20massive%20growth%20due%20to%20economic%20opportunity%2E%20This%20combination%20demands%20thoughtful%20and%20long-term%20planning%2E_Lagos_Lagos_blsat%2Cflg_DkDP4t6mgw0u7cSeoul%2C%20Korea%20demonstrated%20long-term%20urban%20protected%20area%20planning%20with%20regions%20such%20as%20Bukhansan%20National%20Park%2C%20preserving%20greenspace%20during%20urban%20densification%2E_Seoul_Seoul_blsat%2Cwdpa_DkDP4t6mgw0u7cSeoul%2C%20Korea%20demonstrated%20long-term%20urban%20protected%20area%20planning%20with%20regions%20such%20as%20Bukhansan%20National%20Park%2C%20preserving%20greenspace%20during%20urban%20densification%2E_Seoul_Seoul_blsat%2Cflg_DkDQ5wYitp3subThe%20Pearl%20River%20Delta%20in%20China%20has%20witnessed%20massive%20population%20explosions%2C%20with%20Shenzhen%20growing%20from%20a%20mere%2040%2C000%20inhabitants%20to%2040%20million%20in%20three%20decades%2E%20Massive%20land%20use%20transformations%20can%20be%20seen%20in%20concert%20with%20this%20rapid%20growth%2E_Shenzhen_Shenzhen_blsat%2Cwdpa_DkDQrnpWLjJUyaBrasilia%2C%20Brazil%20includes%20the%20largest%20national%20urban%20park%20in%20the%20world%2C%20protecting%20tropical%20savanna%20and%20forest%20in%20order%20to%20balance%20development%20with%20greening%20and%20preservation%2E_Brasilia_Brasilia_blte%2Cwdpa_DkDQoLbXOXaTsVBrasilia%2C%20Brazil%20includes%20the%20largest%20national%20urban%20park%20in%20the%20world%2C%20protecting%20tropical%20savanna%20and%20forest%20in%20order%20to%20balance%20development%20with%20greening%20and%20preservation%2E_Brasilia_Northwest%20of%20Brasilia_blsat%2Cwdpa_DkDQ5YWph63cxfThe%20forestation%20of%20agricultural%20areas%20around%20Milan%2C%20Italy%20serves%20as%20an%20example%20of%20conservation%20management%2C%20now%20prevalent%20in%20numerous%20locales%20throughout%20Europe%2E_Milano_Milano_blsat_DkDQSHLrsBhcigBGermany%20has%20increased%20its%20forest%20cover%20by%20more%20than%203%25%2C%20thanks%20to%20explicit%20forestation%20policies%20surrounding%20urban%20areas%2E_Duisburg_Duisburg_blsat_DkDQENjTEnwf2dUrbanization%20in%20the%20Jo%27burg%20-%20Pretoria%20corridor%20has%20greatly%20increased%20urban%20land%20use%20throughout%20Gauteng%20Province%2C%20placing%20industrial%20and%20residential%20activities%20close%20together%20as%20in%20other%20industrial%2C%20growing%20locales%20around%20the%20world%2E_Pretoria_Pretoria%2C%20South%20Afria_blsat_DkDAFpEbiqFhmjB_Nairobi_Nairobi_blsat_DkDAZdNelWYhojB_Addis%20Ababa_Addis%20Ababa_blsat_DkDAGq9mKcYi8VThe%20gradual%20disappearance%20of%20Lake%20Urmia%20in%20Iran%20is%20a%20token%20of%20resource%20shifts%20today%2C%20culmination%20from%20short-term%20human%20decisions%20combined%20with%20long-term%20global%20trends%2E%20These%20markers%20of%20change%20are%20near-time%20exemplars%20of%20long-term%20changes%20in%20watershed%2C%20arable%20land%20and%20climate%20dynamics%20that%20shift%20opportunities%20globally%2E_Lake%20Urmia_Lake%20Urmia_blsat_DkDAGyOdZ5mcnCToday%20we%20can%20map%20every%20coral%20reef%2C%20and%20we%20can%20visualize%20bleaching%20events%20annually%20over%20decades%2C%20helping%20to%20understand%20visually%20the%20global%20impact%20of%20changes%20in%20ocean%20chemistry%20now%20underway%2E_Coral%20Reefs_Coral%20Reefs_blsat%2Ccb_DkDAHBYiAv1s9aPearl%20River%20Delta%20%28Shenzhen%29%2C%20China_Shenzhen_Shenzhen_blsat_DkDAm4fVqIeqoO_Himawari-8__blsat%2Ch8_DkDAm4fVqIeqoO_Sumatra%20Fires_Fires%20in%20Sumatra%2C%20Indonesia%20remove%20forest%20for%20agriculture%2E_blsat%2Ch8_DkDAm4fVqIeqoO_Sinabung%20Volcano_Eruption%20of%20Sinabung%20volcano%20in%20Sumatra%2C%20Indonesia%2E_blsat%2Ch8_DkDAm4fVqIeqoO_Clear%20Beijing_Relatively%20clear%20day%20for%20Beijing%2C%20China%2E_blsat%2Ch8_DkDAm4fVqIeqoO_Hazy%20Beijing_Hazy%20day%20in%20Beijing%2C%20China%2E_blsat%2Ch8_DkDAm4fVqIeqoO_Hazier%20Beijing_Very%20hazy%20day%20in%20Beijing%2C%20China%2E_blsat%2Ch8_DkDAm4fVqIeqoO_Melting%20Snow_Melting%20snow%2C%20Inner%20Mongolia%2C%20China%2E_blsat%2Ch8_DkDAm4fVqIeqoO_Ice%20Floes_Ice%20floes%20off%20the%20coast%20of%20Antarctica%2E_blsat%2Ch8_DkDAm4fVqIeqoO_Iceberg%20calving_Large%20iceberg%20calving%20off%20the%20coast%20of%20Antarctica%2E_blsat%2Ch8_DkDAm4fVqIeqoO_Typhoon%20In-Fa_Typhoon%20In-Fa%20was%20the%2024th%20category%204%2B%20typhoon%20for%20the%202015%20season%2C%20shattering%20the%20previous%20record%20of%2018%20such%20typhoons%20in%20a%20season%2E%20Luckily%2C%20it%20did%20not%20make%20landfall%2E_blsat%2Ch8_Untitled_B";
	  // "https://docs.google.com/spreadsheets/d/1lWFdujSWrPdNM-NpyyeOL5ZirCkTpvFZMBR5spAQArY/edit?usp=sharing"
	  var waypointSliderContentPath = EARTH_TIMELAPSE_CONFIG.waypointSliderContentPath || "default-waypoints.tsv";
	  var showEVA = !!EARTH_TIMELAPSE_CONFIG.showEVA;
	  var showLODES = !!EARTH_TIMELAPSE_CONFIG.showLODES;
	  var showForestAlerts = !!EARTH_TIMELAPSE_CONFIG.showForestAlerts;
	  var showMonthlyRefugees = !!EARTH_TIMELAPSE_CONFIG.showMonthlyRefugees;
	  var showGlobalWindPower = !!EARTH_TIMELAPSE_CONFIG.showGlobalWindPower;
	  var showShareButton = (window.location.hash.indexOf("showShareButton") >= 0);
	  var isHyperwall = showShareButton ? false : !!EARTH_TIMELAPSE_CONFIG.isHyperwall;
	  var useGoogleMaps = !!EARTH_TIMELAPSE_CONFIG.useGoogleMaps;
	  var useGoogleSearch = (typeof(EARTH_TIMELAPSE_CONFIG.useGoogleSearch) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useGoogleSearch;
	  var enableAutoMode = !!EARTH_TIMELAPSE_CONFIG.enableAutoMode;
	  var screenTimeoutInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.screenTimeoutInMilliseconds) || 8 * 60 * 1000;
	  var waypointDelayInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.waypointDelayInMilliseconds) || 1 * 15 * 1000;
	  var defaultPlaybackSpeed = parseFloat(EARTH_TIMELAPSE_CONFIG.defaultPlaybackSpeed) || 0.5;
	  var enableLetterboxMode = !!EARTH_TIMELAPSE_CONFIG.enableLetterboxMode;
	  var useFaderShader = (typeof(EARTH_TIMELAPSE_CONFIG.useFaderShader) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useFaderShader;
	  var enableWaypointText = (typeof(EARTH_TIMELAPSE_CONFIG.enableWaypointText) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.enableWaypointText;
	  var enableRecordingMode = !!EARTH_TIMELAPSE_CONFIG.enableRecordingMode;
	  var trackingId = EARTH_TIMELAPSE_CONFIG.trackingId || "UA-4157572-7";
	  var rootTilePath = (typeof(EARTH_TIMELAPSE_CONFIG.rootTilePath) == "undefined") ? "../../../data/" : EARTH_TIMELAPSE_CONFIG.rootTilePath;

	  var landsatMaxScale = 1.25;
	  var himawariMaxScale = 0.02;
	  var isAutoModeRunning = false;
	  var visibleBaseMapLayer = "landsat";
	  var previousVisibleBaseMapLayer = visibleBaseMapLayer;
	  WebglVideoTile.useFaderShader = useFaderShader;
	  var timelapse, previousWaypoint = {}, previousHimawariIdx, waypointViewChangeListener, hideWaypointListener;
	  var himawariWaypoints = {};
	  var timelineType = "customUI";
	  var activeLayersWithTimeline = 0;
	  var keysDown = [];

	  // This is necessary because waypoint thumbnails are generated from the Landsat set and thus the best we can show is just a solid black thumbnail
	  // instead of some random location that a himawari bounds corresponds to in Landsat.
	  var himawariWaypointThumbnailBounds = {xmin: 1018272.2506574813, xmax: 1019810.9508472969, ymin: 750319.6448379, ymax: 750725.1564504242};


	  // ## 1 ##
	  //
	  //// Layer variables ////
	  //

	  var forestAlertsTimeMachineLayer, forestAlertsNoOverlayTimeMachineLayer, landsatBaseMapLayer, darkBaseMapLayer, lightBaseMapLayer, wdpaVectorLayer, mcrmVectorLayer;
	  var hansenMapLayer, hansenMapLayer2, viirsTile, coralBleachingTile, lightsAtNightMapLayer, crwTimemachineLayer, animatedHansenLayer, himawariTimemachineLayer;
	  var waterOccurrenceLayer, waterChangeLayer, usgsWindTurbineLayer, solarInstallsLayer, drillingLayer, monthlyRefugeesTile;
	  var globalWindPowerLayer;

	  // ## 2 ##
	  //// Layer tile paths
	  //

	  var landsatUrl = rootTilePath + "/earthtime-annual-2015-v2/1068x600";
	  // Using "https" will casue the thumbnail loading from the server to fail
	  //var landsatUrl = "http://earthengine.google.org/timelapse/data/20130507";
	  var crwTimemachineUrl = rootTilePath + "/coral/coralreefwatch-2.timemachine/crf20-22fps-1424x800";
	  var himawariTimemachineUrl = rootTilePath + "/himawari8/himawari8-nov-2015.timemachine/crf26-12fps-1424x800";
	  var forestAlertsTimeMachineUrl = rootTilePath + "/global-forest-alerts/ForestAlarms2016v2/1068x600";
	  var forestAlertsNoOverlayTimeMachineUrl = rootTilePath + "/global-forest-alerts/ForestAlarmsNoOverlay2016v1/1068x600";

	  var osmDefaultUrl = rootTilePath + "/openstreetmap/default/";
	  var osmLightRetinaUrl = rootTilePath + "/openstreetmap/light_all_retina/{default}/{z}/{x}/{y}.png";
	  var osmDarkRetinaUrl = rootTilePath + "/openstreetmap/dark_all_retina/{default}/{z}/{x}/{y}.png";
	  var gfcTransUrl = rootTilePath + "/global-forest-change/loss_year_transparent/{default}/{z}/{x}/{y}.png";
	  var gfcLossGainUrl = rootTilePath + "/global-forest-change/loss_tree_gain/{default}/{z}/{x}/{y}.png";
	  var googleMapsDefaultUrl = "https://mts0.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0";
	  var googleMapsDarkStyleUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0";
	  var googleMapsDefaultRetinaUrl = "https://mts1.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0!5m1!5f2";
	  var googleMapsDarkStyleRetinaUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0!5m1!5f2";
	  var lightMapUrl = useGoogleMaps ? googleMapsDefaultRetinaUrl : osmLightRetinaUrl;
	  var darkMapUrl = useGoogleMaps ? googleMapsDarkStyleRetinaUrl : osmDarkRetinaUrl;
	  var lightsAtNightUrl = rootTilePath + "/lights-at-night/{default}/{z}/{x}/{y}.png";
	  var waterOccurrenceUrl = rootTilePath + "/water/occurrence-2015/{default}/{z}/{x}/{y}.png";
	  var waterChangeUrl = rootTilePath + "/water/change-2015/{default}/{z}/{x}/{y}.png";

	  var wdpaUrl = rootTilePath + "/wdpaline-year";
	  var mcrmUrl = rootTilePath + "/coral/mcrm-lines-wrapdateline";
	  var viirsUrl = rootTilePath + "/viirs/createlab-viirs-uncorrected-20140314-20150403.bin";
	  var coralBleachingUrl = rootTilePath + "/coral/bleaching_reports_4km_81-10.bin";
	  var usgsWindTurbineUrl = rootTilePath + "/energy/wind-installs-usgs";
	  var solarInstallsUrl = rootTilePath + "/energy/solar-installs";
	  var globalWindPowerUrl = rootTilePath + "/energy/global-wind-power";
	  var drillingUrl = rootTilePath + "/energy/drilling";
	  var animatedHansenUrls = [gfcTransUrl, gfcLossGainUrl];
	  var monthlyRefugeesUrl = rootTilePath + '/monthly-mediterranean-refugees/monthly-mediterranean-refugees-20140101-20160701.bin';

	  function init() {
		var settings = {
		  loopDwell: { startDwell:1.5, endDwell:1.5 },
		  playbackSpeed: defaultPlaybackSpeed,
		  viewerType: "webgl",
		  url: landsatUrl,
		  enablePresentationSlider: enableRecordingMode ? false : true,
		  enableEditor: enableRecordingMode ? true : false,
		  showEditorOnLoad: enableRecordingMode ? true : false,
		  thumbnailServerRootTileUrl: "http://earthengine.google.org/timelapse/data/20130507",
		  showFullScreenBtn: false,
		  showShareBtn: showShareButton,
		  presentationSliderSettings: enableRecordingMode ? {} : {
			onLoadAnimation: "none",
			playAfterAnimation: false,
			initialWaypointIndex: 0,
			doAutoMode: enableAutoMode,
			showAnnotations: false,
			screenIdleTime: screenTimeoutInMilliseconds,
			waypointDelayTime: waypointDelayInMilliseconds,
			height: 94
		  },
		  useTouchFriendlyUI: isHyperwall,
		  datasetType: "landsat",
		  playOnLoad: enableRecordingMode ? false : true,
		  mediaType: ".mp4",
		  onTimeMachinePlayerReady: function(viewerDivId) {},
		  scaleBarOptions: {
			scaleBarDiv: "scaleBar1"
		  },
		  contextMapOptions: {
			contextMapDiv: "contextMap1",
			tileType: useGoogleMaps ? "Google" : "OpenStreetMap",
			tileUrl: osmDefaultUrl,
			geometry: {
			  width: 270,
			  height: 200
			}
		  },
		  isGoogleAnalyticEventTrackingEnabled: true,
		  startEditorFromPresentationMode : true
		};

		if (enableLetterboxMode) {
		  $("#timeMachine").addClass("letterbox");
		  $("#letterbox-middle").replaceWith($("#timeMachine"));
		} else {
		  $("#content").remove();
		}

		if(enableRecordingMode) {
		  $("#timeMachine, #content").addClass("recording");
		  $("#letterbox-bottom").remove();
		}

		timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", settings);
		onTimeMachinePlayerReady();

		//document.body.appendChild( stats.domElement );
		//$(stats.domElement).css('z-index', 1000);

		perf = new WebglTimeMachinePerf(document.getElementById('stats'), timelapse);
		$('#stats').hide();
		/*$(document).keypress(function(e) {
		  // ctrl-a toggles perf
		  if (e.keyCode == 1) {
			$('#stats').toggle();
		  }
		});*/
	  }

	  $(init);

	  function loadHimawari() {
		if (!$("#show-himawari").prop('checked')) {
		  $('#show-himawari').prop('checked', true);
		  timelineType = "defaultUI";
		  requestNewTimeline("himawari-times.json", timelineType);
		  showHimawariTimeMachineLayer = true;
		  var v = timelapse.getVideoset();
		  v.setFps(12);
		  timelapse.setMaxScale(himawariMaxScale);
		  timelapse.setDoDwell(false);
		  timelapse.setPlaybackRate(1);
		  previousVisibleBaseMapLayer = visibleBaseMapLayer;
		  visibleBaseMapLayer = "himawari";
		  $("#layers-legend").hide();
		}
	  }

	  function googleMapsLoadedCallback() {
		if (useGoogleSearch) {
		  var autocomplete = new google.maps.places.Autocomplete($("#location_search").get(0));
		  var geocoder = new google.maps.Geocoder();

		  // Hack to enable places selection from dropdown on touch screens
		  $(document).on('touchstart', '.pac-item', function(e){
			e.preventDefault();
			var searchText = $(this).text();
			$("#location_search").val(searchText);
			google.maps.event.trigger(autocomplete, 'place_changed', {locationName: searchText});
			$('.pac-container').hide();
		  });

		  google.maps.event.addListener(autocomplete, 'place_changed', function(options) {
			var place = (options && options.locationName) || autocomplete.getPlace();
			if (!place) return;
			if (!place.geometry) {
			  var address = $("#location_search").val();
			  $("#location_search").val("");
			  geocoder.geocode({
				'address': address
			  }, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
				  var lat = results[0].geometry.location.lat();
				  var lng = results[0].geometry.location.lng();
				  newView = {
					center: {
					  "lat": lat,
					  "lng": lng
					},
					"zoom": 10
				  };
				  timelapse.setNewView(newView, false, false);
				} else {
				  console.log("Geocode failed: " + status);
				}
			  });
			} else {
			  var newView = {
				center: {
				  "lat": place.geometry.location.lat(),
				  "lng": place.geometry.location.lng()
				},
				"zoom": 10
			  };
			  timelapse.setNewView(newView, false, false);
			}

			var searchLocation = (options && options.locationName) || place.formatted_address;
			if (searchLocation) {
			  searchLocation = searchLocation.replace(/ /g, '');
			  UTIL.addGoogleAnalyticEvent('textbox', 'search', 'go-to-searched-place=' + searchLocation);
			}
		  });
		}
	  }

	  // Wait until currrent execution finishes so that we can skip loading the timeline in case it is not the last call.
	  // We do this because the timeline loads asynchronously; otherwise, the next waypoint might use the wrong timeline.
	  var finalizeNewTimelineTimeout = null;
	  function requestNewTimeline(url, newTimelineStyle) {
	   // The last timeline request takes precedence
	   if (finalizeNewTimelineTimeout !== null) {
		 clearTimeout(finalizeNewTimelineTimeout);
		 finalizeNewTimelineTimeout = null;
	   }
	   finalizeNewTimelineTimeout = setTimeout(function () {
		 timelapse.loadNewTimeline(url, newTimelineStyle);
		 finalizeNewTimelineTimeout = null;
	   }, 0);
	  }

	  function initLayerToggleUI() {
		// ## 3 ##
		//// Layer toggle event handlers ////
		//

		$("#show-water-occurrence").on("click", function() {
		  var $this = $(this);
		  if ($this.is(':checked')) {
			showWaterOccurrenceLayer = true;
			if ($("#show-water-change").prop('checked')) {
			  $("#show-water-change").click();
			}
			$("#water-occurrence-legend").show();
		  } else {
			showWaterOccurrenceLayer = false;
			$("#water-occurrence-legend").hide();
		  }
		}).prop('checked', showWaterOccurrenceLayer);

		$("#show-water-change").on("click", function() {
		  var $this = $(this);
		  if ($this.is(':checked')) {
			showWaterChangeLayer = true;
			if ($("#show-water-occurrence").prop('checked')) {
			  $("#show-water-occurrence").click();
			}
			$("#water-change-legend").show();
		  } else {
			showWaterChangeLayer = false;
			$("#water-change-legend").hide();
		  }
		}).prop('checked', showWaterChangeLayer);

		$("#show-wdpa").on("click", function() {
		  var $this = $(this);
		  if ($this.is(':checked')) {
			showWdpaLayer = true;
			$("#wdpa-legend").show();
		  } else {
			showWdpaLayer = false;
			$("#wdpa-legend").hide();
		  }
		}).prop('checked', showWdpaLayer);

		$("#show-forest-change").on("click", function() {
		  if ($(this).prop('checked')) {
			showHansenLayer = true;
			if ($("#show-forest-loss-gain").prop('checked')) {
			  $("#show-forest-loss-gain").click();
			}
			if ($("#show-animated-forest-loss-gain").prop('checked')) {
			  $("#show-animated-forest-loss-gain").click();
			}
			if ($("#show-forest-alerts").prop('checked')) {
			  $("#show-forest-alerts").click();
			}
			if ($("#show-forest-alerts-no-overlay").prop('checked')) {
			  $("#show-forest-alerts-no-overlay").click();
			}
			$("#forest-loss-year-legend").show();
		  } else {
			showHansenLayer = false;
			$("#forest-loss-year-legend").hide();
		  }
		}).prop('checked', showHansenLayer);

		$("#show-forest-loss-gain").on("click", function() {
		  if ($(this).prop('checked')) {
			showHansenLayer2 = true;
			if ($("#show-forest-change").prop('checked')) {
			  $("#show-forest-change").click();
			}
			if ($("#show-animated-forest-loss-gain").prop('checked')) {
			  $("#show-animated-forest-loss-gain").click();
			}
			if ($("#show-forest-alerts").prop('checked')) {
			  $("#show-forest-alerts").click();
			}
			if ($("#show-forest-alerts-no-overlay").prop('checked')) {
			  $("#show-forest-alerts-no-overlay").click();
			}
			$("#forest-loss-gain-legend").show();
		  } else {
			showHansenLayer2 = false;
			$("#forest-loss-gain-legend").hide();
		  }
		}).prop('checked', showHansenLayer2);

		$("#show-animated-forest-loss-gain").on("click", function() {
		  if ($(this).prop('checked')) {
			showAnimatedHansenLayer = true;
			setActiveLayersWithTimeline(1);
			if ($("#show-forest-change").prop('checked')) {
			  $("#show-forest-change").click();
			}
			if ($("#show-forest-loss-gain").prop('checked')) {
			  $("#show-forest-loss-gain").click();
			}
			if ($("#show-forest-alerts").prop('checked')) {
			  $("#show-forest-alerts").click();
			}
			if ($("#show-forest-alerts-no-overlay").prop('checked')) {
			  $("#show-forest-alerts-no-overlay").click();
			}
			$("#forest-loss-gain-legend").show();
		  } else {
			showAnimatedHansenLayer = false;
			setActiveLayersWithTimeline(-1);
			$("#forest-loss-gain-legend").hide();
		  }
		}).prop('checked', showViirsLayer);

		$("#show-forest-alerts").on("click", function() {
		  // Do not load if Himawari is up
		  if ($("#show-himawari").prop('checked')) {
			$(this).prop('checked', false);
			return;
		  }
		  if ($(this).prop('checked')) {
			timelineType = "defaultUI";
			requestNewTimeline("forest-alerts-times.json", timelineType);
			showForestAlertsTimeMachineLayer = true;
			setActiveLayersWithTimeline(1);
			if ($("#show-forest-change").prop('checked')) {
			  $("#show-forest-change").click();
			}
			if ($("#show-forest-loss-gain").prop('checked')) {
			  $("#show-forest-loss-gain").click();
			}
			if ($("#show-animated-forest-loss-gain").prop('checked')) {
			  $("#show-animated-forest-loss-gain").click();
			}
			if ($("#show-forest-alerts-no-overlay").prop('checked')) {
			  $("#show-forest-alerts-no-overlay").click();
			}
			var v = timelapse.getVideoset();
			v.setFps(10);
			timelapse.setMaxScale(landsatMaxScale);
			timelapse.setDoDwell(false);
			timelapse.setPlaybackRate(1);
			previousVisibleBaseMapLayer = visibleBaseMapLayer;
			visibleBaseMapLayer = "forest-alarms";
		  } else {
			showForestAlertsTimeMachineLayer = false;
			setActiveLayersWithTimeline(-1);
			if (!showForestAlertsNoOverlayTimeMachineLayer && !showForestAlertsTimeMachineLayer) {
			  timelineType = "customUI";
			  requestNewTimeline("landsat-times.json", timelineType);
			  visibleBaseMapLayer = $("input:radio[name=base-layers]:checked").val();
			  timelapse.setMaxScale(landsatMaxScale);
			  var v = timelapse.getVideoset();
			  v.setFps(10);
			  timelapse.setDoDwell(true);
			  timelapse.setPlaybackRate(defaultPlaybackSpeed);
			}
		  }
		}).prop('checked', showForestAlertsTimeMachineLayer);

		$("#show-forest-alerts-no-overlay").on("click", function() {
		  // Do not load if Himawari is up
		  if ($("#show-himawari").prop('checked')) {
			$(this).prop('checked', false);
			return;
		  }
		  if ($(this).prop('checked')) {
			timelineType = "defaultUI";
			requestNewTimeline("forest-alerts-times.json", timelineType);
			showForestAlertsNoOverlayTimeMachineLayer = true;
			setActiveLayersWithTimeline(1);
			if ($("#show-forest-change").prop('checked')) {
			  $("#show-forest-change").click();
			}
			if ($("#show-forest-loss-gain").prop('checked')) {
			  $("#show-forest-loss-gain").click();
			}
			if ($("#show-animated-forest-loss-gain").prop('checked')) {
			  $("#show-animated-forest-loss-gain").click();
			}
			if ($("#show-forest-alerts").prop('checked')) {
			  $("#show-forest-alerts").click();
			}
			var v = timelapse.getVideoset();
			v.setFps(10);
			timelapse.setMaxScale(landsatMaxScale);
			timelapse.setDoDwell(false);
			timelapse.setPlaybackRate(1);
			previousVisibleBaseMapLayer = visibleBaseMapLayer;
			visibleBaseMapLayer = "forest-alarms-no-overlay";
		  } else {
			showForestAlertsNoOverlayTimeMachineLayer = false;
			setActiveLayersWithTimeline(-1);
			if (!showForestAlertsNoOverlayTimeMachineLayer && !showForestAlertsTimeMachineLayer) {
			  timelineType = "customUI";
			  requestNewTimeline("landsat-times.json", timelineType);
			  visibleBaseMapLayer = $("input:radio[name=base-layers]:checked").val();
			  timelapse.setMaxScale(landsatMaxScale);
			  var v = timelapse.getVideoset();
			  v.setFps(10);
			  timelapse.setDoDwell(true);
			  timelapse.setPlaybackRate(defaultPlaybackSpeed);
			}
		  }
		}).prop('checked', showForestAlertsNoOverlayTimeMachineLayer);

		$("#show-viirs").on("click", function() {
		  if ($(this).prop('checked')) {
			showViirsLayer = true;
			setActiveLayersWithTimeline(1);
			timelapse.setPlaybackRate(8);
			timelineType = "defaultUI";
			requestNewTimeline("viirs-times.json", timelineType);
			timelapse.setDoDwell(false);
			$("#show-additional-landsat").prop("disabled", true);
			$("#fires-at-night-legend").show();
		  } else {
			showViirsLayer = false;
			setActiveLayersWithTimeline(-1);
			timelapse.setPlaybackRate(defaultPlaybackSpeed);
			timelineType = "customUI";
			requestNewTimeline("landsat-times.json", timelineType);
			timelapse.setDoDwell(true);
			$("#show-additional-landsat").prop("disabled", false);
			$("#fires-at-night-legend").hide();
		  }
		}).prop('checked', showViirsLayer);

		$("#show-coral").on("click", function() {
		  if ($(this).prop('checked')) {
			showCoralBleachingLayer = true;
			showMcrmLayer = true;
			setActiveLayersWithTimeline(1);
			$("#coral-bleaching-legend").show();
		  } else {
			showCoralBleachingLayer = false;
			showMcrmLayer = false;
			setActiveLayersWithTimeline(-1);
			if (!$("#show-coral-bleaching-alerts").prop('checked'))
			$("#coral-bleaching-legend").hide();
		  }
		}).prop('checked', showCoralBleachingLayer);

		$("#show-coral-bleaching-alerts").on("click", function() {
		  if ($(this).prop('checked')) {
			timelineType = "defaultUI";
			requestNewTimeline("crw-times.json", timelineType);
			showCrwTimemachineLayer = true;
			showMcrmLayer = true;
			setActiveLayersWithTimeline(1);
			var v = timelapse.getVideoset();
			v.setFps(22);
			timelapse.setDoDwell(false);
			WebglVideoTile.useGreenScreen = true;
			$("#coral-bleaching-alerts-legend").show();
			$("#coral-bleaching-legend").show();
		  } else {
			showCrwTimemachineLayer = false;
			showMcrmLayer = false;
			setActiveLayersWithTimeline(-1);
			timelineType = "customUI";
			requestNewTimeline("landsat-times.json", timelineType);
			timelapse.setDoDwell(true);
			WebglVideoTile.useGreenScreen = false;
			var v = timelapse.getVideoset();
			v.setFps(10);
			$("#coral-bleaching-alerts-legend").hide();
			if (!$("#show-coral").prop('checked'))
			  $("#coral-bleaching-legend").hide();
		  }
		}).prop('checked', showCrwTimemachineLayer);

		$("#show-himawari").on("click", function() {
		  $(".map-layer-div input:checked").not("#show-himawari").trigger("click");
		  if ($(this).prop('checked')) {
			timelineType = "defaultUI";
			requestNewTimeline("himawari-times.json", timelineType);
			showHimawariTimeMachineLayer = true;
			setActiveLayersWithTimeline(1);
			var v = timelapse.getVideoset();
			v.setFps(12);
			timelapse.setMaxScale(himawariMaxScale);
			timelapse.setDoDwell(false);
			timelapse.setPlaybackRate(1);
			previousVisibleBaseMapLayer = visibleBaseMapLayer;
			visibleBaseMapLayer = "himawari";
			$("#layers-legend").hide();
		  } else {
			showHimawariTimeMachineLayer = false;
			setActiveLayersWithTimeline(-1);
			timelineType = "customUI";
			requestNewTimeline("landsat-times.json", timelineType);
			var v = timelapse.getVideoset();
			v.setFps(10);
			visibleBaseMapLayer = previousVisibleBaseMapLayer;
			timelapse.setMaxScale(landsatMaxScale);
			timelapse.setDoDwell(true);
			timelapse.setPlaybackRate(defaultPlaybackSpeed);
			$("#layers-legend").hide();
		  }
		  timelapse.warpTo(timelapse.getHomeView());
		}).prop('checked', showHimawariTimeMachineLayer);

		$("#show-usgs-windturbine").on("click", function() {
		  if ($(this).prop('checked')) {
			showUsgsWindTurbineLayer = true;
			setActiveLayersWithTimeline(1);
			$("#wind-installs-legend").show();
		  } else {
			showUsgsWindTurbineLayer = false;
			setActiveLayersWithTimeline(-1);
			$("#wind-installs-legend").hide();
		  }
		}).prop('checked', showUsgsWindTurbineLayer);

		$("#show-global-wind-power").on("click", function() {
		  if ($(this).prop('checked')) {
			showGlobalWindPowerLayer = true;
			setActiveLayersWithTimeline(1);
			$("#global-wind-power-legend").show();
		  } else {
			showGlobalWindPowerLayer = false;
			setActiveLayersWithTimeline(-1);
			$("#global-wind-power-legend").hide();
		  }
		}).prop('checked', showGlobalWindPowerLayer);

		$("#show-solar-installs").on("click", function() {
		  if ($(this).prop('checked')) {
			showSolarInstallsLayer = true;
			setActiveLayersWithTimeline(1);
			$("#solar-installs-legend").show();
		  } else {
			showSolarInstallsLayer = false;
			setActiveLayersWithTimeline(-1);
			$("#solar-installs-legend").hide();
		  }
		}).prop('checked', showSolarInstallsLayer);

		$("#show-drilling").on("click", function() {
		  if ($(this).prop('checked')) {
			showDrillingLayer = true;
			setActiveLayersWithTimeline(1);
			$("#drilling-legend").show();
		  } else {
			showDrillingLayer = false;
			setActiveLayersWithTimeline(-1);
			$("#drilling-legend").hide();
		  }
		}).prop('checked', showDrillingLayer);

		$("#show-lights-at-night").on("click", function() {
		  if ($(this).prop('checked')) {
			showLightsAtNightLayer = true;
			setActiveLayersWithTimeline(1);
			$("#lights-at-night-legend").show();
		  } else {
			showLightsAtNightLayer = false;
			setActiveLayersWithTimeline(-1);
			$("#lights-at-night-legend").hide();
		  }
		}).prop('checked', showCoralBleachingLayer);
		  
		$("#show-monthly-refugees").on("click", function() {
		  if ($(this).prop('checked')) {
			showMonthlyRefugeesLayer = true;
			activeLayersWithTimeline += 1;
			timelapse.setPlaybackRate(.85);
			timelineType = "defaultUI";
			requestNewTimeline("monthly-refugees-times.json", timelineType);
			timelapse.setDoDwell(false);
			$("#monthly-refugees-legend").show();
		  } else {
			showMonthlyRefugeesLayer = false;
			activeLayersWithTimeline -= 1;
			timelapse.setPlaybackRate(defaultPlaybackSpeed);
			timelineType = "customUI";
			requestNewTimeline("landsat-times.json", timelineType);
			timelapse.setDoDwell(true);
			timelapse.setMaxScale(landsatMaxScale);
			$("#monthly-refugees-legend").hide();
		  }
		}).prop('checked', showMonthlyRefugeesLayer);

		// Set the starting base layer
		$("input:radio[name=base-layers]").on("click", function() {
		  visibleBaseMapLayer = $(this).val();
		  if (visibleBaseMapLayer == "landsat" && previousVisibleBaseMapLayer != "landsat")
			setActiveLayersWithTimeline(1);
		  else if (visibleBaseMapLayer != "landsat")
			setActiveLayersWithTimeline(-1);
		  previousVisibleBaseMapLayer = visibleBaseMapLayer;
		});
		$('input:radio[name=base-layers][id=' + visibleBaseMapLayer + '-base]').prop('checked', true);
		// initially set activeLayersWithTimeline to 1 if we first load with landsat enabled.
		if (visibleBaseMapLayer == "landsat")
		  activeLayersWithTimeline = 1;

		// Copy over data attributes to selectmenu
		$.widget("ui.selectmenu", $.ui.selectmenu, {
		  _renderItem: function( ul, item ) {
			var elementdata = item.element.context.dataset;
			var attributesObj = {};
			Object.keys(elementdata).forEach(function(x){
			attributesObj["data-" + x] = elementdata[x];
		  });
		  return $( '<li>' )
			.attr(attributesObj)
			.append(item.label)
			.appendTo( ul );
		  }
		});

		var appendTarget = "#timeMachine";
		if (enableLetterboxMode) {
		  appendTarget = "#content";
		}
		$("#extras-selector").selectmenu({
		  position: {
			at : "left top",
			collision: 'flip',
			using: function(coords, feedback) {
			  // Using 'flip' above, we ensure that the menu either draws up or down, depending upon how much space we have.
			  // Then we place the default select option at either the begining or end based on this direction.
			  $("#extras-selector option[id='default-extras-select']").remove();
			  $(this).css({top: coords.top, left: coords.left});
			  if (feedback.vertical == "top")
				$("#extras-selector").prepend('<option id="default-extras-select" selected="selected" value="select">Select extra content...</option>');
			  else
				$("#extras-selector").append('<option id="default-extras-select" selected="selected" value="select">Select extra content...</option>');
			  $("#extras-selector").selectmenu("refresh");
			}
		  },
		  appendTo: appendTarget
		});

		// Use click event rather than selectmenu 'change' since that event is not registered on the touch screen.
		$(".ui-selectmenu-menu").on("click", "li", function(e) {
			var fileName = $(e.currentTarget).data("filename");
			var fileType = $(e.currentTarget).data("type");
			$("#extras-content").dialog('option', 'title', $(e.currentTarget).text());
			var $extrasHtml = "";
			if (fileType == "image") {
			  $extrasHtml = '<img src="../../../extras/' + fileName + '">';
			  $("#extras-content").html($extrasHtml).dialog("open");
			} else if (fileType == "video") {
			  $extrasHtml = '<video id="extras-video" src="../../../extras/' + fileName + '" controls autoplay></video>';
			  $("#extras-content").html($extrasHtml).dialog("open");
			  $("#extras-video")[0].playbackRate = $(e.currentTarget).data("fileplaybackrate");
			  $("#extras-video").gVideo({
				childtheme:'smalldark'
			  });
			} else if (fileType == "iframe") {
			  $extrasHtml = '<iframe style="border: 0px; scrolling: no; width: 100%; height: 100%" src="' + $(e.currentTarget).data("linkpath") + '"></iframe>';
			  $("#extras-content").html($extrasHtml).dialog("open");
			} else if (fileType == "img") {
			  $extrasHtml = '<img height="100%" style="display: block; margin: 0 auto;" src="../../../extras/' + $(e.currentTarget).data("linkpath") + '">';
			  $("#extras-content").html($extrasHtml).dialog("open");
			} else if (fileType == "link") {
			  window.location.href = $(e.currentTarget).data("linkpath");
			}
		});

		$("#extras-content").dialog({
		  appendTo: "#timeMachine",
		  modal: false,
		  autoOpen: false,
		  draggable: false,
		  resizable: false,
		  dialogClass: "extras-content-video",
		  beforeClose: function(event, ui) {
			var $extrasVideo  = $("#extras-video");
			if ($extrasVideo && $extrasVideo[0]) {
			  $extrasVideo[0].pause();
			  $extrasVideo[0].src = "";
			}
			$("#extras-selector").val("select").selectmenu('refresh');
		  }
		}).css({
		  'z-index': '2000',
		  'left': '0px',
		  'top':'0px'
		});

		$(window).resize(function () {
		  var width = $(window).width();
		  var height = $(window).height();
		  var scale = Math.min(1, Math.min((width * 1.8) / 1920, (height * 1.28) / 1200));
		  if (!enableLetterboxMode) {
			$('#layers-list').css({'transform-origin': 'bottom right', 'transform': 'scale(' + scale + ')'});
		  }
		  if (!isHyperwall && enableLetterboxMode) {
			scale = Math.min(1, Math.min(width / 1920, height / 1080));
			$('.map-layer-div').css({'transform-origin': 'center right', 'transform': 'scale(' + scale + ')'});
			$('.base-map-div').css({'transform-origin': 'center left', 'transform': 'scale(' + scale + ')'});
			$('.extras-selector-div, .location_search_div').css({'transform-origin': 'center left', 'transform': 'scale(' + '0.9' + ')'});
		  }
		});

		$(document).keydown(function(e) {
		  if (keysDown.indexOf(e.keyCode) < 0){
			keysDown.push(e.keyCode);
			// SHIFT + S + V
			if (keysDown[0] === 16 && keysDown[1] === 83 && keysDown[2] === 86) {
			  $(".share").trigger("click");
			}
		  }
		}).keyup(function(e) {
		  keysDown.length = 0;
		});

		$('.map-layer-checkbox').on("click", function() {
		  var selectedLayers = $('.map-layer-checkbox input:checked');
		  var numLayersOn = selectedLayers.size();
		  var continueState = true;
		  selectedLayers.each(function(){
			if (this.id.indexOf("himawari") > 0) {
			  continueState = false;
			} else if (this.id.indexOf("forest-alerts") > 0) {
			  continueState = false;
			}
		  });
		  if (!continueState) return;
		  if (numLayersOn == 0) {
			$("#layers-legend").hide();
		  } else {
			$("#layers-legend").show();
		  }
		});

		$('#layers-list').on("click", "input", function(e) {
		  if (e.originalEvent && event.pageX != 0 && event.pageY != 0)
			UTIL.addGoogleAnalyticEvent('button', 'click', 'layer=' + $(this).prop("id"));
		});

		var timelineUIHandler = function() {
		  if (showLightsAtNightLayer || showHansenLayer2) {
			$(".customControl").hide();
			if (timelineType == "defaultUI" && !$(".controls").is(':visible'))
			  $(".controls").show();
		  } else {
			if (($(".map-layer-div input:checked").length == 0 || showHansenLayer || showWdpaLayer || showWaterOccurrenceLayer || showWaterChangeLayer) && activeLayersWithTimeline == 0 && (visibleBaseMapLayer == "light" || visibleBaseMapLayer == "dark"))
			  $(".customControl").hide();
			else if (!$(".controls").is(':visible'))
			  $(".customControl").show();
		  }
		};

		var setActiveLayersWithTimeline = function(modifier) {
		  activeLayersWithTimeline += modifier;
		  if (activeLayersWithTimeline < 0) activeLayersWithTimeline = 0;
		};

		$('#layers-list input').on("click", timelineUIHandler);

		timelapse.addTimelineUIChangeListener(timelineUIHandler);
	  }
	</script>

	<script src="../../js/TimeMachineCanvasLayer.js" type="text/javascript"></script>

	<script type="text/javascript" src="../../js/base.js"></script>
	<script type="text/javascript" src="../../js/io.js"></script>
	<script type="text/javascript" src="../../js/utils.js"></script>

	<script type="text/javascript">
	  "use strict";

	  /* begin stats */
	  /*var stats = new Stats();
	  stats.setMode(0); // 0: fps, 1: ms
	  // Align top-left
	  stats.domElement.style.position = 'absolute';
	  stats.domElement.style.left = '0px';
	  stats.domElement.style.top = '0px';*/
	  /* end stats */

	  // BEGIN WebGL vars
	  var canvasLayer;
	  var gl, glb;


	  // ## 4 ##
	  //// Layer visibility ////
	  //

	  var showWdpaLayer = false;
	  var showMcrmLayer = false;
	  var showHansenLayer = false;
	  var showHansenLayer2 = false;
	  var showViirsLayer = false;
	  var showCoralBleachingLayer = false;
	  var showLightsAtNightLayer = false;
	  var showCrwTimemachineLayer = false;
	  var showAnimatedHansenLayer = false;
	  var showHimawariTimeMachineLayer = false;
	  var showForestAlertsTimeMachineLayer = false;
	  var showForestAlertsNoOverlayTimeMachineLayer = false;
	  var showWaterOccurrenceLayer = false;
	  var showWaterChangeLayer = false;
	  var showUsgsWindTurbineLayer = false;
	  var showGlobalWindPowerLayer = false;
	  var showSolarInstallsLayer = false;
	  var showDrillingLayer = false;
	  var showMonthlyRefugeesLayer = false;


	  // Default Time Machine visibility
	  var tileViewVisibility = {
		videoTile: true,
		vectorTile: false
	  };

	  function onTimeMachinePlayerReady() {
		// initialize the canvasLayer
		var timeMachineCanvasLayerOptions = {
		  timelapse: timelapse,
		  resizeHandler: resize,
		  animate: true,
		  updateHandler: update,
		  resolutionScale: window.devicePixelRatio || 1
		};
		canvasLayer = new TimeMachineCanvasLayer(timeMachineCanvasLayerOptions);

		// initialize WebGL
		gl = canvasLayer.canvas.getContext('experimental-webgl');
		glb = new Glb(gl);

		var layer_html = '';

		layer_html += '<div id="layers-list">';

		var landsat_base_str = '<label class="landsat-select" for="landsat-base" name="blsat"><input type="radio" id="landsat-base" name="base-layers" value="landsat"/>Earth Engine Timelapse<span class="credit"> (Google)</span></label>';
		var landsat_base = '<td colspan="2">' + landsat_base_str + '</td>';
		var light_base = '<td><label for="light-base" name="blte"><input type="radio" id="light-base" name="base-layers" value="light"/><span>Light Map</span></label></td>';
		var dark_base = '<td><label for="dark-base" name="bdrk"><input type="radio" id="dark-base" name="base-layers" value="dark"/><span>Dark Map</span></label></td>';

		// NOTE NOTE NOTE
		// What is set for the name in the label must never be changed and is forever connected to share links
		// The schema for generating the label name is using the initials of the data product. If this ends up conflicting
		// with one that already exisits, then it is up to you to come up with something. Perhaps the initials of the name you would
		// give it when describing the layer to someone. Keep it as short as possible though.
		// NOTE NOTE NOTE
		var show_wdpa = '<td class="wdpa-select"><label for="show-wdpa" name="wdpa"><input type="checkbox" id="show-wdpa" />Protected Areas<span class="credit"> (UNEP-WCMC)</span></label></td>';
		var show_forest_change = '<td class="forest-change-select"><label for="show-forest-change" name="fly"><input type="checkbox" id="show-forest-change" />Forest Loss by Year<span class="credit"> (Hansen et al)</span></label></td>';
		var show_forest_loss_gain = '<td class="forest-loss-gain-select"><label for="show-forest-loss-gain" name="flg"><input type="checkbox" id="show-forest-loss-gain" />Forest Loss/Gain<span class="credit"> (Hansen et al)</span></label></td>';
		var show_animated_forest_loss_gain = '<td class="animated-forest-loss-select"><label for="show-animated-forest-loss-gain" name="aflg"><input type="checkbox" id="show-animated-forest-loss-gain" />Animated Loss/Gain<span class="credit"> (Hansen et al)</span></label></td>';
		var show_viirs = '<td class="viirs-select"><label for="show-viirs" name="viirs"><input type="checkbox" id="show-viirs" />Fires at Night<span class="credit"> (NOAA)</span></label></td>';
		var show_forest_alerts = '<td class="forest-alerts-select"><label for="show-forest-alerts" name="fla"><input type="checkbox" id="show-forest-alerts" />Forest Loss Alerts<span class="credit"> (Hansen et al)</span></label></td>';
		var show_forest_alert_no_overlay = '<td class="forest-alerts-no-overlay-select"><label for="show-forest-alerts-no-overlay" name="flano"><input type="checkbox" id="show-forest-alerts-no-overlay" />Forest Loss Alerts <span style="font-size: 14px">(No Overlay)</span><span class="credit"> (Hansen et al)</span></label></td>';
		var show_lights_at_night = '<td class="lights-at-night-select"><label for="show-lights-at-night" name="lan"><input type="checkbox" id="show-lights-at-night" />Lights at Night<span class="credit"> (NOAA, Google)</span></label></td>';
		var show_coral = '<td class="coral-select"><label for="show-coral" name="cb"><input type="checkbox" id="show-coral"/>Coral Bleaching<span class="credit"> (NOAA, UNEP-WCMC)</span></label></td>';
		var show_coral_bleaching_alerts = '<td class="coral-bleaching-select"><label for="show-coral-bleaching-alerts" name="crw"><input type="checkbox" id="show-coral-bleaching-alerts" />Coral Reef Watch<span class="credit"> (NOAA, UNEP-WCMC)</span></label></td>';
		var show_usgs_windturbine = '<td class="wind-select"><label for="show-usgs-windturbine" name="wp"><input type="checkbox" id="show-usgs-windturbine" />Wind Power (USA)<span class="credit" style=""> (USGS)</span></label></td>';
		var show_global_wind_power = '<td class="wind-select"><label for="show-global-wind-power" name="wp"><input type="checkbox" id="show-global-wind-power" />Wind Power (Global)<span class="credit" style=""> (TheWindPower.net)</span></label></td>';
		var show_solar_installs = '<td class="solar-select"> <label for="show-solar-installs" name="sp"><input type="checkbox" id="show-solar-installs" />Solar PV (USA)<span class="credit"> (NREL)</span></label></td>';
		var show_drilling = '<td class="drilling-select"><label for="show-drilling" name="drl"><input type="checkbox" id="show-drilling" />Oil/Gas Drilling<span class="credit"> (CREATE Lab)</span></label></td>';
		var show_himawari = '<td class="himawari-select"><label for="show-himawari" name="h8"><input type="checkbox" id="show-himawari" />Himawari-8<span class="credit"> (JMA)</span></label></td>';
		var show_water_occurrence = '<td class="water-occurrence-select"><label for="show-water-occurrence" name="wo"><input type="checkbox" id="show-water-occurrence" />Water Occurrence<span class="credit"> (JRC)</span></label></td>';
		var show_water_change = '<td class="water-change-select"><label for="show-water-change" name="wc"><input type="checkbox" id="show-water-change" />Water Change<span class="credit"> (JRC)</span></label></td>';
		var show_monthly_refugees = '<td class="monthly-refugees-select"><label for="show-monthly-refugees" name="mmr"><input type="checkbox" id="show-monthly-refugees" />Monthly Mediterranean Refugees<span class="credit"> (UNHCR)</span></label></td>';

		if (enableLetterboxMode) {
		  layer_html += '<div class="base-map-div">';
		  layer_html += ' <table class="base-map-radio" cellspacing="3">';
		  layer_html += '   <tr>';
		  layer_html += landsat_base;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += light_base;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += dark_base;
		  layer_html += '   </tr>';
		  layer_html += ' </table>';
		  layer_html += '</div>';
		  layer_html += '<div class="map-layer-div">';
		  layer_html += ' <table class="map-layer-checkbox" cellspacing="3">';
		  layer_html += '   <tr>';
		  layer_html += show_viirs;
		  layer_html += show_solar_installs;
		  layer_html += show_coral;
		  layer_html += show_forest_change;
		  layer_html += show_forest_alerts;
		  layer_html += show_himawari;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += show_lights_at_night;
		  layer_html += show_usgs_windturbine;
		  if (showGlobalWindPower) {
		      layer_html += show_global_wind_power;
   		  }
		  layer_html += show_water_occurrence;
		  layer_html += show_forest_loss_gain;
		  layer_html += show_forest_alert_no_overlay;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += show_drilling;
		  layer_html += show_coral_bleaching_alerts;
		  layer_html += show_water_change;
		  layer_html += show_animated_forest_loss_gain;
		  layer_html += show_wdpa;
		  layer_html += '   </tr>';
		  layer_html += ' </table>';
		  layer_html += '</div>';
		} else {
		  layer_html += '<div class="base-map-div">';
		  layer_html += ' <table class="base-map-radio" cellspacing="0">';
		  layer_html += '   <tr>';
		  layer_html += landsat_base;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += light_base;
		  layer_html += dark_base;
		  layer_html += '   </tr>';
		  layer_html += ' </table>';
		  layer_html += '</div>';
		  layer_html += '<div class="map-layer-div">';
		  layer_html += ' <table class="map-layer-checkbox" cellspacing="0">';
		  layer_html += '   <tr>';
		  layer_html += show_wdpa;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += show_forest_change;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += show_forest_loss_gain;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += show_animated_forest_loss_gain;
		  layer_html += '   </tr>';
		  if (showForestAlerts) {
			layer_html += '   <tr>';
			layer_html += show_forest_alerts;
			layer_html += '   </tr>';
			layer_html += '   <tr>';
			layer_html += show_forest_alert_no_overlay;
			layer_html += '   </tr>';
		  }
		  layer_html += '   <tr>';
		  layer_html += show_viirs;
		  layer_html += '   </tr>';
		  layer_html += show_lights_at_night;
		  layer_html += '   <tr>';
		  layer_html += show_coral;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += show_coral_bleaching_alerts;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += show_usgs_windturbine;
		  layer_html += '   </tr>';
		  if (showGlobalWindPower) {
		      layer_html += '   <tr>';
		      layer_html += show_global_wind_power;
		      layer_html += '   </tr>';
    	  }
		  layer_html += '   <tr>';
		  layer_html += show_solar_installs;
		  layer_html += '   </tr>';
		  layer_html += '   <tr>';
		  layer_html += show_drilling;
		  layer_html += '   </tr>';
		  if (showMonthlyRefugees){
			  layer_html += '   <tr>';
			  layer_html += show_monthly_refugees;
			  layer_html += '   </tr>';
		  }
		  layer_html += '   <tr>';
		  layer_html += show_himawari;
		  layer_html += '   </tr>';
		  layer_html += ' </table>';
		  layer_html += '</div>';
		  // ## 5 ##
		  //// Add layer to UI panel ////
		  //
		}

		layer_html += '<div class="extras-selector-div">';
		layer_html += ' <select name="extras-selector" id="extras-selector">';
		layer_html += '   <option id="default-extras-select" selected="selected" value="select">Select extra content...</option>';
		layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="pumphandle_2014.mp4">Measured CO2 Over Time</option>';
		layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="Carbon Dioxide 2006 GEOS-5 model.mp4">CO2 2006 GEOS-5 Model</option>';
		layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Land + Ocean Average Temperature Annual Anomaly.mp4">Temperature Anomaly 1850-2013</option>';
		layer_html += '   <option data-file-playback-rate="0.5" data-type="video" data-file-name="berkeley-earth.mp4">Temperature Anomaly 1850-2015</option>';
		layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic ice age, 1987-2014.mp4">Ice Thinning 1987-2014</option>';
		layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Larsen-B-Collapse.mp4">Larsen-B Collapse</option>';
		layer_html += '   <option data-file-playback-rate="4" data-type="video" data-file-name="Orbiting Carbon Observatory.mp4">Orbiting Carbon Observatory</option>';
		layer_html += '   <option data-file-playback-rate="2" data-type="video" data-file-name="Arctic Sea Ice, September 1979 to September 2014.mp4">Sea Ice Concentration 1979-2014</option>';
		layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="coral-reef-watch-daily-7day-max.mp4">Coral Reef Watch 2013-2015</option>';
		layer_html += '   <option data-file-playback-rate="0.5" data-type="video" data-file-name="merra-spi.mp4">Standardized Precipitation Index 1980-2015</option>';
		layer_html += '   <option data-type="iframe" data-link-path="http://choices.climatecentral.org/widget.html?utm_source=Davos&utm_medium=embed&utm_campaign=SSMC-Map#11/31.2301/121.4736?compare=temperatures&carbon-end-yr=2100&scenario-a=warming-4&scenario-b=warming-2&presentation=1">Shanghai Sea Level</option>';
		layer_html += '   <option data-type="img" data-link-path="land-and-ocean-temps.png">2015: Hottest Year on Record</option>';
		if (showEVA)
		  layer_html += '   <option data-type="link" data-link-path="http://localhost:8080/?uid=history-1436384863961-Vyxt6PIO">EVA - Explorable Visual Analytics</option>';
		if (showLODES)
		  layer_html += '   <option data-type="link" data-link-path="lodes.html#earthTimeBackButton">LODES - Origin-Destination Employment Statistics</option>';
		layer_html += '   <optgroup label="World Economic Forum - Davos 2016">';
		layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Climate Crisis with Naomi Oreskes and Achim Steiner.mp4">Climate Crisis with Naomi Oreskes and Achim Steiner</option>';
		layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Climate Crisis with Naomi Oreskes and Nicholas Stern.mp4">Climate Crisis with Naomi Oreskes and Nicholas Stern</option>';
		layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Future of Forests with Matthew Hansen and Andrew Steer.mp4">Future of Forests with Matthew Hansen and Andrew Steer</option>';
		layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Industrialization Impasse with Ricardo Hausmann and Illah Nourbakhsh.mp4">Industrialization Impasse with Ricardo Hausmann and Illah Nourbakhsh</option>';
		layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Race for Resources with Ellen MacArthur and Randy Sargent.mp4">Race for Resources with Ellen MacArthur and Randy Sargent</option>';
		layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The Race for Resources with William McDonough and Randy Sargent.mp4">Race for Resources with William McDonough and Randy Sargent</option>';
		layer_html += '   <option data-file-playback-rate="1" data-type="video" data-file-name="WEF/The War on Water with Johan Rockstrom and Randy Sargent.mp4">War on Water with Johan Rockstrom and Randy Sargent</option>';
		layer_html += '   </optgroup>';
		layer_html += ' </select>';
		layer_html += '</div>';

		layer_html += '</div>';

		var legend_html = '<div id="layers-legend">';
		legend_html += '<div id="legend-content">';
		legend_html += '<table cellpadding=5>';
		legend_html += '<tr id="wdpa-legend" style="display: none"><td><div style="background-color:#33da4f; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -11px; font-size: 17px">Protected Areas</div></td></tr>';
		legend_html += '<tr id="forest-loss-year-legend" style="display: none"><td><div style="font-size: 17px">Forest Loss By Year</div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">2000</div><div style="margin-top: 3px; float: left; background-image: -webkit-linear-gradient(left, yellow, orange 65%, red 100%);background-image: linear-gradient(left, yellow, orange 65%, red 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">2014</div></div></td></tr>';
		legend_html += '<tr id="forest-loss-gain-legend" style="display: none; font-size: 14px;"><td><div style="font-size: 17px">Forest Loss/Gain 2000-2014</div><div style="float: left; padding-right:8px"><div style="background-color:#00e000; width: 12px; height: 12px; float: left; margin-top: 2px; margin-left: 8px;"></div>&nbsp;Extent</div><div style="float: left; padding-right:8px"><div style="background-color:#ff0000; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Loss</div><div style="float: left; padding-right:8px"><div style="background-color:#0000ff; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Gain</div><div><div style="background-color:#ff00ff; width: 12px; height: 12px; float: left; margin-top: 2px"></div>&nbsp;Both</div></td></tr>';
		legend_html += '<tr id="fires-at-night-legend" style="display: none"><td><div style="background-color:#eda46a; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Fires At Night</div></td></tr>';
		legend_html += '<tr id="lights-at-night-legend" style="display: none"><td><div style="font-size: 17px">Lights at Night over 25 Years</div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">Decrease</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, #4848FD, green 50%, red 100%);background-image: linear-gradient(left, #4848FD, green 50%, red 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">Increase</div></td></tr>';
		legend_html += '<tr id="coral-bleaching-legend" style="display: none"><td><div style="float:left; background-color:#fa13ab; width:17px; height: 5px;"></div><div style="margin-left: 29px; margin-top: -5px; font-size: 17px">Coral Reefs</div></td></tr>';
		legend_html += '<tr id="coral-bleaching-alerts-legend" style="display: none"><td><div style="font-size: 17px">Coral Reef Watch</div><div style="float:left; padding-right:3px; margin-left: 8px; font-size: 14px;">Watch</div><div style="margin-top: 4px; float: left; background-image: -webkit-linear-gradient(left, #ffff00, #fbb404 65%, #a00200 100%);background-image: linear-gradient(left, #ffff00, #fbb404 65%, #a00200 100%); width: 45px; height: 10px"></div><div style="float:left; padding-left: 3px; font-size: 14px;">Alert</div></td></tr>';
		legend_html += '<tr id="wind-installs-legend" style="display: none"><td><div style="background-color:#a0fe8f; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">Wind Power (USA)</div></div></td></tr>';
		legend_html += '<tr id="global-wind-power-legend" style="display: none"><td><div style="background-color:#a0fe8f; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">Wind Power (Global)</div></div></td></tr>';
		legend_html += '<tr id="solar-installs-legend" style="display: none"><td><div style="background-color:#7376b2; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -16px; font-size: 17px">Solar Photovoltaic (USA)</div></td></tr>';
		legend_html += '<tr id="drilling-legend" style="display: none"><td><div style="background-color:#eda46a; border-radius: 50%; width:13px; height: 13px;"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Oil/Gass Drilling (USA)</div></td></tr>';
		legend_html += '<tr id="water-occurrence-legend" style="display: none"><td><div style="font-size: 17px">Water Occurrence 1984-2015</div><div style="margin-left: 8px"><div style="font-size: 13px; float: left">100%</div><div style="font-size: 13px; float: right;">0%</div><div class="waterLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">Always water</div><div style="font-size: 13px; float: right">Never water</div></div></td></tr>';
		legend_html += '<tr id="water-change-legend" style="display: none"><td><div style="font-size: 17px">Water Change 1984-1999 to 2000-2015</div><div style="margin-left: 8px"><div class="waterChangeLegendGradient" style="clear: both;"></div><div style="font-size: 13px; float: left">Water Loss</div><div style="font-size: 13px; float: right">Water Gain</div></div></td></tr>';
		legend_html += '<tr id="monthly-refugees-legend" style="display: none"><td><div style="background: #ff0000;background: -moz-linear-gradient(left, #ff0000 0%, #ffffff 100%);background: -webkit-linear-gradient(left, #ff0000 0%,#ffffff 100%); background: linear-gradient(to right, #ff0000 0%,#ffffff 100%); width:12px; height: 12px; border-radius: 50%; border: 1px solid rgb(210,210,210);"></div><div style="margin-left: 29px; margin-top: -15px; font-size: 17px">Mediterranean Refugees Jan 2014 - Jun 2016</div></td></tr>';
		legend_html += '</table>';
		legend_html += '</div>';
		legend_html += '</div>';

		if (enableLetterboxMode) {
		  $(layer_html).appendTo($("#content"));
		  $(legend_html).appendTo($("#content"));
		  $("#presentation-slider-selection, .base-map-radio, .map-layer-checkbox, .extras-selector, .presentationSlider, #layers-legend").addClass("letterbox");
		  $(".base-map-div, .map-layer-div, .extras-selector-div").addClass("top-panel letterbox");
		  $(".current-location-text, .landsat-select, .wdpa-select, .forest-change-select, .viirs-select, .forest-loss-gain-select, .animated-forest-loss-select, .forest-alerts-select, .forest-alerts-no-overlay-select, .lights-at-night-select, .coral-select, .coral-bleaching-select, .wind-select, .solar-select, .drilling-select, .himawari-select, .water-occurrence-select, .water-change-select .monthly-refugees-select").addClass("letterbox");
		} else {
		  $(layer_html).appendTo($("#timeMachine .player"));
		  $(legend_html).appendTo($("#timeMachine .player"));
		  $("#layers-list").addClass("right-panel");
		}

		if (isHyperwall) {
		  $("#layers-list, .sideToolBar, #layers-legend, #presentation-slider-selection, .base-map-div, .current-location-text").addClass("hyperwall");
		}


		// ## 6 ##
		//// Layer options and initialization ////
		//

		// Landsat
		var defaultTimeMachineLayerOptions = {
		  mediaType: ".mp4",
		  numFrames: 32,
		  fps: 10
		};
		landsatBaseMapLayer = new WebglTimeMachineLayer(glb, canvasLayer, landsatUrl, defaultTimeMachineLayerOptions);

		// Coral Bleaching Alerts
		var crwTimemacineLayerOptions = {
		  mediaType: ".mp4",
		  numFrames: 904,
		  fps: 22,
		  video_width: 1424,
		  video_height: 800,
		  width: 7200,
		  height: 7200,
		  greenScreen: true
		};
		crwTimemachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, crwTimemachineUrl, crwTimemacineLayerOptions);

		// Himawari-8
		var himawariTimeMachineLayerOptions = {
		  mediaType: ".mp4",
		  numFrames: 4249,
		  fps: 12,
		  nLevels: 4,
		  video_width: 1424,
		  video_height: 800,
		  width: 11000,
		  height: 11000
		};
		himawariTimemachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, himawariTimemachineUrl, himawariTimeMachineLayerOptions);

		// Forest Alerts
		var forestAlertsTimeMachineLayerOptions = {
		  mediaType: ".mp4",
		  numFrames: 237,
		  fps: 10,
		  nLevels: 11,
		  video_width: 1424,
		  video_height: 800,
		  width: 750836,
		  height: 156136
		};
		forestAlertsTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsTimeMachineUrl, forestAlertsTimeMachineLayerOptions);
		forestAlertsNoOverlayTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsNoOverlayTimeMachineUrl, forestAlertsTimeMachineLayerOptions);

		// For any raster map
		var defaultMapLayerOptions = {
		  nLevels: 12,
		  tileWidth: 256,
		  tileHeight: 256
		};

		// For any retina raster map
		var retinaMapLayerOptions = {
		  nLevels: 11,
		  tileWidth: 512,
		  tileHeight: 512
		};

		// For the light/dark base layers
		var defaultBaseMapLayerOptions = {
		  nLevels: 11,
		  tileWidth: 256,
		  tileHeight: 256
		};

		var baseMapLayerOptions = isHyperwall ? retinaMapLayerOptions : defaultBaseMapLayerOptions;

		lightBaseMapLayer = new WebglMapLayer(glb, canvasLayer, lightMapUrl, defaultBaseMapLayerOptions);
		darkBaseMapLayer = new WebglMapLayer(glb, canvasLayer, darkMapUrl, defaultBaseMapLayerOptions);
		hansenMapLayer = new WebglMapLayer(glb, canvasLayer, gfcTransUrl, defaultMapLayerOptions);
		hansenMapLayer2 = new WebglMapLayer(glb, canvasLayer, gfcLossGainUrl, defaultMapLayerOptions);
		wdpaVectorLayer = new WebglVectorLayer(glb, canvasLayer, wdpaUrl, defaultMapLayerOptions);
		mcrmVectorLayer = new WebglVectorLayer2(glb, canvasLayer, mcrmUrl, defaultBaseMapLayerOptions);
		waterOccurrenceLayer = new WebglMapLayer(glb, canvasLayer, waterOccurrenceUrl, defaultBaseMapLayerOptions);
		waterChangeLayer = new WebglMapLayer(glb, canvasLayer, waterChangeUrl, defaultBaseMapLayerOptions);
		// VIIRS is just a single tile
		viirsTile = new WebglViirsTile(glb, viirsUrl);
		coralBleachingTile = new WebglCoralTile(glb, coralBleachingUrl);
		monthlyRefugeesTile = new MonthlyRefugeesTile(glb, monthlyRefugeesUrl);

		var lightsAtNightMapLayerOptions = {
		  nLevels: 8,
		  tileWidth: 256,
		  tileHeight: 256
		};
		lightsAtNightMapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNightUrl, lightsAtNightMapLayerOptions);

		var animatedHansenLayerOptions = {
		  nLevels: 12,
		  tileWidth: 256,
		  tileHeight: 256
		};
		animatedHansenLayer = new WebglMapLayer2(glb, canvasLayer, animatedHansenUrls, animatedHansenLayerOptions);

		var usgsWindturbineLayerOptions = {
		  tileWidth: 256,
		  tileHeight: 256,
		  nLevels: 0,
		  setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
		  drawFunction: WebGLVectorTile2.prototype._drawPoints,
		  fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
		  vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
		};
		usgsWindTurbineLayer  = new WebglVectorLayer2(glb, canvasLayer, usgsWindTurbineUrl, usgsWindturbineLayerOptions);

		var globalWindPowerLayerOptions = {
		  tileWidth: 256,
		  tileHeight: 256,
		  nLevels: 0,
		  setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
		  drawFunction: WebGLVectorTile2.prototype._drawPoints,
		  fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
		  vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
		};
		globalWindPowerLayer  = new WebglVectorLayer2(glb, canvasLayer, globalWindPowerUrl, globalWindPowerLayerOptions);

		var solarInstallsLayerOptions = {
		  tileWidth: 256,
		  tileHeight: 256,
		  nLevels: 0,
		  setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
		  drawFunction: WebGLVectorTile2.prototype._drawPoints,
		  fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
		  vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
		};
		solarInstallsLayer  = new WebglVectorLayer2(glb, canvasLayer, solarInstallsUrl, solarInstallsLayerOptions);

		var drillingLayerOptions = {
		  tileWidth: 256,
		  tileHeight: 256,
		  nLevels: 0,
		  setDataFunction: WebGLVectorTile2.prototype._setUsgsWindTurbineData,
		  drawFunction: WebGLVectorTile2.prototype._drawPoints,
		  fragmentShader: WebGLVectorTile2.vectorPointTileFragmentShader,
		  vertexShader: WebGLVectorTile2.vectorPointTileVertexShader
		};
		drillingLayer  = new WebglVectorLayer2(glb, canvasLayer, drillingUrl, drillingLayerOptions);


		// Layer Toggle UI
		initLayerToggleUI();
		$(".googleLogo").html("Google Earth Engine");

		if (enableRecordingMode) {
		  var snaplapse = timelapse.getSnaplapse();
		  if (snaplapse) {
			snaplapse.getSnaplapseViewer().setToRecordingMode();
		  }
		}

		// Toggle layers off when auto mode begins
		var snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
		var snaplapseViewerForPresentationSlider;
		if (snaplapseForPresentationSlider) {
		  snaplapseViewerForPresentationSlider = snaplapseForPresentationSlider.getSnaplapseViewer();
		}

		// Load waypoints
		if (waypointSliderContentPath) {
		  var loadWaypointSliderContentFromCSV = function(csvdata) {
			var waypointJSON = JSON.parse(snaplapseForPresentationSlider.CSVToJSON(csvdata));
			for (var i = 0; i < waypointJSON.snaplapse.keyframes.length; i++) {
			  var keyframe = waypointJSON.snaplapse.keyframes[i];
			  // Himawari is a special case.
			  // We need to store the bounds and times and then replace them with a default view.
			  // The default view allows for a black thumbnail to be used on the waypoint slider instead of some random position in Landsat
			  // Then when we actually click the Himawari waypoint, we load up the original bounds and time and use them.
			  for (var j = 0; j < keyframe.layers.length; j++) {
				if (keyframe.layers[j] == "h8") {
				  himawariWaypoints[i] = {bounds: keyframe.bounds, time: keyframe.time};
				  keyframe.bounds = himawariWaypointThumbnailBounds;
				  keyframe.time = 0;
				}
			  }
			}
			waypointSliderContent = "#presentation=" + snaplapseForPresentationSlider.getAsUrlString(waypointJSON.snaplapse.keyframes);
			timelapse.loadSharedDataFromUnsafeURL(waypointSliderContent);
		  };

		  if (waypointSliderContentPath.indexOf("http") >= 0) {
			// Load waypoints from Google Docs
			snaplapseForPresentationSlider.gdocToJSON(waypointSliderContentPath, function(csvdata) {
			  loadWaypointSliderContentFromCSV(csvdata);
			});
		  } else {
			// Load local version of the waypoints .tsv file
			$.ajax({
			  url: waypointSliderContentPath,
			  dataType: "text",
			  success: function(csvdata) {
				loadWaypointSliderContentFromCSV(csvdata);
			  }
			});
		  }
		} else {
		  // Load the long, encoded URL outputted by the Tour Editor
		  timelapse.loadSharedDataFromUnsafeURL(waypointSliderContent);
		}

		if (snaplapseViewerForPresentationSlider) {
		  // Change UI based on whether setup is a hyperwall or not
		  snaplapseViewerForPresentationSlider.addEventListener('snaplapse-loaded', function() {
			var $elements = $('.presentationSlider, .snaplapse_keyframe_container, .keyframeSubtitleBoxForHovering, .snaplapse_keyframe_list_item_presentation, .snaplapse_keyframe_list_item_thumbnail_overlay_presentation');
			if (isHyperwall)
			  $elements.addClass('hyperwall');
			if (enableLetterboxMode)
			  $elements.addClass('letterbox');
			if (enableRecordingMode)
			  $elements.addClass('recording');
			$(".snaplapse_keyframe_container").scrollLeft(0);
		  });

		  $('.current-location-text').click(function() {
			$(this).hide();
		  });

		  snaplapseViewerForPresentationSlider.addEventListener('automode-start', function() {
			if (timelapse.isPaused() && !timelapse.isDoingLoopingDwell()) {
			  timelapse.handlePlayPause();
			}
		  });

		  snaplapseViewerForPresentationSlider.addEventListener('slide-before-changed', function(waypoint) {
			var waypointTitle = waypoint.title;
			var waypointIndex = waypoint.index;
			var waypointBounds = waypoint.bounds;
			isAutoModeRunning = snaplapseViewerForPresentationSlider.isAutoModeRunning();
			if (himawariWaypoints[waypointIndex]) timelapse.setMaxScale(himawariMaxScale);
			else timelapse.setMaxScale(landsatMaxScale);
		  });

		  snaplapseViewerForPresentationSlider.addEventListener('slide-changed', function(waypoint) {
			var waypointTitle = waypoint.title;
			var waypointIndex = waypoint.index;
			var waypointBounds = waypoint.bounds;
			var waypointLayers = waypoint.layers || [];

			// Display info box for the waypoints
			if (enableWaypointText) {
			  var waypointScale = timelapse.pixelBoundingBoxToPixelCenter(waypointBounds).scale;
			  var $current_location_text = $(".current-location-text");

			  timelapse.removeViewChangeListener(waypointViewChangeListener);
			  timelapse.removeViewChangeListener(hideWaypointListener);
			  waypointViewChangeListener = function() {
				var currentView = timelapse.getView();
				if (currentView.scale * 2.5 > waypointScale && (currentView.x >= waypointBounds.xmin && currentView.x <= waypointBounds.xmax && currentView.y >= waypointBounds.ymin && currentView.y <= waypointBounds.ymax)) {
				  if (waypoint.annotationBoxTitle || waypoint.description) {
					$current_location_text.show();
					$current_location_text.find("h3").text(waypoint.annotationBoxTitle);
					$current_location_text.find("p").text(waypoint.description);
					previousWaypoint.scale = waypointScale;
					previousWaypoint.bounds = waypointBounds;
					hideWaypointListener = function() {
					  var currentView = timelapse.getView();
					  var previousWaypointBounds = previousWaypoint.bounds;
					  if ((previousWaypoint.scale / 2.5 > currentView.scale || !(currentView.x >= previousWaypointBounds.xmin && currentView.x <= previousWaypointBounds.xmax && currentView.y >= previousWaypointBounds.ymin && currentView.y <= previousWaypointBounds.ymax))) {
						$(".current-location-text").hide();
						timelapse.removeViewChangeListener(hideWaypointListener);
					  }
					};
					timelapse.addViewChangeListener(hideWaypointListener);
				  } else {
					$(".current-location-text").hide();
				  }
				  timelapse.removeViewChangeListener(waypointViewChangeListener);
				} else {
				  $(".current-location-text").hide();
				}
			  };
			  timelapse.addViewChangeListener(waypointViewChangeListener);
			}

			// Remove himawari since we do special cases further below
			var himawariIdx = waypointLayers.indexOf("h8");
			if (himawariIdx > -1) waypointLayers.splice(himawariIdx, 1);

			// Clear out layers if they were already checked
			// Special case if himawari waypoint
			var himawariWaypoint = himawariWaypoints[waypointIndex];
			if (himawariWaypoint)
			  $(".map-layer-div input:checked").not("#show-himawari").trigger("click");
			else
			  $(".map-layer-div input:checked").trigger("click");

			// Handle layers
			waypointLayers.forEach(function(layer) {
			  var $layerToggle = $("#layers-list label[name='" + layer + "'] input");
			  if (!$layerToggle.prop('checked')) $layerToggle.trigger("click");
			});

			// Handle himawari
			// Note: Must be run after other layers
			if (himawariWaypoint) {
			  var initialHimawariViewChangeHack = function() {
				if (isAutoModeRunning) {
				  snaplapseViewerForPresentationSlider.startAutoModeWaypointTimeout();
				} else {
				  snaplapseViewerForPresentationSlider.startAutoModeIdleTimeout();
				}
			  };

			  var setHimawariView = function(himawariBoundingBox, himawariTime, himawariPlaybackSpeed) {
				var himawariView = {bbox : himawariBoundingBox};
				if (showHimawariTimeMachineLayer) {
				  timelapse.stopParabolicMotion();
				  timelapse.setNewView(himawariView);
				} else {
				  loadHimawari();
				  timelapse.stopParabolicMotion();
				  timelapse.setNewView(himawariView, true, null, initialHimawariViewChangeHack);
				}
				timelapse.setPlaybackRate(himawariPlaybackSpeed);
				setTimeout(function() {
				  timelapse.seek(himawariTime);
				}, 150);
			  };

			  setHimawariView(himawariWaypoint.bounds, himawariWaypoint.time, 0.5);
			}
			// End Himawari
		  });
		}


		// Location search box, with autocomplete.
		var $locationSearchDiv = $('<div class="location_search_div"><input id="location_search" type="text" placeholder="Search for a location...">');
		if (enableLetterboxMode) {
		  $locationSearchDiv.addClass("top-panel letterbox").appendTo($("#content"));
		  $("#location_search").addClass("letterbox");
		} else {
		  $locationSearchDiv.appendTo($("#timeMachine"));
		}

		if (isHyperwall) {
		  $("#location_search").addClass("hyperwall");
		}

		// Note: Google's service gives much better results, but for locations where Google APIs cannot be used, we fallback to this.
		if (!useGoogleSearch) {
		  var locationList = [];
		  $("#location_search").autocomplete({
			minLength: 5,
			source: function( request, response ) {
			  locationList = [];
			  //http://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=1
			  $.getJSON( "http://photon.komoot.de/api/?limit=5", { q: request.term }, function( data, status, xhr ) {
				response( data.features );
			  });
			},
			select: function(event, ui) {
			  var view;
			  //if (ui.item.properties.extent) {
				//  view = {bbox: {"ne": {"lat": ui.item.properties.extent[1], "lng": ui.item.properties.extent[2]}, "sw": {"lat" : ui.item.properties.extent[3], "lng": ui.item.properties.extent[0]}}};
			  //} else {
				view = {center: {"lat": ui.item.geometry.coordinates[1], "lng": ui.item.geometry.coordinates[0]}, "zoom": 12};
			  //}
			  timelapse.setNewView(view);
			  if (ui.item.properties)
				UTIL.addGoogleAnalyticEvent('textbox', 'search', 'go-to-searched-place=' + ui.item.properties.name + "," + ui.item.properties.country);
			}
		  }).autocomplete( "instance" )._renderItem = function( ul, item ) {
			var tmpLocationString = (item.properties.name || "")  + ", " + (item.properties.state || "") + item.properties.country;
			if (item.properties.osm_value == "hamlet" || !item.properties.country || locationList.indexOf(tmpLocationString) >= 0) return $("<li>");
			  locationList.push(tmpLocationString);
			 return $("<li style='z-index:9999'>").append("<a>" + (item.properties.name || "")  + ", " + (item.properties.state || "") + "<br>" + item.properties.country + "</a>").appendTo(ul);
		  };
		} else if (typeof(google) === "undefined" && !useGoogleMaps) {
		  var googleMapsScript = document.createElement('script');
		  googleMapsScript.setAttribute('src', 'https://maps.google.com/maps/api/js?libraries=places&callback=googleMapsLoadedCallback');
		  googleMapsScript.setAttribute('type', 'text/javascript');
		  document.getElementsByTagName('head')[0].appendChild(googleMapsScript);
		}

		// Set the letterbox mode
		if(enableLetterboxMode && !enableRecordingMode) {
		  // Resize the viewer
		  timelapse.addViewerBottomMargin(-2);
		  // Move the presentation slider out
		  var $presentationSlider = $("#" + timelapse.getTimeMachineDivId() + " .presentationSlider");
		  $presentationSlider.appendTo("#content");
		}

		// Toggle the context map and hide it
		$(".toggleContextMapBtn").click();
		$(".contextMapContainer").hide();

		// Display info box for the waypoints
		if (enableWaypointText) {
		  var $current_location_text = $(".current-location-text");
		  $current_location_text.appendTo($("#timeMachine"));
		  if (enableRecordingMode) {
			$current_location_text.find(".close").remove();
			$current_location_text.addClass("recording");
		  }
		}

		$("#presentation-slider-selection").on("click", "td", function() {
		  var sectionId = $(this).get(0).id;
		  var waypointContainer = $(".snaplapse_keyframe_container");
		  if (sectionId == "automode-section") {
			var snaplapseForPresentationSlider = timelapse.getSnaplapseForPresentationSlider();
			snaplapseForPresentationSlider.getSnaplapseViewer().initializeAndRunAutoMode();
		  } else {
			if (sectionId == "climate-1-section") {
			  var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(0));
			} else if (sectionId == "climate-2-section") {
			  var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(14));
			} else if (sectionId == "forest-section") {
			  var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(30));
			} else if (sectionId == "water-section") {
			  var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(40));
			} else if (sectionId == "resources-1-section") {
			  var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(55));
			} else if (sectionId == "resources-2-section") {
			  var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(69));
			} else if (sectionId == "industrialization-section") {
			  var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(93));
			} else if (sectionId == "himawari-section") {
			  var scrollTo = $($(".snaplapse_keyframe_list").children().children().get(110));
			}
			var scrollAmount = scrollTo.offset().left - waypointContainer.offset().left + waypointContainer.scrollLeft();
			$(".snaplapse_keyframe_container").scrollLeft(scrollAmount);
		  }
		});

		$(window).trigger("resize");
		$(".share").appendTo($(".location_search_div"));
	  }

	  var perf;
	  var maximumUpdateTime = 20; // milliseconds
	  var startOfRedraw;

	  function redrawTakingTooLong() {
		return performance.now() - startOfRedraw > maximumUpdateTime;
	  }

	  function resize() {
		var width = canvasLayer.canvas.width;
		var height = canvasLayer.canvas.height;

		gl.viewport(0, 0, width, height);
	  }

	  //var firstDrawTime = null;
	  //var lastFrameTime = null

	  // Draws to canvas.
	  // Called by TimeMachineCanavasLayer during animation and/or view changes
	  function update() {

		/*var frameTime = performance.now();
		startOfRedraw = frameTime;

		if (lastFrameTime != null) {
		  var duration = frameTime - lastFrameTime;
		}
		lastFrameTime = frameTime;

		//stats.begin();
		if (WebglVideoTile.verbose) {
		  function r2(x) {
			return Math.round(x * 100) / 100;
		  }
		  console.log(r2(performance.now()) + ' update start --------------------------------------------------');
		}*/

		//if (performance.now() - firstDrawTime < 1 * 5000) {
		//  WebglVideoTile.verbose = true;
		//} else {
		//  if (WebglVideoTile.verbose) {
		//    WebglVideoTile.verbose = false;
		//    console.log(WebglVideoTile.stats());
		//  }
		//}

		gl.clear(gl.COLOR_BUFFER_BIT);

		//
		//// Draw layers ////
		//

		// Draw himawari
		if (showHimawariTimeMachineLayer) {
		  var himawariView = timelapse.getView();
		  var timelapse2map = himawariTimemachineLayer.getWidth() / landsatBaseMapLayer.getWidth();
		  himawariView.x *= timelapse2map;
		  himawariView.y *= timelapse2map;
		  himawariView.scale /= timelapse2map;
		  himawariTimemachineLayer.draw(himawariView, tileViewVisibility);
		} else {

		  // Draw lightsAtNightMapLayer
		  if (showLightsAtNightLayer) {
			// Construct view for lightsAtNightMapLayer
			var lightsAtNightLayerView = timelapse.getView();
			var timelapse2map = lightsAtNightMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
			lightsAtNightLayerView.x *= timelapse2map;
			lightsAtNightLayerView.y *= timelapse2map;
			lightsAtNightLayerView.scale /= timelapse2map;

			lightsAtNightMapLayer.draw(lightsAtNightLayerView);
		  }

		  // Draw base layer
		  else if (visibleBaseMapLayer == "landsat") {
			landsatBaseMapLayer.draw(timelapse.getView(), tileViewVisibility);
		  } else if (visibleBaseMapLayer == "light") {
			// Construct view for lightBaseMapLayer
			var lightBaseMapView = timelapse.getView();
			var timelapse2map = lightBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
			lightBaseMapView.x *= timelapse2map;
			lightBaseMapView.y *= timelapse2map;
			lightBaseMapView.scale /= timelapse2map;

			lightBaseMapLayer.draw(lightBaseMapView);
		  } else if (visibleBaseMapLayer == "dark") {
			// Construct view for darkBaseMapLayer
			var darkBaseMapView = timelapse.getView();
			var timelapse2map = darkBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
			darkBaseMapView.x *= timelapse2map;
			darkBaseMapView.y *= timelapse2map;
			darkBaseMapView.scale /= timelapse2map;

			darkBaseMapLayer.draw(darkBaseMapView);
		  }

		  // Layers to draw above the base layer

		  if (showCrwTimemachineLayer) {
			var crwView = timelapse.getView();
			var timelapse2map = crwTimemachineLayer.getWidth() / landsatBaseMapLayer.getWidth();
			crwView.x *= timelapse2map;
			crwView.y *= timelapse2map;
			crwView.scale /= timelapse2map;
			crwTimemachineLayer.draw(crwView, tileViewVisibility);
		   }

		  // Draw hansenMapLayer (Forest change transparent)
		  if (showHansenLayer) {
			// Construct view for hansenMapLayer
			var hansenMapLayerView = timelapse.getView();
			var timelapse2map = hansenMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
			hansenMapLayerView.x *= timelapse2map;
			hansenMapLayerView.y *= timelapse2map;
			hansenMapLayerView.scale /= timelapse2map;

			hansenMapLayer.draw(hansenMapLayerView);
		  }

		  // Draw hansenMapLayer2 (Forest Loss/Gain)
		  if (showHansenLayer2) {
			// Construct view for hansenMapLayer2
			var hansenMapLayerView2 = timelapse.getView();
			var timelapse2map = hansenMapLayer2.getWidth() / landsatBaseMapLayer.getWidth();
			hansenMapLayerView2.x *= timelapse2map;
			hansenMapLayerView2.y *= timelapse2map;
			hansenMapLayerView2.scale /= timelapse2map;

			hansenMapLayer2.draw(hansenMapLayerView2);
		  }

		  // Draw water occurrence
		  if (showWaterOccurrenceLayer) {
			// Construct view for waterOccurrenceLayer
			var waterOccurrenceView = timelapse.getView();
			var timelapse2map = waterOccurrenceLayer.getWidth() / landsatBaseMapLayer.getWidth();
			waterOccurrenceView.x *= timelapse2map;
			waterOccurrenceView.y *= timelapse2map;
			waterOccurrenceView.scale /= timelapse2map;

			waterOccurrenceLayer.draw(waterOccurrenceView);
		  }

		 // Draw water change
		  if (showWaterChangeLayer) {
			// Construct view for waterChangeLayer
			var waterChangeView = timelapse.getView();
			var timelapse2map = waterChangeLayer.getWidth() / landsatBaseMapLayer.getWidth();
			waterChangeView.x *= timelapse2map;
			waterChangeView.y *= timelapse2map;
			waterChangeView.scale /= timelapse2map;

			waterChangeLayer.draw(waterChangeView);
		  }

		  // Draw Animated Hansen Layer
		  if (showAnimatedHansenLayer) {
			// Construct view for hansenMapLayer
			var animatedHansenLayerView = timelapse.getView();
			var timelapse2map = animatedHansenLayer.getWidth() / landsatBaseMapLayer.getWidth();
			animatedHansenLayerView.x *= timelapse2map;
			animatedHansenLayerView.y *= timelapse2map;
			animatedHansenLayerView.scale /= timelapse2map;


			var ratio = 0;

			var captureTimes = timelapse.getCaptureTimes();
			var offset = captureTimes.indexOf("2000");
			var fps = timelapse.getFps();
			if (offset > -1) {
			  var currentTime = Math.max(0,timelapse.getCurrentTime() - offset/fps);
			  ratio = currentTime / ((captureTimes.length - offset - 1)/fps);
			  ratio = Math.min(1, currentTime);
			}
			animatedHansenLayerView.alpha = ratio;

			animatedHansenLayer.draw(animatedHansenLayerView);
		  }

		  // Draw protected
		  if (showMcrmLayer) {
			var mcrmLayerView = timelapse.getView();
			var timelapse2map = mcrmVectorLayer.getWidth() / landsatBaseMapLayer.getWidth();
			mcrmLayerView.x *= timelapse2map;
			mcrmLayerView.y *= timelapse2map;
			mcrmLayerView.scale /= timelapse2map;

			mcrmVectorLayer.draw(mcrmLayerView);
		  }

		  // Draw VIIRS layer
		  if (showViirsLayer) {
			var viirsView = timelapse.getView();
			viirsView.zoom = timelapse.getCurrentZoom();
			var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
			var times = timelapse.getCaptureTimes();
			var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
			var currentDate = ratio*range + new Date(times[0]).getTime();
			viirsView.currentDate = currentDate;
			viirsTile.draw(viirsView);
		  }

		  // Draw Coral Bleaching
		  if (showCoralBleachingLayer) {
			var viirsView = timelapse.getView();
			viirsView.zoom = timelapse.getCurrentZoom();
			var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
			var times = timelapse.getCaptureTimes();
			var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
			var currentDate = ratio*range + new Date(times[0]).getTime();
			viirsView.currentDate = currentDate;
			coralBleachingTile.draw(viirsView);
		  }

		  // Draw wind layer
		  if (showUsgsWindTurbineLayer) {
			var usgsWindTurbineLayerView = timelapse.getView();
			var timelapse2map = usgsWindTurbineLayer.getWidth() / landsatBaseMapLayer.getWidth();
			usgsWindTurbineLayerView.x *= timelapse2map;
			usgsWindTurbineLayerView.y *= timelapse2map;
			usgsWindTurbineLayerView.scale /= timelapse2map;
			usgsWindTurbineLayerView.zoom = timelapse.getCurrentZoom();
			var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
			var times = timelapse.getCaptureTimes();
			var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
			var currentDate = ratio*range + new Date(times[0]).getTime();
			usgsWindTurbineLayerView.currentTime = currentDate;
			usgsWindTurbineLayerView.color = [0.1, 0.5, 0.1, 1.0];
			usgsWindTurbineLayer.draw(usgsWindTurbineLayerView);
		  }

		  // Draw global wind layer
		  if (showGlobalWindPowerLayer) {
			var globalWindPowerLayerView = timelapse.getView();
			var timelapse2map = globalWindPowerLayer.getWidth() / landsatBaseMapLayer.getWidth();
			globalWindPowerLayerView.x *= timelapse2map;
			globalWindPowerLayerView.y *= timelapse2map;
			globalWindPowerLayerView.scale /= timelapse2map;
			globalWindPowerLayerView.zoom = timelapse.getCurrentZoom();
			var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
			var times = timelapse.getCaptureTimes();
			var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
			var currentDate = ratio*range + new Date(times[0]).getTime();
			globalWindPowerLayerView.currentTime = currentDate;
			globalWindPowerLayerView.color = [0.1, 0.5, 0.1, 1.0];
			globalWindPowerLayer.draw(globalWindPowerLayerView);
		  }

		  // Draw solar layer
		  if (showSolarInstallsLayer) {
			var solarInstallsLayerView = timelapse.getView();
			var timelapse2map = usgsWindTurbineLayer.getWidth() / landsatBaseMapLayer.getWidth();
			solarInstallsLayerView.x *= timelapse2map;
			solarInstallsLayerView.y *= timelapse2map;
			solarInstallsLayerView.scale /= timelapse2map;
			solarInstallsLayerView.zoom = timelapse.getCurrentZoom();
			var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
			var times = timelapse.getCaptureTimes();
			var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
			var currentDate = ratio*range + new Date(times[0]).getTime();
			solarInstallsLayerView.currentTime = currentDate;
			solarInstallsLayer.draw(solarInstallsLayerView);
		  }

		  // Draw drilling layer
		  if (showDrillingLayer) {
			var drillingLayerView = timelapse.getView();
			var timelapse2map = drillingLayer.getWidth() / landsatBaseMapLayer.getWidth();
			drillingLayerView.x *= timelapse2map;
			drillingLayerView.y *= timelapse2map;
			drillingLayerView.scale /= timelapse2map;
			drillingLayerView.zoom = timelapse.getCurrentZoom();
			var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
			var times = timelapse.getCaptureTimes();
			var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
			var currentDate = ratio*range + new Date(times[0]).getTime();
			drillingLayerView.currentTime = currentDate;
			drillingLayerView.color = [0.82, 0.22, 0.07, 1.0];
			drillingLayer.draw(drillingLayerView);
		  }

		  // Draw forest alerts no overlay
		  if (showForestAlertsNoOverlayTimeMachineLayer) {
			var forestAlertsNoOverlayView = timelapse.getView();
			var timelapse2map = forestAlertsNoOverlayTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

			var p = timelapse.getProjection();
			var offest = p.latlngToPoint({"lat":5.506709319555738, "lng":-82.5513118548623});

			forestAlertsNoOverlayView.x -= offest.x;
			forestAlertsNoOverlayView.y -= offest.y;
			forestAlertsNoOverlayTimeMachineLayer.draw(forestAlertsNoOverlayView, tileViewVisibility);
		  }

		  // Draw forest alerts
		  if (showForestAlertsTimeMachineLayer) {
			var forestAlertsView = timelapse.getView();
			var timelapse2map = forestAlertsTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

			var p = timelapse.getProjection();
			var offest = p.latlngToPoint({"lat":5.506709319555738, "lng":-82.5513118548623});

			forestAlertsView.x -= offest.x;
			forestAlertsView.y -= offest.y;
			forestAlertsTimeMachineLayer.draw(forestAlertsView, tileViewVisibility);
		  }

		  // Draw wdpaLayer
		  if (showWdpaLayer)
			wdpaVectorLayer.draw(timelapse.getView());
			
		  //Draw mediterranean monthly refugees
		  if (showMonthlyRefugeesLayer){
			var monthlyRefugeesView = timelapse.getView();
			monthlyRefugeesView.zoom = timelapse.getCurrentZoom();
			var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
			var times = timelapse.getCaptureTimes();
			var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
			var currentDate = (ratio*range + new Date(times[0]).getTime())/1000.0;
			monthlyRefugeesView.currentDate = currentDate;
			monthlyRefugeesTile.draw(monthlyRefugeesView);
		  }

		  // ## 7 ##
		  //// Layers to draw on top go here
		  //

		}
		//stats.end();
	  }
	</script>

	<script>
	  "use strict";
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','http://www.google-analytics.com/analytics.js','ga');
	  // Write to local storage since cookies cannot be used on file://
	  // allowLinker is for crossdomain (the tracking domain is different from where we are sending from)
	  ga('create', trackingId, 'auto', {
		 'allowLinker': true,
		 'storage': 'none','clientId':localStorage.getItem('gaClientId')
	  });
	  ga(function(t){localStorage.setItem('gaClientId',t.get('clientId'));});
	  ga('set', 'checkProtocolTask', null); // Disable file protocol checking.
	  ga('send', 'pageview');
	</script>
  </head>
  <body>
	<div id="content">
	  <div id="letterbox-top"></div>
	  <div id="letterbox-middle"></div>
	  <div id="letterbox-bottom"></div>
	</div>
	<div id="timeMachine"></div>
	<div class="current-location-text">
	  <h3></h3>
	  <p></p>
	</div>
	<canvas id="stats" style="position:absolute; top:0px; right:0px; z-index:100" width=1000 height=153></canvas>
	<div id="extras-content" title=""></div>
	<div id="presentation-slider-selection"><table><tr><td style="color: white">Jump To: <td id="climate-1-section"><button type="button">Climate 1</button></td><td id="climate-2-section"><button type="button">Climate 2</button></td><td id="forest-section"><button type="button">Forest</button></td><td id="water-section"><button type="button">Water</button></td><td id="resources-1-section"><button type="button">Resources 1</button></td><td id="resources-2-section"><button type="button">Resources 2</button></td><td id="industrialization-section"><button type="button">Industrialization</button></td><td id="himawari-section"><button type="button">Himawari-8</button></td><td id="automode-section"><button type="button">Launch Automode</button></td></tr></table></div>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <link href="../../timemachine/css/snaplapse.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/defaultUI.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/smallGoogleMap.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/scaleBar.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/customUI.css" rel="stylesheet" type="text/css" />
    <!-- <link href="../../timemachine/css/leaflet/leaflet.css" rel="stylesheet" type="text/css"/> -->

    <script src="../../timemachine/js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/util.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
    <script src="../../timemachine/js/Math.uuid.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/scaleBar.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/smallGoogleMap.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/customUI.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>
    <script src="../../timemachine/template_includes.js" type="text/javascript"></script>
    <script src="landsat_ajax_includes.js" type="text/javascript"></script>
    <script src="https://maps.google.com/maps/api/js?sensor=false&libraries=places" type="text/javascript"></script>
    <!-- <script type="text/javascript" src="../../timemachine/js/leaflet/leaflet.min.js"></script> -->
    <!-- <script type="text/javascript" src="../../timemachine/js/leaflet/Google.js"></script> -->

    <script src="TileIdx.js"></script>
    <script src="WebglVideoTile.js"></script>
    <script src="TileView.js"></script>
    <script src="Glb.js"></script>
    <script src="WebglTimeMachineLayer.js"></script>
    <script src="WebglMapLayer.js"></script>
    <script src="WebglVectorLayer.js"></script>
    <script src="WebglTimeMachinePerf.js"></script>
    <script src="WebGLVectorTile.js"></script>
    <script src="WebglMapTile.js"></script>
    <script src="WebglViirsTile.js"></script>

    <style>
      #timeMachine {
        position: absolute;
        width: 100%;
        height: 100%;
      }
      .player {
        left: -1px !important;
        right: -1px !important;
        top: -1px !important;
      }
      .presentationSlider {
        height: 120px;
      }
      .snaplapse_keyframe_container {
        left: -1px !important;
        right: -1px !important;
      }
      .keyframeSubtitleBoxForHovering {
        bottom: 131px !important;
      }
      .snaplapse_keyframe_list_item_presentation {
        width: 147px;
        height: 101px;
      }
      .snaplapse_keyframe_list_item_thumbnail_overlay_presentation {
        width: 140px;
        height: 95px;
      }
      .keyframeSubtitleBoxForHovering p {
        max-width: 550px;
        padding-top: 18px;
        padding-bottom: 26px;
        padding-left: 27px;
        padding-right: 27px;
      }
      .keyframeSubtitleBoxForHovering {
        font-size: 20px;
        line-height: 29px;
        color: rgb(60, 60, 60);
      }
      #vector-layers {
        width: 375px;
        background: white;
        position: absolute;
        right: 19px;
        bottom: 250px;
        border: 1px solid #656565;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px !important;
        box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.3);
        z-index: 30;
        outline: none;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 30px;
        padding-bottom: 11px;
        padding-top: 13px;
        padding-left: 13px;
        padding-right: 6px;
        color: #262525;
      }
      #legend {
        font-size: 30px;
        margin-left: 6px;
        border-bottom: 1px solid #656565;
        padding-bottom: 6px;
      }
      .legendColor {
        width: 22px;
        height: 22px;
        margin-bottom: 4px;
      }
      .legendTitle {
        margin-left: 7px;
        margin-bottom: 4px;
        color: #656565;
      }
      input[type='checkbox'] {
        width: 28px;
        height: 28px;
        border-radius: 5px;
        border: 2px solid #555;
        margin-top: 15px;
        margin-left: 9px;
        cursor: pointer;
      }
      input[type='radio'] {
        width: 28px;
        height: 28px;
        border-radius: 5px;
        border: 2px solid #555;
        margin-top: 15px;
        margin-left: 9px;
        cursor: pointer;
      }
      label {
        cursor: pointer;
        color: #656565;
        padding-right: 6px;
      }
      .base-layers-label {
        position: relative;
        top: -3px;
      }
      .vector-layers-label {
        margin-top: 13px;
        margin-left: 7px;
        position: absolute;
      }
      #contextMapgleMap1_smallMapContainer {
        right: 19px !important;
        top: 101px !important;
      }
      #logoUrl {
        position: absolute;
        font-size: 40px;
        text-shadow: -1px 0 #000, 0 1px #000, 1px 0 #000, 0 -1px #000, 2px 2px 3px rgba(0, 0, 0, 0.3);
        font-family: Arial, Helvetica, sans-serif;
        color: white;
        font-weight: normal;
        z-index: 50;
        left: 92px;
        top: 18px;
      }
    </style>
    <script type="text/javascript">
      "use strict";

      jQuery.support.cors = true;

      var landsatBaseMapLayer, timelapse, darkBaseMapLayer, lightBaseMapLayer, wdpaVectorLayer, hansonMapLayer, viirsTile;

      // Using "https" will casue the thumbnail loading from the server to fail
      //var url = "http://earthengine.google.org/timelapse/data/20130507";
      var landsatUrl = "../../../landsat-annual/1068x600";

      // Open Street Map paths
      var osmDefaultUrl = "../../../openstreetmap/default";
      var osmDarkUrl = "../../../openstreetmap/dark_all";
      var osmDarkRetinaUrl = "../../../openstreetmap/dark_all_retina";

      // Other vector layer paths
      var wdpaUrl = "../../../wdpaline-year";
      var viirsUrl = '../../../viirs/createlab-viirs-uncorrected-20140314-20150403.bin';
      var gfcDarkUrl = "../../../global-forest-change/loss_year_new";
      var gfcTransUrl = "../../../global-forest-change/loss_year_transparent";

      var visibleBaseMapLayer = "landsat";

      function init() {
        var myHomeView = {
          x: 677982.255550633,
          y: 521801.7016044302,
          scale: 0.0010172804041788702
        };
        var settings = {
          viewerType: "webgl",
          url: landsatUrl,
          enablePresentationSlider: true,
          thumbnailServerRootTileUrl: "http://earthengine.google.org/timelapse/data/20130507",
          showFullScreenBtn: false,
          presentationSliderSettings: {
            onLoadAnimation: "none",
            playAfterAnimation: false,
            initialWaypointIndex: 0,
            doAutoMode: false,
            showAnnotations: false,
            screenIdleTime: 60000,
            waypointDelayTime: 15000
          },
          useTouchFriendlyUI: true,
          datasetType: "landsat",
          playOnLoad: true,
          onTimeMachinePlayerReady: function(viewerDivId) {},
          scaleBarOptions: {
            scaleBarDiv: "scaleBar1"
          },
          smallGoogleMapOptions: {
            smallGoogletMapDiv: "contextMapgleMap1",
            tileType: "OpenStreetMap",
            tilePath: osmDefaultUrl,
            geometry: {
              width: 500,
              height: 300
            }
          },
          newHomeView: myHomeView
        };
        timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", settings);
        onTimeMachinePlayerReady();

        //document.body.appendChild( stats.domElement );
        //$(stats.domElement).css('z-index', 1000);

        perf = new WebglTimeMachinePerf(document.getElementById('stats'), timelapse);
        $('#stats').hide();
        /*$(document).keypress(function(e) {
          // ctrl-a toggles perf
          if (e.keyCode == 1) {
            $('#stats').toggle();
          }
        });*/
      }

      $(init);

      function initLayerToggleUI() {
        $("#show-wdpa").on("click", function() {
          var $this = $(this);
          if ($this.is(':checked')) {
            showWdpaLayer = true;
          } else {
            showWdpaLayer = false;
          }
        }).prop('checked', showWdpaLayer);

        $("#show-forest-change").on("click", function() {
          if ($(this).prop('checked')) {
            showHansonLayer = true;
          } else {
            showHansonLayer = false;
          }
        }).prop('checked', showHansonLayer);

        $("#show-viirs").on("click", function() {
          if ($(this).prop('checked')) {
            showViirsLayer = true;
          } else {
            showViirsLayer = false;
          }
        }).prop('checked', showViirsLayer);

        $("input:radio[name=base-layers]").on("click", function() {
          visibleBaseMapLayer = $(this).val();
        });

        $('input:radio[name=base-layers][id=' + visibleBaseMapLayer + '-base]').prop('checked', true);

      }
    </script>

    <script src="../../js/TimeMachineCanvasLayer.js" type="text/javascript"></script>

    <script type="text/javascript" src="../../js/base.js"></script>
    <script type="text/javascript" src="../../js/io.js"></script>
    <script type="text/javascript" src="../../js/utils.js"></script>

    <script type="text/javascript">
      "use strict";

      /* begin stats */
      /*var stats = new Stats();
      stats.setMode(0); // 0: fps, 1: ms
      // Align top-left
      stats.domElement.style.position = 'absolute';
      stats.domElement.style.left = '0px';
      stats.domElement.style.top = '0px';*/
      /* end stats */

      // BEGIN WebGL vars
      var canvasLayer;
      var gl, glb;

      var showWdpaLayer = true;
      var showHansonLayer = true;
      var showViirsLayer = false;

      var tileViewVisibility = {
        videoTile: true,
        vectorTile: false
      };

      function onTimeMachinePlayerReady() {
        // initialize the canvasLayer
        var timeMachineCanvasLayerOptions = {
          timelapse: timelapse,
          resizeHandler: resize,
          animate: true,
          updateHandler: update,
          resolutionScale: window.devicePixelRatio || 1
        };
        canvasLayer = new TimeMachineCanvasLayer(timeMachineCanvasLayerOptions);

        // initialize WebGL
        gl = canvasLayer.canvas.getContext('experimental-webgl');
        glb = new Glb(gl);

        //totalTime =  29 /*timelapse.getNumFrames()*/ / /*timelapse.getFps()*/ 10;

        var layer_html = '<div id="vector-layers">';
        layer_html += '<table id="legend">';
        layer_html += '<tr>';
        layer_html += '<td><div class="legendColor" style="border: 2px solid rgb(0,255,38);"></div></td><td><div class="legendTitle" style="color: rgb(0,229,34)">Protected Areas</div></td>';
        layer_html += '</tr>';
        layer_html += '</table>';
        layer_html += '<span style="top:6px; position: relative">Base Layers</span><br>';
        layer_html += '<input type="radio" id="light-base" name="base-layers" value="light" />';
        layer_html += '<label for="light-base" class="base-layers-label">Light</label>';
        layer_html += '<input type="radio" id="dark-base" name="base-layers" value="dark" />';
        layer_html += '<label for="dark-base" class="base-layers-label">Dark</label>';
        layer_html += '<input type="radio" id="landsat-base" name="base-layers" value="landsat" />';
        layer_html += '<label for="landsat-base" class="base-layers-label">Landsat</label>';
        layer_html += '<br><br><span>Additional Layers</span><br>';
        layer_html += '<input type="checkbox" id="show-wdpa">';
        layer_html += '<label for="show-wdpa" id="wdpa-label">Protected Areas</label>';
        layer_html += '<br><input type="checkbox" id="show-forest-change">';
        layer_html += '<label for="show-forest-change" id="forest-label">Global Forest Change</label>';
        layer_html += '<br><input type="checkbox" id="show-viirs">';
        layer_html += '<label for="show-viirs" id="viirs-label">Fires at night</label>';
        layer_html += '</div>';

        $(layer_html).appendTo("#timeMachine");
        //$("#timeMachine").append('<div id="logoUrl">earthengine.google.org</div>');

        // Time Machine layer
        landsatBaseMapLayer = new WebglTimeMachineLayer(glb, canvasLayer, landsatUrl, wdpaUrl);

        // Vector map layers
        var mapLevels = 12;
        lightBaseMapLayer = new WebglMapLayer(glb, canvasLayer, osmDefaultUrl, mapLevels);
        darkBaseMapLayer = new WebglMapLayer(glb, canvasLayer, osmDarkUrl, mapLevels);
        hansonMapLayer = new WebglMapLayer(glb, canvasLayer, gfcTransUrl, mapLevels);
        wdpaVectorLayer = new WebglVectorLayer(glb, canvasLayer, wdpaUrl, mapLevels);

        // VIIRS is just a single tile
        viirsTile = new WebglViirsTile(glb, viirsUrl);

        // Layer Toggle UI
        initLayerToggleUI();

        // Load waypoints
        timelapse.loadSharedDataFromUnsafeURL("#presentation=EODkDPWPyXs9wR6gBAmazon%20Deforestation%20in%20Rondonia_Rondonia_DkDT37Hawc4T8VA%20large-scale%20hydroelectric%20project%20in%20the%20Brazilian%20Amazon%20rainforest_Tucurui%20Dam_BkDTiTRWWTmR6gBRiver%20meandering%20in%20the%20Amazon_Meander_DkDK9ySWib2R2dThe%20abandonment%20of%20a%20river%20channel%20and%20the%20formation%20of%20a%20new%20river%20channel_Bolivia%20Avulsion_DkDU28jbt4xTkcErosion%20in%20the%20Amazon%27s%20mouth_Mouth%20of%20Amazon_DkDcOeLoWayQ6gBThe%20Cape%20and%20islands%20are%20subject%20to%20massive%20coastal%20erosion_South%20Cape%20Cod_BkDPt3KmUZ3P6gBThe%20Outer%20Banks%20often%20suffers%20significant%20beach%20erosion%20during%20storms_Outer%20Banks%20NC_DkDFGq9mKcYi8VThe%20shrinking%20and%20drying%20up%20of%20the%20Lake%20Urmia_Lake%20Urmia_DkDOcGQprwpkmRThe%20shrinking%20of%20the%20Aral%20Sea%20destroys%20fishing%20industry%20and%20brings%20unemployment%20and%20public%20health%20problems_Aral%20Sea_DkDSq1joU5sk6gBThe%20expansion%20of%20irrigation%20systems%20near%20the%20Aral%20Sea_Aral%20Expansion_BkDcM7nkdxUhgZCenter-pivot%20irrigation%20irrigates%20crops%20with%20sprinklers%20centered%20on%20the%20pivot%2C%20creating%20a%20green%20circular%20pattern_Saudi%20Irrigation_CkDWmblQtbBxuXBushfires%20in%20Australia%20are%20frequent%20during%20the%20hotter%20months%20of%20the%20year_Australia%20Bushfire_DkDWZuFgTJ1tycThe%20eruption%20of%20Mount%20Pinatubo%20on%20June%2015%2C%201991_Pinatubo_BkDVUU_kfEAu_cUrban%20expansion%20in%20Shanghai%2C%20China%2E_Shanghai_Untitled_B");

        // Toggle layers off when auto mode begins
        // TODO: Handle newly added layers
        var snaplapse = timelapse.getSnaplapseForPresentationSlider();
        var snaplapseViewer = snaplapse.getSnaplapseViewer();
        snaplapseViewer.addEventListener('automode-start', function() {
          var $globalForestLayerToggle = $("#show-forest-change");
          var $wdpaLayerToggle = $("#show-wdpa");
          if ($globalForestLayerToggle.prop('checked')) {
            $globalForestLayerToggle.click();
          }
          if ($wdpaLayerToggle.prop('checked')) {
            $wdpaLayerToggle.click();
          }
        });
      }

      var perf;
      var maximumUpdateTime = 20; // milliseconds
      var startOfRedraw;

      function redrawTakingTooLong() {
        return performance.now() - startOfRedraw > maximumUpdateTime;
      }

      function resize() {
        var width = canvasLayer.canvas.width;
        var height = canvasLayer.canvas.height;

        gl.viewport(0, 0, width, height);
      }

      //var firstDrawTime = null;
      //var lastFrameTime = null

      // Draws to canvas.
      // Called by TimeMachineCanavasLayer during animation and/or view changes
      function update() {

        /*var frameTime = performance.now();
        startOfRedraw = frameTime;

        if (lastFrameTime != null) {
          var duration = frameTime - lastFrameTime;
        }
        lastFrameTime = frameTime;

        //stats.begin();
        if (WebglVideoTile.verbose) {
          function r2(x) {
            return Math.round(x * 100) / 100;
          }
          console.log(r2(performance.now()) + ' update start --------------------------------------------------');
        }*/

        //if (!firstDrawTime) {
        //  firstDrawTime = performance.now();
        //  var dfwView = { center: {x:308100, y:538800}, zoom: 8};
        //  timelapse.setNewView(dfwView, true);
        //  timelapse.play();
        //}

        //if (performance.now() - firstDrawTime < 1 * 5000) {
        //  WebglVideoTile.verbose = true;
        //} else {
        //  if (WebglVideoTile.verbose) {
        //    WebglVideoTile.verbose = false;
        //    console.log(WebglVideoTile.stats());
        //  }
        //}

        gl.clear(gl.COLOR_BUFFER_BIT);

        // Draw base layer
        if (visibleBaseMapLayer == "landsat") {
          landsatBaseMapLayer.draw(timelapse.getView(), tileViewVisibility);
        } else if (visibleBaseMapLayer == "light") {
          // Construct view for lightBaseMapLayer
          var lightBaseMapView = timelapse.getView();
          var timelapse2map = lightBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
          lightBaseMapView.x *= timelapse2map;
          lightBaseMapView.y *= timelapse2map;
          lightBaseMapView.scale /= timelapse2map;

          lightBaseMapLayer.draw(lightBaseMapView);
        } else if (visibleBaseMapLayer == "dark") {
          // Construct view for darkBaseMapLayer
          var darkBaseMapView = timelapse.getView();
          var timelapse2map = darkBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
          darkBaseMapView.x *= timelapse2map;
          darkBaseMapView.y *= timelapse2map;
          darkBaseMapView.scale /= timelapse2map;

          darkBaseMapLayer.draw(darkBaseMapView);
        }

        // Layers to draw above the base layer

        // Draw hansonMapLayer
        if (showHansonLayer) {
          // Construct view for hansonMapLayer
          var hansonMapLayerView = timelapse.getView();
          var timelapse2map = hansonMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
          hansonMapLayerView.x *= timelapse2map;
          hansonMapLayerView.y *= timelapse2map;
          hansonMapLayerView.scale /= timelapse2map;

          hansonMapLayer.draw(hansonMapLayerView);
        }

        // Draw wdpaLayer
        if (showWdpaLayer)
          wdpaVectorLayer.draw(timelapse.getView());

        // VIIRS layer
        if (showViirsLayer) {
          var viirsView = timelapse.getView();
          viirsView.zoom = timelapse.getCurrentZoom();
          viirsTile.draw(viirsView);
        }

        //stats.end();
      }
    </script>
  </head>
  <body>
    <div id="timeMachine" style="overflow: hidden"> </div>
    <canvas id="stats" style="position:absolute; top:0px; right:0px; z-index:100" width=1000 height=153></canvas>
  </body>
</html>

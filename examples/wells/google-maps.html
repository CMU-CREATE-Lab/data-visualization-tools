<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Google Maps, WebGL, Drilling data</title>
    <style>
      html, body, #map-div {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      .controls {
        position: absolute;
        left: 0px;
        bottom: 0px;
        right: 0px;
        width: auto;
        height: 60px;
        overflow: visible;
      }

      .ui-dialog {
  border: 1px solid #656565;
  border-radius: 2px;
  font-size: 13px;
}

.ui-dialog .ui-dialog-titlebar {
  border-radius: 2px;
}

.ui-widget-content {
  font-family: Arial, Helvetica, sans-serif;
  font-size: 13px;
}

.ui-dialog .ui-button {
  border-radius: 2px;
}

.loadingOverlay {
  background-color: rgba(0, 0, 0, 0);
  bottom: 0;
  left: 0;
  position: fixed;
  right: 0;
  top: 0;
  z-index: 999;
}

.tiledContentHolder {
  position: absolute;
  left: 1px;
  top: 1px;
  bottom: 1px;
  right: 1px;
  border: 1px solid #656565;
  width: auto;
  height: auto;
  background: black;
  overflow: hidden;
}

.ui-button .ui-icon.ui-icon-custom-stop {
  background-image: url(../images/buttons/custom_stop.png);
  margin-top: -8px;
  margin-left: -8px;
  width: 18px;
  height: 24px;
  opacity: 0.7;
}

.ui-button.ui-state-hover .ui-icon.ui-icon-custom-stop {
  opacity: 1;
}

.ui-button .ui-icon.ui-icon-custom-play {
  background-image: url(../images/buttons/custom_play.png);
  margin-top: -12px;
  margin-left: -7px;
  width: 18px;
  height: 24px;
  opacity: 0.7;
}

.ui-button.ui-state-hover .ui-icon.ui-icon-custom-play {
  opacity: 1;
}

.ui-button .ui-icon.ui-icon-custom-pause {
  background-image: url(../images/buttons/custom_pause.png);
  margin-top: -12px;
  margin-left: -11px;
  width: 24px;
  height: 24px;
  opacity: 0.7;
}

.ui-button.ui-state-hover .ui-icon.ui-icon-custom-pause {
  opacity: 1;
}

.tiledContentHolder:focus {
  outline: 0;
}

.viewerModeBtn {
  position: absolute;
  width: 58px;
  height: 18px;
  bottom: 86px;
  right: 20px;
  background: white;
  border: 1px solid #656565;
  border-radius: 3px !important;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
  z-index: 30;
  outline: none;
  overflow: hidden;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 11px;
}

.viewerModeBtn .ui-icon {
  margin-left: -2px;
}

.viewerModeBtn .ui-button-text {
  margin-top: -1px;
  margin-left: 0px;
}

.viewerModeBtn.ui-state-active {
  border: 1px solid #ffffff;
  background: rgba(0,0,0,0.6);
  color: white;
}

.viewerModeBtn.ui-state-active .ui-icon {
  background-image: url(../images/ui-icons_custom_256x240.png);
}

.share {
  position: absolute;
  width: 60px;
  height: 20px;
  bottom: 54px;
  right: 20px;
  background: white;
  border: 1px solid #656565;
  border-radius: 3px !important;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
  z-index: 30;
  outline: none;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 11px;
}

.share .ui-icon {
  margin-left: -2px;
}

.share .ui-button-text {
  margin-left: -1px;
  margin-top: -2px;
}

.helpPlayerLabel.ui-button {
  position: absolute;
  height: 18px;
  bottom: 22px;
  width: 58px;
  right: 20px;
  background: white;
  border: 1px solid #656565;
  border-radius: 3px !important;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
  z-index: 30;
  outline: none;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 11px;
}

.helpPlayerLabel .ui-icon {
  margin-left: -1px;
}

.helpPlayerLabel .ui-button-text {
  margin-top: -2px;
  margin-left: 3px;
}

.instructions {
  background-color: rgba(0, 0, 0, 0.5);
  position: absolute;
  top: 0px;
  left: 0px;
  bottom: 0px;
  right: 0px;
  width: auto;
  height: auto;
  z-index: 999;
  display: none;
}

.instructions span {
  font-size: 12px;
  color: black;
  position: absolute;
  display: block;
  line-height: 18px;
}

.instructions p {
  font-size: 12px;
}

.instructions span.movehelp {
  top: 30px;
  left: 110px;
  width: 140px;
  color: white !important;
  padding: 68px 0px 0px 0px;
  background-repeat: no-repeat;
  background-position: center top;
  background-image: url(../images/drag_mouse_white.png);
}

.instructions span.zoomhelp {
  background-color: white;
  border: 1px solid #656565;
  top: 150px;
  left: 67px;
  overflow: visible;
  border-radius: 3px;
}

.instructions span.zoomallhelp {
  background-color: white;
  border: 1px solid #656565;
  top: 250px;
  left: 67px;
  overflow: visible;
  border-radius: 3px;
}

.instructions span.zoomhelp p, .instructions span.zoomallhelp p {
  margin: 0px -6px 0px -11px;
  padding: 12px 0px 12px 30px;
  background-repeat: no-repeat;
  background-position: center left;
  background-image: url(../images/bubble_edge_vertical_white.png);
  width: 190px;
}

.instructions span.speedhelp {
  background-color: white;
  border: 1px solid #656565;
  overflow: visible;
  bottom: 50px;
  left: 88px;
  border-radius: 3px;
}

.instructions span.speedhelp p {
  margin: 0px 0px -11px 0px;
  padding: 12px 15px 22px 15px;
  background-repeat: no-repeat;
  background-position: 20px 100%;
  background-image: url(../images/bubble_edge_horizontal_white.png);
  width: 172px;
}

.videoTime {
  margin: 0px;
  padding: 0px;
  position: absolute;
  left: 100px;
  bottom: 7px;
  font-size: 12px;
  color: #202020;
  font-family: Arial, Helvetica, sans-serif;
  display: none;
}

.captureTime {
  position: absolute;
  left: 90px;
  bottom: 42px;
  font-size: 18px;
  text-shadow: -1px 0 #000, 0 1px #000, 1px 0 #000, 0 -1px #000, 2px 2px 3px rgba(0,0,0,0.3);
  font-family: Arial, Helvetica, sans-serif;
  text-align: center;
  color: white;
  font-weight: normal;
}

.playbackButton.ui-button {
  display: block;
  position: absolute;
  width: 50px;
  height: 50px;
  bottom: 17px;
  left: 20px;
  background: white;
  border: 1px solid #656565;
  border-radius: 35px !important;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
  z-index: 10;
  outline: none;
}

.timelineSliderFiller {
  position: absolute;
  bottom: 26px;
  left: 160px;
  right: 100px;
  width: auto;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
  border: 1px solid #656565;
  background: transparent;
}

.timelineSlider {
  background: rgba(255,255,255,0.3);
  cursor: pointer;
  border: 2px solid rgba(255,255,255,0.8);
  position: absolute;
  height: 7px;
  width: inherit;
  position: relative;
  top: 0px;
  left: 0px;
  margin: 0;
  padding: 0;
  z-index: 25;
}

.timelineSlider .ui-slider-handle {
  width: 12px;
  margin-left: -5px !important;
  height: 15px;
  overflow: hidden;
  top: -5px;
  border-style: none;
  border: none;
  margin: 0px;
  z-index: 5;
  border: 1px solid #656565;
  border-radius: 2px !important;
}

.timelineSlider .ui-slider-range {
  background: red;
  opacity: 0.4;
}

.zoomall {
  margin-top: 5px !important;
}

.zoomSlider {
  width: 4px;
  height: 130px;
  background: #ffffff;
  border: 1px solid #656565;
  margin: 0 auto;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
  cursor: pointer;
}

.zoomSlider .ui-slider-handle {
  width: 20px;
  height: 8px;
  overflow: hidden;
  left: -9px;
  z-index: 15;
  border: 1px solid #656565;
  border-radius: 2px !important;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
  background-color: white;
}

.pan {
  display: block;
  width: 50px;
  height: 50px;
  margin-bottom: 10px;
  background: white;
  border: 1px solid #656565;
  border-radius: 25px !important;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
}

.pan .ui-button {
  position: absolute;
  width: 20px;
  height: 20px;
  background: transparent;
  border: 0px solid #656565;
  border-radius: 0px;
}

.sideToolBar {
  position: absolute;
  top: 20px;
  left: 20px;
  z-index: 15;
}

.zoom .ui-button {
  display: block;
  width: 20px;
  height: 20px;
  margin: 0 auto;
  background: white;
  border: 1px solid #656565;
  border-radius: 2px !important;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
}

.zoom .ui-icon {
  margin-top: -9px;
}

.controls {
  position: absolute;
  left: 0px;
  bottom: 0px;
  right: 0px;
  width: auto;
  height: 60px;
  overflow: visible;
}

.shareurl {
  width: 600px;
  height: 32px;
  resize: none;
}

.spinnerOverlay {
  background-image: url(../images/loading.gif);
  width: 32px;
  height: 32px;
  top: 50%;
  left: 50%;
  margin-left: -16px;
  margin-top: -16px;
  position: absolute;
  display: none;
  z-index: 10;
}

#browser_not_supported {
  display: block;
  height: 348px;
  left: 34px;
  position: fixed;
  top: 100px;
  width: 514px;
}

#html5_overridden_message {
  height: 348px;
  left: 34px;
  position: fixed;
  top: 65px;
  width: 514px;
  z-index: 1000;
}

.warning, .error {
  border: 1px solid;
  width: 400px;
  margin-left: auto;
  margin-right: auto;
  margin-top: 50px;
  padding: 15px 10px 15px 60px;
  background-repeat: no-repeat;
  background-position: 10px center;
}

.warning {
  color: #9F6000;
  background-color: #FEEFB3;
  background-image: url('../images/alert.png');
}

.error {
  color: #D8000C;
  background-color: #FFBABA;
  background-image: url('../images/error.png');
}

.ui-dialog-titlebar {
  background: #959595;
  border: 0;
  color: white;
}

.toggleSpeed.ui-button {
  position: absolute;
  width: 55px;
  height: 17px;
  top: 19px;
  left: 89px;
  background: white;
  border: 1px solid #656565;
  border-radius: 3px !important;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
  z-index: 9;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 8pt;
  color: #656565;
  display: none;
  outline: none;
}

.toggleSpeed .ui-button-text {
  text-align: center;
  padding: 0px;
}

.temperature {
  position: absolute;
  width: 60px;
  height: 20px;
  bottom: 24px;
  right: 20px;
  background: white;
  border: 1px solid #656565;
  border-radius: 3px !important;
  box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
  z-index: 30;
  outline: none;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 11px;
}

.temperature .ui-icon {
  margin-left: -2px;
}

.temperature .ui-button-text {
  margin-left: -1px;
  margin-top: -2px;
}
    </style>
    <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="../../js/CanvasLayer.js"></script>
    <script type="text/javascript" src="../../js/base.js"></script>
    <script type="text/javascript" src="../../js/io.js"></script>
    <script type="text/javascript" src="../../js/utils.js"></script>
    <script type="text/javascript" src="../../js/stats.min.js"></script>
    <script id="point-vertex-shader" type="x-shader/x-vertex">
      attribute vec4 worldCoord;
      attribute float aPointSize;
      attribute float time;


      uniform mat4 mapMatrix;
      uniform float minTime;
      uniform float maxTime;


      void main() {
        // transform world coordinate by matrix uniform variable
        if (time < minTime || time > maxTime) {
          gl_Position = vec4(-1,-1,-1,-1);
        } else {
          gl_Position = mapMatrix * worldCoord;
        }
        gl_PointSize = aPointSize;
      }
    </script>
    <script id="point-fragment-shader" type="x-shader/x-fragment">
      precision mediump float;

      void main() {
        float dist = length(gl_PointCoord.xy - vec2(.5, .5));
        dist = 1. - (dist * 2.);
        dist = max(0., dist);
        gl_FragColor = vec4(.82, .22, .07, 1.) * dist;
      }
    </script>

    <script>
      /* begin stats */
      var stats = new Stats();
      stats.setMode(0); // 0: fps, 1: ms
      // Align top-left
      stats.domElement.style.position = 'absolute';
      stats.domElement.style.left = '0px';
      stats.domElement.style.top = '0px';
      /* end stats */

      var map;
      var canvasLayer;
      var gl;

      /**
        * Latitude-longitude-date data is a series of 2 32-bit floats and 1 32-bit integer little-endian encoded.
        * Each lat-lng-date grouping represents a well.
        */

      var dataURL = "capture/wells.bin";
      var pointCount;
      var pointData;
      var pointArrayBuffer;
      var timeData;
      var timeArrayBuffer;
      var dataLoaded = false;
      var pixelsToWebGLMatrix = new Float32Array(16);
      var mapMatrix = new Float32Array(16);
      var aPointSize;

      function resize() {
        var w = gl.canvas.width;
        var h = gl.canvas.height;
        gl.viewport(0, 0, w, h);

        // matrix which maps pixel coordinates to WebGL coordinates
        pixelsToWebGLMatrix.set([2/w, 0,   0, 0,
                                 0,  -2/h, 0, 0,
                                 0,   0,   0, 0,
                                -1,   1,   0, 1]);
      }

      function scaleMatrix(matrix, scaleX, scaleY) {
        // scaling x and y, which is just scaling first two columns of matrix
        matrix[0] *= scaleX;
        matrix[1] *= scaleX;
        matrix[2] *= scaleX;
        matrix[3] *= scaleX;

        matrix[4] *= scaleY;
        matrix[5] *= scaleY;
        matrix[6] *= scaleY;
        matrix[7] *= scaleY;
      }

      function translateMatrix(matrix, tx, ty) {
        // translation is in last column of matrix
        matrix[12] += matrix[0]*tx + matrix[4]*ty;
        matrix[13] += matrix[1]*tx + matrix[5]*ty;
        matrix[14] += matrix[2]*tx + matrix[6]*ty;
        matrix[15] += matrix[3]*tx + matrix[7]*ty;
      }


      function update() {
        stats.begin();

        if (dataLoaded) {
          gl.clear(gl.COLOR_BUFFER_BIT);

    	    var pointSize = Math.floor((map.zoom - 4.) / (25. - 4.) * (20. - 1) + 1);

          gl.vertexAttrib1f(aPointSize, pointSize*1.0);

          var mapProjection = map.getProjection();

          /**
           * We need to create a transformation that takes world coordinate
           * points in the pointArrayBuffer to the coodinates WebGL expects.
           * 1. Start with second half in pixelsToWebGLMatrix, which takes pixel
           *     coordinates to WebGL coordinates.
           * 2. Scale and translate to take world coordinates to pixel coords
           * see https://developers.google.com/maps/documentation/javascript/maptypes#MapCoordinate
           */

          // copy pixel->webgl matrix
          mapMatrix.set(pixelsToWebGLMatrix);

          // Scale to current zoom (worldCoords * 2^zoom)
          var scale = canvasLayer.getMapScale();
          scaleMatrix(mapMatrix, scale, scale);

          var translation = canvasLayer.getMapTranslation();
          translateMatrix(mapMatrix, translation.x, translation.y);

          // attach matrix value to 'mapMatrix' uniform in shader
          var matrixLoc = gl.getUniformLocation(pointProgram, 'mapMatrix');
          gl.uniformMatrix4fv(matrixLoc, false, mapMatrix);


          // attach matrix value to 'mapMatrix' uniform in shader
          var maxTimeLoc = gl.getUniformLocation(pointProgram, 'maxTime');
          gl.uniform1f(maxTimeLoc, new Date('2014-01-01').getTime()*1.);

          var minTimeLoc = gl.getUniformLocation(pointProgram, 'minTime');
          gl.uniform1f(minTimeLoc, new Date('1903-01-01').getTime()*1.);

          // draw!
          var first = 0;
          var count = pointCount;
          gl.drawArrays(gl.POINTS, first, count);
        }
        stats.end();
      }

      function createBuffers() {
        console.log('createBuffers');
        pointArrayBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, pointArrayBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, pointData, gl.STATIC_DRAW);

        var attributeLoc = gl.getAttribLocation(pointProgram, 'worldCoord');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 2, gl.FLOAT, false, 0, 0);

        timeArrayBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, timeArrayBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, timeData, gl.STATIC_DRAW);

        var timeAttributeLoc = gl.getAttribLocation(pointProgram, 'time');
        gl.enableVertexAttribArray(timeAttributeLoc);
        gl.vertexAttribPointer(timeAttributeLoc, 1, gl.FLOAT, false, 0, 0);

        aPointSize = gl.getAttribLocation(pointProgram, "aPointSize");

      }

      function createShaderProgram() {
        console.log('createShaderProgram');
        // create vertex shader
        var vertexSrc = document.getElementById('point-vertex-shader').text;
        var vertexShader = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vertexShader, vertexSrc);
        gl.compileShader(vertexShader);

        // create fragment shader
        var fragmentSrc = document.getElementById('point-fragment-shader').text;
        var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fragmentShader, fragmentSrc);
        gl.compileShader(fragmentShader);

        // link shaders to create our program
        pointProgram = gl.createProgram();
        gl.attachShader(pointProgram, vertexShader);
        gl.attachShader(pointProgram, fragmentShader);
        gl.linkProgram(pointProgram);

        gl.useProgram(pointProgram);
      }


      function initWebGL(canvas) {
        try {
          gl = canvas.getContext("experimental-webgl");
          gl.enable(gl.BLEND);
          gl.blendFunc( gl.SRC_ALPHA, gl.ONE );
          console.log("initWebGL")
        } catch (e) {
        }
        if (!gl) {
          console.log("Could not initialise WebGL");
        }
      }


      function main() {
        createShaderProgram();
        createBuffers();
        dataLoaded = true;
      }

      function createWells(arrayBuffer, callback) {
        var dataView = new DataView(arrayBuffer);
        var len = dataView.byteLength / Float32Array.BYTES_PER_ELEMENT;

        pointCount = dataView.byteLength / (Float32Array.BYTES_PER_ELEMENT * 3);
        pointData = new Float32Array(pointCount*2);
        timeData = new Float32Array(pointCount);

        for (var i = 0; i < len; i += 3) {
          var lat = dataView.getFloat32(i * Float32Array.BYTES_PER_ELEMENT, true);
          var lng = dataView.getFloat32((i + 1) * Float32Array.BYTES_PER_ELEMENT, true);
          var date = dataView.getInt32((i + 2) * Int32Array.BYTES_PER_ELEMENT, true);
          var pixel = LatLongToPixelXY(lat, lng);
          pointData[2*i/3] = pixel.x;
          pointData[2*i/3 + 1] = pixel.y;
          timeData[i/3] = date*1000.0;
          if (i == 0) {
            console.log("First point {\n\tlat: " + lat + " \n\tlng: " + lng + "\n\tdate:" + date + "\n}");
          }
        }
        callback();
      }

      function loadArrayBuffer(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);
        xhr.onload = function() {
          if (xhr.readyState == 4) {
            // HTTP reports success with a 200 status. The file protocol reports
            // success with zero. HTTP does not use zero as a status code (they
            // start at 100).
            // https://developer.mozilla.org/En/Using_XMLHttpRequest
            var success = xhr.status == 200 || xhr.status == 0;
            if (success) {
              var arrayBuffer = xhr.response;
            }
            callback(arrayBuffer, success ? null : 'could not load: ' + url);
          }
        }
        xhr.responseType = "arraybuffer";
        xhr.send(null);
      }

      function initMap() {
        // initialize the map
        var mapOptions = {
          zoom: 4,
          maxZoom: 25,
          minZoom: 4,
          center: new google.maps.LatLng(39.3, -95.8),
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          styles: [
            {
              featureType: 'water',
              stylers: [{ color: '#c3cfdd'}]
            },
            {
              featureType: 'poi',
              stylers: [{visibility: 'off'}]
            }
          ]
        };
        var mapDiv = document.getElementById('map-div');
        map = new google.maps.Map(mapDiv, mapOptions);

        // initialize the canvasLayer
        var canvasLayerOptions = {
          map: map,
          resizeHandler: resize,
          animate: true,
          updateHandler: update
        };
        canvasLayer = new CanvasLayer(canvasLayerOptions);
        window.addEventListener('resize', function () {  google.maps.event.trigger(map, 'resize') }, false);
        initWebGL(canvasLayer.canvas);

      }

      function init() {
        initMap();
        loadArrayBuffer(dataURL, function(arrayBuffer, exception) {
          if (exception) {
            console.log(exception);
          } else {
            createWells(arrayBuffer, main);
          }
        });
      }

      document.addEventListener('DOMContentLoaded', init, false);
    </script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/smoothness/jquery-ui.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script>
    <script>
      var TimeSlider = function (config) {
        this.rate_ = config.rate || {
          fast: 10,
          medium: 50,
          slow: 90
        }
        this.startTime_ = config.startTime || new Date().getTime();
        this.endTime_ = config.endTime || new Date().getTime();
        this.offset_ = config.offset || 24*60*60*1000;
        this.increment_ = config.increment || 24*60*60*1000;
        return this;
      }

      var TimeSliderView = function(timeSlider, config) {
        this.timeSlider_ = timeSlider;
        this.id_ = config.id || "time-slider-controls";
        this.template_ = config.template || '\
          <div class="controls"> \
            <div class="timelineSliderFiller"> \
              <div id="Tslider1" class="timelineSlider"></div> \
            </div> \
            <div title="Play" class="playbackButton"></div> \
            <div class="videoTime" title="Video time"> \
              <span class="currentTime">00:00.00</span>/<span class="totalTime">00:00.00</span> \
            </div> \
            <a href="http://timemachine.cmucreatelab.org" target="_blank"><div class="logo timeMachineLogo"></div></a> \
            <button class="toggleSpeed" id="fastSpeed" title="Toggle playback speed">Fast</button> \
            <button class="toggleSpeed" id="mediumSpeed" title="Toggle playback speed">Medium</button> \
            <button class="toggleSpeed" id="slowSpeed" title="Toggle playback speed">Slow</button> \
        </div>';

        return this;
      }

      TimeSliderView.prototype.output = function() {
        return this.template_;
      }

      TimeSliderView.prototype.render = function() {
        document.getElementById(this.id_).innerHTML = this.output();
      }

      TimeSliderView.prototype.initPlaybackButton = function() {
        var $playbackButton = $(".playbackButton");
        $playbackButton.button({
          icons: {
            secondary: "ui-icon-custom-play"
          },
          text: false
        }).on("click", function() {
          if ($playbackButton.attr("title") == "Play") {
            $playbackButton.removeClass("play").addClass("pause").attr("title", "Pause");
            $playbackButton.button({icons: {secondary: "ui-icon-custom-pause"}});
            animate = true;
          } else {
            $playbackButton.removeClass("pause").addClass("play").attr("title", "Play");
            $playbackButton.button({icons: {secondary: "ui-icon-custom-play"}});
            animate = false;
          }
        });
      }

      TimeSliderView.prototype.initFastSpeedButton = function() {
        var $fastSpeedButton = $("#fastSpeed");
        $fastSpeedButton.button({
          text: true
        }).click(function() {
          $controls.prepend($mediumSpeedButton);
          $mediumSpeedButton.stop(true, true).show();
          $fastSpeedButton.slideUp(300);
          defaultRate = 'm';
        });

      }

      TimeSliderView.prototype.initMediumSpeedButton = function() {
        var $mediumSpeedButton = $("#mediumSpeed");
        $mediumSpeedButton.button({
          text: true
        }).click(function() {
          $controls.prepend($slowSpeedButton);
          $slowSpeedButton.stop(true, true).show();
          $mediumSpeedButton.slideUp(300);
          defaultRate = 's';
        });

      }

      TimeSliderView.prototype.initSlowSpeedButton = function() {
        var $slowSpeedButton = $("#slowSpeed");
        $slowSpeedButton.button({
          text: true
        }).click(function() {
          $controls.prepend($fastSpeedButton);
          $fastSpeedButton.stop(true, true).show();
          $slowSpeedButton.slideUp(300);
          defaultRate = 'f';

        });
      }

      TimeSliderView.prototype.initTimelineSlider = function() {
        var $timelineSlider = $(".timelineSlider");
        $timelineSlider.slider({
          min: 0,
          max: (this.timeSlider_.endTime_ - (this.timeSlider_.endTime_ + this.timeSlider_.offset_)) / this.timeSlider_.increment_, // this way the time scrubber goes exactly to the end of timeline
          range: "min",
          step: 1,
          slide: function(e, ui) {
            currentDate = (ui.value*this.timeSlider_.increment) + (this.timeSlider_.startTime_ + this.timeSlider_.offset_);
            var el = document.getElementById('current-date');
            el.innerHTML = new Date(currentDate).yyyymmdd();
          }
        }).removeClass("ui-corner-all").children().removeClass("ui-corner-all");
        $(".timelineSlider .ui-slider-handle").attr("title", "Drag to go to a different point in time");

      }

      TimeSliderView.prototype.init = function() {
        this.initPlaybackButton();
        this.initSlowSpeedButton();
        this.initMediumSpeedButton();
        this.initFastSpeedButton();
        this.initTimelineSlider();
      }

      var TimeSliderController = function(timeSlider, config) {
        this.timeSlider_ = timeSlider;
        this.timeSliderView_ = new TimeSliderView(timeSlider, {});
      }

      TimeSliderController.prototype.loadView = function() {
        this.timeSliderView_.render();
        this.timeSliderView_.init();
      }

      document.addEventListener('DOMContentLoaded', function() {
        var t = new TimeSlider({});
        var tc = new TimeSliderController(t);
        tc.loadView();
      }, false);

    </script>
  </head>
  <body>
    <div id="map-div"></div>
    <div id="time-slider-controls"></div>
  </body>
</html>
